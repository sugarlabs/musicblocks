name: Auto-convert PO to JSON and commit

on:
  push:
    paths:
      - 'po/**/*.po'

# Prevent concurrent runs on the same branch
concurrency:
  group: po-to-json-${{ github.ref }}
  cancel-in-progress: false

jobs:
  convert-and-commit:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install polib jsonschema

      - name: Find changed .po files
        id: find_po
        run: |
          set -e
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^po/.*\.po$' > changed_po_files.txt || true
          
          if [ -s changed_po_files.txt ]; then
            echo "üìù Found $(wc -l < changed_po_files.txt) changed PO file(s):"
            cat changed_po_files.txt
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "‚ÑπÔ∏è No PO files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
          
          echo "po_files<<EOF" >> $GITHUB_OUTPUT
          cat changed_po_files.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run conversion script with error handling
        if: steps.find_po.outputs.has_changes == 'true'
        id: convert
        run: |
          set -e
          mkdir -p locales
          
          failed_files=""
          success_count=0
          fail_count=0
          
          while IFS= read -r po_file; do
            if [ -z "$po_file" ]; then
              continue
            fi
            
            echo "‚ñ∂ Converting $po_file"
            
            if python3 convert_po_to_json.py "$po_file" "locales"; then
              echo "‚úÖ Successfully converted $po_file"
              success_count=$((success_count + 1))
            else
              echo "‚ùå Failed to convert $po_file"
              failed_files="${failed_files}${po_file}\n"
              fail_count=$((fail_count + 1))
            fi
          done < changed_po_files.txt
          
          echo "success_count=$success_count" >> $GITHUB_OUTPUT
          echo "fail_count=$fail_count" >> $GITHUB_OUTPUT
          echo "failed_files<<EOF" >> $GITHUB_OUTPUT
          echo -e "$failed_files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          if [ $fail_count -gt 0 ]; then
            echo "::warning::$fail_count file(s) failed to convert"
            exit 1
          fi

      - name: Validate generated JSON files
        if: steps.find_po.outputs.has_changes == 'true' && steps.convert.outcome == 'success'
        id: validate
        run: |
          set -e
          echo "üîç Validating generated JSON files..."
          
          invalid_files=""
          valid_count=0
          invalid_count=0
          
          for json_file in locales/*.json; do
            if [ -f "$json_file" ]; then
              if python3 -c "import json; json.load(open('$json_file'))"; then
                echo "‚úÖ Valid JSON: $json_file"
                valid_count=$((valid_count + 1))
              else
                echo "‚ùå Invalid JSON: $json_file"
                invalid_files="${invalid_files}${json_file}\n"
                invalid_count=$((invalid_count + 1))
              fi
            fi
          done
          
          echo "valid_count=$valid_count" >> $GITHUB_OUTPUT
          echo "invalid_count=$invalid_count" >> $GITHUB_OUTPUT
          echo "invalid_files<<EOF" >> $GITHUB_OUTPUT
          echo -e "$invalid_files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          if [ $invalid_count -gt 0 ]; then
            echo "::error::$invalid_count JSON file(s) are invalid"
            exit 1
          fi
          
          echo "‚úÖ All $valid_count JSON file(s) are valid"

      - name: Upload JSON artifacts
        if: always() && steps.find_po.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: generated-json-files
          path: locales/*.json
          retention-days: 7

      - name: Commit and push updated JSON
        if: steps.validate.outcome == 'success'
        id: commit
        run: |
          set -e
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add locales/*.json

          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è No JSON changes to commit."
            echo "committed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "chore(i18n): auto-update JSON files from updated PO files" \
                       -m "Converted ${{ steps.convert.outputs.success_count }} PO file(s)" \
                       -m "Validated ${{ steps.validate.outputs.valid_count }} JSON file(s)" \
                       -m "[skip ci]"
            git push origin ${{ github.ref }}
            echo "üöÄ Pushed updated JSON files."
            echo "committed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create failure notification
        if: failure()
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const issue_body = `## ‚ö†Ô∏è PO to JSON Conversion Failed
            
            **Workflow:** [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            **Branch:** \`${{ github.ref_name }}\`
            **Commit:** ${{ github.sha }}
            **Triggered by:** @${{ github.actor }}
            
            ### Details
            ${process.env.CONVERT_STATUS === 'failure' ? '‚ùå **Conversion errors detected**\n\nFailed files:\n```\n' + process.env.FAILED_FILES + '\n```\n' : ''}
            ${process.env.VALIDATE_STATUS === 'failure' ? '‚ùå **JSON validation failed**\n\nInvalid files:\n```\n' + process.env.INVALID_FILES + '\n```\n' : ''}
            
            ### Statistics
            - ‚úÖ Successful conversions: ${{ steps.convert.outputs.success_count || 0 }}
            - ‚ùå Failed conversions: ${{ steps.convert.outputs.fail_count || 0 }}
            - ‚úÖ Valid JSON files: ${{ steps.validate.outputs.valid_count || 0 }}
            - ‚ùå Invalid JSON files: ${{ steps.validate.outputs.invalid_count || 0 }}
            
            ### Next Steps
            1. Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details
            2. Download artifacts to inspect generated files
            3. Fix the PO files and push again
            
            ---
            *This issue was automatically created by the PO to JSON workflow.*`;
            
            // Create an issue for persistent notification
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® PO to JSON Conversion Failed - ${new Date().toISOString().split('T')[0]}`,
              body: issue_body,
              labels: ['automation', 'i18n', 'bug']
            });
        env:
          CONVERT_STATUS: ${{ steps.convert.outcome }}
          VALIDATE_STATUS: ${{ steps.validate.outcome }}
          FAILED_FILES: ${{ steps.convert.outputs.failed_files }}
          INVALID_FILES: ${{ steps.validate.outputs.invalid_files }}

      - name: Post success summary
        if: success() && steps.commit.outputs.committed == 'true'
        run: |
          echo "## ‚úÖ PO to JSON Conversion Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Converted:** ${{ steps.convert.outputs.success_count }} file(s)" >> $GITHUB_STEP_SUMMARY
          echo "**Validated:** ${{ steps.validate.outputs.valid_count }} JSON file(s)" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** All changes committed and pushed ‚ú®" >> $GITHUB_STEP_SUMMARY
