name: Run Jest Tests on PR

on:
    pull_request:
        types:
            - opened
            - synchronize

jobs:
    test:
        name: Run Jest Tests
        runs-on: ubuntu-latest
        outputs:
            tests_passed: ${{ steps.results.outputs.tests_passed }}
            failed_tests: ${{ steps.results.outputs.failed_tests }}
        permissions:
            contents: read

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.pull_request.head.sha }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install Dependencies
              run: npm ci --ignore-scripts

            - name: Run Jest Tests
              id: jest
              run: |
                  npm test -- --json --outputFile=jest-results.json || echo "TESTS_FAILED=true" >> $GITHUB_ENV

            - name: Read Jest Results
              id: results
              run: |
                  # Default TESTS_FAILED to false
                  if [ -z "$TESTS_FAILED" ]; then
                    TESTS_FAILED=false
                  fi

                  # Set TESTS_PASSED properly
                  if [ "$TESTS_FAILED" = "true" ]; then
                    TESTS_PASSED=false
                    echo "TESTS_PASSED=false" >> $GITHUB_ENV
                    FAILED_TESTS=$(jq -r '[.testResults[] | select(.status == "failed") | .name] | map(split("/") | last) | join("\n")' jest-results.json)
                    echo "FAILED_TESTS<<EOF" >> $GITHUB_ENV
                    echo "$FAILED_TESTS" >> $GITHUB_ENV
                    echo "EOF" >> $GITHUB_ENV
                  else
                    TESTS_PASSED=true
                    echo "TESTS_PASSED=true" >> $GITHUB_ENV
                    echo "FAILED_TESTS=None" >> $GITHUB_ENV
                  fi

                  echo "tests_passed=$TESTS_PASSED" >> $GITHUB_OUTPUT
                  echo "failed_tests<<EOF" >> $GITHUB_OUTPUT
                  echo "$FAILED_TESTS" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

    comment:
        name: Comment Jest Results
        if: github.event.pull_request.head.repo.full_name == github.repository
        needs: test
        runs-on: ubuntu-latest
        permissions:
            pull-requests: write
        steps:
            - name: Comment success
              if: needs.test.outputs.tests_passed == 'true'
              uses: thollander/actions-comment-pull-request@v3
              with:
                  message: |
                      ✅ All Jest tests passed! This PR is ready to merge.
                  comment-tag: jest-tests
                  mode: recreate
                  pr-number: ${{ github.event.pull_request.number }}
                  github-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Comment failure
              if: needs.test.outputs.tests_passed != 'true'
              uses: thollander/actions-comment-pull-request@v3
              with:
                  message: |
                      ❌ Some Jest tests failed. Please check the logs and fix the issues before merging.

                      **Failed Tests:**

                      ```
                      ${{ needs.test.outputs.failed_tests }}
                      ```
                  comment-tag: jest-tests
                  mode: recreate
                  pr-number: ${{ github.event.pull_request.number }}
                  github-token: ${{ secrets.GITHUB_TOKEN }}
