var VOICENAMES=[[_('violin'),'violin','images/voices.svg'],[_('cello'),'cello','images/voices.svg'],[_('guitar'),'guitar','images/voices.svg'],[_('flute'),'flute','images/voices.svg'],[_('default'),'default','images/synth.svg'],[_('simple 1'),'mono1','images/synth.svg'],[_('simple 2'),'mono2','images/synth.svg'],[_('simple 3'),'mono3','images/synth.svg'],[_('simple 4'),'mono4','images/synth.svg'],[_('white noise'),'noise1','images/synth.svg'],[_('brown noise'),'noise2','images/synth.svg'],[_('pink noise'),'noise3','images/synth.svg'],[_('sine'),'sine','images/synth.svg'],[_('square'),'square','images/synth.svg'],[_('sawtooth'),'sawtooth','images/synth.svg'],[_('triangle'),'triangle','images/synth.svg'],[_('custom'),'custom','images/synth.svg'],];var DRUMNAMES=[[_('snare drum'),'snare drum','images/snaredrum.svg'],[_('kick drum'),'kick drum','images/kick.svg'],[_('tom tom'),'tom tom','images/tom.svg'],[_('floor tom tom'),'floor tom tom','images/floortom.svg'],[_('cup drum'),'cup drum','images/cup.svg'],[_('darbuka drum'),'darbuka drum','images/darbuka.svg'],[_('hi hat'),'hi hat','images/hihat.svg'],[_('ride bell'),'ride bell','images/ridebell.svg'],[_('cow bell'),'cow bell','images/cowbell.svg'],[_('triangle bell'),'triangle bell','images/trianglebell.svg'],[_('finger cymbals'),'finger cymbals','images/fingercymbals.svg'],[_('chime'),'chine','images/chine.svg'],[_('clang'),'clang','images/clang.svg'],[_('crash'),'crash','images/crash.svg'],[_('bottle'),'bottle','images/bottle.svg'],[_('clap'),'clap','images/clap.svg'],[_('slap'),'slap','images/slap.svg'],[_('splash'),'splash','images/splash.svg'],[_('bubbles'),'bubbles','images/bubbles.svg'],[_('cat'),'cat','images/cat.svg'],[_('cricket'),'cricket','images/cricket.svg'],[_('dog'),'dog','images/dog.svg'],[_('duck'),'duck','images/duck.svg'],];var SOUNDSAMPLESDEFINES=["samples/violin","samples/cello","samples/flute","samples/guitar","samples/basse","samples/bottle","samples/clap","samples/darbuka","samples/hihat","samples/splash","samples/bubbles","samples/cowbell","samples/dog","samples/kick","samples/tom","samples/cat","samples/crash","samples/duck","samples/ridebell","samples/triangle","samples/chine","samples/cricket","samples/fingercymbal","samples/slap","samples/clang","samples/cup","samples/floortom","samples/snare"]
const SAMPLECENTERNO={'violin':51,'cello':39,'basse':15,'guitar':39,'flute':57};function validateAndSetParams(defaultParams,params){if(defaultParams&&(defaultParams!==null)&&params&&(params!==undefined)){for(var key in defaultParams){if(key in params&&params[key]!==undefined)defaultParams[key]=params[key];}}return defaultParams;};var instruments={};var instrumentsSource={};var instrumentsEffects={};var instrumentsFilters={};function Synth(){const BUILTIN_SYNTHS={'sine':1,'triangle':1,'sawtooth':1,'square':1,'pluck':1,'noise1':1,'noise2':1,'noise3':1,'poly':1,'mono1':1,'mono2':1,'mono3':1,'mono4':1,'custom':1,};const CUSTOM_SYNTHS={'amsynth':1,'fmsynth':1,'duosynth':1,};this.tone=new Tone();Tone.Buffer.onload=function(){console.log('sample loaded');};this.samples=null;this.samplesuffix="_SAMPLE";this.loadSamples=function(){var SAMPLES_MANIFEST={"voice":[{"name":"violin","data_name":"violin","data":VIOLIN_SAMPLE},{"name":"cello","data_name":"cello","data":CELLO_SAMPLE},{"name":"flute","data_name":"flute","data":FLUTE_SAMPLE},{"name":"guitar","data_name":"guitar","data":GUITAR_SAMPLE},{"name":"basse","data_name":"basse","data":BASSE_SAMPLE}],"drum":[{"name":"bottle","data_name":"bottle","data":BOTTLE_SAMPLE},{"name":"clap","data_name":"clap","data":CLAP_SAMPLE},{"name":"darbuka drum","data_name":"darbuka","data":DARBUKA_SAMPLE},{"name":"hi hat","data_name":"hihat","data":HIHAT_SAMPLE},{"name":"splash","data_name":"splash","data":SPLASH_SAMPLE},{"name":"bubbles","data_name":"bubbles","data":BUBBLES_SAMPLE},{"name":"cow bell","data_name":"cowbell","data":COWBELL_SAMPLE},{"name":"dog","data_name":"dog","data":DOG_SAMPLE},{"name":"kick drum","data_name":"kick","data":KICK_SAMPLE},{"name":"tom tom","data_name":"tom","data":TOM_SAMPLE},{"name":"cat","data_name":"cat","data":CAT_SAMPLE},{"name":"crash","data_name":"crash","data":CRASH_SAMPLE},{"name":"duck","data_name":"duck","data":DUCK_SAMPLE},{"name":"ride bell","data_name":"ridebell","data":RIDEBELL_SAMPLE},{"name":"triangle bell","data_name":"triangle","data":TRIANGLE_SAMPLE},{"name":"chine","data_name":"chine","data":CHINE_SAMPLE},,{"name":"cricket","data_name":"cricket","data":CRICKET_SAMPLE},{"name":"finger cymbals","data_name":"fingercymbal","data":FINGERCYMBAL_SAMPLE},{"name":"slap","data_name":"slap","data":SLAP_SAMPLE},{"name":"clang","data_name":"clang","data":CLANG_SAMPLE},{"name":"cup drum","data_name":"cup","data":CUP_SAMPLE},{"name":"floor tom tom","data_name":"floortom","data":FLOORTOM_SAMPLE},{"name":"snare drum","data_name":"snare","data":SNARE_SAMPLE}]}
this.samples={};for(var type in SAMPLES_MANIFEST){if(SAMPLES_MANIFEST.hasOwnProperty(type)){this.samples[type]={};for(var sample in SAMPLES_MANIFEST[type]){if(SAMPLES_MANIFEST[type].hasOwnProperty(sample)){var data=SAMPLES_MANIFEST[type][sample].data;var name=SAMPLES_MANIFEST[type][sample].name;this.samples[type][name]=data;}}}}}
var t=this;require(SOUNDSAMPLESDEFINES,function(){t.loadSamples();});this.recorder=new Recorder(Tone.Master);this.download=function(blob){var filename=prompt('Filename:','untitled.wav');if(fileExt(filename)!=='wav'){filename+='.wav';}download(filename,URL.createObjectURL(blob));}
this.getDefaultParamValues=function(sourceName){var sourceNameLC=sourceName.toLowerCase();if(getOscillatorTypes(sourceNameLC)!=null){sourceNameLC=getOscillatorTypes(sourceNameLC);}switch(sourceNameLC){case'amsynth':var synthOptions={'harmonicity':3,'detune':0,'envelope':{'attack':0.01,'decay':0.01,'sustain':1,'release':0.5},'modulation':{'type':'square'},'modulationEnvelope':{'attack':0.5,'decay':0,'sustain':1,'release':0.5}};break;case'fmsynth':var synthOptions={'harmonicity':3,'modulationIndex':10,'detune':0,'envelope':{'attack':0.01,'decay':0.01,'sustain':1,'release':0.5},'modulation':{'type':'square'},'modulationEnvelope':{'attack':0.5,'decay':0.0,'sustain':1,'release':0.5}};break;case'noise1':var synthOptions={'noise':{'type':'white'},'envelope':{'attack':0.005,'decay':0.1,'sustain':1}};break;case'noise2':var synthOptions={'noise':{'type':'brown'},'envelope':{'attack':0.005,'decay':0.1,'sustain':1}};break;case'noise3':var synthOptions={'noise':{'type':'pink'},'envelope':{'attack':0.005,'decay':0.1,'sustain':1}};break;case'mono1':case'mono2':case'mono3':case'mono4':var synthOptions={'oscillator':{'type':'sine'},'envelope':{'attack':0.03,'decay':0,'sustain':1,'release':0.03},};break;case'duosynth':var synthOptions={'vibratoAmount':0.5,'vibratoRate':5,'harmonicity':1.5,'voice0':{'volume':-10,'portamento':0,'oscillator':{'type':'sine'},'filterEnvelope':{'attack':0.01,'decay':0.0,'sustain':1,'release':0.5},'envelope':{'attack':0.01,'decay':0.0,'sustain':1,'release':0.5}},'voice1':{'volume':-10,'portamento':0,'oscillator':{'type':'sine'},'filterEnvelope':{'attack':0.01,'decay':0.0,'sustain':1,'release':0.5},'envelope':{'attack':0.01,'decay':0.0,'sustain':1,'release':0.5}}};break;case'sine':case'triangle':case'square':case'sawtooth':var synthOptions={'oscillator':{'type':sourceNameLC},'envelope':{'attack':0.03,'decay':0,'sustain':1,'release':0.03},};break;case'pluck':var synthOptions={'attackNoise':1,'dampening':4000,'resonance':0.9};break;case'poly':var synthOptions={polyphony:6};break;default:var synthOptions={};break;}return synthOptions;};this.createDefaultSynth=function(){console.log('poly (default) (custom)');var default_synth=new Tone.PolySynth(6,Tone.AMSynth).toMaster();instruments['default']=default_synth;instrumentsSource['default']=[0,'default'];instruments['custom']=default_synth;instrumentsSource['custom']=[0,'custom'];};this._createSampleSynth=function(instrumentName,sourceName,params){if(sourceName in this.samples.voice){instrumentsSource[instrumentName]=[2,sourceName];console.log(sourceName);var tempSynth=new Tone.Sampler(this.samples.voice[sourceName]);}else if(sourceName in this.samples.drum){instrumentsSource[instrumentName]=[1,sourceName];console.log(sourceName);var tempSynth=new Tone.Sampler(this.samples.drum[sourceName]);}else{instrumentsSource[instrumentName]=[1,'drum'];console.log(DEFAULTDRUM);var tempSynth=new Tone.Sampler(this.samples.drum[DEFAULTDRUM]);}return tempSynth;};this._createBuiltinSynth=function(instrumentName,sourceName,params){if(sourceName in BUILTIN_SYNTHS){var synthOptions=this.getDefaultParamValues(sourceName);synthOptions=validateAndSetParams(synthOptions,params);}switch(sourceName){case'mono1':case'mono2':case'mono3':case'mono4':instrumentsSource[instrumentName]=[3,sourceName];console.log(sourceName);var builtin_synth=new Tone.Synth(synthOptions);break;case'sine':case'triangle':case'square':case'sawtooth':instrumentsSource[instrumentName]=[3,sourceName];console.log(sourceName);var builtin_synth=new Tone.Synth(synthOptions);break;case'pluck':instrumentsSource[instrumentName]=[3,sourceName];console.log(sourceName);var builtin_synth=new Tone.PluckSynth(synthOptions);break;case'poly':instrumentsSource[instrumentName]=[0,'poly'];console.log('poly');var builtin_synth=new Tone.PolySynth(synthOptions.polyphony,Tone.AMSynth);break;case'noise1':case'noise2':case'noise3':instrumentsSource[instrumentName]=[4,sourceName];console.log(sourceName);var builtin_synth=new Tone.NoiseSynth(synthOptions);break;default:instrumentsSource[instrumentName]=[0,'poly'];console.log('poly (default)');var builtin_synth=new Tone.PolySynth(6,Tone.AMSynth);break;}return builtin_synth;};this._createCustomSynth=function(sourceName,params){var synthOptions=this.getDefaultParamValues(sourceName);synthOptions=validateAndSetParams(synthOptions,params);if(sourceName.toLowerCase()==='amsynth'){var tempSynth=new Tone.AMSynth(synthOptions);}else if(sourceName.toLowerCase()==='fmsynth'){var tempSynth=new Tone.FMSynth(synthOptions);}else if(sourceName.toLowerCase()==='duosynth'){var tempSynth=new Tone.DuoSynth(synthOptions);}else{var tempSynth=new Tone.PolySynth(6,Tone.AMSynth);}return tempSynth;};this.createSynth=function(instrumentName,sourceName,params){if((sourceName in this.samples.voice)||(sourceName in this.samples.drum)){instruments[instrumentName]=this._createSampleSynth(instrumentName,sourceName,null).toMaster();}else if(sourceName in BUILTIN_SYNTHS){instruments[instrumentName]=this._createBuiltinSynth(instrumentName,sourceName,params).toMaster();}else if(sourceName in CUSTOM_SYNTHS){instruments[instrumentName]=this._createCustomSynth(sourceName,params).toMaster();instrumentsSource[instrumentName]=[0,'poly'];}else{if(sourceName.length>=4){if(sourceName.slice(0,4)==='http'){instruments[sourceName]=new Tone.Sampler(sourceName).toMaster();instrumentsSource[instrumentName]=[1,'drum'];}else if(sourceName.slice(0,4)==='file'){instruments[sourceName]=new Tone.Sampler(sourceName).toMaster();instrumentsSource[instrumentName]=[1,'drum'];}else if(sourceName==='drum'){instruments[sourceName]=this._createSampleSynth(sourceName,sourceName,null).toMaster();instrumentsSource[instrumentName]=[1,'drum'];}}}};this.loadSynth=function(sourceName){if(instruments[sourceName]==null){console.log('loading '+sourceName);this.createSynth(sourceName,sourceName,null);}if(sourceName in instruments){return instruments[sourceName].toMaster();}return null;}
this.performNotes=function(synth,notes,beatValue,paramsEffects,paramsFilters){if(paramsEffects==null&&paramsFilters==null){synth.triggerAttackRelease(notes,beatValue);}else{if(paramsFilters!=null&&paramsFilters!=undefined){var numFilters=paramsFilters.length;var k=0;var temp_filters=[];for(k=0;k<numFilters;k++){var filterVal=new Tone.Filter(paramsFilters[k].filterFrequency,paramsFilters[k].filterType,paramsFilters[k].filterRolloff);temp_filters.push(filterVal);synth.chain(temp_filters[k],Tone.Master);}}if(paramsEffects!=null&&paramsEffects!=undefined){if(paramsEffects.doVibrato){var vibrato=new Tone.Vibrato(1/paramsEffects.vibratoFrequency,paramsEffects.vibratoIntensity);synth.chain(vibrato,Tone.Master);}if(paramsEffects.doDistortion){var distort=new Tone.Distortion(paramsEffects.distortionAmount).toMaster();synth.connect(distort,Tone.Master);}if(paramsEffects.doTremolo){var tremolo=new Tone.Tremolo({'frequency':paramsEffects.tremoloFrequency,'depth':paramsEffects.tremoloDepth}).toMaster().start();synth.chain(tremolo);}if(paramsEffects.doPhaser){var phaser=new Tone.Phaser({'frequency':paramsEffects.rate,'octaves':paramsEffects.octaves,'baseFrequency':paramsEffects.baseFrequency}).toMaster();synth.chain(phaser,Tone.Master);}if(paramsEffects.doChorus){var chorusEffect=new Tone.Chorus({'frequency':paramsEffects.chorusRate,'delayTime':paramsEffects.delayTime,'depth':paramsEffects.chorusDepth}).toMaster();synth.chain(chorusEffect,Tone.Master);}}synth.triggerAttackRelease(notes,beatValue);setTimeout(function(){if(paramsEffects&&paramsEffects!=null&&paramsEffects!=undefined){if(paramsEffects.doVibrato){vibrato.dispose();}if(paramsEffects.doDistortion){distort.dispose();}if(paramsEffects.doTremolo){tremolo.dispose();}if(paramsEffects.doPhaser){phaser.dispose();}if(paramsEffects.doChorus){chorusEffect.dispose();}}if(paramsFilters&&paramsFilters!=null&&paramsFilters!=undefined){for(k=0;k<numFilters;k++){temp_filters[k].dispose();}}},beatValue*1000);}};this.trigger=function(notes,beatValue,instrumentName,paramsEffects,paramsFilters){if(paramsEffects!==null&&paramsEffects!==undefined){if(paramsEffects['vibratoIntensity']!=0){paramsEffects.doVibrato=true;}if(paramsEffects['distortionAmount']!=0){paramsEffects.doDistortion=true;}if(paramsEffects['tremoloFrequency']!=0){paramsEffects.doTremolo=true;}if(paramsEffects['rate']!=0){paramsEffects.doPhaser=true;}if(paramsEffects['chorusRate']!=0){paramsEffects.doChorus=true;}}var tempNotes=notes;var tempSynth=instruments['default'];var flag=0;if(instrumentName in instruments){tempSynth=instruments[instrumentName];flag=instrumentsSource[instrumentName][0];if(flag===1||flag===2){var sampleName=instrumentsSource[instrumentName][1];}}switch(flag){case 1:if(instrumentName.slice(0,4)==='http'){tempSynth.triggerAttack(0,beatValue);}else if(instrumentName.slice(0,4)==='file'){tempSynth.triggerAttack(0,beatValue);}else{tempSynth.triggerAttack(0);}break;case 2:var centerNo=SAMPLECENTERNO[sampleName];var obj=noteToPitchOctave(notes);var noteNum=pitchToNumber(obj[0],obj[1],'C Major');tempNotes=noteNum-centerNo;this.performNotes(tempSynth.toMaster(),tempNotes,beatValue,paramsEffects,paramsFilters);break;case 3:if(typeof(notes)==='object'){tempNotes=notes[0];}this.performNotes(tempSynth.toMaster(),tempNotes,beatValue,paramsEffects,paramsFilters);break;case 4:tempSynth.triggerAttackRelease(beatValue);break;case 0:default:this.performNotes(tempSynth.toMaster(),tempNotes,beatValue,paramsEffects,paramsFilters);break;}};this.stopSound=function(instrumentName){instruments[instrumentName].triggerRelease();};this.start=function(){Tone.Transport.start();};this.stop=function(){Tone.Transport.stop();};this.setVolume=function(instrumentName,volume){var db=this.tone.gainToDb(volume/100);if(instrumentName in instruments){instruments[instrumentName].volume.value=db;}};this.getVolume=function(instrumentName){if(instrumentName in instruments){return instruments[instrumentName].volume.value;}else{console.log('instrument not found');return 50;}};this.setMasterVolume=function(volume){var db=this.tone.gainToDb(volume/100);Tone.Master.volume.rampTo(db,0.01);};};