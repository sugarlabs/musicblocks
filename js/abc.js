const ABCHEADER='X:1\nT:Music Blocks composition\nC:Mr. Mouse\nL:1/16\nM:C\n';getABCHeader=function(){return ABCHEADER;};processAbcNotes=function(logo,turtle){logo.notationNotes[turtle]='';function __convertDuration(duration){var returnString='';switch(duration){case 64:returnString='1/4';break;case 32:returnString='1/2';break;case 16:returnString='1';break;case 8:returnString='2';break;case 4:returnString='4';break;case 2:returnString='8';break;case 1:returnString='16';break;default:returnString=duration;break;}return returnString;};function __toABCnote(note){if(typeof(note)==='number'){var pitchObj=frequencyToPitch(note);note=pitchObj[0]+pitchObj[1];}if(note.indexOf('♯')>-1){note='^'+note.replace('♯','')}if(note.indexOf('♯')>-1){note='^'+note.replace(/♯/g,'')}if(note.indexOf('♭')>-1){note='_'+note.replace('♭','')}if(note.indexOf('♭')>-1){note='_'+note.replace(/♭/g,'')}if(note.indexOf('10')>-1){return note.replace('10',"'''''").toLowerCase();}if(note.indexOf('9')>-1){return note.replace('9',"''''").toLowerCase();}if(note.indexOf('8')>-1){return note.replace('8',"'''").toLowerCase();}if(note.indexOf('7')>-1){return note.replace('7',"''").toLowerCase();}if(note.indexOf('6')>-1){return note.replace('6',"'").toLowerCase();}if(note.indexOf('5')>-1){return note.replace('5',"").toLowerCase();}if(note.indexOf('4')>-1){return note.replace('4',"").toUpperCase();}if(note.indexOf('3')>-1){return note.replace('3',",").toUpperCase();}if(note.indexOf('2')>-1){return note.replace('2',",,").toUpperCase();}if(note.indexOf('1')>-1){return note.replace('1',",,,").toUpperCase();}return note.toUpperCase();};var counter=0;var queueSlur=false;var articulation=false;var targetDuration=0;var tupletDuration=0;for(var i=0;i<logo.notationStaging[turtle].length;i++){obj=logo.notationStaging[turtle][i];if(typeof(obj)==='string'){switch(obj){case'break':if(i>0){logo.notationNotes[turtle]+='\n';}counter=0;break;case'begin articulation':articulation=true;break;case'end articulation':articulation=false;break;case'begin crescendo':logo.notationNotes[turtle]+='!\<(!';break;case'end crescendo':logo.notationNotes[turtle]+='!\<)!';break;case'begin decrescendo':logo.notationNotes[turtle]+='!\>(!';break;case'end decrescendo':logo.notationNotes[turtle]+='!\<(!';break;case'begin slur':queueSlur=true;break;case'end slur':logo.notationNotes[turtle]+='';break;case'tie':logo.notationNotes[turtle]+='';break;case'meter':logo.notationNotes[turtle]+='M:'+logo.notationStaging[turtle][i+1]+'/'+logo.notationStaging[turtle][i+2]+'\n';i+=2;break;case'pickup':i+=1;break;case'voice one':case'voice two':case'voice three':case'voice four':case'one voice':break;default:logo.notationNotes[turtle]+=obj;break;}}else{if(counter%8===0&&counter>0){logo.notationNotes[turtle]+='\n';}counter+=1;var note=__toABCnote(obj[NOTATIONNOTE]);var incompleteTuplet=0;if(obj[NOTATIONTUPLETVALUE]!=null){targetDuration=(1/logo.notationStaging[turtle][i][NOTATIONDURATION]);tupletDuration=(1/logo.notationStaging[turtle][i][NOTATIONROUNDDOWN]);var j=1;var k=1;while(k<obj[NOTATIONTUPLETVALUE]){if(i+j>=logo.notationStaging[turtle].length){incompleteTuplet=j;break;}if(logo.notationStaging[turtle][i+j][NOTATIONINSIDECHORD]>0&&logo.notationStaging[turtle][i+j][NOTATIONINSIDECHORD]===logo.notationStaging[turtle][i+j-1][NOTATIONINSIDECHORD]){j++;}else if(logo.notationStaging[turtle][i+j][NOTATIONTUPLETVALUE]!==obj[NOTATIONTUPLETVALUE]){incompleteTuplet=j;break;}else{targetDuration+=(1/logo.notationStaging[turtle][i+j][NOTATIONDURATION]);tupletDuration+=(1/logo.notationStaging[turtle][i+j][NOTATIONROUNDDOWN]);j++;k++;}}}function __processTuplet(logo,turtle,i,count){var j=0;var k=0;while(k<count){var tupletDuration=2*logo.notationStaging[turtle][i+j][NOTATIONDURATION];if(logo.notationStaging[turtle][i+j][NOTATIONINSIDECHORD]>0){if((i===0&&j===0)||logo.notationStaging[turtle][i+j-1][NOTATIONINSIDECHORD]!==logo.notationStaging[turtle][i+j][NOTATIONINSIDECHORD]){logo.notationNotes[turtle]+='[';}logo.notationNotes[turtle]+=__toABCnote(logo.notationStaging[turtle][i+j][NOTATIONNOTE]);if(obj[NOTATIONSTACCATO]){logo.notationNotes[turtle]+='.';}if(i+j===logo.notationStaging[turtle].length-1||logo.notationStaging[turtle][i+j+1][NOTATIONINSIDECHORD]!==logo.notationStaging[turtle][i+j][NOTATIONINSIDECHORD]){logo.notationNotes[turtle]+=']'+__convertDuration(logo.notationStaging[turtle][i+j+1][NOTATIONROUNDDOWN]);k++;}j++;}else{logo.notationNotes[turtle]+=__toABCnote(logo.notationStaging[turtle][i+j][NOTATIONNOTE])+__convertDuration(logo.notationStaging[turtle][i+j][NOTATIONROUNDDOWN]);if(obj[NOTATIONSTACCATO]){logo.notationNotes[turtle]+='.';}j++;k++;}}if(i+j-1<logo.notationStaging[turtle].length-1){var nextObj=logo.notationStaging[turtle][i+j];if(typeof(nextObj)==='string'&&nextObj===')'){i+=1;}else{logo.notationNotes[turtle]+=' ';}}else{logo.notationNotes[turtle]+=' ';}return j;};if(obj[NOTATIONTUPLETVALUE]>0){if(incompleteTuplet===0){var tupletFraction=toFraction(tupletDuration/targetDuration);logo.notationNotes[turtle]+='('+tupletFraction[0]+':'+tupletFraction[1]+'';i+=__processTuplet(logo,turtle,i,obj[NOTATIONTUPLETVALUE])-1;}else{var tupletFraction=toFraction(obj[NOTATIONTUPLETVALUE]/incompleteTuplet);logo.notationNotes[turtle]+='('+tupletFraction[0]+':'+tupletFraction[1]+'';i+=__processTuplet(logo,turtle,i,incompleteTuplet)-1;}targetDuration=0;tupletDuration=0;}else{if(obj[NOTATIONINSIDECHORD]>0){if(i===0||logo.notationStaging[turtle][i-1][NOTATIONINSIDECHORD]!==obj[NOTATIONINSIDECHORD]){logo.notationNotes[turtle]+='[';}logo.notationNotes[turtle]+=(note);if(i===logo.notationStaging[turtle].length-1||logo.notationStaging[turtle][i+1][NOTATIONINSIDECHORD]!==obj[NOTATIONINSIDECHORD]){logo.notationNotes[turtle]+=']';logo.notationNotes[turtle]+=__convertDuration(obj[NOTATIONDURATION]);for(var d=0;d<obj[NOTATIONDOTCOUNT];d++){logo.notationNotes[turtle]+=' ';}if(articulation){logo.notationNotes[turtle]+=' ';}logo.notationNotes[turtle]+=' ';}}else{logo.notationNotes[turtle]+=note;logo.notationNotes[turtle]+=__convertDuration(obj[NOTATIONDURATION]);for(var d=0;d<obj[NOTATIONDOTCOUNT];d++){logo.notationNotes[turtle]+='.';}if(articulation){logo.notationNotes[turtle]+='';}}if(obj[NOTATIONSTACCATO]){logo.notationNotes[turtle]+='.';}targetDuration=0;tupletDuration=0;}logo.notationNotes[turtle]+=' ';if(queueSlur){queueSlur=false;logo.notationNotes[turtle]+='';}}}};saveAbcOutput=function(logo,saveName){var turtleCount=0;var clef=[];logo.notationOutput=getABCHeader();for(var t in logo.notationStaging){turtleCount+=1;}console.log('saving as abc: '+turtleCount);var c=0;for(var t in logo.notationStaging){logo.notationOutput+='K:'+logo.keySignature[t].toUpperCase().replace(' ','').replace('♭','b').replace('♯','#')+'\n';processAbcNotes(logo,t);logo.notationOutput+=logo.notationNotes[t];c+=1;}logo.notationOutput+='\n';console.log(logo.notationOutput);doSaveAbc(logo,saveName);};