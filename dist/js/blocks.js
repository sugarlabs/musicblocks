"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function asyncGeneratorStep(t,e,i,s,o,n,c){try{var l=t[n](c),a=l.value}catch(t){return void i(t)}l.done?e(a):Promise.resolve(a).then(s,o)}function _asyncToGenerator(l){return function(){var t=this,c=arguments;return new Promise(function(e,i){var s=l.apply(t,c);function o(t){asyncGeneratorStep(s,e,i,o,n,"next",t)}function n(t){asyncGeneratorStep(s,e,i,o,n,"throw",t)}o(void 0)})}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var MINIMUMDOCKDISTANCE=400,LONGSTACK=300,CAMERAVALUE="##__CAMERA__##",VIDEOVALUE="##__VIDEO__##",NOTEBLOCKS=["newnote","osctime"],PITCHBLOCKS=["pitch","steppitch","hertz","pitchnumber","nthmodalpitch","playdrum"],Blocks=function Blocks(activity){var _this=this;_classCallCheck(this,Blocks),this.activity=activity,this.storage=this.activity.storage,this.trashcan=this.activity.trashcan,this.turtles=this.activity.turtles,this.boundary=this.activity.boundary,this.macroDict=this.activity.macroDict,this.stageClick=!1,this.trashStacks=[],this.protoBlockDict={},this.blockList=[],this.blockArt={},this.blockCollapseArt={},this.mouseDownTime=0,this.longPressTimeout=null,this.pasteDx=0,this.pasteDy=0,this.selectedStack=null,this.selectedBlocksObj=null,this._loopCounter=0,this._sizeCounter=0,this._searchCounter=0,this.highlightedBlock=null,this.activeBlock=null,this.visible=!0,this.dragGroup=[],this.stackList=[],this._expandablesList=[],this._loadCounter=0,this._adjustTheseDocks=[],this.blocksToCollapse=[],this._checkTwoArgBlocks=[],this._checkArgClampBlocks=[],this.clampBlocksToCheck=[],this.noRunBlocks=[],this._homeButtonContainers=[],this.blockScale=DEFAULTBLOCKSCALE,this.inLongPress=!1,this.customTemperamentDefined=!1,this.isBlockMoving=!1,this.selectionModeOn=!1,this.selectedBlocks=[],this.deleteActionTimeout=0,this.getLongPressStatus=function(){return _this.inLongPress},this.clearLongPress=function(){_this.inLongPress=!1},this.setBlockScale=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var i,s,o,n,c;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:for(s in console.debug("New block scale is "+e),_this.blockScale=e,_this.blockList)_this.blockList[s].resize(e);for(o in _this.findStacks(),_this.stackList)_this.adjustDocks(_this.stackList[o],!0);for(n in _this.blockList)_this.blockList[n].trash&&_this.blockList[n].hide();for(i in _this.activity.palettes.dict)for(c in _this.activity.palettes.dict[i].protoList)_this.activity.palettes.dict[i].protoList[c].scale=e;return t.next=9,delayExecution(100);case 9:_this.activity.refreshCanvas();case 10:case"end":return t.stop()}},t)}));return function(t){return e.apply(this,arguments)}}(),this.extract=function(){null!=_this.activeBlock&&"rest2"!==_this.blockList[_this.activeBlock].name&&_this._extractBlock(_this.activeBlock,!0)},this._extractBlock=function(){var i=_asyncToGenerator(regeneratorRuntime.mark(function t(e,i){var s,o,n,c,l;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:s=_this.blockList[e],o=s.connections[0],SPECIALINPUTS.includes(s.name)?(null!=o&&(n=_this.blockList[o].connections.indexOf(e),_this.blockList[o].connections[n]=null,s.connections[0]=null),_this.moveStackRelative(e,4*STANDARDBLOCKHEIGHT,0),_this.blockMoved(e)):(c=[],_this.findNestedClampBlocks(e,c),l=last(s.connections),n=null!=o?_this.blockList[o].connections.indexOf(e):null,(s.connections[0]=null)!=l&&("hidden"===_this.blockList[l].name?(l=last(_this.blockList[l].connections),_this.blockList[last(s.connections)].connections[_this.blockList[last(s.connections)].connections.length-1]=null):s.connections[s.connections.length-1]=null,null!=l&&(_this.blockList[l].connections[0]=o)),null!=o&&(_this.blockList[o].connections[n]=l),_this.moveStackRelative(e,4*STANDARDBLOCKHEIGHT,0),_this.blockMoved(e),i&&null!=o&&(_this.adjustDocks(o,!0),0<c.length&&(_this.clampBlocksToCheck=c,_this.adjustExpandableClampBlock())));case 3:case"end":return t.stop()}},t)}));return function(t,e){return i.apply(this,arguments)}}(),this.bottomMostBlock=function(){var t=-1e3;for(var e in _this.blockList)_this.blockList[e].container.y>t&&(t=_this.blockList[e].container.y);return t},this.toggleCollapsibles=function(){var t,e,i=!0,s=!1;for(t in _this.blockList)e=_this.blockList[t],["newnote","interval","osctime"].includes(e.name)||COLLAPSIBLES.includes(e.name)&&!e.trash&&(e.collapsed?s=!0:i=!1);if(i||!s)for(t in _this.blockList)e=_this.blockList[t],["newnote","interval","osctime"].includes(e.name)||COLLAPSIBLES.includes(e.name)&&!e.trash&&e.collapseToggle();else for(t in _this.blockList)e=_this.blockList[t],["newnote","interval","osctime"].includes(e.name)||COLLAPSIBLES.includes(e.name)&&!e.trash&&(e.collapsed||e.collapseToggle())},this.setHomeContainers=function(t,e){return _this._setHomeButtonContainers=t,_this.boundary=e,_this},this._actionBlock=function(t){return["do","doArg","calc","calcArg"].includes(t)},this._namedActionBlock=function(t){return["nameddo","nameddoArg","namedcalc","namedcalcArg"].includes(t)},this._adjustBlockPositions=function(){_this.dragGroup.length<2||_this.adjustDocks(_this.dragGroup[0],!0)},this.adjustExpandableClampBlock=function(){if(0!==_this.clampBlocksToCheck.length){var n=_this,t=_this.clampBlocksToCheck.pop(),e=t[0],i=t[1],s=_this.blockList[e];if(!s.isArgFlowClampBlock()&&!s.isLeftClampBlock()){if(s.isArgBlock()||s.isTwoArgBlock())return;s.isArgClamp()&&_this._adjustArgClampBlock([e])}!function(t,e){var i=t.isArgFlowClampBlock()||t.isLeftClampBlock()?1:0===e?t.connections.length-2:t.connections.length-3,s=1;(n._sizeCounter=0)<i&&null!=t.connections[i]&&(_this._sizeCounter=0,s=Math.max(n._getStackSize(t.connections[i]),1));var o=s-t.clampCount[e];0!=o&&(0===s&&1===t.clampCount[e]||t.updateSlots(e,o)),0<n.clampBlocksToCheck.length&&n.adjustExpandableClampBlock()}(s,i)}},this._getNestingDepth=function(t){for(var e=0;null!==t;)t=_this.insideExpandableBlock(t),e+=1;return e},this._getBlockSize=function(t){var e=_this.blockList[t];return["newnote","interval","osctime"].includes(e.name)&&e.collapsed?1:e.size},this._adjustArgClampBlock=function(t){if(0!==t.length){for(var e=t.pop(),i=_this.blockList[e],s=!1,o=["doArg","calcArg","makeblock"].includes(i.name)?2:1,n=i.argClampSlots,c=0;c<n.length;c++){var l=i.connections[o+c],a=1;null!=l&&(a=Math.max(_this._getBlockSize(l),1)),n[c]!==a&&(n[c]=a,s=!0)}s&&i.updateArgSlots(n)}},this._adjustExpandableTwoArgBlock=function(t){var e,i,s,o,n;0!==t.length&&(e=t.pop(),o=1,null!=(s=(i=_this.blockList[e]).connections[1])&&(o=Math.max(_this._getBlockSize(s),1)),0!=(n=o-i.clampCount[0])&&0!==o&&i.updateSlots(0,n))},this._addRemoveVspaceBlock=function(t){var e=_this.blockList[t],i=e.connections[e.connections.length-2],s=1;null!=i&&(s=Math.max(_this._getBlockSize(i),1));var k=_this,o=function t(e){var i=last(k.blockList[e].connections);return i&&"vspace"===k.blockList[i].name?1+t(i):0}(t);if(s<o+1)for(var n=Math.abs(s-o-1),c=0;c<n;c++){var l=e.connections.length-1,a=_this.blockList[e.connections[l]],r=a.connections[1];null!=(e.connections[l]=r)&&(_this.blockList[r].connections[0]=t),a.connections=[null,null],a.trash=!0,a.hide()}else o+1<s&&_this._makeNewBlockWithConnections("vspace",_this.blockList.length,[null,null],function t(e){var i,s=e[0],o=e[1],n=e[2],c=e[3],l=e[4],a=k.blockList[n],r=last(s.docks),h=r[0]-a.docks[0][0],u=r[1]-a.docks[0][1];a.container.x=s.container.x+h,a.container.y=s.container.y+u,a.connections[0]=k.blockList.indexOf(s),a.connections[1]=o,s.connections[s.connections.length-1]=n,o&&(k.blockList[o].connections[0]=n),c+1<l&&(i=k.blockList.length,s=last(k.blockList),o=last(s.connections),k._makeNewBlockWithConnections("vspace",i,[null,null],t,[s,o,i,c+1,l]))},[e,last(e.connections),_this.blockList.length,0,s-o-1])},this._getStackSize=function(t){var e=0;if(_this._sizeCounter+=1,_this._sizeCounter>2*_this.blockList.length)return console.debug("Infinite loop encountered detecting size of expandable block? "+t),e;if(null==t)return e;var i,s,o,n=_this.blockList[t];return null==n&&console.debug("Something very broken in _getStackSize."),n.isClampBlock()?((s=0)<(i=n.connections.length-2)&&(null!=(o=n.connections[i])&&(s=_this._getStackSize(o)),e=0===s?1:s),n.isDoubleClampBlock()&&(s=0)<(i=n.connections.length-3)&&(null!=(o=n.connections[i])&&(s=_this._getStackSize(o)),e+=0===s?1:s),e+=n.size):e=n.size,(-1!=_this.blocksToCollapse.indexOf(t)||["newnote","interval","osctime"].includes(n.name)&&n.collapsed)&&(e=1),1<n.connections.length&&null!=(o=last(n.connections))&&(e+=_this._getStackSize(o)),e},this.adjustDocks=function(t,e){var i=_this.blockList[t];if(null!=e&&(_this._loopCounter=0),null!=i)if(null!=i.connections)if(0!==i.connections.length){if(1!==i.docks.length)if(_this._loopCounter+=1,_this._loopCounter>2*_this.blockList.length)console.debug("Infinite loop encountered while adjusting docks: "+t+" "+_this.blockList);else{var s=1;i.isTwoArgBooleanBlock()?s=0:i.isInlineCollapsible()&&i.collapsed&&(s=i.connections.length-1);for(var o=s;o<i.connections.length;o++){var n=i.docks[o],c=i.connections[o];if(null!==c)if(null!==_this.blockList[c]){for(var l=!1,a=void 0,a=0;a<_this.blockList[c].connections.length;a++)if(_this.blockList[c].connections[a]===t){l=!0;break}if(!l){console.debug("Did not find match for "+i.name+" ("+t+") and "+_this.blockList[c].name+" ("+c+")"),console.debug(i.connections),console.debug(_this.blockList[c].connections);break}var r,h,u=_this.blockList[c].docks[a],k=void 0,_=void 0,b=void 0,d=void 0;0<o?(k=n[0]-u[0],_=i.isInlineCollapsible()&&i.collapsed?(r=i.docks.length,h=i.docks[r-1][1]-i.docks[r-2][1],n[1]-h-u[1]):n[1]-u[1],null==i.container?console.debug("Does this ever happen any more?"):(b=i.container.x+k,d=i.container.y+_),_this._moveBlock(c,b,d)):(k=u[0]-n[0],_=u[1]-n[1],b=_this.blockList[c].container.x+k,d=_this.blockList[c].container.y+_,_this._moveBlock(t,b,d)),0<o&&_this.adjustDocks(c,!0)}else console.debug("This is not good: we encountered a null block: "+c)}}}else console.debug("Saw a block with [] connections: "+t);else console.debug("Saw a block with null connections: "+t);else console.debug("Saw a null block: "+t)},this.addDefaultBlock=function(t,e,n){if(null!=t){var i,s,o,c,l=_this;if("action"===_this.blockList[t].name)null==(i=_this.blockList[t].connections[1])&&_this._makeNewBlockWithConnections("text",0,[t],function(t){var e=t[0],s=t[1],o=l.blockList.length-1;l.blockList[e].connections[1]=o,l.blockList[o].value=l.findUniqueActionName(_("action"));var i=l.blockList[o].value;getTextWidth(i,"bold 20pt Sans")>TEXTWIDTH&&(i=i.substr(0,STRINGLEN)+"..."),l.blockList[o].text.text=i,l.blockList[o].container.updateCache(),l.blockList[o].value!==l.blockList[s].value&&function(){l.newNameddoBlock(l.blockList[o].value,l.actionHasReturn(e),l.actionHasArgs(e));for(var i=l.activity.palettes.dict.action,t=0;t<i.protoList.length;t++){if("break"===function(t){var e=i.protoList[t];if("nameddo"===e.name&&e.defaults[0]===l.blockList[s].value)return setTimeout(function(){i.remove(e,l.blockList[s].value),delete l.protoBlockDict["myDo_"+l.blockList[s].value],l.activity.palettes.updatePalettes("action")},50),"break"}(t))break}l.renameNameddos(l.blockList[s].value,l.blockList[o].value),n?l.renameDos(l.blockList[s].value,l.blockList[o].value,s):l.renameDos(l.blockList[s].value,l.blockList[o].value)}(),l.adjustDocks(e,!0)},[t,e]);else if("temperament1"===_this.blockList[t].name){null==(i=_this.blockList[t].connections[1])&&_this._makeNewBlockWithConnections("text",0,[t],function(t){var e=t[0],i=t[1],s=l.blockList.length-1;l.blockList[e].connections[1]=s,l.blockList[s].value=l.blockList[i].value,l.blockList[s].text.text=l.blockList[i].text.text,l.blockList[s].container.updateCache(),l.adjustDocks(e,!0)},[t,e])}else if("pitch"===_this.blockList[t].name){if(null==(i=_this.blockList[t].connections[2])&&_this._makeNewBlockWithConnections("number",0,[t],function(t){var e=t[0],i=t[1],s=_this.blockList.length-1;_this.blockList[e].connections[2]=s;var o=_this.blockList[i].value;_this.blockList[s].value=o,_this.blockList[s].text.text=o.toString();var n=_this.blockList[s].container.children.length-1;_this.blockList[s].container.setChildIndex(_this.blockList[s].text,n),_this.blockList[s].container.updateCache(),_this.adjustDocks(e,!0)},[t,e]),null==_this.blockList[t].connections[1]){var a="solfege",r="sol";switch(_this.blockList[e].name){case"eastindiansolfege":a=_this.blockList[e].name,r="sol";break;case"scaledegree2":a=_this.blockList[e].name,r="5";break;case"notename":a=_this.blockList[e].name,r="G"}_this._makeNewBlockWithConnections(a,0,[t],function(t){var e=t[0],i=t[1],s=_this.blockList.length-1;_this.blockList[e].connections[1]=s;var o,n,c,l=i;_this.blockList[s].value=l,"eastindiansolfege"===_this.blockList[s].name?(o=splitSolfege(l),n=WESTERN2EISOLFEGENAMES[o[0]],"â™®"!==(c=o[1])&&(n+=c),_this.blockList[s].text.text=n):_this.blockList[s].text.text=l.toString();var a=_this.blockList[s].container.children.length-1;_this.blockList[s].container.setChildIndex(_this.blockList[s].text,a),_this.blockList[s].container.updateCache(),_this.adjustDocks(e,!0)},[t,r])}}else{"storein"===_this.blockList[t].name?null==(i=_this.blockList[t].connections[1])&&_this._makeNewBlockWithConnections("text",0,[t],function(t){var e=t[0],i=l.blockList.length-1;l.blockList[e].connections[1]=i,l.blockList[i].value=_("box");var s=l.blockList[i].value;getTextWidth(s,"bold 20pt Sans")>TEXTWIDTH&&(s=s.substr(0,STRINGLEN)+"..."),l.blockList[i].text.text=s,l.blockList[i].container.updateCache(),l.adjustDocks(e,!0)},[t,e]):NOTEBLOCKS.includes(_this.blockList[t].name)&&(null==(i=_this.blockList[t].connections[2])?(s=_this.makeBlock("vspace","__NOARG__"),_this.blockList[t].connections[2]=s,_this.blockList[s].connections[0]=t,o=_this.makeBlock("rest2","__NOARG__"),_this.blockList[o].connections[0]=s,_this.blockList[o].connections[1]=null,_this.blockList[s].connections[1]=o):"vspace"===_this.blockList[i].name&&null==_this.blockList[i].connections[1]&&(c=_this.makeBlock("rest2","__NOARG__"),_this.blockList[c].connections[0]=i,_this.blockList[c].connections[1]=null,_this.blockList[i].connections[1]=c))}}},this._deletePitchBlocks=function(t){var e=_this.blockList[t].connections[0];null===e&&console.debug("Silence block was not inside a note block");for(var i=0;!NOTEBLOCKS.includes(_this.blockList[e].name);){if(t=e,null===(e=_this.blockList[e].connections[0])){console.debug("Silence block was not inside a note block");break}if((i+=1)>_this.blockList.length){console.debug("Connection loop???");break}}for(i=0;null!=t;){if(_this.blockList[t].connections.length<2){console.debug("value block encountered??? "+t);break}var s,o=last(_this.blockList[t].connections);if(PITCHBLOCKS.includes(_this.blockList[t].name)?_this._extractBlock(t,!1):["flat","sharp"].includes(_this.blockList[t].name)&&(s=_this.blockList[t].connections[1],_this._blockInStack(s,PITCHBLOCKS)&&_this._extractBlock(t,!1)),t=o,(i+=1)>_this.blockList.length){console.debug("Connection loop???");break}}},this.deleteNextDefault=function(t){var e,i;if(null!=t){var s=_this.blockList[t];if("vspace"!==(null===s||void 0===s?void 0:s.name)||"rest2"!==(null===(e=_this.blockList[s.connections[1]])||void 0===e?void 0:e.name)||"vspace"!==(null===(i=_this.blockList[s.connections[0]])||void 0===i?void 0:i.name)){for(var o=s=_this.blockList[t];"vspace"==(null===o||void 0===o?void 0:o.name);){if("vspace"!=(null===o||void 0===o?void 0:o.name))break;if("newnote"==(null===(o=_this.blockList[o.connections[0]])||void 0===o?void 0:o.name))return}if("rest2"===s.name)_this._deletePitchBlocks(t);else{if(s&&1===s.connections.length)return void console.debug("Value block encountered? "+s.name);for(;null!=last(s.connections);){var n=s.connections.length-1,c=s.connections[n];if("rest2"===_this.blockList[c].name){var l=_this.blockList[c];l.hide(),l.trash=!0,s.connections[n]=l.connections[1];break}s=_this.blockList[c]}}}}},this.deletePreviousDefault=function(t){var e,i,s=_this.blockList[t];if("rest2"===(null===(e=_this.blockList[s.connections[0]])||void 0===e?void 0:e.name)&&"vspace"===(null===(i=_this.blockList[t])||void 0===i?void 0:i.name))return s.connections[0];if(_this._blockInStack(t,["rest2"]))return _this._deletePitchBlocks(t),_this.blockList[t].connections[0];for(;null!=s.connections[0];){var o=s.connections[0];if(NOTEBLOCKS.includes(_this.blockList[o].name))break;if("rest2"===_this.blockList[o].name){var n=o,c=_this.blockList[n];c.hide(),c.trash=!0;for(var l=0;l<_this.blockList[c.connections[0]].connections.length;l++)if(_this.blockList[c.connections[0]].connections[l]===n){_this.blockList[c.connections[0]].connections[l]=_this.blockList.indexOf(s);break}s.connections[0]=c.connections[0];break}s=_this.blockList[o]}return s.connections[0]},this.reInitWidget=function(){var i=_asyncToGenerator(regeneratorRuntime.mark(function t(e,i){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,delayExecution(i);case 2:_this.blockList[e].trash||_this.activity.logo.runLogoCommands(e);case 3:case"end":return t.stop()}},t)}));return function(t,e){return i.apply(this,arguments)}}(),this.blockMoved=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var i,s,o,n,c,l,a,r,h,u,k,b,d,p,L,m,f,v,g,B,x,y,C,T,A,w,D,S,N,E,I,O,P,R,G,W,M,j,F,U,H,V,z,K,q,X,Y,J,Z,Q,$,tt,et,it,st,ot,nt,ct,lt;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(i=_this.findTopBlock(e),_this.clampBlocksToCheck=[],null==e)return console.debug("blockMoved called with null block."),t.abrupt("return");t.next=5;break;case 5:s=_this.insideExpandableBlock(e),o=0,(n=null)!=s&&(n=s),c=!1;case 10:if(null==s){t.next=19;break}if((o+=1)>2*_this.blockList.length)return console.debug("Infinite loop encountered checking for expandables?"),t.abrupt("break",19);t.next=15;break;case 15:"ifthenelse"===_this.blockList[s].name?(_this.clampBlocksToCheck.push([s,0]),_this.clampBlocksToCheck.push([s,1])):_this.clampBlocksToCheck.push([s,0]),s=_this.insideExpandableBlock(s),t.next=10;break;case 19:if(_this._checkTwoArgBlocks=[],l=[],null==(a=_this.blockList[e]))return console.debug("null block found in blockMoved method: "+e),t.abrupt("return");t.next=25;break;case 25:if(null!=(r=a.connections[0])&&(h=_this.blockList[r]),a.isArgBlock()&&null!=r&&(_this.blockList[r].isTwoArgBlock()||_this.blockList[r].isArgClamp()?h.connections[1]===e&&_this._checkTwoArgBlocks.push(r):(_this.blockList[r].isArgBlock()&&_this.blockList[r].isExpandableBlock()||_this.blockList[r].isArgClamp())&&h.connections[1]===e&&_this._checkTwoArgBlocks.push(r)),u=document.getElementsByClassName("wftTitle"),null==r){t.next=53;break}k=1;case 31:if(!(k<h.connections.length)){t.next=38;break}if(h.connections[k]===e)return h.connections[k]=null,t.abrupt("break",38);t.next=35;break;case 35:k++,t.next=31;break;case 38:a.connections[0]=null,_this.raiseStackToTop(e),b=!1,d=0;case 42:if(!(d<u.length)){t.next=53;break}if(!1!==b){t.next=50;break}t.t0=u[d].innerHTML,t.next="oscilloscope"===t.t0||"tempo"===t.t0||"rhythm maker"===t.t0||"pitch slider"===t.t0||"pitch staircase"===t.t0||"status"===t.t0||"phrase maker"===t.t0||"lego bricks"===t.t0||"custom mode"===t.t0||"music keyboard"===t.t0||"pitch drum"===t.t0||"meter"===t.t0||"temperament"===t.t0||"timbre"===t.t0?47:50;break;case 47:return b=!0,_this.blockList[i].protoblock.staticLabels[0]===u[d].innerHTML&&_this.reInitWidget(i,1500),t.abrupt("break",50);case 50:d++,t.next=42;break;case 53:p=a.container.x+a.docks[0][0],L=a.container.y+a.docks[0][1],f=m=null,v=MINIMUMDOCKDISTANCE/DEFAULTBLOCKSCALE*_this.blockScale,g=a.docks[0][2],B=!0,x=0;case 61:if(!(x<_this.blockList.length)){t.next=95;break}if(x===e)return t.abrupt("continue",92);t.next=64;break;case 64:if(_this.blockList[x].inCollapsed)return t.abrupt("continue",92);t.next=66;break;case 66:if(!COLLAPSIBLES.includes(_this.blockList[x].name)){t.next=70;break}if(INLINECOLLAPSIBLES.includes(_this.blockList[x].name)){t.next=70;break}if(_this.blockList[x].collapsed)return t.abrupt("continue",92);t.next=70;break;case 70:if(_this.blockList[x].trash)return t.abrupt("continue",92);t.next=72;break;case 72:y=1,_this.blockList[x].isInlineCollapsible()&&_this.blockList[x].collapsed&&(y=_this.blockList[x].connections.length-1),C=y;case 75:if(!(C<_this.blockList[x].connections.length)){t.next=92;break}if(C===_this.blockList[x].docks.length)return t.abrupt("break",92);t.next=78;break;case 78:if(C===_this.blockList[x].connections.length-1&&null!=_this.blockList[x].connections[C]&&_this.blockList[_this.blockList[x].connections[C]].isNoHitBlock())return t.abrupt("continue",89);t.next=82;break;case 82:if(["backward","status"].includes(_this.blockList[x].name)&&1===C&&null!=_this.blockList[x].connections[1]&&_this.blockList[_this.blockList[x].connections[1]].isNoHitBlock())return t.abrupt("continue",89);t.next=86;break;case 86:if("action"===_this.blockList[x].name&&2===C&&null!=_this.blockList[x].connections[2]&&_this.blockList[_this.blockList[x].connections[2]].isNoHitBlock())return t.abrupt("continue",89);t.next=88;break;case 88:_this._testConnectionType(g,_this.blockList[x].docks[C][2])&&(T=_this.blockList[x].container.x+_this.blockList[x].docks[C][0],A=_this.blockList[x].container.y+_this.blockList[x].docks[C][1],(w=(T-p)*(T-p)+(A-L)*(A-L))<v&&(m=x,f=C,v=w));case 89:C++,t.next=75;break;case 92:x++,t.next=61;break;case 95:if(null==m){t.next=216;break}if(D=_this._countBlocksInStack(_this.findTopBlock(m)),LONGSTACK<D&&_this.activity.errorMsg(_("Consider breaking this stack into parts.")),a.connections[0]=m,null!=(S=_this.blockList[m].connections[f])){t.next=104;break}_this.blockList[m].isArgClamp()&&(-1!==["doArg","calcArg","makeblock"].indexOf(_this.blockList[m].name)&&1===f||["doArg","nameddoArg"].includes(_this.blockList[m].name)&&f===_this.blockList[m].connections.length-1||(E=_this._getBlockSize(e),I=_this.blockList[m].argClampSlots,O=f-1,["doArg","calcArg","makeblock"].includes(_this.blockList[m].name)&&(O=f-2),I[O]!==E&&(I[O]=E,_this.blockList[m].updateArgSlots(I)))),t.next=187;break;case 104:if(B=!1,!_this.blockList[m].isArgClamp()){t.next=139;break}if(-1===["doArg","calcArg","makeblock"].indexOf(_this.blockList[m].name)||1!==f){t.next=112;break}for(_this.blockList[S].connections[0]=null,_this.findDragGroup(S),P=0;P<_this.dragGroup.length;P++)_this.moveBlockRelative(_this.dragGroup[P],40,40);t.next=137;break;case 112:if(!["doArg","nameddoArg"].includes(_this.blockList[m].name)||f!==_this.blockList[m].connections.length-1){t.next=118;break}N=_this.findBottomBlock(e),_this.blockList[S].connections[0]=N,_this.blockList[N].connections[_this.blockList[N].connections.length-1]=S,t.next=137;break;case 118:R=_this._getBlockSize(e),G=_this.blockList[m].argClampSlots,W=_this.blockList[m].connections.indexOf(S),M=W-1,["doArg","calcArg","makeblock"].includes(_this.blockList[m].name)&&(M=W-2),F=j=null,U=M;case 126:if(!(U<G.length)){t.next=133;break}if(null==_this.blockList[m].connections[W+U-M])return F=W+U-M,t.abrupt("break",133);t.next=130;break;case 130:U++,t.next=126;break;case 133:if(null==F){for(G.push(1),"makeblock"!==_this.blockList[m].name&&_this._newLocalArgBlock(G.length),F=W+j-M,_this.blockList[m].connections.push(null),H=G.length-1;M+1<H;H--)G[H]=G[H-1];for(V=_this.blockList[m].connections.length-1;W+1<V;V--)_this.blockList[m].connections[V]=_this.blockList[m].connections[V-1]}f+=1,G[M+1]=R,_this.blockList[m].updateArgSlots(G);case 137:t.next=187;break;case 139:if(!a.isArgBlock()){t.next=186;break}if(_this.blockList[S].connections[0]=null,"number"===_this.blockList[S].name)_this.sendStackToTrash(_this.blockList[S]);else for(_this.findDragGroup(S),z=0;z<_this.dragGroup.length;z++)_this.moveBlockRelative(_this.dragGroup[z],40,40);if("action"!==_this.blockList[m].name){t.next=177;break}if(c=!0,a.value!==_this.blockList[S].value)return K=a.connections[0],a.connections[0]=null,q=_this.findUniqueActionName(a.value),a.connections[0]=K,q!==a.value&&(a.value=q,X=q,getTextWidth(X,"bold 20pt Sans")>TEXTWIDTH&&(X=X.substr(0,STRINGLEN)+"..."),a.text.text=X,a.container.updateCache()),t.next=152,delayExecution(75);t.next=175;break;case 152:q=_this.blockList[S].value,null!=_this.protoBlockDict["myDo_"+q]&&(delete _this.protoBlockDict["myDo_"+q],_this.activity.palettes.dict.action.hideMenu(!0)),_this.newNameddoBlock(a.value,_this.actionHasReturn(m),_this.actionHasArgs(m)),Y=_this.activity.palettes.dict.action,J=0;case 157:if(!(J<Y.protoList.length)){t.next=173;break}if("nameddo"===(Z=Y.protoList[J]).name&&Z.staticLabels[0]===_this.blockList[S].value)return t.next=162,delayExecution(50);t.next=170;break;case 162:return Y.remove(Z,_this.blockList[S].value),delete _this.protoBlockDict["myDo_"+_this.blockList[S].value],_this.activity.palettes.hide(),_this.activity.palettes.updatePalettes("action"),t.next=168,delayExecution(500);case 168:return _this.activity.palettes.show(),t.abrupt("break",173);case 170:J++,t.next=157;break;case 173:_this.renameNameddos(_this.blockList[S].value,a.value),_this.renameDos(_this.blockList[S].value,a.value);case 175:t.next=184;break;case 177:if("storein"!==_this.blockList[m].name){t.next=184;break}if(1===f&&"box"!==a.value)return _this.newStorein2Block(a.value),_this.newNamedboxBlock(a.value),t.next=183,delayExecution(50);t.next=184;break;case 183:_this.activity.palettes.updatePalettes("boxes");case 184:t.next=187;break;case 186:"argclamparg"===a.protoblock.style||(_this.blockList[e].isArgFlowClampBlock()?console.debug("HOW DID WE GET HERE?"):(N=_this.findBottomBlock(e),_this.blockList[S].connections[0]=N,_this.blockList[N].connections[_this.blockList[N].connections.length-1]=S));case 187:if(_this.blockList[m].connections[f]=e,null!=_this._insideNoteBlock(e)&&1<_this.blockList[e].connections.length&&(B?m=_this.deletePreviousDefault(e):N&&_this.deleteNextDefault(N)),"action"!==_this.blockList[m].name||c){t.next=198;break}Q=0;case 191:if(!(Q<_this.blockList.length)){t.next=198;break}if(Q===m)return t.abrupt("continue",195);t.next=194;break;case 194:"action"===_this.blockList[Q].name&&null!=_this.blockList[Q].connections[1]&&_this.blockList[_this.blockList[Q].connections[1]].value===_this.blockList[e].value&&(_this.blockList[e].value=_this.findUniqueActionName(_this.blockList[e].value),$=_this.blockList[e].value,getTextWidth($,"bold 20pt Sans")>TEXTWIDTH&&($=$.substr(0,STRINGLEN)+"..."),_this.blockList[e].text.text=$,_this.blockList[e].container.updateCache(),_this.newNameddoBlock(_this.blockList[e].value,_this.actionHasReturn(Q),_this.actionHasArgs(Q)),_this.setActionProtoVisiblity(!1));case 195:Q++,t.next=191;break;case 198:if(_this.adjustDocks(m,!0),tt=!1,null!==r){t.next=216;break}et=0;case 202:if(!(et<u.length)){t.next=216;break}if(it=_this,!1!==tt){t.next=213;break}st=void 0,t.t1=u[et].innerHTML,t.next="oscilloscope"===t.t1||"tempo"===t.t1||"rhythm maker"===t.t1||"pitch slider"===t.t1||"pitch staircase"===t.t1||"status"===t.t1||"phrase maker"===t.t1||"lego bricks"===t.t1||"custom mode"===t.t1||"music keyboard"===t.t1||"pitch drum"===t.t1||"meter"===t.t1||"temperament"===t.t1||"timbre"===t.t1?209:213;break;case 209:return tt=!0,st=it.findTopBlock(e),_this.blockList[st].protoblock.staticLabels[0]==u[et].innerHTML&&_this.reInitWidget(st,1500),t.abrupt("break",213);case 213:et++,t.next=202;break;case 216:if((a.isArgBlock()||["calcArg","namedcalcArg","makeblock"].includes(a.name))&&null!=m&&(_this.blockList[m].isTwoArgBlock()?_this.blockList[m].connections[1]===e&&(_this._checkTwoArgBlocks.includes(m)||_this._checkTwoArgBlocks.push(m)):_this.blockList[m].isArgBlock()&&_this.blockList[m].isExpandableBlock()&&_this.blockList[m].connections[1]===e&&(_this._checkTwoArgBlocks.includes(m)||_this._checkTwoArgBlocks.push(m)),ot=_this.blockList[m].connections.length,_this.blockList[m].connections[ot-2]===e&&(_this.blockList[m].isArgClamp()||"in"!==_this.blockList[m].docks[ot-1][2]||l.push(m))),_this.addDefaultBlock(n,e,c),0<l.length)for(nt=0;nt<l.length;nt++)_this._addRemoveVspaceBlock(l[nt]);for(0<_this._checkTwoArgBlocks.length&&_this._adjustExpandableTwoArgBlock(_this._checkTwoArgBlocks),ct=0;ct<l.length;ct++)_this.adjustDocks(l[ct],!0);s=_this.insideExpandableBlock(e),o=0;case 223:if(null==s){t.next=233;break}if((o+=1)>2*_this.blockList.length)return console.debug("Infinite loop checking for expandables?"),console.debug(_this.blockList),t.abrupt("break",233);t.next=229;break;case 229:"ifthenelse"===_this.blockList[s].name?(_this.clampBlocksToCheck.push([s,0]),_this.clampBlocksToCheck.push([s,1])):_this.clampBlocksToCheck.push([s,0]),s=_this.insideExpandableBlock(s),t.next=223;break;case 233:_this.isBlockMoving=!1,_this.adjustExpandableClampBlock(),_this.activity.refreshCanvas(),_this.activity.turtles.running()&&(_this.activity.logo.doStopTurtles(),(lt=document.getElementById("stop"))&&(lt.style.color="white"));case 237:case"end":return t.stop()}},t)}));return function(t){return e.apply(this,arguments)}}(),this._testConnectionType=function(t,e){return"vspaceout"===t&&"vspacein"===e||("vspacein"===t&&"vspaceout"===e||("in"===t&&"out"===e||("out"===t&&"in"===e||("in"===t&&"vspaceout"===e||("vspaceout"===t&&"in"===e||("out"===t&&"vspacein"===e||("vspacein"===t&&"out"===e||(!("numberin"!==t||!["numberout","anyout"].includes(e))||(!(!["numberout","anyout"].includes(t)||"numberin"!==e)||(!("textin"!==t||!["textout","anyout"].includes(e))||(!(!["textout","anyout"].includes(t)||"textin"!==e)||("booleanout"===t&&"booleanin"===e||("booleanin"===t&&"booleanout"===e||("mediain"===t&&"mediaout"===e||("mediaout"===t&&"mediain"===e||("mediain"===t&&"textout"===e||("mediain"===e&&"textout"===t||("filein"===t&&"fileout"===e||("fileout"===t&&"filein"===e||("casein"===t&&"caseout"===e||("caseout"===t&&"casein"===e||("vspaceout"===t&&"casein"===e||("casein"===t&&"vspaceout"===e||("vspacein"===t&&"caseout"===e||("caseout"===t&&"vspacein"===e||(!("solfegein"!==t||!["anyout","solfegeout","textout","noteout","scaledegreeout","numberout"].includes(e))||(!("solfegein"!==e||!["anyout","solfegeout","textout","noteout","scaledegreeout","numberout"].includes(t))||(!("notein"!==t||!["solfegeout","scaledegreeout","textout","noteout"].includes(e))||("pitchout"===t&&"anyin"===e||("gridout"===t&&"anyin"===e||(!("notein"!==e||!["solfegeout","scaledegreeout","textout","noteout"].includes(t))||(!("anyin"!==t||!["textout","mediaout","numberout","anyout","fileout","solfegeout","scaledegreeout","noteout"].includes(e))||!("anyin"!==e||!["textout","mediaout","numberout","anyout","fileout","solfegeout","scaledegreeout","noteout"].includes(t))))))))))))))))))))))))))))))))))},this.updateBlockPositions=function(){for(var t in _this.blockList)_this._moveBlock(t,_this.blockList[t].container.x,_this.blockList[t].container.y)},this.bringToTop=function(){var t;for(t in _this._adjustTheseStacks=[],_this.blockList){null==_this.blockList[t].connections[0]&&_this._adjustTheseStacks.push(t)}for(var e=0;e<_this._adjustTheseStacks.length;e++)_this.raiseStackToTop(_this._adjustTheseStacks[e]);_this.activity.refreshCanvas()},this.checkBounds=function(){var t=!0;for(var e in _this.blockList)if(null==_this.blockList[e].connections[0]&&_this.blockList[e].offScreen(_this.boundary)){_this.activity.setHomeContainers(!0),t=!1;break}t&&(_this.activity.setHomeContainers(!1),_this.boundary.hide())},this.moveBlock=function(t,e,i){_this._moveBlock(t,e,i),_this.adjustDocks(t,!0)},this._moveBlock=function(t,e,i){var s=_this.blockList[t];null!=s.container?(s.container.x=Math.floor(e+.5),s.container.y=Math.floor(i+.5),_this.checkBounds()):console.debug("No container yet for block "+s.name)},this.moveBlockRelative=function(t,e,i){_this.inLongPress=!1,_this.isBlockMoving=!0;var s=_this.blockList[t];null!=s.container?(s.container.x+=e,s.container.y+=i,_this.checkBounds()):console.debug("No container yet for block "+s.name)},this.moveStackRelative=function(t,e,i){if(_this.findDragGroup(t),0<_this.dragGroup.length)for(var s=0;s<_this.dragGroup.length;s++)_this.moveBlockRelative(_this.dragGroup[s],e,i)},this.moveAllBlocksExcept=function(t,e,i){for(var s in _this.blockList){_this.blockList[_this.findTopBlock(s)]!==t&&_this.moveBlockRelative(s,e,i)}},this.updateBlockText=function(t){var e,i,s=_this.blockList[t],o=8;if(null!=s.text){switch(s.name){case"loadFile":try{c=s.value[0].toString()}catch(t){c=_("open file")}o=10;break;case"audiofile":try{null===s.value[0]?c=_("audio file"):(c=s.value[0].toString(),getTextWidth(c,"bold 20pt Sans")>TEXTWIDTH&&(c=c.substr(0,STRINGLEN)+"..."))}catch(t){c=_("audio file")}break;case"solfege":null===s.value&&(s.value="sol"),e=splitSolfege(s.value),c=i18nSolfege(e[0]),(i=e[1])!==NATURAL&&(c+=i);break;case"scaledegree2":null===s.value&&(s.value="4"),c=(e=splitScaleDegree(s.value))[0],(i=e[1])!==NATURAL&&(c+=i);break;case"customNote":c=_(s.value);break;case"eastindiansolfege":null===s.value&&(s.value="sol"),e=splitSolfege(s.value),c=WESTERN2EISOLFEGENAMES[e[0]],(i=e[1])!==NATURAL&&(c+=i);break;case"modename":null===s.value&&(s.value=DEFAULTMODE),c=_(s.value);break;case"chordname":null===s.value&&(s.value=DEFAULTCHORD),c=_(s.value);break;case"accidentalname":case"intervalname":if(null===s.value)switch(s.name){case"accidentalname":s.value=DEFAULTACCIDENTAL;break;case"intervalname":s.value=DEFAULTINTERVAL}e=s.value.split(" "),c=_(e[0])+" "+e[1];break;case"grid":c=_(s.value);break;case"filtertype":case"drumname":case"effectsname":case"voicename":case"oscillatortype":case"invertmode":if(null===s.value)switch(s.name){case"filtertype":s.value=DEFAULTFILTERTYPE;break;case"drumname":s.value=DEFAULTDRUM;break;case"effectsname":s.value=DEFAULTEFFECT;break;case"voicename":s.value=DEFAULTVOICE;break;case"oscillatortype":s.value=DEFAULTOSCILLATORTYPE;break;case"invertmode":s.value=DEFAULTINVERT}c=_(s.value);break;case"noisename":c=getNoiseName(s.value);break;case"temperamentname":for(var n=getTemperamentsList(),c=_(n[0][1]),l=0;l<n.length;l++)if(n[l][1]===s.value){c=0===n[l][0].length?n[l][2]:n[l][0];break}break;case"wrapmode":c="on"===s.value?_("on2"):_("off");break;case"boolean":c=s.value?_("true"):_("false");break;default:c=null==s.value?"":"string"!=typeof s.value?s.value.toString():s.value}!WIDENAMES.includes(s.name)&&c.length>o&&(c=c.substr(0,o-1)+"..."),s.text.text=c;var a=s.container.children.length-1;s.container.setChildIndex(s.text,a),s.loadComplete?s.container.updateCache():console.debug("Load not yet complete for ("+t+") "+s.name)}},this.findTopBlock=function(t){if(null==t)return null;var e=_this.blockList[t];if(null==e.connections)return t;if(0===e.connections.length)return t;if(1<e.connections.length&&null!=e.connections[0]&&e.connections[0]===last(e.connections))return console.debug("WARNING: CORRUPTED BLOCK DATA. Block "+e.name+" ("+t+") is connected to the same block "+_this.blockList[e.connections[0]].name+" ("+e.connections[0]+") twice."),t;for(var i=0;null!=e.connections[0];){if((i+=1)>2*_this.blockList.length){console.debug("infinite loop finding topBlock?"),console.debug(_this.blockList.indexOf(e)+" "+e.name);break}t=e.connections[0],e=_this.blockList[t]}return t},this.sameGeneration=function(t,e){if(null==t||null==e)return!1;if(t===e)return!0;if(null==(o=_this.blockList[t]).connections)return!1;if(0===o.connections.length)return!1;for(var i=0;null!=last(o.connections);){if((i+=1)>2*_this.blockList.length){console.debug("infinite loop finding bottomBlock?");break}var s=last(o.connections),o=_this.blockList[s];if(s===e)return!0}return!1},this._blockInStack=function(t,e){for(var i=0;null!=t;){if(e.includes(_this.blockList[t].name))return!0;if(t=1<_this.blockList[t].connections.length?last(_this.blockList[t].connections):null,(i+=1)>_this.blockList.length){console.debug("infinite loop finding block name in stack");break}}return!1},this.findBottomBlock=function(t){if(null==t)return null;var e=_this.blockList[t];if(null==e.connections)return t;if(0===e.connections.length)return t;for(var i=0;null!=last(e.connections);){if((i+=1)>2*_this.blockList.length){console.debug("infinite loop finding bottomBlock?");break}t=last(e.connections),e=_this.blockList[t]}return t},this._countBlocksInStack=function(t){var e=0;if(null!==t){e+=1;for(var i=1;i<_this.blockList[t].connections.length;i++)e+=_this._countBlocksInStack(_this.blockList[t].connections[i])}return e},this.findStacks=function(){_this.stackList=[];for(var t=0;t<_this.blockList.length;t++)null==_this.blockList[t].connections[0]&&_this.stackList.push(t)},this._findClamps=function(){_this._expandablesList=[],_this.findStacks();for(var t=0;t<_this.stackList.length;t++)_this._searchCounter=0,_this._searchForExpandables(_this.stackList[t]);_this._searchForArgFlow()},this._findTwoArgs=function(){_this._expandablesList=[];for(var t=0;t<_this.blockList.length;t++)(_this.blockList[t].isArgBlock()&&_this.blockList[t].isExpandableBlock()||_this.blockList[t].isTwoArgBlock())&&_this._expandablesList.push(t)},this._searchForArgFlow=function(){for(var t in _this.blockList)_this.blockList[t].isArgFlowClampBlock()&&(_this._searchCounter=0,_this._searchForExpandables(t),_this._expandablesList.push(t))},this._searchForExpandables=function(t){for(var e;null!=t&&null!=_this.blockList[t]&&!_this.blockList[t].isValueBlock();){if(_this._searchCounter+=1,_this._searchCounter>2*_this.blockList.length){console.debug("infinite loop searching for Expandables? "+_this._searchCounter),console.debug(t+" "+_this.blockList[t].name);break}_this.blockList[t].isClampBlock()?(_this._expandablesList.push(t),e=_this.blockList[t].connections.length-2,_this._searchForExpandables(_this.blockList[t].connections[e]),"ifthenelse"===_this.blockList[t].name&&_this._searchForExpandables(_this.blockList[t].connections[2])):_this.blockList[t].isArgClamp()&&_this._expandablesList.push(t),t=1<_this.blockList[t].connections.length?last(_this.blockList[t].connections):null}},this._expandTwoArgs=function(){_this._findTwoArgs(),_this._adjustExpandableTwoArgBlock(_this._expandablesList),_this.activity.refreshCanvas()},this._expandClamps=function(){_this._findClamps(),_this.clampBlocksToCheck=[];for(var t=0;t<_this._expandablesList.length;t++)"ifthenelse"===_this.blockList[_this._expandablesList[t]].name?(_this.clampBlocksToCheck.push([_this._expandablesList[t],0]),_this.clampBlocksToCheck.push([_this._expandablesList[t],1])):_this.clampBlocksToCheck.push([_this._expandablesList[t],0]);_this.adjustExpandableClampBlock(),_this.activity.refreshCanvas()},this.changeDisabledStatus=function(t,e){for(var i in _this.blockList){var s=_this.blockList[i];s.name===t&&(s.protoblock.disabled=e,s.regenerateArtwork(!1))}},this.unhighlightAll=function(){for(var t in _this.blockList)_this.unhighlight(t)},this.unhighlight=function(t){var e;_this.visible&&(null===(e=t)&&(e=_this.highlightedBlock),null!==e&&_this.blockList[e].unhighlight(),_this.highlightedBlock===e&&(_this.highlightedBlock=null))},this.highlight=function(t,e){_this.visible&&null!==t&&(e&&_this.unhighlight(null),_this.blockList[t].highlight(),_this.highlightedBlock=t)},this.hide=function(){for(var t in _this.blockList)_this.blockList[t].hide();_this.visible=!1},this.show=function(){for(var t in _this.blockList)_this.blockList[t].show();_this.visible=!0},this._makeNewBlockWithConnections=function(t,e,i,s,o){var n=_this.makeNewBlock(t,s,o);if(null!==n)for(var c=0;c<i.length&&c!==n.docks.length;c++)null==i[c]?n.connections.push(null):n.connections.push(i[c]+e);else console.debug("could not make block "+t)},this.makeNewBlock=function(t,e,i){if(null==_this.protoBlockDict[t])return console.debug("makeNewBlock: no prototype for "+t),null;if(["sine","sawtooth","triangle","square"].includes(t)&&_this.activity.logo.synth.loadSynth(0,t),["namedbox","nameddo","namedcalc","nameddoArg","namedcalcArg","outputtools"].includes(t)?_this.blockList.push(new Block(_this.protoBlockDict[t],_this,i[1])):"namedarg"===t?_this.blockList.push(new Block(_this.protoBlockDict[t],_this,"arg "+i[1])):_this.blockList.push(new Block(_this.protoBlockDict[t],_this)),null==last(_this.blockList))return console.debug("failed to make protoblock for "+t),null;var s=last(_this.blockList);return s.copySize(),s.postProcess=e,s.postProcessArg=i,s.container=new createjs.Container,_this.activity.blocksContainer.addChild(s.container),s.container.snapToPixelEnabled=!0,s.container.x=0,s.container.y=0,s.imageLoad(),s},this.makeBlock=function(t,e){var i,n=_this,s=function(t){var e=t[0],i=t[1];switch(n.blockList[e].value=i,n.blockList[e].name){case"drumname":case"effectsname":case"voicename":case"oscillatortype":case"invertmode":case"filtertype":case"noisename":n.blockList[e].text.text=_(i);break;case"temperamentname":var s=getTemperamentsList();n.blockList[e].text.text=_(s[0][1]);for(var o=0;o<s.length;o++)if(s[o][1]===i){n.blockList[e].text.text=s[o][0];break}break;case"wrapmode":n.blockList[e].text.text="on"===i?_("on2"):_("off");break;case"boolean":n.blockList[e].text.text=i?_("true"):_("false");break;default:n.blockList[e].text.text=i}n.blockList[e].container.updateCache()},o=null,c=_this.blockList.length;"start"===t?(s=function(t){n.blockList[t].value=n.turtles.getTurtleCount(),n.turtles.addTurtle(n.blockList[t])},o=c):"outputtools"===t?(s=function(t){n.blockList[c].value=null,n.blockList[c].privateData=t[1]},o=[c,e]):"text"===t?o=[c,_("text")]:"boolean"===t?o=[c,!0]:"solfege"===t?o=[c,"sol"]:"scaledegree2"===t?o=[c,"5"]:"customNote"===t?(i=_this.activity.logo.synth.startingPitch.length,o=[c,_this.activity.logo.synth.startingPitch.substring(0,i-1)+"(+0%)"]):"notename"===t?o=[c,"G"]:"drumname"===t?o=[c,DEFAULTDRUM]:"effectsname"===t?o=[c,DEFAULTEFFECT]:"filtertype"===t?o=[c,DEFAULTFILTER]:"oscillatortype"===t?o=[c,DEFAULTOSCILLATORTYPE]:"voicename"===t?o=[c,DEFAULTVOICE]:"noisename"===t?o=[c,DEFAULTNOISE]:"eastindiansolfege"===t?(s=function(t){var e=t[0],i=t[1];n.blockList[e].value=i,n.blockList[e].text.text=WESTERN2EISOLFEGENAMES[i],n.blockList[e].container.updateCache()},o=[c,"sol"]):"modename"===t?(s=function(t){var e=t[0],i=t[1];n.blockList[e].value=i,n.blockList[e].text.text=i,n.blockList[e].container.updateCache()},o=[c,DEFAULTMODE]):"chordname"===t?(s=function(t){var e=t[0],i=t[1];n.blockList[e].value=i,n.blockList[e].text.text=i,n.blockList[e].container.updateCache()},o=[c,DEFAULTCHORD]):"accidentalname"===t?(s=function(t){var e=t[0],i=t[1],s=(n.blockList[e].value=i).split(" ");n.blockList[e].text.text=_(s[0])+" "+s[1],n.blockList[e].container.updateCache()},o=[c,DEFAULTACCIDENTAL]):"intervalname"===t?(s=function(t){var e=t[0],i=t[1],s=(n.blockList[e].value=i).split(" ");n.blockList[e].text.text=_(s[0])+" "+s[1],n.blockList[e].container.updateCache()},o=[c,DEFAULTINTERVAL]):"temperamentname"===t?o=[c,DEFAULTTEMPERAMENT]:"invertmode"===t?o=[c,DEFAULTINVERT]:"number"===t?(s=function(t){var e=t[0],i=Number(t[1]);n.blockList[e].value=i,n.blockList[e].text.text=i.toString(),n.blockList[e].container.updateCache()},o=[c,NUMBERBLOCKDEFAULT]):"loudness"===t||"pitchness"===t?s=function(){n.activity.logo.initMediaDevices()}:"media"===t?(s=function(t){var e=t[0],i=t[1];n.blockList[e].value=i,n.blockList[e].image=null==i?"images/load-media.svg":null},o=[c,null]):"camera"===t?(s=function(t){var e=t[0],i=t[1];n.blockList[e].value=CAMERAVALUE,n.blockList[e].image=null==i?"images/camera.svg":null},o=[c,null]):"video"===t?(s=function(t){var e=t[0],i=t[1];n.blockList[e].value=VIDEOVALUE,n.blockList[e].image=null==i?"images/video.svg":null},o=[c,null]):"loadFile"===t?(s=function(t){n.updateBlockText(t[0])},o=[c,null]):["storein2","namedbox","nameddo","namedcalc","nameddoArg","namedcalcArg","namedarg"].includes(t)?(s=function(t){n.blockList[c].value=null,n.blockList[c].privateData=t[1]},o=[c,e]):"newnote"===t?(s=function(){},o=[c,null]):s=null;var l=!1;for(var a in n.protoBlockDict)if(n.protoBlockDict[a].name===t){if("__NOARG__"===e){n.makeNewBlock(a,s,o),l=!0;break}if(n.protoBlockDict[a].defaults[0]===e){n.makeNewBlock(a,s,o),l=!0;break}if(["namedbox","nameddo","namedcalc","nameddoArg","namedcalcArg","namedarg"].includes(t)){if(void 0===n.protoBlockDict[a].defaults[0]){n.makeNewBlock(a,s,o),l=!0;break}}else{if("storein2"===t){s=function(t){var e=n.blockList[c].connections[0];t[1]===_("store in box")?n.blockList[e].privateData=_("box"):(n.blockList[e].privateData=t[1],"box1"===t[1]?n.blockList[e].overrideName=_("box1"):"box2"===t[1]?n.blockList[e].overrideName=_("box2"):n.blockList[e].overrideName=t[1],n.blockList[e].regenerateArtwork(!1))},o=[c,e],n.makeNewBlock(a,s,o),l=!0;break}if("outputtools"===t&&void 0===n.protoBlockDict[a].defaults[0]){n.makeNewBlock(a,s,o),l=!0;break}}}l||console.debug(t+" not found!!");for(var r=_this.blockList.length-1,h=_this.blockList[r],u=0;u<h.docks.length;u++)h.connections.push(null);for(var k=1+r,b=0;b<h.protoblock.defaults.length;b++)!function(t){var o=h.protoblock.defaults[t];"action"===h.name&&(o=_this.findUniqueActionName(_("action")))!==_("action")&&(_this.newNameddoBlock(o,!1,!1),_this.activity.palettes.updatePalettes("action")),c=_this.blockList.length,h.docks.length>t&&"anyin"===h.docks[t+1][2]?null==o?console.debug("cannot set default value"):"string"==typeof o?(s=function(t){var e=t[0],i=t[1];n.blockList[e].value=i;var s=o.toString();!WIDENAMES.includes(n.blockList[e].name)&&getTextWidth(s,"bold 20pt Sans")>TEXTWIDTH&&(s=s.substr(0,STRINGLEN)+"..."),n.blockList[e].text.text=s,n.blockList[e].container.updateCache()},_this.makeNewBlock("text",s,[c,o])):(s=function(t){var e=t[0],i=Number(t[1]);n.blockList[e].value=i,n.blockList[e].text.text=i.toString()},_this.makeNewBlock("number",s,[c,o])):"textin"===h.docks[t+1][2]?(s=function(t){var e=t[0],i=t[1],s=(n.blockList[e].value=i).toString();!WIDENAMES.includes(n.blockList[e].name)&&getTextWidth(s,"bold 20pt Sans")>TEXTWIDTH&&(s=s.substr(0,STRINGLEN)+"..."),n.blockList[e].text.text=s},_this.makeNewBlock("text",s,[c,o])):"solfegein"===h.docks[t+1][2]?(s=function(t){var e=t[0],i=t[1];n.blockList[e].value=i;var s=i18nSolfege(i.toString());n.blockList[e].text.text=s},_this.makeNewBlock("solfege",s,[c,o])):"notein"===h.docks[t+1][2]?(s=function(t){var e=t[0],i=t[1],s=(n.blockList[e].value=i).toString();n.blockList[e].text.text=s},_this.makeNewBlock("notename",s,[c,o])):"mediain"===h.docks[t+1][2]?(s=function(t){var e=t[0],i=t[1];n.blockList[e].value=i},_this.makeNewBlock("media",s,[c,o])):"filein"===h.docks[t+1][2]?(s=function(t){n.updateBlockText(t)},_this.makeNewBlock("loadFile",s,c)):(s=function(t){var e=t[0],i=t[1];n.blockList[e].value=i,n.blockList[e].text.text=i.toString()},_this.makeNewBlock("number",s,[c,o]));var e=_this.blockList[k+t];e.connections=[r],e.value=o,h.connections[t+1]=k+t}(b);return _this.updateBlockPositions(),_this.adjustDocks(r,!0),_this.activity.refreshCanvas(),r},this.findDragGroup=function(t){null!=t?(_this.dragLoopCounter=0,_this.dragGroup=[],_this._calculateDragGroup(t)):console.debug("null block passed to findDragGroup")},this._calculateDragGroup=function(t){if(_this.dragLoopCounter+=1,_this.dragLoopCounter>_this.blockList.length)console.debug("Maximum loop counter exceeded in calculateDragGroup... this is bad. "+t);else if(null!=t){var e=_this.blockList[t];if(null!=e)if(null!=e.connections)if(0!==e.connections.length){_this.dragGroup.push(t);for(var i=1;i<e.connections.length;i++){var s=e.connections[i];null!=s&&_this._calculateDragGroup(s)}}else _this.dragGroup=[t];else _this.dragGroup=[t];else console.debug("null block encountered... this is bad. "+t)}else console.debug("null block passed to calculateDragGroup")},this.setActionProtoVisiblity=function(t){for(var e=_this.activity.palettes.dict.action,i=!1,s=0;s<e.protoList.length;s++){var o=e.protoList[s];"nameddo"===o.name&&0===o.defaults.length&&o.hidden===t&&(o.hidden=!t,i=!0)}i&&_this.activity.palettes.updatePalettes("action")},this.findUniqueActionName=function(t,e){t===_("action")&&_this.setActionProtoVisiblity(!0);var i,s=[];for(var o in _this.blockList){"text"!==_this.blockList[o].name&&"string"!==_this.blockList[o].name||_this.blockList[o].trash||(null===(i=_this.blockList[o].connections[0])||"action"!==_this.blockList[i].name||_this.blockList[i].trash||e!==i&&s.push(_this.blockList[o].value))}for(var n=1,c=t;s.includes(c);)c=t+n.toString(),n+=1;return c},this.findUniqueCustomName=function(t){var e,i=[];for(var s in _this.blockList){"text"!==_this.blockList[s].name||_this.blockList[s].trash||(null==(e=_this.blockList[s].connections[0])||"pitch"!==_this.blockList[e].name||_this.blockList[e].trash||i.push(_this.blockList[s].value))}for(var o=1,n=t;i.includes(n);)n=t+o.toString(),o+=1;return n},this.findUniqueTemperamentName=function(t){var e,i=[];for(var s in _this.blockList){"text"!==_this.blockList[s].name||_this.blockList[s].trash||(null==(e=_this.blockList[s].connections[0])||"temperament1"!==_this.blockList[e].name||_this.blockList[e].trash||i.push(_this.blockList[s].value))}for(var o=1,n=t;i.includes(n);)n=t+o.toString(),o+=1;return n},this._findDrumURLs=function(){for(var t in _this.blockList){var e;"text"!==_this.blockList[t].name&&"string"!==_this.blockList[t].name||null!=(e=_this.blockList[t].connections[0])&&["playdrum","setdrum","playnoise","setvoice"].includes(_this.blockList[e].name)&&"http"===_this.blockList[t].value.slice(0,4)&&_this.activity.logo.synth.loadSynth(0,_this.blockList[t].value)}},this.renameBoxes=function(t,e){if(t!==e&&t!==_("box"))for(var i in _this.blockList)if("text"===_this.blockList[i].name){var s=_this.blockList[i].connections[0];if(null!=s&&"box"===_this.blockList[s].name&&_this.blockList[i].value===t){_this.blockList[i].value=e,_this.blockList[i].text.text=e;try{_this.blockList[i].container.updateCache()}catch(t){console.debug(t)}}}},this.renameStoreinBoxes=function(t,e){if(t!==e&&t!==_("box"))for(var i in _this.blockList)if("text"===_this.blockList[i].name){var s=_this.blockList[i].connections[0];if(null!=s&&"storein"===_this.blockList[s].name&&_this.blockList[i].value===t){_this.blockList[i].value=e,_this.blockList[i].text.text=e;try{_this.blockList[i].container.updateCache()}catch(t){console.debug(t)}}}else if("storein2"===_this.blockList[i].name&&_this.blockList[i].privateData===t){_this.blockList[i].privateData=e,_this.blockList[i].overrideName="box1"===e?_("box1"):"box2"===e?_("box2"):e,_this.blockList[i].regenerateArtwork();try{_this.blockList[i].container.updateCache()}catch(t){console.debug(t)}}},this.renameStorein2Boxes=function(t,e){if(t!==e&&t!==_("box"))for(var i in _this.blockList)if("storein2"===_this.blockList[i].name&&_this.blockList[i].privateData===t){_this.blockList[i].privateData=e,_this.blockList[i].overrideName="box1"===e?_("box1"):"box2"===e?_("box2"):e,_this.blockList[i].regenerateArtwork();try{_this.blockList[i].container.updateCache()}catch(t){console.debug(t)}}},this.renameNamedboxes=function(t,e){if(t!==e&&t!==_("box"))for(var i in _this.blockList)if("namedbox"===_this.blockList[i].name&&_this.blockList[i].privateData===t){_this.blockList[i].privateData=e,_this.blockList[i].overrideName="box1"===e?_("box1"):"box2"===e?_("box2"):e,_this.blockList[i].regenerateArtwork();try{_this.blockList[i].container.updateCache()}catch(t){console.debug(t)}}},this.renameDos=function(t,e,i){if(t!==e)for(var s in _this.blockList){var o,n,c;s!==i&&(o=_this.blockList[s],null!=(n=_this.blockList[o.connections[0]])&&["do","calc","doArg","calcArg","action","offbeatdo","onbeatdo","listen"].includes(n.name)&&("onbeatdo"!==n.name&&"listen"!==n.name||2===n.connections.indexOf(s))&&o.value===t&&(o.value=e,c=o.value,getTextWidth(c,"bold 20pt Sans")>TEXTWIDTH&&(c=c.substr(0,STRINGLEN)+"..."),o.text.text=c,o.container.updateCache()))}},this.renameNameddos=function(t,e){if(t!==e){for(var i in _this.blockList){var s;["nameddo","namedcalc","nameddoArg","namedcalcArg"].includes(_this.blockList[i].name)&&_this.blockList[i].privateData===t&&(s=_this.blockList[i].privateData=e,getTextWidth(s,"bold 20pt Sans")>TEXTWIDTH&&(s=s.substr(0,STRINGLEN)+"..."),_this.blockList[i].overrideName=s,_this.blockList[i].regenerateArtwork())}for(var o=_this.activity.palettes.dict.action,n=!1,c=0;c<o.protoList.length;c++){var l=o.protoList[c];-1!==["nameddo","namedcalc","nameddoArg","namedcalcArg"].indexOf(l.name)&&l.defaults[0]===t&&(l.defaults[0]=e,n=!0)}n&&_this.activity.palettes.updatePalettes("action")}},this.newStoreinBlock=function(t){var e;null!=t?null!=t?"myStorein_"+t in _this.protoBlockDict||(e=new ProtoBlock("storein"),(_this.protoBlockDict["myStorein_"+t]=e).palette=_this.activity.palettes.dict.boxes,e.defaults.push(t),e.defaults.push(NUMBERBLOCKDEFAULT),e.staticLabels.push(_("store in"),_("name"),_("value")),e.adjustWidthToLabel(),e.twoArgBlock(),e.dockTypes[1]="anyin",e.dockTypes[2]="anyin","box"!==t&&_this.activity.palettes.dict.boxes.add(e,!0)):console.debug("undefined name passed to newStoreinBlock"):console.debug("null name passed to newStoreinBlock")},this.newStorein2Block=function(t){var e;null!=t?null!=t?"yourStorein2_"+t in _this.protoBlockDict||(e=new ProtoBlock("storein2"),(_this.protoBlockDict["yourStorein2_"+t]=e).palette=_this.activity.palettes.dict.boxes,e.defaults.push(t),e.staticLabels.push(t),e.adjustWidthToLabel(),e.oneArgBlock(),e.dockTypes[1]="anyin","box"!==t&&_this.activity.palettes.dict.boxes.add(e,!0)):console.debug("undefined name passed to newStorein2Block"):console.debug("null name passed to newStorein2Block")},this.newNamedboxBlock=function(t){var e;null!=t?null!=t?"myBox_"+t in _this.protoBlockDict||(e=new ProtoBlock("namedbox"),(_this.protoBlockDict["myBox_"+t]=e).palette=_this.activity.palettes.dict.boxes,e.defaults.push(t),e.staticLabels.push(t),e.parameterBlock(),"box"!==t&&e.palette.add(e,!0)):console.debug("undefined name passed to newNamedboxBlock"):console.debug("null name passed to newNamedboxBlock")},this._newLocalArgBlock=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var i,s;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if("myArg_"+(i="arg_"+e)in _this.protoBlockDict)return t.abrupt("return");t.next=3;break;case 3:if(s=new ProtoBlock("namedarg"),(_this.protoBlockDict["myArg_"+i]=s).palette=_this.activity.palettes.dict.action,s.defaults.push(e),s.staticLabels.push("arg "+e),s.parameterBlock(),"arg_1"===i)return t.abrupt("return");t.next=11;break;case 11:return s.palette.add(s,!0),t.next=14,delayExecution(100);case 14:_this.activity.palettes.updatePalettes("action");case 15:case"end":return t.stop()}},t)}));return function(t){return e.apply(this,arguments)}}(),this._removeNamedoEntries=function(t){_this.protoBlockDict["myDo_"+t]?(_this.protoBlockDict["myDo_"+t].hide=!0,delete _this.protoBlockDict["myDo_"+t]):_this.protoBlockDict["myCalc_"+t]?(_this.protoBlockDict["myCalc_"+t].hide=!0,delete _this.protoBlockDict["myCalc_"+t]):_this.protoBlockDict["myDoArg_"+t]?(_this.protoBlockDict["myDoArg_"+t].hide=!0,delete _this.protoBlockDict["myDoArg_"+t]):_this.protoBlockDict["myCalcArg_"+t]&&(_this.protoBlockDict["myCalcArg_"+t].hide=!0,delete _this.protoBlockDict["myCalcArg_"+t])},this.newNameddoBlock=function(t,e,i){if(t===_("action"))return!1;if(e&&i)return _this.newNamedcalcArgBlock(t);if(!e&&i)return _this.newNameddoArgBlock(t);if(e&&!i)return _this.newNamedcalcBlock(t);if(void 0!==_this.protoBlockDict["myDo_"+t])return!1;var s=new ProtoBlock("nameddo");return(_this.protoBlockDict["myDo_"+t]=s).palette=_this.activity.palettes.dict.action,s.defaults.push(t),s.staticLabels.push(t),s.zeroArgBlock(),s.palette.add(s,!0),_this.activity.palettes.updatePalettes(),!0},this.newNamedcalcBlock=function(t){if(void 0!==_this.protoBlockDict["myCalc_"+t])return!1;var e=new ProtoBlock("namedcalc");return(_this.protoBlockDict["myCalc_"+t]=e).palette=_this.activity.palettes.dict.action,e.defaults.push(t),e.staticLabels.push(t),e.zeroArgBlock(),e.palette.add(e,!0),!0},this.newNameddoArgBlock=function(t){if(void 0!==_this.protoBlockDict["myDoArg_"+t])return!1;var e=new ProtoBlock("nameddoArg");return(_this.protoBlockDict["myDoArg_"+t]=e).palette=_this.activity.palettes.dict.action,e.defaults.push(t),e.staticLabels.push(t),e.zeroArgBlock(),e.palette.add(e,!0),!0},this.newNamedcalcArgBlock=function(t){if(void 0!==_this.protoBlockDict["myCalcArg_"+t])return!1;var e=new ProtoBlock("namedcalcArg");return(_this.protoBlockDict["myCalcArg_"+t]=e).palette=_this.activity.palettes.dict.action,e.defaults.push(t),e.staticLabels.push(t),e.zeroArgBlock(),e.palette.add(e,!0),!0},this._insideArgClamp=function(t){if(null==_this.blockList[t])return console.debug("null block in blockList? "+t),null;if(null==_this.blockList[t].connections[0])return null;var e=_this.blockList[t].connections[0];return _this.blockList[e].isArgClamp()?e:null},this.findNestedClampBlocks=function(t,e){if(null==_this.blockList[t])return console.debug("null block in blockList? "+t),[];if(null==_this.blockList[t].connections[0])return e;var i=_this.blockList[t].connections[0];return _this.blockList[i].isClampBlock()&&(_this.blockList[i].isDoubleClampBlock()?(e.push([i,0]),e.push([i,1])):e.push([i,0])),_this.findNestedClampBlocks(i,e)},this.insideExpandableBlock=function(t){if(null==_this.blockList[t])return console.debug("null block in blockList? "+t),null;if(null==_this.blockList[t].connections[0])return null;var e=_this.blockList[t].connections[0];return!_this.blockList[e].isExpandableBlock()||!_this.blockList[e].isArgFlowClampBlock()&&!_this.blockList[e].isLeftClampBlock()&&t===last(_this.blockList[e].connections)?_this.insideExpandableBlock(e):e},this._insideNoteBlock=function(t){if(null==_this.blockList[t])return console.debug("null block in blockList? "+t),null;if(null==_this.blockList[t].connections[0])return null;var e=_this.blockList[t].connections[0];return _this.blockList[e].isExpandableBlock()?"forever"===_this.blockList[t].name&&_this._isConnectedToNoteValue(e)?(_this.activity.errorMsg(_("Forever loop detected inside a note value block. Unexpected things may happen.")),null):t===last(_this.blockList[e].connections)?_this._insideNoteBlock(e):t!==_this.blockList[e].connections[1]&&NOTEBLOCKS.includes(_this.blockList[e].name)?e:null:_this._insideNoteBlock(e)},this._isConnectedToNoteValue=function(t){if(NOTEBLOCKS.includes(_this.blockList[t].name))return!0;if(null==_this.blockList[t].connections[0])return!1;var e=_this.blockList[t].connections[0];return _this._isConnectedToNoteValue(e)},this.findBlockInstance=function(t){for(var e in _this.blockList)if(_this.blockList[e].name===t&&!_this.blockList[e].trash)return!0;return!1},this.insideInlineCollapsibleBlock=function(t){if(null===t)return null;var e=_this.blockList[t].connections[0];return null===e?null:_this.blockList[e].isInlineCollapsible()&&t!==last(_this.blockList[e].connections)?e:_this.insideInlineCollapsibleBlock(e)},this.findNoteBlock=function(t){if(null===t)return null;if("newnote"===_this.blockList[t].name)return t;var e,i=last(_this.blockList[t].connections);return _this.blockList[t].isClampBlock()&&(e=_this.blockList[t].connections.length-2,i=_this.blockList[t].connections[e]),_this.findNoteBlock(i)},this.findNestedIntervalBlock=function(t){if(null===t)return null;if("interval"===_this.blockList[t].name)return t;var e,i=last(_this.blockList[t].connections);return _this.blockList[t].isClampBlock()&&(e=_this.blockList[t].connections.length-2,i=_this.blockList[t].connections[e]),_this.findNestedIntervalBlock(i)},this.findFirstPitchBlock=function(t){if(null===t)return null;if(PITCHBLOCKS.includes(_this.blockList[t].name))return t;if("rest2"===_this.blockList[t].name)return t;var e=last(_this.blockList[t].connections);return _this.findFirstPitchBlock(e)},this.findPitchOctave=function(t){if(null===t)return 4;if(["pitch","setpitchnumberoffset","invert1","tofrequency","nthmodalpitch"].includes(_this.blockList[t].name)){var e=_this.blockList[t].connections[2];return null!==e&&"number"===_this.blockList[e].name?_this.blockList[e].value:4}return 4},this.setPitchOctave=function(t,e){var i,s,o;null!==t&&(!["pitch","setpitchnumberoffset","invert1","tofrequency","nthmodalpitch"].includes(_this.blockList[t].name)||null!==(i=_this.blockList[t].connections[2])&&"number"===_this.blockList[i].name&&((s=_this.blockList[i]).value=e,s.text.text=e.toString(),o=s.container.children.length-1,s.container.setChildIndex(s.text,o),s.container.updateCache()))},this.intervalModifierNumber=function(t){if(null===t)return!1;var e=_this.blockList[t],i=e.connections[0];if("number"!==e.name||null===i||"plus"!==_this.blockList[i].name)return!1;var s=_this.blockList[i].connections[0];return null!==s&&!!["interval","setscalartransposition","semitoneinterval","settransposition"].includes(_this.blockList[s].name)},this.octaveModifierNumber=function(t){if(null===t)return!1;var e=_this.blockList[t],i=e.connections[0];if("number"===e.name&&null!==i&&"multiply"===_this.blockList[i].name){var s=_this.blockList[i].connections[1];if(_this.blockList[i].connections[1]===t&&(s=_this.blockList[i].connections[2]),"modelength"===_this.blockList[s].name)return!0;if("number"===_this.blockList[s].name&&12===_this.blockList[s].value)return!0}return!1},this.noteValueNumber=function(t,e){if(null===t)return!1;var i=_this.blockList[t],s=i.connections[0];if("number"===i.name&&null!==s&&"divide"===_this.blockList[s].name&&_this.blockList[s].connections[e]===_this.blockList.indexOf(i)){var o=_this.blockList[s].connections[0];if(null!==o)switch(_this.blockList[o].name){case"newnote":case"pickup":case"tuplet4":case"newstaccato":case"newslur":case"elapsednotes2":return _this.blockList[o].connections[1]===s?!0:!1;case"meter":return _this.blockList[t]._check_meter_block=o,_this.blockList[o].connections[2]===s;case"setbpm3":case"setbpm2":case"setmasterbpm2":case"stuplet":case"rhythm2":case"newswing2":case"vibrato":case"neighbor":case"neighbor2":return _this.blockList[o].connections[2]===s?!0:!1;default:return!1}}return!1},this.noteValueValue=function(t){if(null===t)return 1;var e=_this.blockList[t].connections[0],i=_this.blockList[e].connections[0];if(null!==i)switch(_this.blockList[i].name){case"newnote":case"pickup":case"tuplet4":case"newstaccato":case"newslur":case"elapsednotes2":return _this.blockList[i].connections[1]===e?(i=_this.blockList[e].connections[2],_this.blockList[i].value):1;case"meter":return _this.blockList[t]._check_meter_block=i,_this.blockList[i].connections[2]===e&&_this.blockList[i].connections[1]===e?(i=_this.blockList[e].connections[2],_this.blockList[i].value):1;case"setbpm3":case"setbpm2":case"setmasterbpm2":case"stuplet":case"rhythm2":case"newswing2":case"vibrato":case"neighbor":case"neighbor2":return _this.blockList[i].connections[2]===e?_this.blockList[i].connections[1]===e?(i=_this.blockList[e].connections[2],_this.blockList[i].value):1:1;default:return 1}return 1},this.octaveNumber=function(t){if(null===t)return!1;var e=_this.blockList[t];return!(null===e.connections[0]||!["pitch","setpitchnumberoffset","invert1","tofrequency","nthmodalpitch"].includes(_this.blockList[e.connections[0]].name)||_this.blockList[e.connections[0]].connections[2]!==t)||null!==e.connections[0]&&"customsample"===_this.blockList[e.connections[0]].name&&_this.blockList[e.connections[0]].connections[3]===t},this.meter_block_changed=function(t){if(null!==t&&"meter"===_this.blockList[t].name&&(null!==(l=_this.blockList[t].connections[2])&&"divide"===_this.blockList[l].name)){var e=_this.blockList[l].connections[1];if(null!==e&&"number"===_this.blockList[e].name){var i=_this.blockList[e].value,s=_this.blockList[l].connections[2];if(null!==s&&"number"===_this.blockList[s].name)for(var o=_this.blockList[s].value,n=0;n<_this.blockList.length;n++)if(["setbpm3","setmasterbpm2"].includes(_this.blockList[n].name)){var c=_this.blockList[n].connections[1];if(null===c||"number"!==_this.blockList[c].name)continue;var l,a=_this.blockList[c].value;if(null===(l=_this.blockList[n].connections[2])||"divide"!==_this.blockList[l].name)continue;var r=_this.blockList[l].connections[1];if(null===r||"number"!==_this.blockList[r].name)continue;var h=_this.blockList[r].value,u=_this.blockList[l].connections[2];if(null===u||"number"!==_this.blockList[u].name)continue;a*=h*o/_this.blockList[u].value*i,_this.blockList[c].value=a,_this.updateBlockText(c),_this.blockList[r].value=i,_this.updateBlockText(r),_this.blockList[u].value=o,_this.updateBlockText(u)}}}},this.prepareStackForCopy=function(){if(null==_this.activeBlock)return _this.activity.errorMsg(_("There is no block selected.")),void console.debug("No active block to copy.");_this.selectedStack=_this.activeBlock,_this.selectedBlocksObj=JSON.parse(JSON.stringify(_this._copyBlocksToObj(!1))),_this.pasteDx=0,_this.pasteDy=0},this.triggerLongPress=function(){null!=_this.longPressTimeout&&(clearTimeout(_this.longPressTimeout),_this.longPressTimeout=null),_this.inLongPress=!0,piemenuBlockContext(_this.blockList[_this.activeBlock])},this.pasteStack=function(){if(null!=_this.selectedStack){for(var t in _this.activity.palettes.dict)_this.activity.palettes.dict[t].hideMenu(!0);null!=_this.selectedBlocksObj&&("none"!==docById("helpfulWheelDiv").style.display?(_this.selectedBlocksObj[0][2]=docById("helpfulWheelDiv").offsetLeft+240-_this.activity.blocksContainer.x,_this.selectedBlocksObj[0][3]=docById("helpfulWheelDiv").offsetTop+130-_this.activity.blocksContainer.y,docById("helpfulWheelDiv").style.display="none"):(_this.selectedBlocksObj[0][2]=175-_this.activity.blocksContainer.x+_this.pasteDx,_this.selectedBlocksObj[0][3]=75-_this.activity.blocksContainer.y+_this.pasteDy,_this.pasteDx+=21,_this.pasteDy+=21),_this.loadNewBlocks(_this.selectedBlocksObj),_this.activity.__tick())}},this.saveStack=function(){if(console.debug(_this.selectedStack),null!==_this.selectedStack){var t=_this._copyBlocksToObj(!0),e="---";if(["temperament1","definemode","action"].includes(t[0][1])){var i=t[0][4][1];null==i?console.debug("action not named... skipping"):e="string"==typeof t[i][1][1]?t[i][1][1]:"number"==typeof t[i][1][1]?t[i][1][1].toString():t[i][1][1].value}else for(var s=0;s<t.length;s++)if(["show","turtleshell","customsample"].includes(t[s][1])){switch(t[s][1]){case"show":e=_("Show").toLowerCase()+"-"+MathUtility.doRandom(0,1e3);break;case"turtleshell":e=_("avatar")+"-"+MathUtility.doRandom(0,1e3);break;case"sample":e=_("sample")+"-"+MathUtility.doRandom(0,1e3);break;default:e=t[s][1]+"-"+MathUtility.doRandom(0,1e3)}break}_this.storage.macros=prepareMacroExports(e,t,_this.macroDict),_this.addToMyPalette(e),_this.activity.palettes.updatePalettes("myblocks")}},this._copyBlocksToObj=function(t){var e,i=[],s={};_this.findDragGroup(_this.selectedStack);for(var o=0;o<_this.dragGroup.length;o++){var n=_this.blockList[_this.dragGroup[o]],c=0===o?(e=75-_this.activity.blocksContainer.x,75-_this.activity.blocksContainer.y):e=0,l=void 0;if(n.isValueBlock())switch(n.name){case"media":case"audiofile":l=t?[o,[n.name,{value:n.value}],e,c,[]]:[o,[n.name,null],e,c,[]];break;case"namedbox":case"namedarg":l=[o,[n.name,{value:n.privateData}],e,c,[]];break;default:l=[o,[n.name,{value:n.value}],e,c,[]]}else l=["storein2","nameddo","namedcalc","nameddoArg","namedcalcArg","outputtools"].includes(n.name)?[o,[n.name,{value:n.privateData}],e,c,[]]:[o,n.name,e,c,[]];s[_this.dragGroup[o]]=o,i.push(l)}for(var a=0;a<_this.dragGroup.length;a++)for(var r=_this.blockList[_this.dragGroup[a]],h=0;h<r.connections.length;h++)null===r.connections[h]?i[a][4].push(null):i[a][4].push(s[r.connections[h]]);return i},this.addToMyPalette=function(t){var e=new ProtoBlock("macro_"+t),i="macro_"+t;_this.protoBlockDict[i]=e,console.debug("Adding "+t+" to myblocks palette"),"myblocks"in _this.activity.palettes.dict||_this.activity.palettes.add("myblocks"),e.palette=_this.activity.palettes.dict.myblocks,e.zeroArgBlock(),e.staticLabels.push(_(t)),_this.protoBlockDict[i].palette.add(_this.protoBlockDict[i])},this.findBlockInstance=function(t){for(var e in _this.blockList)if(_this.blockList[e].name===t&&!_this.blockList[e].trash)return!0;return!1},this.loadNewBlocks=function(p){for(var t=null,e=0;e<p.length;e++){if("number"==typeof p[e][1]){t=e;break}}null!==t&&(console.debug("Removing deprecated playback queue from project"),p.splice(t,p.length-t));for(var i=0;i<p.length;i++){var s=p[i];for(var o in s[4])if(s[4][o]===s[0])return console.debug("Circular connection in block data: "+s),console.debug("Punting loading of new blocks!"),void console.debug(p)}for(var n=[],c=[],l=0;l<_this.blockList.length;l++)_this.blockList[l].trash||("action"===_this.blockList[l].name?null!=_this.blockList[l].connections[1]&&n.push(_this.blockList[_this.blockList[l].connections[1]].value):"storein"===_this.blockList[l].name&&null!=_this.blockList[l].connections[1]&&c.push(_this.blockList[_this.blockList[l].connections[1]].value));_this._checkTwoArgBlocks=[],_this._checkArgClampBlocks=[];var a={},r={},h={},u={};_this.blocksToCollapse=[];for(var k=0;k<p.length;k++){var b,d=p[k];if(!((b="string"==typeof d[1]?d[1]:d[1][0])in _this.protoBlockDict))switch(b){case"hat":b="action";break;case"string":b="text";break;default:console.debug("skipping "+b);continue}["arg","twoarg"].includes(_this.protoBlockDict[b].style)&&_this.protoBlockDict[b].expandable&&_this._checkTwoArgBlocks.push(_this.blockList.length+k),["clamp","argclamp","argclamparg","doubleclamp","argflowclamp"].includes(_this.protoBlockDict[b].style)&&_this._checkArgClampBlocks.push(_this.blockList.length+k);var L;switch(b){case"text":void 0===a[L=d[1][1]]&&(a[L]=[]),a[L].push(k);break;case"action":case"hat":null!=d[4][1]&&(r[k]=d[4][1]);break;case"storein":null!=d[4][1]&&(h[k]=d[4][1]);break;case"nameddo":case"namedcalc":case"nameddoArg":case"namedcalcArg":u[k]=d[1][1].value;break;case"do":case"stack":null!=d[4][1]&&(u[k]=d[4][1])}COLLAPSIBLES.includes(b)&&"object"===_typeof(d[1])&&1<d[1].length&&"object"===_typeof(d[1][1])&&"collapsed"in d[1][1]&&d[1][1].collapsed&&_this.blocksToCollapse.push(_this.blockList.length+k)}var m=!1;for(var f in h){var v=p[h[f]];c.includes(v[1][1])||(b="string"==typeof v[1][1]?v[1][1]:v[1][1].value,_this.newStorein2Block(b),_this.newNamedboxBlock(b),m=!0)}for(var g in r){var B=p[r[g]];(b="string"==typeof B[1][1]?B[1][1]:B[1][1].value)===_("action")&&_this.setActionProtoVisiblity(!0);for(var x=b,y=1;n.includes(b);)if(b=x+y.toString(),(y+=1)>_this.blockList.length){console.debug("Could not generate unique action name.");break}n.push(b),x!==b&&(console.debug("action "+x+" is being renamed "+b),B[1][1]={value:b});var C=void 0;for(var T in u){var A,w=p[T],C="string"==typeof w[1]?w[1]:w[1][0];["nameddo","namedcalc","nameddoArg","namedcalcArg"].includes(C)?w[1][1].value===x&&(w[1][1]={value:b}):"string"==typeof(A=p[u[T]])[1][1]?A[1][1]===x&&(A[1][1]=b):A[1][1].value===x&&(A[1][1]={value:b})}}m&&_this.activity.palettes.updatePalettes("action");for(var D,S,N=p.length,E=0,I=0;I<N;I++)switch(b="object"===_typeof(p[I][1])?p[I][1][0]:p[I][1]){case"arpeggio":case"articulation":case"backward":case"crescendo":case"drift":case"duplicatenotes":case"interval":case"invert1":case"fill":case"flat":case"hollowline":case"multiplybeatfactor":case"note":case"newnote":case"newslur":case"newstaccato":case"newswing":case"newswing2":case"osctime":case"pluck":case"ratiointerval":case"rhythmicdot":case"semitoneinterval":case"setbpm":case"setnotevolume2":case"setratio":case"setscalartransposition":case"settransposition":case"setvoice":case"sharp":case"skipnotes":case"slur":case"staccato":case"swing":case"tie":case"tuplet2":case"vibrato":var O,P,R,G,W=p[I][4].length;null==last(p[I][4])?(console.debug("last connection of "+b+" is null: adding hidden block"),console.debug(p[I][4]),p[I][4][W-1]=N+E,p.push([N+E,"hidden",0,0,[I,null]]),E+=1):(O=p[I][4][W-1],P=void 0,"hidden"!==(P="object"===_typeof(p[O][1])?p[O][1][0]:p[O][1])&&(console.debug("last connection of "+b+" is "+P+": adding hidden block"),p[I][4][W-1]=N+E,p[O][4][0]=N+E,p.push([N+E,"hidden",0,0,[I,O]]),E+=1)),["note","slur","staccato","swing"].includes(b)&&(R=p[I][4][2],p[I][4][2]=N+E,null==R?p.push([N+E,"vspace",0,0,[I,null]]):(p[R][4][0]=N+E,p.push([N+E,"vspace",0,0,[I,R]])),E+=1,G=p[I][4][1],p[I][4][1]=N+E,null==G?(p.push([N+E,"divide",0,0,[I,N+E+1,N+E+2]]),p.push([N+E+1,["number",{value:1}],0,0,[N+E]]),p.push([N+E+2,["number",{value:1}],0,0,[N+E]]),E+=3):(p[G][4][0]=N+E,p.push([N+E,"divide",0,0,[I,N+E+1,G]]),p.push([N+E+1,["number",{value:1}],0,0,[N+E]]),E+=2),"object"===_typeof(p[I][1])?p[I][1][0]="new"+b:p[I][1]="new"+b);break;case"action":W=p[I][4].length,null==p[I][4][2]?(console.debug("last connection of "+b+" is null: adding hidden block"),p[I][4][2]=N+E,p.push([N+E,"hidden",0,0,[I,null]]),E+=1):(D=p[I][4][2],S=void 0,"hidden"!==(S="object"===_typeof(p[D][1])?p[D][1][0]:p[D][1])&&(console.debug("last connection of "+b+" is "+S+": adding hidden block"),p[I][4][2]=N+E,p[D][4][0]=N+E,p.push([N+E,"hidden",0,0,[I,D]]),E+=1))}_this._adjustTheseStacks=[],_this._adjustTheseDocks=[],_this._loadCounter=p.length;for(var M=_this.blockList.length,j=_this.blockList.length,F=0;F<_this._loadCounter;F++)!function(t){var e=M+t,i=p[t],s=void 0;"object"===_typeof(i[1])?1===i[1].length?s=[i[1][0],{value:null}]:["number","string"].includes(_typeof(i[1][1]))?(s=[i[1][0],{value:i[1][1]}],COLLAPSIBLES.includes(i[1][0])&&(s[1].collapsed=!1)):s=i[1]:(s=[i[1],{value:null}],COLLAPSIBLES.includes(i[1])&&(s[1].collapsed=!1));var o=s[0],n=void 0;null==s[1]?n=null:(n=s[1].value,s[1].text),o in BACKWARDCOMPATIBILIYDICT&&(o=BACKWARDCOMPATIBILIYDICT[o]);var l=_this;_this.findBlockInstance("temperament1")&&(_this.customTemperamentDefined=!0);var c=void 0;switch(o){case"start":i[4][0]=null,i[4][2]=null,c=function(t){var e=t[0],i=t[1];l.blockList[e].value=l.turtles.getTurtleCount(),l.turtles.addTurtle(l.blockList[e],i)},_this._makeNewBlockWithConnections(o,M,i[4],c,[e,s[1]]);break;case"action":case"hat":i[4][0]=null,i[4][3]=null,_this._makeNewBlockWithConnections("action",M,i[4],null,null);break;case"temperament1":c=function(t){var e=t[1],i="custom";void 0!==e.customName&&(i=e.customName),void 0!==e.customTemperamentNotes&&(deleteTemperamentFromList(i),addTemperamentToDictionary(i,e.customTemperamentNotes),updateTemperaments()),void 0!==e.startingPitch&&(l.activity.logo.synth.startingPitch=e.startingPitch),void 0!==e.octaveSpace&&setOctaveRatio(e.octaveSpace),l.activity.logo.customTemperamentDefined=!0,l.protoBlockDict.custompitch.hidden=!1,l.activity.palettes.updatePalettes("pitch")},_this._makeNewBlockWithConnections(o,M,i[4],c,[e,s[1]]);break;case"storein2":c=function(t){var e=t[0],i=t[1];l.blockList[e].privateData=i,l.blockList[e].value=null,l.blockList[e].overrideName="box1"===i?_("box1"):"box2"===i?_("box2"):i,l.blockList[e].regenerateArtwork()},_this._makeNewBlockWithConnections(o,M,i[4],c,[e,n]);break;case"namedbox":c=function(t){var e=t[0],i=t[1];l.blockList[e].privateData=i,l.blockList[e].overrideName="box1"===i?_("box1"):"box2"===i?_("box2"):i,l.blockList[e].value=null,l.blockList[e].regenerateArtwork()},_this._makeNewBlockWithConnections(o,M,i[4],c,[e,n]);break;case"namedarg":case"namedcalc":case"nameddo":c=function(t){var e=t[0],i=t[1];l.blockList[e].privateData=i,l.blockList[e].value=null},_this._makeNewBlockWithConnections(o,M,i[4],c,[e,n]);break;case"doArg":c=function(t){var e=t[0],i=t[1].length-4;if(0<i){for(var s=l.blockList[e].argClampSlots,o=0;o<i;o++)s.push(1),l._newLocalArgBlock(s.length),l.blockList[e].connections.push(null);l.blockList[e].updateArgSlots(s);for(var n=0;n<t[1].length;n++)null!=t[1][n]?l.blockList[e].connections[n]=t[1][n]+j:l.blockList[e].connections[n]=t[1][n]}l._checkArgClampBlocks.push(e)},_this._makeNewBlockWithConnections("doArg",M,i[4],c,[e,i[4]]);break;case"nameddoArg":c=function(t){var e=t[0],i=t[1];l.blockList[e].privateData=i,l.blockList[e].value=null;var s=t[2].length-3;if(0<s){for(var o=l.blockList[e].argClampSlots,n=0;n<s;n++)o.push(1),l._newLocalArgBlock(o.length),l.blockList[e].connections.push(null);l.blockList[e].updateArgSlots(o);for(var c=0;c<t[2].length;c++)null!=t[2][c]?l.blockList[e].connections[c]=t[2][c]+j:l.blockList[e].connections[c]=t[2][c]}l._checkArgClampBlocks.push(e)},_this._makeNewBlockWithConnections("nameddoArg",M,i[4],c,[e,n,i[4]]);break;case"calcArg":c=function(t){var e=t[0],i=t[1].length-3;if(0<i){for(var s=l.blockList[e].argClampSlots,o=0;o<i;o++)s.push(1),l._newLocalArgBlock(s.length),l.blockList[e].connections.push(null);l.blockList[e].updateArgSlots(s);for(var n=0;n<t[1].length;n++)null!=t[1][n]?l.blockList[e].connections[n]=t[1][n]+j:l.blockList[e].connections[n]=t[1][n]}l._checkArgClampBlocks.push(e)},_this._makeNewBlockWithConnections("calcArg",M,i[4],c,[e,i[4]]);break;case"namedcalcArg":c=function(t){var e=t[0],i=t[1];l.blockList[e].privateData=i,l.blockList[e].value=null;var s=t[2].length-2;if(0<s){for(var o=l.blockList[e].argClampSlots,n=0;n<s;n++)o.push(1),l._newLocalArgBlock(o.length),l.blockList[e].connections.push(null);l.blockList[e].updateArgSlots(o);for(var c=0;c<t[2].length;c++)null!=t[2][c]?l.blockList[e].connections[c]=t[2][c]+j:l.blockList[e].connections[c]=t[2][c]}l._checkArgClampBlocks.push(e)},_this._makeNewBlockWithConnections("namedcalcArg",M,i[4],c,[e,n,i[4]]);break;case"makeblock":c=function(t){var e=t[0],i=t[1].length-3;if(0<i){for(var s=l.blockList[e].argClampSlots,o=0;o<i;o++)s.push(1),l.blockList[e].connections.push(null);l.blockList[e].updateArgSlots(s);for(var n=0;n<t[1].length;n++)null!=t[1][n]?l.blockList[e].connections[n]=t[1][n]+j:l.blockList[e].connections[n]=t[1][n]}l._checkArgClampBlocks.push(e)},_this._makeNewBlockWithConnections("makeblock",M,i[4],c,[e,i[4]]);break;case"number":c=function(t){var e=t[0],i=t[1];l.blockList[e].value=Number(i),l.updateBlockText(e)},_this._makeNewBlockWithConnections(o,M,i[4],c,[e,n]);break;case"outputtools":c=function(t){var e=t[0],i=t[1];l.blockList[e].privateData=i,l.blockList[e].overrideName=i},_this._makeNewBlockWithConnections("outputtools",M,i[4],c,[e,p[t][1][1].value]);break;case"text":case"solfege":case"scaledegree2":case"customNote":case"eastindiansolfege":case"notename":case"modename":case"chordname":case"temperamentname":case"invertmode":case"filtertype":case"oscillatortype":case"accidentalname":case"intervalname":case"grid":case"boolean":c=function(t){var e=t[0],i=t[1];l.blockList[e].value=i,l.updateBlockText(e)},_this._makeNewBlockWithConnections(o,M,i[4],c,[e,n]);break;case"drumname":c=function(t){var e=t[0],i=t[1];l.blockList[e].value=i,l.updateBlockText(e)},_this._makeNewBlockWithConnections(o,M,i[4],c,[e,n]),null===n&&(n=DEFAULTDRUM),l.activity.logo.synth.loadSynth(0,getDrumSynthName(n));break;case"effectsname":c=function(t){var e=t[0],i=t[1];l.blockList[e].value=i,l.updateBlockText(e)},_this._makeNewBlockWithConnections(o,M,i[4],c,[e,n]),null===n&&(n=DEFAULTEFFECT),l.activity.logo.synth.loadSynth(0,getDrumSynthName(n));break;case"voicename":c=function(t){var e=t[0],i=t[1];["simple 1","simple 2","simple 3","simple 4"].includes(i)&&(i="sine"),l.blockList[e].value=i,l.updateBlockText(e)},_this._makeNewBlockWithConnections(o,M,i[4],c,[e,n]);try{null===n&&(n=DEFAULTVOICE),_this.activity.logo.synth.loadSynth(0,getVoiceSynthName(n))}catch(t){console.debug(t)}break;case"noisename":c=function(t){var e=t[0],i=t[1];l.blockList[e].value=i,l.updateBlockText(e)},_this._makeNewBlockWithConnections(o,M,i[4],c,[e,n]);try{null===n&&(n=DEFAULTNOISE),_this.activity.logo.synth.loadSynth(0,getNoiseSynthName(n))}catch(t){console.debug(t)}break;case"loudness":case"pitchness":_this._makeNewBlockWithConnections(o,M,i[4],null,[]),_this.activity.logo.initMediaDevices();break;case"media":c=function(t){var e=t[0],i=t[1];null!=(l.blockList[e].value=i)&&l.blockList[e].loadThumbnail(null)},_this._makeNewBlockWithConnections(o,M,i[4],c,[e,n]);break;case"camera":c=function(t){var e=t[0];l.blockList[e].value=CAMERAVALUE},_this._makeNewBlockWithConnections(o,M,i[4],c,[e,n]);break;case"video":c=function(t){var e=t[0];l.blockList[e].value=VIDEOVALUE},_this._makeNewBlockWithConnections(o,M,i[4],c,[e,n]);break;case"red":case"black":c=function(t){l.blockList[t].value=0,l.updateBlockText(t)},_this._makeNewBlockWithConnections("number",M,i[4],c,e);break;case"white":c=function(t){l.blockList[t].value=100,l.updateBlockText(t)},_this._makeNewBlockWithConnections("number",M,i[4],c,e);break;case"orange":c=function(t){l.blockList[t].value=10,l.updateBlockText(t)},_this._makeNewBlockWithConnections("number",M,i[4],c,e);break;case"yellow":c=function(t){l.blockList[t].value=20,l.updateBlockText(t)},_this._makeNewBlockWithConnections("number",M,i[4],c,e);break;case"green":c=function(t){l.blockList[t].value=40,l.updateBlockText(t)},_this._makeNewBlockWithConnections("number",M,i[4],c,e);break;case"blue":c=function(t){l.blockList[t].value=70,l.updateBlockText(t)},_this._makeNewBlockWithConnections("number",M,i[4],c,e);break;case"loadFile":c=function(t){l.blockList[t[0]].value=t[1],l.updateBlockText(t[0])},_this._makeNewBlockWithConnections(o,M,i[4],c,[e,n]);break;case"wrapmode":c=function(t){l.blockList[t[0]].value=t[1],l.updateBlockText(t[0])},_this._makeNewBlockWithConnections(o,M,i[4],c,[e,n]);break;case"audiofile":c=function(t){l.blockList[t[0]].value=t[1],l.updateBlockText(t[0])},_this._makeNewBlockWithConnections(o,M,i[4],c,[e,n]);break;default:if(o in _this.protoBlockDict&&null!=_this.protoBlockDict[o])_this._makeNewBlockWithConnections(o,M,i[4],null);else{var a,r,h,u=o,k=i[4].length,b=!0,d=i[4][0];switch(null!==d?(a=p[d][4].indexOf(t),"string"==typeof p[d][1]?void 0!==_this.protoBlockDict[p[d][1]]&&"in"!==_this.protoBlockDict[p[d][1]].dockTypes[a]&&(b=!1):void 0!==_this.protoBlockDict[p[d][1][0]]&&"in"!==_this.protoBlockDict[p[d][1][0]].dockTypes[a]&&(b=!1)):null!==(r=last(i[4]))&&(h=p[r][4].indexOf(t),"string"==typeof p[r][1]&&(void 0!==_this.protoBlockDict[p[r][1]]?"out"!==_this.protoBlockDict[p[r][1]].dockTypes[h]&&(b=!1):void 0!==_this.protoBlockDict[p[r][1][0]]&&"out"!==_this.protoBlockDict[p[r][1][0]].dockTypes[h]&&(b=!1))),b?console.debug(k+": substituting nop flow block for "+o):console.debug(k+": substituting nop arg block for "+o),k){case 1:u="nopValueBlock";break;case 2:u=b?"nopZeroArgBlock":"nopOneArgMathBlock";break;case 3:u=b?"nopOneArgBlock":"nopTwoArgMathBlock";break;case 4:u="nopTwoArgBlock";break;case 5:default:5<k&&console.debug("WARNING: arg count exceed."),u="nopThreeArgBlock"}_this._makeNewBlockWithConnections(u,M,i[4],function(t){l.blockList[t[0]].privateData=t[1]},[e,o])}}e===_this.blockList.length-1&&null==_this.blockList[e].connections[0]&&(_this.blockList[e].container.x=i[2],_this.blockList[e].container.y=i[3],_this._adjustTheseDocks.push(e),null==i[4][0]&&_this._adjustTheseStacks.push(e),(i[2]<0||i[3]<0||i[2]>_this.activity.canvas.width||i[3]>_this.activity.canvas.height)&&_this.activity.setHomeContainers(!0))}(F)},this.cleanupAfterLoad=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var i,s,o,n,c,l,a,r,h,u;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(--_this._loadCounter,0<_this._loadCounter)return t.abrupt("return");t.next=3;break;case 3:for(_this._findDrumURLs(),_this.updateBlockPositions(),_this._cleanupStacks(),i=0;i<_this.blocksToCollapse.length;i++)_this.blockList[_this.blocksToCollapse[i]].collapseToggle();for(o in _this.blocksToCollapse=[],_this.activity.refreshCanvas(),s=!1,_this.blockList)_this.blockList[o].trash||"action"!==_this.blockList[o].name||(n=_this.blockList[o],null!=(c=n.connections[1])&&_this.blockList[c].value!==_("action")&&_this.newNameddoBlock(_this.blockList[c].value,_this.actionHasReturn(o),_this.actionHasArgs(o))&&(s=!0));for(l in s&&_this.activity.palettes.updatePalettes("action"),s=!1,_this.blockList)_this.blockList[l].trash||"storein"!==_this.blockList[l].name||(a=_this.blockList[l],null!=(r=a.connections[1])&&_this.blockList[r].value!==_("box")&&null!==(h=_this.blockList[r].value)&&(null!=_this.protoBlockDict["myStorein_"+h]&&null!=_this.protoBlockDict["yourStorein2_"+h]||(_this.newStorein2Block(_this.blockList[r].value),_this.newNamedboxBlock(_this.blockList[r].value),s=!0)));document.body.style.cursor="default",document.getElementById("load-container").style.display="none",u=new Event("finishedLoading"),document.dispatchEvent(u);case 18:case"end":return t.stop()}},t)}));return function(t){return e.apply(this,arguments)}}(),this._cleanupStacks=function(){for(var t=[],e=0;e<_this._checkArgClampBlocks.length;e++){var i=_this._checkArgClampBlocks[e];t.push([i,_this._getNestingDepth(i),"1arg"])}for(var s=0;s<_this._checkTwoArgBlocks.length;s++){var o=_this._checkTwoArgBlocks[s];t.push([o,_this._getNestingDepth(o),"2arg"])}t=(t=t.sort(function(t,e){return t[1]-e[1]})).reverse();for(var n=0;n<t.length;n++)"1arg"===t[n][2]?_this._adjustArgClampBlock([t[n][0]]):_this._adjustExpandableTwoArgBlock([t[n][0]]);for(var c=0;c<_this._adjustTheseDocks.length;c++)_this.adjustDocks(_this._adjustTheseDocks[c],!0),_this._expandClamps();for(var l=0;l<_this._adjustTheseStacks.length;l++)_this.raiseStackToTop(_this._adjustTheseStacks[l])},this.actionHasReturn=function(t){if("action"!==_this.blockList[t].name)return!1;_this.findDragGroup(t);for(var e=0;e<_this.dragGroup.length;e++)if("return"===_this.blockList[_this.dragGroup[e]].name)return!0;return!1},this.actionHasArgs=function(t){if("action"!==_this.blockList[t].name)return!1;_this.findDragGroup(t);for(var e=0;e<_this.dragGroup.length;e++)if("arg"===_this.blockList[_this.dragGroup[e]].name||"namedarg"===_this.blockList[_this.dragGroup[e]].name)return!0;return!1},this.raiseStackToTop=function(t){var e=_this.findTopBlock(t);_this.findDragGroup(e);for(var i=_this.activity.blocksContainer.children.length-1,s=0;s<_this.dragGroup.length;s++)_this.activity.blocksContainer.setChildIndex(_this.blockList[_this.dragGroup[s]].container,i),--i;_this.activity.refreshCanvas},this.deleteActionBlock=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var i,s,o,n,c,l,a;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!(i=_this.blockList[e.connections[1]])){t.next=42;break}s=i.value,t.t0=regeneratorRuntime.keys(_this.blockList);case 4:if((t.t1=t.t0()).done){t.next=36;break}if(o=t.t1.value,n=_this.blockList[o],["nameddo","namedcalcArg","nameddoArg","do","calc","calcArg","doArg"].includes(n.name)){t.next=9;break}return t.abrupt("continue",4);case 9:if(null!==n.connections[0])return t.abrupt("continue",4);t.next=11;break;case 11:if("calc"===n.name){t.next=14;break}if(null!==last(n.connections))return t.abrupt("continue",4);t.next=14;break;case 14:if("calcArg"!==n.name){t.next=17;break}if(null!==n.connections[2])return t.abrupt("continue",4);t.next=17;break;case 17:if("doArg"!==n.name){t.next=20;break}if(null!==n.connections[2])return t.abrupt("continue",4);t.next=20;break;case 20:if("namedcalcArg"!==n.name){t.next=23;break}if(null!==n.connections[1])return t.abrupt("continue",4);t.next=23;break;case 23:l=c=void 0,t.t2=n.name,t.next="doArg"===t.t2||"calcArg"===t.t2||"calc"===t.t2||"do"===t.t2?28:"nameddoArg"===t.t2||"namedcalcArg"===t.t2||"nameddo"===t.t2?30:33;break;case 28:return null!==n.connections[1]&&(c=_this.blockList[n.connections[1]],l=c.value),t.abrupt("break",33);case 30:return c=null,l=n.privateData,t.abrupt("break",33);case 33:l===s&&(n.trash=!0,null!==c&&(c.hide(),c.trash=!0)),t.next=4;break;case 36:return _this.deleteActionTimeout+=50,a=_this.deleteActionTimeout,t.next=40,delayExecution(a);case 40:_this.deleteActionTimeout-=50,_this.activity.palettes.removeActionPrototype(s);case 42:case"end":return t.stop()}},t)}));return function(t){return e.apply(this,arguments)}}(),this.sendStackToTrash=function(t){for(var e in _this.activity.palettes.dict)_this.activity.palettes.dict[e].hideMenu(!0);_this.activity.refreshCanvas();var i=_this.blockList.indexOf(t);_this.trashStacks.push(i);var s,o,n=t.connections[0];if(null!=n){for(var c in _this.blockList[n].connections)if(_this.blockList[n].connections[c]===i){_this.blockList[n].connections[c]=null;break}var l=_this.insideExpandableBlock(i);t.connections[0]=null,_this.addDefaultBlock(l,i)}"start"===t.name||"drum"===t.name?null!=(s=t.value)&&(console.debug("putting turtle "+s+" in the trash"),(o=_this.turtles.turtleList[s].companionTurtle)&&(_this.turtles.turtleList[o].inTrash=!0,_this.turtles.turtleList[o].container.visible=!1),_this.turtles.turtleList[s].inTrash=!0,_this.turtles.turtleList[s].container.visible=!1):"action"===t.name&&(t.trash||_this.deleteActionBlock(t)),_this.findDragGroup(i);for(var a=0;a<_this.dragGroup.length;a++){var r=_this.dragGroup[a];_this.blockList[r].trash=!0,_this.blockList[r].hide();var h=_this.blockList[r].protoblock.staticLabels[0];closeBlkWidgets(_(h)),_this.activity.refreshCanvas()}if(null!=n){var u=_this.findTopBlock(n);_this.findDragGroup(u),_this._checkTwoArgBlocks=[],_this._checkArgClampBlocks=[];for(var k=0;k<_this.dragGroup.length;k++){var b=_this.dragGroup[k],d=_this.blockList[b];d.isTwoArgBlock()||d.isArgBlock()&&d.isExpandableBlock()||d.isArgClamp()?_this._checkTwoArgBlocks.push(b):["clamp","argclamp","argclamparg","doubleclamp","argflowclamp"].includes(d.protoblock.style)&&_this._checkArgClampBlocks.push(b)}_this._cleanupStacks(),_this.activity.refreshCanvas()}_this.activity.refreshCanvas(),_this.activity.trashcan.stopHighlightAnimation(),document.getElementById("hideContents").click()},this.clearParameterBlocks=function(){for(var t in _this.blockList)if(_this.blockList[t].protoblock.parameter&&null!==_this.blockList[t].text){if("audiofile"===_this.blockList[t].name)continue;_this.blockList[t].text.text="",_this.blockList[t].container.updateCache()}_this.activity.refreshCanvas()},this.updateParameterBlock=function(logo,turtle,blk){var name=_this.blockList[blk].name;if(_this.blockList[blk].protoblock.parameter&&null!==_this.blockList[blk].text){var value=0;if("function"==typeof _this.blockList[blk].protoblock.updateParameter)value=_this.blockList[blk].protoblock.updateParameter(logo,turtle,blk);else{if(!(name in logo.evalParameterDict))return;eval(logo.evalParameterDict[name])}if(null==value)_this.blockList[blk].text.text="";else if("string"==typeof value)6<value.length&&(value=value.substr(0,5)+"..."),_this.blockList[blk].text.text=value;else if("divide"===name)_this.blockList[blk].text.text=mixedNumber(value);else try{_this.blockList[blk].text.text=value.toString()}catch(t){console.warn("Error converting value to string:",value,t),_this.blockList[blk].text.text=""}_this.blockList[blk].container.updateCache(),_this.activity.refreshCanvas()}},this.blockSetter=function(logo,blk,value,turtle){if("function"==typeof _this.blockList[blk].protoblock.setter)_this.blockList[blk].protoblock.setter(logo,value,turtle,blk);else{if(!(_this.blockList[blk].name in logo.evalSetterDict))throw new Error;eval(logo.evalSetterDict[_this.blockList[blk].name])}},this.hideBlocks=function(){_this.activity.palettes.hide(),_this.hide(),_this.activity.refreshCanvas()},this.showBlocks=function(){_this.activity.palettes.show(),_this.show(),_this.bringToTop(),_this.activity.refreshCanvas()},this.setSelection=function(t){_this.selectionModeOn=t},this.setSelectionToActivity=function(t){_this.activity.setSelectionMode(t)},this.unhighlightSelectedBlocks=function(t,e){_this.blockList[t].unhighlightSelectedBlocks(t,e)},this.setSelectedBlocks=function(t){_this.selectedBlocks=t},this.isCoordinateOnBlock=function(s,o){return this.blockList.some(function(t){if(t.trash)return!1;var e=t.container.x,i=t.container.y;return e<=s&&s<=e+t.width&&i<=o&&o<=i+t.height})}};