"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,u=!0,l=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return u=e.done,e},e:function(e){l=!0,o=e},f:function(){try{u||null==r.return||r.return()}finally{if(l)throw o}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function asyncGeneratorStep(e,t,r,n,a,o,u){try{var l=e[o](u),i=l.value}catch(e){return void r(e)}l.done?t(i):Promise.resolve(i).then(n,a)}function _asyncToGenerator(l){return function(){var e=this,u=arguments;return new Promise(function(t,r){var n=l.apply(e,u);function a(e){asyncGeneratorStep(n,t,r,a,o,"next",e)}function o(e){asyncGeneratorStep(n,t,r,a,o,"throw",e)}a(void 0)})}}var defaultTempo=90,standardDurations=[{value:"1/1",duration:1},{value:"1/2",duration:.5},{value:"1/4",duration:.25},{value:"1/8",duration:.125},{value:"1/16",duration:.0625},{value:"1/32",duration:.03125},{value:"1/64",duration:.015625},{value:"1/128",duration:.0078125}],getClosestStandardNoteValue=function(e){for(var t=standardDurations[0],r=Math.abs(e-t.duration),n=1;n<standardDurations.length;n++){var a=Math.abs(e-standardDurations[n].duration);a<r&&(t=standardDurations[n],r=a)}return t.value.split("/").map(Number)},transcribeMidi=function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(t,g){var r,A,c,S,v,_,k,I,T,M,w,C,x,N,n,a,o,D,u,l,i,s,d,h,p,f,m;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:for(r=t,A=getReverseDrumMidi(),c=[],S=[],_=[],w=!(M=100),C=T=I=k=v=0,x=[],N=[],n=(n=r.header.tempos)&&0<n.length?Math.round(n[0].bpm):defaultTempo,a=[4,4],o=(o=r.header.timeSignatures)&&0<o.length?o[0].timeSignature:a,D=!1,r.tracks.forEach(function(h,e){var p=0;if(!w&&h.notes.length){var t=S.length,r="electronic synth";if(h.instrument.name&&!h.instrument.percussion){var n,a=_createForOfIteratorHelper(VOICENAMES);try{for(a.s();!(n=a.n()).done;){var o=n.value;-1<h.instrument.name.indexOf(o[1])&&(r=o[0])}}catch(e){a.e(e)}finally{a.f()}}else h.instrument.percussion&&(D=!0);x[C]=0,N[C]=r;var u="track".concat(C,"chunk").concat(v);S.push([t,["action",{collapsed:!1}],150,100,[null,t+1,t+2,null]],[t+1,["text",{value:u}],0,0,[t]]);var f=[];c.push(h.instrument.percussion&&(9===h.channel||10===h.channel)),h.notes.forEach(function(e,t){var r=e.name,n=Math.round(100*e.time)/100,a=Math.round(100*(e.time+e.duration))/100;if(0!==e.duration){var o=f[f.length-1];if(0===t&&0<n&&f.push({start:0,end:n,notes:["R"]}),o&&o.start===n&&o.end===a)o.notes.push(r);else{if(o&&o.start<=n&&o.end>n){var u=_toConsumableArray(o.notes),l=o.end;return o.end=n,f.push({start:n,end:a,notes:[].concat(_toConsumableArray(u),[r])}),void(a<l&&f.push({start:a,end:l,notes:u}))}o&&o.end<n&&f.push({start:o.end,end:n,notes:["R"]}),f.push({start:n,end:a,notes:[r]})}}});var m=0,y=[],b=function(e){var t,r,n=0<arguments.length&&void 0!==e&&e,a=S.length,o="track".concat(C,"chunk").concat(v);_.push(o),x[C]++,0==p?(S.push.apply(S,_toConsumableArray(y)),p=1):(t=a,y[0][4][0]=t,S.push.apply(S,[[a,["action",{collapsed:!1}],100+M,100+M,[null,a+1,t+2,null]],[a+1,["text",{value:o}],0,0,[a]]].concat(_toConsumableArray(y)))),n&&(r=S.length-1,S[r][4][1]=null),y=[],v++,M+=100};for(var l in f){var i=f[l].end-f[l].start,s=getClosestStandardNoteValue(3*i/8);T=Math.max(T,s[1])}for(var d in f){if("break"===function(e){if(w)return"break";var t=f[e],r=t.notes,n=t.start,a=t.end-n,o=16<=(m+=a)||0<I&&I%24==0;o&&(k+=I,m=I=0);var u=e==f.length-1,l=o||u,s=0==e,i=S.length+y.length,d=getClosestStandardNoteValue(3*a/8),d=getClosestStandardNoteValue(d[0]/d[1]);0!=p&&(i+=2);var c=function(e,t,r){var n=[];if("R"==t[0])n.push([e,"rest2",0,0,[r,null]]);else if(D){var a=A[h.notes[0].midi][0]||"kick drum";n.push([e,"playdrum",0,0,[s?r:e-1,e+1,null]],[e+1,["drumname",{value:a}],0,0,[e]]),e+=2}else for(var o in t){var u=t[o],l=0==o,i=o==t.length-1;n.push([e,"pitch",0,0,[l?r:e-3,e+1,e+2,i?null:e+3]],[e+1,["notename",{value:u.substring(0,u.length-1)}],0,0,[e]],[e+2,["number",{value:parseInt(u[u.length-1])}],0,0,[e]]),e+=3}return n}(i+5,r,i);y.push([i,["newnote",{collapsed:!0}],0,0,[s?i-2:i-1,i+1,i+4,i+c.length+5]],[i+1,"divide",0,0,[i,i+2,i+3]],[i+2,["number",{value:d[0]}],0,0,[i+1]],[i+3,["number",{value:d[1]}],0,0,[i+1]],[i+4,"vspace",0,0,[i,i+5]]),I++,c[0][4][0]=i+4,y=y.concat(c);var v=S.length+y.length;return 0!=p&&(v+=2),y.push([v,"hidden",0,0,[i,l?null:v+1]]),(o||u)&&b(u),g<=k?(activity.textMsg("MIDI file is too large. Generating only ".concat(g," noteblocks")),w=!0,"break"):void 0}(d))break}0<y.length&&b(!0),C++,document.body.style.cursor="wait"}}),u=S.length,s=i=l=0;s<C;s++){for(d=u+l+6,h=u+l,p=!0,c[s]?(S.push([u+l,["start",{collapsed:!1}],300+M,100,[null,u+l+14+x[s],null]],[u+l+1,"meter",0,0,[u+l+14+x[s],u+l+2,u+l+3,u+l+6]],[u+l+2,["number",{value:o[0]}],0,0,[u+l+1]],[u+l+3,"divide",0,0,[u+l+1,u+l+4,u+l+5]],[u+l+4,["number",{value:1}],0,0,[u+l+3]],[u+l+5,["number",{value:o[1]}],0,0,[u+l+3]],[u+l+6,"vspace",0,0,[u+l+1,u+l+8+x[s]]],[u+l+7,"hidden",0,0,[u+l+13+x[s],u+l+8]]),p=!1,l+=8):(S.push([u+l,["start",{collapsed:!1}],300+M,100,[null,u+l+16+x[s],null]],[u+l+1,"meter",0,0,[u+l+16+x[s],u+l+2,u+l+3,u+l+6]],[u+l+2,["number",{value:o[0]}],0,0,[u+l+1]],[u+l+3,"divide",0,0,[u+l+1,u+l+4,u+l+5]],[u+l+4,["number",{value:1}],0,0,[u+l+3]],[u+l+5,["number",{value:o[1]}],0,0,[u+l+3]],[u+l+6,"vspace",0,0,[u+l+1,u+l+10+x[s]]],[u+l+7,"settimbre",0,0,[u+l+15+x[s],u+l+8,u+l+10,u+l+9]],[u+l+8,["voicename",{value:N[s]}],0,0,[u+l+7]],[u+l+9,"hidden",0,0,[u+l+7,null]]),l+=10),f=0;f<x[s];f++)S.push([u+l,["nameddo",{value:_[i]}],0,0,[p?u+l-3:u+l-1,u+l+1]]),l++,p=!1,i++;S[u+l-1][4][1]=null,m=S.length,S.push([m,["setbpm3"],0,0,[d,m+1,m+2,m+5]],[m+1,["number",{value:n}],0,0,[m]],[m+2,"divide",0,0,[m,m+3,m+4]],[m+3,["number",{value:1}],0,0,[m+2]],[m+4,["number",{value:o[1]}],0,0,[m+2]],[m+5,"vspace",0,0,[m,d+1]]),l+=6,S.push([u+l,"setturtlename2",0,0,[h,u+l+1,h+1]],[u+l+1,["text",{value:"track".concat(s)}],0,0,[u+l]]),l+=2}return activity.blocks.loadNewBlocks(S),e.abrupt("return",null);case 27:case"end":return e.stop()}},e)}));return function(e,t){return r.apply(this,arguments)}}();"undefined"!=typeof module&&module.exports&&(module.exports={getClosestStandardNoteValue:getClosestStandardNoteValue,transcribeMidi:transcribeMidi});