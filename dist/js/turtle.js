"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function asyncGeneratorStep(t,e,i,n,s,r,a){try{var o=t[r](a),h=o.value}catch(t){return void i(t)}o.done?e(h):Promise.resolve(h).then(n,s)}function _asyncToGenerator(o){return function(){var t=this,a=arguments;return new Promise(function(e,i){var n=o.apply(t,a);function s(t){asyncGeneratorStep(n,e,i,s,r,"next",t)}function r(t){asyncGeneratorStep(n,e,i,s,r,"throw",t)}s(void 0)})}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,_toPropertyKey(n.key),n)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(t,e){if("object"!=_typeof(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0===i)return("string"===e?String:Number)(t);var n=i.call(t,e||"default");if("object"!=_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}var Turtle=function(){function r(t,e,i,n,s){_classCallCheck(this,r),importMembers(this,"",[t,e,i,n,s]),this.activity=t,this.singer=new Singer(this),this.painter=new Painter(this),this._waitTime=0,this.embeddedGraphicsFinished=!0,this.inSetTimbre=!1,this._blinkFinished=!0}var i,t;return _createClass(r,[{key:"blinking",value:function(){return!this._blinkFinished}},{key:"doWait",value:function(t){this._waitTime=1e3*Number(t)}},{key:"_createCache",value:function(){var t=this;this.bounds=this.container.getBounds(),null==this.bounds?setTimeout(function(){t._createCache()},200):this.container.cache(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height)}},{key:"updateCache",value:(t=_asyncToGenerator(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(null==this.bounds)return console.debug("Block container for "+this.name+" not yet ready."),t.next=4,delayExecution(300);t.next=7;break;case 4:this.updateCache(),t.next=9;break;case 7:this.container.updateCache(),this.activity.refreshCanvas();case 9:case"end":return t.stop()}},t,this)})),function(){return t.apply(this,arguments)})},{key:"stopBlink",value:function(){null==this._blinkTimeout&&this._blinkFinished||(clearTimeout(this._blinkTimeout),this._blinkTimeout=null,this.container.visible=!0,this.activity.refreshCanvas(),this._blinkFinished=!0)}},{key:"blink",value:(i=_asyncToGenerator(regeneratorRuntime.mark(function t(e,i){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if("CursorOver"+this.id in this.listeners||"CursorOut"+this.id in this.listeners)return t.abrupt("return");t.next=2;break;case 2:if(this._blinkTimeout=null,16<e)return t.abrupt("return");t.next=5;break;case 5:return this.stopBlink(),this._blinkFinished=!1,this.container.visible=!1,this.activity.refreshCanvas(),t.next=11,delayExecution(100);case 11:this._blinkTimeout=t.sent,this._blinkFinished=!0,this.container.visible=!0,this.activity.refreshCanvas();case 15:case"end":return t.stop()}},t,this)})),function(t,e){return i.apply(this,arguments)})},{key:"initTurtle",value:function(t){this.doWait(0),this.endOfClampSignals={},this.butNotThese={},this.embeddedGraphicsFinished=!0,this.inSetTimbre=!1,this.painter.cp1x=0,this.painter.cp1y=100,this.painter.cp2x=100,this.painter.cp2y=100,this.singer.attack=[],this.singer.decay=[],this.singer.sustain=[],this.singer.release=[],this.singer.scalarTransposition=0,this.singer.scalarTranspositionValues=[],this.singer.transposition=0,this.singer.transpositionValues=[],this.singer.register=0,this.singer.beatFactor=1,this.singer.dotCount=0,this.singer.noteBeat={},this.singer.noteValue={},this.singer.oscList={},this.singer.noteDrums={},this.singer.notePitches={},this.singer.noteOctaves={},this.singer.noteCents={},this.singer.noteHertz={},this.singer.noteBeatValues={},this.singer.embeddedGraphics={},this.singer.lastNotePlayed=null,this.singer.previousNotePlayed=null,this.singer.noteStatus=null,this.singer.noteDirection=0,this.singer.pitchNumberOffset=39,this.singer.currentOctave=4,this.singer.inHarmonic=[],this.singer.partials=[],this.singer.inNeighbor=[],this.singer.neighborStepPitch=[],this.singer.neighborNoteValue=[],this.singer.inDefineMode=!1,this.singer.defineMode=[],this.singer.notesPlayed=[0,1],this.singer.whichNoteToCount=1,this.singer.movable=!1,this.singer.bpm=[],this.singer.previousTurtleTime=0,this.singer.turtleTime=0,this.singer.pushedNote=!1,this.singer.duplicateFactor=1,this.singer.inDuplicate=!1,this.singer.skipFactor=1,this.singer.skipIndex=0,this.singer.instrumentNames=[DEFAULTVOICE],this.singer.inCrescendo=[],this.singer.crescendoDelta=[],this.singer.crescendoInitialVolume={DEFAULTVOICE:[DEFAULTVOLUME]},this.singer.intervals=[],this.singer.semitoneIntervals=[],this.singer.staccato=[],this.singer.glide=[],this.singer.glideOverride=0,this.singer.swing=[],this.singer.swingTarget=[],this.singer.swingCarryOver=0,this.singer.tie=!1,this.singer.tieNotePitches=[],this.singer.tieNoteExtras=[],this.singer.tieCarryOver=0,this.singer.tieFirstDrums=[],this.singer.drift=0,this.singer.drumStyle=[],this.singer.voices=[],this.singer.backward=[],this.singer.vibratoIntensity=[],this.singer.vibratoRate=[],this.singer.distortionAmount=[],this.singer.tremoloFrequency=[],this.singer.tremoloDepth=[],this.singer.rate=[],this.singer.octaves=[],this.singer.baseFrequency=[],this.singer.chorusRate=[],this.singer.delayTime=[],this.singer.chorusDepth=[],this.singer.neighborArgNote1=[],this.singer.neighborArgNote2=[],this.singer.neighborArgBeat=[],this.singer.neighborArgCurrentBeat=[],this.singer.inNoteBlock=[],this.singer.multipleVoices=!1,this.singer.invertList=[],this.singer.beatList=[],this.singer.factorList=[],this.singer.keySignature="C major",this.singer.pitchDrumTable={},this.singer.defaultStrongBeats=!1,this.singer.pickup=0,this.singer.beatsPerMeasure=4,this.singer.noteValuePerBeat=4,this.singer.currentBeat=0,this.singer.currentMeasure=0,this.singer.justCounting=[],this.singer.justMeasuring=[],this.singer.firstPitch=[],this.singer.lastPitch=[],this.singer.suppressOutput=t,this.singer.dispatchFactor=1,this.singer.runningFromEvent=!1}},{key:"waitTime",get:function(){return this._waitTime}},{key:"id",get:function(){return this._id}},{key:"name",get:function(){return this._name}},{key:"turtles",get:function(){return this._turtles}},{key:"startBlock",set:function(t){this._startBlock=t},get:function(){return this._startBlock}},{key:"queue",set:function(t){this._queue=t},get:function(){return this._queue}},{key:"parentFlowQueue",set:function(t){this._parentFlowQueue=t},get:function(){return this._parentFlowQueue}},{key:"unhighlightQueue",set:function(t){this._unhighlightQueue=t},get:function(){return this._unhighlightQueue}},{key:"parameterQueue",set:function(t){this._parameterQueue=t},get:function(){return this._parameterQueue}},{key:"listeners",set:function(t){this._listeners=t},get:function(){return this._listeners}},{key:"media",set:function(t){this._media=t},get:function(){return this._media}},{key:"x",set:function(t){this._x=t},get:function(){return this._x}},{key:"y",set:function(t){this._y=t},get:function(){return this._y}},{key:"running",set:function(t){this._running=t},get:function(){return this._running}},{key:"inTrash",set:function(t){this._trash=t},get:function(){return this._trash}},{key:"decorationBitmap",get:function(){return this._decorationBitmap}},{key:"container",set:function(t){this._container=t},get:function(){return this._container}},{key:"bitmap",set:function(t){this._bitmap=t},get:function(){return this._bitmap}},{key:"imageContainer",set:function(t){this._imageContainer=t},get:function(){return this._imageContainer}},{key:"penstrokes",set:function(t){this._penstrokes=t},get:function(){return this._penstrokes}},{key:"skinChanged",set:function(t){this._skinChanged=t},get:function(){return this._skinChanged}},{key:"orientation",set:function(t){this._orientation=t},get:function(){return this._orientation}},{key:"canvas",get:function(){return this._canvas}},{key:"ctx",get:function(){return this._ctx}}]),r}();Turtle.TurtleModel=function(){function r(t,e,i,n,s){_classCallCheck(this,r),this.activity=t,this._id=e,this._name=i,this._turtles=n,this._startBlock=s,this._queue=[],this._parentFlowQueue=[],this._unhighlightQueue=[],this._parameterQueue=[],this._listeners={},this.endOfClampSignals={},this.butNotThese={},this.delayTimeout={},this.delayParameters={},this._media=[],this._x=0,this._y=0,this._running=!1,this._trash=!1}return _createClass(r,[{key:"rename",value:function(t){this._name=t;var e=this._startBlock;null!=e&&(e.overrideName=this._name,e.collapseText.text=this._name,e.regenerateArtwork(!1),e.value=this._turtles.getIndexOfTurtle(this))}}]),r}(),Turtle.TurtleView=function(){function t(){_classCallCheck(this,t),this._decorationBitmap=null,this._container=null,this._bitmap=null,this._imageContainer=null,this._penstrokes=null,this._skinChanged=!1,this._orientation=0,this._canvas=document.getElementById("overlayCanvas"),this._ctx=this._canvas.getContext("2d")}return _createClass(t,[{key:"doShowImage",value:function(e,t){var i,n=this;null!==t&&((i=new Image).onload=function(){var t=new createjs.Bitmap(i);n.imageContainer.addChild(t),n._media.push(t),t.scaleX=Number(e)/i.width,t.scaleY=t.scaleX,t.scale=t.scaleX,t.x=n.container.x,t.y=n.container.y,t.regX=i.width/2,t.regY=i.height/2,t.rotation=n.orientation,n.activity.refreshCanvas()},i.src=t)}},{key:"doShowURL",value:function(e,t){var i,n;null!==t&&((i=new Image).src=t,n=this,i.onload=function(){var t=new createjs.Bitmap(i);n.imageContainer.addChild(t),n._media.push(t),t.scaleX=Number(e)/i.width,t.scaleY=t.scaleX,t.scale=t.scaleX,t.x=n.container.x,t.y=n.container.y,t.regX=i.width/2,t.regY=i.height/2,t.rotation=n.orientation,n.activity.refreshCanvas()})}},{key:"doTurtleShell",value:function(t,s){var r,a,o=this;null!==s&&(r=Number(t),(a=new Image).src=s,a.onload=function(){o.container.removeChild(o._bitmap),o._bitmap=new createjs.Bitmap(a),o.container.addChild(o._bitmap),o._bitmap.scaleX=r/a.width,o._bitmap.scaleY=o._bitmap.scaleX,o._bitmap.scale=o._bitmap.scaleX,o._bitmap.x=0,o._bitmap.y=0,o._bitmap.regX=a.width/2,o._bitmap.regY=a.height/2,o._bitmap.rotation=o.orientation,o._skinChanged=!0,o.container.uncache();var t=o.container.getBounds();o.container.cache(t.x,t.y,t.width,t.height);var e=new createjs.Shape;e.graphics.beginFill("#FFF").drawRect(0,0,t.width,t.height),e.x=-t.width/2,e.y=-t.height/2,o.container.hitArea=e;var i,n=o._startBlock;null!=n&&(n.container.removeChild(o._decorationBitmap),o._decorationBitmap=new createjs.Bitmap(s),n.container.addChild(o._decorationBitmap),o._decorationBitmap.name="decoration",i=n.width,o._decorationBitmap.x=i-30*n.protoblock.scale/2,o._decorationBitmap.y=20*n.protoblock.scale/2,o._decorationBitmap.scaleX=27.5/a.width*n.protoblock.scale/2,o._decorationBitmap.scaleY=27.5/a.height*n.protoblock.scale/2,o._decorationBitmap.scale=27.5/a.width*n.protoblock.scale/2,n.updateCache()),o.activity.refreshCanvas()})}},{key:"resizeDecoration",value:function(t,e){this._decorationBitmap.x=e-30*t/2,this._decorationBitmap.y=35*t/2,this._decorationBitmap.scaleX=this._decorationBitmap.scaleY=this._decorationBitmap.scale=.5*t/2}},{key:"doShowText",value:function(t,e){if(null!==e)for(var i="string"!=typeof e?[e.toString()]:e.split("\\n"),n=t.toString()+"px "+this.painter.font,s=0;s<i.length;s++){var r=new createjs.Text(i[s],n,this.painter.canvasColor);r.textAlign="left",r.textBaseline="alphabetic",this.turtles.stage.addChild(r),this._media.push(r),r.x=this.container.x,r.y=this.container.y+s*t,r.rotation=this.orientation;var a=r.x*this.turtles.scale,o=r.y*this.turtles.scale,h=t*this.turtles.scale;this.painter.svgOutput+='<text x="'+a+'" y = "'+o+'" fill="'+this.painter.canvasColor+'" font-family = "'+this.painter.font+'" font-size = "'+h+'">'+e+"</text>",this.activity.refreshCanvas()}}},{key:"makeTurtleBitmap",value:function(t,n,s){var r=this,a=new Image;a.onload=function(){var t=new createjs.Bitmap(a);r._bitmap=t,r._bitmap.regX=27,r._bitmap.regY=27,r._bitmap.cursor="pointer",r.container.addChild(r._bitmap),r._createCache();var e,i=r._startBlock;s&&null!=i&&(i.updateCache(),r._decorationBitmap=r._bitmap.clone(),i.container.addChild(r._decorationBitmap),r._decorationBitmap.name="decoration",e=i.width,r._decorationBitmap.x=e-40*i.protoblock.scale/2,r._decorationBitmap.y=35*i.protoblock.scale/2,r._decorationBitmap.scaleX=r._decorationBitmap.scaleY=r._decorationBitmap.scale=.5*i.protoblock.scale/2,i.updateCache()),n.refreshCanvas()},a.src="data:image/svg+xml;base64,"+window.btoa(base64Encode(t))}}]),t}();