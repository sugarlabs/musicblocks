"use strict";function asyncGeneratorStep(e,t,o,i,a,l,n){try{var r=e[l](n),s=r.value}catch(e){return void o(e)}r.done?t(s):Promise.resolve(s).then(i,a)}function _asyncToGenerator(r){return function(){var e=this,n=arguments;return new Promise(function(t,o){var i=r.apply(e,n);function a(e){asyncGeneratorStep(i,t,o,a,l,"next",e)}function l(e){asyncGeneratorStep(i,t,o,a,l,"throw",e)}a(void 0)})}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){var o=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=o){var i,a,l,n,r=[],s=!0,c=!1;try{if(l=(o=o.call(e)).next,0===t){if(Object(o)!==o)return;s=!1}else for(;!(s=(i=l.call(o)).done)&&(r.push(i.value),r.length!==t);s=!0);}catch(e){c=!0,a=e}finally{try{if(!s&&null!=o.return&&(n=o.return(),Object(n)!==n))return}finally{if(c)throw a}}return r}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _createForOfIteratorHelper(e,t){var o="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!o){if(Array.isArray(e)||(o=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){o&&(e=o);var i=0,a=function(){};return{s:a,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var l,n=!0,r=!1;return{s:function(){o=o.call(e)},n:function(){var e=o.next();return n=e.done,e},e:function(e){r=!0,l=e},f:function(){try{n||null==o.return||o.return()}finally{if(r)throw l}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var o={}.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,i=Array(t);o<t;o++)i[o]=e[o];return i}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,_toPropertyKey(i.key),i)}}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var o=e[Symbol.toPrimitive];if(void 0===o)return("string"===t?String:Number)(e);var i=o.call(e,t||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}var PALETTE_SCALE_FACTOR=.5,PALETTE_WIDTH_FACTOR=3,paletteBlockButtonPush=function(e,t,o){return e.makeBlock(t,o)},makePaletteIcons=function(e,t,o){var i=new Image;return i.src="data:image/svg+xml;base64,"+window.btoa(base64Encode(e)),t&&(i.width=t),o&&(i.height=o),i},Palettes=function(){function t(e){_classCallCheck(this,t),this.activity=e,this.cellSize=Math.floor(this.activity.cellSize*PALETTE_SCALE_FACTOR+.5),this.paletteWidth=55*PALETTE_WIDTH_FACTOR,this.scrollDiff=0,this.originalSize=55,this.firstTime=!0,this.background=null,this.mouseOver=!1,this.activePalette=null,this.paletteObject=null,this.paletteVisible=!1,this.pluginsDeleteStatus=!1,this.visible=!0,this.scale=1,this.mobile=!1,this.top=75+LEADING,this.current=DEFAULTPALETTE,this.x=[],this.y=[],this.pluginMacros={},this.dict={},this.selectorButtonsOff=[],this.selectorButtonsOn=[],this.buttons={},this.labels={},this.pluginPalettes=[]}return _createClass(t,[{key:"init",value:function(){this.halfCellSize=Math.floor(this.cellSize/2)}},{key:"init_selectors",value:function(){for(var e=0;e<MULTIPALETTES.length;e++)this._makeSelectorButton(e)}},{key:"deltaY",value:function(e){var t=parseInt(document.getElementById("palette").style.top);document.getElementById("palette").style.top=t+e+"px"}},{key:"_makeSelectorButton",value:function(e){var t,o=this;console.debug("makeSelectorButton "+e),document.getElementById("palette")||((t=document.createElement("div")).id="palette",t.setAttribute("class","disable_highlighting"),t.classList.add("flex-palette"),t.setAttribute("style","position: absolute; z-index: 1000; left :0px; top:"+this.top+"px"),t.innerHTML='<div style="height:fit-content">\n                    <table width="'.concat(1.5*this.cellSize,'" bgcolor="white">\n                        <thead>\n                            <tr></tr>\n                        </thead>\n                    </table>\n                    <table width ="').concat(4.5*this.cellSize,'" bgcolor="white">\n                        <thead>\n                            <tr>\n                                <td style= "width:28px"></td>\n                            </tr>\n                        </thead>\n                        <tbody></tbody>\n                    </table>\n                </div>'),t.childNodes[0].style.border="1px solid ".concat(platformColor.selectorSelected),document.body.appendChild(t));var i=docById("palette").children[0].children[0].children[0].children[0],a=i.insertCell();a.width=1.5*this.cellSize,a.height=1.5*this.cellSize,a.style.position="relative",a.style.backgroundColor=platformColor.paletteBackground,a.appendChild(makePaletteIcons(PALETTEICONS[MULTIPALETTEICONS[e]].replace("background_fill_color",platformColor.paletteLabelBackground).replace(/stroke_color/g,platformColor.strokeColor).replace(/fill_color/g,platformColor.fillColor),1.5*this.cellSize,1.5*this.cellSize));var l=document.createElement("div");l.style.position="absolute",l.style.zIndex="10",l.style.top="0",l.style.width="100%",l.style.height="1px",l.style.background=platformColor.paletteLabelBackground,a.appendChild(l),a.onmouseover=function(){o.showSelection(e,i),o.makePalettes(e)}}},{key:"showSelection",value:function(e,t){for(var o=0;o<MULTIPALETTES.length;o++){var i=void 0;o===e?(i=makePaletteIcons(PALETTEICONS[MULTIPALETTEICONS[o]].replace("background_fill_color",platformColor.paletteLabelSelected).replace(/stroke_color/g,platformColor.strokeColor).replace(/fill_color/g,platformColor.fillColor),this.cellSize,this.cellSize),t.children[o].children[1].style.background=platformColor.paletteLabelSelected):(i=makePaletteIcons(PALETTEICONS[MULTIPALETTEICONS[o]].replace("background_fill_color",platformColor.paletteLabelBackground).replace(/stroke_color/g,platformColor.strokeColor).replace(/fill_color/g,platformColor.fillColor),this.cellSize,this.cellSize),t.children[o].children[1].style.background=platformColor.paletteLabelBackground),t.children[o].children[0].src=i.src}}},{key:"setSize",value:function(e){return this.cellSize=Math.floor(e*PALETTE_SCALE_FACTOR+.5),this}},{key:"setMobile",value:function(e){return(this.mobile=e)&&this._hideMenus(),this}},{key:"setSearch",value:function(e,t){return this.activity.showSearchWidget=e,this.activity.hideSearchWidget=t,this}},{key:"getSearchPos",value:function(){return[this.cellSize,this.top+1.75*this.cellSize]}},{key:"getPluginMacroExpansion",value:function(e,t,o){console.debug(this.pluginMacros[e]);var i=this.pluginMacros[e];return null!=i&&(i[0][2]=t,i[0][3]=o),i}},{key:"countProtoBlocks",value:function(e){var t=0;for(var o in this.activity.blocks.protoBlockDict)null!==this.activity.blocks.protoBlockDict[o].palette&&this.activity.blocks.protoBlockDict[o].palette.name===e&&(t+=1);return t}},{key:"getProtoNameAndPalette",value:function(e){for(var t in this.activity.blocks.protoBlockDict){if(e===this.activity.blocks.protoBlockDict[t].name&&!this.activity.blocks.protoBlockDict[t].hidden)return[t,this.activity.blocks.protoBlockDict[t].palette.name,this.activity.blocks.protoBlockDict[t].name];if(e===t&&!this.activity.blocks.protoBlockDict[t].hidden)return[t,this.activity.blocks.protoBlockDict[t].palette.name,this.activity.blocks.protoBlockDict[t].name]}return[null,null,null]}},{key:"makePalettes",value:function(e){var t=docById("palette"),o=t.children[0].children[1].children[1];o.parentNode.removeChild(o),o=t.children[0].children[1].appendChild(document.createElement("tbody")),this.makeSearchButton("search",makePaletteIcons(PALETTEICONS.search,this.cellSize,this.cellSize),o);var i,a=_createForOfIteratorHelper(MULTIPALETTES[e]);try{for(a.s();!(i=a.n()).done;){var l=i.value;this.activity.beginnerMode&&SKIPPALETTES.includes(l)||"myblocks"===l&&0===this.countProtoBlocks("myblocks")||this.makeButton(l,makePaletteIcons(PALETTEICONS[l],this.cellSize,this.cellSize),o)}}catch(e){a.e(e)}finally{a.f()}}},{key:"makeSearchButton",value:function(e,t,o){var i=o.insertRow(-1),a=i.insertCell(-1),l=i.insertCell(-1);a.appendChild(t),a.style.padding="4px",a.style.boxSizing="content-box",a.style.width="".concat(this.cellSize,"px"),a.style.height="".concat(this.cellSize,"px"),l.textContent=toTitleCase(_(e)),l.style.color=platformColor.paletteText,i.style.borderBottom="1px solid #0CAFFF",l.style.fontSize="kana"===localStorage.kanaPreference?"12px":"16px",l.style.padding="4px",i.style.display="flex",i.style.flexDirection="row",i.style.alignItems="center",i.style.width="126px",i.style.backgroundColor=platformColor.paletteBackground,this._loadPaletteButtonHandler(e,i)}},{key:"makeButton",value:function(e,t,o){var i=o.insertRow(-1),a=i.insertCell(-1),l=i.insertCell(-1);a.appendChild(t),a.style.padding="4px",a.style.boxSizing="content-box",a.style.width="".concat(this.cellSize,"px"),a.style.height="".concat(this.cellSize,"px"),l.textContent=toTitleCase(_(e)),l.style.color=platformColor.paletteText,l.style.fontSize="kana"===localStorage.kanaPreference?"12px":"16px",l.style.padding="4px",i.style.display="flex",i.style.flexDirection="row",i.style.alignItems="center",i.style.width="126px",i.style.backgroundColor=platformColor.paletteBackground,i.addEventListener("mouseover",function(){i.style.backgroundColor=platformColor.hoverColor}),i.addEventListener("mouseout",function(){i.style.backgroundColor=platformColor.paletteBackground}),this._loadPaletteButtonHandler(e,i)}},{key:"showPalette",value:function(e){this.mobile||(this.dict[e].showMenu(!0),this.activePalette=e)}},{key:"_showMenus",value:function(){}},{key:"_hideMenus",value:function(){this.activity.hideSearchWidget(!0),docById("PaletteBody")&&docById("PaletteBody").parentNode.removeChild(docById("PaletteBody"))}},{key:"getInfo",value:function(){for(var e in this.dict)console.debug(this.dict[e].getInfo())}},{key:"updatePalettes",value:function(e){var t;null!=e&&e in this.dict&&(t=!1,docById("PaletteBody")&&(t=!0),this.dict[e].hideMenu(),t&&this.dict[e].show()),this.mobile&&this.hide()}},{key:"hide",value:function(){docById("palette").style.visibility="hidden"}},{key:"show",value:function(){docById("palette").style.visibility="visible"}},{key:"clear",value:function(){try{for(var e in this.dict){var t;!this.dict.hasOwnProperty(e)||(t=this.dict[e])&&"function"==typeof t.hideMenu&&t.hideMenu()}var o=docById("palette");o&&o.parentNode.removeChild(o),this.dict={},this.visible=!1,this.activePalette=null,this.paletteObject=null;var i=document.createElement("div");i.id="palette",i.setAttribute("class","disable_highlighting"),i.classList.add("flex-palette"),i.setAttribute("style","position: fixed; z-index: 1000; left: 0px; top: ".concat(60+this.top,"px; overflow-y: auto;")),i.innerHTML='<div style="height:fit-content">\n                    <table width="'.concat(1.5*this.cellSize,'" bgcolor="white">\n                        <thead>\n                            <tr></tr>\n                        </thead>\n                    </table>\n                    <table width="').concat(4.5*this.cellSize,'" bgcolor="white">\n                        <thead>\n                            <tr>\n                                <td style= "width:28px"></td>\n                            </tr>\n                        </thead>\n                        <tbody>\n                        </tbody>\n                    </table>\n                </div>'),i.childNodes[0].style.border="1px solid ".concat(platformColor.selectorSelected),document.body.appendChild(i)}catch(e){console.error("Error clearing palettes:",e)}}},{key:"setBlocks",value:function(e){return this.blocks=e,this}},{key:"add",value:function(e){return this.dict[e]=new Palette(this,e),this}},{key:"_loadPaletteButtonHandler",value:function(t,e){var o,i=this;e.onmouseover=function(){"search"===t?document.body.style.cursor="text":(document.body.style.cursor="pointer",clearTimeout(o),o=setTimeout(function(){return i.showPalette(t)},400))},e.onmouseout=function(){return clearTimeout(o)},e.onclick=function(e){"search"==t?(i._hideMenus(),i.activity.showSearchWidget()):i.showPalette(t)},e.onmouseup=function(e){document.body.style.cursor="default"},e.onmouseleave=function(e){document.body.style.cursor="default"}}},{key:"removeActionPrototype",value:function(e){for(var t=!1,o=0;o<this.dict.action.protoList.length;o++){var i=this.dict.action.protoList[o];if(-1!==["nameddo","namedcalc","nameddoArg","namedcalcArg"].indexOf(i.name)&&i.defaults[0]===e){this.dict.action.remove(i,e),this.activity.blocks.protoBlockDict["myDo_"+e]?delete this.activity.blocks.protoBlockDict["myDo_"+e]:this.activity.blocks.protoBlockDict["myCalc_"+e]?delete this.activity.blocks.protoBlockDict["myCalc_"+e]:this.activity.blocks.protoBlockDict["myDoArg_"+e]?delete this.activity.blocks.protoBlockDict["myDoArg_"+e]:this.activity.blocks.protoBlockDict["myCalcArg_"+e]&&delete this.activity.blocks.protoBlockDict["myCalcArg_"+e],t=!0;break}}t&&this.updatePalettes("action")}}]),t}(),PaletteModel=function(){function i(e,t,o){_classCallCheck(this,i),this.palette=e,this.palettes=t,this.activity=t.activity,this.name=o,this.blocks=[]}return _createClass(i,[{key:"update",value:function(){for(var e in this.blocks=[],this.palette.protoList){var t=this.palette.protoList[e];this.blocks.push(this.makeBlockInfo(e,t,t.name,t.name))}}},{key:"makeBlockInfo",value:function(e,t,o,i){var a;switch(o){case"storein":i="store in "+t.defaults[0],a=t.defaults[0];break;case"storein2":i="store in2 "+t.staticLabels[0],a=t.staticLabels[0];break;case"box":i=t.defaults[0],a=t.defaults[0];break;case"namedbox":a=void 0===t.defaults[0]?(i="namedbox",_("box")):(i=t.defaults[0],t.defaults[0]);break;case"namedarg":a=void 0===t.defaults[0]?(i="namedarg","1"):(i=t.defaults[0],t.defaults[0]);break;case"nameddo":a=void 0===t.defaults[0]?(i="nameddo",_("action")):(i=t.defaults[0],t.defaults[0]);break;case"nameddoArg":a=void 0===t.defaults[0]?(i="nameddoArg",_("action")):(i=t.defaults[0],t.defaults[0]);break;case"namedcalc":a=void 0===t.defaults[0]?(i="namedcalc",_("action")):(i=t.defaults[0],t.defaults[0]);break;case"namedcalcArg":a=void 0===t.defaults[0]?(i="namedcalcArg",_("action")):(i=t.defaults[0],t.defaults[0])}var l=this.activity.blocks.protoBlockDict[o];null===l&&console.debug("Could not find block "+o);var n="";switch(l.name){case"grid":n=_("Grid").toLowerCase();break;case"text":n=_("text");break;case"drumname":n=_("drum");break;case"effectsname":n=_("effect");break;case"solfege":n=i18nSolfege("sol");break;case"eastindiansolfege":n=_("sargam");break;case"scaledegree2":n=_("scale degree");break;case"modename":n=_("mode name");break;case"invertmode":n=_("invert mode");break;case"voicename":n=_("voice name");break;case"customNote":n=_("custom pitch");break;case"temperamentname":n=_("temperament");break;case"accidentalname":n=_("accidental");break;case"notename":n="G";break;case"intervalname":n=_("interval name");break;case"boolean":n=_("true");break;case"number":n=NUMBERBLOCKDEFAULT.toString();break;case"less":case"greater":case"equal":n=l.staticLabels[0];break;case"namedarg":n="arg "+a;break;case"outputtools":n=_("pitch converter");break;default:o!=i?n="storein"===o&&t.defaults[0]===_("box")?_("store in"):"storein2"===o?t.staticLabels[0]===_("store in box")?_("store in box"):_("store in")+" "+t.staticLabels[0]:t.defaults[0]:0<l.staticLabels.length?""===(n=l.staticLabels[0])&&(n="loadFile"===o?_("open file"):o):n=o}-1!=["do","nameddo","namedbox","namedcalc","doArg","calcArg","nameddoArg","namedcalcArg"].indexOf(l.name)&&null!=n&&getTextWidth(n,"bold 20pt Sans")>TEXTWIDTH&&(n=n.substr(0,STRINGLEN)+"..."),l.image&&(n="");var r,s=l.scale;switch(l.scale=DEFAULTBLOCKSCALE,l.name){case"namedbox":case"namedarg":(r=new SVG).setScale(l.scale),r.setExpand(60,0,0,0),r.setOutie(!0),d=r.basicBox(),u=r.docks,h=r.getHeight();break;case"nameddo":(r=new SVG).setScale(l.scale),r.setExpand(60,0,0,0),d=r.basicBlock(),u=r.docks,h=r.getHeight();break;default:var c=l.generator(),d=c[0],u=c[1],h=c[3]}l.scale=s,d=l.disabled?d.replace(/fill_color/g,DISABLEDFILLCOLOR).replace(/stroke_color/g,DISABLEDSTROKECOLOR).replace("block_label",safeSVG(n)):d.replace(/fill_color/g,PALETTEFILLCOLORS[l.palette.name]).replace(/stroke_color/g,PALETTESTROKECOLORS[l.palette.name]).replace("block_label",safeSVG(n));for(var m=0;m<=l.args;m++)d=d.replace("arg_label_"+m,l.staticLabels[m]||"");return{blk:e,blkname:o,modname:i,height:STANDARDBLOCKHEIGHT,actualHeight:h,label:n,artwork:d,artwork64:"data:image/svg+xml;base64,"+window.btoa(base64Encode(d)),docks:u,image:t.image,scale:t.scale,palettename:this.palette.name,hidden:t.hidden}}}]),i}(),Palette=function(){function Palette(e,t){_classCallCheck(this,Palette),this.palettes=e,this.activity=e.activity,this.name=t,this.model=new PaletteModel(this,e,t),this.visible=!1,this.menuContainer=null,this.protoList=[],this.protoContainers={},this.protoHeights={},this.background=null,this.size=0,this.columns=0,this.draggingProtoBlock=!1,this.mouseHandled=!1,this.upButton=null,this.downButton=null,this.fadedUpButton=null,this.fadedDownButton=null,this.count=0,this._outsideClickListener=null}return _createClass(Palette,[{key:"hide",value:function(){this.hideMenu()}},{key:"show",value:function(){this.showMenu(!0)}},{key:"hideMenu",value:function(){docById("palette").childNodes[0].style.borderRight="1px solid ".concat(platformColor.selectorSelected),this._hideMenuItems()}},{key:"showMenu",value:function(e){var t=this,o=docById("palette");o.childNodes[0].style.borderRight="0",docById("PaletteBody")&&o.removeChild(docById("PaletteBody"));var i=document.createElement("table");i.id="PaletteBody";var a,l,n,r,s,c=window.innerHeight-this.palettes.top-this.palettes.cellSize-26;i.insertAdjacentHTML("afterbegin",'<thead></thead><tbody style = "display: block;   width: 100% ; height:auto ; max-height: '.concat(c,'px;  overflow: auto; overflow-x: hidden;" id="PaletteBody_items" class="PalScrol"></tbody>')),i.style.minWidth="180px",i.style.background=platformColor.paletteBackground,i.style.float="left",i.style.border="1px solid ".concat(platformColor.selectorSelected),[i.childNodes[0],i.childNodes[1]].forEach(function(e){e.style.boxSizing="border-box",e.style.padding="8px"}),o.appendChild(i),this.menuContainer=i,e&&((a=(a=this.menuContainer.children[0]).insertRow()).style.backgroundColor=platformColor.paletteLabelBackground,a.innerHTML='<td style ="width: 100%; height: 42px; box-sizing: border-box; display: flex; flex-direction: row; align-items: center; justify-content: space-between;"></td>',(a=a.children[0]).style.padding="8px",(l=makePaletteIcons(PALETTEICONS[this.name],this.palettes.cellSize,this.palettes.cellSize)).style.borderRadius="4px",l.style.padding="2px",l.style.backgroundColor=platformColor.paletteBackground,a.appendChild(l),(n=document.createElement("span")).textContent=toTitleCase(_(this.name)),n.style.fontWeight="bold",n.style.color=platformColor.textColor,a.appendChild(n),(r=document.createElement("span")).style.height="".concat(this.palettes.cellSize,"px"),(s=makePaletteIcons(CLOSEICON.replace("fill_color",platformColor.selectorSelected),this.palettes.cellSize,this.palettes.cellSize)).onclick=function(){return t.hideMenu()},s.onmouseover=function(){return document.body.style.cursor="pointer"},s.onmouseleave=function(){return document.body.style.cursor="default"},r.appendChild(s),a.appendChild(r)),this._showMenuItems(),this._outsideClickListener&&document.removeEventListener("click",this._outsideClickListener),this._outsideClickListener=function(e){t.menuContainer.contains(e.target)||(t.hideMenu(),document.removeEventListener("click",t._outsideClickListener),t._outsideClickListener=null)},setTimeout(function(){document.addEventListener("click",t._outsideClickListener)},0)}},{key:"_hideMenuItems",value:function(){"search"===this.name&&null!==this.activity.hideSearchWidget&&this.activity.hideSearchWidget(!0),docById("PaletteBody")&&docById("palette").removeChild(docById("PaletteBody"))}},{key:"_showMenuItems",value:function _showMenuItems(){var _this4=this;this.model.update();var paletteList=docById("PaletteBody_items"),blocks=this.model.blocks;blocks.reverse();var protoListScope=_toConsumableArray(this.protoList);last(blocks).blkname!=last(protoListScope).name&&protoListScope.reverse();var _loop=function _loop(blk){var b=blocks[blk];if(b.hidden)return"continue";var itemRow=paletteList.insertRow(),itemCell=itemRow.insertCell(),img=makePaletteIcons(b.artwork);b.image&&(img=["media","camera","video"].includes(b.blkname)?makePaletteIcons(eval(b.blkname+"PALETTE")):makePaletteIcons(_this4.activity.pluginsImages[b.blkname])),img.onmouseover=function(){return document.body.style.cursor="pointer"},img.onmouseleave=function(){return document.body.style.cursor="default"},img.ondragstart=function(){return!1};var down=function(e){var i=img.style.position,a=img.style.zIndex;img.style.position="absolute",img.style.zIndex=1e3,document.body.appendChild(img);function l(e){var t,o,i,a;e.preventDefault(),o="touchmove"===e.type?(t=e.touches[0].clientX,e.touches[0].clientY):(t=e.pageX,e.pageY),i=t,a=o,img.style.left=i-img.offsetWidth/2+"px",img.style.top=a-img.offsetHeight/2+"px"}l(e),document.addEventListener("touchmove",l,{passive:!1}),document.addEventListener("mousemove",l);function t(e){document.body.style.cursor="default",document.removeEventListener("mousemove",l),document.removeEventListener("touchmove",l),img.onmouseup=null,img.ontouchend=null;var t=parseInt(img.style.left),o=parseInt(img.style.top);img.style.position=i,img.style.zIndex=a,document.body.removeChild(img),itemCell.appendChild(img),n._makeBlockFromProtoblock(protoListScope[blk],!0,b.modname,e,(t||n.activity.blocksContainer.x+100)-n.activity.blocksContainer.x,(o||n.activity.blocksContainer.y+100)-n.activity.blocksContainer.y)}var n=_this4;img.ontouchend=t,img.onmouseup=t};img.ontouchstart=down,img.onmousedown=down,itemCell.style.width="".concat(img.width,"px"),itemCell.style.paddingRight="".concat(_this4.palettes.cellSize,"px"),itemCell.appendChild(img)};for(var blk in blocks)var _ret=_loop(blk);this.palettes.mobile&&this.hide()}},{key:"setupGrabScroll",value:function(o){function t(){document.body.style.cursor="default"}function i(e){var t=e.clientY-a;o.scrollTop=l-t,document.body.style.cursor="grabbing"}var a,l;o.onmousedown=function(e){a=e.clientY,l=o.scrollTop,o.onmousemove=i,o.onmouseup=t,o.onmouseleave=t}}},{key:"getInfo",value:function(){var e=this.name+" palette:";for(var t in this.protoList)e+=" "+this.protoList[t].name;return e}},{key:"remove",value:function(e,t){var o=this.protoList.indexOf(e);-1!==o&&this.protoList.splice(o,1);for(var i=0;i<this.model.blocks.length;i++){if(["nameddo","nameddoArg","namedcalc","namedcalcArg"].includes(this.model.blocks[i].blkname)&&this.model.blocks[i].modname===t){this.model.blocks.splice(i,1);break}if(["storein"].includes(this.model.blocks[i].blkname)&&this.model.blocks[i].modname===_("store in")+" "+t){this.model.blocks.splice(i,1);break}}}},{key:"add",value:function(e){return this.protoList.includes(e)||this.protoList.push(e),this}},{key:"makeBlockFromSearch",value:function(e,t,o){this._makeBlockFromPalette(e,t,o),this.activity.hideSearchWidget()}},{key:"_makeBlockFromPalette",value:function(e,t,o){if(null!==e){var i,a;switch(e.name){case"do":t="do "+e.defaults[0],i=e.name,a=e.defaults[0];break;case"storein":t="store in "+e.defaults[0],i=e.name,a=e.defaults[0];break;case"storein2":console.debug("storein2 "+e.defaults[0]+" "+e.staticLabels[0]),t="store in2 "+e.defaults[0],i=e.name,a=e.staticLabels[0];break;case"box":t=e.defaults[0],i=e.name,a=e.defaults[0];break;case"namedbox":a=void 0===e.defaults[0]?(t="namedbox",_("box")):(console.debug(e.defaults[0]),t=e.defaults[0],e.defaults[0]),i=e.name;break;case"namedarg":a=void 0===e.defaults[0]?(t="namedarg","1"):(t=e.defaults[0],e.defaults[0]),i=e.name;break;case"nameddo":a=void 0===e.defaults[0]?(t="nameddo",_("action")):(t=e.defaults[0],e.defaults[0]),i=e.name;break;case"nameddoArg":a=void 0===e.defaults[0]?(t="nameddoArg",_("action")):(t=e.defaults[0],e.defaults[0]),i=e.name;break;case"namedcalc":a=void 0===e.defaults[0]?(t="namedcalc",_("action")):(t=e.defaults[0],e.defaults[0]),i=e.name;break;case"namedcalcArg":a=void 0===e.defaults[0]?(t="namedcalcArg",_("action")):(t=e.defaults[0],e.defaults[0]),i=e.name;break;case"outputtools":a=void 0===e.defaults[0]?(t="outputtools","letter class"):(t=e.defaults[0],e.defaults[0]),i=e.name;break;default:a="nameddo"===t?_("action"):"__NOARG__",i=t}var l=this.activity.blocks.blockList.length;if(["namedbox","nameddo","namedcalc","nameddoArg","namedcalcArg"].includes(e.name)||!blockIsMacro(this.activity,t)){if(!["namedbox","nameddo","namedcalc","nameddoArg","namedcalcArg"].includes(e.name)&&t in this.palettes.pluginMacros)return this._makeBlockFromProtoblock(e,!0,t,null,100,100),o(l),l;var n=paletteBlockButtonPush(this.activity.blocks,i,a);return o(n),n}this._makeBlockFromProtoblock(e,!0,t,null,100,100),o(l)}else console.debug("null protoblk?")}},{key:"_makeBlockFromProtoblock",value:function(e,t,o,i,a,l){var n=this;if(t){t=!1,this.draggingProtoBlock=!1;var r=null;if("status"===e.name){for(var s=0;s<this.activity.blocks.blockList.length;s++){var c=this.activity.blocks.blockList[s];if("status"===c.name&&!c.trash)return void console.log("Status block already exists, preventing creation of another one")}null===this.activity.logo.statusMatrix&&(this.activity.logo.statusMatrix=new StatusMatrix),this.activity.logo.statusFields&&(this.activity.logo.statusFields=[]);for(var d=["modelength","deltapitch2","deltapitch","currentkey","currentmode","x","y","grey","shade","pensize","color","elapsednotes","beatfactor","notevalue","beatvalue","measurevalue","bpmfactor","currentpitch"],u=[],h=new Set,m=0;m<this.activity.blocks.blockList.length;m++){var p=this.activity.blocks.blockList[m];if(!p.trash){var y,b=_createForOfIteratorHelper(d);try{for(b.s();!(y=b.n()).done;){var f=y.value;if(p.name===f&&!h.has(f)){this.activity.logo.statusFields&&this.activity.logo.statusFields.push([m,f]),u.push([m,f]),h.add(f);break}}}catch(e){b.e(e)}finally{b.f()}}}for(var v=[],k=new Set,g=0;g<this.activity.blocks.blockList.length;g++){var _=this.activity.blocks.blockList[g];"namedbox"!==_.name||_.trash||!_.overrideName||k.has(_.overrideName)||(this.activity.logo.statusFields&&this.activity.logo.statusFields.push([g,"namedbox"]),v.push(g),k.add(_.overrideName))}for(var C=[[0,"status",a,l,[null,1,2]],[1,"hidden",0,0,[0,0<u.length||0<v.length?3:null]],[2,"hiddennoflow",0,0,[0,null]]],S=2,L=1,x=0;x<u.length;x++){var B=_slicedToArray(u[x],2),T=B[0],P=B[1],w=activity.blocks.blockList[T],A=x===u.length-1,I=0<v.length;C.push([S+1,"print",0,0,[L,S+2,!A||I?S+3:null]]),L=S+1,C.push([S+2,[P,{value:w.value}],0,0,[S+1]]),S+=2}for(var E=0;E<v.length;E++){var M=v[E],z=activity.blocks.blockList[M];console.log("Adding box block to status:",z),C.push([S+1,"print",0,0,[L,S+2,E<v.length-1?S+3:null]]),L=S+1,C.push([S+2,["namedbox",{value:z.overrideName}],0,0,[S+1]]),S+=2}console.log("blocks"),r=C,this.activity.logo.statusMatrix.init(this.activity),this.activity.logo.inStatusMatrix=!1,this.activity.logo.statusMatrix.updateAll()}else["namedbox","nameddo","namedcalc","nameddoArg","namedcalcArg"].includes(e.name)||null===(r=getMacroExpansion(this.activity,o,a,l))&&o in this.palettes.pluginMacros&&(r=this.palettes.getPluginMacroExpansion(o,a,l));if(null!==r){this.activity.blocks.loadNewBlocks(r);var D=this.activity.blocks.blockList.length-1,O=this.activity.blocks.findTopBlock(D);this.activity.blocks.blockList[O].container.x<2*this.activity.palettes.paletteWidth&&this.activity.blocks.moveBlock(O,2*this.activity.palettes.paletteWidth,this.activity.blocks.blockList[O].container.y)}else if("myblocks"===this.name){for(var N=o.replace("macro_",""),F=[],R=0;R<this.activity.macroDict[N].length;R++){var H=this.activity.macroDict[N][R][1],W=[],W="string"==typeof H?H:"string"==typeof H[1]?"number"===H[0]?[H[0],Number(H[1])]:[H[0],H[1]]:"number"==typeof H[1]?"number"===H[0]?[H[0],H[1]]:[H[0],H[1].toString()]:"number"===H[0]?[H[0],Number(H[1].value)]:[H[0],{value:H[1].value}],G=[this.activity.macroDict[N][R][0],W,this.activity.macroDict[N][R][2],this.activity.macroDict[N][R][3],this.activity.macroDict[N][R][4]];F.push(G)}F[0][2]=a,F[0][3]=l,this.activity.blocks.loadNewBlocks(F);var j=this.activity.blocks.blockList.length-1,U=this.activity.blocks.findTopBlock(j);this.activity.blocks.blockList[U].container.x<2*this.activity.palettes.paletteWidth&&this.activity.blocks.moveBlock(U,2*this.activity.palettes.paletteWidth,this.activity.blocks.blockList[U].container.y),setTimeout(function(){n.activity.blocks.blockList[U].collapseToggle()},500)}else G=this._makeBlockFromPalette(e,o,function(e){for(var t in n.activity.blocks.findDragGroup(e),n.activity.blocks.dragGroup)n.activity.blocks.moveBlockRelative(n.activity.blocks.dragGroup[t],a,l);n.activity.blocks.blockMoved(e),n.activity.blocks.checkBounds()}),this.activity.blocks.blockList[G].container.x<2*this.activity.palettes.paletteWidth&&this.activity.blocks.moveBlock(G,2*this.activity.palettes.paletteWidth,this.activity.blocks.blockList[G].container.y)}}}]),Palette}(),initPalettes=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:for(o=0;o<BUILTINPALETTES.length;o++)t.add(BUILTINPALETTES[o]);t.init_selectors(),t.makePalettes(0),console.debug("Time to show the palettes."),t.show();case 5:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}();"undefined"!=typeof module&&module.exports&&(module.exports={Palettes:Palettes,initPalettes:initPalettes});