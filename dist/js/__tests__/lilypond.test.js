"use strict";function _defineProperty(t,o,n){return(o=_toPropertyKey(o))in t?Object.defineProperty(t,o,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[o]=n,t}function _toPropertyKey(t){var o=_toPrimitive(t,"string");return"symbol"==_typeof(o)?o:o+""}function _toPrimitive(t,o){if("object"!=_typeof(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0===n)return("string"===o?String:Number)(t);var e=n.call(t,o||"default");if("object"!=_typeof(e))return e;throw new TypeError("@@toPrimitive must return a primitive value.")}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var frequencyToPitch=jest.fn(function(t){return["C","4"]}),getScaleAndHalfSteps=jest.fn(function(){return[["C","D","E","F","G","A","B"],["","","","","","",""]]}),toFraction=jest.fn(function(t){return[t,1]}),NOTATIONDURATION=1,NOTATIONNOTE=0,NOTATIONROUNDDOWN=2,NOTATIONSTACCATO=6,NOTATIONTUPLETVALUE=3,NOTATIONDOTCOUNT=4;global.frequencyToPitch=frequencyToPitch,global.getScaleAndHalfSteps=getScaleAndHalfSteps,global.toFraction=toFraction,global.NOTATIONDURATION=NOTATIONDURATION,global.NOTATIONNOTE=NOTATIONNOTE,global.NOTATIONROUNDDOWN=NOTATIONROUNDDOWN,global.NOTATIONSTACCATO=NOTATIONSTACCATO,global.NOTATIONTUPLETVALUE=NOTATIONTUPLETVALUE,global.NOTATIONDOTCOUNT=NOTATIONDOTCOUNT,global.SHARP="‚ôØ",global.FLAT="‚ô≠",global.NATURAL="‚ôÆ",global.DOUBLESHARP="ùÑ™",global.DOUBLEFLAT="ùÑ´",global._=jest.fn(function(t){return t}),global.last=jest.fn(function(t){return t[t.length-1]});var _require=require("../lilypond"),getLilypondHeader=_require.getLilypondHeader,processLilypondNotes=_require.processLilypondNotes,saveLilypondOutput=_require.saveLilypondOutput;describe("getLilypondHeader",function(){test("should return the LilyPond header as a string",function(){var t=getLilypondHeader();expect(_typeof(t)).toBe("string"),expect(t).toContain('\\version "2.18.2"'),expect(t).toContain("Made with LilyPond and Music Blocks"),expect(t).toContain("Creative Commons Attribution ShareAlike 3.0")})}),describe("processLilypondNotes",function(){var n,e,i;beforeEach(function(){n={notationNotes:_defineProperty({},e="0","0"),notation:{notationStaging:_defineProperty({},e,[[["G4"],4,0,null,0,-1,!1],"meter",4,4])}},i=""}),test('should initialize notationNotes with "\\meter\n" and process staging commands',function(){processLilypondNotes(i,n,e),expect(n.notationNotes[e]).toContain("\\meter\n"),expect(n.notationNotes[e]).toContain(" \\time 4/4\n")}),test("should process a note object correctly",function(){n.notation.notationStaging[e]=[[["G4"],4,0,null,0,-1,!1]],processLilypondNotes(i,n,e),expect(n.notationNotes[e]).toContain("\\meter\ng'4 "),expect(n.notationNotes[e]).toContain("4")}),test("should process a key signature correctly",function(){n.notation.notationStaging[e]=["key","C","major"],processLilypondNotes(i,n,e),expect(n.notationNotes[e]).toContain("\\key c \\major")}),test("should process a tempo change correctly",function(){n.notation.notationStaging[e]=["tempo",120,"Allegro"],processLilypondNotes(i,n,e),expect(n.notationNotes[e]).toContain("\\tempo Allegro = 120")}),test("should process a slur correctly",function(){n.notation.notationStaging[e]=["begin slur",[["G4"],4,0,null,0,-1,!1],"end slur"],processLilypondNotes(i,n,e),expect(n.notationNotes[e]).toContain("\\meter\ng'4 (  )  ")}),test("should process a crescendo correctly",function(){n.notation.notationStaging[e]=["begin crescendo",[["G4"],4,0,null,0,-1,!1],"end crescendo"],processLilypondNotes(i,n,e),expect(n.notationNotes[e]).toContain("\\meter\n  g'4 \\< \\! ")}),test("should process a decrescendo correctly",function(){n.notation.notationStaging[e]=["begin decrescendo",[["G4"],4,0,null,0,-1,!1],"end decrescendo"],processLilypondNotes(i,n,e),expect(n.notationNotes[e]).toContain("\\meter\n  g'4 \\> \\! ")}),test("should process a tuplet correctly",function(){n.notation.notationStaging[e]=[[["G4"],4,0,[3,2],0,-1,!1]],processLilypondNotes(i,n,e),expect(n.notationNotes[e]).toContain("\\meter\n\\tuplet Infinity/1 { g' 0} ")}),test("should process a markup command correctly",function(){n.notation.notationStaging[e]=["markup","Test Markup"],processLilypondNotes(i,n,e),expect(n.notationNotes[e]).toContain("^\\markup { \\abs-fontsize #6 { Test Markup } } ")}),test("should process a markdown command correctly",function(){n.notation.notationStaging[e]=["markdown","Test Markdown"],processLilypondNotes(i,n,e),expect(n.notationNotes[e]).toContain("_\\markup { Test Markdown } ")}),test("should process a break command correctly",function(){n.notation.notationStaging[e]=[[["G4"],4,0,null,0,-1,!1],"break",[["E4"],4,0,null,0,-1,!1]],processLilypondNotes(i,n,e),expect(n.notationNotes[e]).toContain("\n")}),test("should process articulation commands correctly",function(){n.notation.notationStaging[e]=["begin articulation",[["G4"],4,0,null,0,-1,!1],"end articulation"],processLilypondNotes(i,n,e),expect(n.notationNotes[e]).toContain("->")}),test("should process a pickup command correctly",function(){n.notation.notationStaging[e]=["pickup",4,[["G4"],4,0,null,0,-1,!1]],processLilypondNotes(i,n,e),expect(n.notationNotes[e]).toContain("\\partial 4\n")}),test("should process voice commands correctly",function(){n.notation.notationStaging[e]=["voice one",[["G4"],4,0,null,0,-1,!1],"voice two",[["E4"],4,0,null,0,-1,!1],"one voice"],processLilypondNotes(i,n,e),expect(n.notationNotes[e]).toContain("<< { \\voiceOne "),expect(n.notationNotes[e]).toContain("}\n\\new Voice { \\voiceTwo "),expect(n.notationNotes[e]).toContain("}\n>> \\oneVoice\n")}),test("should process a tie command correctly",function(){n.notation.notationStaging[e]=["tie"],processLilypondNotes(i,n,e),expect(n.notationNotes[e]).toContain("~")}),test("should append unrecognized command as is",function(){n.notation.notationStaging[e]=["unrecognized"],processLilypondNotes(i,n,e),expect(n.notationNotes[e]).toContain("unrecognized")}),test("should process note object with dot notation",function(){n.notation.notationStaging[e]=[[["G4"],4,0,null,2,-1,!1]],processLilypondNotes(i,n,e),expect(n.notationNotes[e]).toContain("4..")}),test("should process note object with staccato",function(){n.notation.notationStaging[e]=[[["G4"],4,0,null,0,-1,!0]],processLilypondNotes(i,n,e),expect(n.notationNotes[e]).toContain("\\staccato ")}),test("should insert newline after 8 notes",function(){for(var t=[],o=0;o<9;o++)t.push([["G4"],4,0,null,0,-1,!1]);n.notation.notationStaging[e]=t,processLilypondNotes(i,n,e),expect(n.notationNotes[e]).toContain("\n")}),test("should handle incomplete tuplet gracefully",function(){n.notation.notationStaging[e]=[[["G4"],4,0,[3,2],0,-1,!1]],processLilypondNotes(i,n,e),expect(n.notationNotes[e]).toContain("\\tuplet")})}),describe("saveLilypondOutput",function(){var o;beforeEach(function(){global.RODENTS=["mouse","brown rat","mole","chipmunk","red squirrel","guinea pig","capybara","coypu","black rat","grey squirrel","flying squirrel","bat"],o={logo:{notation:{notationStaging:{0:[[["G4"],4,0,null,0,-1,!1]],1:[[["E4"],4,0,null,0,-1,!1]]},notationDrumStaging:{}},notationNotes:{},notationOutput:"",guitarOutputHead:"",guitarOutputEnd:"",MIDIOutput:""},turtles:{turtleList:{0:{name:"Turtle 0"},1:{name:"Turtle 1"}},getTurtle:function(t){return this.turtleList[t]}},prepareExport:jest.fn(function(){return JSON.stringify({project:"data"})})}}),test("should generate LilyPond output correctly",function(){var t=saveLilypondOutput(o);expect(t).toContain("% You can change the MIDI instruments below to anything on this list:"),expect(t).toContain("\\score {"),expect(t).toContain("\\layout {}"),expect(t).toContain("% MUSIC BLOCKS CODE"),expect(t).toContain('{"project":"data"}')}),test("should handle drum staging correctly",function(){o.logo.notation.notationDrumStaging={0:[[["C4"],4,0,null,0,-1,!1]]};var t=saveLilypondOutput(o);expect(t).toContain("\\drummode {")}),test("should handle empty drum staging correctly",function(){o.logo.notation.notationDrumStaging={0:[]};var t=saveLilypondOutput(o);expect(t).not.toContain("\\drummode {")}),test("should handle multiple turtles correctly",function(){var t=saveLilypondOutput(o);expect(t).toContain("Turtle0 = {"),expect(t).toContain("Turtle1 = {")}),test("should handle unique short instrument names correctly",function(){o.turtles.turtleList={0:{name:"Turtle 0"},1:{name:"Turtle 1"},2:{name:"Turtle 2"}};var t=saveLilypondOutput(o);expect(t).toContain('shortInstrumentName = "Tu"')}),test("should handle empty notation staging correctly",function(){o.logo.notation.notationStaging={};var t=saveLilypondOutput(o);expect(t).not.toContain('% You can change the MIDI instruments below to anything on this list:\n% (http://lilypond.org/doc/v2.18/documentation/notation/midi-instruments)\n\n\\score {\n <<\n\n >> \\layout {}\n% MUSIC BLOCKS CODE\n% Below is the code for the Music Blocks project that generated this Lilypond file.\n%{\n\n{"project":"data"}\n%}\n\n')}),test("should handle empty notation output correctly",function(){o.logo.notationOutput="";var t=saveLilypondOutput(o);expect(t).toContain("% You can change the MIDI instruments below to anything on this list:")}),test("should fallback to RODENTS names if instrument name is empty",function(){o.turtles.getTurtle=jest.fn(function(t){return{name:""}}),o.turtles.turtleList={0:{}},saveLilypondOutput(o),expect(o.logo.notationOutput).toContain(RODENTS[0])}),test("should handle multiple turtles with different clefs correctly",function(){o.logo.notationNotes={0:"\\note0",1:"\\note1"},o.logo.notation.notationStaging={0:["note"],1:["note"]},clef=["treble","bass_8"],CLEFS=["treble","bass_8"];var t=saveLilypondOutput(o);expect(t).toContain('\\context TabVoice = "Turtle0" \\Turtle0'),expect(t).toContain('shortInstrumentName = "Tu"'),expect(t).toContain("Turtle1Voice = \\new Staff \\with {")}),test("should ensure last turtle adds a bar",function(){o.logo.notationNotes[0]="g'4 ",o.logo.notation.notationStaging[0]=["note"],turtleCount=1;var t=saveLilypondOutput(o);expect(t).toContain(' \\bar "|."')}),test("should correctly handle score block generation",function(){o.logo.notationNotes[0]="\\note0",o.logo.notation.notationStaging[0]=["note"],o.logo.notationNotes[1]="\\note1",o.logo.notation.notationStaging[1]=["note"],CLEFS=["treble","bass_8"];var t=saveLilypondOutput(o);expect(t).toContain("\\score {"),expect(t).toContain("\\layout {}")}),test("should handle music blocks code correctly",function(){o.prepareExport=jest.fn(function(){return'{"musicBlocks": ["block1", "block2"]}'});var t=saveLilypondOutput(o);expect(t).toContain("% MUSIC BLOCKS CODE"),expect(t).toContain('{"musicBlocks": ["block1", "block2"]}')}),test("should handle custom mode definitions correctly",function(){o.logo.notation.notationStaging[0].push("custom mode");var t=saveLilypondOutput(o);expect(t).toContain("custom mode")}),test("should properly format guitar tab output",function(){o.logo.guitarOutputHead="% Guitar Output Head\n",o.logo.guitarOutputEnd="% Guitar Output End\n",o.logo.notationNotes={0:"\\note0"},o.logo.notation.notationStaging={0:["note"]};var t=saveLilypondOutput(o);expect(t).toContain("% Guitar Output Head"),expect(t).toContain("% Guitar Output End")}),test("should handle MIDI output correctly",function(){o.logo.MIDIOutput="% MIDI Output";var t=saveLilypondOutput(o);expect(t).toContain("% MIDI Output")})});