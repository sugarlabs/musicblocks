"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ownKeys(t,e){var n,o=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),o.push.apply(o,n)),o}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(n),!0).forEach(function(e){_defineProperty(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function _defineProperty(e,t,n){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0===n)return("string"===t?String:Number)(e);var o=n.call(e,t||"default");if("object"!=_typeof(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}function asyncGeneratorStep(e,t,n,o,a,r,i){try{var l=e[r](i),c=l.value}catch(e){return void n(e)}l.done?t(c):Promise.resolve(c).then(o,a)}function _asyncToGenerator(l){return function(){var e=this,i=arguments;return new Promise(function(t,n){var o=l.apply(e,i);function a(e){asyncGeneratorStep(o,t,n,a,r,"next",e)}function r(e){asyncGeneratorStep(o,t,n,a,r,"throw",e)}a(void 0)})}}global.Midi=jest.fn().mockImplementation(function(){return{header:{ticksPerBeat:480},addTrack:jest.fn(function(){return{addNote:jest.fn(),name:"",instrument:{number:0},channel:0}}),toArray:jest.fn(function(){return new Uint8Array([1,2,3])})}}),global.jQuery=jest.fn(function(){return{on:jest.fn(),trigger:jest.fn()}}),global.jQuery.noConflict=jest.fn(function(){return global.jQuery}),global._=jest.fn(function(e){return e}),global._THIS_IS_TURTLE_BLOCKS_=!0,global.TITLESTRING="Music Blocks",global.GUIDEURL="Docs/guide/guide.html",global.fileExt=jest.fn(function(e){if(!e)return"";var t=e.split(".");return 1===t.length||""===t[0]&&2===t.length?"":t.pop()}),global.window={isElectron:!1,prompt:jest.fn()},global.document={createElement:jest.fn(function(){return{setAttribute:jest.fn(),click:jest.fn()}}),body:{appendChild:jest.fn(),removeChild:jest.fn()}},global.docById=jest.fn(function(e){return document.getElementById(e)}),global.docByClass=jest.fn(function(e){return document.getElementsByClassName(e)}),global.mockRunLogoCommands=jest.fn(),global.mockDownload=jest.fn();var _require=require("../SaveInterface"),SaveInterface=_require.SaveInterface,_require2=require("../lilypond"),LILYPONDHEADER=_require2.LILYPONDHEADER;global.LILYPONDHEADER=LILYPONDHEADER,global.instance=new SaveInterface,describe("SaveInterface",function(){var e,t;beforeEach(function(){e={beginnerMode:!1,PlanetInterface:{getCurrentProjectName:jest.fn(function(){return"My Project"})}},t=new SaveInterface(e)}),it("should initialize with the correct default values",function(){expect(t.activity).toBe(e),expect(t.filename).toBeNull(),expect(t.notationConvert).toBe(""),expect(t.timeLastSaved).toBe(-100)}),it("should store activity instance correctly",function(){var e={beginnerMode:!0},t=new SaveInterface(e);expect(t.activity).toBe(e)})}),describe("download",function(){var t;beforeEach(function(){var e={beginnerMode:!1,PlanetInterface:{getCurrentProjectName:jest.fn(function(){return"My Project"})}};t=new SaveInterface(e),document.body.innerHTML="",mockDownloadURL=jest.spyOn(t,"downloadURL"),Object.defineProperty(window,"prompt",{writable:!0,value:jest.fn(function(){return"My Project.abc"})})}),it("should set correct filename and extension when defaultfilename is provided",function(){t.download("abc","data","custom"),expect(mockDownloadURL).toHaveBeenCalledWith("custom.abc","data")}),it("should default filename to 'My Project.abc' if defaultfilename is null",function(){t.download("abc","data",null),expect(mockDownloadURL).toHaveBeenCalledWith("My Project.abc","data")}),it("should append the extension if not present in the filename",function(){t.download("wav","data","My Project"),expect(mockDownloadURL).toHaveBeenCalledWith("My Project.wav","data")}),it("should not append the extension if already present in the filename",function(){t.download("xml","data","My Project"),expect(mockDownloadURL).toHaveBeenCalledWith("My Project.xml","data")}),t=new SaveInterface,it("should create an anchor tag and trigger a download",function(){document.body.appendChild=jest.fn(),document.body.removeChild=jest.fn();var e=jest.fn();jest.spyOn(document,"createElement").mockImplementation(function(){return{setAttribute:jest.fn(),click:e}}),t.downloadURL("test.txt","data:text/plain;base64,SGVsbG8gd29ybGQ="),expect(document.createElement).toHaveBeenCalledWith("a"),expect(e).toHaveBeenCalled(),expect(document.body.appendChild).toHaveBeenCalled(),expect(document.body.removeChild).toHaveBeenCalled()}),afterEach(function(){jest.restoreAllMocks()})}),describe("save HTML methods",function(){var t;beforeEach(function(){t={htmlSaveTemplate:"<html><body><h1>{{ project_name }}</h1><p>{{ project_description }}</p><img src='{{ project_image }}'/><div>{{ data }}</div></body></html>",prepareExport:jest.fn(function(){return"Mock Exported Data"}),PlanetInterface:{getCurrentProjectDescription:jest.fn(function(){return"Mock Description"}),getCurrentProjectName:jest.fn(function(){return"Mock Project"}),getCurrentProjectImage:jest.fn(function(){return"mock-image.png"})}}}),it("should replace placeholders with actual project data",function(){var e=(e=t.htmlSaveTemplate).replace(/{{ project_description }}/g,t.PlanetInterface.getCurrentProjectDescription()).replace(/{{ project_name }}/g,t.PlanetInterface.getCurrentProjectName()).replace(/{{ data }}/g,t.prepareExport()).replace(/{{ project_image }}/g,t.PlanetInterface.getCurrentProjectImage());expect(e).toContain("<h1>Mock Project</h1>"),expect(e).toContain("<p>Mock Description</p>"),expect(e).toContain("<img src='mock-image.png'/>"),expect(e).toContain("<div>Mock Exported Data</div>")}),it("should call prepareHTML and download the file",function(){var e=jest.fn(function(){return"<html>Mock HTML</html>"}),t={save:{prepareHTML:e,download:mockDownload}};instance.saveHTML(t),expect(e).toHaveBeenCalled(),expect(mockDownload).toHaveBeenCalledWith("html","data:text/plain;charset=utf-8,%3Chtml%3EMock%20HTML%3C%2Fhtml%3E",null)}),jest.useFakeTimers(),it("should call prepareHTML and download the file with the correct filename",function(){var e=jest.fn(function(){return"<html>Mock HTML</html>"}),t=jest.fn(function(){return"MockProject"}),n={save:{prepareHTML:e,downloadURL:mockDownloadURL},PlanetInterface:{getCurrentProjectName:t}};instance.saveHTMLNoPrompt(n),jest.runAllTimers(),expect(e).toHaveBeenCalled(),expect(t).toHaveBeenCalled(),expect(mockDownloadURL).toHaveBeenCalledWith("MockProject.html","data:text/plain;charset=utf-8,%3Chtml%3EMock%20HTML%3C%2Fhtml%3E")})}),describe("saveMIDI Method",function(){var e,t;beforeEach(function(){t={runningMIDI:!1,runLogoCommands:jest.fn()},e={logo:t}}),it("should set runningMIDI to true and run logo commands",function(){instance.saveMIDI(e),expect(e.logo.runningMIDI).toBe(!0),expect(e.logo.runLogoCommands).toHaveBeenCalled(),expect(document.body.style.cursor).toBe("wait")})}),describe("afterSaveMIDI",function(){beforeEach(function(){global.activity={logo:{_midiData:{0:[{note:["G4"],duration:4,bpm:90,instrument:"guitar"},{note:["E4"],duration:4,bpm:90,instrument:"guitar"}]}},save:{download:jest.fn()}},global.URL.createObjectURL=jest.fn(function(){return"mockURL"}),jest.useFakeTimers(),global.getMidiInstrument=jest.fn(function(){return{default:0,guitar:25}}),global.getMidiDrum=jest.fn(function(){return{"snare drum":38,"kick drum":36}})}),afterEach(function(){jest.clearAllMocks()}),it("should generate MIDI and trigger download",function(){instance.afterSaveMIDI(),jest.runAllTimers(),expect(Midi).toHaveBeenCalled(),expect(activity.save.download).toHaveBeenCalledWith("midi","mockURL",null),expect(activity.logo._midiData).toEqual({}),expect(document.body.style.cursor).toBe("default")}),it("should create instrument tracks and add notes correctly",function(){instance.afterSaveMIDI(),jest.runAllTimers();var e=Midi.mock.results[0].value.addTrack.mock.results.map(function(e){return e.value}).find(function(e){return"Track 1 - guitar"===e.name});expect(e.instrument.number).toBe(25),expect(e.addNote).toHaveBeenNthCalledWith(1,{name:"G4",time:0,duration:.6666666666666666,velocity:.8}),expect(e.addNote).toHaveBeenNthCalledWith(2,{name:"E4",time:.6666666666666666,duration:.6666666666666666,velocity:.8})})}),describe("save artwork methods",function(){beforeEach(function(){document.body.innerHTML='\n            <canvas id="overlayCanvas"></canvas>\n        ',docById.mockImplementation(function(e){return document.getElementById(e)})}),it("should call doSVG and download the SVG file",function(){var e=jest.fn(function(){return"<svg>Mock SVG</svg>"});global.doSVG=e;var t={save:{download:mockDownload},canvas:{width:500,height:500},logo:"mockLogo",turtles:"mockTurtles"};instance.saveSVG(t),expect(e).toHaveBeenCalledWith(t.canvas,t.logo,t.turtles,t.canvas.width,t.canvas.height,1),expect(mockDownload).toHaveBeenCalledWith("svg","data:image/svg+xml;utf8,<svg>Mock SVG</svg>",null)}),it("should call toDataURL and download the PNG file",function(){var e={toDataURL:jest.fn(function(){return"data:image/png;base64,mockdata"})};global.docById=jest.fn(function(){return e});var t={save:{download:mockDownload}};instance.savePNG(t),expect(e.toDataURL).toHaveBeenCalledWith("image/png"),expect(mockDownload).toHaveBeenCalledWith("png","data:image/png;base64,mockdata",null)}),it("should call printBlockSVG and download the SVG file",function(){var e=jest.fn(function(){return"<svg>Mock SVG</svg>"}),t={save:{download:mockDownload},printBlockSVG:e};instance.saveBlockArtwork(t),expect(e).toHaveBeenCalled(),expect(mockDownload).toHaveBeenCalledWith("svg","data:image/svg+xml;utf8,<svg>Mock SVG</svg>",null)}),it("should call printBlockPNG and download the PNG file",_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=jest.fn(function(){return Promise.resolve("data:image/png;base64,mockdata")}),n={save:{download:mockDownload},printBlockPNG:t},e.next=4,instance.saveBlockArtworkPNG(n);case 4:expect(t).toHaveBeenCalled(),expect(mockDownload).toHaveBeenCalledWith("png","data:image/png;base64,mockdata",null);case 6:case"end":return e.stop()}},e)})))}),describe("saveWAV & saveABC methods",function(){beforeEach(function(){global._=jest.fn(function(e){return e}),global.ABCHEADER="X:1\nT:Music Blocks composition\nC:Mr. Mouse\nL:1/16\nM:C\n"}),it("should start audio recording and update UI",function(){var e=jest.fn(),t=jest.fn(),n=jest.fn(),o={logo:{recording:!1,synth:{setupRecorder:e,recorder:{start:t}},runLogoCommands:mockRunLogoCommands},textMsg:n};instance.saveWAV(o),expect(document.body.style.cursor).toBe("wait"),expect(o.logo.recording).toBe(!0),expect(e).toHaveBeenCalled(),expect(t).toHaveBeenCalled(),expect(mockRunLogoCommands).toHaveBeenCalled(),expect(n).toHaveBeenCalledWith("Your recording is in progress.")}),it("should prepare and run ABC notation commands",function(){var e={logo:{runningAbc:!1,notationOutput:"",notationNotes:{},notation:{notationStaging:{},notationDrumStaging:{}},runLogoCommands:mockRunLogoCommands},turtles:{turtleList:[{painter:{doClear:jest.fn()}}],getTurtleCount:jest.fn(function(){return 1}),getTurtle:function(e){return this.turtleList[e]}}};instance.saveAbc(e),expect(document.body.style.cursor).toBe("wait"),expect(e.logo.runningAbc).toBe(!0),expect(mockRunLogoCommands).toHaveBeenCalled()}),it("should encode and download ABC notation output",function(){var e=jest.fn(function(){return"mock_abc_data"});global.saveAbcOutput=e;var t={save:{download:mockDownload}};instance.afterSaveAbc.call({activity:t}),expect(e).toHaveBeenCalledWith(t),expect(mockDownload).toHaveBeenCalledWith("abc","data:text;utf8,mock_abc_data",null)})}),describe("saveLilypond Methods",function(){var e,t,n,o;beforeEach(function(){document.body.innerHTML='\n            <div id="lilypondModal" style="display: none;">\n                <div class="modal-content" tabindex="-1">\n                    <span class="close">Ã—</span>\n                    <div id="fileNameText">File name</div>\n                    <input type="text" id="fileName" value="TestProject.ly" tabindex="-1">\n                    <p></p>\n                    <div id="titleText">Project title</div>\n                    <input type="text" id="title" tabindex="-1">\n                    <p></p>\n                    <div id="authorText">Project author</div>\n                    <input type="text" id="author" tabindex="-1">\n                    <p></p>\n                    <div id="MIDIText">Include MIDI output?</div>\n                    <input type="checkbox" id="MIDICheck" tabindex="-1">\n                    <p></p>\n                    <div id="guitarText">Include guitar tablature output?</div>\n                    <input type="checkbox" id="guitarCheck" tabindex="-1">\n                    <p></p>\n                    <p><button id="submitLilypond">Save as Lilypond</button></p>\n                </div>\n            </div>\n        ',global.docById=jest.fn(function(e){return document.getElementById(e)}),jest.spyOn(document,"getElementById").mockImplementation(function(e){return document.querySelector("#".concat(e))}),document.execCommand=jest.fn(),global.platform={FF:!1},global.jQuery=jest.fn(function(e){return e===window?{on:jest.fn()}:{appendTo:jest.fn().mockReturnThis(),val:jest.fn().mockReturnThis(),select:jest.fn(),remove:jest.fn(),on:jest.fn()}}),global.jQuery.noConflict=jest.fn().mockImplementation(function(){return global.jQuery}),e={PlanetInterface:{getCurrentProjectName:jest.fn(function(){return"Test Project"})},storage:{getItem:jest.fn(function(){return JSON.stringify("Custom Author")}),setItem:jest.fn()},save:{saveLYFile:jest.fn(),download:jest.fn()},logo:{runningLilypond:!1,MIDIOutput:"",guitarOutputHead:"",guitarOutputEnd:"",notationOutput:"",notationNotes:{},notation:{notationStaging:[],notationDrumStaging:[]},runLogoCommands:jest.fn()},textMsg:jest.fn(),download:jest.fn()},n=_objectSpread(_objectSpread({},e),{},{turtles:{turtleList:[{painter:{doClear:jest.fn()}}],getTurtleCount:jest.fn(function(){return 1}),getTurtle:function(e){return this.turtleList[e]}}}),instance=new SaveInterface,instance.activity=e,instance.notationConvert="ly",instance.afterSaveLilypondLY=jest.fn(),t=new SaveInterface(n),mockSaveLilypondOutput=jest.fn(function(){return"Lilypond Data"}),global.saveLilypondOutput=mockSaveLilypondOutput,o=jest.fn(),window.Converter={ly2pdf:jest.fn()},lydata="Lilypond Data",filename="TestProject.pdf",dataurl="data:application/pdf;base64,abc123",document.body.style.cursor=""}),it("should open the Lilypond modal and populate fields",function(){instance.saveLilypond(e),expect(docById("lilypondModal").style.display).toBe("block"),expect(docById("fileName").value).toBe("Test Project.ly"),expect(docById("title").value).toBe("Test Project"),expect(docById("author").value).toBe("Custom Author")}),it("should close the modal when close button is clicked",function(){instance.saveLilypond(e),docByClass("close")[0].click(),expect(e.logo.runningLilypond).toBe(!1),expect(docById("lilypondModal").style.display).toBe("none")}),it("should call saveLYFile when save button is clicked",function(){instance.saveLilypond(e),docById("submitLilypond").click(),expect(e.save.saveLYFile).toHaveBeenCalledWith(!1)}),afterEach(function(){jest.clearAllMocks()}),it("should save a Lilypond file with default settings",function(){t.saveLYFile(),expect(global.docById).toHaveBeenCalledWith("fileName")}),it("should save a Lilypond file with PDF conversion",function(){t.saveLYFile(!0),expect(t.notationConvert).toBe("pdf")}),it("should handle MIDI and guitar output settings correctly",function(){o.mockImplementation(function(e){return{fileName:{value:"testFile"},title:{value:"My Project"},author:{value:"Mr. Mouse"},MIDICheck:{checked:!0},guitarCheck:{checked:!0},lilypondModal:{style:{display:"block"}}}[e]}),t.saveLYFile();expect(n.logo.MIDIOutput).toContain("% MIDI SECTION\n% Delete the %{ and %} below to include MIDI output.\n%{\n\\midi {\n   \\tempo 4=90\n}\n%}\n\n}")}),it("should call saveLilypondOutput and afterSaveLilypondLY",function(){instance.afterSaveLilypond("ignored.ly"),expect(mockSaveLilypondOutput).toHaveBeenCalledWith(instance.activity),expect(instance.afterSaveLilypondLY).toHaveBeenCalledWith("Lilypond Data","TestProject.ly"),expect(instance.notationConvert).toBe("")}),it('should set cursor to "wait" and call ly2pdf with correct arguments',function(){instance.afterSaveLilypondPDF(lydata,filename),expect(document.body.style.cursor).toBe("wait"),expect(window.Converter.ly2pdf).toHaveBeenCalledWith(lydata,expect.any(Function))}),it('should reset cursor to "default" and call activity.save.download on success',function(){window.Converter.ly2pdf.mockImplementation(function(e,t){t(!0,dataurl)}),instance.afterSaveLilypondPDF(lydata,filename),expect(document.body.style.cursor).toBe("default"),expect(e.save.download).toHaveBeenCalledWith("pdf",dataurl,filename)}),it('should reset cursor to "default" and log an error on failure',function(){var n="Conversion failed";window.Converter.ly2pdf.mockImplementation(function(e,t){t(!1,n)}),console.debug=jest.fn(),instance.afterSaveLilypondPDF(lydata,filename),expect(document.body.style.cursor).toBe("default"),expect(console.debug).toHaveBeenCalledWith("Error: "+n),expect(e.save.download).not.toHaveBeenCalled()})}),describe("MXML Methods",function(){var n,o,a,r;beforeEach(function(){var e={doClear:jest.fn()},t={doClear:jest.fn()};a={runningMxml:!(r={turtleList:[{painter:e},{painter:t}],getTurtleCount:function(){return this.turtleList.length},getTurtle:function(e){return this.turtleList[e]}}),notation:{notationStaging:{},notationDrumStaging:{}},runLogoCommands:jest.fn()},o={logo:a,turtles:r},(n=new SaveInterface).activity=o,n.download=jest.fn(),global.saveMxmlOutput=jest.fn().mockReturnValue("<score>Mock MXML Data</score>")}),it("should initialize MXML state and clear turtle canvases",function(){n.saveMxml("test.mxml"),expect(o.logo.runningMxml).toBe(!0),expect(o.logo.notation.notationStaging[0]).toEqual([]),expect(o.logo.notation.notationStaging[1]).toEqual([]),expect(o.logo.notation.notationDrumStaging[0]).toEqual([]),expect(o.logo.notation.notationDrumStaging[1]).toEqual([]),expect(r.turtleList[0].painter.doClear).toHaveBeenCalledWith(!0,!0,!0),expect(r.turtleList[1].painter.doClear).toHaveBeenCalledWith(!0,!0,!0),expect(o.logo.runLogoCommands).toHaveBeenCalled()}),it("should generate XML and trigger download",function(){var e="TestScore.xml";n.afterSaveMxml(e),expect(global.saveMxmlOutput).toHaveBeenCalledWith(o.logo);var t="data:text;utf8,"+encodeURIComponent("<score>Mock MXML Data</score>");expect(n.download).toHaveBeenCalledWith("xml",t,e),expect(o.logo.runningMxml).toBe(!1)}),it("should handle empty data gracefully",function(){global.saveMxmlOutput.mockReturnValue(""),n.afterSaveMxml("empty.xml"),expect(n.download).toHaveBeenCalledWith("xml","data:text;utf8,"+encodeURIComponent(""),"empty.xml")})});