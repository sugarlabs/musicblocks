"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ownKeys(t,e){var r,n=Object.keys(t);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(t),e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)),n}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(r),!0).forEach(function(e){_defineProperty(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function _defineProperty(e,t,r){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);var n=r.call(e,t||"default");if("object"!=_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}function asyncGeneratorStep(e,t,r,n,o,i,a){try{var c=e[i](a),s=c.value}catch(e){return void r(e)}c.done?t(s):Promise.resolve(s).then(n,o)}function _asyncToGenerator(c){return function(){var e=this,a=arguments;return new Promise(function(t,r){var n=c.apply(e,a);function o(e){asyncGeneratorStep(n,t,r,o,i,"next",e)}function i(e){asyncGeneratorStep(n,t,r,o,i,"throw",e)}o(void 0)})}}var _require=require("../midi"),getClosestStandardNoteValue=_require.getClosestStandardNoteValue,transcribeMidi=_require.transcribeMidi,mockMidi={header:{ppq:480,tempos:[{bpm:120}],timeSignatures:[{timeSignature:[4,4],ticks:0}]},tracks:[{instrument:{name:"acoustic grand piano",family:"piano",number:0,percussion:!1},channel:1,notes:[{name:"C4",midi:60,time:0,duration:.5,velocity:.8},{name:"E4",midi:64,time:.5,duration:.75,velocity:.9},{name:"G4",midi:67,time:1.25,duration:.5,velocity:.85}]},{instrument:{name:"acoustic guitar (nylon)",family:"guitar",number:24,percussion:!1},channel:2,notes:[{name:"G3",midi:55,time:0,duration:.6,velocity:.7},{name:"C4",midi:60,time:.6,duration:.8,velocity:.75}]},{instrument:{name:"drums",family:"percussion",number:128,percussion:!0},channel:9,notes:[{name:"Snare Drum",midi:38,time:0,duration:.3,velocity:.9},{name:"Kick Drum",midi:36,time:.5,duration:.3,velocity:.8}]}]};describe("getClosestStandardNoteValue",function(){it("should return the closest standard note duration for a given input",function(){expect(getClosestStandardNoteValue(1)).toEqual([1,1]),expect(getClosestStandardNoteValue(.0078125)).toEqual([1,128])})}),describe("transcribeMidi",function(){var i;beforeEach(function(){global.getReverseDrumMidi=jest.fn(function(){return{38:["snare drum"],36:["kick drum"],41:["tom tom"]}}),global.VOICENAMES=[["piano","acoustic grand piano"],["guitar","acoustic guitar (nylon)"]],global.activity={textMsg:jest.fn(),blocks:{loadNewBlocks:jest.fn(),palettes:{_hideMenus:jest.fn()},trashStacks:[]}},i=jest.spyOn(activity.blocks,"loadNewBlocks")}),afterEach(function(){jest.clearAllMocks()}),it("should process all tracks and generate blocks",_asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,transcribeMidi(mockMidi);case 2:expect(i).toHaveBeenCalled(),t=i.mock.calls[0][0],expect(Array.isArray(t)).toBe(!0),expect(t.length).toBeGreaterThan(0);case 6:case"end":return e.stop()}},e)}))),it("should handle default tempo correctly",_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=_objectSpread(_objectSpread({},mockMidi),{},{header:_objectSpread(_objectSpread({},mockMidi.header),{},{tempos:[]})}),e.next=3,transcribeMidi(t);case 3:expect(i).toHaveBeenCalled(),r=i.mock.calls[0][0],n=r.find(function(e){return Array.isArray(e[1])&&"setbpm3"===e[1][0]}),expect(n).toBeDefined(),o=r.find(function(e){return e[0]===n[4][1]}),expect(o).toBeDefined(),expect(o[1][1].value).toBe(90);case 10:case"end":return e.stop()}},e)}))),it("should skip tracks with no notes",_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=_objectSpread(_objectSpread({},mockMidi),{},{tracks:[_objectSpread(_objectSpread({},mockMidi.tracks[0]),{},{notes:[]})]}),e.next=3,transcribeMidi(t);case 3:expect(i).toHaveBeenCalled(),r=i.mock.calls[0][0],n=r.filter(function(e){return Array.isArray(e[1])&&"setturtlename2"===e[1][0]}),expect(n.length).toBe(0);case 7:case"end":return e.stop()}},e)}))),it("should handle percussion instruments correctly",_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,transcribeMidi(mockMidi);case 2:expect(i).toHaveBeenCalled(),t=i.mock.calls[0][0],r=t.filter(function(e){return"playdrum"===e[1]}),expect(r.length).toBeGreaterThan(0);case 6:case"end":return e.stop()}},e)}))),it("should assign correct instruments to tracks",_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,transcribeMidi(mockMidi);case 2:expect(i).toHaveBeenCalled(),t=i.mock.calls[0][0],r=t.filter(function(e){return Array.isArray(e[1])&&"settimbre"===e[1][0]}),n=mockMidi.tracks.filter(function(e){return!e.instrument.percussion}),r.forEach(function(e,t){var r=n[t].instrument.name;expect(e[1][1].value).toBe(r)});case 7:case"end":return e.stop()}},e)}))),it("should generate correct note durations",_asyncToGenerator(regeneratorRuntime.mark(function e(){var o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,transcribeMidi(mockMidi);case 2:expect(i).toHaveBeenCalled(),o=i.mock.calls[0][0],o.filter(function(e){return Array.isArray(e[1])&&"newnote"===e[1][0]}).forEach(function(t){var r=o.find(function(e){return e[0]===t[4][1]});expect(r).toBeDefined();var e=o.find(function(e){return e[0]===r[4][1]}),n=o.find(function(e){return e[0]===r[4][2]});expect(e).toBeDefined(),expect(n).toBeDefined(),expect(e[1][1].value).toBeGreaterThan(0),expect(n[1][1].value).toBeGreaterThan(0)});case 6:case"end":return e.stop()}},e)}))),it("should generate rest notes for gaps between notes",_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,transcribeMidi(mockMidi);case 2:expect(i).toHaveBeenCalled(),t=i.mock.calls[0][0],r=t.filter(function(e){return"rest2"===e[1]}),expect(r.length).toBeGreaterThan(0);case 6:case"end":return e.stop()}},e)})))});