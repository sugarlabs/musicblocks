"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,_toPropertyKey(o.key),o)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0===n)return("string"===t?String:Number)(e);var o=n.call(e,t||"default");if("object"!=_typeof(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}function asyncGeneratorStep(e,t,n,o,a,c,r){try{var i=e[c](r),l=i.value}catch(e){return void n(e)}i.done?t(l):Promise.resolve(l).then(o,a)}function _asyncToGenerator(i){return function(){var e=this,r=arguments;return new Promise(function(t,n){var o=i.apply(e,r);function a(e){asyncGeneratorStep(o,t,n,a,c,"next",e)}function c(e){asyncGeneratorStep(o,t,n,a,c,"throw",e)}a(void 0)})}}var PlanetInterface=require("../planetInterface");global.platformColor={header:"#8bc34a"},global._THIS_IS_MUSIC_BLOCKS_={},global.doSVG=jest.fn();var mockActivity={hideSearchWidget:jest.fn(),prepSearchWidget:jest.fn(),sendAllToTrash:jest.fn(),refreshCanvas:jest.fn(),_loadStart:jest.fn(),doLoadAnimation:jest.fn(),textMsg:jest.fn(),stage:{enableDOMEvents:jest.fn(),update:jest.fn()},blocks:{loadNewBlocks:jest.fn(),palettes:{_hideMenus:jest.fn()},trashStacks:[]},logo:{doStopTurtles:jest.fn()},canvas:{},turtles:{},loading:!1,prepareExport:jest.fn(),_allClear:jest.fn()};document.body.innerHTML='\n  <div id="helpElem"></div>\n  <div class="canvasHolder"></div>\n  <div id="canvas"></div>\n  <meta id="theme-color">\n  <div id="toolbars"></div>\n  <div id="palette"></div>\n  <div id="buttoncontainerBOTTOM"></div>\n  <div id="buttoncontainerTOP"></div>\n  <canvas id="overlayCanvas"></canvas>\n  <iframe id="planet-iframe"></iframe>\n  <input id="myOpenFile" type="file">\n';var docById=jest.fn(function(e){return document.getElementById(e)});global.docById=docById,beforeAll(function(){mockCanvas={click:jest.fn()},window.widgetWindows={hideAllWindows:jest.fn(),showWindows:jest.fn()},window.scroll=jest.fn()}),describe("PlanetInterface",function(){var a;beforeEach(function(){a=new PlanetInterface(mockActivity)}),test("hideMusicBlocks hides relevant elements and disables DOM events",function(){a.hideMusicBlocks(),expect(mockActivity.hideSearchWidget).toHaveBeenCalled(),expect(mockActivity.logo.doStopTurtles).toHaveBeenCalled(),expect(docById("helpElem").style.visibility).toBe("hidden"),expect(document.querySelector(".canvasHolder").classList.contains("hide")).toBe(!0),expect(document.querySelector("#canvas").style.display).toBe("none"),expect(document.querySelector("#theme-color").content).toBe("#8bc34a")}),test("showMusicBlocks shows relevant elements and enables DOM events",function(){mockActivity.planet={getCurrentProjectName:jest.fn(function(){return"Test Project"})},a.showMusicBlocks(),expect(document.title).toBe("Test Project"),expect(docById("toolbars").style.display).toBe("block"),expect(docById("palette").style.display).toBe("block"),expect(mockActivity.prepSearchWidget).toHaveBeenCalled(),expect(document.querySelector(".canvasHolder").classList.contains("hide")).toBe(!1),expect(document.querySelector("#canvas").style.display).toBe("")}),test("hidePlanet hides the planet interface",function(){a.iframe=document.querySelector("#planet-iframe"),a.hidePlanet(),expect(a.iframe.style.display).toBe("none")}),test("openPlanet calls saveLocally, hideMusicBlocks, and showPlanet",function(){jest.spyOn(a,"saveLocally").mockImplementation(function(){}),jest.spyOn(a,"hideMusicBlocks").mockImplementation(function(){}),jest.spyOn(a,"showPlanet").mockImplementation(function(){}),a.openPlanet(),expect(a.saveLocally).toHaveBeenCalled(),expect(a.hideMusicBlocks).toHaveBeenCalled(),expect(a.showPlanet).toHaveBeenCalled()}),test("closePlanet calls hidePlanet and showMusicBlocks",function(){jest.spyOn(a,"hidePlanet").mockImplementation(function(){}),jest.spyOn(a,"showMusicBlocks").mockImplementation(function(){}),a.closePlanet(),expect(a.hidePlanet).toHaveBeenCalled(),expect(a.showMusicBlocks).toHaveBeenCalled()}),test("newProject calls closePlanet, initialiseNewProject, _loadStart, and saveLocally",function(){jest.spyOn(a,"closePlanet").mockImplementation(function(){}),jest.spyOn(a,"initialiseNewProject").mockImplementation(function(){}),jest.spyOn(a,"saveLocally").mockImplementation(function(){}),a.newProject(),expect(a.closePlanet).toHaveBeenCalled(),expect(a.initialiseNewProject).toHaveBeenCalled(),expect(mockActivity._loadStart).toHaveBeenCalled(),expect(a.saveLocally).toHaveBeenCalled()}),test("onConverterLoad sets window.Converter",function(){a.planet={Converter:"mockConverter"},a.onConverterLoad(),expect(window.Converter).toBe("mockConverter")}),test("getCurrentProjectName returns name from ProjectStorage",function(){a.planet={ProjectStorage:{getCurrentProjectName:jest.fn(function(){return"ProjectX"})}},expect(a.getCurrentProjectName()).toBe("ProjectX")}),test("initialiseNewProject should reset project state",function(){a.planet={ProjectStorage:{initialiseNewProject:jest.fn()}},a.initialiseNewProject("New Name"),expect(a.planet.ProjectStorage.initialiseNewProject).toHaveBeenCalledWith("New Name"),expect(mockActivity.sendAllToTrash).toHaveBeenCalled(),expect(mockActivity.refreshCanvas).toHaveBeenCalled(),expect(mockActivity.blocks.trashStacks).toEqual([])}),test("loadProjectFromData: default merge=false",function(){a.iframe={style:{display:"block"}},mockActivity.blocks.loadNewBlocks.mockClear(),a.getCurrentProjectName=jest.fn(function(){return"foo"}),a.loadProjectFromData(JSON.stringify({whatever:1})),expect(mockActivity.sendAllToTrash).toHaveBeenCalledWith(!1,!0),expect(mockActivity.textMsg).toHaveBeenCalledWith("foo"),expect(mockActivity.loading).toBe(!1),expect(mockActivity.blocks.loadNewBlocks).toHaveBeenCalledWith({whatever:1}),expect(document.body.style.cursor).toBe("default")}),test("loadProjectFromFile focuses, clicks, scrolls",function(){var e=document.getElementById("myOpenFile");e.focus=jest.fn(),e.click=jest.fn(),a.loadProjectFromFile(),expect(e.focus).toHaveBeenCalled(),expect(e.click).toHaveBeenCalled(),expect(window.scroll).toHaveBeenCalledWith(0,0)}),test("saveLocally: svgData empty → saveLocally(data, null)",function(){doSVG.mockReturnValue("");var e={x:1};mockActivity.prepareExport.mockReturnValue(e),a.planet={ProjectStorage:{saveLocally:jest.fn()}},a.saveLocally(),expect(a.planet.ProjectStorage.saveLocally).toHaveBeenCalledWith(e,null)}),test("getCurrentProjectDescription/Image/TimeLastSaved",function(){var e=new Date(2020,1,1);a.planet={ProjectStorage:{getCurrentProjectDescription:function(){return"desc"},getCurrentProjectImage:function(){return"img.png"},TimeLastSaved:e}},expect(a.getCurrentProjectDescription()).toBe("desc"),expect(a.getCurrentProjectImage()).toBe("img.png"),expect(a.getTimeLastSaved()).toBe(e)}),test("openCurrentProject returns promise data",_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a.planet={ProjectStorage:{getCurrentProjectData:jest.fn(_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",123);case 1:case"end":return e.stop()}},e)})))}},e.next=3,expect(a.openCurrentProject()).resolves.toBe(123);case 3:case"end":return e.stop()}},e)}))),test("openProjectFromPlanet proxies arguments",function(){a.planet={openProjectFromPlanet:jest.fn()},a.openProjectFromPlanet("ID42","oops"),expect(a.planet.openProjectFromPlanet).toHaveBeenCalledWith("ID42","oops")}),test("hideMusicBlocks also calls widgetWindows.hideAllWindows and disables DOM events after 250ms",function(){jest.useFakeTimers(),a.hideMusicBlocks(),expect(window.widgetWindows.hideAllWindows).toHaveBeenCalled(),expect(mockActivity.stage.enableDOMEvents).not.toHaveBeenCalledWith(!1),jest.advanceTimersByTime(250),expect(mockActivity.stage.enableDOMEvents).toHaveBeenCalledWith(!1),jest.useRealTimers()}),test("init(): success wires up planet, Converter, handlers, and mainCanvas",_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return global._THIS_IS_MUSIC_BLOCKS_={},t=document.getElementById("planet-iframe"),n=t.contentWindow,o={Converter:"CONV",setLoadProjectFromData:jest.fn(),setPlanetClose:jest.fn(),setLoadNewProject:jest.fn(),setLoadProjectFromFile:jest.fn(),setOnConverterLoad:jest.fn()},n.makePlanet=jest.fn(_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},e)}))),n.p=o,e.next=8,a.init();case 8:expect(a.planet).toBe(o),expect(o.setLoadProjectFromData).toHaveBeenCalledWith(expect.any(Function)),expect(o.setPlanetClose).toHaveBeenCalledWith(expect.any(Function)),expect(o.setLoadNewProject).toHaveBeenCalledWith(expect.any(Function)),expect(o.setLoadProjectFromFile).toHaveBeenCalledWith(expect.any(Function)),expect(o.setOnConverterLoad).toHaveBeenCalledWith(expect.any(Function)),expect(window.Converter).toBe("CONV"),expect(a.mainCanvas).toBe(mockActivity.canvas);case 16:case"end":return e.stop()}},e)}))),test("showPlanet: catch block when local-tab missing",function(){document.getElementById("overlayCanvas").toDataURL=function(){return"PNG"},a.planet={open:jest.fn()},a.iframe=document.getElementById("planet-iframe"),a.iframe.contentWindow={document:{getElementById:function(){return null}}},console.error=jest.fn(),a.showPlanet(),expect(console.error).toHaveBeenCalled()}),test("saveLocally: non-empty SVG triggers image‑onload path",function(e){doSVG.mockReturnValue("<svg/>"),mockActivity.prepareExport.mockReturnValue("EXPORT"),global.base64Encode=jest.fn(function(e){return e}),a.planet={ProjectStorage:{saveLocally:jest.fn()}},global.Image=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"src",set:function(){this.onload()}}]),e}(),global.createjs={Bitmap:function(){function t(e){_classCallCheck(this,t)}return _createClass(t,[{key:"getBounds",value:function(){return{x:0,y:0,width:1,height:1}}},{key:"cache",value:function(){this.bitmapCache={getCacheDataURL:function(){return"DATAURL"}}}}]),t}()},a.saveLocally(),setTimeout(function(){expect(a.planet.ProjectStorage.saveLocally).toHaveBeenCalledWith("EXPORT","DATAURL"),e()},0)})});