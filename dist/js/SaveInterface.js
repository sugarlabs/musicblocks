"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var o={}.toString.call(t).slice(8,-1);return"Object"===o&&t.constructor&&(o=t.constructor.name),"Map"===o||"Set"===o?Array.from(t):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var o=0,n=Array(e);o<e;o++)n[o]=t[o];return n}function _iterableToArrayLimit(t,e){var o=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=o){var n,a,i,r,l=[],c=!0,d=!1;try{if(i=(o=o.call(t)).next,0===e){if(Object(o)!==o)return;c=!1}else for(;!(c=(n=i.call(o)).done)&&(l.push(n.value),l.length!==e);c=!0);}catch(t){d=!0,a=t}finally{try{if(!c&&null!=o.return&&(r=o.return(),Object(r)!==r))return}finally{if(d)throw a}}return l}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var o=0;o<e.length;o++){var n=e[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,_toPropertyKey(n.key),n)}}function _createClass(t,e,o){return e&&_defineProperties(t.prototype,e),o&&_defineProperties(t,o),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(t,e){if("object"!=_typeof(t)||!t)return t;var o=t[Symbol.toPrimitive];if(void 0===o)return("string"===e?String:Number)(t);var n=o.call(t,e||"default");if("object"!=_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}var SaveInterface=function(){function e(t){var o=this;_classCallCheck(this,e),this.activity=t,this.filename=null,this.notationConvert="",this.timeLastSaved=-100,this.htmlSaveTemplate='<!DOCTYPE html><html lang="en"><head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="description" content="{{ project_description }}"> <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0"> <title>{{ project_name }}</title> <meta property="og:site_name" content="Music Blocks"/> <meta property="og:type" content="website"/> <meta property="og:title" content="'+_("Music Blocks Project")+' - {{ project_name }}"/> <meta property="og:description" content="{{ project_description }}"/> <style>body{background-color: #dbf0fb;}#main{background-color: white; padding: 5%; position: fixed; width: 80vw; height: max-content; margin: auto; top: 0; left: 0; bottom: 0; right: 0; display: flex; flex-direction: column; justify-content: center; text-align: center; color: #424242; box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23); font-family: "Roboto", "Helvetica","Arial",sans-serif;}h3{font-weight: 400; font-size: 36px; margin-top: 10px;}hr{border-top: 0px solid #ccc; margin: 1em;}.btn {display: inline-block; margin-left: 10px; cursor: pointer; font-size: 14px; border-radius: 12px; border: 1px solid #1678ad; padding: 3px 5px; line-height: 20px; color: #181818;}.btn:hover {transition: 0.4s; -webkit-transition: 0.3s; -moz-transition: 0.3s; background-color: #3eb7e7;}.code{word-break: break-all; height: 15vh; background: #f6f8fa; color: #494949; text-align: justify; margin-right: 10vw; margin-left: 10vw; padding: 16px; overflow: auto; line-height: 1.45; background-color: #f6f8fa; border-radius: 3px; font-family: "SFMono-Regular",Consolas,"Liberation Mono",Menlo,Courier,monospace;}.image{border-radius: 2px 2px 0 0; position: relative; background-color: #96D3F3;}.image-div{margin-bottom: 10px;}.moreinfo-div{margin-top: 20px;}h4{font-weight: 500; font-size: 1.4em; margin-top: 10px; margin-bottom: 10px;}.tbcode{margin-bottom: 10px;}</style></head><body> <div id="main"> <div class="image-div"><img class="image" id="project-image" src="{{ project_image }}"></div><h3 id="title">'+_("Music Blocks Project")+' - {{ project_name }}</h3> <p>{{ project_description }}</p><hr> <div> <div style="color: #9E9E9E"><p>'+_("This project was created in Music Blocks")+' (<a href="https://musicblocks.sugarlabs.org" target="_blank">https://musicblocks.sugarlabs.org</a>). '+TITLESTRING+" "+_("Music Blocks is a Free/Libre Software application.")+" "+_("The source code can be accessed at")+' <a href="https://github.com/sugarlabs/musicblocks" target="_blank">https://github.com/sugarlabs/musicblocks</a>. '+_("For more information, please consult the")+' <a href="'+GUIDEURL+'" target="_blank">'+_("Music Blocks Guide")+"</a>.</p><p>"+_("To run this project, open Music Blocks in a web browser and drag and drop this file into the browser window.")+" "+_("Alternatively, open the file in Music Blocks using the Load project button.")+'</p></div><div class="moreinfo-div"> <div class="tbcode"><h4>'+_("Project Code")+"</h4>"+_("This code stores data about the blocks in a project.")+'<a href="javascript:toggle();" id="showhide">'+_("Show")+'</a><button class="btn" onclick="copyCode()" style="margin-left: 10px;">'+_("Copy to Clipboard")+'</button></div> <div class="code" id="codeBlock">{{ data }}</div></div></div></div><script type="text/javascript">function toggle() {  var codeBlock = document.getElementsByClassName("code")[0];  var showHideButton = document.getElementById("showhide");  if (codeBlock.style.display === "none") {    codeBlock.style.display = "flex";    showHideButton.textContent = "'+_("Hide")+'";  } else {    codeBlock.style.display = "none";    showHideButton.textContent = "'+_("Show")+'";  }}window.onload = function() {  var codeBlock = document.getElementById("codeBlock");  var showHideButton = document.getElementById("showhide");  codeBlock.style.display = "none";  showHideButton.textContent = "'+_("Show")+'";};function copyCode() {  var text = document.getElementById("codeBlock").innerText;  navigator.clipboard.writeText(text).then(function() {    alert("'+_("Project code copied to clipboard!")+'");  }).catch(function() {    alert("'+_("Failed to copy.")+'");  });}<\/script>',this.timeLastSaved=-100;var n=jQuery.noConflict();n(window).on("beforeunload",function(t){var e="#saveButtonAdvanced";if(o.activity.beginnerMode&&(e="#saveButton"),void 0!==o.PlanetInterface&&o.PlanetInterface.getTimeLastSaved()!==o.timeLastSaved)return t.preventDefault(),n(e).trigger("mouseenter"),""})}return _createClass(e,[{key:"download",value:function(t,e,o){var n=null,n=null==o?(o=void 0===this.activity.PlanetInterface?_("My Project"):this.activity.PlanetInterface.getCurrentProjectName(),fileExt(o)!=t&&(o+="."+t),1==window.isElectron?o:prompt("Filename:",o)):(fileExt(o)!=t&&(o+="."+t),o);console.debug("saving to "+n),null!==n?(fileExt(n)!=t&&(n+="."+t),this.downloadURL(n,e)):console.debug("save cancelled")}},{key:"downloadURL",value:function(t,e){var o=document.createElement("a");o.setAttribute("href",e),o.setAttribute("download",t),document.body.appendChild(o),o.click(),document.body.removeChild(o)}},{key:"prepareHTML",value:function(){var t=this.htmlSaveTemplate,e=_("No description provided");void 0!==this.activity.PlanetInterface&&(e=this.activity.PlanetInterface.getCurrentProjectDescription());var o=_("My Project");void 0!==this.activity.PlanetInterface&&(o=this.activity.PlanetInterface.getCurrentProjectName());var n=this.activity.prepareExport(),a="";return void 0!==this.activity.PlanetInterface&&(a=this.activity.PlanetInterface.getCurrentProjectImage()),t=t.replace(new RegExp("{{ project_description }}","g"),e).replace(new RegExp("{{ project_name }}","g"),o).replace(new RegExp("{{ data }}","g"),n).replace(new RegExp("{{ project_image }}","g"),a)}},{key:"saveHTML",value:function(t){var e="data:text/plain;charset=utf-8,"+encodeURIComponent(t.save.prepareHTML());t.save.download("html",e,null)}},{key:"saveHTMLNoPrompt",value:function(e){setTimeout(function(){var t="data:text/plain;charset=utf-8,"+encodeURIComponent(e.save.prepareHTML());void 0!==e.PlanetInterface?e.save.downloadURL(e.PlanetInterface.getCurrentProjectName()+".html",t):e.save.downloadURL(_("My Project").replace(" ","_")+".html",t)},500)}},{key:"saveMIDI",value:function(t){t.logo.runningMIDI=!0,t.logo.runLogoCommands(),document.body.style.cursor="wait"}},{key:"afterSaveMIDI",value:function(){var v=getMidiInstrument(),m=getMidiDrum(),t=activity.logo._midiData;setTimeout(function(){!function(t){var y=new Midi;y.header.ticksPerBeat=480,Object.entries(t).forEach(function(t){var e=_slicedToArray(t,2),u=e[0],o=e[1];y.addTrack().name="Track ".concat(parseInt(u)+1);var s=new Map,p=0;o.forEach(function(t){var e,o,n,a,i,r,l,c,d;t.note&&0!==t.note.length&&(e=1/t.duration*60*4/t.bpm,o=t.instrument||"default",t.drum?(n=t.drum||!1,s.has(n)||((a=y.addTrack()).name="Track ".concat(parseInt(u)+1," - ").concat(n),a.channel=9,s.set(n,a)),i=s.get(n),r=m[n]||36,i.addNote({midi:r,time:p,duration:e,velocity:.9})):(s.has(o)||((c=y.addTrack()).name="Track ".concat(parseInt(u)+1," - ").concat(o),c.instrument.number=null!==(l=v[o])&&void 0!==l?l:v.default,s.set(o,c)),d=s.get(o),t.note.forEach(function(t){t.includes("R")||d.addNote({name:t.replace("♯","#").replace("♭","b"),time:p,duration:e,velocity:.8})})),p+=e)}),p=0});var e=y.toArray(),o=new Blob([e],{type:"audio/midi"}),n=URL.createObjectURL(o);activity.save.download("midi",n,null)}(t),activity.logo._midiData={},document.body.style.cursor="default"},500)}},{key:"saveSVG",value:function(t){var e="data:image/svg+xml;utf8,"+doSVG(t.canvas,t.logo,t.turtles,t.canvas.width,t.canvas.height,1);t.save.download("svg",e,null)}},{key:"savePNG",value:function(t){var e=docById("overlayCanvas").toDataURL("image/png");t.save.download("png",e,null)}},{key:"saveBlockArtwork",value:function(t){var e="data:image/svg+xml;utf8,"+t.printBlockSVG();t.save.download("svg",e,null)}},{key:"saveBlockArtworkPNG",value:function(e){e.printBlockPNG().then(function(t){e.save.download("png",t,null)})}},{key:"saveWAV",value:function(t){document.body.style.cursor="wait",t.logo.recording=!0,t.logo.synth.setupRecorder(),t.logo.synth.recorder.start(),t.logo.runLogoCommands(),t.textMsg(_("Your recording is in progress."))}},{key:"saveAbc",value:function(t){document.body.style.cursor="wait",t.logo.runningAbc=!0,t.logo.notationOutput=ABCHEADER,t.logo.notationNotes={};for(var e=0;e<t.turtles.getTurtleCount();e++)t.logo.notation.notationStaging[e]=[],t.logo.notation.notationDrumStaging[e]=[],t.turtles.getTurtle(e).painter.doClear(!0,!0,!0);t.logo.runLogoCommands()}},{key:"afterSaveAbc",value:function(){var t=encodeURIComponent(saveAbcOutput(this.activity));this.activity.save.download("abc","data:text;utf8,"+t,null)}},{key:"saveLilypond",value:function(t){var e=_("My Project");void 0!==t.PlanetInterface&&(e=t.PlanetInterface.getCurrentProjectName()),"ly"!=fileExt(e)&&(e+=".ly"),docById("lilypondModal").style.display="block",docById("fileNameText").textContent=_("File name"),docById("titleText").textContent=_("Project title"),docById("authorText").textContent=_("Project author"),docById("MIDIText").textContent=_("Include MIDI output?"),docById("guitarText").textContent=_("Include guitar tablature output?"),docById("submitLilypond").textContent=_("Save as Lilypond"),docById("fileName").value=e,void 0!==t.PlanetInterface?docById("title").value=t.PlanetInterface.getCurrentProjectName():docById("title").value=_("My Project");var o=t.storage.getItem("customAuthor");docById("author").value=null!=o?JSON.parse(o):_("Mr. Mouse"),docById("submitLilypond").onclick=function(){t.save.saveLYFile(!1)},docByClass("close")[0].onclick=function(){t.logo.runningLilypond=!1,docById("lilypondModal").style.display="none"}}},{key:"saveLYFile",value:function(t){void 0===t&&(t=!1);var e=docById("fileName").value,o=docById("title").value,n=docById("author").value;this.activity.storage.setItem("customAuthor",JSON.stringify(n));var a=docById("MIDICheck").checked,i=docById("guitarCheck").checked;null!=e&&"ly"!==fileExt(e)&&(e+=".ly");var r={"My Music Blocks Creation":o,"Mr. Mouse":n},l=LILYPONDHEADER.replace(/My Music Blocks Creation|Mr. Mouse/gi,function(t){return r[t]});this.activity.logo.MIDIOutput=a?"% MIDI SECTION\n% MIDI Output included! \n\n\\midi {\n   \\tempo 4=90\n}\n\n\n}\n\n":"% MIDI SECTION\n% Delete the %{ and %} below to include MIDI output.\n%{\n\\midi {\n   \\tempo 4=90\n}\n%}\n\n}\n\n",i?(this.activity.logo.guitarOutputHead='\n\n% GUITAR TAB SECTION\n% Guitar tablature output included!\n\n      \\new TabStaff = "guitar tab" \n      <<\n         \\clef moderntab\n',this.activity.logo.guitarOutputEnd="      >>\n\n"):(this.activity.logo.guitarOutputHead='\n\n% GUITAR TAB SECTION\n% Delete the %{ and %} below to include guitar tablature output.\n%{\n      \\new TabStaff = "guitar tab" \n      <<\n         \\clef moderntab\n',this.activity.logo.guitarOutputEnd="      >>\n%}\n"),this.activity.logo.runningLilypond=!0,this.notationConvert=t?"pdf":"",this.activity.logo.notationOutput=l,this.activity.logo.notationNotes={};for(var c=0;c<this.activity.turtles.getTurtleCount();c++)this.activity.logo.notation.notationStaging[c]=[],this.activity.logo.notation.notationDrumStaging[c]=[],this.activity.turtles.getTurtle(c).painter.doClear(!0,!0,!0);document.body.style.cursor="wait",this.activity.logo.runLogoCommands(),docById("lilypondModal").style.display="none"}},{key:"afterSaveLilypond",value:function(t){t=docById("fileName").value;var e=saveLilypondOutput(this.activity);switch(this.notationConvert){case"pdf":this.afterSaveLilypondPDF(e,t);break;default:this.afterSaveLilypondLY(e,t)}this.notationConvert=""}},{key:"afterSaveLilypondLY",value:function(t,e){var o;e=docById("fileName").value,platform.FF?console.debug('execCommand("copy") does not work on FireFox'):((o=jQuery("<textarea />").appendTo(document.body)).val(t),o.select(),o[0].setSelectionRange(0,t.length),document.execCommand("copy"),o.remove(),this.activity.textMsg(_("The Lilypond code is copied to clipboard. You can paste it here: ")+"<a href='http://hacklily.org' target='_blank'>http://hacklily.org</a> ")),this.download("ly","data:text;utf8,"+encodeURIComponent(t),e)}},{key:"afterSaveLilypondPDF",value:function(t,o){var n=this;document.body.style.cursor="wait",window.Converter.ly2pdf(t,function(t,e){document.body.style.cursor="default",t?n.activity.save.download("pdf",e,o):console.debug("Error: "+e)})}},{key:"saveMxml",value:function(){this.activity.logo.runningMxml=!0;for(var t=0;t<this.activity.turtles.getTurtleCount();t++)this.activity.logo.notation.notationStaging[t]=[],this.activity.logo.notation.notationDrumStaging[t]=[],this.activity.turtles.getTurtle(t).painter.doClear(!0,!0,!0);this.activity.logo.runLogoCommands()}},{key:"afterSaveMxml",value:function(t){var e=saveMxmlOutput(this.activity.logo);this.download("xml","data:text;utf8,"+encodeURIComponent(e),t),this.activity.logo.runningMxml=!1}}]),e}();"undefined"!=typeof module&&module.exports&&(module.exports={SaveInterface:SaveInterface});