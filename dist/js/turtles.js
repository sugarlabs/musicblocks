"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,_toPropertyKey(i.key),i)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0===n)return("string"===t?String:Number)(e);var i=n.call(e,t||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}var CONTAINERSCALEFACTOR=4,Turtles=function(){function t(e){_classCallCheck(this,t),importMembers(this,"",[e]),this.initActions()}return _createClass(t,[{key:"initActions",value:function(){setupRhythmActions(this.activity),setupMeterActions(this.activity),setupPitchActions(this.activity),setupIntervalsActions(this.activity),setupToneActions(this.activity),setupOrnamentActions(this.activity),setupVolumeActions(this.activity),setupDrumActions(this.activity),setupDictActions(this.activity)}},{key:"addTurtle",value:function(e,t){var n;this.add(e,t),this.isShrunk()&&((n=this.getTurtle(this.getTurtleCount()-1)).container.scaleX=CONTAINERSCALEFACTOR,n.container.scaleY=CONTAINERSCALEFACTOR,n.container.scale=CONTAINERSCALEFACTOR)}},{key:"add",value:function(e,t){var a=this;null!==e&&e.value!==this.getTurtleCount()&&(e.value=this.getTurtleCount());var n="object"===_typeof(t)&&0<Object.keys(t).length,i=n&&"id"in t&&t.id!==1/0?t.id:Date.now(),r=n&&"name"in t?t.name:_("start"),o=new Turtle(this.activity,i,r,this,e);this.addTurtleStageProps(o,n,t);var l=this.activity.stage,s=this.getTurtleCount()%10;if(this.pushTurtle(o),null!==e){if("start"===e.name)this.createArtwork(o,s,!0);else{for(var u=0;u<this.getTurtleCount();u++)if(this.getTurtle(u).companionTurtle===this.getTurtleCount()-1){s=u%10;break}this.createArtwork(o,s,!1)}this.createHitArea(o),o.container.on("mousedown",function(e){var t=a.scale,n=o.container.x-e.stageX/t,i=o.container.y-e.stageY/t;l.dispatchEvent("CursorDown"+o.id),o.container.removeAllEventListeners("pressmove"),o.container.on("pressmove",function(e){a.isShrunk()||o.running||(o.container.x=e.stageX/t+n,o.container.y=e.stageY/t+i,o.x=a.screenX2turtleX(o.container.x),o.y=a.screenY2turtleY(o.container.y),a.activity.refreshCanvas())})}),o.container.on("pressup",function(){l.dispatchEvent("CursorUp"+o.id)}),o.container.on("click",function(){l.dispatchEvent("click"+o.id)}),o.container.on("mouseover",function(){l.dispatchEvent("CursorOver"+o.id),o.running||(o.container.scaleX*=1.2,o.container.scaleY=o.container.scaleX,o.container.scale=o.container.scaleX,a.activity.refreshCanvas())}),o.container.on("mouseout",function(){l.dispatchEvent("CursorOut"+o.id),o.running||(o.container.scaleX/=1.2,o.container.scaleY=o.container.scaleX,o.container.scale=o.container.scaleX,a.activity.refreshCanvas())}),document.getElementById("loader").className="",this.addTurtleGraphicProps(o,n,t),this.activity.refreshCanvas()}}},{key:"markAllAsStopped",value:function(){for(var e=0;e<this.getTurtleCount();e++){this.getTurtle(e).running=!1}this.activity.refreshCanvas()}},{key:"masterStage",set:function(e){this._masterStage=e},get:function(){return this._masterStage}},{key:"stage",set:function(e){this._stage=e,this._stage.addChild(this._borderContainer)},get:function(){return this._stage}},{key:"canvas",set:function(e){this._canvas=e},get:function(){return this._canvas}},{key:"borderContainer",get:function(){return this._borderContainer}},{key:"hideMenu",set:function(e){this._hideMenu=e},get:function(){return this._hideMenu}},{key:"doClear",set:function(e){this._doClear=e},get:function(){return this._doClear}},{key:"hideGrids",set:function(e){this._hideGrids=e},get:function(){return this._hideGrids}},{key:"doGrid",set:function(e){this._doGrid=e},get:function(){return this._doGrid}},{key:"turtleList",get:function(){return this._turtleList}},{key:"scale",get:function(){return this._scale}}]),t}();Turtles.TurtlesModel=function(){function t(e){_classCallCheck(this,t),this.activity=e,this._masterStage=null,this._stage=null,this._canvas=null,this._hideMenu=null,this._doClear=null,this._hideGrids=null,this._doGrid=null,this._borderContainer=new createjs.Container,this._masterStage=this.activity.stage,this._stage=this.activity.turtleContainer,this._stage.addChild(this._borderContainer),this._canvas=this.activity.canvas,this._hideMenu=this.activity.hideAuxMenu,this._hideGrids=this.activity.hideGrids,this._doGrid=this.activity._doCartesianPolar,this._turtleList=[]}return _createClass(t,[{key:"initializeTurtleList",value:function(e){this._turtleList=e}},{key:"getTurtle",value:function(e){var t=this._turtleList[e];if(!t)throw new Error("Turtle ".concat(e," not found"));return t}},{key:"getTurtleCount",value:function(){return this._turtleList.length}},{key:"pushTurtle",value:function(e){this._turtleList.includes(e)||this._turtleList.push(e)}},{key:"getIndexOfTurtle",value:function(e){return this._turtleList.indexOf(e)}},{key:"removeTurtle",value:function(e){0<=e&&e<this._turtleList.length&&this._turtleList.splice(e,1)}},{key:"addTurtleStageProps",value:function(e,t,n){t&&("xcor"in n&&(e.x=n.xcor),"ycor"in n&&(e.y=n.ycor));var i=this._stage;e.imageContainer=new createjs.Container,i.addChild(e.imageContainer),e.penstrokes=new createjs.Bitmap,i.addChild(e.penstrokes),e.container=new createjs.Container,i.addChild(e.container),e.container.x=this.turtleX2screenX(e.x),e.container.y=this.turtleY2screenY(e.y)}},{key:"createHitArea",value:function(e){var t=new createjs.Shape;t.graphics.beginFill("#FFF").drawEllipse(-27,-27,55,55),t.x=0,t.y=0,e.container.hitArea=t}},{key:"addTurtleGraphicProps",value:function(e,t,n){setTimeout(function(){t&&("heading"in n&&e.painter.doSetHeading(n.heading),"pensize"in n&&e.painter.doSetPensize(n.pensize),"grey"in n&&e.painter.doSetChroma(n.grey),"shade"in n&&e.painter.doSetValue(n.shade),"color"in n&&e.painter.doSetColor(n.color),"name"in n&&e.rename(n.name))},2e3)}},{key:"running",value:function(){for(var e=0;e<this.getTurtleCount();e++)if(this.getTurtle(e).running)return!0;return!1}},{key:"ithTurtle",value:function(e){return this.getTurtle(e)}},{key:"companionTurtle",value:function(e){for(var t=0;t<this.getTurtleCount();t++)if(this.getTurtle(t).companionTurtle===e)return t;return e}},{key:"turtleCount",value:function(){for(var e=0,t=0;t<this.getTurtleCount();t++)this.companionTurtle(t)!==t||this.getTurtle(t).inTrash||(e+=1);return e}}]),t}(),Turtles.TurtlesView=function(){function e(){var r=this;_classCallCheck(this,e),this._scale=1,this._w=1200,this._h=900,this._isShrunk=!1,this._expandedBoundary=null,this._collapsedBoundary=null,this._expandButton=null,this._collapseButton=null,this._clearButton=null,this.gridButton=null,this.collapse=null,this.expand=null,this._backgroundColor=platformColor.background,this._locked=!1,this._queue=[],this.currentGrid=null,window.addEventListener("resize",function(){var e=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,t=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,n=Math.min(e/1200,t/900),i=Math.round(1200*n),a=Math.round(900*n);r._w=i,r._h=a})}return _createClass(e,[{key:"setStageScale",value:function(e){this.stage.scaleX=e,this.stage.scaleY=e,this.activity.refreshCanvas()}},{key:"doScale",value:function(e,t,n){this._locked?this._queue=[e,t,n]:(this._scale=n,this._w=e/n,this._h=t/n),this.makeBackground()}},{key:"isShrunk",value:function(){return this._isShrunk}},{key:"setGridLabel",value:function(e){this._gridLabel=e}},{key:"setBackgroundColor",value:function(e){var t=-1===e?platformColor.background:this.getTurtle(e).painter.canvasColor;this._backgroundColor=t,this.makeBackground(),this.activity.refreshCanvas()}},{key:"deltaY",value:function(e){this.stage.y+=e}},{key:"_invertY",value:function(e){return this.canvas.height/(2*this._scale)-e}},{key:"screenX2turtleX",value:function(e){return e-this.canvas.width/(2*this._scale)}},{key:"screenY2turtleY",value:function(e){return this._invertY(e)}},{key:"turtleX2screenX",value:function(e){return this.canvas.width/(2*this._scale)+e}},{key:"turtleY2screenY",value:function(e){return this._invertY(e)}},{key:"createArtwork",value:function(e,t,n){var i=(i=n?TURTLESVG:METRONOMESVG).replace(/fill_color/g,FILLCOLORS[t]).replace(/stroke_color/g,STROKECOLORS[t]);e.makeTurtleBitmap(i,this.activity,n),e.painter.color=10*t,e.painter.canvasColor=getMunsellColor(e.painter.color,DEFAULTVALUE,DEFAULTCHROMA)}},{key:"makeBackground",value:function(){var a=this,o=this.activity,i=this.borderContainer;i.removeAllChildren();function n(e,t,n,i){var a=document.createElement("div");a.setAttribute("id",""+t.name),a.setAttribute("class","tooltipped"),a.setAttribute("data-tooltip",t.label),a.setAttribute("data-position","bottom"),jQuery.noConflict()(".tooltipped").tooltip({html:!0,delay:100}),a.onmouseover=function(){o.loading||(document.body.style.cursor="pointer",a.style.transition="0.1s ease-out",a.style.transform="scale(1.15)")},a.onmouseout=function(){o.loading||(document.body.style.cursor="default",a.style.transition="0.15s ease-out",a.style.transform="scale(1)")};var r=new Image;return r.src="data:image/svg+xml;base64,"+window.btoa(base64Encode(e)),a.appendChild(r),a.setAttribute("style","position: absolute; right:"+(document.body.clientWidth-n)+"px;  top: "+i+"px;"),docById("buttoncontainerTOP").appendChild(a),a}function r(){a.hideMenu(),a.activity.hideGrids(),a.setStageScale(.25),a._collapsedBoundary.visible=!0,a._expandedBoundary.visible=!1,l.x=3*a._w/4-10,l.y=55+LEADING+6,a._isShrunk=!0;for(var i,e=0;e<a.getTurtleCount();e++){var t=a.getTurtle(e);t.container.scaleX=CONTAINERSCALEFACTOR,t.container.scaleY=CONTAINERSCALEFACTOR,t.container.scale=CONTAINERSCALEFACTOR}a.masterStage.removeChild(l),a.masterStage.addChild(l),l.removeAllEventListeners("pressmove"),l.removeAllEventListeners("mousedown"),l.on("mousedown",function(e){i={y:e.stageY-l.y,x:e.stageX-l.x}}),l.on("pressmove",function(e){var t=e.stageX-i.x,n=e.stageY-i.y;l.x=Math.max(0,Math.min(3*a._w/4,t)),l.y=Math.max(55,Math.min(3*a._h/4,n)),o.refreshCanvas()}),a.activity.refreshCanvas()}var l=this.stage;this.collapse=function(){var e,t=docById("aux-toolbar");"block"===t.style.display&&(e=docById("menu"),t.style.display="none",e.innerHTML="menu",docById("toggleAuxBtn").className-="blue darken-1"),a._expandButton.style.visibility="visible",a._collapseButton.style.visibility="hidden",a.gridButton.style.visibility="hidden",a.activity.helpfulWheelItems.forEach(function(e){"Expand"===e.label?e.display=!0:"Collapse"!==e.label&&"Grid"!==e.label||(e.display=!1)}),r(),"none"!==docById("helpfulWheelDiv").style.display&&(docById("helpfulWheelDiv").style.display="none",a.activity.__tick())};this.expand=function(){var e,t=docById("aux-toolbar");"block"===t.style.display&&(e=docById("menu"),t.style.display="none",e.innerHTML="menu",docById("toggleAuxBtn").className-="blue darken-1"),a.hideMenu(),a.setStageScale(1),a._expandedBoundary.visible=!0,a.gridButton.style.visibility="visible",a._collapseButton.style.visibility="visible",a._expandButton.style.visibility="hidden",a.activity.helpfulWheelItems.forEach(function(e){"Expand"===e.label?e.display=!1:"Collapse"!==e.label&&"Grid"!==e.label||(e.display=!0)}),a._collapsedBoundary.visible=!1,l.removeAllEventListeners("pressmove"),l.removeAllEventListeners("mousedown"),l.x=0,l.y=0,a._isShrunk=!1;for(var n=0;n<a.getTurtleCount();n++){var i=a.getTurtle(n);i.container.scaleX=1,i.container.scaleY=1,i.container.scale=1}a._clearButton.scaleX=1,a._clearButton.scaleY=1,a._clearButton.scale=1,a._clearButton.x=a._w-5-110,null!==a.gridButton&&(a.gridButton.scaleX=1,a.gridButton.scaleY=1,a.gridButton.scale=1,a.gridButton.x=a._w-10-165,a.gridButton.visible=!0),null!==a.currentGrid&&a.activity.turtles.doGrid(0),a.masterStage.removeChild(l),a.masterStage.addChildAt(l,0),"none"!==docById("helpfulWheelDiv").style.display&&(docById("helpfulWheelDiv").style.display="none",a.activity.__tick())};function s(){var e=!1;docById("buttoncontainerTOP")&&(jQuery.noConflict()(".tooltipped").tooltip("close"),docById("buttoncontainerTOP").parentElement.removeChild(docById("buttoncontainerTOP")),e=!0);var t=document.createElement("div");document.body.appendChild(t),t.style.display=e?"block":"none",t.setAttribute("id","buttoncontainerTOP"),a._collapseButton=n(COLLAPSEBUTTON,{name:"Collapse",label:_("Collapse")},a._w-55,70+LEADING+6),a._collapseButton.onclick=function(){var e,t=docById("aux-toolbar");"block"===t.style.display&&(e=docById("menu"),t.style.display="none",e.innerHTML="menu",docById("toggleAuxBtn").className-="blue darken-1"),a._expandButton.style.visibility="visible",a._collapseButton.style.visibility="hidden",a.activity.helpfulWheelItems.forEach(function(e){"Expand"===e.label?e.display=!0:"Collapse"!==e.label&&"Grid"!==e.label||(e.display=!1)}),r()},a._expandButton=n(EXPANDBUTTON,{name:"Expand",label:_("Expand")},a._w-55,70+LEADING+6),null!==a._expandButton&&(a._expandButton.style.visibility="hidden"),a._expandButton.onclick=function(){a.expand()},a._clearButton=n(CLEARBUTTON,{name:"Clear",label:_("Clear")},a._w-5-110,70+LEADING+6),a._clearButton.onclick=function(){a.activity._allClear()},function(){a.gridButton=n(CARTESIANBUTTON,{name:"Grid",label:_("Grid")},a._w-10-165,70+LEADING+6);var e=a;a.gridButton.onclick=function(){piemenuGrid(e.activity)}}(),jQuery.noConflict()(".tooltipped").each(function(){jQuery.noConflict()(this).tooltip({html:!0,delay:100})}),a._locked=!1}function u(){var e=new Image;e.onload=function(){null!==a._collapsedBoundary&&(a._collapsedBoundary.visible=!1),a._collapsedBoundary=new createjs.Bitmap(e),a._collapsedBoundary.x=0,a._collapsedBoundary.y=55+LEADING,i.addChild(a._collapsedBoundary),a._collapsedBoundary.visible=!1};var t=a._w-20,n=a._h-55-LEADING;e.src="data:image/svg+xml;base64,"+window.btoa(base64Encode(MBOUNDARY.replace("HEIGHT",a._h).replace("WIDTH",a._w).replace("Y",10).replace("X",10).replace("DY",n).replace("DX",t).replace("stroke_color",platformColor.ruleColor).replace("fill_color",a._backgroundColor).replace("STROKE",20))),s()}function c(){a._locked=!0;var e=new Image;e.onload=function(){null!==a._expandedBoundary&&(a._expandedBoundary.visible=!1),a._expandedBoundary=new createjs.Bitmap(e),a._expandedBoundary.x=0,a._expandedBoundary.y=55+LEADING,i.addChild(a._expandedBoundary),u()};var t=a._w-5,n=a._h-55-LEADING;e.src="data:image/svg+xml;base64,"+window.btoa(base64Encode(MBOUNDARY.replace("HEIGHT",a._h).replace("WIDTH",a._w).replace("Y",10/CONTAINERSCALEFACTOR).replace("X",10/CONTAINERSCALEFACTOR).replace("DY",n).replace("DX",t).replace("stroke_color",platformColor.ruleColor).replace("fill_color",a._backgroundColor).replace("STROKE",20/CONTAINERSCALEFACTOR)))}var e;return this._locked||c(),window.addEventListener("resize",function(){clearTimeout(e),e=setTimeout(function(){var e,t;e=window.innerWidth,t=window.innerHeight,a._w=e,a._h=t,c(),u()},150)}),this}}]),e}(),"undefined"!=typeof module&&module.exports&&(module.exports=Turtles);