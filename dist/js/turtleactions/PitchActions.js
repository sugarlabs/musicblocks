"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function _iterableToArrayLimit(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,i,o,s,l=[],a=!0,u=!1;try{if(o=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;a=!1}else for(;!(a=(n=o.call(r)).done)&&(l.push(n.value),l.length!==t);a=!0);}catch(e){u=!0,i=e}finally{try{if(!a&&null!=r.return&&(s=r.return(),Object(s)!==s))return}finally{if(u)throw i}}return l}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);var n=r.call(e,t||"default");if("object"!=_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}function setupPitchActions(y){Singer.PitchActions=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"playPitch",value:function(e,t,r,n,i){Singer.processPitch(y,e,t,r,n,i)}},{key:"stepPitch",value:function(e,t,r){var n=y.turtles.ithTurtle(t);if(y.logo.inMatrix||y.logo.inMusicKeyboard||0!==n.singer.inNoteBlock.length||(n.singer.lastNotePlayed=["G4",4]),"number"!=typeof e)return y.errorMsg(NANERRORMSG,r),void(y.logo.stopTurtle=!0);0<n.singer.justCounting.length&&null===n.singer.lastNotePlayed&&(n.singer.previousNotePlayed=["G4",4],n.singer.lastNotePlayed=["G4",4]),null===n.singer.lastNotePlayed&&(n.singer.lastNotePlayed=["G4",4]);var i,o,s,l,a=n.singer.lastNotePlayed,u=0;"number"==typeof a[0]?(s=(a=frequencyToPitch(a[0]))[0],l=a[1],u=a[2]):(s=a[0].slice(0,a[0].length-1),l=parseInt(a[0].slice(a[0].length-1,a[0].length))),n.singer.inverted&&(i=Singer.calculateInvert(y.logo,t,s,l,u),s=(o=getNote(s,l,2*i,n.singer.keySignature,n.singer.movable,null,y.errorMsg,y.logo.synth.inTemperament))[0],l=o[1]);var c=Singer.addScalarTransposition(y.logo,t,s,l,e);Singer.processPitch(y,c[0],c[1],u,t,r)}},{key:"playNthModalPitch",value:function(e,t,r,n){var i=y.turtles.ithTurtle(r),o=(e=Math.round(e))<0;e=Math.abs(e);var s=keySignatureToMode(i.singer.keySignature),l=MUSICALMODES[s[1]].length,a=Math.floor(e-1)%l+1,u=NOTESTEP[s[0].substr(0,1)]-1;s[0].substr(1)===FLAT?u--:s[0].substr(1)===SHARP&&u++,a=o?l-a:a;var c=nthDegreeToPitch(i.singer.keySignature,a),g=u;g+=NOTESFLAT.includes(c)?NOTESFLAT.indexOf(c)-u:NOTESSHARP.indexOf(c)-u;var p=(o?-1:1)*(Math.floor(e/l)+(o?u<g?1:0:g<u?1:0))+Math.floor(calcOctave(i.singer.currentOctave,t,i.singer.lastNotePlayed,c));Singer.processPitch(y,c,p,0,r,n)}},{key:"playPitchNumber",value:function(e,t,r){var n,i=y.turtles.ithTurtle(t);i.singer.inDefineMode?i.singer.defineMode.push(e):(isCustomTemperament(y.logo.synth.inTemperament)&&i.singer.scalarTransposition+i.singer.transposition!==0&&y.errorMsg(_("Scalar transpositions are equal to Semitone transpositions for custom temperament.")),n=numberToPitch(e+i.singer.pitchNumberOffset,y.logo.synth.inTemperament,y.logo.synth.startingPitch,i.singer.pitchNumberOffset),Singer.processPitch(y,n[0],n[1],0,t,r))}},{key:"playHertz",value:function(e,t,r){var n=y.turtles.ithTurtle(t),i=frequencyToPitch(e),o=i[0],s=i[1],l=i[2];Singer.processPitch(y,o,s,l,t,r),0<n.singer.inNoteBlock.length&&y.logo.runningLilypond&&y.logo.notation.notationMarkup(t,e)}},{key:"setAccidental",value:function(e,t,r){var n,i=ACCIDENTALNAMES.indexOf(e);if(-1===i)switch(e){case _("sharp"):return void(n=1);case _("flat"):return void(n=-1);default:return void(n=0)}else n=ACCIDENTALVALUES[i];var o=y.turtles.ithTurtle(t);o.singer.transposition+=0<o.singer.invertList.length?-n:n;var s,l="_accidental_"+t+"_"+r;void 0!==r&&r in y.blocks.blockList?y.logo.setDispatchBlock(r,t,l):!MusicBlocks.isRun||null!==(s=Mouse.getMouseFromTurtle(o))&&s.MB.listeners.push(l);y.logo.setTurtleListener(t,l,function(){o.singer.transposition+=0<o.singer.invertList.length?n:-n})}},{key:"setScalarTranspose",value:function(e,t,r){var n=y.turtles.ithTurtle(t);n.singer.scalarTransposition+=0<n.singer.invertList.length?-e:e,n.singer.scalarTranspositionValues.push(e);var i,o="_scalar_transposition_"+t;void 0!==r&&r in y.blocks.blockList?y.logo.setDispatchBlock(r,t,o):!MusicBlocks.isRun||null!==(i=Mouse.getMouseFromTurtle(n))&&i.MB.listeners.push(o);y.logo.setTurtleListener(t,o,function(){e=n.singer.scalarTranspositionValues.pop(),n.singer.scalarTransposition+=0<n.singer.invertList.length?e:-e})}},{key:"setSemitoneTranspose",value:function(e,t,r){var n=y.turtles.ithTurtle(t);n.singer.transposition+=0<n.singer.invertList.length?-e:e,n.singer.transpositionValues.push(e);var i,o="_transposition_"+t;void 0!==r&&r in y.blocks.blockList?y.logo.setDispatchBlock(r,t,o):!MusicBlocks.isRun||null!==(i=Mouse.getMouseFromTurtle(n))&&i.MB.listeners.push(o);y.logo.setTurtleListener(t,o,function(){e=n.singer.transpositionValues.pop(),n.singer.transposition+=0<n.singer.invertList.length?e:-e})}},{key:"setRatioTranspose",value:function(e,t,r){var n=y.turtles.ithTurtle(t);n.singer.transpositionRatios.push(e);var i,o="_transposition_ratio_"+t;void 0!==r&&r in y.blocks.blockList?y.logo.setDispatchBlock(r,t,o):!MusicBlocks.isRun||null!==(i=Mouse.getMouseFromTurtle(n))&&i.MB.listeners.push(o);y.logo.setTurtleListener(t,o,function(){n.singer.transpositionRatios.pop()})}},{key:"setRegister",value:function(e,t){y.turtles.ithTurtle(t).singer.register=Math.floor(e)}},{key:"invert",value:function(e,t,r,n,i){"number"==typeof r&&(r=r%2==0?"even":"odd"),r===_("even")?r="even":r===_("odd")?r="odd":r===_("scalar")&&(r="scalar");var o,s=y.turtles.ithTurtle(n);"even"!==r&&"odd"!==r&&"scalar"!==r||(o=calcOctave(s.singer.currentOctave,t,s.singer.lastNotePlayed,e),s.singer.invertList.push([e,o,r]));var l,a="_invert_"+n;void 0!==i&&i in y.blocks.blockList?y.logo.setDispatchBlock(i,n,a):!MusicBlocks.isRun||null!==(l=Mouse.getMouseFromTurtle(s))&&l.MB.listeners.push(a);y.logo.setTurtleListener(n,a,function(){s.singer.invertList.pop(),s.singer.inverted=!1})}},{key:"numToPitch",value:function(e,t,r){if(null===e||"number"!=typeof e)throw"NoArgError";var n=numberToPitch(Math.floor(e)+y.turtles.ithTurtle(r).singer.pitchNumberOffset);return"pitch"===t?n[0]:n[1]}},{key:"setPitchNumberOffset",value:function(e,t,r){var n=y.turtles.ithTurtle(r),i=Math.floor(calcOctave(n.singer.currentOctave,t,n.singer.lastNotePlayed,e));n.singer.pitchNumberOffset=pitchToNumber(e,i,n.singer.keySignature)}},{key:"deltaPitch",value:function(e,t){var n=y.turtles.ithTurtle(t);if(null==n.singer.previousNotePlayed)return 0;var r=n.singer.previousNotePlayed[0].length,i=n.singer.previousNotePlayed[0].slice(0,r-1),o=parseInt(n.singer.previousNotePlayed[0].slice(r-1)),s=[i,o],l=pitchToNumber(s[0],s[1],n.singer.keySignature),r=n.singer.lastNotePlayed[0].length,i=n.singer.lastNotePlayed[0].slice(0,r-1),o=parseInt(n.singer.lastNotePlayed[0].slice(r-1)),s=[i,o],a=pitchToNumber(s[0],s[1],n.singer.keySignature)-l;if("deltapitch"===e)return a;function u(e){var t=("up"===e?getStepSizeUp:getStepSizeDown)(n.singer.keySignature,i,0,"equal");a-=t,c+="up"===e?1:-1;var r=_slicedToArray(getNote(i,o,t,n.singer.keySignature,n.singer.movable,null,y.errorMsg,y.logo.synth.inTemperament),2);i=r[0],o=r[1]}var c=0;if(0<a)for(;0<a;)u("up");else for(;a<0;)u("down");return c}},{key:"consonantStepSize",value:function(e,t){var r=y.turtles.ithTurtle(t);if(null===r.singer.lastNotePlayed)return("up"===e?getStepSizeUp:getStepSizeDown)(r.singer.keySignature,"G");var n=r.singer.lastNotePlayed[0].length;return("up"===e?getStepSizeUp:getStepSizeDown)(r.singer.keySignature,r.singer.lastNotePlayed[0].slice(0,n-1))}}]),e}()}"undefined"!=typeof module&&module.exports&&(module.exports=setupPitchActions);