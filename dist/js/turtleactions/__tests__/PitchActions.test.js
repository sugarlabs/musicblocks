"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _defineProperty(e,t,n){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0===n)return("string"===t?String:Number)(e);var i=n.call(e,t||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}global.TextEncoder=require("util").TextEncoder,global.TextDecoder=require("util").TextDecoder;var utils=require("../../utils/utils.js");global._=utils._,global.last=utils.last;var musicUtils=require("../../utils/musicutils");Object.assign(global,{pitchToNumber:musicUtils.pitchToNumber,getStepSizeUp:musicUtils.getStepSizeUp,getStepSizeDown:musicUtils.getStepSizeDown,calcOctave:musicUtils.calcOctave,getNote:musicUtils.getNote,nthDegreeToPitch:musicUtils.nthDegreeToPitch,keySignatureToMode:musicUtils.keySignatureToMode,frequencyToPitch:musicUtils.frequencyToPitch,numberToPitch:musicUtils.numberToPitch,isCustomTemperament:musicUtils.isCustomTemperament,ACCIDENTALNAMES:musicUtils.ACCIDENTALNAMES,ACCIDENTALVALUES:musicUtils.ACCIDENTALVALUES,NOTESFLAT:musicUtils.NOTESFLAT,NOTESSHARP:musicUtils.NOTESSHARP,NOTESTEP:musicUtils.NOTESTEP,MUSICALMODES:musicUtils.MUSICALMODES,SHARP:musicUtils.SHARP,FLAT:musicUtils.FLAT}),global.NANERRORMSG=require("../../logo").NANERRORMSG;var exp=require("../../../js/js-export/export");global.MusicBlocks=exp.MusicBlocks,global.Mouse=exp.Mouse,global.Singer={processPitch:jest.fn(),addScalarTransposition:jest.fn().mockReturnValue(["C",4]),calculateInvert:jest.fn().mockReturnValue(2)};var setupPitchActions=require("../PitchActions");describe("Tests for Singer.PitchActions setup",function(){var i,s,o;beforeEach(function(){s={singer:{inNoteBlock:[],justCounting:[],lastNotePlayed:null,previousNotePlayed:null,inDefineMode:!(o=1),defineMode:[],pitchNumberOffset:0,scalarTransposition:0,transposition:0,scalarTranspositionValues:[],transpositionValues:[],transpositionRatios:[],invertList:[],keySignature:"C",currentOctave:4}},i={turtles:{ithTurtle:function(){return s}},blocks:{blockList:_defineProperty({},o,{})},logo:{inMatrix:!1,inMusicKeyboard:!1,synth:{inTemperament:"equal",startingPitch:"A0"},runningLilypond:!1,setDispatchBlock:function(){},setTurtleListener:function(){},stopTurtle:!1,notation:{notationMarkup:function(){}}},errorMsg:function(){}},setupPitchActions(i)}),test("playPitch → always calls processPitch",function(){var e=jest.spyOn(Singer,"processPitch");Singer.PitchActions.playPitch("C",4,0,0,o),expect(e).toHaveBeenCalledWith(i,"C",4,0,0,o),e.mockRestore()}),describe("Tests for stepPitch",function(){test("non‑number value → error path",function(){Singer.PitchActions.stepPitch("foo",0,o),expect(i.logo.stopTurtle).toBe(!0)}),test("first‑call default assignment + justCounting branch",function(){s.singer.justCounting=[1],s.singer.lastNotePlayed=null,Singer.PitchActions.stepPitch(2,0,o),expect(s.singer.lastNotePlayed[0]).toBe("G4")}),test("inverted path",function(){s.singer.lastNotePlayed=["A4",4],s.singer.inverted=!0,jest.spyOn(Singer,"calculateInvert").mockReturnValue(1),jest.spyOn(getNote,"bind"),Singer.PitchActions.stepPitch(3,0,o)}),test("stepPitch handles numeric‑frequency lastNotePlayed branch",function(){s.singer.lastNotePlayed=[440],s.singer.inNoteBlock=[],i.logo.inMatrix=!1,i.logo.inMusicKeyboard=!1,Singer.PitchActions.stepPitch(1,0,o),expect(Array.isArray(s.singer.lastNotePlayed)).toBe(!0),expect(_typeof(s.singer.lastNotePlayed[0])).toBe("string")}),test("justCounting with null previous/last sets both to G4",function(){s.singer.justCounting=[0],s.singer.lastNotePlayed=null,s.singer.previousNotePlayed=null,s.singer.inNoteBlock=[1],Singer.PitchActions.stepPitch(2,0,o),expect(s.singer.previousNotePlayed).toEqual(["G4",4]),expect(s.singer.lastNotePlayed).toEqual(["G4",4])}),test("when lastNotePlayed=null but inNoteBlock nonempty → fourth‐if sets default",function(){s.singer.lastNotePlayed=null,s.singer.inNoteBlock=[1],i.logo.inMatrix=!1,i.logo.inMusicKeyboard=!1,s.singer.justCounting=[],Singer.PitchActions.stepPitch(1,0,o),expect(s.singer.lastNotePlayed).toEqual(["G4",4])}),test("numeric lastNotePlayed → frequencyToPitch branch",function(){s.singer.lastNotePlayed=[440],s.singer.inNoteBlock=[1],i.logo.inMatrix=!1,i.logo.inMusicKeyboard=!1;var e=jest.spyOn(global,"frequencyToPitch");Singer.PitchActions.stepPitch(2,0,o),expect(e).toHaveBeenCalledWith(440),e.mockRestore()})}),describe("Tests for playNthModalPitch",function(){test("float rounding + negative arg + FLAT/SHARP adjustments",function(){s.singer.lastNotePlayed=["C4",4],global.keySignatureToMode=function(){return["Db","minor"]},Singer.PitchActions.playNthModalPitch(-2.7,3.1,0,o)}),test("playNthModalPitch covers SHARP adjustment branch",function(){global.keySignatureToMode=function(){return["F#","minor"]},expect(function(){Singer.PitchActions.playNthModalPitch(5.2,3,0,o)}).not.toThrow()})}),describe("Tests for playPitchNumber",function(){test("defineMode push",function(){s.singer.inDefineMode=!0,Singer.PitchActions.playPitchNumber(7,0,o),expect(s.singer.defineMode).toContain(7)}),test("customTemperament error + else real play",function(){s.singer.inDefineMode=!1,jest.spyOn(isCustomTemperament,"bind").mockReturnValue(!0),Singer.PitchActions.playPitchNumber(5,0,o),jest.spyOn(Singer,"processPitch"),jest.spyOn(isCustomTemperament,"bind").mockReturnValue(!1),Singer.PitchActions.playPitchNumber(5,0,o),expect(Singer.processPitch).toHaveBeenCalled()}),test("errorMsg called with correct localized string on custom temperament + nonzero transposition",function(){s.singer.inDefineMode=!1,s.singer.scalarTransposition=1,s.singer.transposition=0,global.isCustomTemperament=function(){return!0};var e=_("Scalar transpositions are equal to Semitone transpositions for custom temperament."),t=jest.spyOn(i,"errorMsg");Singer.PitchActions.playPitchNumber(5,0,o),expect(t).toHaveBeenCalledWith(e),t.mockRestore()})}),test("Tests for playHertz",function(){s.singer.inNoteBlock=[1],i.logo.runningLilypond=!0,jest.spyOn(i.logo.notation,"notationMarkup"),Singer.PitchActions.playHertz(440,0,o),expect(i.logo.notation.notationMarkup).toHaveBeenCalled()}),test("playHertz notationMarkup occurs only when both inNoteBlock AND runningLilypond",function(){var e=jest.spyOn(i.logo.notation,"notationMarkup");s.singer.inNoteBlock=[1],i.logo.runningLilypond=!0,Singer.PitchActions.playHertz(440,0,o),expect(e).toHaveBeenCalledWith(0,440),e.mockClear(),i.logo.runningLilypond=!1,Singer.PitchActions.playHertz(440,0,o),expect(e).not.toHaveBeenCalled(),e.mockClear(),s.singer.inNoteBlock=[],i.logo.runningLilypond=!0,Singer.PitchActions.playHertz(440,0,o),expect(e).not.toHaveBeenCalled(),e.mockRestore()}),describe("Tests for setAccidental",function(){test("named accidental path",function(){Singer.PitchActions.setAccidental("sharp",0,o)}),test("invalid accidental → default case",function(){Singer.PitchActions.setAccidental("foo",0,o)})}),describe("Tests for transpositions",function(){test("setScalarTranspose blockList path",function(){Singer.PitchActions.setScalarTranspose(1,0,o)}),test("setScalarTranspose MusicBlocks.isRun path",function(){MusicBlocks.isRun=!0,Singer.PitchActions.setScalarTranspose(1,0),MusicBlocks.isRun=!1}),test("setSemitoneTranspose both paths",function(){Singer.PitchActions.setSemitoneTranspose(1,0,o),MusicBlocks.isRun=!0,Singer.PitchActions.setSemitoneTranspose(1,0),MusicBlocks.isRun=!1}),test("setRatioTranspose both paths",function(){Singer.PitchActions.setRatioTranspose(2,0,o),MusicBlocks.isRun=!0,Singer.PitchActions.setRatioTranspose(2,0),MusicBlocks.isRun=!1})}),describe("Tests for setRegister",function(){test("floors the value",function(){Singer.PitchActions.setRegister(5.7,0),expect(s.singer.register).toBe(5)})}),describe("Tests for invert",function(){test("numeric mode normalization",function(){Singer.PitchActions.invert("C",4,3,0,o)}),test("invalid mode ignored",function(){Singer.PitchActions.invert("C",4,"nonsense",0,o)})}),describe("Tests for numToPitch",function(){test("valid number→returns pitch/octave",function(){expect(Singer.PitchActions.numToPitch(5,"pitch",0)).toEqual(expect.any(String)),expect(Singer.PitchActions.numToPitch(5,"octave",0)).toEqual(expect.any(Number))}),test("invalid input → throws",function(){expect(function(){return Singer.PitchActions.numToPitch(null,"pitch",0)}).toThrow("NoArgError")})}),describe("Tests for setPitchNumberOffset",function(){test("sets offset via calcOctave + pitchToNumber",function(){Singer.PitchActions.setPitchNumberOffset("D",5,0),expect(_typeof(s.singer.pitchNumberOffset)).toBe("number")})}),describe("Tests for deltaPitch",function(){test("no previousNote → returns 0",function(){s.singer.previousNotePlayed=null,expect(Singer.PitchActions.deltaPitch("deltapitch",0)).toBe(0)}),test("scalar delta path",function(){s.singer.previousNotePlayed=["C4",4],s.singer.lastNotePlayed=["E4",4];var e=Singer.PitchActions.deltaPitch("deltascalarpitch",0);expect(_typeof(e)).toBe("number")}),test("deltascalarpitch returns a negative count when last < previous",function(){s.singer.previousNotePlayed=["D4",4],s.singer.lastNotePlayed=["C4",4];var e=Singer.PitchActions.deltaPitch("deltascalarpitch",0);expect(e).toBeLessThan(0)})}),describe("Tests for consonantStepSize",function(){test("with lastNote → uses slice path",function(){s.singer.lastNotePlayed=["F#4",4],expect(Singer.PitchActions.consonantStepSize("down",0)).toEqual(musicUtils.getStepSizeDown("C","F#"))}),test("no lastNote → default G",function(){s.singer.lastNotePlayed=null,expect(Singer.PitchActions.consonantStepSize("up",0)).toEqual(musicUtils.getStepSizeUp("C","G"))})}),describe("Tests for listener & dispatch registration",function(){test("invert pushes even/odd/scalar and ignores bad modes",function(){Singer.PitchActions.invert("C",4,2,0,o);var e=s.singer.invertList.pop();expect(e[2]).toBe("even"),Singer.PitchActions.invert("C",4,"scalar",0,o),e=s.singer.invertList.pop(),expect(e[2]).toBe("scalar");var t=s.singer.invertList.length;Singer.PitchActions.invert("C",4,"nope",0,o),expect(s.singer.invertList.length).toBe(t)}),test("deltaPitch returns actual semitone difference",function(){s.singer.previousNotePlayed=["C4",4],s.singer.lastNotePlayed=["D4",4],expect(Singer.PitchActions.deltaPitch("deltapitch",0)).toBe(2)})}),describe("transpose listener registration & value arrays",function(){var e,t,n;beforeEach(function(){e=jest.spyOn(i.logo,"setDispatchBlock"),t=jest.spyOn(i.logo,"setTurtleListener"),n={MB:{listeners:[]}},Mouse.getMouseFromTurtle=function(){return n}}),afterEach(function(){e.mockRestore(),t.mockRestore(),MusicBlocks.isRun=!1}),test("setScalarTranspose: blockList path",function(){Singer.PitchActions.setScalarTranspose(5,0,o),expect(s.singer.scalarTranspositionValues.pop()).toBe(5),expect(e).toHaveBeenCalledWith(o,0,"_scalar_transposition_0"),expect(t).toHaveBeenCalledWith(0,"_scalar_transposition_0",expect.any(Function))}),test("setScalarTranspose: MusicBlocks.isRun path",function(){MusicBlocks.isRun=!0,Singer.PitchActions.setScalarTranspose(2,0),expect(n.MB.listeners).toContain("_scalar_transposition_0"),expect(t).toHaveBeenCalledWith(0,"_scalar_transposition_0",expect.any(Function))}),test("setSemitoneTranspose: blockList path",function(){Singer.PitchActions.setSemitoneTranspose(3,0,o),expect(s.singer.transpositionValues.pop()).toBe(3),expect(e).toHaveBeenCalledWith(o,0,"_transposition_0"),expect(t).toHaveBeenCalledWith(0,"_transposition_0",expect.any(Function))}),test("setSemitoneTranspose: MusicBlocks.isRun path",function(){MusicBlocks.isRun=!0,Singer.PitchActions.setSemitoneTranspose(4,0),expect(n.MB.listeners).toContain("_transposition_0"),expect(t).toHaveBeenCalledWith(0,"_transposition_0",expect.any(Function))}),test("setRatioTranspose: blockList path",function(){Singer.PitchActions.setRatioTranspose(7,0,o),expect(s.singer.transpositionRatios.pop()).toBe(7),expect(e).toHaveBeenCalledWith(o,0,"_transposition_ratio_0"),expect(t).toHaveBeenCalledWith(0,"_transposition_ratio_0",expect.any(Function))}),test("setRatioTranspose: MusicBlocks.isRun path",function(){MusicBlocks.isRun=!0,Singer.PitchActions.setRatioTranspose(9,0),expect(n.MB.listeners).toContain("_transposition_ratio_0"),expect(t).toHaveBeenCalledWith(0,"_transposition_ratio_0",expect.any(Function))})}),describe("low‑level listener callbacks for Accidental / Transpose / Invert",function(){var n;beforeEach(function(){i.logo.setTurtleListener=function(e,t,n){return n()},n={MB:{listeners:[]}},Mouse.getMouseFromTurtle=function(){return n}}),afterEach(function(){MusicBlocks.isRun=!1}),test('setAccidental early‑return for _("sharp") & _("flat")',function(){var e=s.singer.transposition;Singer.PitchActions.setAccidental(_("sharp"),0,o),Singer.PitchActions.setAccidental(_("flat"),0,o),expect(s.singer.transposition).toBe(e)}),test("setAccidental run‑mode pushes listener and its callback reverses delta",function(){MusicBlocks.isRun=!0;var e=s.singer.transposition,t=ACCIDENTALNAMES[0];Singer.PitchActions.setAccidental(t,0),expect(n.MB.listeners).toContain("_accidental_0_undefined"),expect(s.singer.transposition).toBe(e)}),test("setScalarTranspose listener callback pops & reverses",function(){var e=s.singer.scalarTransposition;Singer.PitchActions.setScalarTranspose(4,0,o),expect(s.singer.scalarTransposition).toBe(e)}),test("setSemitoneTranspose listener callback pops & reverses",function(){var e=s.singer.transposition;Singer.PitchActions.setSemitoneTranspose(5,0,o),expect(s.singer.transposition).toBe(e)}),test("setRatioTranspose listener callback pops ratio",function(){s.singer.transpositionRatios=[],Singer.PitchActions.setRatioTranspose(7,0,o),expect(s.singer.transpositionRatios).toHaveLength(0)}),test("invert listener callback pops & clears inverted flag",function(){s.singer.invertList=[],s.singer.inverted=!0,Singer.PitchActions.invert("C",4,"even",0,o),expect(s.singer.invertList).toHaveLength(0),expect(s.singer.inverted).toBe(!1)}),test("setAccidental blockList listener callback reverses delta",function(){i.logo.setTurtleListener=function(e,t,n){return n()};var e=s.singer.transposition,t=ACCIDENTALNAMES[0];Singer.PitchActions.setAccidental(t,0,o),expect(s.singer.transposition).toBe(e)})}),describe("playNthModalPitch unicode FLAT/SHARP ref‑adjustment",function(){test("FLAT symbol branch",function(){global.keySignatureToMode=function(){return["B"+FLAT,"major"]};var e=jest.spyOn(Singer,"processPitch");Singer.PitchActions.playNthModalPitch(4.5,2,0,o),expect(e).toHaveBeenCalled(),e.mockRestore()}),test("SHARP symbol branch",function(){global.keySignatureToMode=function(){return["F"+SHARP,"minor"]};var e=jest.spyOn(Singer,"processPitch");Singer.PitchActions.playNthModalPitch(2.2,3,0,o),expect(e).toHaveBeenCalled(),e.mockRestore()})}),describe("invert: MusicBlocks.isRun listener path",function(){var e;beforeEach(function(){MusicBlocks.isRun=!0,e={MB:{listeners:[]}},Mouse.getMouseFromTurtle=function(){return e}}),afterEach(function(){MusicBlocks.isRun=!1}),test("pushes listenerName into Mouse.MB.listeners",function(){Singer.PitchActions.invert("C",4,"even",0),expect(e.MB.listeners).toContain("_invert_0")})}),describe("default listener‑only path",function(){var t;beforeEach(function(){MusicBlocks.isRun=!1,t=jest.spyOn(i.logo,"setTurtleListener")}),afterEach(function(){t.mockRestore()}),test("setAccidental registers listener only",function(){var e=ACCIDENTALNAMES[0];Singer.PitchActions.setAccidental(e,0),expect(t).toHaveBeenCalledWith(0,"_accidental_0_undefined",expect.any(Function))}),test("setScalarTranspose registers listener only",function(){Singer.PitchActions.setScalarTranspose(3,0),expect(t).toHaveBeenCalledWith(0,"_scalar_transposition_0",expect.any(Function))}),test("setSemitoneTranspose registers listener only",function(){Singer.PitchActions.setSemitoneTranspose(2,0),expect(t).toHaveBeenCalledWith(0,"_transposition_0",expect.any(Function))}),test("setRatioTranspose registers listener only",function(){Singer.PitchActions.setRatioTranspose(5,0),expect(t).toHaveBeenCalledWith(0,"_transposition_ratio_0",expect.any(Function))}),test("invert registers listener only",function(){Singer.PitchActions.invert("C",4,"even",0),expect(t).toHaveBeenCalledWith(0,"_invert_0",expect.any(Function))})})});