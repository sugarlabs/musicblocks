"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}var setupMeterActions=require("../MeterActions");describe("setupMeterActions",function(){var s,a;beforeAll(function(){global.Singer={MeterActions:{},RhythmActions:{getNoteValue:jest.fn(function(){return 1})}},global.TONEBPM=240,global.Queue=jest.fn(function(e,t,n){return{action:e,duration:t,blk:n}}),global.last=jest.fn(function(e){return e[e.length-1]}),global._=jest.fn(function(e){return e}),global.rationalToFraction=jest.fn(function(e){return[4*e,4]})}),beforeEach(function(){s={turtles:{ithTurtle:jest.fn(),turtleList:[],addTurtle:jest.fn(),getTurtle:jest.fn(function(e){return a}),getTurtleCount:jest.fn(function(){return 1})},blocks:{blockList:{1:{}}},logo:{actions:{testAction:"testAction"},setDispatchBlock:jest.fn(),setTurtleListener:jest.fn(),initTurtle:jest.fn(),prepSynths:jest.fn(),runFromBlockNow:jest.fn(),notation:{notationMeter:jest.fn(),notationPickup:jest.fn()}},errorMsg:jest.fn(),stage:{dispatchEvent:jest.fn()}},a={id:0,singer:{beatsPerMeasure:0,noteValuePerBeat:0,beatList:[],factorList:[],defaultStrongBeats:!1,bpm:[],notesPlayed:[0,1],pickup:0,drift:0},queue:[],parentFlowQueue:[],unhighlightQueue:[],parameterQueue:[]},s.turtles.ithTurtle.mockReturnValue(a),setupMeterActions(s)}),it("should set the meter correctly",function(){Singer.MeterActions.setMeter(4,4,0),expect(a.singer.beatsPerMeasure).toBe(4),expect(a.singer.noteValuePerBeat).toBe(.25),expect(s.logo.notation.notationMeter).toHaveBeenCalledWith(0,4,.25)}),describe("default strong beats for various time signatures",function(){test.each([[4,.25,[1,3]],[2,.25,[1]],[3,.25,[1]],[6,1/8,[1,4]]])("should set default strong beats for %i/%f time",function(e,t,n){a.singer.beatList=[],Singer.MeterActions.setMeter(e,t,0),n.forEach(function(e){return expect(a.singer.beatList).toContain(e)}),expect(a.singer.defaultStrongBeats).toBe(!0)})}),it("should handle non-standard time signatures without adding default beats",function(){a.singer.beatList=[],Singer.MeterActions.setMeter(5,.25,0),expect(a.singer.beatList.length).toBe(0),expect(a.singer.defaultStrongBeats).toBe(!1)}),describe("setPickup",function(){test.each([[2,0,2,!0],[-2,0,0,!1]])("setPickup(%i, %i) should result in pickup %i",function(e,t,n,r){Singer.MeterActions.setPickup(e,t),expect(a.singer.pickup).toBe(n),r&&expect(s.logo.notation.notationPickup).toHaveBeenCalledWith(t,e)})}),describe("BPM settings",function(){test.each([[120,.25,[],120,void 0],[10,.25,["1/4 beats per minute must be greater than 30"],30,1],[5e3,.25,["maximum 1/4 beats per minute is 1000"],1e3,1]])("setBPM(%i) should handle %s range",function(e,t,n,r,o){s.errorMsg.mockClear(),Singer.MeterActions.setBPM(e,t,0,o),n.length&&n.forEach(function(e){return expect(s.errorMsg).toHaveBeenCalledWith(e,o)}),expect(a.singer.bpm).toContain(r)})}),describe("master BPM settings",function(){test.each([[100,[],100],[500,[],500],[10,["1/4 beats per minute must be greater than 30"],30],[5e3,["maximum 1/4 beats per minute is 1000"],1e3]])("setMasterBPM(%i) should result in masterBPM %i",function(e,t,n){s.errorMsg.mockClear(),Singer.MeterActions.setMasterBPM(e,.25,1),t.length&&t.forEach(function(e){return expect(s.errorMsg).toHaveBeenCalledWith(e,1)}),expect(Singer.masterBPM).toBe(n),t.length||expect(Singer.defaultBPMFactor).toBe(TONEBPM/n)})}),it("should set a listener for every beat",function(){s.turtles.turtleList=[{companionTurtle:null}],s.turtles.addTurtle=jest.fn(),s.logo.prepSynths=jest.fn(),a.id=0,Singer.MeterActions.onEveryBeatDo("testAction",!1,null,0,1),expect(s.turtles.addTurtle).toHaveBeenCalled(),expect(s.logo.prepSynths).toHaveBeenCalled(),expect(s.logo.setTurtleListener).toHaveBeenCalledWith(1,"__everybeat_1__",expect.any(Function))}),it("should handle running turtle in onEveryBeatDo listener",function(){a.id=0;var t={id:a.companionTurtle=1,running:!0,singer:{bpm:[]},queue:[],parentFlowQueue:[],unhighlightQueue:[],parameterQueue:[]};s.turtles.ithTurtle.mockImplementation(function(e){return 0===e?a:t}),global.setInterval=jest.fn(function(){return 12345}),Singer.MeterActions.onEveryBeatDo("testAction",!1,null,0,1),(0,s.logo.setTurtleListener.mock.calls[0][2])(),expect(t.queue.length).toBe(1),expect(t.parentFlowQueue).toContain(1)}),it("should handle non-running turtle in onEveryBeatDo listener",function(){a.id=0;var t={id:a.companionTurtle=1,running:!1,singer:{bpm:[]},queue:[],parentFlowQueue:[],unhighlightQueue:[],parameterQueue:[]};s.turtles.ithTurtle.mockImplementation(function(e){return 0===e?a:t}),global.setInterval=jest.fn(function(){return 12345}),Singer.MeterActions.onEveryBeatDo("testAction",!1,null,0,1),(0,s.logo.setTurtleListener.mock.calls[0][2])(),expect(s.logo.runFromBlockNow).toHaveBeenCalledWith(s.logo,1,"testAction",!1,null)}),it("should clear existing interval when setting up a new one",function(){var t={id:a.companionTurtle=1,interval:12345,singer:{bpm:[]},queue:[],parentFlowQueue:[],unhighlightQueue:[],parameterQueue:[]};s.turtles.ithTurtle.mockImplementation(function(e){return 0===e?a:t}),global.clearInterval=jest.fn(),global.setInterval=jest.fn(function(){return 54321}),Singer.MeterActions.onEveryBeatDo("testAction",!1,null,0,1),expect(clearInterval).toHaveBeenCalledWith(12345),expect(setInterval).toHaveBeenCalled()}),it("should set a listener for every note",function(){Singer.MeterActions.onEveryNoteDo("testAction",!1,null,0,1),expect(s.logo.setTurtleListener).toHaveBeenCalled(),expect(a.singer.beatList).toContain("everybeat")}),it("should setup listener for strong beat",function(){a.id=0,a.singer.beatsPerMeasure=4,Singer.MeterActions.onStrongBeatDo(1,"testAction",!1,null,0,1),expect(s.logo.setTurtleListener).toHaveBeenCalledWith(0,"__beat_1_0__",expect.any(Function)),expect(a.singer.beatList).toContain(1)}),it("should clear default strong beats when adding custom strong beat",function(){a.singer.defaultStrongBeats=!0,a.singer.beatList=[1,3,5,"everybeat","offbeat"],a.singer.beatsPerMeasure=6,Singer.MeterActions.onStrongBeatDo(2,"testAction",!1,null,0,1),expect(a.singer.beatList).not.toContain(1),expect(a.singer.beatList).not.toContain(3),expect(a.singer.beatList).not.toContain(5),expect(a.singer.beatList).toContain("everybeat"),expect(a.singer.beatList).toContain("offbeat"),expect(a.singer.beatList).toContain(2),expect(a.singer.defaultStrongBeats).toBe(!1)}),it("should handle beat greater than beatsPerMeasure",function(){a.singer.beatsPerMeasure=4,a.singer.factorList=[],Singer.MeterActions.onStrongBeatDo(5,"testAction",!1,null,0,1),expect(a.singer.factorList).toContain(5),expect(a.singer.beatList).not.toContain(5)}),it("should set up listener for weak beat",function(){a.id=0,Singer.MeterActions.onWeakBeatDo("testAction",!1,null,0,1),expect(s.logo.setTurtleListener).toHaveBeenCalledWith(0,"__offbeat_0__",expect.any(Function)),expect(a.singer.beatList).toContain("offbeat")}),it("should increment drift counter and set up listener",function(){a.singer.drift=0,global.clearInterval=jest.fn(),Singer.MeterActions.setNoClock(0,1),expect(a.singer.drift).toBe(1),expect(s.logo.setDispatchBlock).toHaveBeenCalledWith(1,0,"_drift_0");var e=s.logo.setTurtleListener.mock.calls[0][2];a.singer.drift=2,e(),expect(a.singer.drift).toBe(1)}),it("should handle MusicBlocks.isRun condition",function(){global.MusicBlocks={isRun:!0};var e={MB:{listeners:[]}};global.Mouse={getMouseFromTurtle:jest.fn(function(){return e})},Singer.MeterActions.setNoClock(0),expect(e.MB.listeners).toContain("_drift_0")}),test.each([[null],[0]])("should return 0 when noteValue is %p",function(e){var t=Singer.MeterActions.getNotesPlayed(e,0);expect(t).toBe(0)}),it("should calculate notes played correctly",function(){a.singer.notesPlayed=[12,3];var e=Singer.MeterActions.getNotesPlayed(2,0);expect(e).toBe(2)}),it("should calculate whole notes played correctly",function(){a.singer.notesPlayed=[4,1];var e=Singer.MeterActions.getWholeNotesPlayed(0);expect(e).toBe(4)}),it("should return 0 when notes played is less than pickup",function(){a.singer.notesPlayed=[1,1],a.singer.pickup=2;var e=Singer.MeterActions.getBeatCount(0);expect(e).toBe(0)}),it("should calculate beat count correctly",function(){a.singer.notesPlayed=[5,1],a.singer.pickup=1,a.singer.noteValuePerBeat=1,a.singer.beatsPerMeasure=4;var e=Singer.MeterActions.getBeatCount(0);expect(e).toBe(1)}),it("should return 0 for measure count when notes played is less than pickup",function(){a.singer.notesPlayed=[1,1],a.singer.pickup=2;var e=Singer.MeterActions.getMeasureCount(0);expect(e).toBe(0)}),it("should calculate measure count correctly",function(){a.singer.notesPlayed=[9,1],a.singer.pickup=1,a.singer.noteValuePerBeat=1,a.singer.beatsPerMeasure=4;var e=Singer.MeterActions.getMeasureCount(0);expect(e).toBe(3)}),test.each([[[],80,80],[[80,120],void 0,120]])("getBPM with singer.bpm %p and masterBPM %p returns %p",function(e,t,n){a.singer.bpm=e,Singer.masterBPM=80;var r=Singer.MeterActions.getBPM(0);expect(r).toBe(n)}),it("should return the correct beat factor",function(){a.singer.noteValuePerBeat=.25;var e=Singer.MeterActions.getBeatFactor(0);expect(e).toBe(.25)}),it("should return the correct meter format",function(){a.singer.beatsPerMeasure=4,a.singer.noteValuePerBeat=1;var e=Singer.MeterActions.getCurrentMeter(0);expect(e).toBe("4:1")}),describe("invalid inputs and dispatch behaviors",function(){beforeEach(function(){a.singer.beatList=[],s.logo.setDispatchBlock.mockClear(),s.stage.dispatchEvent.mockClear(),global.MusicBlocks={isRun:!1},delete s.turtles.ithTurtle(0).companionTurtle}),test.each([[0,.25,"beatsPerMeasure",4],[4,0,"noteValuePerBeat",4]])("setMeter(%p, %p) defaults %s to %i",function(e,t,n,r){Singer.MeterActions.setMeter(e,t,0),expect(a.singer[n]).toBe(r)}),it("immediately dispatches the beat event once",function(){Singer.MeterActions.onEveryBeatDo("testAction",!1,null,0,1);var e=s.turtles.getTurtle(0).companionTurtle,t="__everybeat_".concat(e,"__");expect(s.stage.dispatchEvent).toHaveBeenCalledWith(t)}),it("handles setNoClock without blk and isRun=false",function(){Singer.MeterActions.setNoClock(0),expect(s.logo.setDispatchBlock).not.toHaveBeenCalled(),expect(s.logo.setTurtleListener).toHaveBeenCalledWith(0,"_drift_0",expect.any(Function))})}),describe("listener invocation",function(){beforeEach(function(){a.queue=[],a.parentFlowQueue=[]}),test.each([["every note","onEveryNoteDo",["testAction",!1,null,0,1],"__everybeat_0__",1],["strong beat","onStrongBeatDo",[2,"testAction",!1,null,0,3],"__beat_2_0__",3],["weak beat","onWeakBeatDo",["testAction",!1,null,0,4],"__offbeat_0__",4]])("should enqueue action on %s listener",function(e,t,n,r,o){var i;(i=Singer.MeterActions)[t].apply(i,_toConsumableArray(n)),(0,s.logo.setTurtleListener.mock.calls.find(function(e){return e[1]===r})[2])(),expect(a.parentFlowQueue).toContain(o),expect(a.queue[0].action).toBe("testAction")})}),it("should return last BPM value when turtle-specific BPM is set",function(){a.singer.bpm=[80,120];var e=Singer.MeterActions.getBPM(0);expect(last).toHaveBeenCalledWith([80,120]),expect(e).toBe(120)}),it("should dispatch event on everyâ€‘beat interval callback",function(){var n;global.setInterval=jest.fn(function(e,t){return n=e,555}),s.stage.dispatchEvent.mockClear(),a.id=0,delete s.turtles.getTurtle(0).companionTurtle,Singer.MeterActions.onEveryBeatDo("testAction",!1,null,0,1),expect(s.stage.dispatchEvent).toHaveBeenCalledTimes(1),expect(setInterval).toHaveBeenCalled(),s.stage.dispatchEvent.mockClear(),n();var e=s.turtles.getTurtle(0).companionTurtle,t="__everybeat_".concat(e,"__");expect(s.stage.dispatchEvent).toHaveBeenCalledWith(t)}),it("should use turtle-specific BPM for interval timer",function(){var n;global.setInterval=jest.fn(function(e,t){return n=t,999}),a.singer.noteValuePerBeat=1,a.singer.bpm=[30,120],Singer.masterBPM=60,Singer.MeterActions.onEveryBeatDo("testAction",!1,null,0,1),expect(last).toHaveBeenCalledWith([30,120]),expect(n).toBe(2e3)}),it("should set listener when Mouse.getMouseFromTurtle returns null",function(){global.MusicBlocks={isRun:!0},global.Mouse.getMouseFromTurtle=jest.fn(function(){return null}),Singer.MeterActions.setNoClock(0),expect(s.logo.setTurtleListener).toHaveBeenCalledWith(0,"_drift_0",expect.any(Function))})});