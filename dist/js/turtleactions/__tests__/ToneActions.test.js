"use strict";var setupToneActions=require("../ToneActions");describe("setupToneActions",function(){var o,n,i={};beforeAll(function(){global.Singer={ToneActions:{}},global.instrumentsEffects={0:{"default-voice":{vibratoActive:!1,vibratoIntensity:[],vibratoFrequency:0}}},global.VOICENAMES={Piano:["piano","grand-piano"],Violin:["violin","acoustic-violin"]},global.CUSTOMSAMPLES={},global.DEFAULTVOICE="default-voice",global.last=function(e){return e[e.length-1]},global._=function(e){return e},global.NOINPUTERRORMSG="Missing input",global.MusicBlocks={isRun:!0},global.Mouse={getMouseFromTurtle:function(e){return e?{MB:{listeners:[]}}:null}}}),beforeEach(function(){i={},global.VOICENAMES={Piano:["piano","grand-piano"],Violin:["violin","acoustic-violin"]};var t={MB:{listeners:[]}};global.Mouse.getMouseFromTurtle=jest.fn(function(e){return t}),o={turtles:{ithTurtle:function(){return n}},blocks:{blockList:{1:{},2:{}}},logo:{setDispatchBlock:jest.fn(function(e){}),setTurtleListener:jest.fn(function(e,t,o){i[t]=o}),synth:{loadSynth:jest.fn(),createSynth:jest.fn()},phraseMaker:{_instrumentName:null},notation:{notationSwing:jest.fn(),notationVoices:jest.fn(),notationBeginHarmonics:jest.fn(),notationEndHarmonics:jest.fn()},timbre:{instrumentName:"default-voice",FMSynthParams:[],AMSynthParams:[],duoSynthParams:[],osc:[],fmSynthParamvals:{},amSynthParamvals:{},duoSynthParamVals:{},FMSynthesizer:[],AMSynthesizer:[],duoSynthesizer:[],vibratoEffect:[],vibratoParams:[]},inTimbre:!0,stopTurtle:!1,inMatrix:!1},errorMsg:jest.fn()},n={singer:{instrumentNames:[],synthVolume:{"default-voice":[1]},crescendoInitialVolume:{"default-voice":[1]},vibratoIntensity:[],vibratoRate:[],chorusRate:[],delayTime:[],chorusDepth:[],rate:[],octaves:[],baseFrequency:[],tremoloFrequency:[],tremoloDepth:[],distortionAmount:[],inHarmonic:[],partials:[]},inSetTimbre:!1},global.instrumentsEffects={0:{"default-voice":{vibratoActive:!1,vibratoIntensity:[],vibratoFrequency:[]}}},setupToneActions(o)}),describe("setTimbre",function(){it("should set timbre correctly for known voice",function(){Singer.ToneActions.setTimbre("piano",0,1),expect(n.singer.instrumentNames).toContain("grand-piano"),expect(o.logo.synth.loadSynth).toHaveBeenCalledWith(0,"grand-piano"),i._settimbre_0&&(i._settimbre_0(),expect(n.inSetTimbre).toBe(!1),expect(n.singer.instrumentNames.length).toBe(0))}),it("should handle direct synth name",function(){Singer.ToneActions.setTimbre("grand-piano",0,1),expect(n.singer.instrumentNames).toContain("grand-piano")}),it("should handle custom sample timbres correctly",function(){Singer.ToneActions.setTimbre(["custom1","sample1","sample2","sample3"],0,1),expect(global.CUSTOMSAMPLES.customsample_custom1).toEqual(["sample1","sample2","sample3"]),expect(n.singer.instrumentNames).toContain("customsample_custom1")}),it("should handle empty custom sample name",function(){Singer.ToneActions.setTimbre(["","sample1","sample2","sample3"],0,1),expect(n.singer.instrumentNames).toContain("default-voice")}),it("should use default voice when synth is undefined",function(){Singer.ToneActions.setTimbre("unknown-instrument",0,1),expect(n.singer.instrumentNames).toContain("unknown-instrument")}),it("should handle non-object non-accounted instrument",function(){delete global.VOICENAMES.Piano,Singer.ToneActions.setTimbre("piano",0,1),expect(n.singer.instrumentNames).toContain("piano")}),it("should set instrument name in phraseMaker when in matrix",function(){o.logo.inMatrix=!0,Singer.ToneActions.setTimbre("piano",0,1);var e=global.VOICENAMES.Piano[1];expect(o.logo.phraseMaker._instrumentName).toBe(e)}),it("should initialize synthVolume when undefined",function(){n.singer.instrumentNames=[];var e=global.VOICENAMES.Piano[1];delete n.singer.synthVolume[e],delete n.singer.crescendoInitialVolume[e],Singer.ToneActions.setTimbre("piano",0,1),expect(n.singer.synthVolume[e]).toBeDefined(),expect(n.singer.synthVolume[e]).toEqual([1]),expect(n.singer.crescendoInitialVolume[e]).toEqual([1])}),it("should fallback to default-voice when instrument is undefined",function(){Singer.ToneActions.setTimbre(void 0,0,1),expect(n.singer.instrumentNames).toContain("default-voice")}),it("should NOT register a mouse listener when blk is undefined",function(){MusicBlocks.isRun=!1;var e=Mouse.getMouseFromTurtle(n);e.MB.listeners=[],Singer.ToneActions.setTimbre("piano",0),expect(e.MB.listeners).not.toContain("_settimbre_0"),MusicBlocks.isRun=!0}),it("should register a mouse listener when blk is undefined and running",function(){var e=Mouse.getMouseFromTurtle(n);e.MB.listeners=[],Singer.ToneActions.setTimbre("piano",0),expect(e.MB.listeners).toContain("_settimbre_0"),i._settimbre_0(),expect(n.inSetTimbre).toBe(!1)})}),describe("doVibrato",function(){it("should apply vibrato correctly with valid parameters",function(){Singer.ToneActions.doVibrato(50,10,0,1),expect(n.singer.vibratoIntensity).toContain(.5),expect(n.singer.vibratoRate).toContain(.1),expect(o.logo.timbre.vibratoEffect).toContain(1),expect(o.logo.timbre.vibratoParams).toContain(50),expect(global.instrumentsEffects[0]["default-voice"].vibratoActive).toBe(!0),i._vibrato_0&&(i._vibrato_0(),expect(n.singer.vibratoIntensity.length).toBe(0),expect(n.singer.vibratoRate.length).toBe(0))}),it("should show error for invalid vibrato intensity",function(){Singer.ToneActions.doVibrato(150,5,0,1),expect(o.errorMsg).toHaveBeenCalledWith("Vibrato intensity must be between 1 and 100.",1),expect(o.logo.stopTurtle).toBe(!0)}),it("should show error for invalid vibrato rate",function(){Singer.ToneActions.doVibrato(50,0,0,1),expect(o.errorMsg).toHaveBeenCalledWith("Vibrato rate must be greater than 0.",1),expect(o.logo.stopTurtle).toBe(!0)}),it("should use last vibrato intensity in timbre mode",function(){o.logo.inTimbre=!0,Singer.ToneActions.doVibrato(50,10,0,1),expect(global.instrumentsEffects[0]["default-voice"].vibratoActive).toBe(!0),expect(o.logo.timbre.vibratoParams).toContain(50),expect(o.logo.timbre.vibratoParams).toContain(.1),expect(global.instrumentsEffects[0]["default-voice"].vibratoFrequency).toBe(10)}),it("should skip timbreâ€‘mode params when not in timbre",function(){o.logo.inTimbre=!1,Singer.ToneActions.doVibrato(50,5,0,1),expect(o.logo.timbre.vibratoEffect).toHaveLength(0)}),it("should NOT register a mouse listener when blk is undefined",function(){MusicBlocks.isRun=!1;var e=Mouse.getMouseFromTurtle(n);e.MB.listeners=[],Singer.ToneActions.doVibrato(50,5,0),expect(e.MB.listeners).not.toContain("_vibrato_0"),MusicBlocks.isRun=!0}),it("should register a mouse listener when blk is undefined and running",function(){var e=Mouse.getMouseFromTurtle(n);e.MB.listeners=[],Singer.ToneActions.doVibrato(50,5,0),expect(e.MB.listeners).toContain("_vibrato_0"),i._vibrato_0(),expect(n.singer.vibratoIntensity.length).toBe(0)})}),describe("doChorus",function(){it("should apply chorus effect correctly with valid parameters",function(){Singer.ToneActions.doChorus(1.5,20,50,0,1),expect(n.singer.chorusRate).toContain(1.5),expect(n.singer.delayTime).toContain(20),expect(n.singer.chorusDepth).toContain(.5),i._chorus_0&&(i._chorus_0(),expect(n.singer.chorusRate.length).toBe(0),expect(n.singer.delayTime.length).toBe(0),expect(n.singer.chorusDepth.length).toBe(0))}),it("should show error for invalid chorus depth",function(){Singer.ToneActions.doChorus(1.5,20,150,0,1),expect(o.errorMsg).toHaveBeenCalledWith("Depth is out of range.",1),expect(o.logo.stopTurtle).toBe(!0)}),it("should show error for negative chorus depth",function(){Singer.ToneActions.doChorus(1.5,20,-10,0,1),expect(o.errorMsg).toHaveBeenCalledWith("Depth is out of range.",1),expect(o.logo.stopTurtle).toBe(!0)}),it("should NOT register a mouse listener when blk is undefined",function(){MusicBlocks.isRun=!1;var e=Mouse.getMouseFromTurtle(n);e.MB.listeners=[],Singer.ToneActions.doChorus(1.5,20,50,0),expect(e.MB.listeners).not.toContain("_chorus_0"),MusicBlocks.isRun=!0}),it("should register a mouse listener when blk is undefined and running",function(){var e=Mouse.getMouseFromTurtle(n);e.MB.listeners=[],Singer.ToneActions.doChorus(1.5,20,50,0),expect(e.MB.listeners).toContain("_chorus_0"),i._chorus_0(),expect(n.singer.chorusRate.length).toBe(0)})}),describe("doPhaser",function(){it("should apply phaser effect correctly",function(){Singer.ToneActions.doPhaser(2,3,100,0,1),expect(n.singer.rate).toContain(2),expect(n.singer.octaves).toContain(3),expect(n.singer.baseFrequency).toContain(100),i._phaser_0&&(i._phaser_0(),expect(n.singer.rate.length).toBe(0),expect(n.singer.octaves.length).toBe(0),expect(n.singer.baseFrequency.length).toBe(0))}),it("should NOT register a mouse listener when blk is undefined",function(){MusicBlocks.isRun=!1;var e=Mouse.getMouseFromTurtle(n);e.MB.listeners=[],Singer.ToneActions.doPhaser(2,3,100,0),expect(e.MB.listeners).not.toContain("_phaser_0"),MusicBlocks.isRun=!0}),it("should register a mouse listener when blk is undefined and running",function(){var e=Mouse.getMouseFromTurtle(n);e.MB.listeners=[],Singer.ToneActions.doPhaser(2,3,100,0),expect(e.MB.listeners).toContain("_phaser_0"),i._phaser_0(),expect(n.singer.rate.length).toBe(0)})}),describe("doTremolo",function(){it("should apply tremolo effect correctly",function(){Singer.ToneActions.doTremolo(5,50,0,1),expect(n.singer.tremoloFrequency).toContain(5),expect(n.singer.tremoloDepth).toContain(.5),expect(o.logo.setDispatchBlock).toHaveBeenCalledWith(1,0,"_tremolo_0"),i._tremolo_0&&(i._tremolo_0(),expect(n.singer.tremoloFrequency.length).toBe(0),expect(n.singer.tremoloDepth.length).toBe(0))}),it("should show error for invalid tremolo depth",function(){Singer.ToneActions.doTremolo(5,150,0,1),expect(o.errorMsg).toHaveBeenCalledWith("Depth is out of range.",1),expect(o.logo.stopTurtle).toBe(!0)}),it("should show error for negative tremolo depth",function(){Singer.ToneActions.doTremolo(5,-50,0,1),expect(o.errorMsg).toHaveBeenCalledWith("Depth is out of range.",1),expect(o.logo.stopTurtle).toBe(!0)}),it("should NOT register a mouse listener when blk is undefined",function(){MusicBlocks.isRun=!1;var e=Mouse.getMouseFromTurtle(n);e.MB.listeners=[],Singer.ToneActions.doTremolo(5,50,0),expect(e.MB.listeners).not.toContain("_tremolo_0"),MusicBlocks.isRun=!0}),it("should register a mouse listener when blk is undefined and running",function(){var e=Mouse.getMouseFromTurtle(n);e.MB.listeners=[],Singer.ToneActions.doTremolo(5,50,0),expect(e.MB.listeners).toContain("_tremolo_0"),i._tremolo_0(),expect(n.singer.tremoloFrequency.length).toBe(0)})}),describe("doDistortion",function(){it("should apply distortion effect correctly",function(){Singer.ToneActions.doDistortion(50,0,1),expect(n.singer.distortionAmount).toContain(.5),expect(o.logo.setDispatchBlock).toHaveBeenCalledWith(1,0,"_distortion_0"),i._distortion_0&&(i._distortion_0(),expect(n.singer.distortionAmount.length).toBe(0))}),it("should show error for invalid distortion amount",function(){Singer.ToneActions.doDistortion(150,0,1),expect(o.errorMsg).toHaveBeenCalledWith("Distortion must be from 0 to 100.",1),expect(o.logo.stopTurtle).toBe(!0)}),it("should show error for negative distortion amount",function(){Singer.ToneActions.doDistortion(-10,0,1),expect(o.errorMsg).toHaveBeenCalledWith("Distortion must be from 0 to 100.",1),expect(o.logo.stopTurtle).toBe(!0)}),it("should NOT register a mouse listener when blk is undefined",function(){MusicBlocks.isRun=!1;var e=Mouse.getMouseFromTurtle(n);e.MB.listeners=[],Singer.ToneActions.doDistortion(50,0),expect(e.MB.listeners).not.toContain("_distortion_0"),MusicBlocks.isRun=!0}),it("should register a mouse listener when blk is undefined and running",function(){var e=Mouse.getMouseFromTurtle(n);e.MB.listeners=[],Singer.ToneActions.doDistortion(50,0),expect(e.MB.listeners).toContain("_distortion_0"),i._distortion_0(),expect(n.singer.distortionAmount.length).toBe(0)})}),describe("doHarmonic",function(){it("should apply harmonic effect correctly",function(){Singer.ToneActions.doHarmonic(2,0,1),expect(o.logo.notation.notationBeginHarmonics).toHaveBeenCalledWith(0),expect(n.singer.partials).toHaveLength(1),expect(n.singer.partials[0]).toEqual([0,0,1]),expect(o.logo.setDispatchBlock).toHaveBeenCalledWith(1,0,"_harmonic_0_1"),i._harmonic_0_1&&(i._harmonic_0_1(),expect(n.singer.inHarmonic.length).toBe(0),expect(n.singer.partials.length).toBe(0),expect(o.logo.notation.notationEndHarmonics).toHaveBeenCalledWith(0))}),it("should show error for invalid harmonic value",function(){Singer.ToneActions.doHarmonic(-1,0,1),expect(o.errorMsg).toHaveBeenCalledWith("Partial must be greater than or equal to 0."),expect(o.logo.stopTurtle).toBe(!0)}),it("should show error for non-numeric harmonic value",function(){Singer.ToneActions.doHarmonic("not a number",0,1),expect(o.errorMsg).toHaveBeenCalledWith("Partial must be greater than or equal to 0."),expect(o.logo.stopTurtle).toBe(!0)}),it("should handle zero harmonic value",function(){Singer.ToneActions.doHarmonic(0,0,1),expect(n.singer.partials).toHaveLength(1),expect(n.singer.partials[0]).toEqual([1])}),it("should NOT register a mouse listener when blk is undefined",function(){MusicBlocks.isRun=!1;var e=Mouse.getMouseFromTurtle(n);e.MB.listeners=[],Singer.ToneActions.doHarmonic(2,0),expect(e.MB.listeners).not.toContain("_harmonic_0_undefined"),MusicBlocks.isRun=!0}),it("should register a mouse listener when blk is undefined and running",function(){var e=Mouse.getMouseFromTurtle(n);e.MB.listeners=[],Singer.ToneActions.doHarmonic(2,0),expect(e.MB.listeners).toContain("_harmonic_0_undefined"),i._harmonic_0_undefined(),expect(n.singer.inHarmonic.length).toBe(0),expect(n.singer.partials.length).toBe(0)})}),describe("defFMSynth",function(){it("should define FM synth correctly",function(){Singer.ToneActions.defFMSynth(10,0,1),expect(o.logo.timbre.FMSynthParams).toContain(10),expect(o.logo.synth.createSynth).toHaveBeenCalledWith(0,"default-voice","fmsynth",{modulationIndex:10})}),it("should handle null modulationIndex",function(){Singer.ToneActions.defFMSynth(null,0,1),expect(o.errorMsg).toHaveBeenCalledWith("Missing input",1),expect(o.logo.timbre.FMSynthParams).toContain(10)}),it("should handle negative modulationIndex",function(){Singer.ToneActions.defFMSynth(-10,0,1),expect(o.errorMsg).toHaveBeenCalledWith("The input cannot be negative."),expect(o.logo.timbre.FMSynthParams).toContain(10)}),it("should show error when oscillators exist",function(){o.logo.timbre.osc=[{}],Singer.ToneActions.defFMSynth(10,0,1),expect(o.errorMsg).toHaveBeenCalledWith("Unable to use synth due to existing oscillator")}),it("should not create parameters when not in timbre mode",function(){o.logo.inTimbre=!1,Singer.ToneActions.defFMSynth(10,0,1),expect(o.logo.synth.createSynth).not.toHaveBeenCalled()})}),describe("defAMSynth",function(){it("should define AM synth correctly",function(){Singer.ToneActions.defAMSynth(5,0,1),expect(o.logo.timbre.AMSynthParams).toContain(5),expect(o.logo.synth.createSynth).toHaveBeenCalledWith(0,"default-voice","amsynth",{harmonicity:5})}),it("should handle null harmonicity",function(){Singer.ToneActions.defAMSynth(null,0,1),expect(o.errorMsg).toHaveBeenCalledWith("Missing input",1),expect(o.logo.timbre.AMSynthParams).toContain(1)}),it("should handle non-numeric harmonicity",function(){Singer.ToneActions.defAMSynth("string",0,1),expect(o.errorMsg).toHaveBeenCalledWith("Missing input",1),expect(o.logo.timbre.AMSynthParams).toContain(1)}),it("should handle negative harmonicity",function(){Singer.ToneActions.defAMSynth(-5,0,1),expect(o.errorMsg).toHaveBeenCalledWith("The input cannot be negative."),expect(o.logo.timbre.AMSynthParams).toContain(5)}),it("should show error when oscillators exist",function(){o.logo.timbre.osc=[{}],Singer.ToneActions.defAMSynth(5,0,1),expect(o.errorMsg).toHaveBeenCalledWith("Unable to use synth due to existing oscillator")}),it("should not create parameters when not in timbre mode",function(){o.logo.inTimbre=!1,Singer.ToneActions.defAMSynth(5,0,1),expect(o.logo.synth.createSynth).not.toHaveBeenCalled()})}),describe("defDuoSynth",function(){it("should define Duo synth correctly",function(){Singer.ToneActions.defDuoSynth(10,20,0,1),expect(o.logo.timbre.duoSynthParams).toContain(10),expect(o.logo.timbre.duoSynthParams).toContain(.2),expect(o.logo.synth.createSynth).toHaveBeenCalledWith(0,"default-voice","duosynth",{vibratoRate:10,vibratoAmount:.2})}),it("should handle null vibratoRate",function(){Singer.ToneActions.defDuoSynth(null,20,0,1),expect(o.errorMsg).toHaveBeenCalledWith("Missing input",1),expect(o.logo.timbre.duoSynthParams).toContain(10)}),it("should handle non-numeric vibratoRate",function(){Singer.ToneActions.defDuoSynth("string",20,0,1),expect(o.errorMsg).toHaveBeenCalledWith("Missing input",1),expect(o.logo.timbre.duoSynthParams).toContain(10)}),it("should handle null vibratoAmount",function(){Singer.ToneActions.defDuoSynth(10,null,0,1),expect(o.errorMsg).toHaveBeenCalledWith("Missing input",1),expect(o.logo.timbre.duoSynthParams).toContain(.5)}),it("should handle non-numeric vibratoAmount",function(){Singer.ToneActions.defDuoSynth(10,"string",0,1),expect(o.errorMsg).toHaveBeenCalledWith("Missing input",1),expect(o.logo.timbre.duoSynthParams).toContain(.5)}),it("should handle negative inputs correctly",function(){Singer.ToneActions.defDuoSynth(-10,-20,0,1),expect(o.logo.timbre.duoSynthParams).toContain(10),expect(o.logo.timbre.duoSynthParams).toContain(.2)}),it("should show error when oscillators exist",function(){o.logo.timbre.osc=[{}],Singer.ToneActions.defDuoSynth(10,20,0,1),expect(o.errorMsg).toHaveBeenCalledWith("Unable to use synth due to existing oscillator")}),it("should not create parameters when not in timbre mode",function(){o.logo.inTimbre=!1,Singer.ToneActions.defDuoSynth(10,20,0,1),expect(o.logo.synth.createSynth).not.toHaveBeenCalled()})})});