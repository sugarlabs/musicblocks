"use strict";var setupVolumeActions=require("../VolumeActions");describe("setupVolumeActions",function(){var o,i,e,t,n,s,l,u,c,a;beforeAll(function(){global.Singer={VolumeActions:{},setSynthVolume:jest.fn(),setMasterVolume:jest.fn(),masterVolume:[]},global.instruments={0:{synth1:{connect:jest.fn()},piano:{connect:jest.fn()}}},global.Tone={Panner:jest.fn(function(e){return{toDestination:jest.fn(),pan:{value:e||0}}})},global.last=jest.fn(function(e){return e[e.length-1]}),global._=jest.fn(function(e){return e}),global.VOICENAMES={Piano:["Piano","piano"],Violin:["Violin","violin"]},global.DRUMNAMES={Kick:["Kick","kick"],Snare:["Snare","snare"]},global.DEFAULTVOLUME=50,global.DEFAULTVOICE="default"}),beforeEach(function(){e&&e.mockClear(),t&&t.mockClear(),n&&n.mockClear(),s&&s.mockClear(),l&&l.mockClear(),u&&u.mockClear(),c&&c.mockClear(),a&&a.mockClear(),jest.useFakeTimers(),global.Mouse={getMouseFromTurtle:jest.fn().mockReturnValue({MB:{listeners:[]}})},global.MusicBlocks={isRun:!0},o={turtles:{ithTurtle:jest.fn()},blocks:{blockList:{}},logo:{setDispatchBlock:jest.fn(),setTurtleListener:jest.fn(),synth:{loadSynth:jest.fn(),setMasterVolume:jest.fn(),trigger:jest.fn()},notation:{notationBeginArticulation:jest.fn(),notationEndArticulation:jest.fn(),notationEndCrescendo:jest.fn()},blockList:{1:{connections:[{},{}]},2:{connections:[{}]},testBlock:{connections:[null,2]},emptyBlock:{connections:[]},oneConnectionBlock:{connections:[3]}}},errorMsg:jest.fn()},e=jest.spyOn(Singer,"setSynthVolume"),t=jest.spyOn(Singer,"setMasterVolume"),n=jest.spyOn(o.logo.notation,"notationEndCrescendo"),s=jest.spyOn(o.logo.notation,"notationBeginArticulation"),l=jest.spyOn(o.logo.notation,"notationEndArticulation"),u=jest.spyOn(o.logo.synth,"loadSynth"),c=jest.spyOn(o.logo.synth,"trigger"),a=jest.spyOn(o.logo,"setDispatchBlock"),i={singer:{synthVolume:{default:[DEFAULTVOLUME],piano:[DEFAULTVOLUME]},crescendoInitialVolume:{default:[DEFAULTVOLUME],piano:[DEFAULTVOLUME]},crescendoDelta:[],inCrescendo:[],instrumentNames:["default","piano"],suppressOutput:!1,justCounting:[],panner:null}},o.turtles.ithTurtle.mockReturnValue(i),setupVolumeActions(o)}),afterEach(function(){jest.useRealTimers()}),describe("doCrescendo",function(){test.each([["crescendo",10,10],["decrescendo",10,-10]])("sets up %s correctly",function(e,t,n){Singer.VolumeActions.doCrescendo(e,t,0,1),expect(i.singer.crescendoDelta).toContain(n),expect(i.singer.synthVolume.default.length).toBeGreaterThan(1),expect(i.singer.inCrescendo).toContain(!0),expect(o.logo.setTurtleListener).toHaveBeenCalledWith(0,"_crescendo_0",expect.any(Function))}),test("handles dispatch block, mouse listener, and run flag",function(){o.blocks.blockList[1]={};var e={MB:{listeners:[]}};Mouse.getMouseFromTurtle.mockReturnValue(e),Singer.VolumeActions.doCrescendo("crescendo",10,0,1),expect(o.logo.setDispatchBlock).toHaveBeenCalledWith(1,0,"_crescendo_0"),expect(e.MB.listeners).toHaveLength(0),MusicBlocks.isRun=!1,o.logo.setDispatchBlock.mockClear(),Mouse.getMouseFromTurtle.mockClear(),Singer.VolumeActions.doCrescendo("crescendo",15,0),expect(o.logo.setDispatchBlock).not.toHaveBeenCalled(),expect(Mouse.getMouseFromTurtle).not.toHaveBeenCalled(),expect(o.logo.setTurtleListener).toHaveBeenCalledWith(0,"_crescendo_0",expect.any(Function))}),test.each([[[],!1],[[!0],!0]])("listener execution with justCounting %p",function(e,t){i.singer.justCounting=e,Singer.VolumeActions.doCrescendo("crescendo",10,0,1),(0,o.logo.setTurtleListener.mock.calls.pop()[2])(),t?expect(n).not.toHaveBeenCalled():expect(n).toHaveBeenCalledWith(0,10)})}),describe("setRelativeVolume",function(){it("should adjust volume relatively for all synths",function(){i.singer.synthVolume={default:[50],piano:[60]},Singer.VolumeActions.setRelativeVolume(20,0,1),expect(i.singer.synthVolume.default).toContain(60),expect(i.singer.synthVolume.piano).toContain(72),expect(e).toHaveBeenCalledWith(o.logo,0,"default",60),expect(e).toHaveBeenCalledWith(o.logo,0,"piano",72)}),it("should clamp relative volume to max 100",function(){i.singer.synthVolume={default:[90]},Singer.VolumeActions.setRelativeVolume(50,0,1),expect(i.singer.synthVolume.default).toContain(100)}),it("should clamp relative volume to min -100",function(){i.singer.synthVolume={default:[50]},Singer.VolumeActions.setRelativeVolume(-300,0,1),expect(i.singer.synthVolume.default).toContain(-100)}),it("should call notationBeginArticulation when justCounting is empty",function(){Singer.VolumeActions.setRelativeVolume(20,0,1),expect(s).toHaveBeenCalledWith(0)}),it("should not call notationBeginArticulation when justCounting is not empty",function(){i.singer.justCounting=[!0],Singer.VolumeActions.setRelativeVolume(20,0,1),expect(s).not.toHaveBeenCalled()}),it("should use dispatch block when block is provided",function(){o.blocks.blockList[1]={},Singer.VolumeActions.setRelativeVolume(20,0,1),expect(o.logo.setDispatchBlock).toHaveBeenCalledWith(1,0,"_articulation_0")}),it("should add listener to mouse when MusicBlocks.isRun is true",function(){var e={MB:{listeners:[]}};Mouse.getMouseFromTurtle.mockReturnValue(e),Singer.VolumeActions.setRelativeVolume(20,0),expect(e.MB.listeners).toContain("_articulation_0")}),it("should execute listener correctly",function(){i.singer.synthVolume={default:[50,60],piano:[60,72]},Singer.VolumeActions.setRelativeVolume(20,0,1),(0,o.logo.setTurtleListener.mock.calls[0][2])(),expect(i.singer.synthVolume.default).toHaveLength(2),expect(i.singer.synthVolume.piano).toHaveLength(2),expect(e).toHaveBeenCalledWith(o.logo,0,"default",60),expect(e).toHaveBeenCalledWith(o.logo,0,"piano",72),expect(l).toHaveBeenCalledWith(0)}),it("should not call notationEndArticulation when justCounting is not empty",function(){i.singer.justCounting=[!0],Singer.VolumeActions.setRelativeVolume(20,0,1),(0,o.logo.setTurtleListener.mock.calls[0][2])(),expect(l).not.toHaveBeenCalled()}),it("should not call setSynthVolume when suppressOutput is true",function(){i.singer.suppressOutput=!0,Singer.VolumeActions.setRelativeVolume(30,0,1),expect(e).not.toHaveBeenCalled()}),it("should not call setDispatchBlock or mouse listener when MusicBlocks.isRun is false and blk is undefined",function(){MusicBlocks.isRun=!1,Singer.VolumeActions.setRelativeVolume(25,0),expect(o.logo.setDispatchBlock).not.toHaveBeenCalled(),expect(Mouse.getMouseFromTurtle).not.toHaveBeenCalled(),expect(o.logo.setTurtleListener).toHaveBeenCalledWith(0,"_articulation_0",expect.any(Function))})}),describe("setMasterVolume",function(){it("should set master volume correctly",function(){Singer.VolumeActions.setMasterVolume(80,0,1),expect(Singer.masterVolume).toContain(80),expect(t).toHaveBeenCalledWith(o.logo,80,1)}),it("should clamp master volume to min 0",function(){Singer.VolumeActions.setMasterVolume(-10,0,1),expect(Singer.masterVolume).toContain(0),expect(o.errorMsg).toHaveBeenCalledWith("Setting volume to 0.",1)}),it("should clamp master volume to max 100",function(){Singer.VolumeActions.setMasterVolume(120,0,1),expect(Singer.masterVolume).toContain(100)}),it("should pop from masterVolume when length is 2",function(){Singer.masterVolume=[50,60],Singer.VolumeActions.setMasterVolume(80,0,1),expect(Singer.masterVolume).toEqual([50,80])}),it("should not call setMasterVolume when suppressOutput is true",function(){i.singer.suppressOutput=!0,Singer.VolumeActions.setMasterVolume(80,0,1),expect(t).not.toHaveBeenCalled()})}),describe("setPanning",function(){it("should create new panner when none exists",function(){i.singer.panner=null,Singer.VolumeActions.setPanning(50,0),expect(Tone.Panner).toHaveBeenCalledWith(.5);var e=Tone.Panner.mock.results[0].value;expect(e.toDestination).toHaveBeenCalled()}),it("should update existing panner when one exists",function(){i.singer.panner=new Tone.Panner(0),Singer.VolumeActions.setPanning(50,0),expect(i.singer.panner.pan.value).toBe(.5)}),it("should clamp panning value to range [-1, 1]",function(){Singer.VolumeActions.setPanning(150,0),expect(Tone.Panner).toHaveBeenCalledWith(1);var e=Tone.Panner.mock.results[0].value;expect(e.pan.value).toBe(1),Singer.VolumeActions.setPanning(-150,0),expect(Tone.Panner).toHaveBeenCalledWith(-1);var t=Tone.Panner.mock.results[1].value;expect(t.pan.value).toBe(-1)}),it("should connect all instruments to the panner",function(){var e=jest.spyOn(instruments[0].synth1,"connect"),t=jest.spyOn(instruments[0].piano,"connect");Singer.VolumeActions.setPanning(50,0),expect(e).toHaveBeenCalledWith(i.singer.panner),expect(t).toHaveBeenCalledWith(i.singer.panner)})}),describe("setSynthVolume",function(){it("should set volume for default voice",function(){Singer.VolumeActions.setSynthVolume(DEFAULTVOICE,70,0,"testBlock"),expect(i.singer.synthVolume[DEFAULTVOICE]).toContain(70),expect(e).toHaveBeenCalledWith(o.logo,0,DEFAULTVOICE,70)}),it("should set volume for custom synth",function(){Singer.VolumeActions.setSynthVolume("custom",70,0,"testBlock"),expect(i.singer.synthVolume.custom).toContain(70),expect(e).toHaveBeenCalledWith(o.logo,0,"custom",70)}),it("should identify and set volume for voice type from VOICENAMES",function(){Singer.VolumeActions.setSynthVolume("Piano",70,0,"testBlock"),expect(i.singer.synthVolume.piano).toContain(70),Singer.VolumeActions.setSynthVolume("violin",60,0,"testBlock"),expect(i.singer.synthVolume.violin).toContain(60)}),it("should identify and set volume for drum type from DRUMNAMES",function(){Singer.VolumeActions.setSynthVolume("Kick",70,0,"testBlock"),expect(i.singer.synthVolume.kick).toContain(70),Singer.VolumeActions.setSynthVolume("snare",60,0,"testBlock"),expect(i.singer.synthVolume.snare).toContain(60)}),it("should handle invalid synth name",function(){Singer.VolumeActions.setSynthVolume("invalidSynth",70,0,"testBlock"),expect(o.errorMsg).toHaveBeenCalledWith("nullnot found"),expect(i.singer.synthVolume[DEFAULTVOICE]).toContain(70)}),it("should load synth when not in instrumentNames",function(){i.singer.instrumentNames=["default"],Singer.VolumeActions.setSynthVolume("piano",70,0,"testBlock"),expect(i.singer.instrumentNames).toContain("piano"),expect(u).toHaveBeenCalledWith(0,"piano")}),it("should initialize synthVolume and crescendoInitialVolume when undefined",function(){delete i.singer.synthVolume.violin,delete i.singer.crescendoInitialVolume.violin,Singer.VolumeActions.setSynthVolume("violin",70,0,"testBlock"),expect(i.singer.synthVolume.violin).toEqual([DEFAULTVOLUME,70]),expect(i.singer.crescendoInitialVolume.violin).toEqual([DEFAULTVOLUME])}),it("should not call setSynthVolume when suppressOutput is true",function(){i.singer.suppressOutput=!0,Singer.VolumeActions.setSynthVolume(DEFAULTVOICE,70,0,"testBlock"),expect(e).not.toHaveBeenCalled()}),it("should trigger tone when firstConnection and lastConnection are null",function(){Singer.VolumeActions.setSynthVolume(DEFAULTVOICE,70,0,null),jest.advanceTimersByTime(250),expect(c).toHaveBeenCalledWith(0,"G4",.25,DEFAULTVOICE,null,null,!1)}),it("should not trigger tone when connections exist",function(){Singer.VolumeActions.setSynthVolume(DEFAULTVOICE,70,0,"testBlock"),jest.advanceTimersByTime(250),expect(c).not.toHaveBeenCalled()})}),describe("getter methods",function(){it("should get master volume correctly",function(){Singer.masterVolume=[60],expect(Singer.VolumeActions.masterVolume).toBe(60)}),it("should get synth volume correctly when synth exists",function(){i.singer.synthVolume.piano=[50,70],expect(Singer.VolumeActions.getSynthVolume("piano",0)).toBe(70)}),it("should return undefined when getting volume for non-existent synth",function(){expect(Singer.VolumeActions.getSynthVolume("nonExistentSynth",0)).toBeUndefined()})}),describe("edge cases and combinations",function(){it("should handle case where synthVolume is undefined",function(){delete i.singer.synthVolume.default,Singer.VolumeActions.setRelativeVolume(20,0,1),expect(i.singer.synthVolume.piano).toBeDefined()}),it("should handle empty crescendoInitialVolume",function(){i.singer.crescendoInitialVolume={},Singer.VolumeActions.doCrescendo("crescendo",10,0,1),expect(i.singer.crescendoInitialVolume.default).toBeDefined(),expect(i.singer.crescendoInitialVolume.piano).toBeDefined()}),it("should handle null mouse",function(){Mouse.getMouseFromTurtle.mockReturnValue(null),Singer.VolumeActions.doCrescendo("crescendo",10,0),expect(o.logo.setTurtleListener).toHaveBeenCalled()})})});