"use strict";var setupDrumActions=require("../DrumActions");describe("setupDrumActions",function(){var o,i;beforeAll(function(){global.Singer={DrumActions:{},processNote:jest.fn()},global.DEFAULTDRUM="defaultDrum",global.DRUMNAMES={drum1:["d1","drum1"],drum2:["d2","drum2"]},global.NOISENAMES={noise1:["n1","noise1"],noise2:["n2","noise2"]},global.DEFAULTVOLUME=100,global.last=jest.fn(function(e){return e[e.length-1]}),global._=jest.fn(function(e){return e}),global.MusicBlocks={isRun:!1},global.Mouse={getMouseFromTurtle:jest.fn()}}),beforeEach(function(){o={turtles:{ithTurtle:jest.fn()},blocks:{blockList:{1:{}}},logo:{setDispatchBlock:jest.fn(),setTurtleListener:jest.fn(),clearNoteParams:jest.fn(),inRhythmRuler:!1,rhythmRuler:{Drums:[],Rulers:[]},_currentDrumBlock:null},errorMsg:jest.fn()},i={singer:{drumStyle:[],inNoteBlock:[],noteDrums:{},synthVolume:{},crescendoInitialVolume:{},noteBeatValues:{},beatFactor:1,pushedNote:!1,pitchDrumTable:{}}},o.turtles.ithTurtle.mockReturnValue(i),global.MusicBlocks.isRun=!1,global.Mouse.getMouseFromTurtle.mockReturnValue(null),setupDrumActions(o)}),describe("GetDrumname",function(){it("should return the correct drum name when given nickname",function(){var e=Singer.DrumActions.GetDrumname("d1");expect(e).toBe("drum1")}),it("should return the default drum for unknown drums",function(){var e=Singer.DrumActions.GetDrumname("unknown");expect(e).toBe(DEFAULTDRUM)}),it("should return http URLs directly",function(){var e="https://example.com/drum.wav",n=Singer.DrumActions.GetDrumname(e);expect(n).toBe(e)}),it("should handle direct drum names",function(){var e=Singer.DrumActions.GetDrumname("drum1");expect(e).toBe("drum1")})}),describe("playDrum",function(){it("should play a standalone drum sound",function(){i.singer.noteDrums[1]||(i.singer.noteDrums[1]=[]),Singer.DrumActions.playDrum("d1",0,1),expect(Singer.processNote).toHaveBeenCalledWith(o,expect.any(Number),!1,expect.anything(),0,expect.any(Function)),expect(o.logo.clearNoteParams).toHaveBeenCalledWith(i,1,[]),expect(i.singer.inNoteBlock).toContain(1),expect(i.singer.noteDrums[1]).toContain("drum1"),expect(i.singer.pushedNote).toBe(!0)}),it("should add a drum to an existing note block",function(){i.singer.inNoteBlock.push(2),i.singer.noteDrums[2]=[],Singer.DrumActions.playDrum("d1",0,1),expect(i.singer.noteDrums[2]).toContain("drum1")}),it("should use the drum style if one is set",function(){i.singer.inNoteBlock.push(2),i.singer.noteDrums[2]=[],i.singer.drumStyle.push("drum2"),Singer.DrumActions.playDrum("d1",0,1),expect(i.singer.noteDrums[2]).toContain("drum2"),expect(i.singer.noteDrums[2]).not.toContain("drum1")}),it("should initialize synthVolume if not defined",function(){i.singer.inNoteBlock.push(2),i.singer.noteDrums[2]=[],i.singer.synthVolume={},Singer.DrumActions.playDrum("d1",0,1),expect(i.singer.synthVolume.drum1).toEqual([DEFAULTVOLUME]),expect(i.singer.crescendoInitialVolume.drum1).toEqual([DEFAULTVOLUME])}),it("should not overwrite existing synthVolume and crescendoInitialVolume",function(){i.singer.inNoteBlock.push(5),i.singer.noteDrums[5]=[],i.singer.synthVolume={drum1:[30]},i.singer.crescendoInitialVolume={drum1:[40]},Singer.DrumActions.playDrum("d1",0,5),expect(i.singer.synthVolume.drum1).toEqual([30]),expect(i.singer.crescendoInitialVolume.drum1).toEqual([40])}),it("should remove the block from inNoteBlock when the callback is invoked",function(){i.singer.noteDrums[2]||(i.singer.noteDrums[2]=[]),Singer.DrumActions.playDrum("d1",0,2),expect(i.singer.inNoteBlock).toContain(2),(0,Singer.processNote.mock.calls[0][5])(),expect(i.singer.inNoteBlock).not.toContain(2)})});describe.each([["setDrum","_setdrum_0",!0],["mapPitchToDrum","_mapdrum_0",!1]])("%s",function(n,t,e){beforeEach(function(){i.singer.drumStyle=[],i.singer.pitchDrumTable={},o.logo.setDispatchBlock.mockClear(),o.logo.setTurtleListener.mockClear(),global.MusicBlocks.isRun=!1,global.Mouse.getMouseFromTurtle.mockReturnValue(null)}),it("sets drum style and listener",function(){Singer.DrumActions[n]("d1",0,1),expect(i.singer.drumStyle).toContain("drum1"),expect(o.logo.setDispatchBlock).toHaveBeenCalledWith(1,0,t),expect(o.logo.setTurtleListener).toHaveBeenCalledWith(0,t,expect.any(Function))}),it("handles MusicBlocks.isRun case",function(){var e={MB:{listeners:[]}};global.MusicBlocks.isRun=!0,global.Mouse.getMouseFromTurtle.mockReturnValue(e),Singer.DrumActions[n]("d1",0),expect(i.singer.drumStyle).toContain("drum1"),expect(e.MB.listeners).toContain(t)}),it("handles direct drum name input",function(){Singer.DrumActions[n]("drum2",0,1),expect(i.singer.drumStyle).toContain("drum2")}),it("handles rhythm ruler",function(){o.logo.inRhythmRuler=!0,Singer.DrumActions[n]("d1",0,1),expect(o.logo._currentDrumBlock).toBe(1),expect(o.logo.rhythmRuler.Drums).toContain(1),expect(o.logo.rhythmRuler.Rulers).toHaveLength(1)}),it("removes drumStyle on listener",function(){Singer.DrumActions[n]("d1",0,1),(0,o.logo.setTurtleListener.mock.calls[0][2])(),expect(i.singer.drumStyle).toHaveLength(0),e&&expect(i.singer.pitchDrumTable).toEqual({})}),it("only adds listener when blk undefined and not running",function(){Singer.DrumActions[n]("d1",0),expect(o.logo.setDispatchBlock).not.toHaveBeenCalled(),expect(global.Mouse.getMouseFromTurtle).not.toHaveBeenCalled(),expect(o.logo.setTurtleListener).toHaveBeenCalledWith(0,expect.any(String),expect.any(Function))}),it("skips mouse listener when isRun and mouse null",function(){global.MusicBlocks.isRun=!0,global.Mouse.getMouseFromTurtle.mockReturnValue(null),Singer.DrumActions[n]("d1",0),expect(o.logo.setDispatchBlock).not.toHaveBeenCalled(),expect(global.Mouse.getMouseFromTurtle).toHaveBeenCalledWith(expect.any(Object)),expect(o.logo.setTurtleListener).toHaveBeenCalledWith(0,expect.any(String),expect.any(Function))})}),describe("playNoise",function(){it("should play noise in a note block",function(){i.singer.inNoteBlock.push(2),i.singer.noteDrums[2]=[],i.singer.noteBeatValues[2]=[],Singer.DrumActions.playNoise("n1",0,1),expect(i.singer.noteDrums[2]).toContain("noise1"),expect(i.singer.noteBeatValues[2]).toContain(1),expect(i.singer.pushedNote).toBe(!0)}),it("should throw an error for standalone noise block",function(){Singer.DrumActions.playNoise("n1",0,1),expect(o.errorMsg).toHaveBeenCalledWith("Noise Block: Did you mean to use a Note block?",1)}),it("should handle direct noise name input",function(){i.singer.inNoteBlock.push(2),i.singer.noteDrums[2]=[],i.singer.noteBeatValues[2]=[],Singer.DrumActions.playNoise("noise2",0,1),expect(i.singer.noteDrums[2]).toContain("noise2")}),it("should initialize synthVolume if not defined",function(){i.singer.inNoteBlock.push(2),i.singer.noteDrums[2]=[],i.singer.noteBeatValues[2]=[],i.singer.synthVolume={},Singer.DrumActions.playNoise("n1",0,1),expect(i.singer.synthVolume.noise1).toEqual([DEFAULTVOLUME]),expect(i.singer.crescendoInitialVolume.noise1).toEqual([DEFAULTVOLUME])}),it("should push unknown noise names directly",function(){i.singer.inNoteBlock.push(3),i.singer.noteDrums[3]=[],i.singer.noteBeatValues[3]=[],Singer.DrumActions.playNoise("foo",0,3),expect(i.singer.noteDrums[3]).toContain("foo")}),it("should not reinitialize synthVolume if already defined",function(){i.singer.inNoteBlock.push(4),i.singer.noteDrums[4]=[],i.singer.noteBeatValues[4]=[],i.singer.synthVolume={noise1:[50]},i.singer.crescendoInitialVolume={noise1:[60]},Singer.DrumActions.playNoise("n1",0,4),expect(i.singer.synthVolume.noise1).toEqual([50]),expect(i.singer.crescendoInitialVolume.noise1).toEqual([60])})})});