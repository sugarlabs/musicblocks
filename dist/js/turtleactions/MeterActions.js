"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);var n=r.call(e,t||"default");if("object"!=_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}function setupMeterActions(g){Singer.MeterActions=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"setMeter",value:function(e,t,r){var n=g.turtles.ithTurtle(r);n.singer.beatsPerMeasure=e<=0?4:e,n.singer.noteValuePerBeat=t<=0?4:1/t,4==n.singer.noteValuePerBeat&&4==n.singer.beatsPerMeasure?(n.singer.beatList.push(1),n.singer.beatList.push(3),n.singer.defaultStrongBeats=!0):4==n.singer.noteValuePerBeat&&2==n.singer.beatsPerMeasure||4==n.singer.noteValuePerBeat&&3==n.singer.beatsPerMeasure?(n.singer.beatList.push(1),n.singer.defaultStrongBeats=!0):8==n.singer.noteValuePerBeat&&6==n.singer.beatsPerMeasure&&(n.singer.beatList.push(1),n.singer.beatList.push(4),n.singer.defaultStrongBeats=!0),g.logo.notation.notationMeter(r,n.singer.beatsPerMeasure,n.singer.noteValuePerBeat)}},{key:"setPickup",value:function(e,t){var r=g.turtles.ithTurtle(t);r.singer.pickup=Math.max(0,e),g.logo.notation.notationPickup(t,r.singer.pickup)}},{key:"setBPM",value:function(e,t,r,n){var i,s,u=e*t/.25;u<30?(i=rationalToFraction(t),s=7.5/t,g.errorMsg(i[0]+"/"+i[1]+" "+_("beats per minute must be greater than")+" "+s,n),u=30):1e3<u&&(i=rationalToFraction(t),s=250/t,g.errorMsg(_("maximum")+" "+i[0]+"/"+i[1]+" "+_("beats per minute is")+" "+s,n),u=1e3),g.turtles.ithTurtle(r).singer.bpm.push(u)}},{key:"setMasterBPM",value:function(e,t,r){var n,i,s=e*t/.25;s<30?(n=rationalToFraction(t),i=7.5/t,g.errorMsg(n[0]+"/"+n[1]+" "+_("beats per minute must be greater than")+" "+i,r),Singer.masterBPM=30):1e3<s?(n=rationalToFraction(t),i=250/t,g.errorMsg(_("maximum")+" "+n[0]+"/"+n[1]+" "+_("beats per minute is")+" "+i,r),Singer.masterBPM=1e3):Singer.masterBPM=s,Singer.defaultBPMFactor=TONEBPM/Singer.masterBPM}},{key:"onEveryNoteDo",value:function(t,e,r,n,i){var s=g.turtles.ithTurtle(n),u="__everybeat_"+s.id+"__";g.logo.setTurtleListener(n,u,function(){var e=new Queue(g.logo.actions[t],1,i);s.parentFlowQueue.push(i),s.queue.push(e)}),s.singer.beatList.push("everybeat")}},{key:"onEveryBeatDo",value:function(t,r,n,i,s){var e=i;g.turtles.getTurtle(e).companionTurtle||(i=g.turtles.getTurtleCount(),g.turtles.getTurtle(e).companionTurtle=i,g.turtles.addTurtle(g.blocks.blockList[s],{}),g.logo.prepSynths()),i=g.turtles.getTurtle(e).companionTurtle;var u=g.turtles.ithTurtle(i),o="__everybeat_"+i+"__";u.queue=[],u.parentFlowQueue=[],u.unhighlightQueue=[],u.parameterQueue=[],g.logo.initTurtle(i),g.logo.setTurtleListener(i,o,function(){var e;u.running?(e=new Queue(g.logo.actions[t],1,s),u.parentFlowQueue.push(s),u.queue.push(e)):g.logo.runFromBlockNow(g.logo,i,g.logo.actions[t],r,n)});var a=g.turtles.ithTurtle(e),l=4*(l=60/(0<a.singer.bpm.length?last(a.singer.bpm):Singer.masterBPM))/a.singer.noteValuePerBeat;void 0!==u.interval&&clearInterval(u.interval),g.stage.dispatchEvent(o),u.interval=setInterval(function(){return g.stage.dispatchEvent(o)},1e3*l)}},{key:"onStrongBeatDo",value:function(e,t,r,n,i,s){var u=g.turtles.ithTurtle(i),o="__beat_"+e+"_"+u.id+"__";if(g.logo.setTurtleListener(i,o,function(){var e=new Queue(g.logo.actions[t],1,s);u.parentFlowQueue.push(s),u.queue.push(e)}),u.singer.defaultStrongBeats){for(var a=0;a<u.singer.beatList.length;a++)"everybeat"!==u.singer.beatList[a]&&"offbeat"!==u.singer.beatList[a]&&(u.singer.beatList.splice(a,1),a--);u.singer.defaultStrongBeats=!1}e>u.singer.beatsPerMeasure?u.singer.factorList.push(e):u.singer.beatList.push(e)}},{key:"onWeakBeatDo",value:function(t,e,r,n,i){var s=g.turtles.ithTurtle(n),u="__offbeat_"+s.id+"__";g.logo.setTurtleListener(n,u,function(){var e=new Queue(g.logo.actions[t],1,i);s.parentFlowQueue.push(i),s.queue.push(e)}),g.turtles.ithTurtle(n).singer.beatList.push("offbeat")}},{key:"setNoClock",value:function(e,t){var r=g.turtles.ithTurtle(e);r.singer.drift++;var n,i="_drift_"+e;void 0!==t&&t in g.blocks.blockList?g.logo.setDispatchBlock(t,e,i):!MusicBlocks.isRun||null!==(n=Mouse.getMouseFromTurtle(r))&&n.MB.listeners.push(i);g.logo.setTurtleListener(e,i,function(){0<r.singer.drift&&r.singer.drift--})}},{key:"getNotesPlayed",value:function(e,t){if(null===e||0===e)return 0;var r=g.turtles.ithTurtle(t);return r.singer.notesPlayed[0]/r.singer.notesPlayed[1]/e}},{key:"getWholeNotesPlayed",value:function(e){var t=g.turtles.ithTurtle(e);return t.singer.notesPlayed[0]/t.singer.notesPlayed[1]}},{key:"getBeatCount",value:function(e){var t=g.turtles.ithTurtle(e);return t.singer.notesPlayed[0]/t.singer.notesPlayed[1]<t.singer.pickup?0:(t.singer.notesPlayed[0]/t.singer.notesPlayed[1]-t.singer.pickup)*t.singer.noteValuePerBeat%t.singer.beatsPerMeasure+1}},{key:"getMeasureCount",value:function(e){var t=g.turtles.ithTurtle(e);return t.singer.notesPlayed[0]/t.singer.notesPlayed[1]<t.singer.pickup?0:Math.floor((t.singer.notesPlayed[0]/t.singer.notesPlayed[1]-t.singer.pickup)*t.singer.noteValuePerBeat/t.singer.beatsPerMeasure)+1}},{key:"getBPM",value:function(e){var t=g.turtles.ithTurtle(e);return 0<t.singer.bpm.length?last(t.singer.bpm):Singer.masterBPM}},{key:"getBeatFactor",value:function(e){return Singer.RhythmActions.getNoteValue(e)*g.turtles.ithTurtle(e).singer.noteValuePerBeat}},{key:"getCurrentMeter",value:function(e){var t=g.turtles.ithTurtle(e);return t.singer.beatsPerMeasure+":"+t.singer.noteValuePerBeat}}]),e}()}"undefined"!=typeof module&&module.exports&&(module.exports=setupMeterActions);