"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _createForOfIteratorHelper(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,u=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return s=t.done,t},e:function(t){u=!0,i=t},f:function(){try{s||null==r.return||r.return()}finally{if(u)throw i}}}}function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_unsupportedIterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(t,e):void 0}}function _iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t))return _arrayLikeToArray(t)}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=Array(e);r<e;r++)n[r]=t[r];return n}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,_toPropertyKey(n.key),n)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function _defineProperty(t,e,r){return(e=_toPropertyKey(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(t,e){if("object"!=_typeof(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0===r)return("string"===e?String:Number)(t);var n=r.call(t,e||"default");if("object"!=_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}var Mouse=function(){function r(t){_classCallCheck(this,r);var e=globalActivity.turtles.getTurtleCount();r.MouseList.length<e?this.turtle=globalActivity.turtles.getTurtle(r.MouseList.length):(globalActivity.turtles.addTurtle(),this.turtle=globalActivity.turtles.getTurtle(e-1),r.AddedTurtles.push(this.turtle)),this.turtle.initTurtle(!1),this.flow=t,this.MB=new MusicBlocks(this),r.MouseList.push(this),r.TurtleMouseMap[this.turtle.id]=this}return _createClass(r,[{key:"run",value:function(){this.turtle.doWait(0),this.flow(this.MB)}}],[{key:"getMouseFromTurtle",value:function(t){return t.id in r.TurtleMouseMap?r.TurtleMouseMap[t.id]:null}}]),r}();_defineProperty(Mouse,"MouseList",[]),_defineProperty(Mouse,"TurtleMouseMap",{}),_defineProperty(Mouse,"AddedTurtles",[]);var MusicBlocks=function(){function MusicBlocks(t){var e=this;_classCallCheck(this,MusicBlocks),this.mouse=t,this.turtle=t.turtle,this.turIndex=globalActivity.turtles.getIndexOfTurtle(this.turtle),this.listeners=[],-1===MusicBlocks._blockNo&&(MusicBlocks._blockNo=0),["GraphicsBlocksAPI","PenBlocksAPI","RhythmBlocksAPI","MeterBlocksAPI","PitchBlocksAPI","IntervalsBlocksAPI","ToneBlocksAPI","OrnamentBlocksAPI","VolumeBlocksAPI","DrumBlocksAPI","DictBlocksAPI"].forEach(function(t){return importMembers(e,t)})}return _createClass(MusicBlocks,[{key:"runCommand",value:function runCommand(command,args){var _this2=this;return new Promise(function(resolve){var returnVal;if("_anonymous"===command)void 0!==args&&args();else{var _cname,cname=null;for(var className in MusicBlocks._methodList)if(-1!==MusicBlocks._methodList[className].indexOf(command)){cname=className;break}cname="Painter"===cname?_this2.turtle.painter:eval(cname),returnVal=void 0===args||Array.isArray(args)&&0===args.length?cname[command]():(_cname=cname)[command].apply(_cname,_toConsumableArray(args))}var delay=_this2.turtle.waitTime;_this2.turtle.doWait(0),setTimeout(function(){return resolve(returnVal)},delay)})}},{key:"print",value:function(t){JSEditor.logConsole('Mouse "'.concat(this.turtle.name,'" (').concat(globalActivity.turtles.getIndexOfTurtle(this.turtle),"): ").concat(t)),void 0===t?globalActivity.textMsg("undefined"):null===t?globalActivity.textMsg("null"):globalActivity.textMsg(t.toString())}},{key:"ENDFLOW",get:function(){return new Promise(function(t){return t()})}},{key:"ENDFLOWCOMMAND",get:function(){var n=this;return new Promise(function(t){var e=n.listeners.pop();null!=e&&globalActivity.stage.dispatchEvent(e);var r=n.turtle.waitTime;n.turtle.doWait(0),setTimeout(t,r)})}},{key:"ENDMOUSE",get:function(){var e=this;return new Promise(function(t){Mouse.MouseList.splice(Mouse.MouseList.indexOf(e.mouse),1),0===Mouse.MouseList.length&&MusicBlocks.init(!1),t()})}},{key:"X",get:function(){return globalActivity.turtles.screenX2turtleX(this.turtle.container.x)}},{key:"Y",get:function(){return globalActivity.turtles.screenY2turtleY(this.turtle.container.y)}},{key:"HEADING",get:function(){return this.turtle.orientation}},{key:"PENSIZE",get:function(){return this.turtle.painter.stroke}},{key:"COLOR",get:function(){return this.turtle.painter.color}},{key:"SHADE",get:function(){return this.turtle.painter.value}},{key:"GREY",get:function(){return this.turtle.painter.chroma}},{key:"NOTEVALUE",get:function(){return Singer.RhythmActions.getNoteValue(this.turIndex)}},{key:"PICKUP",set:function(t){var e=JSInterface.validateArgs("PICKUP",[t]),r=Math.max(0,e[0]);Singer.MeterActions.setPickup(r,this.turIndex)}},{key:"WHOLENOTESPLAYED",get:function(){return Singer.MeterActions.getWholeNotesPlayed(this.turIndex)}},{key:"BEATCOUNT",get:function(){return Singer.MeterActions.getBeatCount(this.turIndex)}},{key:"MEASURECOUNT",get:function(){return Singer.MeterActions.getMeasureCount(this.turIndex)}},{key:"BPM",get:function(){return Singer.MeterActions.getBPM(this.turIndex)}},{key:"BEATFACTOR",get:function(){return Singer.MeterActions.getBeatFactor(this.turIndex)}},{key:"CURRENTMETER",get:function(){return Singer.MeterActions.getCurrentMeter(this.turIndex)}},{key:"SCALARCHANGEINPITCH",get:function(){return Singer.PitchActions.deltaPitch("deltapitch2",this.turIndex)}},{key:"CHANGEINPITCH",get:function(){return Singer.PitchActions.deltaPitch("deltapitch",this.turIndex)}},{key:"SCALARSTEPUP",get:function(){return Singer.PitchActions.consonantStepSize("up",this.turIndex)}},{key:"SCALARSTEPDOWN",get:function(){return Singer.PitchActions.consonantStepSize("down",this.turIndex)}},{key:"MOVABLEDO",set:function(t){var e=JSInterface.validateArgs("MOVABLEDO",[t]);Singer.IntervalsActions.setMovableDo(e[0],this.turIndex)}},{key:"CURRENTKEY",get:function(){return Singer.IntervalsActions.getCurrentKey(this.turIndex)}},{key:"CURRENTMODE",get:function(){return Singer.IntervalsActions.getCurrentMode(this.turIndex)}},{key:"MODELENGTH",get:function(){return Singer.IntervalsActions.getModeLength(this.turIndex)}},{key:"PANNING",set:function(t){var e=JSInterface.validateArgs("PANNING",[t]);Singer.VolumeActions.setPanning(e[0],this.turIndex)}},{key:"MASTERVOLUME",set:function(t){var e=JSInterface.validateArgs("MASTERVOLUME",[t]);Singer.VolumeActions.setMasterVolume(e[0],this.turIndex)},get:function(){return Singer.VolumeActions.masterVolume}}],[{key:"init",value:function init(start){function CreateAPIMethodList(){["Painter","Singer.RhythmActions","Singer.MeterActions","Singer.PitchActions","Singer.IntervalsActions","Singer.ToneActions","Singer.OrnamentActions","Singer.VolumeActions","Singer.DrumActions","Turtle.DictActions"].forEach(function(className){if(MusicBlocks._methodList[className]=[],"Painter"!==className){var _iterator2=_createForOfIteratorHelper(Object.getOwnPropertyNames(eval(className))),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _methodName=_step2.value;"length"!==_methodName&&"prototype"!==_methodName&&MusicBlocks._methodList[className].push(_methodName)}}catch(t){_iterator2.e(t)}finally{_iterator2.f()}}else{var _iterator=_createForOfIteratorHelper(Object.getOwnPropertyNames(eval(className+".prototype"))),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var methodName=_step.value;"constructor"===methodName||methodName.startsWith("_")||MusicBlocks._methodList[className].push(methodName)}}catch(t){_iterator.e(t)}finally{_iterator.f()}}})}start?(MusicBlocks.isRun=!0,CreateAPIMethodList()):(MusicBlocks.isRun=!1,MusicBlocks._methodList={});var _iterator3=_createForOfIteratorHelper(Mouse.AddedTurtles),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var turtle=_step3.value;turtle.container.visible=!1,turtle.inTrash=!0;var turIndex=globalActivity.turtles.getIndexOfTurtle(turtle);globalActivity.turtles.removeTurtle(turIndex)}}catch(t){_iterator3.e(t)}finally{_iterator3.f()}MusicBlocks._blockNo=-1,Mouse.MouseList=[],Mouse.TurtleMouseMap={}}},{key:"run",value:function(){var t,e=_createForOfIteratorHelper(Mouse.MouseList);try{for(e.s();!(t=e.n()).done;){var r=t.value;for(var n in r.turtle.listeners)globalActivity.logo.stage&&r.turtle.listeners.hasOwnProperty(n)&&globalActivity.logo.stage.removeEventListener(n,r.turtle.listeners[n],!1);r.turtle.listeners={}}}catch(t){e.e(t)}finally{e.f()}globalActivity.logo.prepSynths(),globalActivity.logo.firstNoteTime=null,Mouse.MouseList.forEach(function(t){return t.run()})}},{key:"BLK",get:function(){return"B"+MusicBlocks._blockNo++}}]),MusicBlocks}();_defineProperty(MusicBlocks,"_methodList",{}),_defineProperty(MusicBlocks,"_blockNo",-1),_defineProperty(MusicBlocks,"isRun",!1),"undefined"!=typeof module&&module.exports&&(module.exports={Mouse:Mouse,MusicBlocks:MusicBlocks});