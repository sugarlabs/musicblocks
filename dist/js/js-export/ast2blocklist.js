"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _defineProperty(e,r,t){return(r=_toPropertyKey(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function _slicedToArray(e,r){return _arrayWithHoles(e)||_iterableToArrayLimit(e,r)||_unsupportedIterableToArray(e,r)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,r){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var n,a,o,i,l=[],s=!0,c=!1;try{if(o=(t=t.call(e)).next,0===r){if(Object(t)!==t)return;s=!1}else for(;!(s=(n=o.call(t)).done)&&(l.push(n.value),l.length!==r);s=!0);}catch(e){c=!0,a=e}finally{try{if(!s&&null!=t.return&&(i=t.return(),Object(i)!==i))return}finally{if(c)throw a}}return l}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _createForOfIteratorHelper(e,r){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=_unsupportedIterableToArray(e))||r&&e&&"number"==typeof e.length){t&&(e=t);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,l=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return i=e.done,e},e:function(e){l=!0,o=e},f:function(){try{i||null==t.return||t.return()}finally{if(l)throw o}}}}function _unsupportedIterableToArray(e,r){if(e){if("string"==typeof e)return _arrayLikeToArray(e,r);var t={}.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,r):void 0}}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=Array(r);t<r;t++)n[t]=e[t];return n}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var r=_toPrimitive(e,"string");return"symbol"==_typeof(r)?r:r+""}function _toPrimitive(e,r){if("object"!=_typeof(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0===t)return("string"===r?String:Number)(e);var n=t.call(e,r||"default");if("object"!=_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}var AST2BlockList=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"toBlockList",value:function(e,r){return function(e,_){function b(e){var r,t=Array.isArray(e[1])?e[1][0]:e[1],n=_createForOfIteratorHelper(_.body_blocks);try{for(n.s();!(r=n.n()).done;){var a=r.value;if("name"in a&&a.name===t||"name_map"in a&&Object.values(a.name_map).includes(t)){var o={count:a.blocklist_connections?a.blocklist_connections.length:_.default_connections.length},i=a.blocklist_connections||_.default_connections,l=i.indexOf("parent_or_previous_sibling");-1!==l&&(o.prev=l);var s=i.indexOf("first_child");-1!==s&&(o.child=s);var c=i.indexOf("next_sibling");-1!==c&&(o.next=c);var u=i.indexOf("second_child");-1!==u&&(o.second_child=u);var f=a.default_vspaces||_.default_vspaces||{body:1};return"body"in f?{type:"block",connections:o,vspaces:f.body}:{type:"block",connections:o,argument_v_spaces:f.argument}}}}catch(e){n.e(e)}finally{n.f()}return{type:"block",connections:{count:2,prev:0,next:1},vspaces:1,argument_v_spaces:0}}var r,t=[],n=200,a=_createForOfIteratorHelper(e);try{for(a.s();!(r=a.n()).done;){var o=m(r.value,t).blockNumber;t[o][2]=n,t[o][3]=200,n+=300}}catch(e){a.e(e)}finally{a.f()}return t;function m(e,r){var t,n=[],a=r.length;n.push(a),r.push(n),"object"===_typeof(e.name)?(t=Object.keys(e.name)[0],n.push([t,{value:e.name[t]}])):"else"!==e.name&&n.push(e.name),n.push(0),n.push(0);var o=b(n),i=new Array(o.connections.count).fill(null);n.push(i);var l,s,c,u,f,p,v,y,d,h=function(e,r,t){if(void 0===e.arguments||0==e.arguments.length)return 0;var n,a=r[t],o=(b(a),0),i=Array.isArray(a[1])?a[1][0]:a[1],l=null,s=_createForOfIteratorHelper(_.body_blocks);try{for(s.s();!(n=s.n()).done;){var c=n.value;if(c.name===i){l=c;break}if(c.name_map)for(var u in c.name_map)i===c.name_map[u]&&(l=c,console.log(c),console.log(i))}}catch(e){s.e(e)}finally{s.f()}if(!l||!l.arguments)throw new Error("Cannot find argument configuration for: ".concat(i));for(var f=0;f<e.arguments.length;f++){var p,v=e.arguments[f],y=l.arguments[f];"note_or_solfege"===y.type?(p=new Set(["A","B","C","D","E","F","G"]),o+=O([p.has(v.charAt(0))?"notename":"solfege",{value:v}],f+1,r,t)):"ValueExpression"===y.type||"NumberExpression"===y.type||"BooleanExpression"===y.type?o+=A(v,f+1,r,t):o+=O([y.type,{value:"object"===_typeof(v)?v.identifier:v}],f+1,r,t)}return o}(e,r,a),m=Math.max(1,h);return void 0!==e.children&&0<e.children.length&&(s=-1!==(l=e.children.findIndex(function(e){return"else"===e.name}))?e.children.slice(0,l):e.children,c=-1!==l?e.children.slice(l+1):[],m+=(u=g(s,h-o.argument_v_spaces,r)).vspaces,void 0!==o.connections.child&&(i[o.connections.child]=u.firstChildBlockNumber,void 0!==(p=b(f=r[u.firstChildBlockNumber])).connections.prev&&(f[4][p.connections.prev]=a)),-1!==l&&(m+=(v=g(c,0,r)).vspaces,void 0!==o.connections.second_child&&(i[o.connections.second_child]=v.firstChildBlockNumber,void 0!==(d=b(y=r[v.firstChildBlockNumber])).connections.prev&&(y[4][d.connections.prev]=a)))),{blockNumber:a,vspaces:m}}function g(e,r,t){for(var n=[],a=0,o=0;o<r;o++)n.push(k(t)),a++;var i,l=_createForOfIteratorHelper(e);try{for(l.s();!(i=l.n()).done;){var s=m(i.value,t);n.push(s.blockNumber),a+=s.vspaces;for(var c=b(t[s.blockNumber]),u=0;u<s.vspaces-c.vspaces;u++)n.push(k(t))}}catch(e){l.e(e)}finally{l.f()}for(var f=1;f<n.length;f++){var p=t[n[f]],v=b(p);void 0!==v.connections.prev&&(p[4][v.connections.prev]=n[f-1])}for(var y=0;y<n.length-1;y++){var d=t[n[y]],h=b(d);void 0!==h.connections.next&&(d[4][h.connections.next]=n[y+1])}return{firstChildBlockNumber:n[0],vspaces:a}}function k(e){var r=[],t=e.length;return r.push(t),e.push(r),r.push("vspace"),r.push(0),r.push(0),r.push([null,null]),t}function O(e,r,t,n){var a=[],o=t.length;return a.push(o),t.push(a),a.push(e),a.push(0),a.push(0),a.push([n]),t[n][4][r]=o,1}function A(e,r,t,n){var a=0,o=[],i=t.length;o.push(i),t.push(o);var l=_typeof(e);if("string"===l&&(l="text"),"number"===l||"boolean"===l||"text"===l||"object"===l&&void 0!==e.identifier)o.push("object"===l?["namedbox",{value:e.identifier}]:[l,{value:e}]),o.push(0),o.push(0),o.push([n]),a=1;else{if("object"!==l)throw new Error("Unsupported value argument: ".concat(e));o.push(e.name),o.push(0),o.push(0);var s=new Array(1+e.arguments.length).fill(null);s[0]=n,o.push(s),a=function(e,r,t){for(var n=0,a=0;a<e.length;a++)n+=A(e[a],a+1,r,t);return n}(e.arguments,t,i),0===e.arguments.length&&(a+=1)}return t[n][4][r]=i,a}}(function(e,g){var r,v=g.argument_blocks,t={},n=_createForOfIteratorHelper(e.body);try{for(n.s();!(r=n.n()).done;){!function e(r,t){var n=h(r);if(null===n)throw{prefix:"Unsupported statement: ",start:r.start,end:r.end};if(!("name"in n))return;var a={};"name_property"in n.ast?a.name=_defineProperty({},n.name,k(r,n.ast.name_property)):a.name=n.name;if(void 0!==n.arguments){var o,i=[],l=_createForOfIteratorHelper(n.ast.argument_properties);try{for(l.s();!(o=l.n()).done;){var s=o.value;i.push(k(r,s))}}catch(e){l.e(e)}finally{l.f()}var c=m(i);0<c.length&&(a.arguments=c)}if(void 0!==n.ast.children_properties){var u,f=_createForOfIteratorHelper(k(r,n.ast.children_properties[0]));try{for(f.s();!(u=f.n()).done;){var p=u.value;"ReturnStatement"!=p.type&&e(p,a)}}catch(e){f.e(e)}finally{f.f()}if(1<n.ast.children_properties.length){a.children.push({name:"else"});var v,y=_createForOfIteratorHelper(k(r,n.ast.children_properties[1]));try{for(y.s();!(v=y.n()).done;){var d=v.value;"ReturnStatement"!=d.type&&e(d,a)}}catch(e){y.e(e)}finally{y.f()}}}void 0===t.children&&(t.children=[]);t.children.push(a)}(r.value,t)}}catch(e){n.e(e)}finally{n.f()}return console.log(JSON.stringify(t.children,null,2)),t.children;function k(e,r){var t,n=e,a=_createForOfIteratorHelper(r.split("."));try{for(a.s();!(t=a.n()).done;)var o=t.value,i=o.match(/(\w+)\[(\d+)\]/),n=i?(n=n[i[1]])[i[2]]:n[o]}catch(e){a.e(e)}finally{a.f()}return n}function h(e){var r,t=_createForOfIteratorHelper(g.body_blocks);try{for(t.s();!(r=t.n()).done;){var n=r.value;if("ast"in n){var a,o={},i=_createForOfIteratorHelper(n.ast.identifiers);try{for(i.s();!(a=i.n()).done;){var l=a.value;o[l.property]||(o[l.property]=[]),o[l.property].push(l)}}catch(e){i.e(e)}finally{i.f()}for(var s,c=!0,u=0,f=Object.entries(o);u<f.length;u++){var p,v=_slicedToArray(f[u],2),y=v[0],d=v[1],h=k(e,y),m=!1,_=_createForOfIteratorHelper(d);try{for(_.s();!(p=_.n()).done;){var b=p.value;if("value"in b){if(h===b.value){m=!0;break}}else{if("has_value"in b&&(!b.has_value&&null==h||b.has_value&&null!=h)){m=!0;break}if(!("has_value"in b)&&b.size===h.length){m=!0;break}}}}catch(e){_.e(e)}finally{_.f()}if(!m){c=!1;break}}if(c)return!n.name_map||(s=k(e,"expression.argument.callee.property.name"))&&n.name_map[s]&&(console.log(n.name_map[s]),n.name=n.name_map[s]),n}}}catch(e){t.e(e)}finally{t.f()}return null}function m(e){var r,t=[],n=_createForOfIteratorHelper(e);try{for(n.s();!(r=n.n()).done;){var a=r.value,o=null,i=function(e){var r,t=_createForOfIteratorHelper(v);try{for(t.s();!(r=t.n()).done;){var n,a=r.value,o=a.ast,i=!0,l=_createForOfIteratorHelper(o.identifiers);try{for(l.s();!(n=l.n()).done;){var s=n.value,c=k(e,s.property);if("size"in s){if(c.length!==s.size){i=!1;break}}else if(c!==s.value){i=!1;break}}}catch(e){l.e(e)}finally{l.f()}if(i)return a}}catch(e){t.e(e)}finally{t.f()}return null}(a);if(!i)throw{prefix:"Unsupported argument type ".concat(a.type,": "),start:a.start,end:a.end};if("value_property"in i.ast)o=k(a,i.ast.value_property);else if(i.ast.identifier_property)o={identifier:k(a,i.ast.identifier_property)};else{var l=k(a,i.ast.name_property);if(!(l in i.name_map))throw{prefix:"Unsupported operator ".concat(l,": "),start:a.start,end:a.end};var s=i.name_map[l],c=[];if("arguments_property"in i.ast)c=k(a,i.ast.arguments_property);else{var u,f=_createForOfIteratorHelper(i.ast.argument_properties);try{for(f.s();!(u=f.n()).done;){var p=u.value;c.push(k(a,p))}}catch(e){f.e(e)}finally{f.f()}}if("object"===_typeof(s)&&(s=s[c.length]),void 0===s)throw{prefix:"Unsupported argument count for ".concat(l,": "),start:a.start,end:a.end};o={name:s,arguments:m(c)}}null!==o&&t.push(o)}}catch(e){n.e(e)}finally{n.f()}return t}}(e,r),r)}}]),e}();"undefined"!=typeof module&&module.exports&&(module.exports={AST2BlockList:AST2BlockList});