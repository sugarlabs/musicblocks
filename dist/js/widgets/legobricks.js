"use strict";function asyncGeneratorStep(t,e,o,i,n,r,a){try{var l=t[r](a),s=l.value}catch(t){return void o(t)}l.done?e(s):Promise.resolve(s).then(i,n)}function _asyncToGenerator(l){return function(){var t=this,a=arguments;return new Promise(function(e,o){var i=l.apply(t,a);function n(t){asyncGeneratorStep(i,e,o,n,r,"next",t)}function r(t){asyncGeneratorStep(i,e,o,n,r,"throw",t)}n(void 0)})}}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(t,e){var o=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=o){var i,n,r,a,l=[],s=!0,c=!1;try{if(r=(o=o.call(t)).next,0===e){if(Object(o)!==o)return;s=!1}else for(;!(s=(i=r.call(o)).done)&&(l.push(i.value),l.length!==e);s=!0);}catch(t){c=!0,n=t}finally{try{if(!s&&null!=o.return&&(a=o.return(),Object(a)!==a))return}finally{if(c)throw n}}return l}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _createForOfIteratorHelper(t,e){var o="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!o){if(Array.isArray(t)||(o=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){o&&(t=o);var i=0,n=function(){};return{s:n,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,a=!0,l=!1;return{s:function(){o=o.call(t)},n:function(){var t=o.next();return a=t.done,t},e:function(t){l=!0,r=t},f:function(){try{a||null==o.return||o.return()}finally{if(l)throw r}}}}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var o={}.toString.call(t).slice(8,-1);return"Object"===o&&t.constructor&&(o=t.constructor.name),"Map"===o||"Set"===o?Array.from(t):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var o=0,i=Array(e);o<e;o++)i[o]=t[o];return i}function LegoWidget(){this.matrixData={rows:[{type:"pitch",label:"High C (Do)",icon:"HighC.png",color:"pitch-row",note:"C5"},{type:"pitch",label:"B (Ti)",icon:"B.png",color:"pitch-row",note:"B4"},{type:"pitch",label:"A (La)",icon:"A.png",color:"pitch-row",note:"A4"},{type:"pitch",label:"G (So)",icon:"G.png",color:"pitch-row",note:"G4"},{type:"pitch",label:"F (Fa)",icon:"F.png",color:"pitch-row",note:"F4"},{type:"pitch",label:"E (Mi)",icon:"E.png",color:"pitch-row",note:"E4"},{type:"pitch",label:"D (Re)",icon:"D.png",color:"pitch-row",note:"D4"},{type:"pitch",label:"Middle C (Do)",icon:"MiddleC.png",color:"pitch-row",note:"C4"},{type:"pitch",label:"B (Low Ti)",icon:"LowB.png",color:"pitch-row",note:"B3"},{type:"pitch",label:"Low C (Low Do)",icon:"LowC.png",color:"pitch-row",note:"C3"},{type:"pitch",label:"Zoom Controls",icon:"LowC.png",color:"pitch-row"}],columns:8,selectedCells:new Set},this.widgetWindow=null,this.activity=null,this.isPlaying=!1,this.isDragging=!1,this.currentZoom=1,this.verticalSpacing=50,this.imageWrapper=null,this.synth=null,this.selectedInstrument="electronic synth",this.hasGeneratedVisualization=!1,this.eyeDropperMode=!1,this.selectedBackgroundColor={name:"green",hue:120},this.eyeDropperCursor=null,this.blockNo=null,this.rowLabels=[],this.rowArgs=[],this._rowBlocks=[],this._rowMap=[],this._rowOffset=[],this._notesToPlay=[],this.clearBlocks=function(){this._rowBlocks=[],this._rowMap=[],this._rowOffset=[]},this.addRowBlock=function(t){for(this._rowMap.push(this._rowBlocks.length),this._rowOffset.push(0);this._rowBlocks.includes(t);)t+=1e6;this._rowBlocks.push(t)},this._generateRowsFromPitchBlocks=function(){this.matrixData.rows=[];for(var t=[],e=0;e<this.rowLabels.length;e++){var o=this.rowLabels[e],i=this.rowArgs[e];if(-1!==i){var n=o+i,r=o,r="do"===o?"Do":"re"===o?"Re":"mi"===o?"Mi":"fa"===o?"Fa":"sol"===o?"So":"la"===o?"La":"ti"===o?"Ti":o.toUpperCase(),a=0;try{a="undefined"!=typeof noteToFrequency?noteToFrequency(n,this.activity.turtles.ithTurtle(0).singer.keySignature):this._calculateFallbackFrequency(o,i)}catch(t){a=this._calculateFallbackFrequency(o,i)}t.push({frequency:a,type:"pitch",label:r+" ("+i+")",icon:"pitch.svg",color:"pitch-row",note:n,pitch:o,octave:i})}}t.sort(function(t,e){return e.frequency-t.frequency}),this.matrixData.rows=t,this.matrixData.rows.push({type:"control",label:"Zoom Controls",icon:"zoom.svg",color:"control-row"}),0===this.rowLabels.length&&(this.matrixData.rows=[{type:"pitch",label:"E4 (Mi)",icon:"pitch.svg",color:"pitch-row",note:"E4"},{type:"pitch",label:"D4 (Re)",icon:"pitch.svg",color:"pitch-row",note:"D4"},{type:"pitch",label:"C4 (Middle C)",icon:"pitch.svg",color:"pitch-row",note:"C4"},{type:"control",label:"Zoom Controls",icon:"zoom.svg",color:"control-row"}])},this._calculateFallbackFrequency=function(t,e){var o={C:261.63,do:261.63,D:293.66,re:293.66,E:329.63,mi:329.63,F:349.23,fa:349.23,G:392,sol:392,A:440,la:440,B:493.88,ti:493.88};return(o[t.toLowerCase()]||o[t.toUpperCase()]||o.C)*Math.pow(2,e-4)},this.init=function(t){var e=this;this.activity=t,this.running=!0,this._initAudio();var o=window.widgetWindows.windowFor(this,"LEGO BRICKS");(this.widgetWindow=o).clear(),o.show();o.onclose=function(){e._stopWebcam(),e._deactivateEyeDropper(),e.running=!1,o.destroy()},o.onmaximize=this._scale.bind(this),this.playButton=o.addButton("play-button.svg",32,_("Play")),this.playButton.onclick=function(){e._playPhrase()},this.saveButton=o.addButton("save-button.svg",32,_("Save")),this.saveButton.onclick=function(){e._savePhrase()},this.exportButton=o.addButton("export-button.svg",32,_("Export")),this.exportButton.onclick=function(){e._exportPhrase()},this.uploadButton=o.addButton("upload-button.svg",32,_("Upload Image")),this.uploadButton.onclick=function(){e._uploadImage()},this.webcamButton=o.addButton("webcam-button.svg",32,_("Webcam")),this.webcamButton.onclick=function(){e._startWebcam()},this.clearButton=o.addButton("clear-button.svg",32,_("Clear")),this.clearButton.onclick=function(){e._clearPhrase()},this.createMainContainer(),o.sendToCenter(),this.widgetWindow=o,this._generateRowsFromPitchBlocks(),this._initializeRowHeaders(),this._scale(),this.activity.textMsg(_("LEGO Bricks - Phrase Maker with")+" "+this.rowLabels.length+" "+_("pitch rows (sorted by frequency, Instrument: "+this.selectedInstrument+")"))},this._initAudio=function(){this.synth=new Synth,this.synth.loadSamples(),this.synth.createSynth(0,this.selectedInstrument,this.selectedInstrument,null)},this._playNote=function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.5;if(this.synth)try{this.synth.trigger(0,t,e,this.selectedInstrument,null,null,!1,0)}catch(t){console.error("Error playing note:",t)}},this._initializeRowHeaders=function(){var a=this;this.rowHeaderTable.innerHTML="",this.rowHeaderTable.style.margin="0",this.rowHeaderTable.style.padding="0",this.rowHeaderTable.style.borderSpacing="0",this.matrixData.rows.forEach(function(t,e){var o=a.rowHeaderTable.insertRow();o.style.height="40px",o.style.margin="0",o.style.padding="0",o.style.position="relative";var i=o.insertCell();i.style.display="flex",i.style.alignItems="center",i.style.padding="0 8px",i.style.margin="0",i.style.fontSize="13px",i.style.fontWeight="bold",i.style.border="none",i.style.backgroundColor="pitch"===t.type?"#77C428":"#87ceeb",i.style.gap="8px",i.style.height="40px",i.style.lineHeight="40px",i.style.boxSizing="border-box",i.style.cursor=t.note?"pointer":"default",t.note&&(i.onclick=function(){a._playNote(t.note)},i.onmousedown=function(){i.style.transform="scale(0.98)",i.style.boxShadow="inset 0 0 8px rgba(0,0,0,0.2)"},i.onmouseup=function(){i.style.transform="",i.style.boxShadow=""},i.onmouseleave=function(){i.style.transform="",i.style.boxShadow=""});var n,r=document.createElement("div");r.style.width="24px",r.style.height="24px",r.style.backgroundColor="#fff",r.style.borderRadius="50%",r.style.marginRight="6px",r.style.flexShrink="0",i.appendChild(r),i.appendChild(document.createTextNode(t.label)),e<a.matrixData.rows.length-1&&((n=document.createElement("div")).style.position="absolute",n.style.left="0",n.style.right="0",n.style.bottom="0",n.style.height="2px",n.style.backgroundColor="red",n.style.zIndex="5",o.appendChild(n))})},this.createMainContainer=function(){var e=this,t=document.createElement("div");t.style.display="flex",t.style.height="100%",t.style.overflow="hidden",t.style.position="relative";var o=document.createElement("div");o.style.display="flex",o.style.flex="1",o.style.overflow="hidden";var i=document.createElement("div");i.style.flex="0 0 auto",i.style.backgroundColor="#cccccc",i.style.overflowY="auto",i.style.width="180px",i.style.borderRight="2px solid #888",this.rowHeaderTable=document.createElement("table"),this.rowHeaderTable.style.borderCollapse="collapse",this.rowHeaderTable.style.width="100%",i.appendChild(this.rowHeaderTable);var n=document.createElement("div");n.style.flex="1",n.style.height="100%",n.style.backgroundColor="#f5f5f5",n.style.display="flex",n.style.flexDirection="column",n.style.overflow="hidden",n.style.position="relative",this.imageDisplayArea=document.createElement("div"),this.imageDisplayArea.style.position="relative",this.imageDisplayArea.style.flex="1",this.imageDisplayArea.style.display="flex",this.imageDisplayArea.style.alignItems="center",this.imageDisplayArea.style.justifyContent="center",this.imageDisplayArea.style.padding="0",this.imageDisplayArea.style.overflow="hidden",this.imagePlaceholder=document.createElement("div"),this.imagePlaceholder.style.color="#888",this.imagePlaceholder.style.fontSize="16px",this.imagePlaceholder.style.textAlign="center",this.imagePlaceholder.style.fontStyle="italic",this.imagePlaceholder.textContent="Click upload button to add an image",this.imageDisplayArea.appendChild(this.imagePlaceholder),this.gridOverlay=document.createElement("div"),this.gridOverlay.style.position="absolute",this.gridOverlay.style.top="0",this.gridOverlay.style.left="0",this.gridOverlay.style.right="0",this.gridOverlay.style.bottom="0",this.gridOverlay.style.pointerEvents="none",this.gridOverlay.style.zIndex="10",n.appendChild(this.imageDisplayArea),n.appendChild(this.gridOverlay),this.createZoomControls(),n.appendChild(this.zoomControls),o.appendChild(i),o.appendChild(n),t.appendChild(o),this.widgetWindow.getWidgetBody().appendChild(t),this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.accept="image/*",this.fileInput.style.display="none",this.fileInput.onchange=function(t){return e._handleImageUpload(t)},document.body.appendChild(this.fileInput),this._initializeRowHeaders()},this.createZoomControls=function(){var t=this;this.zoomControls=document.createElement("div"),this.zoomControls.style.position="absolute",this.zoomControls.style.bottom="0",this.zoomControls.style.left="180px",this.zoomControls.style.right="0",this.zoomControls.style.padding="10px",this.zoomControls.style.backgroundColor="#f0f0f0",this.zoomControls.style.borderTop="1px solid #888",this.zoomControls.style.display="flex",this.zoomControls.style.alignItems="center",this.zoomControls.style.gap="8px",this.zoomControls.style.zIndex="20";var e=document.createElement("span");e.textContent="Instrument:",e.style.fontSize="12px",e.style.fontWeight="bold",this.instrumentButton=document.createElement("button"),this.instrumentButton.textContent=this.selectedInstrument.charAt(0).toUpperCase()+this.selectedInstrument.slice(1),this.instrumentButton.style.fontSize="12px",this.instrumentButton.style.marginRight="16px",this.instrumentButton.style.padding="4px 8px",this.instrumentButton.style.border="1px solid #ccc",this.instrumentButton.style.borderRadius="4px",this.instrumentButton.style.backgroundColor="#f8f8f8",this.instrumentButton.style.cursor="pointer",this.instrumentButton.onclick=function(){return t._createInstrumentPieMenu()};var o=document.createElement("span");o.textContent="Zoom:",o.style.fontSize="12px";var i=document.createElement("button");i.textContent="âˆ’",i.onclick=function(){return t._adjustZoom(-.01)},this.zoomSlider=document.createElement("input"),this.zoomSlider.type="range",this.zoomSlider.min="0.1",this.zoomSlider.max="3",this.zoomSlider.step="0.01",this.zoomSlider.value="1",this.zoomSlider.style.width="100px",this.zoomSlider.oninput=function(){return t._handleZoom()};var n=document.createElement("button");n.textContent="+",n.onclick=function(){return t._adjustZoom(.01)},this.zoomValue=document.createElement("span"),this.zoomValue.textContent="100%",this.zoomValue.style.fontSize="12px",this.zoomValue.style.minWidth="40px";var r=document.createElement("span");r.textContent="|",r.style.margin="0 8px",r.style.color="#888";var a=document.createElement("span");a.textContent="Column Spacing:",a.style.fontSize="12px";var l=document.createElement("button");l.textContent="âˆ’",l.onclick=function(){return t._adjustVerticalSpacing(-5)},this.spacingSlider=document.createElement("input"),this.spacingSlider.type="range",this.spacingSlider.min="2",this.spacingSlider.max="200",this.spacingSlider.step="1",this.spacingSlider.value="50",this.spacingSlider.style.width="100px",this.spacingSlider.oninput=function(){return t._handleVerticalSpacing()};var s=document.createElement("button");s.textContent="+",s.onclick=function(){return t._adjustVerticalSpacing(1)},this.spacingValue=document.createElement("span"),this.spacingValue.textContent="50px",this.spacingValue.style.fontSize="12px",this.spacingValue.style.minWidth="40px";var c=document.createElement("span");c.textContent="|",c.style.margin="0 8px",c.style.color="#888";var h=document.createElement("span");h.textContent="Eye Dropper:",h.style.fontSize="12px",h.style.fontWeight="bold",this.eyeDropperButton=document.createElement("button"),this.eyeDropperButton.textContent="ðŸŽ¨",this.eyeDropperButton.style.fontSize="12px",this.eyeDropperButton.style.padding="4px 8px",this.eyeDropperButton.style.border="1px solid #ccc",this.eyeDropperButton.style.borderRadius="4px",this.eyeDropperButton.style.backgroundColor="#f8f8f8",this.eyeDropperButton.style.cursor="pointer",this.eyeDropperButton.title="Click to activate eye dropper mode",this.eyeDropperButton.onclick=function(){return t._toggleEyeDropper()};var u=document.createElement("span");u.textContent="|",u.style.margin="0 8px",u.style.color="#888";var d=document.createElement("span");d.textContent="Background:",d.style.fontSize="12px",d.style.fontWeight="bold",this.backgroundColorDisplay=document.createElement("span"),this.backgroundColorDisplay.textContent=this.selectedBackgroundColor.name,this.backgroundColorDisplay.style.fontSize="12px",this.backgroundColorDisplay.style.padding="4px 8px",this.backgroundColorDisplay.style.border="1px solid #ccc",this.backgroundColorDisplay.style.borderRadius="4px",this.backgroundColorDisplay.style.backgroundColor=this._getColorHex(this.selectedBackgroundColor.name),this.backgroundColorDisplay.style.color=this._getContrastColor(this.selectedBackgroundColor.name),this.backgroundColorDisplay.style.minWidth="60px",this.backgroundColorDisplay.style.textAlign="center",this.zoomControls.appendChild(e),this.zoomControls.appendChild(this.instrumentButton),this.zoomControls.appendChild(o),this.zoomControls.appendChild(i),this.zoomControls.appendChild(this.zoomSlider),this.zoomControls.appendChild(n),this.zoomControls.appendChild(this.zoomValue),this.zoomControls.appendChild(r),this.zoomControls.appendChild(a),this.zoomControls.appendChild(l),this.zoomControls.appendChild(this.spacingSlider),this.zoomControls.appendChild(s),this.zoomControls.appendChild(this.spacingValue),this.zoomControls.appendChild(c),this.zoomControls.appendChild(h),this.zoomControls.appendChild(this.eyeDropperButton),this.zoomControls.appendChild(u),this.zoomControls.appendChild(d),this.zoomControls.appendChild(this.backgroundColorDisplay)},this._initializeMatrix=function(){var n=this;this.matrixTable.innerHTML="",this.matrixData.rows.forEach(function(t,e){var o=n.matrixTable.insertRow().insertCell();o.style.width="180px",o.style.height="40px",o.style.display="flex",o.style.alignItems="center",o.style.padding="0 8px",o.style.fontSize="13px",o.style.fontWeight="bold",o.style.border="1px solid #888",o.style.position="sticky",o.style.left="0",o.style.zIndex="10",o.style.gap="8px",o.style.backgroundColor="pitch"===t.type?"#77C428":"#87ceeb";var i=document.createElement("div");i.style.width="24px",i.style.height="24px",i.style.backgroundColor="#fff",i.style.borderRadius="50%",i.style.marginRight="6px",o.appendChild(i),o.appendChild(document.createTextNode(t.label))})},this._savePhrase=function(){if(this.colorData&&0!==this.colorData.length)if(this._collectNotesToPlay(),0!==this._notesToPlay.length){for(var t in this.activity.blocks.palettes.dict)this.activity.blocks.palettes.dict[t].hideMenu(!0);this.activity.refreshCanvas();for(var e=[[0,["action",{collapsed:!0}],100,100,[null,1,null,null]],[1,["text",{value:_("LEGO phrase")}],0,0,[0]]],o=0,i=0;i<this._notesToPlay.length;i++){var n=this._notesToPlay[i],r=e.length;e.push([r,"newnote",0,0,[o,r+1,r+2,null]]);var a=e[r][4].length;0===i?e[o][4][a-2]=r:e[o][4][a-1]=r,o=r;e.push([r+1,"vspace",0,0,[r,r+5]]);var l=void 0,s=void 0,s=1.5===n.noteValue?(l=3,2):.5===n.noteValue?(l=1,2):Number.isInteger(n.noteValue)?(l=1,n.noteValue):(l=1,Math.round(1/n.noteValue));e.push([r+2,"divide",0,0,[r,r+3,r+4]]),e.push([r+3,["number",{value:l}],0,0,[r+2]]),e.push([r+4,["number",{value:s}],0,0,[r+2]]),e[r][4][1]=r+2,e[r][4][2]=r+1;var c=null,h=r+1,u=r+5;if(0===n.pitches.length||n.isRest)e.push([u,"rest2",0,0,[h,c]]);else for(var d=0;d<n.pitches.length;d++){var p=n.pitches[d],c=d===n.pitches.length-1?null:u+3;e.push([u,"pitch",0,0,[h,u+1,u+2,c]]),e.push([u+1,["solfege",{value:p.solfege}],0,0,[u]]),e.push([u+2,["number",{value:p.octave}],0,0,[u]]),h=(u+=3)-3}}this.activity.blocks.loadNewBlocks(e),this.activity.textMsg(_("LEGO phrase saved as action blocks with ")+this._notesToPlay.length+_(" notes"))}else this.activity.textMsg(_("No notes detected from color scanning."));else this.activity.textMsg(_("No color data to save. Please scan an image first."))},this._collectNotesToPlay=function(){var d=this;if(this._notesToPlay=[],this.colorData&&0!==this.colorData.length)for(var t=this._analyzeColumnBoundaries(),i=this._filterSmallSegments(t),e=0;e<i.length-1;e++)!function(t){var s=i[t],c=i[t+1],e=c-s,o=void 0,o=e<750?8:e<1500?4:e<3e3?2:1,h=!1,u=[];d.colorData.forEach(function(t,e){if(t.colorSegments){var o,i=0,n=_createForOfIteratorHelper(t.colorSegments);try{for(n.s();!(o=n.n()).done;){var r,a=o.value,l=i+a.duration;i<c&&s<l&&(r=Math.max(i,s),1e3<Math.min(l,c)-r?a.color!==d.selectedBackgroundColor.name&&function(){h=!0;var e=d._convertRowToPitch(t);e&&!u.some(function(t){return t.solfege===e.solfege&&t.octave===e.octave})&&u.push(e)}():(a.color,d.selectedBackgroundColor.name)),i+=a.duration}}catch(t){n.e(t)}finally{n.f()}}}),d._notesToPlay.push({pitches:u,noteValue:o,duration:e,isRest:!h||0===u.length})}(e)},this._filterSmallSegments=function(t){if(t.length<=2)return t;for(var e=[t[0]],o=1;o<t.length;o++){1e3<=t[o]-e[e.length-1]&&e.push(t[o])}return 1===e.length&&1<t.length&&e.push(t[t.length-1]),e},this._analyzeColumnBoundaries=function(){var o=new Set([0]);this.colorData.forEach(function(t){var e;t.colorSegments&&(e=0,t.colorSegments.forEach(function(t){e+=t.duration,o.add(e)}))});for(var t=Array.from(o).sort(function(t,e){return t-e}),e=[t[0]],i=1;i<t.length;i++)500<t[i]-e[e.length-1]&&e.push(t[i]);return e},this._convertRowToPitch=function(t){if(!t.note)return null;var e=t.note.match(/^([A-G][#b]?)(\d+)$/);if(!e)return null;var o=e[1],i=parseInt(e[2]);return{solfege:{C:"do","C#":"doâ™¯",Db:"reâ™­",D:"re","D#":"reâ™¯",Eb:"miâ™­",E:"mi",F:"fa","F#":"faâ™¯",Gb:"solâ™­",G:"sol","G#":"solâ™¯",Ab:"laâ™­",A:"la","A#":"laâ™¯",Bb:"tiâ™­",B:"ti"}[o]||"do",octave:i}},this._exportPhrase=function(){var t={selectedCells:Array.from(this.matrixData.selectedCells),rows:this.matrixData.rows.map(function(t){return{type:t.type,label:t.label}})};this.activity.textMsg(_("Exporting phrase data: ")+JSON.stringify(t))},this._clearPhrase=function(){this.matrixData.selectedCells.clear(),this.matrixTable.querySelectorAll("[data-cell-id]").forEach(function(t){t.style.backgroundColor="";var e=t.querySelector(".cell-dot");e&&t.removeChild(e)}),this.activity.textMsg(_("Phrase cleared"))},this._uploadImage=function(){this.fileInput.click()},this._handleImageUpload=function(t){var e,o=this,i=t.target.files[0];i&&i.type.startsWith("image/")&&((e=new FileReader).onload=function(t){o.imageDisplayArea.innerHTML="",o.imageWrapper=document.createElement("div"),o.imageWrapper.style.position="absolute",o.imageWrapper.style.left="0px",o.imageWrapper.style.top="0px",o.imageWrapper.style.transformOrigin="top left",o.imageWrapper.style.cursor="grab";var e=document.createElement("img");e.src=t.target.result,e.style.maxWidth="100%",e.style.maxHeight="100%",e.style.objectFit="contain",e.style.borderRadius="8px",e.style.boxShadow="0 2px 8px rgba(0,0,0,0.2)",o.imageWrapper.appendChild(e),o.imageDisplayArea.appendChild(o.imageWrapper),o._makeImageDraggable(o.imageWrapper),o._showZoomControls(),o._drawGridLines(),o.activity.textMsg(_("Image uploaded successfully"))},e.readAsDataURL(i))},this._startWebcam=function(){var e=this;this.imageDisplayArea.innerHTML="",this.imageWrapper=document.createElement("div"),this.imageWrapper.style.position="absolute",this.imageWrapper.style.left="0px",this.imageWrapper.style.top="0px",this.imageWrapper.style.transformOrigin="top left",this.imageWrapper.style.cursor="grab",this.webcamVideo=document.createElement("video"),this.webcamVideo.autoplay=!0,this.webcamVideo.playsInline=!0,this.webcamVideo.style.maxWidth="100%",this.webcamVideo.style.maxHeight="100%",this.imageWrapper.appendChild(this.webcamVideo),this.imageDisplayArea.appendChild(this.imageWrapper),navigator.mediaDevices.getUserMedia({video:!0}).then(function(t){e.webcamVideo.srcObject=t,e._makeImageDraggable(e.imageWrapper),e._showZoomControls(),e._drawGridLines(),e.activity.textMsg(_("Webcam started"))}).catch(function(t){e.activity.textMsg(_("Webcam access denied: ")+t.message)})},this._stopWebcam=function(){this.webcamVideo&&this.webcamVideo.srcObject&&this.webcamVideo.srcObject.getTracks().forEach(function(t){return t.stop()})},this._toggleEyeDropper=function(){this.eyeDropperMode=!this.eyeDropperMode,this.eyeDropperMode?this._activateEyeDropper():this._deactivateEyeDropper()},this._activateEyeDropper=function(){this.imageDisplayArea&&(this.imageDisplayArea.style.cursor="crosshair"),this.eyeDropperButton.style.backgroundColor="#4CAF50",this.eyeDropperButton.style.color="white",this.imageDisplayArea&&(this.imageDisplayArea.addEventListener("mousemove",this._handleEyeDropperHover),this.imageDisplayArea.addEventListener("click",this._handleEyeDropperClick),this.imageDisplayArea.addEventListener("mouseleave",this._handleEyeDropperLeave)),this._createColorPreviewTooltip(),this.activity.textMsg(_("Eye dropper active - hover over image to preview colors, click to select background color"))},this._deactivateEyeDropper=function(){this.imageDisplayArea&&(this.imageDisplayArea.style.cursor="default"),this.eyeDropperButton.style.backgroundColor="",this.eyeDropperButton.style.color="",this.imageDisplayArea&&(this.imageDisplayArea.removeEventListener("mousemove",this._handleEyeDropperHover),this.imageDisplayArea.removeEventListener("click",this._handleEyeDropperClick),this.imageDisplayArea.removeEventListener("mouseleave",this._handleEyeDropperLeave)),this._removeColorPreviewTooltip()},this._handleEyeDropperClick=function(t){t.preventDefault(),t.stopPropagation(),this.colorPreviewTooltip&&(this.colorPreviewTooltip.style.display="none");var e=this._sampleColorAtPosition(t.clientX,t.clientY);e?(this.selectedBackgroundColor=e,this._deactivateEyeDropper(),this.eyeDropperMode=!1,this._updateBackgroundColorDisplay(),this.activity.textMsg(_("Background color selected: ")+e.name)):this.activity.textMsg(_("Could not sample color - please try clicking on the image"))}.bind(this),this._sampleColorAtPosition=function(t,e){var o=null;if(this.imageWrapper&&(o=this.imageWrapper.querySelector("img")||this.imageWrapper.querySelector("video")),!o)return null;var i=document.createElement("canvas"),n=i.getContext("2d");i.width=o.naturalWidth||o.videoWidth||o.width,i.height=o.naturalHeight||o.videoHeight||o.height;try{n.drawImage(o,0,0,i.width,i.height)}catch(t){return console.log("Could not draw media element to canvas for color sampling:",t),null}var r=o.getBoundingClientRect(),a=(t-r.left)/r.width*i.width,l=(e-r.top)/r.height*i.height;if(a<0||a>=i.width||l<0||l>=i.height)return null;var s=_slicedToArray(n.getImageData(Math.floor(a),Math.floor(l),1,1).data,3),c=s[0],h=s[1],u=s[2],d=this._rgbToHsl(c,h,u);return this._getColorFamily(d[0],d[1],d[2])},this._createColorPreviewTooltip=function(){this.colorPreviewTooltip&&this._removeColorPreviewTooltip(),this.colorPreviewTooltip=document.createElement("div"),this.colorPreviewTooltip.style.position="absolute",this.colorPreviewTooltip.style.backgroundColor="rgba(0, 0, 0, 0.8)",this.colorPreviewTooltip.style.color="white",this.colorPreviewTooltip.style.padding="8px 12px",this.colorPreviewTooltip.style.borderRadius="6px",this.colorPreviewTooltip.style.fontSize="12px",this.colorPreviewTooltip.style.fontWeight="bold",this.colorPreviewTooltip.style.pointerEvents="none",this.colorPreviewTooltip.style.zIndex="1000",this.colorPreviewTooltip.style.display="none",this.colorPreviewTooltip.style.boxShadow="0 2px 8px rgba(0,0,0,0.3)",this.colorSwatch=document.createElement("div"),this.colorSwatch.style.width="20px",this.colorSwatch.style.height="20px",this.colorSwatch.style.border="2px solid white",this.colorSwatch.style.borderRadius="3px",this.colorSwatch.style.display="inline-block",this.colorSwatch.style.marginRight="8px",this.colorSwatch.style.verticalAlign="middle",this.colorPreviewTooltip.appendChild(this.colorSwatch),this.colorPreviewText=document.createElement("span"),this.colorPreviewText.style.verticalAlign="middle",this.colorPreviewTooltip.appendChild(this.colorPreviewText),document.body.appendChild(this.colorPreviewTooltip)},this._removeColorPreviewTooltip=function(){this.colorPreviewTooltip&&(document.body.removeChild(this.colorPreviewTooltip),this.colorPreviewTooltip=null,this.colorSwatch=null,this.colorPreviewText=null)},this._handleEyeDropperHover=function(t){var e;this.eyeDropperMode&&this.colorPreviewTooltip&&((e=this._sampleColorAtPosition(t.clientX,t.clientY))?(this.colorSwatch.style.backgroundColor=this._getColorHex(e.name),this.colorPreviewText.textContent=e.name.charAt(0).toUpperCase()+e.name.slice(1),this.colorPreviewTooltip.style.left=t.clientX+15+"px",this.colorPreviewTooltip.style.top=t.clientY-40+"px",this.colorPreviewTooltip.style.display="block"):this.colorPreviewTooltip.style.display="none")}.bind(this),this._handleEyeDropperLeave=function(t){this.colorPreviewTooltip&&(this.colorPreviewTooltip.style.display="none")}.bind(this),this._updateBackgroundColorDisplay=function(){this.backgroundColorDisplay&&(this.backgroundColorDisplay.textContent=this.selectedBackgroundColor.name,this.backgroundColorDisplay.style.backgroundColor=this._getColorHex(this.selectedBackgroundColor.name),this.backgroundColorDisplay.style.color=this._getContrastColor(this.selectedBackgroundColor.name))},this._getColorHex=function(t){return{red:"#FF0000",orange:"#FFA500",yellow:"#FFFF00",green:"#00FF00",blue:"#0000FF",purple:"#800080",pink:"#FFC0CB",cyan:"#00FFFF",magenta:"#FF00FF",white:"#FFFFFF",black:"#000000",gray:"#808080"}[t]||"#808080"},this._getContrastColor=function(t){return["white","yellow","cyan","pink","orange"].includes(t)?"#000000":"#FFFFFF"},this._makeImageDraggable=function(i){var n,r,a,l,s=!1;i.style.width="100%",i.style.height="100%",i.style.overflow="hidden",i.onmousedown=function(t){s=!0,n=t.clientX,r=t.clientY,a=parseFloat(i.style.left)||0,l=parseFloat(i.style.top)||0,i.style.cursor="grabbing",t.preventDefault()},document.onmousemove=function(t){var e,o;s&&(e=t.clientX-n,o=t.clientY-r,i.style.left="".concat(a+e,"px"),i.style.top="".concat(l+o,"px"))},document.onmouseup=function(){s&&(s=!1,i.style.cursor="grab")}},this._getColorFamily=function(t,e,o){var i=_slicedToArray(this._rgbToHsl(t,e,o),3),n=i[0],r=i[1],a=i[2];if(a<15)return{name:"black",hue:n,saturation:r,lightness:a};if(r<20)return 85<a?{name:"white",hue:n,saturation:r,lightness:a}:a<25?{name:"black",hue:n,saturation:r,lightness:a}:{name:"gray",hue:n,saturation:r,lightness:a};var l="unknown";return 345<=n||n<15?l="red":15<=n&&n<45?l="orange":45<=n&&n<75?l="yellow":75<=n&&n<165?l="green":165<=n&&n<195?l="cyan":195<=n&&n<255?l="blue":255<=n&&n<285?l="purple":285<=n&&n<315?l="magenta":315<=n&&n<345&&(l="pink"),{name:l,hue:n,saturation:r,lightness:a}},this._getColorFamily=function(t,e,o){return e<15?85<o?{name:"white",hue:0}:o<15?{name:"black",hue:0}:{name:"gray",hue:0}:345<=t||t<15?{name:"red",hue:0}:15<=t&&t<45?{name:"orange",hue:30}:45<=t&&t<75?{name:"yellow",hue:60}:75<=t&&t<165?{name:"green",hue:120}:165<=t&&t<195?{name:"cyan",hue:180}:195<=t&&t<255?{name:"blue",hue:240}:255<=t&&t<285?{name:"purple",hue:270}:285<=t&&t<315?{name:"magenta",hue:300}:315<=t&&t<345?{name:"pink",hue:330}:{name:"unknown",hue:t}},this._getColorFamilyByName=function(t){return{red:{name:"red",hue:0,saturation:80,lightness:50},orange:{name:"orange",hue:30,saturation:80,lightness:50},yellow:{name:"yellow",hue:60,saturation:80,lightness:50},green:{name:"green",hue:120,saturation:80,lightness:50},cyan:{name:"cyan",hue:180,saturation:80,lightness:50},blue:{name:"blue",hue:240,saturation:80,lightness:50},purple:{name:"purple",hue:270,saturation:80,lightness:50},magenta:{name:"magenta",hue:300,saturation:80,lightness:50},pink:{name:"pink",hue:330,saturation:70,lightness:75},white:{name:"white",hue:0,saturation:0,lightness:95},gray:{name:"gray",hue:0,saturation:5,lightness:50},black:{name:"black",hue:0,saturation:0,lightness:5}}[t]||null},this._rgbToHsl=function(t,e,o){t/=255,e/=255,o/=255;var i=Math.max(t,e,o),n=Math.min(t,e,o),r=0,a=0,l=(i+n)/2;if(i!==n){var s=i-n,a=.5<l?s/(2-i-n):s/(i+n);switch(i){case t:r=(e-o)/s+(e<o?6:0);break;case e:r=(o-t)/s+2;break;case o:r=(t-e)/s+4}r*=60}return[Math.round(r),Math.round(100*a),Math.round(100*l)]},this._colorsAreSimilar=function(t,e){if(!t||!e)return!1;if(t.name===e.name)return!0;var o=["white","gray","black"];if(o.includes(t.name)&&o.includes(e.name))return Math.abs(t.lightness-e.lightness)<30;if(20<t.saturation&&20<e.saturation){var i=Math.min(Math.abs(t.hue-e.hue),360-Math.abs(t.hue-e.hue)),n=Math.abs(t.saturation-e.saturation),r=Math.abs(t.lightness-e.lightness);return i<25&&n<20&&r<20}return!1},this._getColorForCanvasRow=function(t,e){var o=e.getBoundingClientRect(),i=this.gridOverlay.getBoundingClientRect(),n=t.topPos,r=t.bottomPos,a=o.top-i.top,l=a+o.height;return r<=a||l<=n?this.selectedBackgroundColor||this._getColorFamilyByName("green"):null},this._showZoomControls=function(){this.currentZoom=1,this.zoomSlider.value="1",this.zoomValue.textContent="100%",this.spacingSlider.value=this.verticalSpacing.toString(),this.spacingValue.textContent=this.verticalSpacing+"px"},this._adjustZoom=function(t){var e=parseFloat(this.zoomSlider.value)+t,e=Math.max(.1,Math.min(3,e));this.zoomSlider.value=e.toFixed(2),this._handleZoom()},this._adjustVerticalSpacing=function(t){var e=parseFloat(this.spacingSlider.value)+t,e=Math.max(2,Math.min(200,e));this.spacingSlider.value=e.toString(),this._handleVerticalSpacing()},this._handleVerticalSpacing=function(){var t=this;this.verticalSpacing=parseFloat(this.spacingSlider.value),this.spacingValue.textContent=this.verticalSpacing+"px",setTimeout(function(){return t._drawGridLines()},50)},this._changeInstrument=function(){this.selectedInstrument=this.instrumentSelect.value,this.synth&&this.synth.createSynth(0,this.selectedInstrument,this.selectedInstrument,null),this.activity.textMsg(_("Instrument changed to: ")+this.selectedInstrument)},this._createInstrumentPieMenu=function(){var o=this,i=[_("Electronic Synth"),_("Piano"),_("Guitar"),_("Acoustic Guitar"),_("Electric Guitar"),_("Violin"),_("Viola"),_("Cello"),_("Bass"),_("Flute"),_("Clarinet"),_("Saxophone"),_("Trumpet"),_("Trombone"),_("Oboe"),_("Tuba"),_("Banjo"),_("Sine"),_("Square"),_("Sawtooth"),_("Triangle")],n=["electronic synth","piano","guitar","acoustic guitar","electric guitar","violin","viola","cello","bass","flute","clarinet","saxophone","trumpet","trombone","oboe","tuba","banjo","sine","square","sawtooth","triangle"],e={container:{x:this.instrumentButton.offsetLeft+this.instrumentButton.offsetWidth/2,y:this.instrumentButton.offsetTop+this.instrumentButton.offsetHeight/2,children:[],setChildIndex:function(){}},text:{_text:this.selectedInstrument,get text(){return this._text},set text(t){this._text=t,this._updateCallback&&this._updateCallback(t)},_updateCallback:null},value:this.selectedInstrument,activity:{canvas:{offsetLeft:0,offsetTop:0},blocksContainer:{x:0,y:0},getStageScale:function(){return 1},logo:{synth:this.synth},turtles:{ithTurtle:function(){return{singer:{instrumentNames:[o.selectedInstrument]}}}}},blocks:{blockScale:1,turtles:{_canvas:{width:window.innerWidth,height:window.innerHeight}}},updateCache:function(){},updateValue:function(t){o.selectedInstrument=t,o.instrumentButton.textContent=t.charAt(0).toUpperCase()+t.slice(1),o.synth&&o.synth.createSynth(0,o.selectedInstrument,o.selectedInstrument,null),o.activity.textMsg(_("Instrument changed to: ")+o.selectedInstrument),e.value=t,e.text.text=t}};e.text._updateCallback=function(e){var t=n[i.findIndex(function(t){return t.toLowerCase()===e.toLowerCase()})]||e.toLowerCase();o.selectedInstrument=t,o.instrumentButton.textContent=t.charAt(0).toUpperCase()+t.slice(1),o.synth&&o.synth.createSynth(0,o.selectedInstrument,o.selectedInstrument,null),o.activity.textMsg(_("Instrument changed to: ")+o.selectedInstrument)},piemenuVoices(e,i,n,[],this.selectedInstrument,!1)},this._handleZoom=function(){var t=this;this.imageWrapper&&(this.currentZoom=parseFloat(this.zoomSlider.value),this.imageWrapper.style.transform="scale(".concat(this.currentZoom,")"),this.zoomValue.textContent=Math.round(100*this.currentZoom)+"%",this.imageWrapper.style.width="100%",this.imageWrapper.style.height="100%",setTimeout(function(){return t._drawGridLines()},50))},this._drawGridLines=function(){if(this.rowHeaderTable.rows.length&&this.gridOverlay){this.gridOverlay.innerHTML="";for(var t=this.matrixData.rows.length,e=0;e<t;e++){var o=document.createElement("div");o.style.position="absolute",o.style.left="0px",o.style.right="0px",o.style.height="2px",o.style.backgroundColor="red",o.style.zIndex="5";var i=40*(e+1);o.style.top="".concat(i,"px"),this.gridOverlay.appendChild(o)}var n=this.gridOverlay.getBoundingClientRect().width||this.gridOverlay.offsetWidth||800;if(0<n)for(var r=Math.floor(n/this.verticalSpacing),a=1;a<=r;a++){var l=document.createElement("div");l.style.position="absolute",l.style.top="0px",l.style.bottom="0px",l.style.width="2px",l.style.backgroundColor="blue",l.style.zIndex="5";var s=a*this.verticalSpacing;l.style.left="".concat(s,"px"),this.gridOverlay.appendChild(l)}}},this._scale=function(){var t=this;setTimeout(function(){return t._drawGridLines()},300)},this.show=function(){this.widgetWindow&&this.widgetWindow.show()},this.updateParams=function(t){t.zoom&&this.zoomSlider&&(this.zoomSlider.value=t.zoom,this._handleZoom())},this._playPhrase=function(){var l=this;this._stopPlayback(),this.activity.textMsg(_("Scanning image with vertical lines...")),this.hasGeneratedVisualization=!1;Array.from(this.gridOverlay.querySelectorAll("div")).filter(function(t){return"red"===t.style.backgroundColor}).sort(function(t,e){return parseFloat(t.style.top)-parseFloat(e.style.top)});this.scanningLines=[],this.colorData=[];var s=this.gridOverlay.getBoundingClientRect().height||40*this.matrixData.rows.length;this.matrixData.rows.filter(function(t){return t.note}).length;this.matrixData.rows.forEach(function(t,e){var o,i,n,r,a;t.note&&(l.colorData.push({note:t.note,label:t.label,colorSegments:[]}),o=40*e,i=40*(e+1),n=Math.max(0,Math.min(o,s)),r=Math.max(0,Math.min(i,s)),s<=n||r<=0?l.colorData[l.colorData.length-1].colorSegments.push({color:l.selectedBackgroundColor.name,duration:5e3,timestamp:performance.now()}):((a=document.createElement("div")).style.position="absolute",a.style.width="3px",a.style.height=r-n+"px",a.style.backgroundColor="rgba(255, 0, 0, 0.7)",a.style.zIndex="20",a.style.left="0px",a.style.top=n+"px",a.dataset.lineId=e,l.gridOverlay.appendChild(a),l.scanningLines.push({element:a,topPos:n,bottomPos:r,currentX:0,currentColor:null,colorStartTime:null,lastSignificantColor:null,completed:!1,rowIndex:e})))}),this.isPlaying=!0,this.startTime=performance.now(),this.lastFrameTime=this.startTime,this._animateLines()},this._animateLines=function(){var n,r,a,l,s,c=this;this.isPlaying&&(n=performance.now(),r=(n-this.lastFrameTime)/1e3,this.lastFrameTime=n,a=this.gridOverlay.getBoundingClientRect(),l=this.verticalSpacing/.5,s=!0,this.scanningLines.forEach(function(t){if(!t.completed){t.currentX+=l*r;var e,o,i=a.width;if(t.currentX>i)return t.completed=!0,void(t.lastSignificantColor&&t.colorStartTime&&(1<(e=(n-t.colorStartTime)/1e3)&&c.colorData[t.rowIndex].colorSegments.push({color:t.lastSignificantColor.name,duration:e,endTime:n-c.startTime})));if(c._isLineBeyondImageHorizontally(t))return t.completed=!0,void(t.lastSignificantColor&&t.colorStartTime&&(1<(o=(n-t.colorStartTime)/1e3)&&c.colorData[t.rowIndex].colorSegments.push({color:t.lastSignificantColor.name,duration:o,endTime:n-c.startTime})));s=!1,t.element.style.left=t.currentX+"px",c._sampleAndDetectColor(t,n)}}),s?this._stopPlayback():requestAnimationFrame(function(){return c._animateLines()}))},this._isLineBeyondImageHorizontally=function(t){var e=null;if(this.imageWrapper&&(e=this.imageWrapper.querySelector("img")||this.imageWrapper.querySelector("video")),!e)return!1;var o=e.getBoundingClientRect(),i=this.gridOverlay.getBoundingClientRect();return o.left-i.left+o.width<=t.currentX},this._stopPlayback=function(){var o,i=this;this.isPlaying=!1,this.scanningLines&&(o=performance.now(),this.scanningLines.forEach(function(t){var e;t.currentColor&&t.colorStartTime&&(1e3<(e=o-t.colorStartTime)&&i._addColorSegment(t.rowIndex,t.currentColor,e)),t.element&&t.element.parentNode&&t.element.parentNode.removeChild(t.element)}),this.scanningLines=null),!this.hasGeneratedVisualization&&this.colorData&&0<this.colorData.length&&this.colorData.some(function(t){return t.colorSegments&&0<t.colorSegments.length})&&(this._mergeConsecutiveColorSegments(),this.hasGeneratedVisualization=!0,setTimeout(function(){i._generateColorVisualization(),i._drawColumnLinesOnCanvas()},100))},this._mergeConsecutiveColorSegments=function(){var a=this;this.colorData.forEach(function(t){if(t.colorSegments&&!(t.colorSegments.length<=1)){var e,o=[],i=null,n=_createForOfIteratorHelper(t.colorSegments);try{for(n.s();!(e=n.n()).done;){var r=e.value;i?a._shouldMergeColors(i.color,r.color)?(i.duration+=r.duration,i.endTime=r.endTime):(o.push(i),i={color:r.color,duration:r.duration,endTime:r.endTime}):i={color:r.color,duration:r.duration,endTime:r.endTime}}}catch(t){n.e(t)}finally{n.f()}i&&o.push(i),t.colorSegments=o}})},this._shouldMergeColors=function(t,e){if(t===e)return!0;var o=["white","gray","black"];return!(!o.includes(t)||!o.includes(e))},this._sampleAndDetectColor=function(t,e){var o=null;if(this.imageWrapper&&(o=this.imageWrapper.querySelector("img")||this.imageWrapper.querySelector("video")),o){var i,n=this._getColorForCanvasRow(t,o);if(n){t.currentColor&&t.currentColor.name===n.name||500<(t.lastColorChangeTime?e-t.lastColorChangeTime:1e3)&&(t.currentColor&&t.colorStartTime&&(1e3<(i=e-t.colorStartTime)&&this._addColorSegment(t.rowIndex,t.currentColor,i)),t.currentColor=n,t.colorStartTime=e,t.lastColorChangeTime=e)}else{var r=document.createElement("canvas"),a=r.getContext("2d"),l=o.getBoundingClientRect(),s=this.gridOverlay.getBoundingClientRect();r.width=o.naturalWidth||o.videoWidth||l.width,r.height=o.naturalHeight||o.videoHeight||l.height;try{a.drawImage(o,0,0,r.width,r.height)}catch(t){return void console.error("Error drawing image to canvas:",t)}var c=o.getBoundingClientRect(),h=c.left-s.left,u=c.top-s.top,d=t.currentX-h,p=t.topPos-u,m=t.bottomPos-u;if(!(d<0||d>=c.width)){for(var g=r.width/c.width,y=r.height/c.height,f=Math.floor(d*g),v=Math.max(0,Math.floor(p*y)),C=Math.min(r.height,Math.floor(m*y)),w={},b=0,x=0;x<32;x++){var _=v+x*(C-v)/31;if(0<=f&&f<r.width&&0<=_&&_<r.height)try{var S=a.getImageData(f,_,1,1),k=_slicedToArray(S.data,3),T=k[0],D=k[1],B=k[2];if(S.data[3]<128)continue;var F=_slicedToArray(this._rgbToHsl(T,D,B),3),E=F[0],z=F[1],A=F[2],I=this._getColorFamily(E,z,A);I&&"unknown"!==I.name&&(w[I.name]=(w[I.name]||0)+1,b++)}catch(t){console.error("Error sampling pixel data:",t)}}if(!(b<1)){for(var P,M=null,W=0,L=Math.max(1,Math.floor(.25*b)),R=0,O=Object.entries(w);R<O.length;R++){var H=_slicedToArray(O[R],2),V=H[0],G=H[1];W<G&&L<=G&&(W=G,M=this._getColorFamilyByName(V))}!M||t.currentColor&&this._colorsAreSimilar(t.currentColor,M)||500<(t.lastColorChangeTime?e-t.lastColorChangeTime:1e3)&&(t.currentColor&&t.colorStartTime&&(1e3<(P=e-t.colorStartTime)&&this._addColorSegment(t.rowIndex,t.currentColor,P)),t.currentColor=M,t.colorStartTime=e,t.lastColorChangeTime=e)}}}}else console.warn("No image or video element found for color sampling")},this._getColorFamilyByName=function(t){return{red:{name:"red",hue:0},orange:{name:"orange",hue:30},yellow:{name:"yellow",hue:60},green:{name:"green",hue:120},cyan:{name:"cyan",hue:180},blue:{name:"blue",hue:240},purple:{name:"purple",hue:270},magenta:{name:"magenta",hue:300},pink:{name:"pink",hue:330},white:{name:"white",hue:0},black:{name:"black",hue:0},gray:{name:"gray",hue:0}}[t]||null},this._addColorSegment=function(t,e,o){this.colorData[t]||(this.colorData[t]={note:this.this.matrixData.rows[t].note,label:this.this.matrixData.rows[t].label,colorSegments:[]}),this.colorData[t].colorSegments.push({color:e.name,duration:o,timestamp:performance.now()})},this._drawColumnLinesOnCanvas=function(){var t,r,a,l,s=this;this.colorData&&0!==this.colorData.length&&(this.gridOverlay.querySelectorAll(".column-line").forEach(function(t){return t.remove()}),t=this._analyzeColumnBoundaries(),r=this._filterSmallSegments(t),a=this.gridOverlay.getBoundingClientRect().width||800,l=r[r.length-1]-r[0],r.forEach(function(t,e){var o,i,n;0!==e&&(o=t-r[0],0<(i=Math.round(o/l*a))&&i<a&&((n=document.createElement("div")).className="column-line",n.style.position="absolute",n.style.top="0px",n.style.bottom="0px",n.style.width="2px",n.style.backgroundColor="#0066FF",n.style.zIndex="15",n.style.left="".concat(i,"px"),s.gridOverlay.appendChild(n)))}))},this._drawColumnLines=function(n,t,r,a,l){var e=this._analyzeColumnBoundaries(),s=this._filterSmallSegments(e),c=s[s.length-1]-s[0];n.strokeStyle="#0066FF",n.lineWidth=3,s.forEach(function(t,e){var o,i;0!==e&&(o=t-s[0],i=a+Math.round(o/c*l),a<=i&&i<=a+l&&(n.beginPath(),n.moveTo(i,0),n.lineTo(i,r),n.stroke()))})},this._generateColorVisualization=function(){var a,t,e,l,s;this.colorData&&0!==this.colorData.length&&(a=800,t=50*this.colorData.length,(e=document.createElement("canvas")).width=a,e.height=t,(l=e.getContext("2d")).fillStyle="#f0f0f0",l.fillRect(0,0,a,t),s={red:"#FF0000",orange:"#FFA500",yellow:"#FFFF00",green:"#00FF00",blue:"#0000FF",purple:"#800080",pink:"#FFC0CB",cyan:"#00FFFF",magenta:"#FF00FF",white:"#FFFFFF",black:"#000000",gray:"#808080",unknown:"#C0C0C0"},this.colorData.forEach(function(t,e){var i,n,r,o=50*e;l.fillStyle=e%2==0?"#ffffff":"#f8f8f8",l.fillRect(0,o,a,50),l.fillStyle="#000000",l.font="12px Arial",l.textAlign="left",l.fillText("".concat(t.label," (").concat(t.note,")"),10,20+o),t.colorSegments&&0<t.colorSegments.length?(i=150,n=10+o,r=t.colorSegments.reduce(function(t,e){return t+e.duration},0),t.colorSegments.forEach(function(t,e){var o=Math.max(20,t.duration/r*630);l.fillStyle=s[t.color]||s.unknown,l.fillRect(i,n,o,30),l.strokeStyle="#333333",l.lineWidth=1,l.strokeRect(i,n,o,30),40<o&&(l.fillStyle="white"===t.color||"yellow"===t.color?"#000000":"#ffffff",l.font="10px Arial",l.textAlign="center",l.fillText(t.color,i+o/2,15+n+3)),l.fillStyle="#666666",l.font="8px Arial",l.textAlign="center",l.fillText("".concat(Math.round(t.duration),"ms"),i+o/2,30+n+12),i+=o+2})):(l.fillStyle="#cccccc",l.font="12px Arial",l.textAlign="left",l.fillText("No colors were detected",150,25+o)),l.strokeStyle="#dddddd",l.lineWidth=1,l.beginPath(),l.moveTo(0,50+o),l.lineTo(a,50+o),l.stroke()}),this._drawColumnLines(l,a,t,150,630),l.fillStyle="#000000",l.font="bold 16px Arial",l.textAlign="center",l.fillText("Color Detection Visualization",400,-10),e.toBlob(function(t){var e=URL.createObjectURL(t),o=document.createElement("a");o.href=e,o.download="color_detection_".concat((new Date).getTime(),".png"),document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(e)},"image/png"),this.playColorMusicPolyphonic(this.colorData))},this.playColorMusicPolyphonic=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var o,i,d,n,r,a,l,s,c,p=this;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:for(this.synth||this._initAudio(),o=this._analyzeColumnBoundaries(),i=this._filterSmallSegments(o),d=[],n=function(t){var h=i[t],u=i[t+1];e.forEach(function(t,e){if(t.colorSegments&&t.note){var o,i=0,n=!1,r=_createForOfIteratorHelper(t.colorSegments);try{for(r.s();!(o=r.n()).done;){var a=o.value,l=i+a.duration;if(i<u&&h<l){var s=Math.max(i,h),c=Math.min(l,u)-s;if(1e3<c&&a.color!==p.selectedBackgroundColor.name){n=!0;break}c<=350&&(a.color,p.selectedBackgroundColor.name)}i+=a.duration}}catch(t){r.e(t)}finally{r.f()}n&&(d.push({time:h,type:"on",note:t.note,rowIdx:e}),d.push({time:u,type:"off",note:t.note,rowIdx:e}))}})},r=0;r<i.length-1;r++)n(r);d.sort(function(t,e){return t.time-e.time}),a=new Set,l=0,s=regeneratorRuntime.mark(function t(e){var o,i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(o=d[e],0<(i=o.time-l))return t.next=5,new Promise(function(t){return setTimeout(t,i)});t.next=5;break;case 5:"on"===o.type?a.has(o.note)||(p.synth.trigger(0,o.note,999,p.selectedInstrument,null,null,!1,0),a.add(o.note)):"off"===o.type&&(p.synth.stopSound(0,p.selectedInstrument,o.note),a.delete(o.note)),l=o.time;case 7:case"end":return t.stop()}},t)}),c=0;case 11:if(c<d.length)return t.delegateYield(s(c),"t0",13);t.next=16;break;case 13:c++,t.next=11;break;case 16:a.forEach(function(t){p.synth.stopSound(0,p.selectedInstrument,t)});case 17:case"end":return t.stop()}},t,this)}));return function(t){return e.apply(this,arguments)}}()}