"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _createForOfIteratorHelper(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0,o=function(){};return{s:o,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,s=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return i=t.done,t},e:function(t){s=!0,a=t},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw a}}}}function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_unsupportedIterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(t,e):void 0}}function _iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t))return _arrayLikeToArray(t)}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=Array(e);n<e;n++)r[n]=t[n];return r}function AIDebuggerWidget(){var a={BASE_URL:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:8000":window.location.hostname.includes("musicblocks.sugarlabs.org")?"".concat(window.location.protocol,"//api.musicblocks.sugarlabs.org"):"".concat(window.location.protocol,"//").concat(window.location.hostname,":8000"),ENDPOINTS:{ANALYZE:"/analyze"},TIMEOUT:3e4};console.log("AI Debugger Backend URL:",a.BASE_URL),this.chatHistory=[],this.promptCount=0,this.conversationId=null,this.activity=null,this.widgetWindow=null,this.chatLog=null,this.messageInput=null,this.sendButton=null,this._generateConversationId=function(){return"conv_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)},this.conversationId=this._generateConversationId(),this.init=function(t){var e=this;this.activity=t,this.activity.isInputON=!0,this.conversationId||(this.conversationId=this._generateConversationId());var n=window.widgetWindows.windowFor(this,"Debugger");(this.widgetWindow=n).clear(),n.show(),n.getWidgetBody().style.width="900px",n.getWidgetBody().style.height="600px",n.onclose=function(){n.destroy(),e.activity.isInputON=!1},n.onmaximize=this._scale.bind(this),this._resetButton=n.addButton("reload.svg",32,_("Reset conversation")),this._resetButton.onclick=function(){e._resetConversation()},this._exportButton=n.addButton("download.svg",32,_("Export chat")),this._exportButton.onclick=function(){e._exportChat()},this._createLayout(),this._loadProjectAndInitialize(),n.sendToCenter(),this.activity.textMsg(_("Debugger initialized"))},this._createLayout=function(){var t=document.createElement("div");t.style.display="flex",t.style.height="100%",t.style.width="100%",this._createChatArea(t),this.widgetWindow.getWidgetBody().appendChild(t)},this._createChatArea=function(t){var e=this,n=document.createElement("div");n.style.width="100%",n.style.display="flex",n.style.flexDirection="column",n.style.height="100%",this.chatLog=document.createElement("div"),this.chatLog.className="chatLog",this.chatLog.style.flex="1",this.chatLog.style.overflowY="auto",this.chatLog.style.padding="15px",this.chatLog.style.backgroundColor="#fafafa",this.chatLog.style.display="flex",this.chatLog.style.flexDirection="column",this.chatLog.style.gap="10px",n.appendChild(this.chatLog);var r=document.createElement("div");r.style.display="flex",r.style.padding="15px",r.style.backgroundColor="#fff",r.style.borderTop="1px solid #ddd",r.style.gap="10px",this.messageInput=document.createElement("input"),this.messageInput.type="text",this.messageInput.placeholder="Type your message here...",this.messageInput.style.flex="1",this.messageInput.style.padding="12px",this.messageInput.style.border="1px solid #ddd",this.messageInput.style.borderRadius="25px",this.messageInput.style.fontSize="14px",this.messageInput.style.outline="none",this.messageInput.onfocus=function(){this.style.borderColor="#2196F3",this.style.boxShadow="0 0 5px rgba(33, 150, 243, 0.3)"},this.messageInput.onblur=function(){this.style.borderColor="#ddd",this.style.boxShadow="none"},this.sendButton=document.createElement("button"),this.sendButton.textContent="Send",this.sendButton.style.padding="12px 20px",this.sendButton.style.backgroundColor="#2196F3",this.sendButton.style.color="white",this.sendButton.style.border="none",this.sendButton.style.borderRadius="25px",this.sendButton.style.cursor="pointer",this.sendButton.style.fontSize="14px",this.sendButton.style.fontWeight="bold",this.sendButton.style.transition="background-color 0.3s",this.sendButton.onmouseover=function(){this.style.backgroundColor="#1976D2"},this.sendButton.onmouseout=function(){this.style.backgroundColor="#2196F3"},this.sendButton.onclick=function(){e._sendMessage()},this.messageInput.onkeypress=function(t){"Enter"===t.key&&e._sendMessage()},r.appendChild(this.messageInput),r.appendChild(this.sendButton),n.appendChild(r),t.appendChild(n)},this._addWelcomeMessage=function(){var t={type:"system",content:_THIS_IS_MUSIC_BLOCKS_?"Welcome to Music Blocks Debugger! I can help you with music composition, Music Blocks programming, and general music theory questions.":"Welcome to Turtle Blocks Debugger! I can help you with programming, turtle graphics, and general coding questions.",timestamp:(new Date).toISOString()};this._addMessageToUI(t)},this._sendMessage=function(){var t,e=this.messageInput.value.trim();""!==e&&(t={type:"user",content:e,timestamp:(new Date).toISOString()},this.chatHistory.push(t),this._addMessageToUI(t),this.messageInput.value="",this._updateMessageCount(),this._sendToBackend(e))},this._addMessageToUI=function(t){var e=document.createElement("div");e.style.maxWidth="80%",e.style.padding="12px 16px",e.style.borderRadius="18px",e.style.marginBottom="8px",e.style.wordWrap="break-word",e.style.fontSize="14px",e.style.lineHeight="1.4";var n=document.createElement("div");n.style.fontSize="11px",n.style.opacity="0.7",n.style.marginTop="4px",n.textContent=new Date(t.timestamp).toLocaleTimeString(),"user"===t.type?(e.style.alignSelf="flex-end",e.style.backgroundColor="#2196F3",e.style.color="white",e.textContent=t.content,e.appendChild(n)):"bot"===t.type?(e.style.alignSelf="flex-start",e.style.backgroundColor="#e0e0e0",e.style.color="#333",e.textContent=t.content,e.appendChild(n)):"system"===t.type&&(e.style.alignSelf="center",e.style.backgroundColor="#fff3cd",e.style.color="#856404",e.style.border="1px solid #ffeaa7",e.style.fontStyle="italic",e.textContent=t.content,e.appendChild(n)),this.chatLog.appendChild(e),this.chatLog.scrollTop=this.chatLog.scrollHeight},this._sendToBackend=function(t){var n=this;this._showTypingIndicator(),this.promptCount++;try{var e=this.activity.prepareExport(),r=(JSON.parse(e),e)}catch(t){console.error("Error getting project data:",t),this.activity.textMsg(_("Debugger error: Could not prepare project data.")),r="[]"}var o={code:r,prompt:t,history:this.chatHistory.filter(function(t){return"system"!==t.type}).map(function(t){return{role:"user"===t.type?"user":"assistant",content:t.content}}),prompt_count:this.promptCount};fetch("".concat(a.BASE_URL).concat(a.ENDPOINTS.ANALYZE),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).then(function(t){if(!t.ok)throw new Error("HTTP ".concat(t.status,": ").concat(t.statusText));return t.json()}).then(function(t){if(n._hideTypingIndicator(),!t||!t.response)throw n.activity.textMsg(_("Server error: Invalid response from AI backend.")),new Error("No response from backend");var e={type:"bot",content:t.response,timestamp:(new Date).toISOString()};n.chatHistory.push(e),n._addMessageToUI(e),n._updateMessageCount()}).catch(function(t){n._hideTypingIndicator(),console.error("Backend connection error:",t.message),n.activity.textMsg(_("Server error: Unable to connect to AI backend.")),t instanceof TypeError&&t.message.includes("fetch")&&console.error("Network/CORS error. Backend connection failed");var e={type:"bot",content:"I'm sorry, I'm having trouble connecting to the AI backend. Error: ".concat(t.message,". Please check your connection and try again."),timestamp:(new Date).toISOString()};n.chatHistory.push(e),n._addMessageToUI(e),n._updateMessageCount()})},this._showTypingIndicator=function(){var t=document.createElement("div");t.className="typing-indicator",t.style.alignSelf="flex-start",t.style.backgroundColor="#e0e0e0",t.style.color="#666",t.style.padding="12px 16px",t.style.borderRadius="18px",t.style.marginBottom="8px",t.style.fontSize="14px",t.style.fontStyle="italic",t.textContent="Debugger is typing...";var e=0,n=setInterval(function(){e=(e+1)%4,t.textContent="Debugger is typing"+".".repeat(e)},500);t.setAttribute("data-animation-id",n),this.chatLog.appendChild(t),this.chatLog.scrollTop=this.chatLog.scrollHeight},this._hideTypingIndicator=function(){var t,e=this.chatLog.querySelector(".typing-indicator");e&&((t=e.getAttribute("data-animation-id"))&&clearInterval(parseInt(t)),e.remove())},this._updateMessageCount=function(){},this._loadProjectAndInitialize=function(){try{var t=this.activity.prepareExport();try{JSON.parse(t)}catch(t){console.error("Error parsing project data:",t),this.activity.textMsg(_("Debugger error: Invalid project data format."))}var e={type:"system",content:"Loading your current project and initializing AI assistant...",timestamp:(new Date).toISOString()};this._addMessageToUI(e),this._initializeBackendWithProject(t)}catch(t){console.error("Error loading project data:",t),this.activity.textMsg(_("Debugger error: Could not load project data."));var n={type:"system",content:"Could not load project data. Starting with basic assistant...",timestamp:(new Date).toISOString()};this._addMessageToUI(n),this._addWelcomeMessage()}},this._initializeBackendWithProject=function(t){var n=this,e={code:t,prompt:"",history:this.chatHistory.map(function(t){return{role:"user"===t.type?"user":"assistant",content:t.content}}),prompt_count:1};this._showTypingIndicator(),fetch("".concat(a.BASE_URL).concat(a.ENDPOINTS.ANALYZE),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(function(t){if(!t.ok)throw new Error("HTTP ".concat(t.status,": ").concat(t.statusText));return t.json()}).then(function(t){if(n._hideTypingIndicator(),!t.response)throw n.activity.textMsg(_("Server error: No initial response from AI backend.")),new Error("No initial response from backend");var e={type:"bot",content:t.response,timestamp:(new Date).toISOString()};n.chatHistory.push(e),n._addMessageToUI(e),n._updateMessageCount(),n.promptCount=1}).catch(function(t){n._hideTypingIndicator(),console.error("Backend initialization error:",t.message),n.activity.textMsg(_("Server error: Failed to initialize AI debugger.")),t instanceof TypeError&&t.message.includes("fetch")&&console.error("Network/CORS error. Backend connection failed");var e={type:"system",content:"Could not connect to AI backend: ".concat(t.message,". Please check your connection and try again."),timestamp:(new Date).toISOString()};n._addMessageToUI(e),n._addWelcomeMessage()})},this._resetConversation=function(){this.chatHistory=[],this.promptCount=0,this.conversationId=this._generateConversationId(),this.chatLog.innerHTML="",this._loadProjectAndInitialize(),this._updateMessageCount(),this.activity.textMsg(_("Conversation reset."))},this._exportChat=function(){if(0!==this.chatHistory.length){var e="";try{var t=this.activity.prepareExport();try{var n=JSON.parse(t),e=this._convertProjectToLLMFormat(n)}catch(t){e="Could not convert project to readable format"}}catch(t){console.error("Error getting project data for export:",t),this.activity.textMsg(_("Debugger error: Could not retrieve project data for export.")),e="Could not convert project to readable format"}var r=_THIS_IS_MUSIC_BLOCKS_?"Music Blocks":"Turtle Blocks",o="".concat(r," Debugger Chat Export\n");o+="Generated at: "+(new Date).toLocaleString()+"\n\n",o+="Project Code (Human Readable Format):\n",o+=e+"\n\n",o+="Chat History:\n\n",this.chatHistory.forEach(function(t){var e="user"===t.type?"User":"".concat(r," Debugger");o+=e+":\n",o+=t.content+"\n\n"});var a=new Blob([o],{type:"text/plain"}),i=URL.createObjectURL(a),s=document.createElement("a");s.href=i,s.download="music_blocks_chat_"+(new Date).toISOString().replace(/[:.]/g,"-").split("T")[0]+"_"+(new Date).toTimeString().split(" ")[0].replace(/:/g,"")+".txt",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),this.activity.textMsg(_("Chat exported successfully."))}else this.activity.textMsg(_("No conversation to export."))},this._convertProjectToLLMFormat=function(t){if(!Array.isArray(t))return"Invalid JSON format: Expected a list at the root.";if(0===t.length)return"Warning: No blocks found in input!";var e=["Start of Project"],n=Object.fromEntries(t.map(function(t){return[t[0],t]})),r=new Set,o=t.find(function(t){return"start"===(Array.isArray(t[1])?t[1][0]:t[1])})||t[0];e.push.apply(e,_toConsumableArray(this._processBlock(o,n,r,1)));var a,i=_createForOfIteratorHelper(t);try{for(i.s();!(a=i.n()).done;){var s,c=a.value,l=c[0];r.has(l)||"hidden"!==(s=Array.isArray(c[1])?c[1][0]:c[1])&&"vspace"!==s&&l!==o[0]&&e.push.apply(e,_toConsumableArray(this._processBlock(c,n,r,1)))}}catch(t){i.e(t)}finally{i.f()}return e.join("\n")},this._clearChat=function(){this.chatLog.innerHTML="",this.activity.textMsg(_("Chat cleared."))},this._processBlock=function(t,e,n){var r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,o=4<arguments.length&&void 0!==arguments[4]&&arguments[4],a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:null,i=[],s=t[0];if(n.has(s))return i;n.add(s);var c=t[1],l=null;if(Array.isArray(c)&&(l=c[1],c=c[0],l&&"object"===_typeof(l)))for(var u in l)"string"==typeof l[u]&&this._isBase64Data(l[u])&&(l[u]="data");if(["vspace","hidden"].includes(c)){var d,h=_createForOfIteratorHelper(Array.isArray(t[t.length-1])?t[t.length-1]:[]);try{for(h.s();!(d=h.n()).done;){var p=d.value;e[p]&&i.push.apply(i,_toConsumableArray(this._processBlock(e[p],e,n,r,o,c)))}}catch(t){h.e(t)}finally{h.f()}return i}if("number"===c||"drumname"===c||"solfege"===c)return i;var y=this._getBlockRepresentation(c,l,t,e,r,o,a);if(!y)return i;var g="│   ".repeat(r-1)+"├── ";i.push("".concat(g).concat(y));for(var m,f=Array.isArray(t[t.length-1])?t[t.length-1]:[],v=0;v<f.length-1;v++){var _=f[v];null!==_&&e[_]&&("divide"!==(Array.isArray(e[_][1])?e[_][1][0]:e[_][1])||"newnote"!==a&&"setmasterbpm2"!==a&&"arc"!==a)&&i.push.apply(i,_toConsumableArray(this._processBlock(e[_],e,n,r+1,!0,c)))}return 0<f.length&&null!==f[f.length-1]&&(e[m=f[f.length-1]]&&i.push.apply(i,_toConsumableArray(this._processBlock(e[m],e,n,r,!1,c)))),"start"!==c&&"action"!==c||i.push("│   ".repeat(r-1)+"│"),i},this._getBlockRepresentation=function(t,e,n,r,o,a,i){var s=n[n.length-1]||[];switch(t){case"start":var c=["ID: ".concat(e.id),"Position: (".concat(e.xcor.toFixed(2),", ").concat(e.ycor.toFixed(2),")"),"Heading: ".concat(e.heading,"°"),"Color: ".concat(e.color,", Shade: ").concat(e.shade),"Pen Size: ".concat(e.pensize,", Grey: ").concat(e.grey.toFixed(2))].join(", ");return"Start Block --\x3e {".concat(c,"}");case"setmasterbpm2":var l,u,d,h=this._getNumericValue(s[1],r),p="Set Master BPM → ".concat(h||"?"," BPM");return s[2]&&r[s[2]]&&"divide"===r[s[2]][1]&&(l=r[s[2]],u=this._getNumericValue(l[l.length-1][1],r),d=this._getNumericValue(l[l.length-1][2],r),null!==u&&null!==d&&0!==d&&(p+="\n".concat("│   ".repeat(o),"├── beat value --\x3e ").concat(u,"/").concat(d," = ").concat((u/d).toFixed(2)))),p;case"divide":var y=this._getNumericValue(s[1],r),g=this._getNumericValue(s[2],r),m="?";return null!==y&&null!==g&&0!==g&&(m=(y/g).toFixed(2)),"newnote"===i?"Duration --\x3e ".concat(y||"?","/").concat(g||"?"," = ").concat(m):"Divide Block --\x3e ".concat(y||"?","/").concat(g||"?"," = ").concat(m);case"storein2":var f=(null==e?void 0:e.value)||"unnamed",v=this._getNumericValue(s[1],r);return'Store Variable "'.concat(f,'" → ').concat(null!==v?v:"?");case"namedbox":return'Variable: "'.concat((null==e?void 0:e.value)||"unnamed",'"');case"action":var _=this._getTextValue(s[1],r);return'Action: "'.concat(_||"unnamed",'"');case"repeat":var b,x,I,A="?",S="?";return s[1]&&r[s[1]]&&(b=r[s[1]],Array.isArray(b[1])&&"divide"===b[1][0]?(x=this._getNumericValue(b[b.length-1][1],r),I=this._getNumericValue(b[b.length-1][2],r),null!==x&&null!==I&&0!==I&&(A=(x/I).toFixed(2),S="".concat(x,"/").concat(I," = ").concat(A))):S=(A=this._getNumericValue(s[1],r))||"?"),"Repeat (".concat(S,") Times");case"forever":return"Forever Loop (Repeats Indefinitely)";case"penup":return"Pen Up (Lifts Pen from Canvas)";case"pendown":return"Pen Down";case"forward":var w=this._getNumericValue(s[1],r);return"Move Forward → ".concat(w||"?"," Steps");case"back":var C=this._getNumericValue(s[1],r);return"Move Backward → ".concat(C||"?"," Steps");case"right":var T=this._getNumericValue(s[1],r);return"Rotate Right → ".concat(T||"?","°");case"left":var B=this._getNumericValue(s[1],r);return"Rotate Left → ".concat(B||"?","°");case"setheading":var k=this._getNumericValue(s[1],r);return"Set Heading → ".concat(k||"0","°");case"show":var N=this._getNumericValue(s[2],r);return"Show Number: ".concat(N||"?");case"increment":var L=this._getNumericValue(s[1],r),M=this._getNumericValue(s[2],r);return"Increment --\x3e Color: ".concat(L||"?",", Amount: ").concat(M||"?");case"incrementOne":var D=this._getNamedBoxValue(s[1],r);return'Increment Variable: "'.concat(D||"?",'"');case"newnote":return"Note";case"playdrum":var E=this._getDrumName(s[1],r);return"Play Drum → ".concat(E||"?");case"arc":var O,j,V,H="?";s[3]&&r[s[3]]&&(O=r[s[3]],Array.isArray(O[1])&&"divide"===O[1][0]?(j=this._getNumericValue(O[O.length-1][1],r),V=this._getNumericValue(O[O.length-1][2],r),null!==j&&null!==V&&0!==V&&(H=(j/V).toFixed(2))):H=this._getNumericValue(s[3],r)||"?");var P=this._getNumericValue(s[2],r);return"Draw Arc --\x3e Angle: ".concat(H,"°, Radius: ").concat(P||"?");case"print":var U=this._getTextValue(s[2],r);return'Print: "'.concat(U||"",'"');case"plus":var W=this._getNumericValue(s[1],r),R=this._getNumericValue(s[2],r);return"Add --\x3e ".concat(W||"?"," + ").concat(R||"?"," = ").concat(null!==W&&null!==R?(W+R).toFixed(2):"?");case"text":return'"'.concat((null==e?void 0:e.value)||"",'"');case"pitch":var F,z,J,Y,Z="?",q=this._getNumericValue(s[2],r);return s[1]&&r[s[1]]&&(F=r[s[1]],"text"===(z=Array.isArray(F[1])?F[1][0]:F[1])&&Array.isArray(F[1])?Z=(null===(J=F[1][1])||void 0===J?void 0:J.value)||"?":"solfege"===z&&Array.isArray(F[1])&&(Z=(null===(Y=F[1][1])||void 0===Y?void 0:Y.value)||"?")),"Pitch --\x3e Solfege: ".concat(Z,", Octave: ").concat(q||"?");case"solfege":return null;case"nameddo":var G=(null==e?void 0:e.value)||"unnamed";return'Do action --\x3e "'.concat(G,'"');case"settransposition":var K=this._getNumericValue(s[1],r);return"Set Transposition --\x3e ".concat(K||"?");default:return void 0!==(null==e?void 0:e.value)?"".concat(t,": ").concat(e.value):t.charAt(0).toUpperCase()+t.slice(1)}},this._getNumericValue=function(t,e){if(null===t||!e[t])return null;var n,r=e[t];return"number"!==(Array.isArray(r[1])?r[1][0]:r[1])?null:Array.isArray(r[1])?null===(n=r[1][1])||void 0===n?void 0:n.value:r[1]},this._getTextValue=function(t,e){if(null===t||!e[t])return null;var n,r=e[t];return"text"===(Array.isArray(r[1])?r[1][0]:r[1])&&Array.isArray(r[1])?null===(n=r[1][1])||void 0===n?void 0:n.value:null},this._getDrumName=function(t,e){if(null===t||!e[t])return null;var n,r=e[t];return"drumname"===(Array.isArray(r[1])?r[1][0]:r[1])&&Array.isArray(r[1])?null===(n=r[1][1])||void 0===n?void 0:n.value:null},this._getNamedBoxValue=function(t,e){if(null===t||!e[t])return null;var n,r=e[t],o=Array.isArray(r[1])?r[1][0]:r[1];return"namedbox"!==o&&"namedarg"!==o||!Array.isArray(r[1])?null:null===(n=r[1][1])||void 0===n?void 0:n.value},this._isBase64Data=function(t){return"string"==typeof t&&/^data:(image|audio)\/[a-zA-Z0-9+.-]+;base64,/.test(t)},this._scale=function(){var t,e;this.widgetWindow.isMaximized()?((t=this.widgetWindow.getWidgetBody()).style.width="100%",t.style.height="100%"):((e=this.widgetWindow.getWidgetBody()).style.width="900px",e.style.height="600px")}}