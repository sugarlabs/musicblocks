"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var l=0;l<e.length;l++){var i=e[l];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,_toPropertyKey(i.key),i)}}function _createClass(t,e,l){return e&&_defineProperties(t.prototype,e),l&&_defineProperties(t,l),Object.defineProperty(t,"prototype",{writable:!1}),t}function _defineProperty(t,e,l){return(e=_toPropertyKey(e))in t?Object.defineProperty(t,e,{value:l,enumerable:!0,configurable:!0,writable:!0}):t[e]=l,t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(t,e){if("object"!=_typeof(t)||!t)return t;var l=t[Symbol.toPrimitive];if(void 0===l)return("string"===e?String:Number)(t);var i=l.call(t,e||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}var PitchDrumMatrix=function(){function m(){_classCallCheck(this,m),this.rowLabels=[],this.rowArgs=[],this.drums=[],this._rests=0,this._playing=!1,this._rowBlocks=[],this._colBlocks=[],this._blockMap=[]}return _createClass(m,[{key:"init",value:function(t){var e=this;this.activity=t;var l=window.innerWidth;this._cellScale=l/1200;var i=window.widgetWindows.windowFor(this,"pitch drum");(this.widgetWindow=i).clear(),i.show(),this.playButton=i.addButton("play-button.svg",m.ICONSIZE,_("Play")),this.playButton.onclick=function(){e._playing=!e._playing,e.activity.logo.turtleDelay=0,e._playAll()},this._save_lock=!1,i.addButton("export-chunk.svg",m.ICONSIZE,_("Save")).onclick=function(){e._get_save_lock()||(e._save_lock=!0,e._save(),setTimeout(function(){e._save_lock=!1},1e3))},i.addButton("erase-button.svg",m.ICONSIZE,_("Clear")).onclick=function(){e._clear()},this.pitchDrumDiv=document.createElement("div"),i.getWidgetBody().append(this.pitchDrumDiv),i.getWidgetBody().style.height="400px",i.getWidgetBody().style.width="500px";var o=this.pitchDrumDiv;o.style.position="relative",o.style.visibility="invisible",o.style.border="0px",o.innerHTML="",i.onclose=function(){o.style.visibility="hidden",e.activity.hideMsgs(),i.destroy()},this.widgetWindow.onmaximize=this._scale,o.innerHTML='<div id="pdmOuterDiv"><div id="pdmInnerDiv"><table cellpadding="0px" id="pdmTable"></table></div></div>';for(var n,r,s,a,c=docById("pdmTable"),d=0,h=0;h<this.rowLabels.length;h++)this.rowLabels[h].toLowerCase()!==_("rest")?null==(n=getDrumName(this.rowLabels[h]))?((s=(r=c.insertRow()).insertCell()).style.backgroundColor=platformColor.labelColor,s.style.fontSize=100*this._cellScale+"%",s.style.height=Math.floor(MATRIXSOLFEHEIGHT*this._cellScale)+1+"px",s.style.width=Math.floor(MATRIXSOLFEWIDTH*this._cellScale)+"px",s.style.minWidth=0,s.style.maxWidth=0,s.className="headcol",s.innerHTML=this.rowLabels[d]+this.rowArgs[d].toString().sub(),s.style.position="sticky",s.style.left="0",s.style.top="0",s.style.zIndex="5",(a=r.insertCell()).innerHTML='<table cellpadding="0px" id="pdmCellTable'+d+'"><tr></tr></table>',docById("pdmCellTable"+d).insertRow().setAttribute("id","pdm"+d),d+=1):this.drums.push(n):this._rests+=1;(s=(r=c.insertRow()).insertCell()).style.backgroundColor=platformColor.labelColor,s.style.fontSize=100*this._cellScale+"%",s.style.height=Math.floor(1.5*MATRIXSOLFEHEIGHT*this._cellScale)+"px",s.style.width=Math.floor(MATRIXSOLFEWIDTH*this._cellScale)+"px",s.style.minWidth=Math.floor(MATRIXSOLFEWIDTH*this._cellScale)+"px",s.style.maxWidth=s.style.minWidth,s.className="headcol",s.innerHTML="",s.style.position="sticky",s.style.left="0",s.style.top="0",s.style.bottom="0",s.style.zIndex="20";var y=Math.max(Math.floor(.5*window.innerHeight/100),8),u=docById("pdmOuterDiv");u.style.height=i.getWidgetBody().style.height,u.style.width=i.getWidgetBody().style.width,c.rows.length+2>y?Math.max(Math.min(i.getWidgetBody().style.width,this._cellScale*(this.drums.length*(m.DRUMNAMEWIDTH+2)+MATRIXSOLFEWIDTH+24)),m.BUTTONDIVWIDTH):Math.max(Math.min(window.innerWidth/2,this._cellScale*(this.drums.length*(m.DRUMNAMEWIDTH+2)+MATRIXSOLFEWIDTH)),m.BUTTONDIVWIDTH);var g=docById("pdmInnerDiv");g.style.height=i.getWidgetBody().style.height,g.style.width=i.getWidgetBody().style.width,g.style.marginLeft="0px",(a=r.insertCell()).innerHTML='<table cellpadding="0px" id="pdmDrumTable"><tr></tr></table>',a.style.position="sticky",a.style.bottom="0",a.style.zIndex="10";for(var p=0;p<this.drums.length;p++)this._addDrum(p);i.onmaximize=function(){var t;i._maximized?(i.getWidgetBody().style.position="absolute",i.getWidgetBody().style.height="calc(-95px + 100vh)",i.getWidgetBody().style.width="calc(-55px + 100vw)",i.getWidgetBody().style.left="55px",u.style.height=i.getWidgetBody().style.height,u.style.width=i.getWidgetBody().style.width,g.style.height=i.getWidgetBody().style.height,g.style.width=i.getWidgetBody().style.width):(i.getWidgetBody().style.position="relative",i.getWidgetBody().style.left="0px",i.getWidgetBody().style.height="400px",i.getWidgetBody().style.width="500px",(t=docById("pdmInnerDiv")).style.height=i.getWidgetBody().style.height,t.style.width=i.getWidgetBody().style.width)},t.textMsg(_("Click in the grid to map notes to drums."),3e3)}},{key:"clearBlocks",value:function(){this._rowBlocks=[],this._colBlocks=[]}},{key:"addRowBlock",value:function(t){this._rowBlocks.push(t)}},{key:"addColBlock",value:function(t){this._colBlocks.push(t)}},{key:"addNode",value:function(t,e){for(var l,i=0;i<this._blockMap.length;i++)if((l=this._blockMap[i])[0]===t&&l[1]===e)return;this._blockMap.push([t,e])}},{key:"removeNode",value:function(t,e){for(var l,i=0;i<this._blockMap.length;i++)(l=this._blockMap[i])[0]===t&&l[1]===e&&(this._blockMap[i]=[-1,-1])}},{key:"_get_save_lock",value:function(){return this._save_lock}},{key:"_addButton",value:function(t,e,l,i){var o=t.insertCell(-1);return o.innerHTML='&nbsp;&nbsp;<img \n                src="header-icons/'.concat(e,'" \n                title="').concat(i,'" \n                alt="').concat(i,'" \n                height="').concat(l,'" \n                width="').concat(l,'" \n                vertical-align="middle" \n                align-content="center"\n            >&nbsp;&nbsp;'),o.style.width=m.BUTTONSIZE+"px",o.style.minWidth=o.style.width,o.style.maxWidth=o.style.width,o.style.height=o.style.width,o.style.minHeight=o.style.height,o.style.maxHeight=o.style.height,o.style.backgroundColor=platformColor.selectorBackground,o.onmouseover=function(){o.style.backgroundColor=platformColor.selectorBackgroundHOVER},o.onmouseout=function(){o.style.backgroundColor=platformColor.selectorBackground},o}},{key:"_addDrum",value:function(t){for(var e=this.drums[t],l=docById("pdmTable"),i=0;i<l.rows.length-1;i++)n=docById("pdmCellTable"+i).rows[0],(o=n.insertCell()).style.height=Math.floor(MATRIXSOLFEHEIGHT*this._cellScale)+1+"px",o.width=m.DRUMNAMEWIDTH,o.style.width=o.width,o.style.minWidth=o.style.width,o.style.maxWidth=o.style.width,o.style.backgroundColor=platformColor.selectorBackground,o.style.border="2px solid white",o.style.borderRadius="10px",o.onmouseover=function(){"black"!==o.style.backgroundColor&&(o.style.backgroundColor=platformColor.selectorSelected)},o.onmouseout=function(){"black"!==o.style.backgroundColor&&(o.style.backgroundColor=platformColor.selectorBackground)},o.setAttribute("id",i+","+t);var o,n=docById("pdmDrumTable").rows[0];(o=n.insertCell()).height=Math.floor(1.5*MATRIXSOLFEHEIGHT*this._cellScale)+1+"px",o.width=m.DRUMNAMEWIDTH,o.style.width=o.width,o.style.minWidth=o.style.width,o.style.maxWidth=o.style.width,o.style.height=Math.floor(1.5*MATRIXSOLFEHEIGHT*this._cellScale)+"px",o.style.fontSize=Math.floor(75*this._cellScale)+"%",o.style.lineHeight="100%",o.setAttribute("id",t);var r=getDrumName(e);""===r&&(r=e),o.innerHTML='&nbsp;&nbsp;<img \n                src="'.concat(getDrumIcon(r),'" \n                title="').concat(r,'" \n                alt="').concat(r,'" \n                height="').concat(m.ICONSIZE,'" \n                width="').concat(m.ICONSIZE,'" \n                vertical-align="middle"\n            >&nbsp;&nbsp;'),o.style.backgroundColor=platformColor.selectorBackground}},{key:"makeClickable",value:function(){for(var t,e,l,i,o,n=this,r=docById("pdmTable"),s=docById("pdmDrumTable"),a=0;a<r.rows.length-1;a++){t=docById("pdmCellTable"+a).rows[0];for(var c=0;c<t.cells.length;c++)e=t.cells[c],s.rows[0].cells[c],e.onclick=function(t){var e=t.target,l=e.id.split(",");"black"===e.style.backgroundColor?(e.style.backgroundColor=platformColor.selectorBackground,n._setCellPitchDrum(l[1],l[0],!1)):(e.style.backgroundColor="black",n._setCellPitchDrum(l[1],l[0],!0))}}for(var d=0;d<this._blockMap.length;d++)if(-1!==(l=this._blockMap[d])[0]){i=this._rowBlocks.indexOf(l[0]),o=-1;for(var h=0;h<this._colBlocks.length;h++)if(this._colBlocks[h]===l[1]){o=h;break}if(-1===o)continue;null!=(e=(t=docById("pdmCellTable"+i).rows[0]).cells[o])&&(e.style.backgroundColor="black",this._setPairCell(i,o,e,!1))}}},{key:"_scale",value:function(){var t=this.getWidgetFrame().offsetHeight-this.getDragElement().offsetHeight,e=this.getWidgetBody(),l=this.isMaximized?t/e.offsetHeight:1;e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center",e.children[0].style.display="flex",e.children[0].style.flexDirection="column",e.children[0].style.alignItems="center";var i=this.getWidgetBody().getElementsByTagName("svg")[0];i.style.pointerEvents="none",i.setAttribute("height","".concat(400*l,"px")),i.setAttribute("width","".concat(400*l,"px")),setTimeout(function(){i.style.pointerEvents="auto"},100)}},{key:"_playAll",value:function(){var t=this,e=this.playButton;if(!this._playing)return e.innerHTML='&nbsp;&nbsp;<img \n                    src="header-icons/play-button.svg" \n                    title="'.concat(_("Play"),'" \n                    alt="').concat(_("Play"),'" \n                    height="').concat(m.ICONSIZE,'" \n                    width="').concat(m.ICONSIZE,'" \n                    vertical-align="middle" \n                    align-content="center"\n                >&nbsp;&nbsp;'),void(this._playing=!1);e.innerHTML='&nbsp;&nbsp;<img \n                    src="header-icons/stop-button.svg" \n                    title="'.concat(_("Stop"),'" \n                    alt="').concat(_("Stop"),'" \n                    height="').concat(m.ICONSIZE,'" \n                    width="').concat(m.ICONSIZE,'" \n                    vertical-align="middle" \n                    align-content="center"\n                >&nbsp;&nbsp;'),this.activity.logo.synth.stop();for(var l,i=[],o=docById("pdmTable"),n=0;n<o.rows.length-1;n++){l=docById("pdmCellTable"+n).rows[0];for(var r=void 0,r=0;r<l.cells.length;r++)if("black"===l.cells[r].style.backgroundColor){i.push([n,r]);break}r===l.cells.length&&i.push([n,-1])}for(var s=!0,a=0;a<i.length;a++)if(-1!=i[a][1]){s=!1;break}s?(this.widgetWindow._maximized||activity.textMsg(_("Click in the grid to map notes to drums."),3e3),e.innerHTML='&nbsp;&nbsp;<img \n                    src="header-icons/play-button.svg" \n                    title="'.concat(_("Play"),'" \n                    alt="').concat(_("Play"),'" \n                    height="').concat(m.ICONSIZE,'" \n                    width="').concat(m.ICONSIZE,'" \n                    vertical-align="middle" \n                    align-content="center"\n                >&nbsp;&nbsp;')):(0<i.length&&this._playPitchDrum(0,i),setTimeout(function(){t._playing=!1,e.innerHTML='&nbsp;&nbsp;<img \n                        src="header-icons/play-button.svg" \n                        title="'.concat(_("Play"),'" \n                        alt="').concat(_("Play"),'" \n                        height="').concat(m.ICONSIZE,'" \n                        width="').concat(m.ICONSIZE,'" \n                        vertical-align="middle" \n                        align-content="center"\n                    >&nbsp;&nbsp;')},1e3*i.length))}},{key:"_playPitchDrum",value:function(e,l){var i=this,o=docById("pdmTable");if(this._playing){docById("pdmDrumTable").rows[0];var t=docById("pdmCellTable"+e).rows[0].cells[e];(o=docById("pdmTable")).rows[e].cells[0].style.backgroundColor=platformColor.selectorBackground,-1!==l[e][1]&&this._setPairCell(l[e][0],l[e][1],t,!0),e<l.length-1?setTimeout(function(){var t=e+1;i._playPitchDrum(t,l)},1e3):setTimeout(function(){for(var t=0;t<o.rows.length-1;t++)o.rows[t].cells[0].style.backgroundColor=platformColor.labelColor},1e3)}else{for(var n=0;n<e;n++)o.rows[n].cells[0].style.backgroundColor=platformColor.labelColor;this.playButton.innerHTML='&nbsp;&nbsp;<img \n                    src="header-icons/play-button.svg" \n                    title="'.concat(_("Play"),'" \n                    alt="').concat(_("Play"),'" \n                    height="').concat(m.ICONSIZE,'" \n                    width="').concat(m.ICONSIZE,'" \n                    vertical-align="middle" \n                    align-content="center"\n                >&nbsp;&nbsp;')}}},{key:"_setCellPitchDrum",value:function(t,e,l){var i,o,n,r=Number(t),s=Number(e),a=docById("pdmDrumTable").rows[0],c=docById("pdmCellTable"+s),a=c.rows[0];if(l)for(var d,h=0;h<a.cells.length;h++)h!==r&&"black"===(n=a.cells[h]).style.backgroundColor&&(i=this._rowBlocks[s],o=this._colBlocks[h],this.removeNode(i,o),n.style.backgroundColor=platformColor.selectorBackground,d=n.id.split(","),this._setCellPitchDrum(Number(d[0]),Number(d[1]),!1));i=this._rowBlocks[s],o=this._colBlocks[r],l?this.addNode(i,o):this.removeNode(i,o),a=docById("pdmCellTable"+s).rows[0];for(var y=0;y<a.cells.length;y++)"black"===(n=a.cells[y]).style.backgroundColor&&this._setPairCell(s,y,n,l)}},{key:"_setPairCell",value:function(t,e,l,i){var o,n=this,r=docById("pdmTable").rows[t].cells[0].innerHTML,s=docById("pdmDrumTable").rows[0].cells[e].innerHTML.split('"'),a=getDrumSynthName(s[3]),c=getNote(r,-1,0,this.activity.turtles.ithTurtle(0).singer.keySignature,!1,null,this.activity.errorMsg),d=c[0]+c[1];i&&(o=1e3*Singer.defaultBPMFactor*.25,this.activity.logo.synth.trigger(0,d.replace(/♭/g,"b").replace(/♯/g,"#"),.125,"default",null,null),setTimeout(function(){n.activity.logo.synth.trigger(0,"C2",.125,a,null,null)},o))}},{key:"_clear",value:function(){for(var t,e,l=docById("pdmTable"),i=0;i<l.rows.length-1;i++){t=docById("pdmCellTable"+i).rows[0];for(var o=0;o<t.cells.length;o++)"black"===(e=t.cells[o]).style.backgroundColor&&(e.style.backgroundColor=platformColor.selectorBackground,this._setCellPitchDrum(o,i,!1))}}},{key:"_save",value:function(){for(var t in this.activity.blocks.palettes.dict)this.activity.blocks.palettes.dict[t].hideMenu(!0);this.activity.refreshCanvas();for(var e,l=[],i=docById("pdmTable"),o=docById("pdmDrumTable"),n=0;n<i.rows.length-1;n++){e=docById("pdmCellTable"+n).rows[0];for(var r=0;r<e.cells.length;r++)"black"!==e.cells[r].style.backgroundColor||l.push([n,r])}if(0!==l.length){for(var s,a,c,d,h,y,u,g,p,m,b,f,v,_=[[0,["action",{collapsed:!0}],100,100,[null,1,2,null]],[1,["text",{value:"drums"}],0,0,[0]]],k=0,w=0;w<l.length;w++)e=l[w][0],s=l[w][1],a=i.rows[e].cells[0].innerHTML,c=o.rows[0].cells[s].innerHTML.split('"'),d=getDrumSynthName(c[3]),y=(h=getNote(a,-1,0,this.activity.turtles.ithTurtle(0).singer.keySignature,!1,null,this.activity.errorMsg))[0],u=h[1],p=(g=_.length)+1,m=g+2,b=g+3,f=g+4,v=g+5,_.push([g,"mapdrum",0,0,[k,p,m,v]]),_.push([p,["drumname",{value:d}],0,0,[g]]),_.push([m,"pitch",0,0,[g,b,f,null]]),_.push([b,["solfege",{value:SOLFEGECONVERSIONTABLE[y]}],0,0,[m]]),_.push([f,["number",{value:u}],0,0,[m]]),w===l.length-1?_.push([v,"hidden",0,0,[g,null]]):_.push([v,"hidden",0,0,[g,v+1]]),k=v;this.activity.blocks.loadNewBlocks(_)}}}]),m}();_defineProperty(PitchDrumMatrix,"BUTTONDIVWIDTH",295),_defineProperty(PitchDrumMatrix,"DRUMNAMEWIDTH",50),_defineProperty(PitchDrumMatrix,"OUTERWINDOWWIDTH",128),_defineProperty(PitchDrumMatrix,"INNERWINDOWWIDTH",50),_defineProperty(PitchDrumMatrix,"BUTTONSIZE",53),_defineProperty(PitchDrumMatrix,"ICONSIZE",32);