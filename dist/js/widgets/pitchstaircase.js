"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,_toPropertyKey(s.key),s)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function _defineProperty(t,e,i){return(e=_toPropertyKey(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(t,e){if("object"!=_typeof(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0===i)return("string"===e?String:Number)(t);var s=i.call(t,e||"default");if("object"!=_typeof(s))return s;throw new TypeError("@@toPrimitive must return a primitive value.")}var PitchStaircase=function(){function y(){_classCallCheck(this,y),this.Stairs=[],this.stairPitchBlocks=[],this._stepTables=[],this._musicRatio1=null,this._musicRatio2=null}return _createClass(y,[{key:"_addButton",value:function(t,e,i,s){var r=t.insertCell(-1);return r.innerHTML='&nbsp;&nbsp;<img \n                src="header-icons/play-button.svg" \n                title="'.concat(s,'" \n                alt="').concat(s,'" \n                height="').concat(i,'" \n                width="').concat(i,'" \n                vertical-align="middle" \n                align-content="center"\n            >&nbsp;&nbsp;'),r.style.width=y.BUTTONSIZE+"px",r.style.minWidth=r.style.width,r.style.maxWidth=r.style.width,r.style.height=r.style.width,r.style.minHeight=r.style.height,r.style.maxHeight=r.style.height,r.style.backgroundColor=platformColor.selectorBackground,r.onmouseover=function(){r.style.backgroundColor=platformColor.selectorBackgroundHOVER},r.onmouseout=function(){r.style.backgroundColor=platformColor.selectorBackground},r}},{key:"_makeStairs",value:function(){var p=this,d=this._pscTable;d.innerHTML="",d.style.textAlign="center";for(var t=0;t<this.Stairs.length;t++)!function(t){var e=d.insertRow().insertCell(),i=document.createElement("table");p._stepTables[t]=i,e.append(i);var s=i.insertRow(),r=p.Stairs[t][2],a=p._addButton(s,"play-button.svg",y.ICONSIZE,_("Play"));a.className="headcol",a.setAttribute("id",t),a.style.cursor="pointer";var o=s.insertCell();o.setAttribute("id",r),o.style.width=y.INNERWINDOWWIDTH*parseFloat(y.DEFAULTFREQUENCY/r)*p._cellScale/3+"px",o.innerHTML="".concat(r.toFixed(2),"<br>").concat(p.Stairs[t][0]).concat(p.Stairs[t][1]),o.style.minWidth=o.style.width,o.style.maxWidth=o.style.width,o.style.height=y.BUTTONSIZE+"px",o.style.backgroundColor=platformColor.selectorBackground;var l=Number(o.style.width.replace(/px/,"")),n=l.toString(),c=(l/55).toString(),u=(165/l).toString(),h="data:image/svg+xml;base64,"+window.btoa(base64Encode(SYNTHSVG.replace(/SVGWIDTH/g,n).replace(/XSCALE/g,c).replace(/STOKEWIDTH/g,u)));o.style.backgroundImage="url("+h+")",o.style.backgroundRepeat="no-repeat",o.style.backgroundPosition="center center",o.addEventListener("click",function(t){p._dissectStair(t)}),a.onclick=function(){var t=a.getAttribute("id"),e=p._stepTables[t].rows[0].cells[1];p._playOne(e)}}(t)}},{key:"_undo",value:function(){if(0===this._history.length)return!1;var t=this._history.pop();return this.Stairs.splice(t,1),this._refresh(),!0}},{key:"_dissectStair",value:function(t){var e=this._musicRatio1.value,e=isNaN(e)?3:Math.abs(Math.floor(e));this._musicRatio1.value=e;var i=this._musicRatio2.value,i=isNaN(i)?2:Math.abs(Math.floor(i));this._musicRatio2.value=i;for(var s=parseFloat(i/e),r=t.target,a=Number(r.getAttribute("id")),o=0;o<this.Stairs.length&&this.Stairs[o][2]!==a;o++);if(o!==this.Stairs.length){for(var l=frequencyToPitch(parseFloat(a)/s),n=!1,c=!1,u=!0,h=0;h<this.Stairs.length;h++){if(this.Stairs[h][2]<parseFloat(a)/s){this.Stairs.splice(h,0,[l[0],l[1],parseFloat(a)/s,this.Stairs[o][3]*parseFloat(i),this.Stairs[o][4]*parseFloat(e),this.Stairs[o][2],this.Stairs[o][6]]),n=!0;break}if(this.Stairs[h][2]===parseFloat(a)/s){this.Stairs.splice(h,1,[l[0],l[1],parseFloat(a)/s,this.Stairs[o][3]*parseFloat(i),this.Stairs[o][4]*parseFloat(e),this.Stairs[o][2],this.Stairs[o][6]]),u=!(c=n=!0);break}}n?c||this._history.push(h):(this.Stairs.push([l[0],l[1],parseFloat(a)/s,this.Stairs[o][3]*parseFloat(i),this.Stairs[o][4]*parseFloat(e),this.Stairs[o][2],this.Stairs[o][6]]),this._history.push(this.Stairs.length-1)),this._makeStairs(u)}}},{key:"_playOne",value:function(t){t.style.backgroundColor=platformColor.selectorBackground;var e=Number(t.getAttribute("id"));this.activity.logo.synth.trigger(0,e,1,DEFAULTVOICE,null,null),setTimeout(function(){t.style.backgroundColor=platformColor.selectorBackground},1e3)}},{key:"_playAll",value:function(){for(var e=this,t=[],i=0;i<this.Stairs.length;i++){var s=this.Stairs[i][0]+this.Stairs[i][1];t.push(s.replace(/♭/g,"b").replace(/♯/g,"#")),this._stepTables[i].rows[0].cells[1].style.backgroundColor=platformColor.selectorBackground,this.activity.logo.synth.trigger(0,t,1,DEFAULTVOICE,null,null)}setTimeout(function(){for(var t=0;t<e.Stairs.length;t++){e._stepTables[t].rows[0].cells[1].style.backgroundColor=platformColor.selectorBackground}},1e3)}},{key:"playUpAndDown",value:function(){var t=[],e=this.Stairs[this.Stairs.length-1][0]+this.Stairs[this.Stairs.length-1][1];t.push(e.replace(/♭/g,"b").replace(/♯/g,"#"));var i=this.Stairs.length-1;this._stepTables[i].rows[0].cells[1].style.backgroundColor=platformColor.selectorBackground,this.activity.logo.synth.trigger(0,t,1,DEFAULTVOICE,null,null),this._playNext(this.Stairs.length-2,-1)}},{key:"_playNext",value:function(t,e){var i=this;if(!this.closed)if(t!==this.Stairs.length){if(-1===t)return setTimeout(function(){for(var t=0;t<i.Stairs.length;t++){i._stepTables[t].rows[0].cells[1].style.backgroundColor=platformColor.selectorBackground}},1e3),void setTimeout(function(){i._playNext(0,1)},200);var s=[],r=this.Stairs[t][0]+this.Stairs[t][1];s.push(r.replace(/♭/g,"b").replace(/♯/g,"#"));var a=t-e,o=this._stepTables[a];setTimeout(function(){null!=o&&(o.rows[0].cells[1].style.backgroundColor=platformColor.selectorBackground),i._stepTables[t].rows[0].cells[1].style.backgroundColor=platformColor.selectorBackground,i.activity.logo.synth.trigger(0,s,1,DEFAULTVOICE,null,null),(t<i.Stairs.length||-1<t)&&i._playNext(t+e,e)},1e3)}else setTimeout(function(){for(var t=0;t<i.Stairs.length;t++){i._stepTables[t].rows[0].cells[1].style.backgroundColor=platformColor.selectorBackground}},1e3)}},{key:"_save",value:function(){for(var t in this.activity.palettes.dict)this.activity.palettes.dict[t].hideMenu(!0);this.activity.refreshCanvas();for(var e=[[0,["action",{collapsed:!0}],100,100,[null,1,2,null]],[1,["text",{value:"stair"}],0,0,[0]]],i=0,s=0;s<this.Stairs.length;s++){var r,a,o,l,n,c,u,h,p,d=this.Stairs[s][2],y=frequencyToPitch(d),g=void 0,f=void 0,v=void 0;0===y[2]?(a=(g=r=e.length)+1,o=r+2,f=r+3,v="hidden",e.push([g,"pitch",0,0,[i,a,o,f]]),e.push([a,["notename",{value:y[0]}],0,0,[r]]),e.push([o,["number",{value:y[1]}],0,0,[r]])):(l=(g=e.length)+1,n=g+2,c=g+3,u=g+4,h=g+5,p=g+6,f=g+7,v="vspace",e.push([g,"hertz",0,0,[i,l,p]]),e.push([l,"multiply",0,0,[g,n,c]]),e.push([n,["number",{value:this.Stairs[s][6].toFixed(2)}],0,0,[l]]),e.push([c,"divide",0,0,[l,u,h]]),e.push([u,["number",{value:this.Stairs[s][4]}],0,0,[c]]),e.push([h,["number",{value:this.Stairs[s][3]}],0,0,[c]]),e.push([p,"vspace",0,0,[g,f]]),g=p),s===this.Stairs.length-1?e.push([f,v,0,0,[g,null]]):e.push([f,v,0,0,[g,f+1]]),i=f}this.activity.blocks.loadNewBlocks(e),activity.textMsg(_("New action block generated."),3e3)}},{key:"_get_save_lock",value:function(){return this._save_lock}},{key:"init",value:function(t){var e=this;this.activity=t;for(var i=0;i<this.Stairs.length;i++)this.Stairs[i].push(this.Stairs[i][2]),this.Stairs[i].push(this.Stairs[i][2]);this._history=[];var s=window.innerWidth;this._cellScale=s/1200;var r=window.widgetWindows.windowFor(this,"pitch staircase","pitch staircase",!0);(this.widgetWindow=r).clear(),r.show(),r.onclose=function(){e.activity.logo.synth.setMasterVolume(0),e.closed=!0,r.destroy()},this.closed=!1,r.addButton("play-chord.svg",y.ICONSIZE,_("Play chord")).onclick=function(){e._playAll()},r.addButton("play-scale.svg",y.ICONSIZE,_("Play scale")).onclick=function(){e.playUpAndDown()},this._save_lock=!1,r.addButton("export-chunk.svg",y.ICONSIZE,_("Save")).onclick=function(){e._get_save_lock()||(e._save_lock=!0,e._save(),setTimeout(function(){e._save_lock=!1},1e3))};var a=document.getElementsByClassName("wfbWidget")[0];a.style.maxHeight=10*y.BUTTONSIZE+"px",a.style.overflowY="scroll",this._musicRatio1=r.addInputButton("3"),r.addDivider(),this._musicRatio2=r.addInputButton("2"),r.addButton("restore-button.svg",y.ICONSIZE,_("Undo")).onclick=function(){e._undo()},r.addButton("erase-button.svg",y.ICONSIZE,_("Clear")).onclick=function(){for(;e._undo(););},this._pscTable=document.createElement("table"),r.getWidgetBody().append(this._pscTable),this._refresh(),t.textMsg(_("Click on a note to create a new step."),3e3),r.onmaximize=function(){r._maximized?a.style.maxHeight=16*y.BUTTONSIZE+"px":a.style.maxHeight=10*y.BUTTONSIZE+"px"}}},{key:"_refresh",value:function(){this._makeStairs(!0)}}]),y}();_defineProperty(PitchStaircase,"BUTTONDIVWIDTH",476),_defineProperty(PitchStaircase,"OUTERWINDOWWIDTH",685),_defineProperty(PitchStaircase,"INNERWINDOWWIDTH",600),_defineProperty(PitchStaircase,"BUTTONSIZE",53),_defineProperty(PitchStaircase,"ICONSIZE",32),_defineProperty(PitchStaircase,"DEFAULTFREQUENCY",220);