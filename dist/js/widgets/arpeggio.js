"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var l=0;l<t.length;l++){var i=t[l];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,_toPropertyKey(i.key),i)}}function _createClass(e,t,l){return t&&_defineProperties(e.prototype,t),l&&_defineProperties(e,l),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,t,l){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:l,enumerable:!0,configurable:!0,writable:!0}):e[t]=l,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var l=e[Symbol.toPrimitive];if(void 0===l)return("string"===t?String:Number)(e);var i=l.call(e,t||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}var Arpeggio=function(){function b(){_classCallCheck(this,b),this.notesToPlay=[],this._blockMap=[],this.defaultCols=b.DEFAULTCOLS}return _createClass(b,[{key:"init",value:function(e){var t=this;this._activity=e,this._rowLabels=[],this._rowBlocks=[];for(var l=getTemperament(this._activity.logo.synth.whichTemperament()),i=0;i<l.pitchNumber+1;i++)this._rowBlocks.push(i),this._rowLabels.push((l.pitchNumber-i).toString());this._modeNumbers=getModeNumbers(keySignatureToMode(this._activity.turtles.ithTurtle(0).singer.keySignature)[1]).split(" "),this._playing=!1,this._playList=[],this._colBlocks=[];for(var o=0;o<this.defaultCols;o++)this._colBlocks.push(o+1);var n=window.innerWidth;this._cellScale=n/1200;var r=window.widgetWindows.windowFor(this,"arpeggio");(this.widgetWindow=r).clear(),r.show(),this.playButton=r.addButton("play-button.svg",b.ICONSIZE,_("Play")),this.playButton.onclick=function(){t._playing=!t._playing,t._activity.logo.turtleDelay=0,t._playAll()},this._save_lock=!1,r.addButton("export-chunk.svg",b.ICONSIZE,_("Save")).onclick=function(){t._get_save_lock()||(t._save_lock=!0,t._save(),setTimeout(function(){t._save_lock=!1},1e3))},r.addButton("erase-button.svg",b.ICONSIZE,_("Clear")).onclick=function(){t._clear()},this.arpeggioDiv=document.createElement("div"),r.getWidgetBody().append(this.arpeggioDiv),r.getWidgetBody().style.height="400px",r.getWidgetBody().style.width="400px";var s=this.arpeggioDiv;s.style.display="inline",s.style.visibility="visible",s.style.border="0px",s.innerHTML="",r.onclose=function(){s.style.visibility="hidden",t._activity.hideMsgs(),r.destroy()},this.widgetWindow.onmaximize=this._scale,s.innerHTML='<div id="arpeggioOuterDiv"><div id="arpeggioInnerDiv"><table cellpadding="0px" id="arpeggioTable"></table></div></div>';for(var a,c,h=docById("arpeggioTable"),g=0,d=0;d<this._rowLabels.length;d++)(c=(a=h.insertRow()).insertCell()).style.backgroundColor=platformColor.labelColor,c.style.fontSize=50*this._cellScale+"%",c.style.height=b.CELLSIZE+"px",c.style.width=b.CELLSIZE+"px",c.style.minWidth=0,c.style.maxWidth=0,c.className="headcol",c.innerHTML=this._rowLabels[g],a.insertCell().innerHTML='<table cellpadding="0px" id="arpeggioCellTable'.concat(g,'">\n                    <tr></tr>\n                </table>'),docById("arpeggioCellTable"+g).insertRow().setAttribute("id","arpeggio"+g),g+=1;(c=(a=h.insertRow()).insertCell()).style.backgroundColor=platformColor.labelColor,c.style.fontSize=50*this._cellScale+"%",c.style.height=b.CELLSIZE+"px",c.style.width=b.CELLSIZE+"px",c.style.minWidth=b.CELLSIZE+"px",c.style.maxWidth=c.style.minWidth,c.className="headcol",c.innerHTML="";var y=docById("arpeggioOuterDiv");y.style.height=r.getWidgetBody().style.height,y.style.width=r.getWidgetBody().style.width,y.style.marginLeft="0px";var u=docById("arpeggioInnerDiv");u.style.height=r.getWidgetBody().style.height,u.style.width=r.getWidgetBody().style.width,u.style.marginLeft="0px",a.insertCell().innerHTML='<table cellpadding="0px" id="arpeggioNoteTable"><tr></tr></table>';for(var p=0;p<this.defaultCols;p++)this._addNote(p);r.onmaximize=function(){r._maximized?(r.getWidgetBody().style.position="absolute",r.getWidgetBody().style.height="calc(100vh - 80px)",r.getWidgetBody().style.width="200vh",docById("arpeggioOuterDiv").style.height="calc(100vh - 80px)",docById("arpeggioOuterDiv").style.width="calc(200vh - 64px)",docById("arpeggioInnerDiv").style.width="calc(200vh - 64px)",docById("arpeggioInnerDiv").style.height="calc(100vh - 80px)",r.getWidgetBody().style.left="70px"):(r.getWidgetBody().style.position="relative",r.getWidgetBody().style.left="0px",r.getWidgetBody().style.height="400px",r.getWidgetBody().style.width="400px",u.style.height=r.getWidgetBody().style.height,u.style.width=r.getWidgetBody().style.width)},this.makeClickable(),e.textMsg(_("Click in the grid to add steps to the arpeggio."),3e3)}},{key:"clearBlocks",value:function(){this._rowBlocks=[],this._colBlocks=[]}},{key:"addNode",value:function(e,t){for(var l,i=0;i<this._blockMap.length;i++)if((l=this._blockMap[i])[0]===e&&l[1]===t)return;this._blockMap.push([e,t])}},{key:"removeNode",value:function(e,t){for(var l,i=0;i<this._blockMap.length;i++)(l=this._blockMap[i])[0]===e&&l[1]===t&&(this._blockMap[i]=[-1,-1])}},{key:"_get_save_lock",value:function(){return this._save_lock}},{key:"_addButton",value:function(e,t,l,i){var o=e.insertCell(-1);return o.innerHTML='&nbsp;&nbsp;<img \n                src="header-icons/'.concat(t,'" \n                title="').concat(i,'" \n                alt="').concat(i,'" \n                height="').concat(l,'" \n                width="').concat(l,'" \n                vertical-align="middle" \n                align-content="center"\n            >&nbsp;&nbsp;'),o.style.width=b.BUTTONSIZE+"px",o.style.minWidth=o.style.width,o.style.maxWidth=o.style.width,o.style.height=o.style.width,o.style.minHeight=o.style.height,o.style.maxHeight=o.style.height,o.style.backgroundColor=platformColor.selectorBackground,o.onmouseover=function(){o.style.backgroundColor=platformColor.selectorBackgroundHOVER},o.onmouseout=function(){o.style.backgroundColor=platformColor.selectorBackground},o}},{key:"_inMode",value:function(e){return this._modeNumbers.includes(e.toString())}},{key:"_rowInMode",value:function(e){var t=(this._rowLabels.length-e-1)%(this._rowLabels.length-1);return this._inMode(t)}},{key:"_getBackgroundColor",value:function(e){return this._rowInMode(e)?platformColor.selectorSelected:platformColor.selectorBackground}},{key:"_addNote",value:function(e){for(var t=(e+1).toString(),l=docById("arpeggioTable"),i=0;i<l.rows.length-1;i++)n=docById("arpeggioCellTable"+i).rows[0],(o=n.insertCell()).style.height=b.CELLSIZE+"px",o.width=b.CELLSIZE,o.style.width=o.width,o.style.minWidth=o.style.width,o.style.maxWidth=o.style.width,o.style.backgroundColor=this._getBackgroundColor(i),o.style.border="2px solid white",o.style.borderRadius="10px",o.setAttribute("id",i+","+e),o.onmouseover=function(){"black"!==o.style.backgroundColor&&(o.style.backgroundColor=platformColor.selectorSelected)},o.onmouseout=function(){"black"!==o.style.backgroundColor&&(o.style.backgroundColor=platformColor.selectorBackground)};var o,n=docById("arpeggioNoteTable").rows[0];(o=n.insertCell()).height=b.CELLSIZE+1+"px",o.width=b.CELLSIZE,o.style.width=o.width+"px",o.style.minWidth=o.style.width,o.style.maxWidth=o.style.width,o.style.height=b.CELLSIZE+"px",o.style.fontSize=Math.floor(50*this._cellScale)+"%",o.style.lineHeight="100%",o.setAttribute("id",e),o.className="headcol",o.innerHTML=t,o.style.backgroundColor=platformColor.selectorBackground}},{key:"makeClickable",value:function(){for(var e,t,l,i,o,n=this,r=docById("arpeggioTable"),s=docById("arpeggioNoteTable"),a=0;a<r.rows.length-1;a++){e=docById("arpeggioCellTable"+a).rows[0];for(var c=0;c<e.cells.length;c++)t=e.cells[c],s.rows[0].cells[c],t.onclick=function(e){var t=e.target,l=t.id.split(",");"black"===t.style.backgroundColor?(t.style.backgroundColor=n._getBackgroundColor(Number(l[0])),n._setCell(l[1],l[0],!1)):(n._clearColumn(l[1],l[0]),t.style.backgroundColor="black",n._setCell(l[1],l[0],!0))}}for(var h=0;h<this._blockMap.length;h++)if(-1!==(l=this._blockMap[h])[0]){i=this._rowBlocks.indexOf(l[0]),o=-1;for(var g=0;g<this._colBlocks.length;g++)if(this._colBlocks[g]===l[1]){o=g;break}if(-1===o)continue;if(i<0)continue;null!=(t=(e=docById("arpeggioCellTable"+i).rows[0]).cells[o])&&(t.style.backgroundColor="black",this.__playCell(i,o,t,!1))}}},{key:"_scale",value:function(){var e=this.getWidgetFrame().offsetHeight-this.getDragElement().offsetHeight,t=this.getWidgetBody(),l=this.isMaximized?e/t.offsetHeight:1;t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="center",t.children[0].style.display="flex",t.children[0].style.flexDirection="column",t.children[0].style.alignItems="center";var i=this.getWidgetBody().getElementsByTagName("svg")[0];i.style.pointerEvents="none",i.setAttribute("height","".concat(400*l,"px")),i.setAttribute("width","".concat(400*l,"px")),setTimeout(function(){i.style.pointerEvents="auto"},100)}},{key:"_playAll",value:function(){var e=this.playButton;if(!this._playing)return e.innerHTML='&nbsp;&nbsp;<img \n                    src="header-icons/play-button.svg" \n                    title="'.concat(_("Play"),'" \n                    alt="').concat(_("Play"),'" \n                    height="').concat(b.ICONSIZE,'" \n                    width="').concat(b.ICONSIZE,'" \n                    vertical-align="middle" \n                    align-content="center"\n                >&nbsp;&nbsp;'),void(this._playing=!1);e.innerHTML='&nbsp;&nbsp;<img \n                    src="header-icons/stop-button.svg" \n                    title="'.concat(_("Stop"),'" \n                    alt="').concat(_("Stop"),'" \n                    height="').concat(b.ICONSIZE,'" \n                    width="').concat(b.ICONSIZE,'" \n                    vertical-align="middle" \n                    align-content="center"\n                >&nbsp;&nbsp;'),this._activity.logo.synth.stop();var t=this.__makePairsList();this._playList=[];for(var l=0;l<this.notesToPlay.length;l++)for(var i=this.notesToPlay[l][1],o=this.notesToPlay[l][0].slice(0,-1),n=Number(this.notesToPlay[l][0].substr(this.notesToPlay[l][0].length-1)),r=0;r<t.length;r++)-1===t[r][0]?this._playList.push(["",i]):this._playList.push([getNote(o,n,this._rowLabels.length-t[r][0]-1,this._activity.turtles.ithTurtle(0).singer.keySignature,!1,null,this._activity.errorMsg),i]);this.__playNote(0)}},{key:"__makePairsList",value:function(){for(var e=[],t=docById("arpeggioTable"),l=0;l<this.defaultCols;l++){for(var i=[-1,l],o=0;o<t.rows.length-1;o++)if("black"===docById("arpeggioCellTable"+o).rows[0].cells[l].style.backgroundColor){i=[o,l];break}e.push(i)}return e}},{key:"__playNote",value:function(e){var t=this;e<this._playList.length?(0<this._playList[e][0].length&&this._activity.logo.synth.trigger(0,this._playList[e][0][0].replace(/♭/g,"b").replace(/♯/g,"#")+this._playList[e][0][1],this._playList[e][1],"default",null,null,null),setTimeout(function(){t.__playNote(e+1)},2600*this._playList[e][1])):(this.playButton.innerHTML='&nbsp;&nbsp;<img \n                    src="header-icons/play-button.svg" \n                    title="'.concat(_("Play"),'" \n                    alt="').concat(_("Play"),'" \n                    height="').concat(b.ICONSIZE,'" \n                    width="').concat(b.ICONSIZE,'" \n                    vertical-align="middle" \n                    align-content="center"\n                >&nbsp;&nbsp;'),this._playing=!1)}},{key:"_setCell",value:function(e,t,l){var i,o=Number(e),n=Number(t),r=docById("arpeggioCellTable"+n).rows[0],s=this._rowBlocks[n],a=this._colBlocks[o];l?this.addNode(s,a):this.removeNode(s,a);for(var c=0;c<r.cells.length;c++)"black"===(i=r.cells[c]).style.backgroundColor&&this.__playCell(n,c,i,l)}},{key:"__playCell",value:function(e,t,l,i){var o,n,r,s;i&&(n=0===this.notesToPlay.length?(o="C",4):(o=this.notesToPlay[0][0].slice(0,-1),Number(this.notesToPlay[0][0].substr(this.notesToPlay[0][0].length-1))),s=(r=getNote(o,n,this._rowLabels.length-e-1,this._activity.turtles.ithTurtle(0).singer.keySignature,!1,null,this._activity.errorMsg))[0]+r[1],this._activity.logo.synth.trigger(0,s.replace(/♭/g,"b").replace(/♯/g,"#"),this.notesToPlay[0][1],"default",null,null,null))}},{key:"_clearColumn",value:function(e,t){for(var l,i=docById("arpeggioTable"),o=0;o<i.rows.length-1;o++)o!==t&&"black"===(l=docById("arpeggioCellTable"+o).rows[0].cells[e]).style.backgroundColor&&(l.style.backgroundColor=this._getBackgroundColor(o),this._setCell(e,o,!1))}},{key:"_clear",value:function(){for(var e,t,l=docById("arpeggioTable"),i=0;i<l.rows.length-1;i++){e=docById("arpeggioCellTable"+i).rows[0];for(var o=0;o<e.cells.length;o++)"black"===(t=e.cells[o]).style.backgroundColor&&(t.style.backgroundColor=this._getBackgroundColor(i),this._setCell(o,i,!1))}}},{key:"_save",value:function(){for(var e=this.__makePairsList(),t=[],l=0;l<e.length;l++)if(-1===e[l][0])t.push(["-","-"]);else{var i=this._rowBlocks.length-e[l][0]-1;if(this._inMode(i))t.push([this._modeNumbers.indexOf(i.toString()),0]);else if(0===e[l][0])t.push([this._modeNumbers.length,0]);else for(var o=1;0<=i-o;){if(this._inMode(i-o)){t.push([this._modeNumbers.indexOf((i-o).toString()),o]);break}o+=1}}console.log(t),setCustomChord(t);this._activity.blocks.loadNewBlocks([[0,"arpeggio",100,100,[null,1,2,11]],[1,["chordname",{value:"custom"}],0,0,[0]],[2,["newnote",{collapsed:!1}],0,0,[0,3,6,10]],[3,"divide",0,0,[2,4,5]],[4,["number",{value:1}],0,0,[3]],[5,["number",{value:12}],0,0,[3]],[6,"vspace",0,0,[2,7]],[7,"pitch",0,0,[6,8,9,null]],[8,["solfege",{value:"do"}],0,0,[7]],[9,["number",{value:4}],0,0,[7]],[10,"hidden",0,0,[2,null]],[11,"hidden",0,0,[0,null]]])}}]),b}();_defineProperty(Arpeggio,"BUTTONDIVWIDTH",295),_defineProperty(Arpeggio,"CELLSIZE",28),_defineProperty(Arpeggio,"BUTTONSIZE",53),_defineProperty(Arpeggio,"ICONSIZE",32),_defineProperty(Arpeggio,"DEFAULTCOLS",4);