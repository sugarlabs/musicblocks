"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,_toPropertyKey(s.key),s)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function _defineProperty(t,e,i){return(e=_toPropertyKey(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(t,e){if("object"!=_typeof(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0===i)return("string"===e?String:Number)(t);var s=i.call(t,e||"default");if("object"!=_typeof(s))return s;throw new TypeError("@@toPrimitive must return a primitive value.")}var Tempo=function(){function h(){_classCallCheck(this,h),this._xradius=h.YRADIUS/3,this.BPMs=[],this.BPMInputs=[],this.BPMBlocks=[],this.tempoCanvases=[]}return _createClass(h,[{key:"init",value:function(t){var s=this;this.activity=t,this._directions=[],this._widgetFirstTimes=[],this._widgetNextTimes=[],this._firstClickTimes=null,this._intervals=[],this.isMoving=!0,null!=this._intervalID&&null!=this._intervalID&&clearInterval(this._intervalID),this._intervalID=null,this.activity.logo.synth.loadSynth(0,getDrumSynthName(h.TEMPOSYNTH)),null!=this._intervalID&&clearInterval(this._intervalID);var e=window.widgetWindows.windowFor(this,"tempo","tempo",!0);(this.widgetWindow=e).clear(),e.show(),e.onclose=function(){null!=s._intervalID&&clearInterval(s._intervalID),e.destroy()};var i,n,r,o,a=e.addButton("pause-button.svg",h.ICONSIZE,_("Pause"));a.onclick=function(){s.isMoving?(s.pause(),a.innerHTML='<img \n                        src="header-icons/play-button.svg" \n                        title="'.concat(_("Play"),'" \n                        alt="').concat(_("Play"),'" \n                        height="').concat(h.ICONSIZE,'" \n                        width="').concat(h.ICONSIZE,'" \n                        vertical-align="middle"\n                    >'),s.isMoving=!1):(s.resume(),a.innerHTML='<img \n                        src="header-icons/pause-button.svg" \n                        title="'.concat(_("Pause"),'" \n                        alt="').concat(_("Pause"),'" \n                        height="').concat(h.ICONSIZE,'" \n                        width="').concat(h.ICONSIZE,'" \n                        vertical-align="middle"\n                    >'),s.isMoving=!0)},this._save_lock=!1,e.addButton("export-chunk.svg",h.ICONSIZE,_("Save tempo"),"").onclick=function(){s._get_save_lock()||(s._save_lock=!0,s._saveTempo(),setTimeout(function(){return s._save_lock=!1},1e3))},this.bodyTable=document.createElement("table"),this.widgetWindow.getWidgetBody().appendChild(this.bodyTable);for(var l=0;l<this.BPMs.length;l++)this._directions.push(1),this._widgetFirstTimes.push(this.activity.logo.firstNoteTime),this.BPMs[l]<=0&&(this.BPMs[l]=30),this._intervals.push(60/this.BPMs[l]*1e3),this._widgetNextTimes.push(this._widgetFirstTimes[l]-this._intervals[l]),i=this.bodyTable.insertRow(),n=this.bodyTable.insertRow(),r=this.bodyTable.insertRow(),e.addButton("up.svg",h.ICONSIZE,_("speed up"),i.insertCell()).onclick=function(t){return function(){return s.speedUp(t)}}(l),e.addButton("down.svg",h.ICONSIZE,_("slow down"),n.insertCell()).onclick=function(t){return function(){return s.slowDown(t)}}(l),this.BPMInputs[l]=e.addInputButton(this.BPMs[l],r.insertCell()),this.tempoCanvases[l]=document.createElement("canvas"),this.tempoCanvases[l].style.width=h.TEMPOWIDTH+"px",this.tempoCanvases[l].style.height=h.TEMPOHEIGHT+"px",this.tempoCanvases[l].style.margin="1px",this.tempoCanvases[l].style.background="rgba(255, 255, 255, 1)",(o=i.insertCell()).appendChild(this.tempoCanvases[l]),o.setAttribute("rowspan","3"),this.tempoCanvases[l].onclick=function(i){return function(){var t,e=new Date;null!=s._firstClickTime&&29<(t=parseInt(6e4/(e.getTime()-s._firstClickTime)))&&t<1001?(s.BPMs[i]=t,s._updateBPM(i),s.BPMInputs[i].value=s.BPMs[i],s._firstClickTime=null):s._firstClickTime=e.getTime()}}(l),this.BPMInputs[l].addEventListener("keyup",function(e){return function(t){13===t.keyCode&&s._useBPM(e)}}(l));t.textMsg(_("Adjust the tempo with the buttons."),3e3),this.resume(),e.sendToCenter()}},{key:"_updateBPM",value:function(t){var e;this._intervals[t]=60/this.BPMs[t]*1e3,null!=this.BPMBlocks[t]&&null!=(e=this.activity.blocks.blockList[this.BPMBlocks[t]].connections[1])&&(this.activity.blocks.blockList[e].value=parseFloat(this.BPMs[t]),this.activity.blocks.blockList[e].text.text=this.BPMs[t],this.activity.blocks.blockList[e].updateCache(),this.activity.refreshCanvas(),this.activity.saveLocally())}},{key:"pause",value:function(){clearInterval(this._intervalID)}},{key:"resume",value:function(){for(var t=this,e=new Date,i=0;i<this.BPMs.length;i++)this._widgetFirstTimes[i]=e.getTime(),this._widgetNextTimes[i]=this._widgetFirstTimes[i]+this._intervals[i],this._directions[i]=1;null!==this._intervalID&&clearInterval(this._intervalID),this._intervalID=setInterval(function(){t._draw()},h.TEMPOINTERVAL)}},{key:"_useBPM",value:function(t){var e=this.BPMInputs[t].value;isNaN(e)?activity.errorMsg(_("Please enter a number between 30 and 1000"),3e3):(this.BPMs[t]=this.BPMInputs[t].value,1e3<this.BPMs[t]?(this.BPMs[t]=1e3,activity.errorMsg(_("The beats per minute must be between 30 and 1000."),3e3)):this.BPMs[t]<30&&(this.BPMs[t]=30,activity.errorMsg(_("The beats per minute must be between 30 and 1000."),3e3)),this._updateBPM(t),this.BPMInputs[t].value=this.BPMs[t])}},{key:"speedUp",value:function(t){this.BPMs[t]=parseFloat(this.BPMs[t])+Math.round(.1*this.BPMs[t]),1e3<this.BPMs[t]&&(activity.errorMsg(_("The beats per minute must be below 1000."),3e3),this.BPMs[t]=1e3),this._updateBPM(t),this.BPMInputs[t].value=this.BPMs[t]}},{key:"slowDown",value:function(t){this.BPMs[t]=parseFloat(this.BPMs[t])-Math.round(.1*this.BPMs[t]),this.BPMs[t]<30&&(activity.errorMsg(_("The beats per minute must be above 30"),3e3),this.BPMs[t]=30),this._updateBPM(t),this.BPMInputs[t].value=this.BPMs[t]}},{key:"_draw",value:function(){for(var t,e,i,s,n,r=new Date,o=0;o<this.BPMs.length;o++)(t=this.tempoCanvases[o])&&(null==this._widgetFirstTimes[o]&&(this._widgetFirstTimes[o]=r.getTime(),this._widgetNextTimes[o]=this._widgetFirstTimes[o]+this._intervals[o]),e=this._widgetNextTimes[o]-r.getTime(),r.getTime()>this._widgetNextTimes[o]?(this.activity.logo.synth.trigger(0,["C2"],.0625,h.TEMPOSYNTH,null,null,!1),this._widgetNextTimes[o]+=this._intervals[o],-1===this._directions[o]?this._directions[o]=1:this._directions[o]=-1):(i=0!==this._intervals[o]?t.width*(e/this._intervals[o]):0,t.width-i<=h.YRADIUS/3?this._xradius=t.width-i:this._xradius=i<=h.YRADIUS/3?i:h.YRADIUS/3,s=-1===this._directions[o]?t.width-i:i),void 0===s&&(s=-1===this._directions[o]?0:t.width),(n=t.getContext("2d")).clearRect(0,0,t.width,t.height),n.beginPath(),n.fillStyle="rgba(0,0,0,1)",n.ellipse(s,h.YRADIUS,Math.max(this._xradius,1),h.YRADIUS,0,0,2*Math.PI),n.fill(),n.closePath())}},{key:"__save",value:function(i){var s=this;setTimeout(function(){var t=42*i,e=[[0,["setbpm3",{}],100+t,100+t,[null,1,2,5]],[1,["number",{value:s.BPMs[i]}],0,0,[0]],[2,["divide",{}],0,0,[0,3,4]],[3,["number",{value:1}],0,0,[2]],[4,["number",{value:4}],0,0,[2]],[5,["vspace",{}],0,0,[0,null]]];s.activity.blocks.loadNewBlocks(e),activity.textMsg(_("New action block generated."),3e3)},200*i)}},{key:"_saveTempo",value:function(){for(var t=0;t<this.BPMs.length;t++)this.__save(t)}},{key:"_get_save_lock",value:function(){return this._save_lock}}]),h}();_defineProperty(Tempo,"TEMPOSYNTH","bottle"),_defineProperty(Tempo,"TEMPOINTERVAL",5),_defineProperty(Tempo,"BUTTONDIVWIDTH",476),_defineProperty(Tempo,"BUTTONSIZE",53),_defineProperty(Tempo,"ICONSIZE",32),_defineProperty(Tempo,"TEMPOWIDTH",700),_defineProperty(Tempo,"TEMPOHEIGHT",100),_defineProperty(Tempo,"YRADIUS",75);