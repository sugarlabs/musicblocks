"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _createForOfIteratorHelper(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,s=!0,a=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return s=e.done,e},e:function(e){a=!0,r=e},f:function(){try{s||null==i.return||i.return()}finally{if(a)throw r}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var i={}.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=Array(t);i<t;i++)n[i]=e[i];return n}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var i=e[Symbol.toPrimitive];if(void 0===i)return("string"===t?String:Number)(e);var n=i.call(e,t||"default");if("object"!=_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}window.widgetWindows={openWindows:{},_posCache:{}};var WidgetWindow=function(){function o(e,t){var i,n=!(2<arguments.length&&void 0!==arguments[2])||arguments[2];_classCallCheck(this,o),this._key=e,this._buttons=[],this._first=!0,this._title=t,this._visible=!0,this._rolled=!1,this._savedPos=null,this._maximized=!1,this._fullscreenEnabled=n,this._dx=this._dy=0,this._dragging=!1,this._createUIelements(),this._setupLanguage(),this._dragTopHandler=this._dragTopHandler.bind(this),this._docMouseMoveHandler=this._docMouseMoveHandler.bind(this),this._docMouseDownHandler=this._docMouseDownHandler.bind(this),document.addEventListener("mouseup",this._dragTopHandler,!0),document.addEventListener("mousemove",this._docMouseMoveHandler,!0),document.addEventListener("mousedown",this._docMouseDownHandler,!0),window.widgetWindows._posCache[this._key]&&(i=window.widgetWindows._posCache[this._key],this.setPosition(i[0],i[1])),this.takeFocus(),this.sendToCenter=this.sendToCenter.bind(this)}return _createClass(o,[{key:"_create",value:function(e,t,i){var n=document.createElement(e);return t&&(n.className=t),i&&i.append(n),n}},{key:"_toggleClass",value:function(e,t){e.classList.toggle(t)}},{key:"_createUIelements",value:function(){var o=this,e=docById("floatingWindows");this._frame=this._create("div","windowFrame",e),this._overlayframe=this._create("div","windowFrame",e),this._drag=this._create("div","wfTopBar",this._frame),this._drag.style.display="flex",this._drag.style.justifyContent="space-between",this._fullscreenEnabled&&(this._drag.ondblclick=function(e){o._maximize(),o.takeFocus(),o.onmaximize(),e.preventDefault(),e.stopImmediatePropagation()}),this._create("div","wftButton close",this._drag).onclick=function(e){o.onclose(),e.preventDefault(),e.stopPropagation()},this._nonclose=this._create("div","nonclose",this._drag),this._nonclose.style.display="flex",this._nonclose.justifyContent="space-between",this._nonclose.style.width="100%";var t=this._create("div","wftTitle",this._nonclose);t.innerHTML="",t.insertAdjacentHTML("afterbegin",_(this._title)),t.id="".concat(this._key,"WidgetID"),this._nonclose.onmousedown=function(e){var t,i,n;o._dragging=!0,o._maximized&&(i=((t=o._drag.getBoundingClientRect()).left-e.clientX)/(t.right-t.left),n=t.top-e.clientY,o._restore(),o.onmaximize(),i*=(t=o._drag.getBoundingClientRect()).right-t.left,o.setPosition(e.clientX+i,e.clientY+n)),o.takeFocus(),o._dx=e.clientX-o._drag.getBoundingClientRect().left,o._dy=e.clientY-o._drag.getBoundingClientRect().top,e.preventDefault()},this._nonclosebuttons=this._create("div","nonclosebuttons",this._nonclose),this._nonclosebuttons.style.display="flex";var i,n=this._create("div","wftButton rollup",this._nonclosebuttons);n.onclick=function(e){o._rolled?o.unroll():o._rollup(),o._toggleClass(n,"plus"),o.takeFocus(),o._frame.style.width="auto",o._frame.style.height="auto",o._frame.style.minHeight="0px",e.preventDefault(),e.stopPropagation()},this._fullscreenEnabled&&((i=this._create("div","wftButton wftMaxmin",this._nonclosebuttons)).onclick=function(e){o._maximized?(o._restore(),o.sendToCenter()):o._maximize(),o.takeFocus(),o.onmaximize(),e.preventDefault(),e.stopImmediatePropagation()},this._maxminIcon=this._create("img",void 0,i),this._maxminIcon.setAttribute("src","header-icons/icon-expand.svg")),this._body=this._create("div","wfWinBody",this._frame),this._toolbar=this._create("div","wfbToolbar",this._body);function r(){var e=window.pageYOffset||document.documentElement.scrollTop,t=window.pageXOffset||document.documentElement.scrollLeft;window.onscroll=function(){window.scrollTo(t,e)}}this._widget=this._create("div","wfbWidget",this._body),this._widget.addEventListener("wheel",r,!1),this._widget.addEventListener("DOMMouseScroll",r,!1)}},{key:"_docMouseMoveHandler",value:function(e){var t,i;this._dragging&&(this._fullscreenEnabled&&"64px"===this._frame.style.top?this._overlay(!0):this._overlay(!1),t=e.clientX-this._dx,i=e.clientY-this._dy,this.setPosition(t,i))}},{key:"_overlay",value:function(e){e?(this._frame.style.zIndex="10",this._overlayframe.style.left="0",this._overlayframe.style.zIndex="1",this._overlayframe.style.top="64px",this._overlayframe.style.width="100vw",this._overlayframe.style.height="calc(100vh - 64px)",this._overlayframe.style.border="0.25vw solid black",this._overlayframe.style.backgroundColor="rgba(255,255,255,0.75)"):(this._frame.style.zIndex="10000",this._overlayframe.style.border="0px",this._overlayframe.style.zIndex="-1",this._overlayframe.style.backgroundColor="rgba(255,255,255,0)")}},{key:"_docMouseDownHandler",value:function(e){e.target===this._frame||this._frame.contains(e.target)||this._fullscreenEnabled?(this._frame.style.opacity="1",this._frame.style.zIndex="10000"):(this._frame.style.opacity=".7",this._frame.style.zIndex="0")}},{key:"_dragTopHandler",value:function(e){this._dragging=!1,this._fullscreenEnabled&&"64px"===this._frame.style.top&&!this._maximized&&(this._maximize(),this.takeFocus(),this.onmaximize(),e.preventDefault())}},{key:"_setupLanguage",value:function(){var e=localStorage.languagePreference;void 0===e&&(e=navigator.language),"ja"===e&&(this._body.style.flexDirection="column",this._body.style.flexGrow="1",this._toolbar.style.overflowY="auto",this._toolbar.style.width="100%",this._toolbar.style.display="flex",this._toolbar.style.flexShrink="0")}},{key:"addInputButton",value:function(e,t){var i=this._create("div","wfbtItem",t||this._toolbar);return i.innerHTML="",i.insertAdjacentHTML("afterbegin",'<input value="'.concat(e,'" />')),i.querySelector("input")}},{key:"addRangeSlider",value:function(e,t,i,n,o){var r=this._create("div","wfbtItem",t||this._toolbar),s='\n          <input type="range" class="'.concat(o,'" min="').concat(i,'" max="').concat(n,'" value="').concat(e,'" />\n        ');r.style.height="250px",r.innerHTML="",r.insertAdjacentHTML("afterbegin",s);var a=r.querySelector("input");return a.style=" position:absolute;transform:rotate(270deg);height:10px;width:250px;",a}},{key:"addSelectorButton",value:function(e,t,i){var n=this._create("div","wfbtItem",i||this._toolbar);n.innerHTML="",n.insertAdjacentHTML("afterbegin",'<select value="'.concat(t,'" />'));var o,r=n.querySelector("select"),s=_createForOfIteratorHelper(e);try{for(s.s();!(o=s.n()).done;){var a=o.value,l=new Option("turtle "+a,a);r.add(l)}}catch(e){s.e(e)}finally{s.f()}return r}},{key:"addDivider",value:function(){return this._create("div","wfbtHR",this._toolbar)}},{key:"modifyButton",value:function(e,t,i,n){var o='\n            <img src="header-icons/'.concat(t,'" title="').concat(n,'" alt="').concat(n,'" height="').concat(i,'" width="').concat(i,'"/> \n            ');return this._buttons[e].innerHTML="",this._buttons[e].insertAdjacentHTML("afterbegin",o),this._buttons[e]}},{key:"close",value:function(){document.removeEventListener("mouseup",this._dragTopHandler,!0),document.removeEventListener("mousemove",this._docMouseMoveHandler,!0),document.removeEventListener("mousedown",this._docMouseDownHandler,!0),this.onclose()}},{key:"updateTitle",value:function(e){docById(this._key+"WidgetID").innerHTML=e}},{key:"takeFocus",value:function(){for(var e=docById("floatingWindows").children,t=0;t<e.length;t++)e[t].style.zIndex="0",e[t].style.opacity="0";this._frame.style.zIndex="10000",this._frame.style.opacity="1"}},{key:"addButton",value:function(e,t,i,n){var o=this._create("div","wfbtItem",n||this._toolbar),r='<img src="header-icons/'.concat(e,'" \n                  title="').concat(i,'" \n                  alt="').concat(i,'" \n                  height="').concat(t,'" \n                  width="').concat(t,'" \n             />');return o.innerHTML="",o.insertAdjacentHTML("afterbegin",r),this._buttons.push(o),o}},{key:"sendToCenter",value:function(){var e=docById("myCanvas"),t=this._frame.getBoundingClientRect(),i=e.getBoundingClientRect();if(0===i.width||0===i.height)return this.setPosition(200,140),this;var n=document.querySelector("nav").offsetHeight;return this.setPosition((i.width-t.width)/2,(i.height-t.height+n)/2),this}},{key:"_restore",value:function(){this._maxminIcon.setAttribute("src","header-icons/icon-expand.svg"),this._maximized=!1,this._savedPos&&(this._frame.style.left=this._savedPos[0],this._frame.style.top=this._savedPos[1],this._savedPos=null),this._overlay(!1),this._frame.style.width="auto",this._frame.style.height="auto",this._frame.style.minHeight="420px",this._frame.style.minWidth="470px"}},{key:"_maximize",value:function(){this._maxminIcon.setAttribute("src","header-icons/icon-contract.svg"),this._maximized=!0,this.unroll(),this.takeFocus(),this._savedPos=[this._frame.style.left,this._frame.style.top],this._frame.style.width="100vw",this._frame.style.height="calc(100vh - 64px)",this._frame.style.left="0",this._frame.style.top="64px"}},{key:"getWidgetBody",value:function(){return this._widget}},{key:"getWidgetFrame",value:function(){return this._frame}},{key:"getDragElement",value:function(){return this._drag}},{key:"onclose",value:function(){this.destroy()}},{key:"destroy",value:function(){this._frame&&this._frame.parentElement&&this._frame.parentElement.removeChild(this._frame),this._overlayframe&&this._overlayframe.parentElement&&this._overlayframe.parentElement.removeChild(this._overlayframe),window.widgetWindows.openWindows[this._key]=void 0}},{key:"onmaximize",value:function(){return this}},{key:"isMaximized",value:function(){return this._maximized}},{key:"show",value:function(){this._frame.style.display="block"}},{key:"setPosition",value:function(e,t){return this._frame.style.left="".concat(e,"px"),this._frame.style.top="".concat(Math.max(t,64),"px"),window.widgetWindows._posCache[this._key]=[e,Math.max(t,64)],this}},{key:"isVisible",value:function(){return this._visible}},{key:"clear",value:function(){return this._widget.innerHTML="",this._toolbar.innerHTML="",this}},{key:"clearScreen",value:function(){return this._widget.innerHTML="",this}},{key:"_rollup",value:function(){return this._rolled=!0,this._body.style.display="none",this}},{key:"unroll",value:function(){return this._rolled=!1,this._body.style.display="flex",this}}]),o}();window.widgetWindows.windowFor=function(e,t,i,n){var o,r=void 0,r=void 0!==e.blockNo?e.blockNo:i||t;return void 0===window.widgetWindows.openWindows[r]&&(o=new WidgetWindow(r,t,n).sendToCenter(),window.widgetWindows.openWindows[r]=o),window.widgetWindows.openWindows[r].unroll()},window.widgetWindows.clear=function(e){var t=window.widgetWindows.openWindows[e];t&&"function"==typeof t.onclose&&t.onclose()},window.widgetWindows.isOpen=function(e){return!!window.widgetWindows.openWindows[e]||""},window.widgetWindows.hideAllWindows=function(){Object.values(window.widgetWindows.openWindows).forEach(function(e){void 0!==e&&(e._frame.style.display="none")})},window.widgetWindows.hideWindow=function(e){var t=window.widgetWindows.openWindows[e];t&&(t._frame.style.display="none")},window.widgetWindows.showWindows=function(){Object.values(window.widgetWindows.openWindows).forEach(function(e){void 0!==e&&(e._frame.style.display="block")})};