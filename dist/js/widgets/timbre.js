"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function asyncGeneratorStep(t,e,i,s,n,a,o){try{var r=t[a](o),l=r.value}catch(t){return void i(t)}r.done?e(l):Promise.resolve(l).then(s,n)}function _asyncToGenerator(r){return function(){var t=this,o=arguments;return new Promise(function(e,i){var s=r.apply(t,o);function n(t){asyncGeneratorStep(s,e,i,n,a,"next",t)}function a(t){asyncGeneratorStep(s,e,i,n,a,"throw",t)}n(void 0)})}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,_toPropertyKey(s.key),s)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function _defineProperty(t,e,i){return(e=_toPropertyKey(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(t,e){if("object"!=_typeof(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0===i)return("string"===e?String:Number)(t);var s=i.call(t,e||"default");if("object"!=_typeof(s))return s;throw new TypeError("@@toPrimitive must return a primitive value.")}var TimbreWidget=function(){function u(){var A=this;_classCallCheck(this,u),_defineProperty(this,"_update",function(){var s=_asyncToGenerator(regeneratorRuntime.mark(function t(e,i,s){var n,a,o,r,l,c,d,u,h,y,v,m,p,b;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(n=[],!0===A.isActive.envelope&&null!=A.env[e])for(a=0;a<4;a++)n[a]=A.activity.blocks.blockList[A.env[e]].connections[a+1];if(!0===A.isActive.filter&&null!=A.fil[e])for(o=0;o<3;o++)n[o]=A.activity.blocks.blockList[A.fil[e]].connections[o+1];if(!0===A.isActive.oscillator&&null!=A.osc[e])for(r=0;r<2;r++)n[r]=A.activity.blocks.blockList[A.osc[e]].connections[r+1];if(!0===A.isActive.amsynth&&null!=A.AMSynthesizer[e]&&(n[0]=A.activity.blocks.blockList[A.AMSynthesizer[e]].connections[1]),!0===A.isActive.fmsynth&&null!=A.FMSynthesizer[e]&&(n[0]=A.activity.blocks.blockList[A.FMSynthesizer[e]].connections[1]),!0===A.isActive.noisesynth&&null!=A.NoiseSynthesizer[e]&&(n[0]=A.activity.blocks.blockList[A.NoiseSynthesizer[e]].connections[1]),!0===A.isActive.duosynth&&null!=A.duoSynthesizer[e])for(l=0;l<2;l++)n[l]=A.activity.blocks.blockList[A.duoSynthesizer[e]].connections[l+1];if(!0===A.isActive.tremolo&&null!=A.tremoloEffect[e])for(c=0;c<2;c++)n[c]=A.activity.blocks.blockList[A.tremoloEffect[e]].connections[c+1];if(!0!==A.isActive.vibrato||null==A.vibratoEffect[e]){t.next=28;break}if(n[0]=A.activity.blocks.blockList[A.vibratoEffect[e]].connections[1],d=A.activity.blocks.blockList[A.vibratoEffect[e]].connections[2],"divide"!==A.activity.blocks.blockList[d].name||null==A.activity.blocks.blockList[d].connections[1]||"number"!==A.activity.blocks.blockList[A.activity.blocks.blockList[d].connections[1]].name||null==A.activity.blocks.blockList[d].connections[2]||"number"!==A.activity.blocks.blockList[A.activity.blocks.blockList[d].connections[2]].name){t.next=19;break}u=A.activity.blocks.blockList[d].connections[1],h=A.activity.blocks.blockList[d].connections[2],n[1]=h,n[2]=u,t.next=28;break;case 19:return y=rationalToFraction(A.activity.logo.parseArg(A.activity.logo,0,d,null,null)),v=A.activity.blocks.blockList.length,A.activity.blocks.loadNewBlocks([[0,["divide",{}],0,0,[null,1,2]],[1,["number",{value:y[0]}],0,0,[0]],[2,["number",{value:y[1]}],0,0,[0]]]),n[1]=v+2,n[2]=v+1,m=function(){A.activity.blocks.blockList[last(A.vibratoEffect)].connections[2]=v,A.activity.blocks.blockList[v].connections[0]=last(A.vibratoEffect),A.activity.blocks.blockList[d].connections[0]=null,A.activity.blocks.clampBlocksToCheck.push([v,0]),A.activity.blocks.clampBlocksToCheck.push([A.blockNo,0]),A.activity.blocks.adjustDocks(A.blockNo,!0)},t.next=27,delayExecution(500);case 27:m();case 28:if(!0===A.isActive.chorus&&null!=A.chorusEffect[e])for(p=0;p<3;p++)n[p]=A.activity.blocks.blockList[A.chorusEffect[e]].connections[p+1];if(!0===A.isActive.phaser&&null!=A.phaserEffect[e])for(b=0;b<3;b++)n[b]=A.activity.blocks.blockList[A.phaserEffect[e]].connections[b+1];!0===A.isActive.distortion&&null!=A.distortionEffect[e]&&(n[0]=A.activity.blocks.blockList[A.distortionEffect[e]].connections[1]),null!=n[0]&&(A.activity.blocks.blockList[n[s]].value="string"==typeof i?i:parseFloat(i),A.activity.blocks.blockList[n[s]].text.text=i.toString(),A.activity.blocks.blockList[n[s]].updateCache(),A.activity.refreshCanvas(),A.activity.saveLocally());case 32:case"end":return t.stop()}},t)}));return function(t,e,i){return s.apply(this,arguments)}}()),_defineProperty(this,"clampConnection",function(){var s=_asyncToGenerator(regeneratorRuntime.mark(function t(e,i,s){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return A.activity.blocks.blockList[A.blockNo].connections[2]=e,A.activity.blocks.blockList[e].connections[0]=A.blockNo,null!=s&&(A.activity.blocks.blockList[e].connections[i]=s,A.activity.blocks.blockList[s].connections[0]=e),A.activity.blocks.clampBlocksToCheck.push([e,0]),A.activity.blocks.clampBlocksToCheck.push([A.blockNo,0]),t.next=7,delayExecution(500);case 7:A.activity.blocks.adjustExpandableClampBlock(),A.activity.blocks.adjustDocks(A.blockNo,!0);case 9:case"end":return t.stop()}},t)}));return function(t,e,i){return s.apply(this,arguments)}}()),_defineProperty(this,"clampConnectionVspace",function(){var s=_asyncToGenerator(regeneratorRuntime.mark(function t(e,i,s){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return A.activity.blocks.blockList[A.blockNo].connections[2]=e,A.activity.blocks.blockList[e].connections[0]=A.blockNo,null!=s&&(A.activity.blocks.blockList[i].connections[1]=s,A.activity.blocks.blockList[s].connections[0]=i),A.activity.blocks.clampBlocksToCheck.push([e,0]),A.activity.blocks.clampBlocksToCheck.push([A.blockNo,0]),t.next=7,delayExecution(500);case 7:A.activity.blocks.adjustExpandableClampBlock(),A.activity.blocks.adjustDocks(A.blockNo,!0);case 9:case"end":return t.stop()}},t)}));return function(t,e,i){return s.apply(this,arguments)}}()),_defineProperty(this,"blockConnection",function(){var i=_asyncToGenerator(regeneratorRuntime.mark(function t(e,i){var s,n,a;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(s=A.activity.blocks.blockList.length-e,null==i)A.activity.blocks.blockList[A.blockNo].connections[2]=s,A.activity.blocks.blockList[s].connections[0]=A.blockNo;else{for(n=A.activity.blocks.blockList[i].connections.length-1;"hidden"===A.activity.blocks.blockList[i].name&&"newnote"!==A.activity.blocks.blockList[A.activity.blocks.blockList[i].connections[0]].name;)a=A.activity.blocks.blockList[i].connections[0],n=A.activity.blocks.blockList[a].connections.length-2,A.activity.blocks.clampBlocksToCheck.push([a,0]),null==A.activity.blocks.blockList[a].connections[n]?i=a:(i=A.activity.blocks.findBottomBlock(A.activity.blocks.blockList[a].connections[n]),n=A.activity.blocks.blockList[i].connections.length-1);A.activity.blocks.blockList[i].connections[n]=s,A.activity.blocks.blockList[s].connections[0]=i}return A.activity.blocks.clampBlocksToCheck.push([A.blockNo,0]),t.next=5,delayExecution(1e3);case 5:A.activity.blocks.adjustExpandableClampBlock(),A.activity.blocks.adjustDocks(A.blockNo,!0),A.activity.refreshCanvas();case 8:case"end":return t.stop()}},t)}));return function(t,e){return i.apply(this,arguments)}}()),_defineProperty(this,"_synth",function(){var S=0;A.timbreTableDiv.style.display="inline",A.timbreTableDiv.style.visibility="visible",A.timbreTableDiv.style.border="0px",A.timbreTableDiv.style.overflow="auto",A.timbreTableDiv.style.backgroundColor="white",A.timbreTableDiv.style.height="300px",A.timbreTableDiv.innerHTML='<div id="timbreTable"></div>';for(var t=docById("timbreTable"),e="",i=0;i<2;i++)e+='<div id ="synth'+i+'"></div>';t.innerHTML=e;var s=document.createElement("div");s.id="envAppend",s.style.backgroundColor=platformColor.widgetBackground,s.style.height="30px",s.style.marginTop="40px",s.style.overflow="auto",t.append(s),docById("synth0").innerHTML='<p>\n                <input type="radio" name="synthsName" value="AMSynth"/>'.concat(_("AM synth"),'<br>\n                <input type="radio" name="synthsName" value="FMSynth"/>').concat(_("FM synth"),'<br>\n                <input type="radio" name="synthsName" value="DuoSynth"/>').concat(_("duo synth"),"<br>\n            </p>");for(var x,F=docById("synth1"),n=docByName("synthsName"),a=0;a<n.length;a++)n[a].onclick=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var i,s,n,a,o,r,l,c,d,u,h,y,v,m,p,b,f,k,g;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:for(x=e.target.value,i='<div id="chosen">'+x+"</div>",s=0;s<A.activeParams.length;s++)A.isActive[A.activeParams[s]]=!1;if(A.isActive.synth=!0,"AMSynth"!==x){t.next=28;break}if(A.isActive.amsynth=!0,A.isActive.fmsynth=!1,A.isActive.duosynth=!1,0===A.AMSynthesizer.length)return n=A.activity.blocks.blockList[A.blockNo].connections[2],a=A.activity.blocks.findBottomBlock(n),o=[[0,["amsynth",{}],0,0,[null,1,null]],[1,["number",{value:1}],0,0,[0]]],A.activity.blocks.loadNewBlocks(o),t.next=15,delayExecution(100);t.next=21;break;case 15:r=A.activity.blocks.blockList.length-2,A.AMSynthesizer.push(r),A.AMSynthParams.push(1),A._changeBlock(last(A.AMSynthesizer),x,a),A.amSynthParamvals.harmonicity=parseFloat(A.AMSynthParams[0]),A.activity.logo.synth.createSynth(0,A.instrumentName,"amsynth",A.amSynthParamvals);case 21:i+='<div id="wrapperS0"><div id="sS0"><span>'+_("harmonicity")+'</span></div><div class="insideDivSynth"><input type="range" id="myRangeS0" class="sliders" style="margin-top:20px" value="'+parseFloat(A.AMSynthParams[0])+'"><span id="myspanS0" class="rangeslidervalue">'+A.AMSynthParams[0]+"</span></div></div>",F.innerHTML=i,A.amSynthParamvals.harmonicity=parseFloat(A.AMSynthParams[0]),1!==A.AMSynthesizer.length&&(S=A.AMSynthesizer.length-1),document.getElementById("wrapperS0").addEventListener("change",function(t){var e=t.target;docById("myRangeS0").value=parseFloat(e.value),A.amSynthParamvals.harmonicity=parseFloat(e.value),docById("myspanS0").textContent=e.value,A._update(S,e.value,0),A.activity.logo.synth.createSynth(0,A.instrumentName,"amsynth",A.amSynthParamvals),A._playNote("G4",1/8)}),t.next=103;break;case 28:if("FMSynth"!==x){t.next=52;break}if(A.isActive.amsynth=!1,A.isActive.fmsynth=!0,A.isActive.duosynth=!1,0===A.FMSynthesizer.length)return l=A.activity.blocks.blockList[A.blockNo].connections[2],c=A.activity.blocks.findBottomBlock(l),d=[[0,["fmsynth",{}],0,0,[null,1,null]],[1,["number",{value:10}],0,0,[0]]],A.activity.blocks.loadNewBlocks(d),t.next=39,delayExecution(100);t.next=45;break;case 39:u=A.activity.blocks.blockList.length-2,A.FMSynthesizer.push(u),A.FMSynthParams.push(10),A._changeBlock(last(A.FMSynthesizer),x,c),A.fmSynthParamvals.modulationIndex=parseFloat(A.FMSynthParams[0]),A.activity.logo.synth.createSynth(0,A.instrumentName,"fmsynth",A.fmSynthParamvals);case 45:i+='<div id="wrapperS0"><div id="sS0"><span>'+_("modulation index")+'</span></div><div class="insideDivSynth"><input type="range" id="myRangeS0" class="sliders" style="margin-top:20px" value="'+parseFloat(A.FMSynthParams[0])+'"><span id="myspanS0" class="rangeslidervalue">'+A.FMSynthParams[0]+"</span></div></div>",F.innerHTML=i,A.fmSynthParamvals.modulationIndex=parseFloat(A.FMSynthParams[0]),1!==A.FMSynthesizer.length&&(S=A.FMSynthesizer.length-1),document.getElementById("wrapperS0").addEventListener("change",function(t){var e=t.target;docById("myRangeS0").value=parseFloat(e.value),docById("myspanS0").textContent=e.value,A.fmSynthParamvals.modulationIndex=parseFloat(e.value),A._update(S,e.value,0),A.activity.logo.synth.createSynth(0,A.instrumentName,"fmsynth",A.fmSynthParamvals),A._playNote("G4",1/8)}),t.next=103;break;case 52:if("NoiseSynth"!==x){t.next=77;break}if(A.isActive.amsynth=!1,A.isActive.fmsynth=!1,A.isActive.noisesynth=!0,A.isActive.duosynth=!1,0===A.NoiseSynthesizer.length)return h=A.activity.blocks.blockList[A.blockNo].connections[2],y=A.activity.blocks.findBottomBlock(h),v=[[0,["noisesynth",{}],0,0,[null,1,null]],[1,["number",{value:10}],0,0,[0]]],A.activity.blocks.loadNewBlocks(v),t.next=64,delayExecution(100);t.next=70;break;case 64:m=A.activity.blocks.blockList.length-2,A.NoiseSynthesizer.push(m),A.NoiseSynthParams.push("white"),A._changeBlock(last(A.NoiseSynthesizer),x,y),A.noiseSynthParamvals["noise.type"]=A.NoiseSynthParams[0],A.activity.logo.synth.createSynth(0,A.instrumentName,"noisesynth",A.noiseSynthParamvals);case 70:i+='<div id="wrapperS0"><div id="sS0"><span>'+_("modulation index")+'</span></div><div class="insideDivSynth"><input type="range" id="myRangeS0" class="sliders" style="margin-top:20px" value="'+A.NoiseSynthParams[0]+'"><span id="myspanS0" class="rangeslidervalue">'+A.NoiseSynthParams[0]+"</span></div></div>",F.innerHTML=i,A.noiseSynthParamvals["noise.type"]=A.NoiseSynthParams[0],1!==A.NoiseSynthesizer.length&&(S=A.NoiseSynthesizer.length-1),document.getElementById("wrapperS0").addEventListener("change",function(t){var e=t.target;docById("myRangeS0").value=parseFloat(e.value),docById("myspanS0").textContent=e.value,A.noiseSynthParamvals["noise.type"]=parseFloat(e.value),A._update(S,e.value,0),A.activity.logo.synth.createSynth(0,A.instrumentName,"noisesynth",A.noiseSynthParamvals),A._playNote(1/8)}),t.next=103;break;case 77:if("DuoSynth"!==x){t.next=103;break}if(A.isActive.amsynth=!1,A.isActive.fmsynth=!1,A.isActive.duosynth=!0,0===A.duoSynthesizer.length)return p=A.activity.blocks.blockList[A.blockNo].connections[2],b=A.activity.blocks.findBottomBlock(p),f=[[0,["duosynth",{}],0,0,[null,1,2,null]],[1,["number",{value:10}],0,0,[0]],[2,["number",{value:6}],0,0,[0]]],A.activity.blocks.loadNewBlocks(f),t.next=88,delayExecution(100);t.next=96;break;case 88:k=A.activity.blocks.blockList.length-3,A.duoSynthesizer.push(k),A.duoSynthParams.push(10),A.duoSynthParams.push(6),A._changeBlock(last(A.duoSynthesizer),x,b),A.duoSynthParamVals.vibratoRate=parseFloat(A.duoSynthParams[0]),A.duoSynthParamVals.vibratoAmount=parseFloat(A.duoSynthParams[1]),A.activity.logo.synth.createSynth(0,A.instrumentName,"duosynth",A.duoSynthParamVals);case 96:for(i+='<div id="wrapperS0"><div id="sS0"><span>'+_("vibrato rate")+'</span></div><div class="insideDivSynth"><input type="range" id="myRangeS0" class="sliders" style="margin-top:20px" value="'+parseFloat(A.duoSynthParams[0])+'"><span id="myspanS0" class="rangeslidervalue">'+A.duoSynthParams[0]+"</span></div></div>",i+='<div id="wrapperS1"><div id="sS1"><span>'+_("vibrato amount")+'</span></div><div class="insideDivSynth"><input type="range" id="myRangeS1" class="sliders" style="margin-top:20px" value="'+parseFloat(A.duoSynthParams[1])+'"><span id="myspanS1" class="rangeslidervalue">'+A.duoSynthParams[1]+"</span></div></div>",F.innerHTML=i,1!==A.duoSynthesizer.length&&(S=A.duoSynthesizer.length-1),A.duoSynthParamVals.vibratoRate=parseFloat(A.duoSynthParams[0]),A.duoSynthParamVals.vibratoAmount=parseFloat(A.duoSynthParams[1]),g=0;g<2;g++)document.getElementById("wrapperS"+g).addEventListener("change",function(t){var e=t.target,i=e.id.slice(-1);docById("myRangeS"+i).value=parseFloat(e.value),0===i?A.duoSynthParamVals.vibratoRate=parseFloat(e.value):1===i&&(A.duoSynthParamVals.vibratoAmount=parseFloat(e.value)),docById("myspanS"+i).textContent=e.value,A._update(S,e.value,Number(i)),A.activity.logo.synth.createSynth(0,A.instrumentName,"duosynth",A.duoSynthParamVals),A._playNote("G4",1/8)});case 103:case"end":return t.stop()}},t)}));return function(t){return e.apply(this,arguments)}}()}),_defineProperty(this,"_addFilter",_asyncToGenerator(regeneratorRuntime.mark(function t(){var e,i,s,n,a,o;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e=docById("timbreTable"),i=A.activity.blocks.blockList[A.blockNo].connections[2],s=A.activity.blocks.findBottomBlock(i),A.fil.push(A.activity.blocks.blockList.length),n=instrumentsFilters[0][A.instrumentName].slice(),(a=FILTERTYPES.slice().filter(function(t){for(var e in n)if(n[e].filterType===t[1])return!1;return!0})).length<=0?A.filterParams.push(DEFAULTFILTERTYPE):A.filterParams.push(a[0][1]),A.filterParams.push(-12),A.filterParams.push(392),o=A.filterParams.length,A.activity.blocks.loadNewBlocks([[0,["filter",{}],0,0,[null,3,1,2,null]],[1,["number",{value:A.filterParams[o-2]}],0,0,[0]],[2,["number",{value:A.filterParams[o-1]}],0,0,[0]],[3,["filtertype",{value:A.filterParams[o-3]}],0,0,[0]]]),t.next=13,delayExecution(500);case 13:A.blockConnection(4,s),A._createFilter(A.fil.length-1,e),A._playNote("G4",1/8),A._updateFilters();case 17:case"end":return t.stop()}},t)}))),_defineProperty(this,"_effects",function(){var N=0;Object.assign(A.timbreTableDiv.style,{display:"inline",visibility:"visible",border:"0px",overflow:"auto",backgroundColor:"white",height:"300px"}),A.timbreTableDiv.innerHTML='<div id="timbreTable"></div>';for(var t=docById("timbreTable"),e="",i=0;i<2;i++)e+='<div id ="effect'+i+'"></div>';t.innerHTML=e;var s=document.createElement("div");s.id="envAppend",s.style.backgroundColor=platformColor.widgetBackground,s.style.height="30px",s.style.marginTop="40px",s.style.overflow="auto",t.append(s);var n=docById("effect0"),a=["Tremolo","Vibrato","Chorus","Phaser","Distortion"].map(function(t){return'<input type="radio" name="effectsName" value="'.concat(t,'"/>').concat(_(t.toLowerCase()),"<br>")}).join("");n.innerHTML="<p>".concat(a,"</p>");for(var T,L=docById("effect1"),o=docByName("effectsName"),r=0;r<o.length;r++)o[r].onclick=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var i,s,n,a,o,r,l,c,d,u,h,y,v,m,p,b,f,k,g,S,x,F,P,B,E,C,I;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(T=e.target.value,i='<div id="chosen">'+T+"</div>","Tremolo"!==T){t.next=32;break}for(A.isActive.tremolo=!0,A.isActive.chorus=!1,A.isActive.vibrato=!1,A.isActive.distortion=!1,A.isActive.phaser=!1,instrumentsEffects[0][A.instrumentName].tremoloActive=!0,s=0;s<2;s++)i+='<div id="wrapperFx'+s+'"><div id="sFx'+s+'"><span></span></div><div class="insideDivEffects"><input type="range" id="myRangeFx'+s+'" class="sliders" style="margin-top:20px" value="2"><span id="myspanFx'+s+'" class="rangeslidervalue">2</span></div></div>';if(L.innerHTML=i,docById("sFx0").textContent=_("rate"),docById("myRangeFx0").value=10,docById("myspanFx0").textContent="10",docById("sFx1").textContent=_("depth"),docById("myRangeFx1").value=50,docById("myspanFx1").textContent="50",0!==A.tremoloEffect.length)for(N=A.tremoloEffect.length-1,n=0;n<2;n++)docById("myRangeFx"+n).value=parseFloat(A.tremoloParams[n]),docById("myspanFx"+n).textContent=A.tremoloParams[n],A._update(N,A.tremoloParams[n],n);if(0===A.tremoloEffect.length)return a=A.activity.blocks.blockList[A.blockNo].connections[2],o=A.activity.blocks.blockList.length,r=[[0,["tremolo",{}],0,0,[null,1,2,null,3]],[1,["number",{value:10}],0,0,[0]],[2,["number",{value:50}],0,0,[0]],[3,"hidden",0,0,[0,null]]],A.activity.blocks.loadNewBlocks(r),A.tremoloEffect.push(o),A.tremoloParams.push(10),A.tremoloParams.push(50),t.next=28,delayExecution(500);t.next=29;break;case 28:A.clampConnection(o,3,a);case 29:for(l=0;l<2;l++)document.getElementById("wrapperFx"+l).addEventListener("change",function(t){var e=t.target,i=e.id.slice(-1);docById("myRangeFx"+i).value=parseFloat(e.value),docById("myspanFx"+i).textContent=e.value,0===i&&(instrumentsEffects[0][A.instrumentName].tremoloFrequency=parseFloat(e.value)),1===i&&(instrumentsEffects[0][A.instrumentName].tremoloDepth=parseFloat(e.value)/100),A._update(N,parseFloat(e.value),Number(i)),A._playNote("G4",1/8)});t.next=169;break;case 32:if("Vibrato"!==T){t.next=71;break}for(A.isActive.tremolo=!1,A.isActive.chorus=!1,A.isActive.vibrato=!0,A.isActive.distortion=!1,A.isActive.phaser=!1,instrumentsEffects[0][A.instrumentName].vibratoActive=!0,c=0;c<2;c++)i+='<div id="wrapperFx'+c+'"><div id="sFx'+c+'"><span></span></div><div class="insideDivEffects"><input type="range" id="myRangeFx'+c+'" class="sliders" style="margin-top:20px" max="25" value="2"><span id="myspanFx'+c+'" class="rangeslidervalue">2</span></div></div>';if(L.innerHTML=i,docById("sFx0").textContent=_("intensity"),docById("sFx1").textContent=_("rate"),!(0<A.vibratoEffect.length)){t.next=51;break}docById("myRangeFx0").value=parseFloat(A.vibratoParams[0]),docById("myspanFx0").textContent=A.vibratoParams[0],docById("myRangeFx1").value=100/parseFloat(A.vibratoParams[1]),d=rationalToFraction(1/parseFloat(A.vibratoParams[1])),docById("myspanFx1").textContent=d[0]+"/"+d[1],t.next=67;break;case 51:return u=A.activity.blocks.blockList[A.blockNo].connections[2],h=A.activity.blocks.blockList.length,y=[[0,["vibrato",{}],0,0,[null,1,3,2,6]],[1,["number",{value:5}],0,0,[0]],[2,["vspace",{}],0,0,[0,null]],[3,["divide",{}],0,0,[0,4,5]],[4,["number",{value:1}],0,0,[3]],[5,["number",{value:16}],0,0,[3]],[6,["hidden",{}],0,0,[0,null]]],A.activity.blocks.loadNewBlocks(y),A.vibratoEffect.push(h),A.vibratoParams.push(5),A.vibratoParams.push(16),t.next=60,delayExecution(500);case 60:A.clampConnectionVspace(h,h+2,u),docById("myRangeFx0").value=5,docById("myspanFx0").textContent="5",instrumentsEffects[0][A.instrumentName].vibratoIntensity=.05,docById("myRangeFx1").value=6.25,docById("myspanFx1").textContent="1/16",instrumentsEffects[0][A.instrumentName].vibratoFrequency=1/16;case 67:document.getElementById("wrapperFx0").addEventListener("change",function(t){var e=t.target;docById("myRangeFx0").value=parseFloat(e.value),docById("myspanFx0").textContent=e.value,instrumentsEffects[0][A.instrumentName].vibratoIntensity=parseFloat(e.value)/100,A._update(A.vibratoEffect.length-1,e.value,0),A._playNote("G4",1/8)}),document.getElementById("wrapperFx1").addEventListener("change",function(t){var e=t.target;docById("myRangeFx1").value=parseFloat(e.value);var i=oneHundredToFraction(e.value);docById("myspanFx1").textContent=i[0]+"/"+i[1];var s=parseFloat(i[0])/parseFloat(i[1]);instrumentsEffects[0][A.instrumentName].vibratoFrequency=s,A._update(A.vibratoEffect.length-1,i[1],1),A._update(A.vibratoEffect.length-1,i[0],2),A._playNote("G4",1/8)}),t.next=169;break;case 71:if("Chorus"!==T){t.next=108;break}for(A.isActive.tremolo=!1,A.isActive.chorus=!0,A.isActive.vibrato=!1,A.isActive.distortion=!1,A.isActive.phaser=!1,instrumentsEffects[0][A.instrumentName].chorusActive=!0,v=0;v<3;v++)i+='<div id="wrapperFx'+v+'"><div id="sFx'+v+'"><span></span></div><div class="insideDivEffects"><input type="range" id="myRangeFx'+v+'" class="sliders" style="margin-top:20px" value="2"><span id="myspanFx'+v+'" class="rangeslidervalue">2</span></div></div>';if(L.innerHTML=i,docById("sFx0").textContent=_("rate"),docById("myRangeFx0").value=2,docById("myspanFx0").textContent="2",instrumentsEffects[0][A.instrumentName].chorusRate=2,docById("sFx1").textContent=_("delay (MS)"),docById("myRangeFx1").value=4,docById("myspanFx1").textContent="4",instrumentsEffects[0][A.instrumentName].delayTime=4,docById("sFx2").textContent=_("depth"),docById("myRangeFx2").value=70,docById("myspanFx2").textContent="70",instrumentsEffects[0][A.instrumentName].chorusDepth=4,0!==A.chorusEffect.length)for(N=A.chorusEffect.length-1,m=0;m<3;m++)docById("myRangeFx"+m).value=parseFloat(A.chorusParams[m]),docById("myspanFx"+m).textContent=A.chorusParams[m],A._update(N,A.chorusParams[m],m);if(0===A.chorusEffect.length)return p=A.activity.blocks.blockList[A.blockNo].connections[2],b=A.activity.blocks.blockList.length,f=[[0,["chorus",{}],0,0,[null,1,2,3,null,4]],[1,["number",{value:2}],0,0,[0]],[2,["number",{value:4}],0,0,[0]],[3,["number",{value:70}],0,0,[0]],[4,"hidden",0,0,[0,null]]],A.activity.blocks.loadNewBlocks(f),A.chorusEffect.push(b),A.chorusParams.push(2),A.chorusParams.push(4),A.chorusParams.push(70),t.next=104,delayExecution(500);t.next=105;break;case 104:A.clampConnection(b,4,p);case 105:for(k=0;k<3;k++)document.getElementById("wrapperFx"+k).addEventListener("change",function(t){var e=t.target,i=e.id.slice(-1);docById("myRangeFx"+i).value=parseFloat(e.value),docById("myspanFx"+i).textContent=e.value,0===i&&(instrumentsEffects[0][A.instrumentName].chorusRate=parseFloat(e.value)),1===i&&(instrumentsEffects[0][A.instrumentName].delayTime=parseFloat(e.value)),2===i&&(instrumentsEffects[0][A.instrumentName].chorusDepth=parseFloat(e.value)/100),A._update(N,e.value,Number(i)),A._playNote("G4",1/8)});t.next=169;break;case 108:if("Phaser"!==T){t.next=145;break}for(A.isActive.tremolo=!1,A.isActive.chorus=!1,A.isActive.vibrato=!1,A.isActive.distortion=!1,A.isActive.phaser=!0,instrumentsEffects[0][A.instrumentName].phaserActive=!0,instrumentsEffects[0][A.instrumentName].rate=5,instrumentsEffects[0][A.instrumentName].octaves=3,instrumentsEffects[0][A.instrumentName].baseFrequency=100,g=0;g<3;g++)i+='<div id="wrapperFx'+g+'"><div id="sFx'+g+'"><span></span></div><div class="insideDivEffects"><input type="range" id="myRangeFx'+g+'" class="sliders" style="margin-top:20px" min="0" max="1000" value="2"><span id="myspanFx'+g+'" class="rangeslidervalue">2</span></div></div>';if(L.innerHTML=i,docById("sFx0").textContent=_("rate"),docById("myRangeFx0").value=5,docById("myspanFx0").textContent="5",docById("sFx1").textContent=_("octaves"),docById("myRangeFx1").value=3,docById("myspanFx1").textContent="3",docById("sFx2").textContent=_("base frequency"),docById("myRangeFx2").value=1e3,docById("myspanFx2").textContent="1000",0!==A.phaserEffect.length)for(N=A.phaserEffect.length-1,S=0;S<3;S++)docById("myRangeFx"+S).value=parseFloat(A.phaserParams[S]),docById("myspanFx"+S).textContent=A.phaserParams[S],A._update(N,A.phaserParams[S],S);if(0===A.phaserEffect.length)return x=A.activity.blocks.blockList[A.blockNo].connections[2],F=A.activity.blocks.blockList.length,P=[[0,["phaser",{}],0,0,[null,1,2,3,null,4]],[1,["number",{value:5}],0,0,[0]],[2,["number",{value:3}],0,0,[0]],[3,["number",{value:100}],0,0,[0]],[4,"hidden",0,0,[0,null]]],A.activity.blocks.loadNewBlocks(P),A.phaserEffect.push(F),A.phaserParams.push(5),A.phaserParams.push(3),A.phaserParams.push(350),t.next=141,delayExecution(500);t.next=142;break;case 141:A.clampConnection(F,4,x);case 142:for(B=0;B<3;B++)document.getElementById("wrapperFx"+B).addEventListener("change",function(t){var e=t.target,i=e.id.slice(-1);docById("myRangeFx"+i).value=parseFloat(e.value),docById("myspanFx"+i).textContent=e.value,0===i&&(instrumentsEffects[0][A.instrumentName].rate=parseFloat(e.value)),1===i&&(instrumentsEffects[0][A.instrumentName].octaves=parseFloat(e.value)),2===i&&(instrumentsEffects[0][A.instrumentName].baseFrequency=parseFloat(e.value)),A._update(N,parseFloat(e.value),Number(i)),A._playNote("G4",1/8)});t.next=169;break;case 145:if("Distortion"!==T){t.next=169;break}if(A.isActive.tremolo=!1,A.isActive.chorus=!1,A.isActive.vibrato=!1,A.isActive.distortion=!0,A.isActive.phaser=!1,instrumentsEffects[0][A.instrumentName].distortionActive=!0,i+='<div id="wrapperFx0"><div id="sFx0"><span></span></div><div class="insideDivEffects"><input type="range" id="myRangeFx0" class="sliders" style="margin-top:20px" value="2"><span id="myspanFx0" class="rangeslidervalue">2</span></div></div>',L.innerHTML=i,docById("sFx0").textContent=_("distortion amount"),docById("myRangeFx0").value=40,docById("myspanFx0").textContent="40",0!==A.distortionEffect.length&&(N=A.distortionEffect.length-1,docById("myRangeFx0").value=parseFloat(A.distortionParams[0]),docById("myspanFx0").textContent=A.distortionParams[0],A._update(N,A.distortionParams[0],0)),0===A.distortionEffect.length)return E=A.activity.blocks.blockList[A.blockNo].connections[2],C=A.activity.blocks.blockList.length,I=[[0,["dis",{}],0,0,[null,1,null,2]],[1,["number",{value:40}],0,0,[0]],[2,"hidden",0,0,[0,null]]],A.activity.blocks.loadNewBlocks(I),A.distortionEffect.push(C),A.distortionParams.push(40),t.next=167,delayExecution(500);t.next=168;break;case 167:A.clampConnection(C,2,E);case 168:document.getElementById("wrapperFx0").addEventListener("change",function(t){var e=t.target;docById("myRangeFx0").value=parseFloat(e.value),docById("myspanFx0").textContent=e.value,instrumentsEffects[0][A.instrumentName].distortionAmount=parseFloat(e.value)/100,A._update(N,e.value,0),A._playNote("G4",1/8)});case 169:case"end":return t.stop()}},t)}));return function(t){return e.apply(this,arguments)}}()}),this.notesToPlay=[],this.env=[],this.ENVs=[],this._eventListeners={},this.synthVals={oscillator:{type:"sine6",source:DEFAULTOSCILLATORTYPE},envelope:{attack:.01,decay:.5,sustain:.6,release:.01}},this.adsrMap=["attack","decay","sustain","release"],this.amSynthParamvals={harmonicity:3},this.fmSynthParamvals={modulationIndex:10},this.noiseSynthParamvals={noise:{type:"white"}},this.duoSynthParamVals={vibratoAmount:.5,vibratoRate:5},this.fil=[],this.filterParams=[],this.osc=[],this.oscParams=[],this.tremoloEffect=[],this.tremoloParams=[],this.vibratoEffect=[],this.vibratoParams=[],this.chorusEffect=[],this.chorusParams=[],this.phaserEffect=[],this.phaserParams=[],this.distortionEffect=[],this.distortionParams=[],this.AMSynthesizer=[],this.AMSynthParams=[],this.FMSynthesizer=[],this.FMSynthParams=[],this.NoiseSynthesizer=[],this.NoiseSynthParams=[],this.duoSynthesizer=[],this.duoSynthParams=[],this.activeParams=["synth","amsynth","fmsynth","noisesynth","duosynth","envelope","oscillator","filter","effects","chorus","vibrato","phaser","distortion","tremolo"],this.isActive={};for(var t=0;t<this.activeParams.length;t++)this.isActive[this.activeParams[t]]=!1;this.blockNo=null,this.instrumentName="custom",this.instrumentName in instrumentsFilters[0]||(instrumentsFilters[0][this.instrumentName]=[]),this.instrumentName in instrumentsEffects[0]||(instrumentsEffects[0][this.instrumentName]=[]),this.timbreTableDiv=document.createElement("div")}return _createClass(u,[{key:"_addButton",value:function(t,e,i,s){var n=this,a=t.insertCell(-1);return a.innerHTML='&nbsp;&nbsp;<img \n                src="header-icons/'.concat(e,'" \n                title="').concat(s,'" \n                alt="').concat(s,'" \n                height="').concat(i,'" \n                width="').concat(i,'" \n                vertical-align="middle" \n                align-content="center"\n            >&nbsp;&nbsp;'),a.style.width=u.BUTTONSIZE+"px",a.style.minWidth=a.style.width,a.style.maxWidth=a.style.width,a.style.height=a.style.width,a.style.minHeight=a.style.height,a.style.maxHeight=a.style.height,a.style.backgroundColor=platformColor.selectorBackground,a.onmouseover=function(){n.style.backgroundColor=platformColor.selectorBackgroundHOVER},a.onmouseout=function(){n.style.backgroundColor=platformColor.selectorBackground},a}},{key:"_playNote",value:function(t,e){var i,s;this.activity.logo.synth.setMasterVolume(last(Singer.masterVolume)),this.instrumentName in instrumentsFilters[0]?(s={doVibrato:!1,doDistortion:!1,doTremolo:!1,doPhaser:!1,doChorus:!1,vibratoIntensity:0,vibratoFrequency:0,distortionAmount:0,tremoloFrequency:0,tremoloDepth:0,rate:0,octaves:0,baseFrequency:0,chorusRate:0,delayTime:0,chorusDepth:0},(i=instrumentsEffects[0][this.instrumentName]).vibratoActive&&(s.vibratoFrequency=i.vibratoFrequency,s.vibratoIntensity=i.vibratoIntensity,s.doVibrato=!0),i.distortionActive&&(s.distortionAmount=i.distortionAmount,s.doDistortion=!0),i.tremoloActive&&(s.tremoloFrequency=i.tremoloFrequency,s.tremoloDepth=i.tremoloDepth,s.doTremolo=!0),i.phaserActive&&(s.rate=i.rate,s.octaves=i.octaves,s.baseFrequency=i.baseFrequency,s.doPhaser=!0),i.chorusActive&&(s.chorusRate=i.chorusRate,s.delayTime=i.delayTime,s.chorusDepth=i.chorusDepth,s.doChorus=!0),this.activity.logo.synth.trigger(0,t,Singer.defaultBPMFactor*e,this.instrumentName,s,instrumentsFilters[0][this.instrumentName])):this.activity.logo.synth.trigger(0,t,Singer.defaultBPMFactor*e,this.instrumentName,null,null)}},{key:"_play",value:function(){var i=this;this._playing=!this._playing,this.activity.logo.resetSynth(0);var s=this.playButton;this._playing?s.innerHTML='&nbsp;&nbsp;<img src="header-icons/stop-button.svg" title="'+_("Stop")+'" alt="'+_("Stop")+'" height="'+u.ICONSIZE+'" width="'+u.ICONSIZE+'" vertical-align="middle" align-content="center">&nbsp;&nbsp;':(this.activity.logo.synth.setMasterVolume(0),this.activity.logo.synth.stop(),s.innerHTML='&nbsp;&nbsp;<img \n                    src="header-icons/play-button.svg" \n                    title="'.concat(_("Play"),'" \n                    alt="').concat(_("Play"),'" \n                    height="').concat(u.ICONSIZE,'" \n                    width="').concat(u.ICONSIZE,'" \n                    vertical-align="middle" \n                    align-content="center"\n                >&nbsp;&nbsp;')),0===this.notesToPlay.length&&(this.notesToPlay=[["G4",.25],["E4",.25],["G4",.5]]);this._playing&&!function t(e){i._playing&&i._playNote(i.notesToPlay[e][0],i.notesToPlay[e][1]),(e+=1)<i.notesToPlay.length&&i._playing?setTimeout(function(){t(e)},1e3*Singer.defaultBPMFactor*i.notesToPlay[e-1][1]):(s.innerHTML='&nbsp;&nbsp;<img \n                        src="header-icons/play-button.svg" \n                        title="'.concat(_("Play"),'" \n                        alt="').concat(_("Play"),'" \n                        height="').concat(u.ICONSIZE,'" \n                        width="').concat(u.ICONSIZE,'" \n                        vertical-align="middle" \n                        align-content="center"\n                    >&nbsp;&nbsp;'),i._playing=!1)}(0)}},{key:"_save",value:function(){var t=[[0,"settimbre",100+this._delta,100+this._delta,[null,1,null,2]],[1,["text",{value:"custom"}],0,0,[0]],[2,"hidden",0,0,[0,null]]];this.activity.blocks.loadNewBlocks(t),this._delta+=42}},{key:"_undo",value:function(){var t=0;if(this.isActive.envelope){1<this.env.length&&(t=this.env.length-1),docById("envelopeButtonCell").style.backgroundColor=platformColor.selectorBackground;for(var e=0;e<4;e++)this.synthVals.envelope[this.adsrMap[e]]=parseFloat(this.ENVs[e])/100,docById("myRange"+e).value=parseFloat(this.ENVs[e]),docById("myspan"+e).textContent=this.ENVs[e],this._update(t,parseFloat(this.ENVs[e]),e);this.activity.logo.synth.createSynth(0,this.instrumentName,this.synthVals.oscillator.source,this.synthVals)}else if(!0===this.isActive.amsynth)docById("synthButtonCell").style.backgroundColor=platformColor.selectorBackground,1<this.AMSynthesizer.length&&(t=this.AMSynthesizer.length-1),docById("myRangeS0").value=parseFloat(this.AMSynthParams[0]),docById("myspanS0").textContent=this.AMSynthParams[0],this.amSynthParamvals.harmonicity=parseFloat(this.AMSynthParams[0]),this._update(t,this.AMSynthParams[0],0),this.activity.logo.synth.createSynth(0,this.instrumentName,"amsynth",this.amSynthParamvals);else if(!0===this.isActive.fmsynth)docById("synthButtonCell").style.backgroundColor=platformColor.selectorBackground,1<this.FMSynthesizer.length&&(t=this.FMSynthesizer.length-1),docById("myRangeS0").value=parseFloat(this.FMSynthParams[0]),docById("myspanS0").textContent=this.FMSynthParams[0],this.fmSynthParamvals.modulationIndex=parseFloat(this.FMSynthParams[0]),this._update(t,this.FMSynthParams[0],0),this.activity.logo.synth.createSynth(0,this.instrumentName,"fmsynth",this.fmSynthParamvals);else if(!0===this.isActive.noisesynth)docById("synthButtonCell").style.backgroundColor=platformColor.selectorBackground,1<this.NoiseSynthesizer.length&&(t=this.NoiseSynthesizer.length-1),docById("myRangeS0").value=this.NoiseSynthParams[0],docById("myspanS0").textContent=this.NoiseSynthParams[0],this.noiseSynthParamvals["noise.type"]=this.NoiseSynthParams[0],this._update(t,this.NoiseSynthParams[0],0),this.activity.logo.synth.createSynth(0,this.instrumentName,"noisesynth",this.noiseSynthParamvals);else if(!0===this.isActive.duosynth)docById("synthButtonCell").style.backgroundColor=platformColor.selectorBackground,1<this.duoSynthesizer.length&&(t=this.duoSynthesizer.length-1),docById("myRangeS0").value=parseFloat(this.duoSynthParams[0]),docById("myspanS0").textContent=this.duoSynthParams[0],this.duoSynthParamVals.vibratoRate=parseFloat(this.duoSynthParams[0]),this._update(t,this.duoSynthParams[0],0),docById("myRangeS1").value=parseFloat(this.duoSynthParams[1]),docById("myspanS1").textContent=this.duoSynthParams[1],this.duoSynthParamVals.vibratoAmount=parseFloat(this.duoSynthParams[1]),this._update(t,this.duoSynthParams[1],1),this.activity.logo.synth.createSynth(0,this.instrumentName,"duosynth",this.duoSynthParamVals);else if(this.isActive.oscillator)docById("oscillatorButtonCell").style.backgroundColor=platformColor.selectorBackground,1<this.osc.length&&(t=this.osc.length-1),docById("selOsc1").value=DEFAULTOSCILLATORTYPE,this._update(t,DEFAULTOSCILLATORTYPE,0),docById("myRangeO0").value=parseFloat(6),docById("myspanO0").textContent="6",this._update(t,"6",1),this.synthVals.oscillator.type="sine6",this.synthVals.oscillator.source=DEFAULTOSCILLATORTYPE,this.activity.logo.synth.createSynth(0,this.instrumentName,this.oscParams[0],this.synthVals);else if(this.isActive.filter)for(var i=0;i<this.fil.length;i++){docById("filterButtonCell").style.backgroundColor=platformColor.selectorBackground,docById("sel"+i).value=this.filterParams[3*i],this._update(i,this.filterParams[3*i],0),instrumentsFilters[0][this.instrumentName][i].filterType=this.filterParams[3*i];var s=[4*i,4*i+1,4*i+2,4*i+3];-12===this.filterParams[3*i+1]?docById("radio"+s[0]).checked=!0:docById("radio"+s[0]).checked=!1,-24===this.filterParams[3*i+1]?docById("radio"+s[1]).checked=!0:docById("radio"+s[1]).checked=!1,-48===this.filterParams[3*i+1]?docById("radio"+s[2]).checked=!0:docById("radio"+s[2]).checked=!1,-96===this.filterParams[3*i+1]?docById("radio"+s[3]).checked=!0:docById("radio"+s[3]).checked=!1,this._update(i,this.filterParams[1+3*i],1),instrumentsFilters[0][this.instrumentName][i].filterRolloff=parseFloat(this.filterParams[1+3*i]),docById("myRangeF"+i).value=parseFloat(this.filterParams[2+3*i]),docById("myspanF"+i).textContent=this.filterParams[2+3*i],this._update(i,this.filterParams[2+3*i],2),instrumentsFilters[0][this.instrumentName][i].filterFrequency=parseFloat(this.filterParams[2+3*i])}else if(!0===this.isActive.tremolo){docById("effectsButtonCell").style.backgroundColor=platformColor.selectorBackground,1!==this.tremoloEffect.length&&(t=this.tremoloEffect.length-1);for(var n=0;n<2;n++)docById("myRangeFx"+n).value=parseFloat(this.tremoloParams[n]),docById("myspanFx"+n).textContent=this.tremoloParams[n],this._update(t,this.tremoloParams[n],n)}else if(!0===this.isActive.vibrato){docById("effectsButtonCell").style.backgroundColor=platformColor.selectorBackground,1!==this.vibratoEffect.length&&(t=this.vibratoEffect.length-1);for(var a=0;a<2;a++)docById("myRangeFx"+a).value=parseFloat(this.vibratoParams[a]),docById("myspanFx"+a).textContent=this.vibratoParams[a],this._update(t,this.vibratoParams[a],a)}else if(!0===this.isActive.phaser){docById("effectsButtonCell").style.backgroundColor=platformColor.selectorBackground,1!==this.phaserEffect.length&&(t=this.phaserEffect.length-1);for(var o=0;o<3;o++)docById("myRangeFx"+o).value=parseFloat(this.phaserParams[o]),docById("myspanFx"+o).textContent=this.phaserParams[o],this._update(t,this.phaserParams[o],o)}else if(!0===this.isActive.chorus){docById("effectsButtonCell").style.backgroundColor=platformColor.selectorBackground,1!==this.chorusEffect.length&&(t=this.chorusEffect.length-1);for(var r=0;r<3;r++)docById("myRangeFx"+r).value=parseFloat(this.chorusParams[r]),docById("myspanFx"+r).textContent=this.chorusParams[r],this._update(t,this.chorusParams[r],r)}else!0===this.isActive.distortion&&(docById("effectsButtonCell").style.backgroundColor=platformColor.selectorBackground,1!==this.distortionEffect.length&&(t=this.dstortionEffect.length-1),docById("myRangeFx0").value=parseFloat(this.distortionParams[0]),docById("myspanFx0").textContent=this.distortionParams[0],this._update(t,this.distortionParams[0],0));this._playNote("G4",1/8)}},{key:"init",value:function(e){var o=this;this.activity=e,this._delta=0,this._playing=!1;var t=window.widgetWindows.windowFor(this,"timbre","timbre",!0);(this.widgetWindow=t).clear(),t.show();var r,i=window.innerWidth;this._cellScale=i/1200,t.getWidgetBody().append(this.timbreTableDiv),t.getWidgetBody().style.height="500px",t.getWidgetBody().style.width="600px",t.getWidgetBody().style.overflowY="auto",t.onclose=function(){o._cleanupEventListeners(),o.activity.hideMsgs(),t.destroy()},this.playButton=t.addButton("play-button.svg",u.ICONSIZE,_("Play")),this.playButton.onclick=function(){o._play()},t.addButton("export-chunk.svg",u.ICONSIZE,_("Save")).onclick=function(){o._save()};var s=t.addButton("synth.svg",u.ICONSIZE,_("Synthesizer"));s.id="synthButtonCell",this.isActive.synth=!1,s.onclick=function(){r(s);for(var t=0;t<o.activeParams.length;t++)o.isActive[o.activeParams[t]]=!1;o.isActive.synth=!0,0===o.osc.length?o._synth():e.errorMsg(_("Unable to use synth due to existing oscillator"),3e3)};var l=t.addButton("oscillator.svg",u.ICONSIZE,_("Oscillator"));l.id="oscillatorButtonCell",this.isActive.oscillator=!1,l.onclick=_asyncToGenerator(regeneratorRuntime.mark(function t(){var e,i,s,n,a;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:for(r(l),e=0;e<o.activeParams.length;e++)o.isActive[o.activeParams[e]]=!1;if(o.isActive.oscillator=!0,0===o.osc.length)return i=o.activity.blocks.blockList[o.blockNo].connections[2],s=o.activity.blocks.findBottomBlock(i),n=[[0,["oscillator",{}],0,0,[null,2,1,null]],[1,["number",{value:6}],0,0,[0]],[2,["oscillatortype",{value:DEFAULTOSCILLATORTYPE}],0,0,[0]]],o.activity.blocks.loadNewBlocks(n),t.next=10,delayExecution(100);t.next=20;break;case 10:return a=o.activity.blocks.blockList.length-3,o.osc.push(a),o.oscParams.push(DEFAULTOSCILLATORTYPE),o.oscParams.push(6),t.next=16,delayExecution(500);case 16:o.blockConnection(3,s),o._oscillator(!0),t.next=21;break;case 20:o._oscillator(!1);case 21:0===o.osc.length||0===o.AMSynthesizer.length&&0===o.FMSynthesizer.length&&0===o.duoSynthesizer.length||o._oscillator(!1);case 22:case"end":return t.stop()}},t)}));var c=t.addButton("envelope.svg",u.ICONSIZE,_("Envelope"));c.id="envelopeButtonCell",this.isActive.envelope=!1,c.onclick=_asyncToGenerator(regeneratorRuntime.mark(function t(){var e,i,s,n,a;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:for(r(c),e=0;e<o.activeParams.length;e++)o.isActive[o.activeParams[e]]=!1;if(o.isActive.envelope=!0,0===o.env.length)return i=o.activity.blocks.blockList[o.blockNo].connections[2],s=o.activity.blocks.findBottomBlock(i),n=[[0,["envelope",{}],0,0,[null,1,2,3,4,null]],[1,["number",{value:1}],0,0,[0]],[2,["number",{value:50}],0,0,[0]],[3,["number",{value:60}],0,0,[0]],[4,["number",{value:1}],0,0,[0]]],o.activity.blocks.loadNewBlocks(n),t.next=10,delayExecution(100);t.next=22;break;case 10:return a=o.activity.blocks.blockList.length-5,o.env.push(a),o.ENVs.push(1),o.ENVs.push(50),o.ENVs.push(60),o.ENVs.push(1),t.next=18,delayExecution(500);case 18:o.blockConnection(5,s),o._envelope(!0),t.next=23;break;case 22:o._envelope(!1);case 23:case"end":return t.stop()}},t)}));var n=t.addButton("effects.svg",u.ICONSIZE,_("Effects"));n.id="effectsButtonCell",this.isActive.effects=!1,n.onclick=function(){r(n);for(var t=0;t<o.activeParams.length;t++)o.isActive[o.activeParams[t]]=!1;o.isActive.effects=!0,o._effects()};var d=t.addButton("filter.svg",u.ICONSIZE,_("Filter"));d.id="filterButtonCell",this.isActive.filter=!1,d.onclick=_asyncToGenerator(regeneratorRuntime.mark(function t(){var e,i,s,n,a;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:for(r(d),e=0;e<o.activeParams.length;e++)o.isActive[o.activeParams[e]]=!1;if(o.isActive.filter=!0,0===o.fil.length)return i=o.activity.blocks.blockList[o.blockNo].connections[2],s=o.activity.blocks.findBottomBlock(i),n=[[0,["filter",{}],0,0,[null,3,1,2,null]],[1,["number",{value:-12}],0,0,[0]],[2,["number",{value:392}],0,0,[0]],[3,["filtertype",{value:DEFAULTFILTERTYPE}],0,0,[0]]],o.activity.blocks.loadNewBlocks(n),t.next=10,delayExecution(100);t.next=18;break;case 10:return a=o.activity.blocks.blockList.length-4,o.fil.push(a),o.filterParams.push(DEFAULTFILTERTYPE),o.filterParams.push(-12),o.filterParams.push(392),t.next=17,delayExecution(500);case 17:o.blockConnection(4,s);case 18:o._filter();case 19:case"end":return t.stop()}},t)}));var a=t.addButton("filter+.svg",u.ICONSIZE,_("Add filter"));a.style.backgroundColor="#808080",a.onclick=function(){o.isActive.filter&&o._addFilter()},a.onmouseover=function(){},a.onmouseout=function(){},t.addButton("restore-button.svg",u.ICONSIZE,_("Undo")).onclick=function(){o._undo()},r=function(t){a.style.backgroundColor=platformColor.widgetButton,s.style.backgroundColor=platformColor.widgetButton,l.style.backgroundColor=platformColor.widgetButton,c.style.backgroundColor=platformColor.widgetButton,n.style.backgroundColor=platformColor.widgetButton,d.style.backgroundColor=platformColor.widgetButton,t.style.backgroundColor=platformColor.widgetButtonSelect},e.textMsg(_("Click on buttons to open the timbre design tools."),3e3),t.sendToCenter()}},{key:"_changeBlock",value:function(t,e,i){var s=0;0!==this.AMSynthesizer.length&&"AMSynth"!==e?(s=this.AMSynthesizer.pop(),setTimeout(this._blockReplace(s,t),500)):0!==this.FMSynthesizer.length&&"FMSynth"!==e?(s=this.FMSynthesizer.pop(),setTimeout(this._blockReplace(s,t),500)):0!==this.duoSynthesizer.length&&"DuoSynth"!==e?(s=this.duoSynthesizer.pop(),setTimeout(this._blockReplace(s,t),500)):"FMSynth"===e||"AMSynth"===e?setTimeout(this.blockConnection(2,i),500):setTimeout(this.blockConnection(3,i),500)}},{key:"_blockReplace",value:function(t,e){var i=this.activity.blocks.blockList[t].connections[0],s=last(this.activity.blocks.blockList[t].connections);if(this.activity.blocks.blockList[e].connections[0]=i,this.activity.blocks.blockList[e].connections[this.activity.blocks.blockList[e].connections.length-1]=s,null!=i){for(var n=0;n<this.activity.blocks.blockList[i].connections.length;n++)if(this.activity.blocks.blockList[i].connections[n]===t){this.activity.blocks.blockList[i].connections[n]=e;break}for(var a=i;a!=this.blockNo;)this.activity.blocks.blockList[a].isClampBlock()&&this.activity.blocks.clampBlocksToCheck.push([a,0]),a=this.activity.blocks.blockList[a].connections[0];this.activity.blocks.clampBlocksToCheck.push([this.blockNo,0])}if(null!=s)for(var o=0;o<this.activity.blocks.blockList[s].connections.length;o++)if(this.activity.blocks.blockList[s].connections[o]===t){this.activity.blocks.blockList[s].connections[o]=e;break}this.activity.blocks.adjustDocks(i,!0),this.activity.blocks.blockList[t].connections[0]=null,this.activity.blocks.blockList[t].connections[this.activity.blocks.blockList[t].connections.length-1]=null,this.activity.blocks.sendStackToTrash(this.activity.blocks.blockList[t]),this.activity.refreshCanvas()}},{key:"_oscillator",value:function(t){var i=this,s=0;1!==this.osc.length&&(s=this.osc.length-1),this.timbreTableDiv.style.display="inline",this.timbreTableDiv.style.visibility="visible",this.timbreTableDiv.style.border="0px",this.timbreTableDiv.style.overflow="auto",this.timbreTableDiv.style.backgroundColor="white",this.timbreTableDiv.style.height="300px",this.timbreTableDiv.innerHTML='<div id="timbreTable"></div>';var e=docById("timbreTable"),n='<div id="wrapperOsc0"><div id="sOsc0"><span>'+_("type")+'</span></div><div id="selOsc"></div></div>';n+='<div id="wrapperOsc1"><div id="sOsc1"><span>'+_("partials")+'</span></div><div class="insideDivOsc"><input type="range" id="myRangeO0" class="sliders" style="margin-top:20px" min="0" max="20" value="'+parseFloat(this.oscParams[1])+'"><span id="myspanO0" class="rangeslidervalue">'+this.oscParams[1]+"</span></div></div>",e.innerHTML=n;var a=document.createElement("div");a.id="envAppend",a.style.backgroundColor=platformColor.widgetBackground,a.style.height="30px",a.style.marginTop="40px",a.style.overflow="auto",e.append(a);for(var o=docById("selOsc"),r='<select id="selOsc1">',l=0;l<OSCTYPES.length;l++)0===OSCTYPES[l][0].length?OSCTYPES[l][0]===this.oscParams[0]||OSCTYPES[l][1]===this.oscParams[0]?r+='<option value="'+OSCTYPES[l][1]+'" selected>'+OSCTYPES[l][1]+"</option>":r+='<option value="'+OSCTYPES[l][1]+'">'+OSCTYPES[l][1]+"</option>":OSCTYPES[l][0]===this.oscParams[0]||OSCTYPES[l][1]===this.oscParams[0]?r+='<option value="'+OSCTYPES[l][0]+'" selected>'+OSCTYPES[l][0]+"</option>":r+='<option value="'+OSCTYPES[l][0]+'">'+OSCTYPES[l][0]+"</option>";r+="</select>",o.innerHTML=r,document.getElementById("wrapperOsc0").addEventListener("change",function(t){var e=t.target;i.oscParams[0]=e.value,i.synthVals.oscillator.type=e.value+i.oscParams[1].toString(),i.synthVals.oscillator.source=e.value,i._update(s,e.value,0),i.activity.logo.synth.createSynth(0,i.instrumentName,i.oscParams[0],i.synthVals),i._playNote("G4",1/8)}),document.getElementById("wrapperOsc1").addEventListener("change",function(t){var e=t.target;i.oscParams[1]=parseFloat(e.value),i.synthVals.oscillator.type=i.oscParams[0]+parseFloat(e.value),docById("myRangeO0").value=parseFloat(e.value),docById("myspanO0").textContent=e.value,i._update(s,e.value,1),i.activity.logo.synth.createSynth(0,i.instrumentName,i.oscParams[0],i.synthVals),i._playNote("G4",1/8)}),docById("selOsc1").value=this.oscParams[0],this._update(s,this.oscParams[0],0),this._update(s,this.oscParams[1],1),this.synthVals.oscillator.type=this.oscParams[0]+this.oscParams[1].toString(),this.synthVals.oscillator.source=this.oscParams[0],t&&this.activity.logo.synth.createSynth(0,this.instrumentName,this.oscParams[0],this.synthVals)}},{key:"_envelope",value:function(t){var s=this,n=0;1!==this.env.length&&(n=this.env.length-1),this.timbreTableDiv.style.display="inline",this.timbreTableDiv.style.visibility="visible",this.timbreTableDiv.style.border="0px",this.timbreTableDiv.style.overflow="auto",this.timbreTableDiv.style.backgroundColor="white",this.timbreTableDiv.style.height="300px",this.timbreTableDiv.innerHTML='<div id="timbreTable"></div>';for(var e=docById("timbreTable"),i="",a=0;a<4;a++)i+='<div id="wrapperEnv'+a+'"><div class="circle">'+"ADSR".charAt(a)+'</div><div class="insideDivEnv"><input type="range" id="myRange'+a+'" class="sliders" style="margin-top:20px" value="'+parseFloat(this.ENVs[a])+'"><span id="myspan'+a+'" class="rangeslidervalue">'+this.ENVs[a]+"</span></div></div>";e.innerHTML=i;var o=document.createElement("div");o.id="envAppend",o.style.backgroundColor=platformColor.widgetBackground,o.style.height="30px",o.style.marginTop="40px",o.style.overflow="auto",e.append(o);for(var r=0;r<4;r++)this.synthVals.envelope[this.adsrMap[r]]=parseFloat(this.ENVs[r])/100,this._update(n,this.ENVs[r],r);for(var l=0;l<4;l++)document.getElementById("wrapperEnv"+l).addEventListener("change",function(t){var e=t.target,i=e.id.slice(-1);docById("myRange"+i).value=parseFloat(e.value),docById("myspan"+i).textContent=e.value,s.synthVals.envelope[s.adsrMap[i]]=parseFloat(e.value)/100,s._update(n,parseFloat(e.value),i),s.activity.logo.synth.createSynth(0,s.instrumentName,s.synthVals.oscillator.source,s.synthVals),s._playNote("G4",1/8)});t&&this.activity.logo.synth.createSynth(0,this.instrumentName,this.synthVals.oscillator.source,this.synthVals)}},{key:"_filter",value:function(){this.timbreTableDiv.style.display="inline",this.timbreTableDiv.style.visibility="visible",this.timbreTableDiv.style.border="0px",this.timbreTableDiv.style.overflow="auto",this.timbreTableDiv.style.backgroundColor="white",this.timbreTableDiv.style.height="300px",this.timbreTableDiv.innerHTML='<div id="timbreTable"></div>';var t=docById("timbreTable");t.innerHTML="";for(var e=0;e<this.fil.length;e++)this._createFilter(e,t);this._setupEventDelegation(),this._updateFilters()}},{key:"_createFilter",value:function(t,e){var i,s,n=[3*t,3*t+1,3*t+2],a=[4*t,4*t+1,4*t+2,4*t+3],o=document.createDocumentFragment(),r=document.createElement("div");t%2==1?(r.className="rectangle",(i=document.createElement("p")).innerHTML="&nbsp;",r.appendChild(i)):0<t&&((s=document.createElement("p")).innerHTML="&nbsp;",r.appendChild(s));var l=document.createElement("div");l.className="wrapper",l.id="wrapper"+n[0];var c=document.createElement("div");c.className="s",c.id="s"+n[0];var d=document.createElement("span");d.textContent=_("type"),c.appendChild(d);var u="selector"+t,h="sel"+t,y=document.createElement("div");y.className="filterselector",y.id=u,l.appendChild(c),l.appendChild(y),r.appendChild(l);var v=document.createElement("div");v.className="wrapper",v.id="wrapper"+n[1];var m=document.createElement("div");m.className="s",m.id="s"+n[1];var p=document.createElement("span");p.textContent=_("rolloff"),m.appendChild(p);var b=document.createElement("div");b.className="insideDivFilter";for(var f=document.createElement("p"),k=["-12","-24","-48","-96"],g=0;g<4;g++){var S=document.createElement("input");S.type="radio",S.id="radio"+a[g],S.name="rolloff"+t,S.value=k[g],0===g&&(S.checked=!0),f.appendChild(S),f.appendChild(document.createTextNode(k[g]))}b.appendChild(f),v.appendChild(m),v.appendChild(b),r.appendChild(v);var x=document.createElement("div");x.className="wrapper",x.id="wrapper"+n[2];var F=document.createElement("div");F.className="s",F.id="s"+n[2];var P=document.createElement("span");P.textContent=_("frequency"),F.appendChild(P);var B=document.createElement("div");B.className="insideDivFilter";var E=document.createElement("input");E.type="range",E.id="myRangeF"+t,E.className="sliders",E.style.marginTop="20px",E.max="7050",E.value=parseFloat(this.filterParams[3*t+2]);var C=document.createElement("span");C.id="myspanF"+t,C.className="rangeslidervalue",C.textContent=this.filterParams[3*t+2],B.appendChild(E),B.appendChild(C),x.appendChild(F),x.appendChild(B),r.appendChild(x),o.appendChild(r),e.appendChild(o);var I=document.createElement("select");I.className="sel",I.id=h;for(var N=null,T=0;T<FILTERTYPES.length;T++){var L=document.createElement("option");0===FILTERTYPES[T][0].length?(L.value=FILTERTYPES[T][1],L.textContent=FILTERTYPES[T][1],FILTERTYPES[T][1]===this.filterParams[3*t]&&(L.selected=!0,N=FILTERTYPES[T][1])):(L.value=FILTERTYPES[T][0],L.textContent=FILTERTYPES[T][0],FILTERTYPES[T][0]===this.filterParams[3*t]&&(L.selected=!0,N=FILTERTYPES[T][0])),I.appendChild(L)}docById(u).appendChild(I),instrumentsFilters[0][this.instrumentName].length-1<t&&instrumentsFilters[0][this.instrumentName].push({filterType:N,filterRolloff:-12,filterFrequency:392})}},{key:"_setupEventDelegation",value:function(){var r=this,t=docById("timbreTable");this._cleanupEventListeners();var l=docById("filterButtonCell");this._eventHandler=function(t){var e,i,s,n,a=t.target,o=a.id||"";o.startsWith("sel")&&"change"===t.type?(l.style.backgroundColor="#C8C8C0",e=o.slice(-1),instrumentsFilters[0][r.instrumentName][e].filterType=a.value,r._update(e,a.value,0),1<instrumentsFilters[0][r.instrumentName].filter(function(t){return t.filterType===a.value}).length&&activity.errorMsg(_("Filter already present."),3e3),r._playNote("G4",1/8)):o.startsWith("radio")&&"click"===t.type?(i=Number(o.replace("radio","")),instrumentsFilters[0][r.instrumentName][Math.floor(i/4)].filterRolloff=parseFloat(a.value),r._update(Math.floor(i/4),a.value,1),r._playNote("G4",1/8)):!o.startsWith("myRangeF")||"change"!==t.type&&"input"!==t.type?(o.startsWith("wrapperS")&&"change"===t.type||o.startsWith("wrapperOsc")&&"change"===t.type||o.startsWith("wrapperEnv")&&"change"===t.type||o.startsWith("wrapperFx")&&"change"===t.type)&&r._playNote("G4",1/8):(l.style.backgroundColor="#C8C0C8",s=o.slice(-1),(n=docById("myspanF"+s))&&(n.textContent=a.value),instrumentsFilters[0][r.instrumentName][s].filterFrequency=parseFloat(a.value),r._update(s,a.value,2),r._playNote("G4",1/8))},t.addEventListener("change",this._eventHandler),t.addEventListener("click",this._eventHandler),t.addEventListener("input",this._eventHandler),this._eventListeners={element:t,listeners:[{type:"change",handler:this._eventHandler},{type:"click",handler:this._eventHandler},{type:"input",handler:this._eventHandler}]}}},{key:"_cleanupEventListeners",value:function(){var e=this;this._eventListeners&&this._eventListeners.element&&(this._eventListeners.listeners.forEach(function(t){e._eventListeners.element.removeEventListener(t.type,t.handler)}),this._eventListeners={})}},{key:"_addFilterListeners",value:function(){this._setupEventDelegation()}},{key:"_updateFilters",value:function(){for(var t=0;t<this.fil.length;t++){var e=[4*t,4*t+1,4*t+2,4*t+3];docById("sel"+t).value=instrumentsFilters[0][this.instrumentName][t].filterType;var i=instrumentsFilters[0][this.instrumentName][t].filterRolloff;docById("radio"+e[0]).checked=-12===i,docById("radio"+e[1]).checked=-24===i,docById("radio"+e[2]).checked=-48===i,docById("radio"+e[3]).checked=-96===i}}}]),u}();_defineProperty(TimbreWidget,"BUTTONSIZE",53),_defineProperty(TimbreWidget,"ICONSIZE",32);