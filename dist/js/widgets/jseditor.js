"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var o=e[Symbol.toPrimitive];if(void 0===o)return("string"===t?String:Number)(e);var n=o.call(e,t||"default");if("object"!=_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}var JSEditor=function(){function a(e){_classCallCheck(this,a),this.activity=e,this.isOpen=!0,this._showingHelp=!1,this.widgetWindow=window.widgetWindows.windowFor(this,"JavaScript Editor","JavaScript Editor"),this.widgetWindow.clear(),this.widgetWindow.show(),this.widgetWindow.setPosition(160,132),this._editor=document.createElement("div"),this._jar=null,this._code=null,this._codeBck=null,this._currentStyle=0,this._styles=["dracula","github","railscasts","vs"].map(function(e){var t=document.createElement("link");return t.href="././lib/codejar/styles/".concat(e,".min.css"),t.rel="stylesheet",t.disabled="true",document.head.appendChild(t),t}),this._styles[this._currentStyle].removeAttribute("disabled"),this._addErrorStyles(),this._setup(),this._setLinesCount(this._code)}return _createClass(a,[{key:"_addErrorStyles",value:function(){var e;document.getElementById("js-error-styles")||((e=document.createElement("style")).id="js-error-styles",e.textContent="\n            .error {\n                background-color: #ff4444 !important;\n                color: white !important;\n                border-radius: 2px;\n                padding: 1px 2px;\n                position: relative;\n            }\n            \n            .hljs-keyword {\n                color: #007acc !important;\n                font-weight: bold;\n            }\n            \n            .hljs-built_in {\n                color: #00d4aa !important;\n            }\n            \n            .hljs-title.function_ {\n                color: #ffcc00 !important;\n            }\n            \n            .hljs-number {\n                color: #4ec9b0 !important;\n            }\n            \n            .hljs-string {\n                color: #ff8c00 !important;\n            }\n            \n            .hljs-subst {\n                color: #ff8c00 !important;\n                background-color: rgba(255, 140, 0, 0.1) !important;\n            }\n            \n            .hljs-comment {\n                color: #57a64a !important;\n                font-style: italic;\n            }\n            \n            .hljs-title.class_ {\n                color: #c586c0 !important;\n            }\n            \n            .hljs-variable {\n                color: #4fc1ff !important;\n            }\n            \n            .hljs-params {\n                color: #4fc1ff !important;\n            }\n            \n            .hljs-property {\n                color: #ff79c6 !important;\n            }\n            \n            .hljs-literal {\n                color: #007acc !important;\n            }\n            \n            .hljs-type {\n                color: #00d4aa !important;\n            }\n            \n            .hljs-operator {\n                color: #ffffff !important;\n            }\n            \n            .hljs-punctuation {\n                color: #cccccc !important;\n            }\n            \n            .hljs-regexp {\n                color: #ff5555 !important;\n            }\n            \n            .hljs-symbol {\n                color: #ffcc00 !important;\n            }\n        ",document.head.appendChild(e))}},{key:"_highlightErrors",value:function(t){t.querySelectorAll(".error").forEach(function(e){var t=e.textContent;e.replaceWith(t)});try{var e=t.textContent;acorn.parse(e,{ecmaVersion:2020})}catch(e){void 0!==e.pos&&this._markErrorAtPosition(t,e.pos,e.message),a.logConsole("Syntax Error at position ".concat(e.pos,": ").concat(e.message))}}},{key:"_markErrorAtPosition",value:function(e,t,o){for(var n=e.textContent,i=t,s=t;0<i;){var r=n.charAt(i-1);if(" "===r||"\n"===r||"\t"===r||";"===r||"{"===r||"}"===r||"("===r||")"===r||","===r)break;i--}for(;s<n.length;){var l=n.charAt(s);if(" "===l||"\n"===l||"\t"===l||";"===l||"{"===l||"}"===l||"("===l||")"===l||","===l)break;s++}i===s&&(s=Math.min(i+1,n.length)),this._markErrorSpan(e,i,s,o)}},{key:"_markErrorSpan",value:function(e,t,o,n){var i=e.textContent,s=i.substring(t,o),r=i.substring(0,t),l=i.substring(o),a=r+'<span class="error" title="'.concat(n,'">').concat(s,"</span>")+l;e.innerHTML=a}},{key:"_setup",value:function(){var t=this;this.widgetWindow.onmaximize=function(){var e=t.widgetWindow.getWidgetBody().childNodes[0];e.style.width=t.widgetWindow._maximized?"100%":"39rem",e.style.height=t.widgetWindow._maximized?"calc(100vh - ".concat(97,"px)"):"".concat(docById("overlayCanvas").height-33-128-12,"px")},this._editor.style.width="39rem",this._editor.style.height="".concat(docById("overlayCanvas").height-33-128-12,"px"),this._editor.style.display="flex",this._editor.style.flexDirection="column";var e=document.createElement("div");e.style.width="100%",e.style.height="3rem",e.style.display="flex",e.style.flexDirection="row",e.style.justifyContent="space-between",e.style.background="#1e88e5",e.style.color="white";var o=document.createElement("div");function n(t,o,e){var n=2<arguments.length&&void 0!==e?e:"bottom",i=document.createElement("div"),s=document.createElement("div");return i.appendChild(s),document.body.appendChild(i),t.addEventListener("mouseover",function(){var e=t.getBoundingClientRect();s.style.position="absolute",s.style.visibility="visible",s.style.opacity="1",s.style.transition="opacity 0.2s ease-in-out",s.style.marginTop="-10px",s.style.background="#333",s.style.color="#fff",s.style.padding="0.5rem",s.style.borderRadius="10px",s.style.zIndex="99999",s.style.fontSize="1rem",s.style.whiteSpace="nowrap",s.textContent=o,s.style.top="".concat(e.bottom+window.scrollY+("bottom"!==n?-30:20),"px"),s.style.left="".concat(e.left+window.scrollX+("bottom"!==n?-135:0),"px")}),t.addEventListener("mouseout",function(){s.style.opacity="0",setTimeout(function(){s.style.visibility="hidden"},250)}),s}o.style.height="3rem",o.style.display="flex",o.style.flexDirection="row",o.style.justifyContent="end",o.style.alignItems="center";var i=document.createElement("span");i.id="js_editor_help_btn",i.classList.add("material-icons"),i.style.borderRadius="50%",i.style.padding=".25rem",i.style.marginLeft=".75rem",i.style.fontSize="2rem",i.style.background="#2196f3",i.style.cursor="pointer",i.innerHTML="help_outline",i.onclick=this._toggleHelp.bind(this),o.appendChild(i),n(i,_("Help"));var s=document.createElement("span");s.classList.add("material-icons"),s.style.borderRadius="50%",s.style.padding=".25rem",s.style.marginLeft=".75rem",s.style.fontSize="2rem",s.style.background="#2196f3",s.style.cursor="pointer",s.innerHTML="autorenew",s.onclick=this._generateCode.bind(this),o.appendChild(s),n(s,_("Reset Code"));var r=document.createElement("span");r.classList.add("material-icons"),r.style.borderRadius="50%",r.style.padding=".25rem",r.style.marginLeft=".75rem",r.style.fontSize="2rem",r.style.background="#2196f3",r.style.cursor="pointer",r.innerHTML="play_arrow",r.onclick=this._runCode.bind(this),o.appendChild(r),e.appendChild(o),n(r,_("Play"));var l=document.createElement("span");l.classList.add("material-icons"),l.style.borderRadius="50%",l.style.padding=".25rem",l.style.marginLeft=".75rem",l.style.fontSize="2rem",l.style.background="#2196f3",l.style.cursor="pointer",l.innerHTML="transform",l.onclick=this._codeToBlocks.bind(this),o.appendChild(l),e.appendChild(o),n(l,_("Convert JavaScript to Blocks"));var a=document.createElement("div");a.style.height="3rem",a.style.display="flex",a.style.flexDirection="row",a.style.justifyContent="end",a.style.alignItems="center";var d=document.createElement("span");d.classList.add("material-icons"),d.style.borderRadius="50%",d.style.padding=".25rem",d.style.marginRight=".75rem",d.style.fontSize="2rem",d.style.background="#2196f3",d.style.cursor="pointer",d.innerHTML="invert_colors",d.onclick=this._changeStyle.bind(this),a.appendChild(d),e.appendChild(a),n(d,_("Change theme"),"left"),this._editor.appendChild(e);var c=document.createElement("div");c.id="editor_container",c.style.width="100%",c.style.flex="2 1 auto",c.style.position="relative",c.style.background="#1e88e5",c.style.color="white";var y=document.createElement("div");y.id="editorLines",y.style.width="2rem",y.style.height="100%",y.style.position="absolute",y.style.top="0",y.style.left="0",y.style.zIndex="99",y.style.overflow="hidden",y.style.boxSizing="border-box",y.style.padding=".25rem .5rem",y.style.fontFamily='"PT Mono", monospace',y.style.fontSize="14px",y.style.fontWeight="400",y.style.letterSpacing="normal",y.style.lineHeight="20px",y.style.background="rgba(255, 255, 255, 0.075)",y.style.color="rgba(255, 255, 255, 0.7)",y.style.textAlign="right",c.appendChild(y);var u=document.createElement("div");u.id="debugButtons",u.style.width="1.5rem",u.style.height="100%",u.style.position="absolute",u.style.top="0",u.style.left="2rem",u.style.zIndex="98",u.style.overflow="hidden",u.style.boxSizing="border-box",u.style.padding=".25rem .25rem",u.style.fontFamily='"PT Mono", monospace',u.style.fontSize="12px",u.style.fontWeight="400",u.style.letterSpacing="normal",u.style.lineHeight="20px",u.style.background="rgba(255, 255, 255, 0.05)",u.style.color="rgba(255, 255, 255, 0.5)",u.style.textAlign="center",u.style.pointerEvents="none",c.appendChild(u);var h=document.createElement("div");h.classList.add("editor"),h.classList.add("language-javascript"),h.style.width="100%",h.style.height="100%",h.style.position="absolute",h.style.top="0",h.style.left="0",h.style.boxSizing="border-box",h.style.padding=".25rem .25rem .25rem 4.25rem",h.style.fontFamily='"PT Mono", monospace',h.style.fontSize="14px",h.style.fontWeight="400",h.style.letterSpacing="normal",h.style.lineHeight="20px",h.style.tabSize="4",h.style.cursor="text",c.appendChild(h),this._editor.appendChild(c);var p=document.createElement("div");p.id="editor_divider",p.style.width="100%",p.style.height="5px",p.style.cursor="row-resize",p.style.background="gray",p.style.position="relative",this._editor.appendChild(p);var g=document.createElement("div");g.id="console_label",g.style.width="100%",g.style.flex="0 0 auto",g.style.boxSizing="border-box",g.style.borderTop="1px solid gray",g.style.borderBottom="1px solid gray",g.style.padding=".25rem",g.style.fontFamily='"PT Mono", monospace',g.style.fontSize="14px",g.style.fontWeight="700",g.style.lineHeight="20px",g.style.color="indigo",g.style.background="white",g.style.display="flex",g.style.justifyContent="space-between",g.innerHTML="&nbsp;&nbsp;&nbsp;&nbsp;CONSOLE",this._editor.appendChild(g);var m=document.createElement("span");m.id="editor_console_btn",m.classList.add("material-icons"),m.style.padding=".25rem",m.style.fontSize="2rem",m.style.cursor="pointer",m.style.lineHeight="0.75rem",m.style.marginLeft="0",m.innerHTML="keyboard_arrow_down",m.onclick=this._toggleConsole.bind(this),g.appendChild(m),n(m,_("Toggle Console"),"left");var f=document.createElement("div");f.id="editorConsole",f.style.width="100%",f.style.flex="1 1 auto",f.style.overflow="auto",f.style.boxSizing="border-box",f.style.padding=".25rem",f.style.fontFamily='"PT Mono", monospace',f.style.fontSize="14px",f.style.fontWeight="400",f.style.lineHeight="20px",f.style.background="lightcyan",f.style.cursor="text",this._editor.appendChild(f);this._jar=new CodeJar(h,function(e){hljs.configure({languages:["javascript"]}),hljs.highlightElement(e),t._highlightErrors(e)}),this._generateCode(),this._jar.updateCode(this._code),this._jar.updateOptions({tab:" ".repeat(4),indentOn:/[(]$/,spellcheck:!1,addClosing:!0}),this._jar.onUpdate(function(e){t._showingHelp||(t._code=e),t._setLinesCount(t._code)}),this.widgetWindow.getWidgetBody().append(this._editor),this.widgetWindow.takeFocus(),this._setupDividerResize(p,c,f,g),(window.jsEditor=this)._setupScrollSync()}},{key:"_setupDividerResize",value:function(l,a,d,c){function t(e){var t,o,n,i,s,r;u&&(t=y._editor.getBoundingClientRect(),o=y._menubar?y._menubar.offsetHeight:0,n=y._editor.clientHeight-o,i=t.top+o,r=n-(s=e.clientY-i)-l.offsetHeight-c.offsetHeight,a.style.flexBasis="".concat(s,"px"),d.style.flexBasis="".concat(r,"px"))}function o(){u=!1,document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",o)}var y=this,u=!1;l.addEventListener("mousedown",function(e){u=!0,document.addEventListener("mousemove",t),document.addEventListener("mouseup",o),e.preventDefault()})}},{key:"_setupScrollSync",value:function(){var e=document.querySelector(".editor"),t=docById("editorLines"),o=docById("debugButtons");e&&t&&o&&e.addEventListener("scroll",function(){t.scrollTop=e.scrollTop,o.scrollTop=e.scrollTop})}},{key:"_runCode",value:function(){if(!this._showingHelp){a.clearConsole();try{acorn.parse(this._code,{ecmaVersion:2020})}catch(e){return void a.logConsole("Syntax Error: ".concat(e.message),"red")}try{MusicBlocks.init(!0),new Function(this._code)(),a.logConsole("Code executed successfully!","green")}catch(e){a.logConsole("Runtime Error: ".concat(e.message),"maroon"),e.stack&&a.logConsole("Stack trace: ".concat(e.stack),"maroon")}}}},{key:"_codeToBlocks",value:function(){a.clearConsole();try{var e=acorn.parse(this._code,{ecmaVersion:2020}),t=AST2BlockList.toBlockList(e,ast2blocklist_config),o=this.activity;o.stage.removeAllEventListeners("trashsignal"),o.stage.addEventListener("trashsignal",function(){o.blocks.loadNewBlocks(t),o.stage.removeAllEventListeners("trashsignal")},!1),o.sendAllToTrash(!1,!1,!1)}catch(e){a.logConsole("message"in e?e.message:e.prefix+this._code.substring(e.start,e.end),"red")}}},{key:"_generateCode",value:function(){JSGenerate.run(!0),this._code=JSGenerate.code,this._jar.updateCode(this._code),this._setLinesCount(this._code);var e=docById("js_editor_help_btn");e&&(e.style.color="white"),this._showingHelp=!1}},{key:"_setLinesCount",value:function(e){if(docById("editorLines")){for(var t=e.replace(/\n+$/,"\n").split("\n").length,o="",n=1;n<t;n++)o+="".concat(n,"\n");docById("editorLines").innerText=o,this._updateDebugButtons(e)}}},{key:"_updateDebugButtons",value:function(e){if(docById("debugButtons")){for(var t=e.replace(/\n+$/,"\n").split("\n"),o="",n=0;n<t.length;n++){var i=n,s=t[n].trim(),r="debugger;"===s||s.includes("debugger;");o+=""===s?"<div style='height: 20px; line-height: 20px;'>&nbsp;</div>":r?'<div style="height: 20px; line-height: 20px; cursor: pointer; opacity: 1; pointer-events: auto; border-radius: 4px;"                     onclick="window.jsEditor._removeDebuggerFromLine('.concat(i,')"                     title="Remove debugger from line ').concat(i+1,'">ðŸ”´</div>'):'<div style="height: 20px; line-height: 20px; cursor: pointer; opacity: 0; transition: opacity 0.2s ease-in-out; pointer-events: auto;"                     onmouseenter="this.style.opacity=\'1\'"                     onmouseleave="this.style.opacity=\'0\'"                    onclick="window.jsEditor._addDebuggerToLine('.concat(i,')"                     title="Add breakpoint to line ').concat(i+1,'">ðŸ”´</div>')}docById("debugButtons").innerHTML=o}}},{key:"_addDebuggerToLine",value:function(e){var t,o,n,i,s=this._code.split("\n"),r=e-1,l=s[r].trim();l.endsWith("{")||l.endsWith(";")?s[r]&&"debugger;"===s[r].trim()||s[1+r]&&"debugger;"===s[1+r].trim()?a.logConsole("Cannot add breakpoint to line ".concat(e+1," because there is already a breakpoint on an adjacent line."),"red"):(o=t="",0<=r&&s[r]?((n=s[r].match(/^(\s*)/))&&(t=n[1]),s[r].trim().endsWith("{")&&(o="\t")):0<s.length&&((i=s[0].match(/^(\s*)/))&&(t=i[1])),s.splice(1+r,0,t+o+"debugger;"),this._code=s.join("\n"),this._jar.updateCode(this._code),this._setLinesCount(this._code),a.logConsole("Debugger added to line ".concat(e+1),"green")):a.logConsole("Cannot add breakpoint to line ".concat(e+1,". Breakpoints can only be added after lines ending with '{' or ';'"),"red")}},{key:"_removeDebuggerFromLine",value:function(e){var t=this._code.split("\n");"debugger;"===t[e].trim()&&t.splice(e,1),this._code=t.join("\n"),this._jar.updateCode(this._code),this._setLinesCount(this._code),a.logConsole("Debugger removed from line ".concat(e+1),"orange")}},{key:"_toggleHelp",value:function(){this._showingHelp=!this._showingHelp;var e=docById("js_editor_help_btn");this._showingHelp?(e.style.color="gold",this._codeBck=this._code,this._jar.updateCode(JS_API),this._setLinesCount(JS_API)):(e.style.color="white",this._jar.updateCode(this._codeBck),this._setLinesCount(this._codeBck),this._code=this._codeBck)}},{key:"_changeStyle",value:function(e){e.preventDefault(),this._styles[this._currentStyle].setAttribute("disabled","true"),this._currentStyle=(this._currentStyle+1)%this._styles.length,this._styles[this._currentStyle].removeAttribute("disabled");var t=docById("editorLines");switch(this._styles[this._currentStyle].href.split("/").pop().split(".")[0]){case"dracula":t.style.color="#ffffff",t.style.background="#5a5a5a";break;case"github":t.style.color="#000000",t.style.background="#eaeaea";break;case"railscasts":t.style.color="#ffffff",t.style.background="#2b2b2b";break;case"vs":t.style.color="#000000",t.style.background="#f2f2f2";break;default:t.style.color="#ffffff",t.style.background="#000000"}}},{key:"_toggleConsole",value:function(){var e=docById("editorConsole"),t=docById("editor_console_btn");this.isOpen?(this.isOpen=!1,e.style.display="none",t&&(t.innerHTML="keyboard_arrow_up")):(this.isOpen=!0,e.style.display="block",t&&(t.innerHTML="keyboard_arrow_down"))}},{key:"_triggerStatusWindow",value:function(){window.widgetWindows.isOpen("status")?a.logConsole("Status window is already open.","blue"):(null===this.activity.logo.statusMatrix&&(this.activity.logo.statusMatrix=new StatusMatrix),this.activity.logo.statusMatrix.init(this.activity),this.activity.logo.inStatusMatrix=!0,a.logConsole("Status window opened.","green"))}}],[{key:"logConsole",value:function(e,t){void 0===t&&(t="midnightblue"),docById("editorConsole")&&(""!==docById("editorConsole").innerHTML&&(docById("editorConsole").innerHTML+="</br>"),docById("editorConsole").innerHTML+='<span style="color: '.concat(t,'">').concat(e,"</span>")),console.log("%c"+e,"color: ".concat(t))}},{key:"clearConsole",value:function(){docById("editorConsole")&&(docById("editorConsole").innerHTML="")}}]),a}();