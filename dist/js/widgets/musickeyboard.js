"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function ownKeys(e,t){var i,o=Object.keys(e);return Object.getOwnPropertySymbols&&(i=Object.getOwnPropertySymbols(e),t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),o.push.apply(o,i)),o}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(i),!0).forEach(function(t){_defineProperty(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ownKeys(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function _defineProperty(t,e,i){return(e=_toPropertyKey(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(t,e){if("object"!=_typeof(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0===i)return("string"===e?String:Number)(t);var o=i.call(t,e||"default");if("object"!=_typeof(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_unsupportedIterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t))return _arrayLikeToArray(t)}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,o=Array(e);i<e;i++)o[i]=t[i];return o}function _iterableToArrayLimit(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var o,l,n,a,s=[],r=!0,c=!1;try{if(n=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;r=!1}else for(;!(r=(o=n.call(i)).done)&&(s.push(o.value),s.length!==e);r=!0);}catch(t){c=!0,l=t}finally{try{if(!r&&null!=i.return&&(a=i.return(),Object(a)!==a))return}finally{if(c)throw l}}return s}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function MusicKeyboard(C){var p=this,k=1e5,u=32,v=[81,87,69,82,84,89,85,73,79,80],b=[49,50,51,52,53,54,55,56,57,48],g=[65,83,68,70,71,72,74,75,76],a=document.onkeydown,s=document.onkeyup,f=window.innerWidth;this.activity=C,this._cellScale=f/1200;var I=localStorage.beginnerMode,W="true"===I?8:16;this._stopOrCloseClicked=!1,this.playingNow=!1,this.instruments=[],this.noteNames=[],this.octaves=[],this.keyboardShown=!0,this.layout=[],this.idContainer=[],this.tick=!1,this.metronomeInterval=!1,this.meterArgs=[4,.25],this.noteMapper={},this.blockNumberMapper={},this.instrumentMapper={},this.firstNote=!1;var x=[],c=null;function w(t){for(var e=[],i=[],o=[],l=null,n=1+k,a=0;a<t.length;a++)if("drum"===t[a].noteName)o.push(t[a]);else{if("hertz"!==t[a].noteName){l=[t[0].noteName,t[0].noteOctave];break}i.push(t[a])}if(null===l)return t;l[0]=convertFromSolfege(l[0]);var s=0;if("C"!==l[0])for(var r=0;r<PITCHES2.length&&(e.push({noteName:PITCHES2[r],noteOctave:l[1],blockNumber:t[0].blockNumber,voice:t[0].voice}),s=r,PITCHES2[r]!==l[0])&&PITCHES[r]!==l[0];r++)e[r].blockNumber=n,n+=1;else e.push({noteName:l[0],noteOctave:l[1],blockNumber:t[0].blockNumber,voice:t[0].voice});for(var c,h,d=l[1],u=1;u<t.length;u++)if("drum"===t[u].noteName)o.push(t[u]);else if("hertz"===t[u].noteName)i.push(t[u]);else{c=(l=[t[u].noteName,t[u].noteOctave])[1],h=t[u].voice,l[0]=convertFromSolfege(l[0]);var y=PITCHES.indexOf(l[0]);if(-1===y&&(y=PITCHES2.indexOf(l[0])),d<c&&(y+=12),y!==(s+1)%12)for(var m=(s%=12)+1;m<y;m++)m%12==0&&(d+=1),e.push({noteName:PITCHES2[m%12],noteOctave:d,blockNumber:n,voice:h}),n+=1;e.push({noteName:l[0],noteOctave:l[1],blockNumber:t[u].blockNumber,voice:t[u].voice}),d=c,s=y}if("C"!==l[0]){var p=PITCHES.indexOf(l[0]);-1===p&&(p=PITCHES2.indexOf(l[0]));for(var v=(p+1)%12;v<PITCHES2.length&&0!==v;v++)e.push({noteName:PITCHES2[v],noteOctave:l[1],blockNumber:n,voice:h}),n+=1;l[1]+=1,e.push({noteName:"C",noteOctave:l[1],blockNumber:n,voice:h}),n+=1}for(var b=0;b<i.length;b++)e.push(i[b]);for(var g=0;g<o.length;g++)e.push(o[g]);return e}this._rowBlocks=[],this._notesPlayed=[],this.addRowBlock=function(t){for(;p._rowBlocks.includes(t);)t+=1e6;p._rowBlocks.push(t)},this.processSelected=function(){if(0!==p._notesPlayed.length){p._notesPlayed.sort(function(t,e){return t.startTime-e.startTime}),x=[{noteOctave:[p._notesPlayed[0].noteOctave],objId:[p._notesPlayed[0].objId],duration:[p._notesPlayed[0].duration],voice:[p._notesPlayed[0].voice],blockNumber:[p._notesPlayed[0].blockNumber],startTime:p._notesPlayed[0].startTime}];for(var t=0,e=1;e<p._notesPlayed.length;e++){for(;e<p._notesPlayed.length&&p._notesPlayed[e].startTime===p._notesPlayed[e-1].startTime;)x[t].noteOctave.push(p._notesPlayed[e].noteOctave),x[t].objId.push(p._notesPlayed[e].objId),x[t].duration.push(p._notesPlayed[e].duration),x[t].voice.push(p._notesPlayed[e].voice),x[t].blockNumber.push(p._notesPlayed[e].blockNumber),e++;t++,e<p._notesPlayed.length&&x.push({noteOctave:[p._notesPlayed[e].noteOctave],objId:[p._notesPlayed[e].objId],duration:[p._notesPlayed[e].duration],voice:[p._notesPlayed[e].voice],blockNumber:[p._notesPlayed[e].blockNumber],startTime:p._notesPlayed[e].startTime})}}else x=[]},this.addKeyboardShortcuts=function(){function a(t){var e,i=t.keyCode;if(g.includes(i))e="whiteRow".concat(g.indexOf(i));else if(v.includes(i)){var o=v.indexOf(i);if([2,6,9,13,16,20].includes(o))return null;e="blackRow".concat(o)}else b.includes(i)?e="hertzRow".concat(b.indexOf(i)):32===i&&(e="rest");return e}var s,r=this,c={},h={},d={},u=new Set,y={},m=0,p=0;document.onkeydown=function(t){u.has(t.keyCode)||(function(t){var e,i=a(t),o=docById(i);if(i in c||(c[i]=(new Date).getTime()),null!=o){if(o.style.backgroundColor=platformColor.orange,h[i]=o.getAttribute("alt").split("__")[0],"hertz"===h[i]?d[i]=parseInt(o.getAttribute("alt").split("__")[1]):h[i]in FIXEDSOLFEGE1?d[i]=FIXEDSOLFEGE1[h[i]].replace(SHARP,"#").replace(FLAT,"b")+o.getAttribute("alt").split("__")[1]:d[i]=h[i].replace(SHARP,"#").replace(FLAT,"b")+o.getAttribute("alt").split("__")[1],"rest"==i)return;0===Object.keys(y).length?(y[i]=d[i],p=Math.floor(c[i]/100)):p===Math.floor(c[i]/100)?(y[i]=d[i],m++):(m=0,y={}),r.activity.logo.synth.trigger(0,d[i],1,r.instrumentMapper[i],null,null),r.tick&&void 0!==r.endTime&&r.firstNote&&(e=(c[i]-r.endTime)/1e3,e/=60,e*=r.bpm,e*=r.meterArgs[1],.06<(e=parseFloat((Math.round(e*W)/W).toFixed(4)))&&0===u.size&&r._notesPlayed.push({startTime:r.endTime,noteOctave:"R",objId:null,duration:parseFloat(e)})),r.firstNote=!0}}(t),u.add(t.keyCode))},document.onkeyup=function(t){var l,e,i,o,n;u.delete(t.keyCode),i=a(t),o=docById(i),n=(new Date).getTime(),s=(n-c[i])/1e3,null!=o&&(i.includes("blackRow")?o.style.backgroundColor="black":o.style.backgroundColor="white",l=s/60,l*=r.bpm,l*=r.meterArgs[1],(l=parseFloat((Math.round(l*W)/W).toFixed(4)))<=0&&(l=1/W),"rest"==i?r._notesPlayed.push({startTime:c[i],noteOctave:"R",objId:null,duration:parseFloat(l)}):(r.activity.logo.synth.stopSound(0,r.instrumentMapper[i],d[i]),i in y?Object.entries(y).forEach(function(t){var e=_slicedToArray(t,2),i=e[0],o=e[1];r._notesPlayed.push({startTime:100*p,noteOctave:o,objId:i,duration:l,voice:r.instrumentMapper[i],blockNumber:r.blockNumberMapper[i]}),delete y[i]}):0<m?m--:(r._notesPlayed.push({startTime:c[i],noteOctave:d[i],objId:i,duration:l,voice:r.instrumentMapper[i],blockNumber:r.blockNumberMapper[i]}),y={})),r._createTable(),r.widgetWindow._maximized?(r.widgetWindow.getWidgetBody().style.position="absolute",r.widgetWindow.getWidgetBody().style.height="calc(100vh - 64px)",r.widgetWindow.getWidgetBody().style.width="200vh",docById("mkbOuterDiv").style.maxHeight="725px",docById("mkbOuterDiv").style.height="calc(100vh - 64px)",docById("mkbOuterDiv").style.width="calc(200vh - 64px)",docById("keyboardHolder2").style.width="calc(200vh - 64px)",docById("mkbInnerDiv").style.width="95.5vw",docById("mkbInnerDiv").style.height="75%",(e=docById("mkbInnerDiv")).scrollLeft=e.scrollWidth,r.widgetWindow.getWidgetBody().style.left="60px"):(docById("mkbOuterDiv").style.maxHeight="400px",r.widgetWindow.getWidgetBody().style.position="relative",r.widgetWindow.getWidgetBody().style.left="0px",r.widgetWindow.getWidgetBody().style.height="550px",r.widgetWindow.getWidgetBody().style.width="1000px",docById("mkbOuterDiv").style.width=f+"px",docById("mkbInnerDiv").style.height="100%"),r.endTime=n,p=0,delete c[i],delete h[i],delete d[i])}},this.loadHandler=function(e,t,i){var o=this,l=this.displayLayout[t].noteName,n="hertz"===l?this.displayLayout[t].noteOctave:l in FIXEDSOLFEGE1?FIXEDSOLFEGE1[l].replace(SHARP,"#").replace(FLAT,"b")+this.displayLayout[t].noteOctave:l.replace(SHARP,"#").replace(FLAT,"b")+this.displayLayout[t].noteOctave;this.blockNumberMapper[e.id]=i,this.instrumentMapper[e.id]=this.displayLayout[t].voice,this.noteMapper[e.id]=n;var a=0,s=new Date,r=0;e.onmousedown=function(){var t;c=e,t=this,s=new Date,r=s.getTime(),t.style.backgroundColor=platformColor.orange,o.activity.logo.synth.trigger(0,o.noteMapper[t.id],1,o.instrumentMapper[t.id],null,null)};e.onmouseup=function(){c=(c===e?function(t){t.id.includes("blackRow")?t.style.backgroundColor="black":t.style.backgroundColor="white";var e=new Date;a=e.getTime()-r,a/=1e3,o.activity.logo.synth.stopSound(0,o.instrumentMapper[t.id],o.noteMapper[t.id]),0===(a="true"===I?parseFloat((Math.round(8*a)/8).toFixed(3)):parseFloat((Math.round(16*a)/16).toFixed(4)))?a=.125:a<0&&(a=-a),o._notesPlayed.push({startTime:r,noteOctave:o.noteMapper[t.id],objId:t.id,duration:a,voice:o.instrumentMapper[t.id],blockNumber:o.blockNumberMapper[t.id]}),o._createTable(),o.widgetWindow._maximized?(o.widgetWindow.getWidgetBody().style.position="absolute",o.widgetWindow.getWidgetBody().style.height="calc(100vh - 64px)",o.widgetWindow.getWidgetBody().style.width="200vh",docById("mkbOuterDiv").style.maxHeight="725px",docById("mkbOuterDiv").style.height="calc(100vh - 64px)",docById("mkbOuterDiv").style.width="calc(200vh - 64px)",docById("keyboardHolder2").style.width="calc(200vh - 64px)",docById("mkbInnerDiv").style.width="95.5vw",docById("mkbInnerDiv").style.height="75%",o.widgetWindow.getWidgetBody().style.left="60px"):(docById("mkbOuterDiv").style.maxHeight="400px",o.widgetWindow.getWidgetBody().style.position="relative",o.widgetWindow.getWidgetBody().style.left="0px",o.widgetWindow.getWidgetBody().style.height="550px",o.widgetWindow.getWidgetBody().style.width="1000px",docById("mkbOuterDiv").style.width=f+"px",docById("mkbInnerDiv").style.height="100%")}(this):c.id.includes("blackRow")?c.style.backgroundColor="black":c.style.backgroundColor="white",null)}},this.init=function(){var l=this;this.tick=!1,this.playingNow=!1;var t=window.innerWidth;this._cellScale=t/1200;var e=window.widgetWindows.windowFor(this,"music keyboard");(this.widgetWindow=e).clear(),e.show(),this.displayLayout=this._keysLayout();var i=this.activity.turtles.ithTurtle(0);this.bpm=0<i.singer.bpm.length?last(i.singer.bpm):Singer.masterBPM,this.widgetWindow.onmaximize=function(){e._maximized?(e.getWidgetBody().style.position="absolute",e.getWidgetBody().style.height="calc(100vh - 64px)",e.getWidgetBody().style.width="200vh",docById("keyboardHolder2").style.width="calc(200vh - 64px)",docById("mkbOuterDiv").style.maxHeight="725px",docById("mkbOuterDiv").style.height="calc(100vh - 64px)",docById("mkbOuterDiv").style.width="calc(200vh - 64px)",e.getWidgetBody().style.left="60px",docById("mkbInnerDiv").style.height="75%"):(docById("mkbOuterDiv").style.maxHeight="400px",e.getWidgetBody().style.position="relative",e.getWidgetBody().style.left="0px",e.getWidgetBody().style.height="550px",e.getWidgetBody().style.width="1000px",docById("mkbOuterDiv").style.width=t+"px",docById("mkbInnerDiv").style.height="100%")},e.onclose=function(){var t;document.onkeydown=a,document.onkeyup=s,document.getElementById("keyboardHolder2")&&(document.getElementById("keyboardHolder2").style.display="none"),null!=(t=document.getElementById("myrow"))&&(t.innerHTML=""),null!=(t=document.getElementById("myrow2"))&&(t.innerHTML=""),l.tick=!1,l.firstNote=!1,l.metronomeON=!1,x=[],l.loopTick&&l.loopTick.stop(),docById("wheelDivptm").style.display="none",docById("wheelDivptm").style.display="none",l._menuWheel&&l._menuWheel.removeWheel(),l._pitchWheel&&l._pitchWheel.removeWheel(),l._tabsWheel&&l._tabsWheel.removeWheel(),l._exitWheel&&l._exitWheel.removeWheel(),l._durationWheel&&l._durationWheel.removeWheel(),l._accidentalsWheel&&l._accidentalsWheel.removeWheel(),l._octavesWheel&&l._octavesWheel.removeWheel(),e.destroy()},this.playButton=e.addButton("play-button.svg",u,_("Play")),this.playButton.onclick=function(){(l.metronomeInterval||l.metronomeON)&&l.stopMetronome(),l.activity.logo.turtleDelay=0,l.processSelected(),l.playAll()},e.addButton("export-chunk.svg",u,_("Save")).onclick=function(){l._save()},e.addButton("erase-button.svg",u,_("Clear")).onclick=function(){l._notesPlayed=[],x=[],l._createTable(),e._maximized?(docById("mkbOuterDiv").style.maxHeight="725px",docById("mkbOuterDiv").style.height="calc(100vh - 64px)",docById("mkbOuterDiv").style.width="calc(200vh - 64px)",docById("mkbInnerDiv").style.height="75%",e.getWidgetBody().style.left="60px"):(docById("mkbOuterDiv").style.maxHeight="400px",e.getWidgetBody().style.position="relative",e.getWidgetBody().style.left="0px",e.getWidgetBody().style.height="550px",e.getWidgetBody().style.width="1000px",docById("mkbOuterDiv").style.width=t+"px",docById("mkbInnerDiv").style.height="100%")};var o=e.addButton("add2.svg",u,_("Add note"));o.setAttribute("id","addnotes"),o.onclick=function(){l._createAddRowPieSubmenu()},this.midiButton=e.addButton("midi.svg",u,_("MIDI")),this.midiButton.onclick=function(){l.doMIDI()},this.tickButton=e.addButton("metronome.svg",u,_("Metronome")),this.stopMetronome=function(){l.tickButton.style.removeProperty("background"),l.tick&&l.loopTick&&l.loopTick.stop(),l.tick=!1,l.firstNote=!1,l.metronomeON=!1;var t=docById("countdownContainer");t&&t.remove(),l.metronomeInterval&&(clearInterval(l.metronomeInterval),l.metronomeInterval=null)},this.tickButton.onclick=function(){var t,e,i,o;l.metronomeInterval||l.metronomeON?l.stopMetronome():(l.metronomeON=!0,l.tickButton.style.background=platformColor.orange,t=document.getElementsByClassName("wfbWidget")[0],(e=document.createElement("div")).id="countdownContainer",(i=document.createElement("div")).id="countdownDisplay",i.textContent="3",e.appendChild(i),t.appendChild(e),o=3,l.metronomeInterval=setInterval(function(){0===--o?(clearInterval(l.metronomeInterval),l.metronomeInterval=null,e.remove(),l.metronomeON&&(l.tick=!0,l.activity.logo.synth.loadSynth(0,"cow bell"),l.loopTick=l.activity.logo.synth.loop(0,"cow bell","C5",1/64,0,l.bpm||90,.07))):i.textContent=o},1e3),l.metronomeON&&l.activity.logo.synth.start())},this.keyboardDiv=document.createElement("div");var n=document.createAttribute("id");n.value="mkbKeyboardDiv",this.keyboardDiv.setAttributeNode(n),this.keyTable=document.createElement("div"),e.getWidgetBody().append(this.keyboardDiv),e.getWidgetBody().append(this.keyTable),e.getWidgetBody().style.height="550px",e.getWidgetBody().style.width="1000px",this._createKeyboard(),this._createTable(),t=Math.max(Math.min(window.innerWidth,758*this._cellScale-20),535),e.sendToCenter()},this.playAll=function(){var e=this;if(!(x.length<=0)){this.playingNow=!this.playingNow;var t=this.playButton;if(this.playingNow){if(t.innerHTML='&nbsp;&nbsp;<img src="header-icons/stop-button.svg" title="'+_("Stop")+'" alt="'+_("Stop")+'" height="'+u+'" width="'+u+'" vertical-align="middle" align-content="center">&nbsp;&nbsp;',x.length<1)return;for(var i,o,l,n=[],a=0;a<x[0].noteOctave.length;a++)this.keyboardShown&&null!==x[0].objId[0]&&null!==(i=docById(x[0].objId[a]))&&(i.style.backgroundColor="lightgrey"),"string"==typeof(l=o=x[0].noteOctave[a])&&(l=o.replace(SHARP,"#").replace(FLAT,"b")),n.push(l);this.keyboardShown||(docById("cells-0").style.backgroundColor=platformColor.selectorBackground),this._stopOrCloseClicked=!1;var s=x[0].duration.map(function(t){return 60*t*4/e.bpm});this._playChord(n,s,x[0].voice);var r=Math.max.apply(Math,_toConsumableArray(s));this.playOne(1,r,t)}else this.keyboardShown?this._createKeyboard():this._createTable(),this._stopOrCloseClicked=!0,t.innerHTML='&nbsp;&nbsp;<img \n                    src="header-icons/play-button.svg" \n                    title="'.concat(_("Play"),'" \n                    alt="').concat(_("Play"),'" \n                    height="').concat(u,'" \n                    width="').concat(u,'" \n                    vertical-align="middle" \n                    align-content="center"\n                >&nbsp;&nbsp;')}},this.playOne=function(c,t,h){var d=this;setTimeout(function(){var t,e,i,o,l,n;if(c<x.length){if(d._stopOrCloseClicked)return;if(d.keyboardShown||(docById("cells-"+c).style.backgroundColor=platformColor.selectorBackground),d.keyboardShown&&null!==x[c-1].objId[0])for(var a=0;a<x[c-1].noteOctave.length;a++)t=x[c-1].objId[a],e=docById(t),t.includes("blackRow")?e.style.backgroundColor="black":e.style.backgroundColor="white";i=[];for(var s,r=0;r<x[c].noteOctave.length;r++)d.keyboardShown&&null!==x[c].objId[0]&&null!==(e=docById(x[c].objId[r]))&&(e.style.backgroundColor="lightgrey"),"string"==typeof(l=o=x[c].noteOctave[r])&&(l=o.replace(SHARP,"#").replace(FLAT,"b")),i.push(l);d.playingNow&&(s=x[c].duration.map(function(t){return 60*t*4/d.bpm}),d._playChord(i,s,x[c].voice)),n=Math.max.apply(Math,_toConsumableArray(x[c].duration.map(function(t){return 60*t*4/d.bpm}))),d.playOne(c+1,n,h)}else h.innerHTML='&nbsp;&nbsp;<img \n                        src="header-icons/play-button.svg" \n                        title="'.concat(_("Play"),'" \n                        alt="').concat(_("Play"),'" \n                        height="').concat(u,'" \n                        width="').concat(u,'" \n                        vertical-align="middle" \n                        align-content="center"\n                    >&nbsp;&nbsp;'),d.playingNow=!1,d.keyboardShown?d._createKeyboard():d._createTable()},1e3*t)},this._playChord=function(t,e,i){"R"!==t[0]&&(setTimeout(function(){p.activity.logo.synth.trigger(0,t[0],e[0],i[0],null,null)},1),1<t.length&&setTimeout(function(){p.activity.logo.synth.trigger(0,t[1],e[0],i[1],null,null)},1),2<t.length&&setTimeout(function(){p.activity.logo.synth.trigger(0,t[2],e[0],i[2],null,null)},1),3<t.length&&setTimeout(function(){p.activity.logo.synth.trigger(0,t[3],e[0],i[3],null,null)},1))},this._keysLayout=function(){var e=this;this.layout=[];for(var t=[],i=0;i<this.noteNames.length;i++)"drum"===this.noteNames[i]?t.push({frequency:1e6+t.length,noteName:this.noteNames[i],noteOctave:this.octaves[i],blockNumber:this._rowBlocks[i],voice:this.instruments[i]}):"hertz"===this.noteNames[i]?t.push({frequency:this.octaves[i],noteName:this.noteNames[i],noteOctave:this.octaves[i],blockNumber:this._rowBlocks[i],voice:this.instruments[i]}):t.push({frequency:noteToFrequency(this.noteNames[i]+this.octaves[i],this.activity.turtles.ithTurtle(0).singer.keySignature),noteName:this.noteNames[i],noteOctave:this.octaves[i],blockNumber:this._rowBlocks[i],voice:this.instruments[i]});var o=t.sort(function(t,e){return t.frequency-e.frequency}),l=[];this.remove=[],o=o.filter(function(t){return!l.includes(t.noteName+t.noteOctave)||"drum"===t.noteName?(l.push(t.noteName+t.noteOctave),!0):(e.remove.push(t.blockNumber),!1)});for(var n=0;n<this.remove.length;n++)!function(t,e){setTimeout(function(){t._removePitchBlock(t.remove[e])},200)}(this,n);for(var a=o.filter(function(t){return"hertz"===t.noteName}),s=o.filter(function(t){return"hertz"!==t.noteName}),o=s.concat(a),r=(r=w(s)).concat(a),c=0;c<r.length;c++)this.layout.push({noteName:r[c].noteName,noteOctave:r[c].noteOctave,blockNumber:r[c].blockNumber,voice:r[c].voice});return r},this._setNotes=function(t,e){var i=docById("cells-"+t).getAttribute("start");this._notesPlayed=this._notesPlayed.filter(function(t){return t.startTime!=parseInt(i)});for(var o,l=!0,n=0;n<this.layout.length;n++)"black"===docById("mkb"+n).cells[t].style.backgroundColor&&(this._setNoteCell(n,t,i,e),l=!1);l&&(o=docById("cells-"+t).getAttribute("dur"),this._notesPlayed.push({startTime:parseInt(i),noteOctave:"R",objId:null,duration:parseFloat(o)}),this._notesPlayed.sort(function(t,e){return t.startTime-e.startTime}))},this._setNoteCell=function(t,e,i,o){var l=this.layout.length,n=this.layout[l-t-1].noteName,a="hertz"===n?this.layout[l-t-1].noteOctave:"drum"===n?"c2":n in FIXEDSOLFEGE1?FIXEDSOLFEGE1[n].replace(SHARP,"#").replace(FLAT,"b")+this.layout[l-t-1].noteOctave:n.replace(SHARP,"#").replace(FLAT,"b")+this.layout[l-t-1].noteOctave,s=docById(t+":"+e);this._notesPlayed.push({startTime:parseInt(i),noteOctave:a,blockNumber:this.layout[l-t-1].blockNumber,duration:parseFloat(s.getAttribute("alt")),objId:this.displayLayout[l-t-1].objId,voice:this.displayLayout[l-t-1].voice}),this._notesPlayed.sort(function(t,e){return t.startTime-e.startTime}),o&&this.activity.logo.synth.trigger(0,a,s.getAttribute("alt"),this.instruments[0],null,null)},this.makeClickable=function(){for(var o,e,l,n=this,t=docById("mkbNoteDurationRow"),i=0;i<x.length;i++)(o=t.cells[i]).onclick=function(t){o=t.target,n._createpiesubmenu(o.getAttribute("id"),o.getAttribute("start"),o.getAttribute("dur"))};for(var a=0;a<this.layout.length;a++){e=docById("mkb"+a);for(var s=0;s<e.cells.length;s++)!function(t){(o=e.cells[t]).setAttribute("id",a+":"+t),l=!1,o.onmousedown=function(t){o=t.target,l=!0;var e=o.id.split(":"),i=Number(e[1]);"black"===o.style.backgroundColor?(o.style.backgroundColor=o.getAttribute("cellColor"),n._setNotes(i,!1)):(o.style.backgroundColor="black",n._setNotes(i,!0))},o.onmouseover=function(){l&&("black"===o.style.backgroundColor?(o.style.backgroundColor=o.getAttribute("cellColor"),n._setNotes(t,!1)):(o.style.backgroundColor="black",n._setNotes(t,!0)))},o.onmouseup=function(){l=!1}}(s)}},this._noteWidth=function(t){return Math.max(Math.floor(EIGHTHNOTEWIDTH*(8*t)*this._cellScale),15)},this._createTable=function(){var o=this;this.processSelected();var t=this.keyTable;t.style.display="inline",t.style.visibility="visible",t.style.border="0px",t.style.width="700px",t.innerHTML="",t.innerHTML='<div id="mkbOuterDiv"><div id="mkbInnerDiv"><table cellpadding="0px" id="mkbTable"></table></div></div>';var e=Math.max(Math.floor(.5*window.innerHeight/100),8),i=docById("mkbOuterDiv");i.style.overflowY="hidden",this.displayLayout.length>e?i.style.height=this._cellScale*MATRIXSOLFEHEIGHT*(e+5)+"px":i.style.height=this._cellScale*MATRIXSOLFEHEIGHT*(this.displayLayout.length+4)+"px",i.style.backgroundColor="white",i.style.marginTop="15px",docById("mkbInnerDiv").style.marginLeft=0;var l=docById("mkbTable");if(x.length<1)i.innerHTML="";else{for(var n,a,s=0,e=this.displayLayout.length,r=this.displayLayout.length-1;0<=r;r--){var c=l.insertRow();(n=c.insertCell()).style.backgroundColor=platformColor.graphicsLabelBackground,n.style.fontSize=100*this._cellScale+"%",n.style.height=Math.floor(MATRIXSOLFEHEIGHT*this._cellScale)+1+"px",n.style.width=1.5*Math.floor(MATRIXSOLFEWIDTH*this._cellScale)+"px",n.style.minWidth=1.5*Math.floor(MATRIXSOLFEWIDTH*this._cellScale)+"px",n.style.maxWidth=n.style.minWidth,n.style.position="sticky",n.style.left="0px",n.className="headcol","drum"===this.displayLayout[r].noteName?n.innerHTML=this.displayLayout[r].voice:"hertz"===this.displayLayout[r].noteName?n.innerHTML=this.displayLayout[r].noteOctave.toString()+"HZ":n.innerHTML="".concat(i18nSolfege(this.displayLayout[r].noteName),"<sub>").concat(this.displayLayout[r].noteOctave.toString(),"</sub>"),n.setAttribute("id","labelcol"+(e-r-1)),"hertz"===this.displayLayout[r].noteName?n.setAttribute("alt",e-r-1+"__synthsblocks"):n.setAttribute("alt",e-r-1+"__pitchblocks"),n.onclick=function(t){null===(n=t.target).getAttribute("alt")&&(n=n.parentNode);var e=n.getAttribute("alt").split("__")[0],i=n.getAttribute("alt").split("__")[1];o._createColumnPieSubmenu(e,i)},c.insertCell().innerHTML='<table cellpadding="0px" id="mkbCellTable'.concat(s,'"></table>'),(a=docById("mkbCellTable"+s)).style.marginTop="-1px",a.insertRow().setAttribute("id","mkb"+s),s+=1}(c=l.insertRow()).style.position="sticky",c.style.bottom="0px",(n=c.insertCell()).style.backgroundColor=platformColor.graphicsLabelBackground,n.style.fontSize=100*this._cellScale+"%",n.style.height=Math.floor(MATRIXSOLFEHEIGHT*this._cellScale)+1+"px",n.style.width=1.5*Math.floor(MATRIXSOLFEWIDTH*this._cellScale)+"px",n.style.minWidth=1.5*Math.floor(MATRIXSOLFEWIDTH*this._cellScale)+"px",n.style.maxWidth=n.style.minWidth,n.className="headcol",n.innerHTML=_("Note value"),n.style.position="sticky",n.style.left="0px",n.style.zIndex="1",c.insertCell().innerHTML='<table  class="mkbTable" cellpadding="0px"><tr id="mkbNoteDurationRow"></tr></table>';for(var h,d,u,y,m,p="lightgrey",v=0;v<x.length;v++){h=Math.max.apply(Math,x[v].duration),d=2*this._noteWidth(Math.max.apply(Math,x[v].duration))+"px",e=this.displayLayout.length;for(var b=0;b<this.displayLayout.length;b++)u=docById("mkb"+b),(n=u.insertCell()).style.height=Math.floor(MATRIXSOLFEHEIGHT*this._cellScale)+1+"px",n.style.width=d,n.style.minWidth=n.style.width,n.style.maxWidth=n.style.width,x[v].blockNumber.includes(this.displayLayout[e-b-1].blockNumber)?(y=x[v].blockNumber.indexOf(this.displayLayout[e-b-1].blockNumber),n.setAttribute("alt",x[v].duration[y]),n.style.backgroundColor="black"):(n.setAttribute("alt",h),n.style.backgroundColor=p),n.style.border="2px solid white",n.style.borderRadius="10px",n.setAttribute("cellColor",p);m=toFraction(Math.max.apply(Math,x[v].duration)),u=docById("mkbNoteDurationRow"),(n=u.insertCell()).style.height=Math.floor(MATRIXSOLFEHEIGHT*this._cellScale)+1+"px",n.style.width=d,n.style.minWidth=n.style.width,n.style.maxWidth=n.style.width,n.style.lineHeight="60%",n.style.textAlign="center",n.innerHTML="".concat(m[0].toString(),"/").concat(m[1].toString()),n.setAttribute("id","cells-"+v),n.setAttribute("start",x[v].startTime),n.setAttribute("dur",h),n.style.backgroundColor=platformColor.rhythmcellcolor,n.style.color=platformColor.textColor}var g=docById("mkbInnerDiv");g.scrollLeft=g.scrollWidth,this.makeClickable()}},this._createpiesubmenu=function(t,i){var o=this;docById("wheelDivptm").style.display="",this._menuWheel=new wheelnav("wheelDivptm",null,600,600),this._exitWheel=new wheelnav("_exitWheel",this._menuWheel.raphael),this._tabsWheel=new wheelnav("_tabsWheel",this._menuWheel.raphael),this._durationWheel=new wheelnav("_durationWheel",this._menuWheel.raphael),this.newNoteValue=2;var e=["divide","delete","add",String(this.newNoteValue)],l=["1/8","1/4","3/8","1/2","5/8","3/4","7/8","1/1"];wheelnav.cssMode=!0,this._menuWheel.keynavigateEnabled=!1,this._menuWheel.clickModeRotate=!1,this._menuWheel.colors=platformColor.pitchWheelcolors,this._menuWheel.slicePathFunction=slicePath().DonutSlice,this._menuWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._menuWheel.sliceSelectedPathCustom=this._menuWheel.slicePathCustom,this._menuWheel.sliceInitPathCustom=this._menuWheel.slicePathCustom,this._menuWheel.titleRotateAngle=90,this._menuWheel.animatetime=0,this._exitWheel.colors=platformColor.exitWheelcolors,this._exitWheel.keynavigateEnabled=!1,this._exitWheel.clickModeRotate=!1,this._exitWheel.slicePathFunction=slicePath().DonutSlice,this._exitWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._exitWheel.sliceSelectedPathCustom=this._exitWheel.slicePathCustom,this._exitWheel.sliceInitPathCustom=this._exitWheel.slicePathCustom;var n=["","","","","","","","","","","","","1","2","3","4","5","6","7",""];this._menuWheel.slicePathCustom.minRadiusPercent=.2,this._menuWheel.slicePathCustom.maxRadiusPercent=.5,this._exitWheel.slicePathCustom.minRadiusPercent=0,this._exitWheel.slicePathCustom.maxRadiusPercent=.2,this._tabsWheel.colors=platformColor.pitchWheelcolors,this._tabsWheel.slicePathFunction=slicePath().DonutSlice,this._tabsWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._tabsWheel.slicePathCustom.minRadiusPercent=.5,this._tabsWheel.slicePathCustom.maxRadiusPercent=.7,this._tabsWheel.sliceSelectedPathCustom=this._tabsWheel.slicePathCustom,this._tabsWheel.sliceInitPathCustom=this._tabsWheel.slicePathCustom,this._tabsWheel.clickModeRotate=!1,this._tabsWheel.createWheel(n),this._durationWheel.colors=platformColor.pitchWheelcolors,this._durationWheel.keynavigateEnabled=!1,this._durationWheel.slicePathFunction=slicePath().DonutSlice,this._durationWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._durationWheel.slicePathCustom.minRadiusPercent=.7,this._durationWheel.slicePathCustom.maxRadiusPercent=1,this._durationWheel.sliceSelectedPathCustom=this._durationWheel.slicePathCustom,this._durationWheel.sliceInitPathCustom=this._durationWheel.slicePathCustom,this._durationWheel.clickModeRotate=!1,this._durationWheel.createWheel(l);for(var a=0;a<n.length;a++)this._tabsWheel.navItems[a].navItem.hide();this._menuWheel.createWheel(e),this._exitWheel.createWheel(["x",""]),docById("wheelDivptm").style.position="absolute",docById("wheelDivptm").style.height="250px",docById("wheelDivptm").style.width="250px";var s=docById(t).getBoundingClientRect().x,r=docById(t).getBoundingClientRect().y;docById("wheelDivptm").style.left=Math.min(this.activity.canvas.width-200,Math.max(0,s*this.activity.getStageScale()))+"px",docById("wheelDivptm").style.top=Math.min(this.activity.canvas.height-250,Math.max(0,r*this.activity.getStageScale()))+"px",this._exitWheel.navItems[0].navigateFunction=function(){docById("wheelDivptm").style.display="none",o._menuWheel.removeWheel(),o._exitWheel.removeWheel()};var c=0;this._menuWheel.navItems[0].navigateFunction=function(){o._divideNotes(i,o.newNoteValue)},this._menuWheel.navItems[1].navigateFunction=function(){o._deleteNotes(i)},this._menuWheel.navItems[2].navigateFunction=function(){o._addNotes(t,i,o.newNoteValue)},this._menuWheel.navItems[3].navigateFunction=function(){if(c){for(var t=12;t<19;t++)docById("wheelnav-wheelDivptm-title-3").children[0].textContent=o.newNoteValue,o._tabsWheel.navItems[t].navItem.hide();c=0}else{for(var e=12;e<19;e++)docById("wheelnav-wheelDivptm-title-3").children[0].textContent=o.newNoteValue,o._tabsWheel.navItems[e].navItem.show();c=1}};for(var h=function(){var t=o._durationWheel.selectedNavItemIndex,e=l[t].split("/");o._updateDuration(i,e)},d=0;d<l.length;d++)this._durationWheel.navItems[d].navigateFunction=h;for(var u=12;u<19;u++)this._tabsWheel.navItems[u].navigateFunction=function(){var t=o._tabsWheel.selectedNavItemIndex;o.newNoteValue=n[t],docById("wheelnav-wheelDivptm-title-3").children[0].textContent=n[t]}},this._updateDuration=function(e,t){e=parseInt(e),t=parseInt(t[0])/parseInt(t[1]);var i=parseFloat((Math.round(8*t)/8).toFixed(3));this._notesPlayed=this._notesPlayed.map(function(t){return t.startTime===e&&(t.duration=i),t}),this._createTable()},this._addNotes=function(t,n,a){n=parseInt(n);var s=docById(t).getAttribute("dur");this._notesPlayed=this._notesPlayed.reduce(function(t,e){var i,o;if(parseInt(e.startTime)!==n)return parseInt(e.startTime)>n&&(e.startTime=e.startTime+1e3*s*a),t.concat([e]);t=t.concat([e]),i=JSON.parse(JSON.stringify(e));for(var l=0;l<a;l++)(o=JSON.parse(JSON.stringify(i))).startTime=i.startTime+1e3*i.duration,t=t.concat([o]),i=o;return t},[]),this._createTable()},this._deleteNotes=function(e){e=parseInt(e),this._notesPlayed=this._notesPlayed.filter(function(t){return parseInt(t.startTime)!==e}),this._createTable()},this._divideNotes=function(a,s){a=parseInt(a),this._notesPlayed=this._notesPlayed.reduce(function(t,e){var i,o,l;if(parseInt(e.startTime)!==a)return t.concat([e]);if("true"===I){if(e.duration/s<.125)return t.concat([e])}else if(e.duration/s<.0625)return t.concat([e]);(i=JSON.parse(JSON.stringify(e))).duration=e.duration/s,t=t.concat([i]),l=i;for(var n=0;n<s-1;n++)(o=JSON.parse(JSON.stringify(l))).startTime=parseInt(o.startTime+1e3*o.duration),t=t.concat([o]),l=o;return t},[]),this._createTable()},this._createAddRowPieSubmenu=function(){var d=this;docById("wheelDivptm").style.display="";for(var t,u=["do","doâ™¯","re","reâ™¯","mi","fa","faâ™¯","sol","solâ™¯","la","laâ™¯","ti"],y=[262,294,327,348,392,436,490,523],m=["pitch","hertz"],e=["imgsrc: images/chime.svg","imgsrc: images/synth.svg"],i=[],p=!1,o=0;o<e.length;o++)t=_(e[o]),i.push(t);this._menuWheel=new wheelnav("wheelDivptm",null,200,200),this._exitWheel=new wheelnav("_exitWheel",this._menuWheel.raphael),wheelnav.cssMode=!0,this._menuWheel.keynavigateEnabled=!1,this._menuWheel.slicePathFunction=slicePath().DonutSlice,this._menuWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._menuWheel.colors=[platformColor.paletteColors.pitch[0],platformColor.paletteColors.pitch[1]],this._menuWheel.slicePathCustom.minRadiusPercent=.3,this._menuWheel.slicePathCustom.maxRadiusPercent=1,this._menuWheel.sliceSelectedPathCustom=this._menuWheel.slicePathCustom,this._menuWheel.sliceInitPathCustom=this._menuWheel.slicePathCustom,this._menuWheel.clickModeRotate=!1,this._menuWheel.animatetime=0,this._menuWheel.createWheel(i),this._menuWheel.navItems[0].setTooltip(_("pitch")),this._menuWheel.navItems[1].setTooltip(_("hertz")),this._exitWheel.colors=platformColor.exitWheelcolors,this._exitWheel.slicePathFunction=slicePath().DonutSlice,this._exitWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._exitWheel.slicePathCustom.minRadiusPercent=0,this._exitWheel.slicePathCustom.maxRadiusPercent=.25,this._exitWheel.sliceSelectedPathCustom=this._exitWheel.slicePathCustom,this._exitWheel.sliceInitPathCustom=this._exitWheel.slicePathCustom,this._exitWheel.clickModeRotate=!1,this._exitWheel.createWheel(["Ã—"," "]);var v,b,l=docById("addnotes").getBoundingClientRect().x,n=docById("addnotes").getBoundingClientRect().y;docById("wheelDivptm").style.position="absolute",docById("wheelDivptm").style.height="300px",docById("wheelDivptm").style.width="300px",docById("wheelDivptm").style.left=Math.min(this.activity.canvas.width-200,Math.max(0,l*this.activity.getStageScale()))+"px",docById("wheelDivptm").style.top=Math.min(this.activity.canvas.height-250,Math.max(0,n*this.activity.getStageScale()))+"px",this._exitWheel.navItems[0].navigateFunction=function(){docById("wheelDivptm").style.display="none",d._menuWheel.removeWheel(),d._exitWheel.removeWheel()};for(var a=function(){if(!p){var t=m[d._menuWheel.selectedNavItemIndex],l=d.activity.blocks.blockList.length;if("pitch"===t){for(var e=0;e<u.length;e++){for(var i=void 0,o=d.layout.length-1;-1<o&&"hertz"===d.layout[o].noteName;)o--;if(i=d.layout[o]&&"hertz"!==d.layout[o].noteName?d.layout[o].noteName:null,u[e].includes(i)||i.includes(u[e]))break}for(;v=u[(e+1)%u.length],e=(e+1)%u.length,d.layout.some(function(t){return t.noteName===v}););for(var n=d.layout.length;0<n&&(b=d.layout[n-1].noteOctave,!(!isNaN(b)&&0<b&&b<9));n--);(e+1)%u.length==0&&(b+=1)}else{v="hertz";for(var a=!(b=392),s=0;s<y.length;s++){a=!1;for(var r=0;r<d.layout.length;r++)if("hertz"===d.layout[r].noteName&&d.layout[r].noteOctave===y[s]){a=!0;break}if(!a){b=y[s];break}}}switch(t){case"pitch":d.activity.blocks.loadNewBlocks([[0,["pitch",{}],0,0,[null,1,2,null]],[1,["solfege",{value:v}],0,0,[0]],[2,["number",{value:b}],0,0,[0]]]);break;case"hertz":d.activity.blocks.loadNewBlocks([[0,["hertz",{}],0,0,[null,1,null]],[1,["number",{value:b}],0,0,[0]]]);break;default:console.log("Nothing to do for "+t)}for(var c=-1,h=d.layout.length;0<h;h--)if(d.layout[h-1].blockNumber<k){c=d.layout[h-1].blockNumber;break}-1!==c?(p=!0,setTimeout(function(){d._addNotesBlockBetween(c,l),p=!1,d.layout.push({noteName:v,noteOctave:b,blockNumber:l,voice:d.layout[0].voice}),d._sortLayout(d.layout),d.displayLayout=d.layout.map(function(t){return SOLFEGENAMES.includes(t.noteName)?_objectSpread(_objectSpread({},t),{},{noteName:FIXEDSOLFEGE[t.noteName]}):t});var t=d.displayLayout.filter(function(t){return"hertz"===t.noteName}),e=d.displayLayout.filter(function(t){return"hertz"!==t.noteName});d.displayLayout=w(e),d.displayLayout=d.displayLayout.concat(t),d._createKeyboard(),d._createTable();var i=d.layout.length,o=d.layout[i-1];d.getElement[o.noteName.toString()+o.noteOctave.toString()]=o.objId,d.getElement[FIXEDSOLFEGE1[o.noteName.toString()]+""+o.noteOctave]=o.objId},500)):console.log("Could not find anywhere to insert new block.")}},s=0;s<i.length;s++)this._menuWheel.navItems[s].navigateFunction=a},this._addNotesBlockBetween=function(t,e){var i=last(this.activity.blocks.blockList[t].connections);this.activity.blocks.blockList[t].connections[this.activity.blocks.blockList[t].connections.length-1]=e,null!==i&&(this.activity.blocks.blockList[i].connections[0]=e),this.activity.blocks.blockList[e].connections[0]=t,this.activity.blocks.blockList[e].connections[this.activity.blocks.blockList[e].connections.length-1]=i,this.activity.blocks.adjustDocks(this.blockNo,!0),this.activity.blocks.clampBlocksToCheck.push([this.blockNo,0]),this.activity.blocks.adjustExpandableClampBlock(),this.activity.refreshCanvas()},this._sortLayout=function(){var l=this;this.layout.sort(function(t,e){var i,o;if("hertz"==t.noteName){if("hertz"!==e.noteName)return 1;i=t.noteOctave}else i=noteToFrequency(t.noteName+t.noteOctave,l.activity.turtles.ithTurtle(0).singer.keySignature);if("hertz"==e.noteName){if("hertz"!==t.noteName)return-1;o=e.noteOctave}else o=noteToFrequency(e.noteName+e.noteOctave,l.activity.turtles.ithTurtle(0).singer.keySignature);return i-o});var i=[];this.remove=[],this.layout=this.layout.filter(function(t,e){return i.includes(t.noteName+t.noteOctave)?!(l.remove=[l.layout[e-1].blockNumber,l.layout[e].blockNumber]):(i.push(t.noteName+t.noteOctave),!0)}),this._notesPlayed.map(function(t){return t.objId===l.remove[1]&&(t.objId=l.remove[0]),t}),this.remove.length&&this._removePitchBlock(this.remove[1]),this.keyboardShown?this._createKeyboard():this._createTable()},this._removePitchBlock=function(t){var e=this.activity.blocks.blockList[t].connections[0],i=last(this.activity.blocks.blockList[t].connections);"musickeyboard"===this.activity.blocks.blockList[e].name?this.activity.blocks.blockList[e].connections[1]=i:this.activity.blocks.blockList[e].connections[this.activity.blocks.blockList[e].connections.length-1]=i,i&&(this.activity.blocks.blockList[i].connections[0]=e),this.activity.blocks.blockList[t].connections[this.activity.blocks.blockList[t].connections.length-1]=null,this.activity.blocks.sendStackToTrash(this.activity.blocks.blockList[t]),this.activity.blocks.adjustDocks(this.blockNo,!0),this.activity.blocks.clampBlocksToCheck.push([this.blockNo,0]),this.activity.refreshCanvas()},this._createColumnPieSubmenu=function(h,d){var u=this;if(h=parseInt(h),void 0!==this.activity.blocks.blockList[this.layout[this.layout.length-h-1].blockNumber]){docById("wheelDivptm").style.display="",docById("wheelDivptm").style.zIndex="300";for(var t=["ð„ª","â™¯","â™®","â™­","ð„«"],y=["ti","la","sol","fa","mi","re","do"],m=[],e=0;e<y.length;e++)m.push(i18nSolfege(y[e]));"synthsblocks"===d&&(y=["261","294","327","348","392","436","490","523"]),this._pitchWheel=new wheelnav("wheelDivptm",null,600,600),this._exitWheel=new wheelnav("_exitWheel",this._pitchWheel.raphael),"pitchblocks"===d&&(this._accidentalsWheel=new wheelnav("_accidentalsWheel",this._pitchWheel.raphael),this._octavesWheel=new wheelnav("_octavesWheel",this._pitchWheel.raphael)),wheelnav.cssMode=!0,this._pitchWheel.keynavigateEnabled=!1,this._pitchWheel.slicePathFunction=slicePath().DonutSlice,this._pitchWheel.slicePathCustom=slicePath().DonutSliceCustomization(),"pitchblocks"===d?(this._pitchWheel.colors=platformColor.pitchWheelcolors,this._pitchWheel.slicePathCustom.minRadiusPercent=.2,this._pitchWheel.slicePathCustom.maxRadiusPercent=.5):"synthsblocks"===d&&(this._pitchWheel.titleRotateAngle=0,this._pitchWheel.colors=platformColor.blockLabelsWheelcolors,this._pitchWheel.slicePathCustom.minRadiusPercent=.6,this._pitchWheel.slicePathCustom.maxRadiusPercent=1,this._pitchWheel.titleRotateAngle=90,this._pitchWheel.clickModeRotate=!1),this._pitchWheel.sliceSelectedPathCustom=this._pitchWheel.slicePathCustom,this._pitchWheel.sliceInitPathCustom=this._pitchWheel.slicePathCustom,this._pitchWheel.animatetime=0,"synthsblocks"===d?this._pitchWheel.createWheel(y):this._pitchWheel.createWheel(m),this._exitWheel.colors=platformColor.exitWheelcolors,this._exitWheel.slicePathFunction=slicePath().DonutSlice,this._exitWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._exitWheel.slicePathCustom.minRadiusPercent=0,this._exitWheel.slicePathCustom.maxRadiusPercent=.2,this._exitWheel.sliceSelectedPathCustom=this._exitWheel.slicePathCustom,this._exitWheel.sliceInitPathCustom=this._exitWheel.slicePathCustom,this._exitWheel.clickModeRotate=!1,this._exitWheel.createWheel(["x"," "]);var i=["8","7","6","5","4","3","2","1",null,null,null,null,null,null];if("pitchblocks"===d){this._accidentalsWheel.colors=platformColor.accidentalsWheelcolors,this._accidentalsWheel.slicePathFunction=slicePath().DonutSlice,this._accidentalsWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._accidentalsWheel.slicePathCustom.minRadiusPercent=.5,this._accidentalsWheel.slicePathCustom.maxRadiusPercent=.75,this._accidentalsWheel.sliceSelectedPathCustom=this._accidentalsWheel.slicePathCustom,this._accidentalsWheel.sliceInitPathCustom=this._accidentalsWheel.slicePathCustom;for(var o=[],l=0;l<t.length;l++)o.push(t[l]);for(var n=0;n<9;n++)o.push(null),this._accidentalsWheel.colors.push(platformColor.accidentalsWheelcolorspush);this._accidentalsWheel.animatetime=0,this._accidentalsWheel.createWheel(o),this._accidentalsWheel.setTooltips([_("double sharp"),_("sharp"),_("natural"),_("flat"),_("double flat")]),this._octavesWheel.colors=platformColor.octavesWheelcolors,this._octavesWheel.slicePathFunction=slicePath().DonutSlice,this._octavesWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._octavesWheel.slicePathCustom.minRadiusPercent=.75,this._octavesWheel.slicePathCustom.maxRadiusPercent=.95,this._octavesWheel.sliceSelectedPathCustom=this._octavesWheel.slicePathCustom,this._octavesWheel.sliceInitPathCustom=this._octavesWheel.slicePathCustom,this._octavesWheel.animatetime=0,this._octavesWheel.createWheel(i)}var a=docById("labelcol"+h).getBoundingClientRect().x,s=docById("labelcol"+h).getBoundingClientRect().y;docById("wheelDivptm").style.position="absolute",docById("wheelDivptm").style.height="300px",docById("wheelDivptm").style.width="300px",docById("wheelDivptm").style.left=Math.min(this.activity.canvas.width-200,Math.max(0,a*this.activity.getStageScale()))+"px",docById("wheelDivptm").style.top=Math.min(this.activity.canvas.height-250,Math.max(0,s*this.activity.getStageScale()))+"px",h=this.layout.length-h-1;var p=this.layout[h].blockNumber,r=this.activity.blocks.blockList[this.activity.blocks.blockList[p].connections[1]].value;if("pitchblocks"===d){for(var c=this.activity.blocks.blockList[this.activity.blocks.blockList[p].connections[2]].value,v=2,b=0;b<t.length;b++)if(r.includes(t[b])){v=b,r=r.substr(0,r.indexOf(t[b]));break}this._accidentalsWheel.navigateWheel(v),this._octavesWheel.navigateWheel(i.indexOf(c.toString())),this._pitchWheel.navigateWheel(y.indexOf(r))}this._exitWheel.navItems[0].navigateFunction=function(){docById("wheelDivptm").style.display="none",u._pitchWheel.removeWheel(),u._exitWheel.removeWheel(),"pitchblocks"===d&&(u._accidentalsWheel.removeWheel(),u._octavesWheel.removeWheel())};var g=function(){var e=u._pitchWheel.navItems[u._pitchWheel.selectedNavItemIndex].title,t=u.activity.blocks.blockList[p].connections[1];u.activity.blocks.blockList[t].text.text=e,u.activity.blocks.blockList[t].value=parseInt(e);var i=u.activity.blocks.blockList[t].container.children.length-1;u.activity.blocks.blockList[t].container.setChildIndex(u.activity.blocks.blockList[t].text,i),u.activity.blocks.blockList[t].updateCache();var o=docById("labelcol"+(u.layout.length-h-1));u.layout[h].noteOctave=parseInt(e),o.innerHTML=u.layout[h].noteName+u.layout[h].noteOctave.toString(),u._notesPlayed.map(function(t){return t.objId==this.layout[h].blockNumber&&(t.noteOctave=parseInt(e)),t})};if("synthsblocks"===d)for(var k=0;k<y.length;k++)this._pitchWheel.navItems[k].navigateFunction=g;var f=function(){var t=u._pitchWheel.navItems[u._pitchWheel.selectedNavItemIndex].title,e=m.indexOf(t),i=y[e],o=u._accidentalsWheel.navItems[u._accidentalsWheel.selectedNavItemIndex].title;"â™®"!==o&&(i+=o);var l=Number(u._octavesWheel.navItems[u._octavesWheel.selectedNavItemIndex].title),n=getNote(i,l,0,u.activity.turtles.ithTurtle(0).singer.keySignature,!1,null,u.activity.logo.errorMsg,u.activity.logo.synth.inTemperament);u.activity.logo.synth.setMasterVolume(PREVIEWVOLUME),Singer.setSynthVolume(u.activity.logo,0,DEFAULTVOICE,PREVIEWVOLUME),u.activity.logo.synth.trigger(0,[n[0]+n[1]],1/8,DEFAULTVOICE,null,null),function(){var t,e,i,o=u._pitchWheel.navItems[u._pitchWheel.selectedNavItemIndex].title;"pitchblocks"===d?(e=m.indexOf(o),t=y[e],"â™®"!==(i=u._accidentalsWheel.navItems[u._accidentalsWheel.selectedNavItemIndex].title)&&(o+=i)):(e=y.indexOf(o),t=o);var l=u.activity.blocks.blockList[p].connections[1];u.activity.blocks.blockList[l].text.text=o,u.activity.blocks.blockList[l].value=t;var n,a=u.activity.blocks.blockList[l].container.children.length-1;u.activity.blocks.blockList[l].container.setChildIndex(u.activity.blocks.blockList[l].text,a),u.activity.blocks.blockList[l].updateCache(),"pitchblocks"===d&&(n=Number(u._octavesWheel.navItems[u._octavesWheel.selectedNavItemIndex].title),u.activity.blocks.blockList[l].blocks.setPitchOctave(u.activity.blocks.blockList[l].connections[0],n));var s=docById("labelcol"+(u.layout.length-h-1));u.layout[h].noteName=o,u.layout[h].noteOctave=n,s.innerHTML=u.layout[h].noteName+u.layout[h].noteOctave.toString();var r=o,c=r in FIXEDSOLFEGE1?FIXEDSOLFEGE1[r].replace(SHARP,"#").replace(FLAT,"b")+n:r.replace(SHARP,"#").replace(FLAT,"b")+n;u._notesPlayed.map(function(t){return t.objId==u.layout[h].blockNumber&&(t.noteOctave=c),t})}()};if("pitchblocks"===d){for(var I=0;I<y.length;I++)this._pitchWheel.navItems[I].navigateFunction=f;for(var W=0;W<t.length;W++)this._accidentalsWheel.navItems[W].navigateFunction=f;for(var w=0;w<8;w++)this._octavesWheel.navItems[w].navigateFunction=f}}},this._createKeyboard=function(){document.onkeydown=null;var t=this.keyboardDiv;t.style.display="flex",t.style.visibility="visible",t.style.border="0px",t.style.width="100%",t.style.top="0px",t.style.overflow="auto",t.style.userSelect="none",t.style.webkitUserSelect="none",t.style.msUserSelect="none",t.innerHTML="",t.innerHTML=' <div id="keyboardHolder2"><table class="white"><tbody><tr id="myrow"></tr></tbody></table><table class="black"><tbody><tr id="myrow2"></tr></tbody></table></div>';var e=docById("keyboardHolder2");e.style.bottom="10px",e.style.left="0px",e.style.height="145px",e.style.backgroundColor="white";var i=document.getElementsByClassName("black");i[0].style.top="1px",i[0].style.borderSpacing="0px 0px 20px",i[0].style.borderCollapse="separate";var o=document.getElementById("myrow");if(o.innerHTML="",(o=document.getElementById("myrow2")).innerHTML="",0===this.noteNames.length){for(var l=0;l<PITCHES3.length;l++)this.noteNames.push(PITCHES3[l]),this.octaves.push(4),4===l&&(this.noteNames.push(null),this.octaves.push(4));this.noteNames.push(PITCHES3[0]),this.octaves.push(5)}this.idContainer=[];for(var n,a,s,r,c,h,d=0,u=0,y=0,m=0;m<this.displayLayout.length;m++)if(this.displayLayout[m].noteName>k){if(a=document.getElementById("myrow2"),(c=document.createElement("td")).setAttribute("id","blackRow"+u.toString()),[2,6,9,13,16,20,23,27,30,34,37,41,44,48,51,55,58,62].includes(u)){a.appendChild(c),(s=docById("blackRow"+u.toString())).style.background="transparent",s.style.border="none",s.style.zIndex="10",s.style.position="relative",m--,u++;continue}c.setAttribute("alt",this.displayLayout[m].noteName+"__"+this.displayLayout[m].noteOctave+"__"+this.displayLayout[m].blockNumber),this.idContainer.push(["blackRow"+u.toString(),this.displayLayout[m].blockNumber]),m<this.layout.length&&(this.displayLayout[m].objId="blackRow"+u.toString(),this.layout[m].objId="blackRow"+u.toString()),u++,c.innerHTML="",c.style.visibility="hidden",a.appendChild(c)}else if("drum"===this.displayLayout[m].noteName)n=document.getElementById("myrow"),(r=document.createElement("td")).style.textAlign="center",r.setAttribute("id","whiteRow"+d.toString()),r.setAttribute("alt",this.displayLayout[m].noteName+"__"+this.displayLayout[m].voice+"__"+this.displayLayout[m].blockNumber),this.idContainer.push(["whiteRow"+d.toString(),this.displayLayout[m].blockNumber]),r.innerHTML="".concat(d<g.length?"<small>(".concat(String.fromCharCode(g[d]),")</small><br/>"):"").concat(this.displayLayout[m].voice),this.displayLayout[m].objId="whiteRow"+d.toString(),d++,r.style.position="relative",r.style.zIndex="100",n.appendChild(r);else if("hertz"===this.displayLayout[m].noteName)n=document.getElementById("myrow"),(r=document.createElement("td")).style.textAlign="center",r.setAttribute("id","hertzRow"+y.toString()),r.setAttribute("alt",this.displayLayout[m].noteName+"__"+this.displayLayout[m].noteOctave+"__"+this.displayLayout[m].blockNumber),this.idContainer.push(["hertzRow"+y.toString(),this.displayLayout[m].blockNumber]),r.innerHTML="".concat(y<b.length?"<small>(${String.fromCharCode(HERTZKEYS[myrow3Id])})</small><br/>":"").concat(this.displayLayout[m].noteOctave),this.displayLayout[m].objId="hertzRow"+y.toString(),y++,r.style.position="relative",r.style.zIndex="100",n.appendChild(r);else if(this.displayLayout[m].noteName.includes(SHARP)||this.displayLayout[m].noteName.includes("#")){if(a=document.getElementById("myrow2"),(c=document.createElement("td")).setAttribute("id","blackRow"+u.toString()),c.style.textAlign="center",[2,6,9,13,16,20,23,27,30,34,37,41,44,48,51,55,58,62].includes(u)){a.appendChild(c),(s=docById("blackRow"+u.toString())).style.background="transparent",s.style.border="none",s.style.zIndex="10",s.style.position="relative",m--,u++;continue}c.setAttribute("alt",this.displayLayout[m].noteName+"__"+this.displayLayout[m].noteOctave+"__"+this.displayLayout[m].blockNumber),this.idContainer.push(["blackRow"+u.toString(),this.displayLayout[m].blockNumber]),h=this.displayLayout[m].noteName.replace(SHARP,"").replace("#",""),this.displayLayout[m].blockNumber>=k&&(c.innerHTML=u<v.length?"<small>(".concat(String.fromCharCode(v[u]),")</small><br/>"):""),m<this.layout.length&&(this.displayLayout[m].objId="blackRow"+u.toString(),this.layout[m].objId="blackRow"+u.toString()),u++,c.style.position="relative",c.style.zIndex="200",a.appendChild(c)}else if(this.displayLayout[m].noteName.includes(FLAT)||this.displayLayout[m].noteName.includes("b")){if(a=document.getElementById("myrow2"),(c=document.createElement("td")).setAttribute("id","blackRow"+u.toString()),c.style.textAlign="center",[2,6,9,13,16,20,23,27,30,34,37,41,44,48,51,55,58,62].includes(u)){a.appendChild(c),(s=docById("blackRow"+u.toString())).style.background="transparent",s.style.border="none",s.style.zIndex="10",s.style.position="relative",m--,u++;continue}c.setAttribute("alt",this.displayLayout[m].noteName+"__"+this.displayLayout[m].noteOctave+"__"+this.displayLayout[m].blockNumber),this.idContainer.push(["blackRow"+u.toString(),this.displayLayout[m].blockNumber]),h=this.displayLayout[m].noteName.replace(FLAT,"").replace("b",""),this.displayLayout[m].blockNumber<=k&&(SOLFEGENAMES.includes(h)?c.innerHTML="<small>(".concat(String.fromCharCode(v[u]),")</small><br/>").concat(i18nSolfege(h)).concat(FLAT).concat(this.displayLayout[m].noteOctave):c.innerHTML="<small>(".concat(String.fromCharCode(v[u]),")</small><br/>").concat(this.displayLayout[m].noteName).concat(this.displayLayout[m].noteOctave)),m<this.layout.length&&(this.displayLayout[m].objId="blackRow"+u.toString(),this.layout[m].objId="blackRow"+u.toString()),u++,c.style.position="relative",c.style.zIndex="200",a.appendChild(c)}else n=document.getElementById("myrow"),(r=document.createElement("td")).setAttribute("id","whiteRow"+d.toString()),r.style.textAlign="center",r.setAttribute("alt",this.displayLayout[m].noteName+"__"+this.displayLayout[m].noteOctave+"__"+this.displayLayout[m].blockNumber),this.idContainer.push(["whiteRow"+d.toString(),this.displayLayout[m].blockNumber]),this.displayLayout[m].blockNumber<=k&&(SOLFEGENAMES.includes(this.displayLayout[m].noteName)?r.innerHTML="".concat(d<g.length?"<small>(".concat(String.fromCharCode(g[d]),")</small><br/>"):"").concat(i18nSolfege(this.displayLayout[m].noteName)).concat(this.displayLayout[m].noteOctave):r.innerHTML="".concat(d<g.length?"<small>(".concat(String.fromCharCode(g[d]),")</small><br/>"):"").concat(this.displayLayout[m].noteName).concat(this.displayLayout[m].noteOctave)),m<this.layout.length&&(this.displayLayout[m].objId="whiteRow"+d.toString(),this.layout[m].objId="whiteRow"+d.toString()),d++,r.style.position="relative",r.style.zIndex="100",n.appendChild(r);n=document.getElementById("myrow"),r=document.createElement("td"),n.appendChild(r),r.style.textAlign="center",r.setAttribute("id","rest"),r.setAttribute("alt","R__"),r.innerHTML="<small>(".concat(_("rest"),")</small><br/>"),r.style.position="relative",r.style.zIndex="100";for(var p=0;p<this.idContainer.length;p++)null!==this.displayLayout[p].blockNumber&&this.loadHandler(document.getElementById(this.idContainer[p][0]),p,this.idContainer[p][1],this.displayLayout);this.addKeyboardShortcuts()},this._save=function(){this.processSelected(),this._clusterNotes=function(t){for(var e=0,i=[],o=DEFAULTVOICE;e<t.length;)0===e?(i.push([e]),"drumnull"!==t[e].noteOctave[0]&&(o=t[e].voice[0])):"drumnull"===t[e].noteOctave[0]||"R"===t[e].noteOctave[0]?i[i.length-1].push(e):o=(t[e].voice[0]!=o?i.push([e]):i[i.length-1].push(e),t[e].voice[0]),e++;return i},this.findLen=function(t,e){for(var i=0,o=0;o<t.length;o++){var l=e[t[o]];"R"===l.noteOctave[0]?i+=6:"drumnull"===l.noteOctave[0]?i+=7:i+=5+3*l.noteOctave.length}return i};for(var t=parseInt(x.length/50)+1,e=0;e<t;e++){var i=x.slice(50*e,50*(e+1)),o=this._clusterNotes(i),l=[[0,["action",{collapsed:!1}],100,100,[null,1,2,null]],[1,["text",{value:_("action")+""+e}],0,0,[0]],[2,"hidden",0,0,[0,0==x.length?null:3]]];l.push([3,"setmasterbpm2",0,0,[2,4,5,8]],[4,["number",{value:this.bpm}],0,0,[3]],[5,"divide",0,0,[3,6,7]],[6,["number",{value:1}],0,0,[5]],[7,["number",{value:4}],0,0,[5]],[8,"vspace",0,0,[3,9]]);for(var n=8,a=void 0,s=0;s<o.length;s++){var r=o[s],c=s==o.length-1,h=l.length,d=x[r[0]].voice[0]||DEFAULTVOICE;"drumnull"===x[r[0]].noteOctave[0]&&(d=DEFAULTVOICE);var u=c?null:h+3+this.findLen(r,x);l.push([h,"settimbre",0,0,[n,h+1,h+3,h+2]],[h+1,["voicename",{value:d}],0,0,[h]],[h+2,"hidden",0,0,[h,u]]),n=h+2,a=h;for(var y=0;y<r.length;y++){var m=x[r[y]],p=l.length;l.push([p,"newnote",0,0,[a,p+2,p+1,null]]);var v=l[p][4].length;0===y?l[a][4][v-2]=p:l[a][4][v-1]=p,a=p;l.push([p+1,"vspace",0,0,[p,p+5]]),l.push([p+2,"divide",0,0,[p,p+3,p+4]]);var b=Math.max.apply(Math,m.duration),g=toFraction(b);l.push([p+3,["number",{value:g[0]}],0,0,[p+2]]),l.push([p+4,["number",{value:g[1]}],0,0,[p+2]]);var k=p+5,f=p+1,I=null;if("R"===m.noteOctave[0])l.push([k+1,"rest2",0,0,[f,I]]);else if("drumnull"===m.noteOctave[0])l.push([k,"playdrum",0,0,[f,k+1,I]]),l.push([k+1,["drumname",{value:m.voice[0]}],0,0,[k]]);else for(var W,w=0;w<m.noteOctave.length;w++){0<w&&(k="string"==typeof m.noteOctave[w-1]?f+3:f+2,W=l[f][4].length,l[f][4][W-1]=k),"string"==typeof m.noteOctave[w]?(l.push([k,"pitch",0,0,[f,k+1,k+2,I]]),["#","b","â™¯","â™­"].includes(m.noteOctave[w][1])?l.push([k+1,["solfege",{value:SOLFEGECONVERSIONTABLE[m.noteOctave[w][0]]+m.noteOctave[w][1]}],0,0,[k]]):l.push([k+1,["solfege",{value:SOLFEGECONVERSIONTABLE[m.noteOctave[w][0]]}],0,0,[k]]),l.push([k+2,["number",{value:m.noteOctave[w][m.noteOctave[w].length-1]}],0,0,[k]])):(l.push([k,"hertz",0,0,[f,k+1,I]]),l.push([k+1,["number",{value:m.noteOctave[w]}],0,0,[k]])),f=k}}}this.activity.blocks.loadNewBlocks(l)}1<t?C.textMsg(_("New action blocks generated."),3e3):C.textMsg(_("New action block generated."),3e3)},this.clearBlocks=function(){this.noteNames=[],this.octaves=[]},this._addButton=function(t,e,i,o){var l=t.insertCell(-1);return l.innerHTML='&nbsp;&nbsp;<img \n                src="header-icons/'.concat(e,'" \n                title="').concat(o,'" \n                alt="').concat(o,'" \n                height="').concat(i,'" \n                width="').concat(i,'" \n                vertical-align="middle" \n                align-content="center"\n            >&nbsp;&nbsp;'),l.style.width="53px",l.style.minWidth=l.style.width,l.style.maxWidth=l.style.width,l.style.height=l.style.width,l.style.minHeight=l.style.height,l.style.maxHeight=l.style.height,l.style.backgroundColor=platformColor.selectorBackground,l.onmouseover=function(){this.style.backgroundColor=platformColor.selectorBackgroundHOVER},l.onmouseout=function(){this.style.backgroundColor=platformColor.selectorBackground},l},this.doMIDI=function(){var y=0,m=0;p.getElement={};for(var t=0;t<p.layout.length;t++){var e=p.layout[t];p.getElement[e.noteName.toString()+e.noteOctave.toString()]=e.objId,p.getElement[FIXEDSOLFEGE1[e.noteName.toString()]+""+e.noteOctave]=e.objId}function i(t){var e,i,o,l,n,a,s,r=(e=t.data[1],i=4+Math.floor((e-60)/12),[NOTESSHARP[e%12],NOTESFLAT[e%12],i]),c=r[0],h=r[1],d=r[2],u=p.getElement[c+""+d]||p.getElement[h+""+d];144==t.data[0]&&0!=t.data[2]?(a=t,(s=docById(u))&&(m=a.timeStamp,s.style.backgroundColor=platformColor.orange,p.activity.logo.synth.trigger(0,p.noteMapper[s.id],1,p.instrumentMapper[s.id],null,null))):(o=t,(l=docById(u))&&(l.id.includes("blackRow")?l.style.backgroundColor="black":l.style.backgroundColor="white",n=o.timeStamp,y=n-m,y/=1e3,p.activity.logo.synth.stopSound(0,p.instrumentMapper[l.id],p.noteMapper[l.id]),0===(y="true"===I?parseFloat((Math.round(8*y)/8).toFixed(3)):parseFloat((Math.round(16*y)/16).toFixed(4)))?y=.125:y<0&&(y=-y),p._notesPlayed.push({startTime:m,noteOctave:p.noteMapper[l.id],objId:l.id,duration:y,voice:p.instrumentMapper[l.id],blockNumber:p.blockNumberMapper[l.id]}),p._createTable()))}navigator.requestMIDIAccess({sysex:!0}).then(function(t){if(p.midiON)return p.midiButton.style.background="#00FF00",void C.textMsg(_("MIDI device present."),3e3);t.inputs.forEach(function(t){t.onmidimessage=i}),t.inputs.size?(p.midiButton.style.background="#00FF00",C.textMsg(_("MIDI device present."),3e3),p.midiON=!0):C.textMsg(_("No MIDI device found."),3e3)},function(){C.errorMsg(_("Failed to get MIDI access in browser."),3e3),p.midiON=!1})}}