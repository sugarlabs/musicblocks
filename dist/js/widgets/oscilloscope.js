"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw i}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,t,r){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);var n=r.call(e,t||"default");if("object"!=_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}var Oscilloscope=function(){function u(e){var m=this;if(_classCallCheck(this,u),_defineProperty(this,"reconnectSynthsToAnalyser",function(e){for(var t in void 0===m.pitchAnalysers[e]&&(m.pitchAnalysers[e]=new Tone.Analyser({type:"waveform",size:u.analyserSize})),instruments[e])instruments[e][t].connect(m.pitchAnalysers[e])}),_defineProperty(this,"makeCanvas",function(l,c,u,f,y){var d=document.createElement("canvas");d.height=c,d.width=l,d.className="oscilloscopeCanvas",m.widgetWindow.getWidgetBody().appendChild(d);var h=d.getContext("2d");h.clearRect(0,0,l,c);!function e(){if(m.drawVisualIDs[f]=requestAnimationFrame(e),m.pitchAnalysers[f]&&(u.running||y)){h.fillStyle="#FFFFFF";var t=m.pitchAnalysers[f].getValue(),r=t.length;h.fillRect(0,0,l,c),h.lineWidth=2;var n=u.painter._canvasColor;h.strokeStyle=n,h.beginPath();for(var o=l*m.zoomFactor/r,i=0,a=0;a<r;a++){var s=c/2*(1-t[a])+m.verticalOffset;0===a?h.moveTo(i,s):h.lineTo(i,s),i+=o}h.lineTo(d.width,d.height/2),h.stroke()}}()}),this.activity=e,this.pitchAnalysers={},this.playingNow=!1,this.drawVisualIDs)for(var t=0,r=Object.keys(this.drawVisualIDs);t<r.length;t++){var n=r[t];cancelAnimationFrame(this.drawVisualIDs[n])}this.drawVisualIDs={};var o=window.widgetWindows.windowFor(this,"oscilloscope");(this.widgetWindow=o).clear(),o.show(),o.onclose=function(){var e,t=_createForOfIteratorHelper(m.divisions);try{for(t.s();!(e=t.n()).done;){var r=e.value,n=m.activity.turtles.getIndexOfTurtle(r);cancelAnimationFrame(m.drawVisualIDs[n])}}catch(e){t.e(e)}finally{t.f()}m.pitchAnalysers={},o.destroy()},o.onmaximize=this._scale.bind(this),document.getElementsByClassName("wfbToolbar")[0].style.backgroundColor="#e8e8e8",document.getElementsByClassName("wfbWidget")[0].style.backgroundColor="#FFFFFF";this.zoomFactor=40,this.verticalOffset=0;var i=o.addButton("",u.ICONSIZE,_("Zoom In"));i.onclick=function(){m.zoomFactor*=1.333},i.children[0].src="data:image/svg+xml;base64,".concat(window.btoa(base64Encode(BIGGERBUTTON)));var a=o.addButton("",u.ICONSIZE,_("Zoom Out"));a.onclick=function(){m.zoomFactor/=1.333,m.zoomFactor<1&&(m.zoomFactor=1)},a.children[0].src="data:image/svg+xml;base64,".concat(window.btoa(base64Encode(SMALLERBUTTON))),o.sendToCenter(),this.widgetWindow=o,this.divisions=[];var s,l=_createForOfIteratorHelper(this.activity.logo.oscilloscopeTurtles);try{for(l.s();!(s=l.n()).done;){var c=s.value;c&&!c.inTrash&&this.divisions.push(c)}}catch(e){l.e(e)}finally{l.f()}this._scale(),this.playingNow}return _createClass(u,[{key:"_scale",value:function(){var e,t,r=this,n=document.getElementsByClassName("oscilloscopeCanvas");Array.prototype.forEach.call(n,function(e){r.widgetWindow.getWidgetBody().removeChild(e)}),t=this.widgetWindow.isMaximized()?(e=this.widgetWindow.getWidgetBody().getBoundingClientRect().width,this.widgetWindow.getWidgetFrame().getBoundingClientRect().height-70):(e=700,400),document.getElementsByTagName("canvas")[0].innerHTML="";var o,i=_createForOfIteratorHelper(this.divisions);try{for(i.s();!(o=i.n()).done;){var a=o.value,s=this.activity.turtles.getIndexOfTurtle(a);this.reconnectSynthsToAnalyser(s),this.makeCanvas(e,t/this.divisions.length,a,s,!0)}}catch(e){i.e(e)}finally{i.f()}}}]),u}();_defineProperty(Oscilloscope,"ICONSIZE",40),_defineProperty(Oscilloscope,"analyserSize",8192);