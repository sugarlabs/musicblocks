"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var l=t[i];l.enumerable=l.enumerable||!1,l.configurable=!0,"value"in l&&(l.writable=!0),Object.defineProperty(e,_toPropertyKey(l.key),l)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,t,i){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var i=e[Symbol.toPrimitive];if(void 0===i)return("string"===t?String:Number)(e);var l=i.call(e,t||"default");if("object"!=_typeof(l))return l;throw new TypeError("@@toPrimitive must return a primitive value.")}var MeterWidget=function(){function v(e,s){var o=this;_classCallCheck(this,v),this.activity=e,this._meterBlock=this.activity.logo._meterBlock,this._strongBeats=[],this._playing=!1,this._click_lock=!1,this._beatValue=.25;var t=window.innerWidth;this._cellScale=t/1200;var i=window.widgetWindows.windowFor(this,"meter");(this.widgetWindow=i).clear(),this.activity.logo.synth.setMasterVolume(PREVIEWVOLUME),this.activity.logo.synth.loadSynth(0,"kick drum"),Singer.setSynthVolume(this.activity.logo,0,"kick drum",PREVIEWVOLUME),this.activity.logo.synth.loadSynth(0,"snare drum"),Singer.setSynthVolume(this.activity.logo,0,"snare drum",PREVIEWVOLUME),this.meterDiv=document.createElement("table"),i.getWidgetBody().append(this.meterDiv),i.onclose=function(){o._playing=!1,o.activity.hideMsgs(),i.destroy()},i.onmaximize=this._scale,this._click_lock=!1;var l=i.addButton("play-button.svg",v.ICONSIZE,_("Play"));l.onclick=function(){o._get_click_lock()||(o._click_lock=!0,o.__getPlayingStatus()?(l.innerHTML='&nbsp;&nbsp;<img \n                            src="header-icons/play-button.svg" \n                            title="'.concat(_("Play all"),'" \n                            alt="').concat(_("Play all"),'" \n                            height="').concat(v.ICONSIZE,'" \n                            width="').concat(v.ICONSIZE,'" \n                            vertical-align="middle"\n                        >&nbsp;&nbsp;'),o._playing=!1):(l.innerHTML='&nbsp;&nbsp;<img \n                            src="header-icons/stop-button.svg" \n                            title="'.concat(_("Stop"),'" \n                            alt="').concat(_("Stop"),'" \n                            height="').concat(v.ICONSIZE,'" \n                            width="').concat(v.ICONSIZE,'" \n                            vertical-align="middle"\n                        >&nbsp;&nbsp;'),o._playing=!0,o.activity.logo.turtleDelay=0,o.activity.logo.resetSynth(0),o._playBeat()),setTimeout(function(){o._click_lock=!1},1e3))},i.addButton("export-chunk.svg",v.ICONSIZE,_("Save")).onclick=function(){o._save()};var a,h,n,r,c=this.meterDiv;c.style.display="inline",c.style.visibility="visible",c.style.border="0px",c.innerHTML='<div id="meterWheelDiv"></div>',null!==this._meterBlock?(a=null!==(h=this.activity.blocks.blockList[this._meterBlock].connections[1])?this.activity.blocks.blockList[h].value:4,n=this.activity.blocks.blockList[this._meterBlock].connections[2],r=this.activity.blocks.blockList[n].connections[2],null!==n&&(this._beatValue=this.activity.blocks.blockList[n].value),this._piemenuMeter(a,this._beatValue)):this._piemenuMeter(4,this._beatValue);var u=document.createElement("div");u.className="wfbtItem",u.innerHTML='<input style="float: left;" value="'.concat(a,'" type="number" id="beatValue" min="1" max="16" >');var m=document.createElement("div");m.className="wfbtItem",m.innerHTML='<input style="float: left;" value="'.concat(1/this._beatValue,'" type="number" id="beatValue" min="1" max="35">'),i._toolbar.appendChild(u),i._toolbar.appendChild(m),i.addButton("reload.svg",v.ICONSIZE,_("Reset")).onclick=function(){o._playing=!1;var e=u.children[0],t=m.children[0];u.children[0].value=Math.min(e.max,Math.max(e.min,e.value)),m.children[0].value=Math.min(t.max,Math.max(t.min,t.value));var i=o.activity.blocks.blockList[h],l=o.activity.blocks.blockList[r],a=u.children[0].value,n=m.children[0].value;i.value=a,i.text.text=a,i.container.setChildIndex(i.text,i.container.children.length-1),l.value=n,l.text.text=n,l.container.setChildIndex(l.text,l.container.children.length-1),o.activity.logo.runLogoCommands(s)},e.textMsg(_("Click in the circle to select strong beats for the meter."),3e3),i.sendToCenter(),this._scale.call(this.widgetWindow)}return _createClass(v,[{key:"_scale",value:function(){var e=this.getWidgetFrame().offsetHeight-this.getDragElement().offsetHeight,t=this.getWidgetBody().getElementsByTagName("svg")[0],i=this.isMaximized()?e/400:1;t.style.pointerEvents="none",t.setAttribute("height","".concat(400*i,"px")),t.setAttribute("width","".concat(400*i,"px")),setTimeout(function(){t.style.pointerEvents="auto"},100)}},{key:"_get_click_lock",value:function(){return this._click_lock}},{key:"__playDrum",value:function(e){this.activity.logo.synth.trigger(0,"C4",Singer.defaultBPMFactor*this._beatValue,e,null,null)}},{key:"__getPlayingStatus",value:function(){return this._playing}},{key:"__getPauseStatus",value:function(){return!this._playing}},{key:"__playOneBeat",value:function(e,t){var i=this;if(this.__getPauseStatus())for(var l=0;l<this._strongBeats.length;l++)this._playWheel.navItems[l].navItem.hide();else{var a=e-1;a<0&&(a+=this._strongBeats.length),this._playWheel.navItems[e].navItem.show(),this._playWheel.navItems[a].navItem.hide(),this._strongBeats[e]?this.__playDrum("snare drum"):this.__playDrum("kick drum"),setTimeout(function(){i.__playOneBeat((e+1)%i._strongBeats.length,t)},t)}}},{key:"_playBeat",value:function(){for(var e=this.activity.turtles.ithTurtle(0),t=TONEBPM/(0<e.singer.bpm.length?last(e.singer.bpm):Singer.masterBPM),i=0;i<this._strongBeats.length;i++)this._playWheel.navItems[i].navItem.hide();var l=1e3*t*this._beatValue;this.__playOneBeat(0,l)}},{key:"_addButton",value:function(e,t,i,l){var a=this,n=e.insertCell(-1);return n.innerHTML='&nbsp;&nbsp;<img \n                src="header-icons/'.concat(t,'" \n                title="').concat(l,'" \n                alt="').concat(l,'" \n                height="').concat(i,'" \n                width="').concat(i,'" \n                vertical-align="middle" \n                align-content="center"\n            >&nbsp;&nbsp;'),n.style.width=v.BUTTONSIZE+"px",n.style.minWidth=n.style.width,n.style.maxWidth=n.style.width,n.style.height=n.style.width,n.style.minHeight=n.style.height,n.style.maxHeight=n.style.height,n.style.backgroundColor=platformColor.selectorBackground,n.onmouseover=function(){a.style.backgroundColor=platformColor.selectorBackgroundHOVER},n.onmouseout=function(){a.style.backgroundColor=platformColor.selectorBackground},n}},{key:"_save",value:function(){for(var e=[],t=[],i=this._strongBeats.length,l=0;l<i;l++)this._strongBeats[l]&&e.push(l);for(var a=0,n=0;n<e.length;n++)0===n?(1===e.length?t.push([0,"onbeatdo",100,100,[null,1,2,null]]):t.push([0,"onbeatdo",100,100,[null,1,2,3]]),t.push([1,["number",{value:e[n]+1}],0,0,[0]]),t.push([2,["text",{value:"action"}],0,0,[0]])):(n===e.length-1?t.push([a,"onbeatdo",0,0,[a-3,a+1,a+2,null]]):t.push([a,"onbeatdo",0,0,[a-3,a+1,a+2,a+3]]),t.push([a+1,["number",{value:e[n]+1}],0,0,[a]]),t.push([a+2,["text",{value:"action"}],0,0,[a]])),a+=3;this.activity.blocks.loadNewBlocks(t)}},{key:"_piemenuMeter",value:function(e,t){var i=this;docById("meterWheelDiv").style.display="flex",docById("meterWheelDiv").style.justifyContent="center",this._meterWheel=new wheelnav("meterWheelDiv",null,400,400),this._beatWheel=new wheelnav("_beatWheel",this._meterWheel.raphael),this._playWheel=new wheelnav("_playWheel",this._meterWheel.raphael),wheelnav.cssMeter=!0,this._meterWheel.colors=platformColor.modeWheelcolors,this._meterWheel.slicePathFunction=slicePath().DonutSlice,this._meterWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._meterWheel.slicePathCustom.minRadiusPercent=.4,this._meterWheel.slicePathCustom.maxRadiusPercent=.75,this._meterWheel.sliceSelectedPathCustom=this._meterWheel.slicePathCustom,this._meterWheel.sliceInitPathCustom=this._meterWheel.slicePathCustom,this._meterWheel.clickModeRotate=!1,this._meterWheel.navAngle=-90,this._meterWheel.animatetime=0,16<e&&(e=16);var l=["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16"],a=[];this._strongBeats=[];for(var n=0;n<e;n++)a.push(l[n]),this._strongBeats.push(!1);this._meterWheel.createWheel(a),this._beatWheel.colors=platformColor.modeWheelcolors,this._beatWheel.slicePathFunction=slicePath().DonutSlice,this._beatWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._beatWheel.slicePathCustom.minRadiusPercent=.75,this._beatWheel.slicePathCustom.maxRadiusPercent=.9,this._beatWheel.sliceSelectedPathCustom=this._beatWheel.slicePathCustom,this._beatWheel.sliceInitPathCustom=this._beatWheel.slicePathCustom,this._beatWheel.clickModeRotate=!1,this._beatWheel.navAngle=-90,this._beatWheel.titleRotateAngle=90,a=[];for(var s=0;s<e;s++)a.push("x");this._beatWheel.createWheel(a),this._playWheel.colors=[platformColor.orange],this._playWheel.slicePathFunction=slicePath().DonutSlice,this._playWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._playWheel.slicePathCustom.minRadiusPercent=.3,this._playWheel.slicePathCustom.maxRadiusPercent=.4,this._playWheel.sliceSelectedPathCustom=this._playWheel.slicePathCustom,this._playWheel.sliceInitPathCustom=this._playWheel.slicePathCustom,this._playWheel.clickModeRotate=!1,this._playWheel.navAngle=-90,this._playWheel.titleRotateAngle=90,a=[];for(var o=0;o<e;o++)a.push(" ");this._playWheel.createWheel(a);for(var h=0;h<e;h++)this._playWheel.navItems[h].navItem.hide();for(var r=function(){var e=i._meterWheel.selectedNavItemIndex;i._strongBeats[e]=!0,i._beatWheel.navItems[e].navItem.show()},c=function(){var e=i._beatWheel.selectedNavItemIndex;i._beatWheel.navItems[e].navItem.hide(),i._strongBeats[e]=!1},u=0;u<e;u++)this._meterWheel.navItems[u].navigateFunction=r,this._beatWheel.navItems[u].navigateFunction=c,this._beatWheel.navItems[u].navItem.hide();this._setupDefaultStrongWeakBeats(e,t)}},{key:"_setupDefaultStrongWeakBeats",value:function(e,t){.25==t&&4==e?(this._strongBeats[0]=!0,this._strongBeats[2]=!0,this._beatWheel.navItems[0].navItem.show(),this._beatWheel.navItems[2].navItem.show()):.25==t&&2==e||.25==t&&3==e?(this._strongBeats[0]=!0,this._beatWheel.navItems[0].navItem.show()):.125==t&&6==e&&(this._strongBeats[0]=!0,this._strongBeats[3]=!0,this._beatWheel.navItems[0].navItem.show(),this._beatWheel.navItems[3].navItem.show())}}]),v}();_defineProperty(MeterWidget,"BUTTONDIVWIDTH",535),_defineProperty(MeterWidget,"BUTTONSIZE",53),_defineProperty(MeterWidget,"ICONSIZE",32);