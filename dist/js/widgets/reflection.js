"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function asyncGeneratorStep(e,t,n,r,i,o,a){try{var s=e[o](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,i)}function _asyncToGenerator(s){return function(){var e=this,a=arguments;return new Promise(function(t,n){var r=s.apply(e,a);function i(e){asyncGeneratorStep(r,t,n,i,o,"next",e)}function o(e){asyncGeneratorStep(r,t,n,i,o,"throw",e)}i(void 0)})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,_toPropertyKey(r.key),r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,t,n){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0===n)return("string"===t?String:Number)(e);var r=n.call(e,t||"default");if("object"!=_typeof(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}var ReflectionMatrix=function(){function i(){_classCallCheck(this,i),this.chatHistory=[],this.AImentor="meta",this.mentorsMap={user:"YOU",meta:"ROHAN",music:"BEETHOVEN",code:"ALAN"},this.triggerFirst=!1,this.projectAlgorithm="",this.code=""}var t,e,n,o,r,a,s,c;return _createClass(i,[{key:"init",value:function(e){var t=this;this.activity=e,this.isOpen=!0,this.isMaximized=!1,this.activity.isInputON=!0,this.PORT="http://3.105.177.138:8000";var n=window.widgetWindows.windowFor(this,"reflection","reflection");(this.widgetWindow=n).clear(),n.show(),n.getWidgetBody().style.height=i.OUTERWINDOWHEIGHT,n.getWidgetBody().style.width=i.OUTERWINDOWWIDTH,n.onclose=function(){t.isOpen=!1,t.activity.isInputON=!1,n.destroy()},this.summary=this.readReport()||"No reports available",this.chatInterface=document.createElement("div"),this.chatInterface.className="chatInterface",n.getWidgetBody().append(this.chatInterface),n.addButton("notes_icon.svg",i.ICONSIZE,_("Summary")).onclick=function(){return t.getAnalysis()},n.addButton("save-button-dark.svg",i.ICONSIZE,_("Save")).onclick=function(){return t.downloadAsTxt(t.chatHistory)},this.metaButton=n.addButton("general_mentor.svg",i.ICONSIZE,_("Talk with Rohan")),this.metaButton.onclick=function(){return t.changeMentor("meta")},this.codeButton=n.addButton("code.svg",i.ICONSIZE,_("Talk with Alan")),this.codeButton.onclick=function(){return t.changeMentor("code")},this.musicButton=n.addButton("music.svg",i.ICONSIZE,_("Talk with Beethoven")),this.musicButton.onclick=function(){return t.changeMentor("music")},this.reloadButton=n.addButton("reload.svg",i.ICONSIZE,_("Refresh")),this.reloadButton.onclick=function(){return t.updateProjectCode()},this.changeMentor(this.AImentor),this.chatLog=document.createElement("div"),this.chatLog.className="chatLog",this.chatInterface.appendChild(this.chatLog),this.inputContainer=document.createElement("div"),this.inputContainer.className="inputContainer",this.inputContainer.style.paddingBottom="10px",0<this.chatHistory.length?this.inputContainer.style.display="flex":this.inputContainer.style.display="none",this.input=document.createElement("input"),this.input.className="input-query",this.input.placeholder="Type a message",this.input.style.marginLeft="10px",this.inputContainer.appendChild(this.input),this.input.onkeydown=function(e){"Enter"===e.key&&t.sendMessage()};var r=document.createElement("button");r.className="confirm-button",r.style.marginRight="10px",r.innerText="Send",r.onclick=function(){return t.sendMessage()},this.inputContainer.appendChild(r),this.chatInterface.appendChild(this.inputContainer),0<this.chatHistory.length?this.renderChatHistory():this.startChatSession(),e.textMsg(_("Reflect on your project."),3e3)}},{key:"showTypingIndicator",value:function(e){var t,n,r=this;this.typingDiv||(this.typingDiv=document.createElement("div"),this.typingDiv.className="typing-indicator",(t=document.createElement("span")).textContent=e||"Thinking",this.typingDiv.appendChild(t),this.dotsContainer=document.createElement("span"),this.typingDiv.appendChild(this.dotsContainer),this.chatLog.appendChild(this.typingDiv),this.chatLog.scrollTop=this.chatLog.scrollHeight,n=0,this.dotsInterval=setInterval(function(){n=(n+1)%4,r.dotsContainer.textContent=".".repeat(n)},500))}},{key:"hideTypingIndicator",value:function(){this.typingDiv&&(clearInterval(this.dotsInterval),this.typingDiv.remove(),this.typingDiv=null)}},{key:"changeMentor",value:function(e){"meta"===(this.AImentor=e)?this.metaButton.style.background="orange":this.metaButton.style.removeProperty("background"),"code"===e?this.codeButton.style.background="orange":this.codeButton.style.removeProperty("background"),"music"===e?this.musicButton.style.background="orange":this.musicButton.style.removeProperty("background")}},{key:"startChatSession",value:(c=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(1==this.triggerFirst)return e.abrupt("return");e.next=2;break;case 2:return this.triggerFirst=!0,setTimeout(function(){r.showTypingIndicator("Reading code")},1e3),e.next=6,this.activity.prepareExport();case 6:return t=e.sent,e.next=9,this.generateAlgorithm(t);case 9:n=e.sent,this.hideTypingIndicator(),n&&!n.error?(this.inputContainer.style.display="flex",this.botReplyDiv(n,!1,!1),this.projectAlgorithm=n.algorithm,this.code=t):this.activity.errorMsg(_(n.error),3e3);case 12:case"end":return e.stop()}},e,this)})),function(){return c.apply(this,arguments)})},{key:"updateProjectCode",value:(s=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.activity.prepareExport();case 2:if((t=e.sent)===this.code)return console.log("No changes in code detected."),e.abrupt("return");e.next=6;break;case 6:return this.showTypingIndicator("Reading code"),e.next=9,this.generateNewAlgorithm(t);case 9:n=e.sent,this.hideTypingIndicator(),n&&!n.error?("unchanged"!==n.algorithm?(this.projectAlgorithm=n.algorithm,this.code=t):console.log("No changes in algorithm detected."),this.botReplyDiv(n,!1,!1)):this.activity.errorMsg(_(n.error),3e3),this.projectAlgorithm=n.algorithm;case 13:case"end":return e.stop()}},e,this)})),function(){return s.apply(this,arguments)})},{key:"generateAlgorithm",value:(a=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch("".concat(this.PORT,"/projectcode"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:t})});case 3:return n=e.sent,e.next=6,n.json();case 6:return r=e.sent,e.abrupt("return",r);case 10:return e.prev=10,e.t0=e.catch(0),console.error("Error :",e.t0),e.abrupt("return",{error:"Failed to send message"});case 14:case"end":return e.stop()}},e,this,[[0,10]])})),function(e){return a.apply(this,arguments)})},{key:"generateNewAlgorithm",value:(r=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch("".concat(this.PORT,"/updatecode"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({oldcode:this.code,newcode:t})});case 3:return n=e.sent,e.next=6,n.json();case 6:return r=e.sent,e.abrupt("return",r);case 10:return e.prev=10,e.t0=e.catch(0),console.error("Error :",e.t0),e.abrupt("return",{error:"Failed to send message"});case 14:case"end":return e.stop()}},e,this,[[0,10]])})),function(e){return r.apply(this,arguments)})},{key:"generateBotReply",value:(o=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n,r,i){var o,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,this.showTypingIndicator(),e.next=4,fetch("".concat(this.PORT,"/chat"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:t,messages:n,mentor:r,algorithm:i})});case 4:return o=e.sent,this.hideTypingIndicator(),e.next=8,o.json();case 8:return a=e.sent,e.abrupt("return",a);case 12:return e.prev=12,e.t0=e.catch(0),console.error("Error :",e.t0),e.abrupt("return",{error:"Failed to send message"});case 16:case"end":return e.stop()}},e,this,[[0,12]])})),function(e,t,n,r){return o.apply(this,arguments)})},{key:"getAnalysis",value:(n=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.chatHistory.length<10)return e.abrupt("return");e.next=2;break;case 2:return this.showTypingIndicator("Analyzing"),e.next=5,this.generateAnalysis();case 5:return t=e.sent,this.hideTypingIndicator(),t&&this.botReplyDiv(t,!1,!0),e.next=10,this.saveReport(t);case 10:case"end":return e.stop()}},e,this)})),function(){return n.apply(this,arguments)})},{key:"generateAnalysis",value:(e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log("Summary stored",this.summary),e.next=4,fetch("".concat(this.PORT,"/analysis"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:this.chatHistory,summary:this.summary})});case 4:return t=e.sent,e.next=7,t.json();case 7:return n=e.sent,e.abrupt("return",n);case 11:return e.prev=11,e.t0=e.catch(0),console.error("Error :",e.t0),e.abrupt("return",{error:"Failed to send message"});case 15:case"end":return e.stop()}},e,this,[[0,11]])})),function(){return e.apply(this,arguments)})},{key:"botReplyDiv",value:(t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,i,o,a,s=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=2<s.length&&void 0!==s[2]&&s[2],!0===(!(1<s.length&&void 0!==s[1])||s[1]))return e.next=5,this.generateBotReply(t,this.chatHistory,this.AImentor,this.projectAlgorithm);e.next=8;break;case 5:r=e.sent,e.next=9;break;case 8:r=t;case 9:if(r.error)return this.hideTypingIndicator(),this.activity.errorMsg(_("Failed to send message"),3e3),e.abrupt("return");e.next=13;break;case 13:this.chatHistory.push({role:this.AImentor,content:r.response}),(i=document.createElement("div")).className="message-container",(o=document.createElement("div")).style.fontSize="12px",o.style.fontWeight="bold",o.style.marginBottom="4px",o.style.color="#383838ff",o.style.alignSelf="flex-start",o.innerText=this.mentorsMap[this.AImentor],a=document.createElement("div"),n?a.innerHTML=this.mdToHTML(r.response):a.innerText=r.response,i.appendChild(o),i.appendChild(a),this.chatLog.appendChild(i),this.chatLog.scrollTop=this.chatLog.scrollHeight;case 29:case"end":return e.stop()}},e,this)})),function(e){return t.apply(this,arguments)})},{key:"sendMessage",value:function(){var e,t,n,r=this.input.value.trim();""!==r&&(this.chatHistory.push({role:"user",content:r}),(e=document.createElement("div")).classList.add("message-container","user"),(t=document.createElement("div")).style.fontSize="12px",t.style.fontWeight="bold",t.style.marginBottom="4px",t.style.color="#555",t.style.overflowWrap="break-word",t.style.alignSelf="flex-start",t.innerText="You",(n=document.createElement("div")).innerText=r,e.appendChild(t),e.appendChild(n),this.chatLog.appendChild(e),this.input.value="",this.botReplyDiv(r),this.chatLog.scrollTop=this.chatLog.scrollHeight)}},{key:"renderChatHistory",value:function(){var i=this;this.chatLog.innerHTML="",this.chatHistory.forEach(function(e){var t=document.createElement("div");t.className="message-container";var n=document.createElement("div");n.style.fontSize="12px",n.style.fontWeight="bold",n.style.marginBottom="4px",n.style.color="#555",n.style.overflowWrap="break-word",n.style.alignSelf="flex-start";var r=document.createElement("div");r.innerText=e.content,t.appendChild(n),t.appendChild(r),"user"===e.role&&t.classList.add("user"),n.innerText=i.mentorsMap[e.role],i.chatLog.appendChild(t)}),this.chatLog.scrollTop=this.chatLog.scrollHeight}},{key:"saveReport",value:function(e){localStorage.setItem("musicblocks_analysis",e.response),console.log("Conversation saved in localStorage.")}},{key:"readReport",value:function(){return localStorage.getItem("musicblocks_analysis")}},{key:"downloadAsTxt",value:function(e){var t,n,r,i,o=this;0!==e.length?(t=e.map(function(e){return"".concat(o.mentorsMap[e.role]||e.role.toUpperCase(),": ").concat(e.content)}).join("\n\n"),n=new Blob([t],{type:"text/plain"}),r=URL.createObjectURL(n),(i=document.createElement("a")).href=r,i.download="conversation.txt",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r)):this.activity.errorMsg(_("No conversation to save."),2e3)}},{key:"mdToHTML",value:function(e){var t=e;return(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/^###### (.*$)/gim,"<h6>$1</h6>")).replace(/^##### (.*$)/gim,"<h5>$1</h5>")).replace(/^#### (.*$)/gim,"<h4>$1</h4>")).replace(/^### (.*$)/gim,"<h3>$1</h3>")).replace(/^## (.*$)/gim,"<h2>$1</h2>")).replace(/^# (.*$)/gim,"<h1>$1</h1>")).replace(/\*\*(.*?)\*\*/gim,"<b>$1</b>")).replace(/\*(.*?)\*/gim,"<i>$1</i>")).replace(/\[(.*?)\]\((.*?)\)/gim,"<a href='$2' target='_blank'>$1</a>")).replace(/\n/gim,"<br>")).trim()}}]),i}();_defineProperty(ReflectionMatrix,"BUTTONDIVWIDTH",535),_defineProperty(ReflectionMatrix,"OUTERWINDOWWIDTH","858px"),_defineProperty(ReflectionMatrix,"OUTERWINDOWHEIGHT","550px"),_defineProperty(ReflectionMatrix,"INNERWINDOWWIDTH",730),_defineProperty(ReflectionMatrix,"BUTTONSIZE",53),_defineProperty(ReflectionMatrix,"ICONSIZE",32);