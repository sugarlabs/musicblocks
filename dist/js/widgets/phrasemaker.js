"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function asyncGeneratorStep(t,e,l,i,s,o,a){try{var n=t[o](a),h=n.value}catch(t){return void l(t)}n.done?e(h):Promise.resolve(h).then(i,s)}function _asyncToGenerator(n){return function(){var t=this,a=arguments;return new Promise(function(e,l){var i=n.apply(t,a);function s(t){asyncGeneratorStep(i,e,l,s,o,"next",t)}function o(t){asyncGeneratorStep(i,e,l,s,o,"throw",t)}s(void 0)})}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var l=0;l<e.length;l++){var i=e[l];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,_toPropertyKey(i.key),i)}}function _createClass(t,e,l){return e&&_defineProperties(t.prototype,e),l&&_defineProperties(t,l),Object.defineProperty(t,"prototype",{writable:!1}),t}function _defineProperty(t,e,l){return(e=_toPropertyKey(e))in t?Object.defineProperty(t,e,{value:l,enumerable:!0,configurable:!0,writable:!0}):t[e]=l,t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(t,e){if("object"!=_typeof(t)||!t)return t;var l=t[Symbol.toPrimitive];if(void 0===l)return("string"===e?String:Number)(t);var i=l.call(t,e||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}var lastIndex=5,MATRIXGRAPHICS=["forward","back","right","left","setheading","setcolor","setshade","sethue","setgrey","settranslucency","setpensize"],MATRIXGRAPHICS2=["arc","setxy"],MATRIXSYNTHS=["sine","triangle","sawtooth","square","hertz"],PhraseMaker=function(){function P(){_classCallCheck(this,P),this._stopOrCloseClicked=!1,this._instrumentName=DEFAULTVOICE,this.isInitial=!0,this.paramsEffects={doVibrato:!1,doDistortion:!1,doTremolo:!1,doPhaser:!1,doChorus:!1,vibratoIntensity:0,vibratoFrequency:0,distortionAmount:0,tremoloFrequency:0,tremoloDepth:0,rate:0,octaves:0,baseFrequency:0,chorusRate:0,delayTime:0,chorusDepth:0},this.rowLabels=[],this.rowArgs=[],this._noteBlocks=!1,this.sorted=!1,this._notesToPlay=[],this._outputAsTuplet=[],this._matrixHasTuplets=!1,this._notesCounter=0,this._noteStored=[],this._rowBlocks=[],this._colBlocks=[],this._rowMap=[],this._rowOffset=[],this._rows=[],this._headcols=[],this._labelcols=[],this._tupletNoteLabel=null,this._tupletValueLabel=null,this._tupletNoteValueLabel=null,this._tupletNoteValueRow=null,this._tupletValueRow=null,this._noteValueRow=null,this._blockMap={},this.blockNo=null,this.notesBlockMap=[],this._blockMapHelper=[],this.columnBlocksMap=[],this._lyrics=[],this.lyricsON=!1}return _createClass(P,[{key:"stylePhraseMaker",value:function(){for(var t=window.innerWidth,e=window.innerHeight,l=document.getElementById("floatingWindows").querySelectorAll(".windowFrame"),i=0;i<l.length;i++){var s=l[i],o=s.querySelector(".wfWinBody"),a=s.querySelector(".wfbWidget"),n=parseFloat(window.getComputedStyle(s).width),h=parseFloat(window.getComputedStyle(s).height),c=.8*t,r=.8*e;(t<n||e<h)&&(s.style.height=Math.min(h,r)+"px",s.style.width=Math.min(n,c)+"px",a.style.overflowY=r<h?"auto":"hidden",a.style.overflowX=c<n?"auto":"hidden",a.style.width="-webkit-fill-available",a.style.height="-webkit-fill-available",a.style.position="absolute",a.style.left="55px",o.style.position="absolute",o.style.overflowY=r<h?"auto":"hidden",o.style.overflowX=c<n?"auto":"hidden",o.style.width="-webkit-fill-available",o.style.height="-webkit-fill-available",o.style.background="#cccccc")}}},{key:"clearBlocks",value:function(){this._rowBlocks=[],this._colBlocks=[],this._rowMap=[],this._rowOffset=[]}},{key:"addRowBlock",value:function(t){for(this._rowMap.push(this._rowBlocks.length),this._rowOffset.push(0);this._rowBlocks.includes(t);)t+=1e6;this._rowBlocks.push(t)}},{key:"addColBlock",value:function(t,e){for(var l=0,i=0;i<this._colBlocks.length;i++)this._colBlocks[i][0]===t&&(l+=1);for(var s=l;s<e+l;s++)this._colBlocks.push([t,s])}},{key:"addNode",value:function(t,e,l,i){void 0===this._blockMap[i]&&(this._blockMap[i]=[]);for(var s,o=0,a=0;a<this._blockMap[i].length;a++)(s=this._blockMap[i][a])[0]===t&&s[1][0]===e&&s[1][1]===l&&(o+=1);this._blockMap[i].push([t,[e,l],o])}},{key:"removeNode",value:function(t,e,l){for(var i,s=this.blockNo,o=0;o<this._blockMap[s].length;o++)(i=this._blockMap[s][o])[0]===t&&i[1][0]===e&&i[1][1]===l&&this._blockMap[s].splice(o,1)}},{key:"_get_save_lock",value:function(){return this._save_lock}},{key:"init",value:function(t){var e,s=this;this.activity=t,this._noteStored=[],this._noteBlocks=!1,this._rests=0,this.playingNow=!1;var l=window.innerWidth;this._cellScale=Math.max(1,l/1200);var i=P.ICONSIZE*this._cellScale,o=window.widgetWindows.windowFor(this,"phrase maker");(this.widgetWindow=o).clear(),o.show(),console.debug("notes "+this.rowLabels+" octave "+this.rowArgs),this._notesToPlay=[],this._matrixHasTuplets=!1,o.onclose=function(){s._rowOffset=[];for(var t=0;t<s._rowMap.length;t++)s._rowMap[t]=t;s.activity.logo.synth.stopSound(0,s._instrumentName),s.activity.logo.synth.stop(),s._stopOrCloseClicked=!0,s.activity.hideMsgs(),docById("wheelDivptm").style.display="none",o.destroy()},this._playButton=o.addButton("play-button.svg",P.ICONSIZE,_("Play")),this._playButton.onclick=function(){s.activity.logo.turtleDelay=0,s.activity.logo.resetSynth(0),s.playingNow?s._playButton.innerHTML='&nbsp;&nbsp;<img \n                        src="header-icons/play-button.svg" \n                        title="'.concat(_("Play"),'" \n                        alt="').concat(_("Play"),'" \n                        height="').concat(P.ICONSIZE,'" \n                        width="').concat(P.ICONSIZE,'" \n                        vertical-align="middle"\n                    >&nbsp;&nbsp;'):s._playButton.innerHTML='&nbsp;&nbsp;<img \n                        src="header-icons/stop-button.svg" \n                        title="'.concat(_("Stop"),'" \n                        alt="').concat(_("Stop"),'" \n                        height="').concat(P.ICONSIZE,'" \n                        width="').concat(P.ICONSIZE,'" \n                        vertical-align="middle"\n                    >&nbsp;&nbsp;'),s.playAll()},this._save_lock=!1,o.addButton("export-chunk.svg",P.ICONSIZE,_("Save")).onclick=_asyncToGenerator(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(s._get_save_lock()){t.next=7;break}return s._save_lock=!0,s._save(),t.next=5,delayExecution(1e3);case 5:s._save_lock=!1,window.innerWidth<=600&&s.widgetWindow.close();case 7:case"end":return t.stop()}},t)})),o.addButton("erase-button.svg",P.ICONSIZE,_("Clear")).onclick=this._clear.bind(this),localStorage.beginnerMode||(o.addButton("export-button.svg",P.ICONSIZE,_("Export")).onclick=this._export.bind(this)),o.addButton("sort.svg",P.ICONSIZE,_("Sort")).onclick=this._sort.bind(this);var a=o.addButton("add2.svg",P.ICONSIZE,_("Add note"));a.setAttribute("id","addnotes"),a.onclick=this._createAddRowPieSubmenu.bind(this);var n,h,c,r,u,p,d,b,y=document.createElement("table");if(y.setAttribute("cellpadding","0px"),o.getWidgetBody().append(y),!this.sorted){this.columnBlocksMap=this._mapNotesBlocks("all",!0);for(var m=0;m<this.columnBlocksMap.length;m++)MATRIXGRAPHICS.includes(this.columnBlocksMap[m][1])||MATRIXGRAPHICS2.includes(this.columnBlocksMap[m][1])||MATRIXSYNTHS.includes(this.columnBlocksMap[m][1])||["playdrum","pitch"].includes(this.columnBlocksMap[m][1])||(this.columnBlocksMap=this.columnBlocksMap.slice(0,m).concat(this.columnBlocksMap.slice(m+1)),m--)}for(var v,g,k=0,f=0;f<this.rowLabels.length;f++)if("rest"!==this.rowLabels[f].toLowerCase()){if(n=y.insertRow(),h=getDrumName(this.rowLabels[f]),"print"===this.rowLabels[f])break;if(c=-1!=MATRIXGRAPHICS.indexOf(this.rowLabels[f])||-1!=MATRIXGRAPHICS2.indexOf(this.rowLabels[f])?platformColor.graphicsLabelBackground:null===h?platformColor.pitchLabelBackground:platformColor.drumLabelBackground,(a=n.insertCell()).style.backgroundColor=c,a.style.fontSize=100*this._cellScale+"%",a.style.height=Math.floor(MATRIXSOLFEHEIGHT*this._cellScale)+1+"px",a.style.width=Math.floor(MATRIXSOLFEWIDTH*this._cellScale)+"px",a.style.minWidth=Math.floor(MATRIXSOLFEWIDTH*this._cellScale)+"px",a.style.maxWidth=a.style.minWidth,a.className="headcol",a.style.position="sticky",a.style.left="1.2px",a.innerHTML="",this._headcols[f]=a,"print"===this.rowLabels[f])break;if(null!=h?a.innerHTML='&nbsp;&nbsp;<img \n                        src="'.concat(getDrumIcon(h),'" \n                        title="').concat(_(h),'" \n                        alt="').concat(_(h),'" \n                        height="').concat(i,'" \n                        width="').concat(i,'" \n                        vertical-align="middle"\n                    >&nbsp;&nbsp;'):"http"===this.rowLabels[f].slice(0,4)?a.innerHTML='&nbsp;&nbsp;<img \n                        src="'.concat(getDrumIcon(this.rowLabels[f]),'" \n                        title="').concat(this.rowLabels[f],'" \n                        alt="').concat(this.rowLabels[f],'" \n                        height="').concat(i/2,'" \n                        width="').concat(i/2,'" \n                        vertical-align="middle"\n                    />&nbsp;&nbsp;'):MATRIXSYNTHS.includes(this.rowLabels[f])?a.innerHTML='&nbsp;&nbsp;<img \n                        src="images/synth2.svg" \n                        height="'.concat(i,'" \n                        width="').concat(i,'" \n                        vertical-align="middle"\n                    >&nbsp;&nbsp;'):MATRIXGRAPHICS.includes(this.rowLabels[f])||MATRIXGRAPHICS2.includes(this.rowLabels[f])?a.innerHTML='&nbsp;&nbsp;<img \n                        src="images/mouse.svg" \n                        height="'.concat(i,'" \n                        width="').concat(i,'" \n                        vertical-align="middle"\n                    >&nbsp;&nbsp;'):(v={C:1,D:2,E:3,F:4,G:5,A:6,B:7,do:1,re:2,mi:3,fa:4,sol:5,la:6,ti:7},(g=this.rowLabels[f])in v&&4===this.rowArgs[f]?a.innerHTML='<img \n                            src="images/8_bellset_key_'.concat(v[g],'.svg" \n                            width="').concat(a.style.width,'" \n                            vertical-align="middle"\n                        >'):["C","do"].includes(g)&&5===this.rowArgs[f]&&(a.innerHTML='<img \n                            src="images/8_bellset_key_8.svg" \n                            width="'.concat(a.style.width,'" \n                            vertical-align="middle"\n                        >'))),(a=n.insertCell()).style.backgroundColor=c,a.style.fontSize=100*this._cellScale+"%",a.style.height=Math.floor(MATRIXSOLFEHEIGHT*this._cellScale)+1+"px",a.style.width=Math.floor(MATRIXSOLFEWIDTH*this._cellScale)+"px",a.style.minWidth=Math.floor(MATRIXSOLFEWIDTH*this._cellScale)+"px",a.style.maxWidth=a.style.minWidth,a.className="labelcol",a.style.position="sticky",a.style.left=P.BUTTONSIZE*this._cellScale+"px",a.setAttribute("alt",f),this._labelcols[f]=a,"print"===this.rowLabels[f])break;if(null!=h)a.innerHTML=_(h),a.style.fontSize=Math.floor(14*this._cellScale)+"px",a.setAttribute("alt",f+"__drumblocks"),a.onclick=function(t){var e=t.target;null===e.getAttribute("alt")&&(e=e.parentNode);var l=e.getAttribute("alt").split("__")[0],i=e.getAttribute("alt").split("__")[1];s._createColumnPieSubmenu(l,i)},this._noteStored.push(h);else if("http"===this.rowLabels[f].slice(0,4))a.innerHTML=this.rowLabels[f],a.style.fontSize=Math.floor(14*this._cellScale)+"px",this._noteStored.push(this.rowLabels[f].replace(/ /g,": "));else if(MATRIXSYNTHS.includes(this.rowLabels[f]))a.innerHTML=this.rowArgs[f],a.style.fontSize=Math.floor(14*this._cellScale)+"px",a.setAttribute("alt",f+"__synthsblocks"),a.onclick=function(t){var e=t.target;null===e.getAttribute("alt")&&(e=e.parentNode);var l=e.getAttribute("alt").split("__")[0],i=e.getAttribute("alt").split("__")[1];s._createMatrixGraphicsPieSubmenu(l,i,null)},this._noteStored.push(this.rowArgs[f]);else if(MATRIXGRAPHICS.includes(this.rowLabels[f]))r=this.activity.blocks.protoBlockDict[this.rowLabels[f]].staticLabels[0],a.innerHTML="".concat(r,"<br>").concat(this.rowArgs[f]),a.style.fontSize=Math.floor(12*this._cellScale)+"px",a.setAttribute("alt",f+"__graphicsblocks"),a.onclick=function(t){var e=t.target;null===e.getAttribute("alt")&&(e=e.parentNode);var l=e.getAttribute("alt").split("__")[0],i=e.getAttribute("alt").split("__")[1];s._createMatrixGraphicsPieSubmenu(l,i,null)},this._noteStored.push(this.rowLabels[f]+": "+this.rowArgs[f]);else if(MATRIXGRAPHICS2.includes(this.rowLabels[f]))r=this.activity.blocks.protoBlockDict[this.rowLabels[f]].staticLabels[0],a.innerHTML="".concat(r,"<br>").concat(this.rowArgs[f][0]," ").concat(this.rowArgs[f][1]),a.style.fontSize=Math.floor(12*this._cellScale)+"px",a.setAttribute("alt",f+"__graphicsblocks2"),a.onclick=function(t){var e=t.target;null===e.getAttribute("alt")&&(e=e.parentNode);var l=e.getAttribute("alt").split("__")[0];s._createMatrixGraphics2PieSubmenu(l,null)},this._noteStored.push(this.rowLabels[f]+": "+this.rowArgs[f][0]+": "+this.rowArgs[f][1]);else{if(noteIsSolfege(this.rowLabels[f])&&!isCustomTemperament(this.activity.logo.synth.inTemperament))a.innerHTML="".concat(i18nSolfege(this.rowLabels[f])).concat(this.rowArgs[f].toString().sub()),u=getNote(this.rowLabels[f],this.rowArgs[f],0,this.activity.turtles.ithTurtle(0).singer.keySignature,!1,null,this.activity.errorMsg,this.activity.logo.synth.inTemperament);else if(isCustomTemperament(this.activity.logo.synth.inTemperament)){u=getNote(this.rowLabels[f],this.rowArgs[f],0,this.activity.turtles.ithTurtle(0).singer.keySignature,!1,null,this.activity.errorMsg,this.activity.logo.synth.inTemperament);var w=this.rowLabels[f],C=getTemperament(this.activity.logo.synth.inTemperament),W=[];for(var L in C)if(C[L][1]===w){W=C[L];break}0<W.length&&(W=W[0]),W[3]&&W[3]!==W[1]?a.innerHTML=W[1]:a.innerHTML=w+this.rowArgs[f].toString().sub()}else a.innerHTML=this.rowLabels[f]+this.rowArgs[f].toString().sub(),u=[this.rowLabels[f],this.rowArgs[f]];a.setAttribute("alt",f+"__pitchblocks"),a.onclick=function(t){var e=t.target;null===e.getAttribute("alt")&&(e=e.parentNode);var l=e.getAttribute("alt").split("__")[0],i=e.getAttribute("alt").split("__")[1];s._createColumnPieSubmenu(l,i)},this._noteStored.push(u[0]+u[1])}p=n.insertCell(),(b=document.createElement("table")).setAttribute("cellpadding","0px"),p.append(b),d=b.insertRow(),this._rows[k]=d,k+=1}else this._rests+=1;if(this.lyricsON){var I=y.insertRow();I.setAttribute("id","lyricRow"),I.style.position="sticky",(a=I.insertCell()).setAttribute("colspan","1"),a.className="headcol",a.style.position="sticky",a.style.left="1.2px",a.style.zIndex="1",a.style.backgroundColor=platformColor.lyricsLabelBackground,a.style.textAlign="center",a.innerHTML='<img src="images/pen.svg" height="'.concat(i,'" width="').concat(i,'" vertical-align="middle">'),(a=I.insertCell()).setAttribute("colspan","1"),a.className="headcol",a.style.position="sticky",a.style.left="1.2px",a.style.zIndex="1",a.style.backgroundColor=platformColor.lyricsLabelBackground,a.style.textAlign="center",a.innerHTML="Lyrics",(e=document.createElement("table")).setAttribute("cellpadding","0px");var x,S=e.insertRow();this._lyrics&&0!==this._lyrics.length?this.activity.logo.tupletRhythms.length>this._lyrics.length&&(x=this.activity.logo.tupletRhythms.length-this._lyrics.length,this._lyrics=this._lyrics.concat(Array(x).fill(""))):this._lyrics=Array(this.activity.logo.tupletRhythms.length).fill("");for(var M=0;M<this.activity.logo.tupletRhythms.length;M++)!function(e){var t=s.activity.logo.tupletRhythms[e][2],l=S.insertCell();l.style.height=Math.floor(MATRIXSOLFEHEIGHT*s._cellScale)+1+"px",l.style.width=s._noteWidth(t)+"px",l.style.minWidth=l.style.width,l.style.maxWidth=l.style.width,l.style.backgroundColor=platformColor.lyricsInputBackground,l.style.fontFamily="sans-serif",l.style.cursor="default",l.style.borderSpacing="1px 1px",l.style.borderCollapse="collapse",l.style.boxSizing="border-box",l.style.padding="0",l.style.borderRadius="6px",l.style.border="none",l.setAttribute("alt",e+"__graphicsblocks2");var i=document.createElement("input");i.type="text",i.value=s._lyrics[e],i.style.height=l.style.height,i.style.width="100%",i.style.minWidth=l.style.minWidth,i.style.maxWidth=l.style.maxWidth,i.style.fontSize="inherit",i.style.fontFamily="sans-serif",i.style.cursor="default",i.style.boxSizing="border-box",i.style.padding="0",i.style.border="none",i.style.borderRadius="6px",i.style.backgroundColor=platformColor.lyricsInputBackground,l.appendChild(i),l.addEventListener("mouseover",function(t){t.target.style.backgroundColor=platformColor.selectorSelected}),l.addEventListener("mouseout",function(t){t.target.style.backgroundColor=platformColor.lyricsInputBackground}),i.addEventListener("focus",function(){return s.activity.isInputON=!0}),i.addEventListener("blur",function(){return s.activity.isInputON=!1}),i.addEventListener("input",function(t){s._lyrics[e]=t.target.value})}(M);I.insertCell().appendChild(e)}p=(n=y.insertRow()).insertCell(),n.setAttribute("id","bottomRow"),n.style.position="sticky",n.style.bottom="0px",n.style.zIndex="1",p.setAttribute("colspan","2"),p.style.position="sticky",p.style.left="1.2px",p.style.zIndex="1",p.className="headcol",(e=document.createElement("table")).setAttribute("cellpadding","0px"),p.append(e),this._tupletNoteLabel=null,this._tupletValueLabel=null,this._tupletNoteValueLabel=null,this._tupletNoteLabel=e.insertRow().insertCell(),this._tupletValueLabel=e.insertRow().insertCell(),this._noteValueLabel=e.insertRow().insertCell(),this._noteValueLabel.innerHTML=_("note value"),this._noteValueLabel.style.fontSize=75*this._cellScale+"%",this._noteValueLabel.style.height=Math.floor(1.5*MATRIXSOLFEHEIGHT*this._cellScale)+"px",this._noteValueLabel.style.width=Math.floor(2*MATRIXSOLFEWIDTH*this._cellScale)+"px",this._noteValueLabel.style.minWidth=this._noteValueLabel.style.width,this._noteValueLabel.style.maxWidth=this._noteValueLabel.style.width,this._noteValueLabel.style.backgroundColor=platformColor.labelColor,(e=document.createElement("table")).setAttribute("cellpadding","0px"),this._tupletNoteValueRow=e.insertRow(),this._tupletValueRow=e.insertRow(),this._noteValueRow=e.insertRow(),n.insertCell().append(e),void 0===this._blockMap[this.blockNo]&&(this._blockMap[this.blockNo]=[]),this._lookForNoteBlocksOrRepeat(),this.sorted?this.sorted=!1:setTimeout(function(){s._sort()},1e3),this.isInitial&&(t.textMsg(_("Click on the table to add notes."),3e3),this.widgetWindow.sendToCenter(),this.inInitial=!1)}},{key:"_createAddRowPieSubmenu",value:function(){var r=this;docById("wheelDivptm").style.display="";for(var u,p=["pitch","hertz","drum","graphics","pen"],t=["imgsrc: images/chime.svg","imgsrc: images/synth.svg","imgsrc: images/TamTamMini.svg","imgsrc: images/mouse.svg","imgsrc: images/pen.svg"],e=[],l=0;l<t.length;l++)u=_(t[l]),e.push(u);for(var d=[],i=0;i<MATRIXGRAPHICS.length;i++)d.push(MATRIXGRAPHICS[i]);for(var s=0;s<MATRIXGRAPHICS2.length;s++)d.push(MATRIXGRAPHICS2[s]);this._menuWheel=new wheelnav("wheelDivptm",null,200,200),this._exitWheel=new wheelnav("_exitWheel",this._menuWheel.raphael),wheelnav.cssMode=!0,this._menuWheel.keynavigateEnabled=!1,this._menuWheel.slicePathFunction=slicePath().DonutSlice,this._menuWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._menuWheel.colors=[platformColor.paletteColors.pitch[0],platformColor.paletteColors.pitch[1],platformColor.paletteColors.drum[0],platformColor.paletteColors.turtle[0],platformColor.paletteColors.turtle[1]],this._menuWheel.slicePathCustom.minRadiusPercent=.3,this._menuWheel.slicePathCustom.maxRadiusPercent=1,this._menuWheel.sliceSelectedPathCustom=this._menuWheel.slicePathCustom,this._menuWheel.sliceInitPathCustom=this._menuWheel.slicePathCustom,this._menuWheel.clickModeRotate=!1,this._menuWheel.animatetime=0,this._menuWheel.createWheel(e),this._menuWheel.navItems[0].setTooltip(_("pitch")),this._menuWheel.navItems[1].setTooltip(_("hertz")),this._menuWheel.navItems[2].setTooltip(_("drum")),this._menuWheel.navItems[3].setTooltip(_("graphics")),this._menuWheel.navItems[4].setTooltip(_("pen")),this._exitWheel.colors=platformColor.exitWheelcolors,this._exitWheel.slicePathFunction=slicePath().DonutSlice,this._exitWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._exitWheel.slicePathCustom.minRadiusPercent=0,this._exitWheel.slicePathCustom.maxRadiusPercent=.25,this._exitWheel.sliceSelectedPathCustom=this._exitWheel.slicePathCustom,this._exitWheel.sliceInitPathCustom=this._exitWheel.slicePathCustom,this._exitWheel.clickModeRotate=!1,this._exitWheel.createWheel(["Ã—"," "]);var o=docById("addnotes").getBoundingClientRect().x,a=docById("addnotes").getBoundingClientRect().y;docById("wheelDivptm").style.position="absolute",docById("wheelDivptm").style.height="300px",docById("wheelDivptm").style.width="300px",docById("wheelDivptm").style.left=Math.min(this.activity.canvas.width-200,Math.max(0,o*this.activity.getStageScale()))+"px",docById("wheelDivptm").style.top=Math.min(this.activity.canvas.height-250,Math.max(0,a*this.activity.getStageScale()))+"px",this._exitWheel.navItems[0].navigateFunction=function(){docById("wheelDivptm").style.display="none",r._menuWheel.removeWheel(),r._exitWheel.removeWheel()};for(var n=function(){!function(){u=p[r._menuWheel.selectedNavItemIndex];var t=null,e=null,l=r.activity.blocks.blockList.length;switch(u){case"pitch":r.activity.blocks.loadNewBlocks([[0,["pitch",{}],0,0,[null,1,2,null]],[1,["solfege",{value:"sol"}],0,0,[0]],[2,["number",{value:4}],0,0,[0]]]),t="sol",e=4;break;case"hertz":r.activity.blocks.loadNewBlocks([[0,["hertz",{}],0,0,[null,1,null]],[1,["number",{value:392}],0,0,[0]]]),t="hertz",e=392;break;case"drum":r.activity.blocks.loadNewBlocks([[0,["playdrum",{}],0,0,[null,1,null]],[1,["drumname",{value:DEFAULTDRUM}],0,0,[0]]]),t="",e=-1;break;case"graphics":r.activity.blocks.loadNewBlocks([[0,["forward",{}],0,0,[null,1,null]],[1,["number",{value:100}],0,0,[0]]]),t="forward",e=100;break;case"pen":r.activity.blocks.loadNewBlocks([[0,["setcolor",{}],0,0,[null,1,null]],[1,["number",{value:0}],0,0,[0]]]),t="setcolor",e=0;break;default:console.debug(u+" not found")}var i,s,o=null,a=null;switch(u){case"graphics":case"pen":for(var n=d.length-1;0<=n;n--)if(1<=(o=r._mapNotesBlocks(d[n])).length){a=last(o);break}break;case"drum":1<=(o=r._mapNotesBlocks("playdrum")).length&&(a=last(o));break;case"hertz":1<=(o=r._mapNotesBlocks("hertz")).length&&(a=last(o));break;case"pitch":1<=(o=r._mapNotesBlocks("pitch")).length&&(a=last(o))}if(null===a&&(1<=(o=r._mapNotesBlocks("pitch")).length&&(a=last(o)),null===a&&(a=r.blockNo)),a===r.blockNo)setTimeout(r._addNotesBlockBetween(a,l,!0),500),r.rowLabels.splice(0,0,t),r.rowArgs.splice(0,0,e),r._rowBlocks.splice(0,0,l);else{for(setTimeout(r._addNotesBlockBetween(a,l,!1),500),i=0;i<r.columnBlocksMap.length&&r.columnBlocksMap[i][0]!==a;i++);r.rowLabels.splice(i+1,0,t),r.rowArgs.splice(i+1,0,e),r._rowBlocks.splice(i+1,0,l)}r.sorted=!1,r.init(r.activity);for(var h=0;h<r.activity.logo.tupletRhythms.length;h++)switch(r.activity.logo.tupletRhythms[h][0]){case"simple":case"notes":(s=[r.activity.logo.tupletParams[r.activity.logo.tupletRhythms[h][1]]]).push([]);for(var c=2;c<r.activity.logo.tupletRhythms[h].length;c++)s[1].push(r.activity.logo.tupletRhythms[h][c]);r.addTuplet(s);break;default:r.addNotes(r.activity.logo.tupletRhythms[h][1],r.activity.logo.tupletRhythms[h][2])}r.makeClickable(),"pitch"===u&&setTimeout(function(){r.pitchBlockAdded(l)},200)}()},h=0;h<e.length;h++)this._menuWheel.navItems[h].navigateFunction=n}},{key:"pitchBlockAdded",value:function(t){for(var e=0;e<this.columnBlocksMap.length&&this.columnBlocksMap[e][0]!==t;e++);setTimeout(this._createColumnPieSubmenu(e,"pitchblocks",!0),500)}},{key:"_createMatrixGraphics2PieSubmenu",value:function(r,t){var u=this;docById("wheelDivptm").style.display="";var e=["10","20","30","40","50","60","70","80","90","100"],l=["0","30","45","60","90","180"],i=["-200","-100","0","100","200"];this._pitchWheel=new wheelnav("wheelDivptm",null,600,600),this._exitWheel=new wheelnav("_exitWheel",this._pitchWheel.raphael),this._blockLabelsWheel=new wheelnav("_blockLabelsWheel",this._pitchWheel.raphael),this._blockLabelsWheel2=new wheelnav("_blockLabelsWheel2",this._pitchWheel.raphael);for(var p=MATRIXGRAPHICS2.slice(),s=[],o=0;o<p.length;o++)s.push(this.activity.blocks.protoBlockDict[p[o]].staticLabels[0]);wheelnav.cssMode=!0,this._pitchWheel.keynavigateEnabled=!1,this._pitchWheel.slicePathFunction=slicePath().DonutSlice,this._pitchWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._pitchWheel.colors=platformColor.blockLabelsWheelcolors,this._pitchWheel.slicePathCustom.minRadiusPercent=.2,this._pitchWheel.slicePathCustom.maxRadiusPercent=.475,this._pitchWheel.sliceSelectedPathCustom=this._pitchWheel.slicePathCustom,this._pitchWheel.sliceInitPathCustom=this._pitchWheel.slicePathCustom,this._pitchWheel.clickModeRotate=!1,this._pitchWheel.animatetime=0,this._blockLabelsWheel2.colors=platformColor.blockLabelsWheelcolors,this._blockLabelsWheel2.slicePathFunction=slicePath().DonutSlice,this._blockLabelsWheel2.slicePathCustom=slicePath().DonutSliceCustomization(),this._blockLabelsWheel2.slicePathCustom.minRadiusPercent=.525,this._blockLabelsWheel2.slicePathCustom.maxRadiusPercent=.8,this._blockLabelsWheel2.sliceSelectedPathCustom=this._blockLabelsWheel2.slicePathCustom,this._blockLabelsWheel2.sliceInitPathCustom=this._blockLabelsWheel2.slicePathCustom,this._blockLabelsWheel2.clickModeRotate=!1,this._blockLabelsWheel2.animatetime=0,this._exitWheel.colors=platformColor.exitWheelcolors,this._exitWheel.slicePathFunction=slicePath().DonutSlice,this._exitWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._exitWheel.slicePathCustom.minRadiusPercent=0,this._exitWheel.slicePathCustom.maxRadiusPercent=.2,this._exitWheel.sliceSelectedPathCustom=this._exitWheel.slicePathCustom,this._exitWheel.sliceInitPathCustom=this._exitWheel.slicePathCustom,this._exitWheel.clickModeRotate=!1,this._blockLabelsWheel.colors=platformColor.graphicWheelcolors,this._blockLabelsWheel.slicePathFunction=slicePath().DonutSlice,this._blockLabelsWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._blockLabelsWheel.slicePathCustom.minRadiusPercent=.8,this._blockLabelsWheel.slicePathCustom.maxRadiusPercent=1,this._blockLabelsWheel.sliceSelectedPathCustom=this._blockLabelsWheel.slicePathCustom,this._blockLabelsWheel.sliceInitPathCustom=this._blockLabelsWheel.slicePathCustom,this._blockLabelsWheel.clickModeRotate=!1,this._blockLabelsWheel.titleRotateAngle=90,this._blockLabelsWheel.animatetime=0,this._blockLabelsWheel.createWheel(s);var a=this._labelcols[r].getBoundingClientRect().x,n=this._labelcols[r].getBoundingClientRect().y;docById("wheelDivptm").style.position="absolute",docById("wheelDivptm").style.height="300px",docById("wheelDivptm").style.width="300px",docById("wheelDivptm").style.left=Math.min(this.activity.canvas.width-200,Math.max(0,a*this.activity.getStageScale()))+"px",docById("wheelDivptm").style.top=Math.min(this.activity.canvas.height-250,Math.max(0,n*this.activity.getStageScale()))+"px";var d=this.columnBlocksMap[r][0];null!==t&&(d=t);var h=this.activity.blocks.blockList[d].name,c=this.activity.blocks.blockList[this.activity.blocks.blockList[d].connections[1]].value,b=this.activity.blocks.blockList[this.activity.blocks.blockList[d].connections[2]].value;"arc"===h?(this._blockLabelsWheel2.createWheel(l),this._pitchWheel.createWheel(e)):"setxy"===h&&(this._blockLabelsWheel2.createWheel(i),this._pitchWheel.createWheel(i)),this._blockLabelsWheel.navigateWheel(p.indexOf(h)),this.xblockValue=[c.toString(),"x"],this.yblockValue=[b.toString(),"y"],this._exitWheel.createWheel(["Ã—",""]),this._exitWheel.navItems[0].navigateFunction=function(){docById("wheelDivptm").style.display="none",u._pitchWheel.removeWheel(),u._exitWheel.removeWheel(),u._blockLabelsWheel.removeWheel(),u._blockLabelsWheel2.removeWheel()};function y(){u.xblockValue[0]=u._blockLabelsWheel2.navItems[u._blockLabelsWheel2.selectedNavItemIndex].title,k(!0)}function m(){u.yblockValue[0]=u._pitchWheel.navItems[u._pitchWheel.selectedNavItemIndex].title,k(!0)}if("arc"===h){for(var v=0;v<l.length;v++)this._blockLabelsWheel2.navItems[v].navigateFunction=y;for(var _=0;_<e.length;_++)this._pitchWheel.navItems[_].navigateFunction=m}else if("setxy"===h)for(var g=0;g<i.length;g++)this._blockLabelsWheel2.navItems[g].navigateFunction=y,this._pitchWheel.navItems[g].navigateFunction=m;for(var k=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var l,i,s,o,a,n,h,c;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(l=p[u._blockLabelsWheel.selectedNavItemIndex],void 0===e)return o=u.activity.blocks.blockList.length,u.activity.blocks.loadNewBlocks([[0,l,0,0,[null,1,2,null]],[1,["number",{value:parseInt(u.xblockValue[0])}],0,0,[0]],[2,["number",{value:parseInt(u.yblockValue[0])}],0,0,[0]]]),t.next=6,delayExecution(500);t.next=12;break;case 6:u._blockReplace(d,o),u.columnBlocksMap[r][0]=o,d=o,u._createMatrixGraphics2PieSubmenu(r,o),t.next=24;break;case 12:i=u.activity.blocks.blockList[d].connections[1],u.activity.blocks.blockList[i].text.text=u.xblockValue[0],u.activity.blocks.blockList[i].value=parseInt(u.xblockValue[0]),s=u.activity.blocks.blockList[i].container.children.length-1,u.activity.blocks.blockList[i].container.setChildIndex(u.activity.blocks.blockList[i].text,s),u.activity.blocks.blockList[i].updateCache(),i=u.activity.blocks.blockList[d].connections[2],u.activity.blocks.blockList[i].text.text=u.yblockValue[0],u.activity.blocks.blockList[i].value=parseInt(u.yblockValue[0]),s=u.activity.blocks.blockList[i].container.children.length-1,u.activity.blocks.blockList[i].container.setChildIndex(u.activity.blocks.blockList[i].text,s),u.activity.blocks.blockList[i].updateCache();case 24:u.rowLabels[r]=l,u.rowArgs[r][0]=parseInt(u.xblockValue),u.rowArgs[r][1]=parseInt(u.yblockValue),n=u._headcols[r],h=P.ICONSIZE*(window.innerWidth/1200),MATRIXGRAPHICS2.includes(u.rowLabels[r])&&(n.innerHTML='&nbsp;&nbsp;<img \n                        src="images/mouse.svg" \n                        height="'.concat(h,'" \n                        width="').concat(h,'" \n                        vertical-align="middle"\n                    >&nbsp;&nbsp;')),n=u._labelcols[r],MATRIXGRAPHICS2.includes(u.rowLabels[r])&&(a=u.activity.blocks.protoBlockDict[u.rowLabels[r]].staticLabels[0],n.innerHTML="".concat(a,"<br>").concat(u.rowArgs[r][0]," ").concat(u.rowArgs[r][1]),n.style.fontSize=Math.floor(12*u._cellScale)+"px"),c=u.rowLabels[r]+": "+u.rowArgs[r][0]+": "+u.rowArgs[r][1],u._noteStored[r]=c;case 34:case"end":return t.stop()}},t)}));return function(t){return e.apply(this,arguments)}}(),f=0;f<s.length;f++)this._blockLabelsWheel.navItems[f].navigateFunction=k}},{key:"_createMatrixGraphicsPieSubmenu",value:function(r,u,t){var e,l,i,s,o,a,p,d,b,y,n,m=this;if(docById("wheelDivptm").style.display="","synthsblocks"===u?e=["261","294","327","348","392","436","490","523"]:(e=["50","90","100","150","180","200","250","270","300","350","360"],l=["1","5","10","25","50","100","200"],i=["15","30","45","60","90","180"],s=["0","45","90","135","180","225","270","315"],o=["1","5","10","25","50"],a=["0","10","20","30","40","5n0","60","70","80","90","100"]),this._pitchWheel=new wheelnav("wheelDivptm",null,800,800),this._exitWheel=new wheelnav("_exitWheel",this._pitchWheel.raphael),"graphicsblocks"===u){this._blockLabelsWheel=new wheelnav("_blockLabelsWheel",this._pitchWheel.raphael),p=[],d=[],b=[],y=[];for(var h=0;h<5;h++)n=MATRIXGRAPHICS[h],p.push(n),d.push(this.activity.blocks.protoBlockDict[n].staticLabels[0]);for(var c=5;c<MATRIXGRAPHICS.length;c++)n=MATRIXGRAPHICS[c],b.push(n),y.push(this.activity.blocks.protoBlockDict[n].staticLabels[0])}wheelnav.cssMode=!0,this._pitchWheel.keynavigateEnabled=!1,this._pitchWheel.slicePathFunction=slicePath().DonutSlice,this._pitchWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._pitchWheel.colors=platformColor.blockLabelsWheelcolors,this._pitchWheel.slicePathCustom.minRadiusPercent=.525,this._pitchWheel.slicePathCustom.maxRadiusPercent=.8,this._pitchWheel.sliceSelectedPathCustom=this._pitchWheel.slicePathCustom,this._pitchWheel.sliceInitPathCustom=this._pitchWheel.slicePathCustom,this._pitchWheel.clickModeRotate=!1,this._pitchWheel.animatetime=0,this._exitWheel.colors=platformColor.exitWheelcolors,this._exitWheel.slicePathFunction=slicePath().DonutSlice,this._exitWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._exitWheel.slicePathCustom.minRadiusPercent=0,this._exitWheel.slicePathCustom.maxRadiusPercent=.2,this._exitWheel.sliceSelectedPathCustom=this._exitWheel.slicePathCustom,this._exitWheel.sliceInitPathCustom=this._exitWheel.slicePathCustom,this._exitWheel.clickModeRotate=!1,"graphicsblocks"===u&&(this._blockLabelsWheel.colors=platformColor.graphicWheelcolors,this._blockLabelsWheel.slicePathFunction=slicePath().DonutSlice,this._blockLabelsWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._blockLabelsWheel.slicePathCustom.minRadiusPercent=.8,this._blockLabelsWheel.slicePathCustom.maxRadiusPercent=1,this._blockLabelsWheel.sliceSelectedPathCustom=this._blockLabelsWheel.slicePathCustom,this._blockLabelsWheel.sliceInitPathCustom=this._blockLabelsWheel.slicePathCustom,this._blockLabelsWheel.clickModeRotate=!1,this._blockLabelsWheel.titleRotateAngle=90,this._blockLabelsWheel.animatetime=0);var v=this._labelcols[r].getBoundingClientRect().x,_=this._labelcols[r].getBoundingClientRect().y;docById("wheelDivptm").style.position="absolute",docById("wheelDivptm").style.height="300px",docById("wheelDivptm").style.width="300px",docById("wheelDivptm").style.left=Math.min(this.activity.canvas.width-200,Math.max(0,v*this.activity.getStageScale()))+"px",docById("wheelDivptm").style.top=Math.min(this.activity.canvas.height-250,Math.max(0,_*this.activity.getStageScale()))+"px";var g=this.columnBlocksMap[r][0];null!==t&&(g=t);var k=this.activity.blocks.blockList[g].name,f=this.activity.blocks.blockList[this.activity.blocks.blockList[g].connections[1]].value;"graphicsblocks"===u?"forward"===k||"back"===k?(this._pitchWheel.createWheel(l),this._blockLabelsWheel.createWheel(d)):"right"===k||"left"===k?(this._pitchWheel.createWheel(i),this._blockLabelsWheel.createWheel(d)):"setheading"===k?(this._pitchWheel.createWheel(s),this._blockLabelsWheel.createWheel(d)):("setpensize"===k?this._pitchWheel.createWheel(o):this._pitchWheel.createWheel(a),this._blockLabelsWheel.createWheel(y)):"synthsblocks"===u&&this._pitchWheel.createWheel(e),this.blockValue=f.toString(),this._exitWheel.createWheel(["Ã—",""]),this._exitWheel.navItems[0].navigateFunction=function(){docById("wheelDivptm").style.display="none",m._pitchWheel.removeWheel(),m._exitWheel.removeWheel(),"graphicsblocks"===u&&m._blockLabelsWheel.removeWheel()};function w(){m.blockValue=m._pitchWheel.navItems[m._pitchWheel.selectedNavItemIndex].title,docById("wheelnav-_exitWheel-title-1").children[0].textContent=m.blockValue,lastIndex=m._pitchWheel.selectedNavItemIndex,L(!0)}var C;"graphicsblocks"===u?C="forward"===k||"back"===k?l.length:"right"===k||"left"===k?i.length:"setheading"===k?s.length:"setpensize"===k?o.length:a.length:"synthsblocks"===u&&(C=e.length);for(var W=0;W<C;W++)this._pitchWheel.navItems[W].navigateFunction=w;var L=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var l,i,s,o,a,n,h,c;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(l="hertz","graphicsblocks"===u&&(i=m._blockLabelsWheel.navItems[m._blockLabelsWheel.selectedNavItemIndex].title,-1===(n=d.indexOf(i))?-1!==(n=y.indexOf(i))&&(l=b[n]):l=p[n]),void 0===e)return s=m.activity.blocks.blockList.length,m.activity.blocks.loadNewBlocks([[0,l,0,0,[null,1,null]],[1,["number",{value:parseInt(m.blockValue)}],0,0,[0]]]),t.next=7,delayExecution(500);t.next=13;break;case 7:m._blockReplace(g,s),m.columnBlocksMap[r][0]=s,g=s,m._createMatrixGraphicsPieSubmenu(r,u,s),t.next=19;break;case 13:o=m.activity.blocks.blockList[g].connections[1],m.activity.blocks.blockList[o].text.text=m.blockValue,m.activity.blocks.blockList[o].value=parseInt(m.blockValue),a=m.activity.blocks.blockList[o].container.children.length-1,m.activity.blocks.blockList[o].container.setChildIndex(m.activity.blocks.blockList[o].text,a),m.activity.blocks.blockList[o].updateCache();case 19:m.rowLabels[r]=l,m.rowArgs[r]=parseInt(m.blockValue),h=m._headcols[r],c=P.ICONSIZE*(window.innerWidth/1200),MATRIXSYNTHS.includes(m.rowLabels[r])?h.innerHTML='&nbsp;&nbsp;<img \n                        src="images/synth2.svg" \n                        height="'.concat(c,'" \n                        width="').concat(c,'" \n                        vertical-align="middle"\n                    >&nbsp;&nbsp;'):MATRIXGRAPHICS.includes(m.rowLabels[r])&&(h.innerHTML='&nbsp;&nbsp;<img \n                        src="images/mouse.svg" \n                        height="'.concat(c,'" \n                        width="').concat(c,'" \n                        vertical-align="middle"\n                    >&nbsp;&nbsp;')),h=m._labelcols[r],MATRIXSYNTHS.includes(m.rowLabels[r])?(h.innerHTML=m.rowArgs[r],h.style.fontSize=Math.floor(14*m._cellScale)+"px"):MATRIXGRAPHICS.includes(m.rowLabels[r])&&(k=m.activity.blocks.protoBlockDict[m.rowLabels[r]].staticLabels[0],h.innerHTML="".concat(k,"<br>").concat(m.rowArgs[r]),h.style.fontSize=Math.floor(12*m._cellScale)+"px"),m._noteStored[r]=m.rowLabels[r]+": "+m.rowArgs[r];case 27:case"end":return t.stop()}},t)}));return function(t){return e.apply(this,arguments)}}();if("graphicsblocks"===u)if("forward"===k||"back"===k)for(var I=0;I<d.length;I++)this._blockLabelsWheel.navItems[I].navigateFunction=L;else if("right"===k||"left"===k)for(var x=0;x<d.length;x++)this._blockLabelsWheel.navItems[x].navigateFunction=L;else if("setheading"===k)for(var S=0;S<d.length;S++)this._blockLabelsWheel.navItems[S].navigateFunction=L;else if("setpensize"===k)for(var M=0;M<y.length;M++)this._blockLabelsWheel.navItems[M].navigateFunction=L;else for(var R=0;R<y.length;R++)this._blockLabelsWheel.navItems[R].navigateFunction=L;null!==lastIndex&&this._pitchWheel.navItems[lastIndex]&&this._pitchWheel.navigateWheel(lastIndex)}},{key:"_createColumnPieSubmenu",value:function(y,m,t){var v=this;y=parseInt(y),docById("wheelDivptm").style.display="";for(var e,l,i=["ð„ª","â™¯","â™®","â™­","ð„«"],g=["ti","la","sol","fa","mi","re","do"],s=[],o=0;o<DRUMS.length;o++)e=_(DRUMS[o]),s.push(e);var a=[];if("drumblocks"===m){g=s,l=[0,0,0,0,0,0,0,1,1,1,1,1,1,1,2,2,2,2];for(var n=platformColor.piemenuVoicesColors,h=0;h<s.length;h++)a.push(n[l[h]%n.length])}this._pitchWheel="drumblocks"===m?new wheelnav("wheelDivptm",null,1200,1200):new wheelnav("wheelDivptm",null,600,600),this._exitWheel=new wheelnav("_exitWheel",this._pitchWheel.raphael),"pitchblocks"===m&&(this._accidentalsWheel=new wheelnav("_accidentalsWheel",this._pitchWheel.raphael),this._octavesWheel=new wheelnav("_octavesWheel",this._pitchWheel.raphael)),wheelnav.cssMode=!0,this._pitchWheel.keynavigateEnabled=!1,this._pitchWheel.slicePathFunction=slicePath().DonutSlice,this._pitchWheel.slicePathCustom=slicePath().DonutSliceCustomization(),"pitchblocks"===m?(this._pitchWheel.colors=platformColor.pitchWheelcolors,this._pitchWheel.slicePathCustom.minRadiusPercent=.2,this._pitchWheel.slicePathCustom.maxRadiusPercent=.5):"drumblocks"===m&&(this._pitchWheel.titleRotateAngle=0,this._pitchWheel.colors=a,this._pitchWheel.slicePathCustom.minRadiusPercent=.2,this._pitchWheel.slicePathCustom.maxRadiusPercent=1),this._pitchWheel.sliceSelectedPathCustom=this._pitchWheel.slicePathCustom,this._pitchWheel.sliceInitPathCustom=this._pitchWheel.slicePathCustom,this._pitchWheel.animatetime=0,this._pitchWheel.createWheel(g),this._exitWheel.colors=platformColor.exitWheelcolors,this._exitWheel.slicePathFunction=slicePath().DonutSlice,this._exitWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._exitWheel.slicePathCustom.minRadiusPercent=0,this._exitWheel.slicePathCustom.maxRadiusPercent=.2,this._exitWheel.sliceSelectedPathCustom=this._exitWheel.slicePathCustom,this._exitWheel.sliceInitPathCustom=this._exitWheel.slicePathCustom,this._exitWheel.clickModeRotate=!1,this._exitWheel.createWheel(["Ã—"," "]);var k,c,r,u,p=[],d=[];if("pitchblocks"===m){this._accidentalsWheel.colors=platformColor.accidentalsWheelcolors,this._accidentalsWheel.slicePathFunction=slicePath().DonutSlice,this._accidentalsWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._accidentalsWheel.slicePathCustom.minRadiusPercent=.5,this._accidentalsWheel.slicePathCustom.maxRadiusPercent=.75,this._accidentalsWheel.sliceSelectedPathCustom=this._accidentalsWheel.slicePathCustom,this._accidentalsWheel.sliceInitPathCustom=this._accidentalsWheel.slicePathCustom;for(var b=0;b<i.length;b++)p.push(i[b]);for(var f=0;f<9;f++)p.push(null),this._accidentalsWheel.colors.push(platformColor.accidentalsWheelcolorspush);this._accidentalsWheel.animatetime=0,this._accidentalsWheel.createWheel(p),this._accidentalsWheel.setTooltips([_("double sharp"),_("sharp"),_("natural"),_("flat"),_("double flat")]),this._octavesWheel.colors=platformColor.octavesWheelcolors,this._octavesWheel.slicePathFunction=slicePath().DonutSlice,this._octavesWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._octavesWheel.slicePathCustom.minRadiusPercent=.75,this._octavesWheel.slicePathCustom.maxRadiusPercent=.95,this._octavesWheel.sliceSelectedPathCustom=this._octavesWheel.slicePathCustom,this._octavesWheel.sliceInitPathCustom=this._octavesWheel.slicePathCustom,d=["8","7","6","5","4","3","2","1",null,null,null,null,null,null],this._octavesWheel.animatetime=0,this._octavesWheel.createWheel(d)}var w=this._labelcols[y].getBoundingClientRect().x,C=this._labelcols[y].getBoundingClientRect().y;if(docById("wheelDivptm").style.position="absolute",docById("wheelDivptm").style.height="300px",docById("wheelDivptm").style.width="300px",docById("wheelDivptm").style.left=Math.min(this.activity.canvas.width-200,Math.max(0,w*this.activity.getStageScale()))+"px",docById("wheelDivptm").style.top=Math.min(this.activity.canvas.height-250,Math.max(0,C*this.activity.getStageScale()))+"px",!this._noteBlocks){if(k=this.columnBlocksMap[y][0],c=this.activity.blocks.blockList[this.activity.blocks.blockList[k].connections[1]].value,"pitchblocks"===m){r=this.activity.blocks.blockList[this.activity.blocks.blockList[k].connections[2]].value,u=2;for(var W=0;W<i.length;W++)if(c.includes(i[W])){u=W,c=c.substr(0,c.indexOf(i[W]));break}this._accidentalsWheel.navigateWheel(u),this._octavesWheel.navigateWheel(d.indexOf(r.toString()))}"drumblocks"===m?this._pitchWheel.navigateWheel(g.indexOf(docBySelector('.labelcol[alt="'+y+'__drumblocks"]').innerText)):this._pitchWheel.navigateWheel(g.indexOf(c))}this._exitWheel.navItems[0].navigateFunction=function(){docById("wheelDivptm").style.display="none",v._pitchWheel.removeWheel(),v._exitWheel.removeWheel(),"pitchblocks"===m&&(v._accidentalsWheel.removeWheel(),v._octavesWheel.removeWheel()),!(v.sorted=!1)===t&&v._sort()};for(var L=function(){var t,e,l,i,s=v._pitchWheel.navItems[v._pitchWheel.selectedNavItemIndex].title,o=0;"pitchblocks"===m?("â™®"!==(t=v._accidentalsWheel.navItems[v._accidentalsWheel.selectedNavItemIndex].title)&&(s+=t),e=Number(v._octavesWheel.navItems[v._octavesWheel.selectedNavItemIndex].title),(l=getNote(s,e,0,v.activity.turtles.ithTurtle(0).singer.keySignature,!1,null,v.activity.errorMsg,v.activity.logo.synth.inTemperament))[0]=l[0].replace(SHARP,"#").replace(FLAT,"b"),v.activity.logo.synth.setMasterVolume(PREVIEWVOLUME),Singer.setSynthVolume(v.activity.logo,0,DEFAULTVOICE,PREVIEWVOLUME),v.activity.logo.synth.trigger(0,[l[0]+l[1]],1/8,DEFAULTVOICE,null,null)):"drumblocks"===m&&(o=0!==(i=v.activity.turtles.ithTurtle(0)).singer.instrumentNames.length&&i.singer.instrumentNames.includes(s)?0:(i.singer.instrumentNames.push(s),s===DEFAULTVOICE&&v.activity.logo.synth.createDefaultSynth(0),v.activity.logo.synth.loadSynth(0,s),500),setTimeout(function(){v.activity.logo.synth.setMasterVolume(DEFAULTVOLUME),Singer.setSynthVolume(v.activity.logo,0,s,DEFAULTVOLUME),v.activity.logo.synth.trigger(0,"G4",.25,s,null,null,!1),v.activity.logo.synth.start()},o)),function(){var t,e,l,i,s,o,a=v._pitchWheel.navItems[v._pitchWheel.selectedNavItemIndex].title,n=g.indexOf(a);"pitchblocks"===m&&(e=!1,"â™®"!==(t=v._accidentalsWheel.navItems[v._accidentalsWheel.selectedNavItemIndex].title)&&(a+=t,e=!0),v.sorted=!1),v._noteBlocks||(i=v.activity.blocks.blockList[k].connections[1],v.activity.blocks.blockList[i].text.text=a,v.activity.blocks.blockList[i].value=a,l=v.activity.blocks.blockList[i].container.children.length-1,v.activity.blocks.blockList[i].container.setChildIndex(v.activity.blocks.blockList[i].text,l),v.activity.blocks.blockList[i].updateCache()),"pitchblocks"===m?(s=Number(v._octavesWheel.navItems[v._octavesWheel.selectedNavItemIndex].title),v._noteBlocks||v.activity.blocks.blockList[i].blocks.setPitchOctave(v.activity.blocks.blockList[i].connections[0],s),o=[a,s],e&&(o=getNote(a,s,0,v.activity.turtles.ithTurtle(0).singer.keySignature,!1,null,v.activity.errorMsg,v.activity.logo.synth.inTemperament)),v.rowLabels[y]=o[0],v.rowArgs[y]=o[1]):"drumblocks"===m&&(v.rowLabels[y]=a);var h=v._headcols[y],c=getDrumName(v.rowLabels[y]),r={C:1,D:2,E:3,F:4,G:5,A:6,B:7,do:1,re:2,mi:3,fa:4,sol:5,la:6,ti:7},u=v.rowLabels[y],p=window.innerWidth,d=P.ICONSIZE*(p/1200);null!=c?h.innerHTML='&nbsp;&nbsp;<img \n                        src="'.concat(getDrumIcon(c),'" \n                        title="').concat(_(c),'" \n                        alt="').concat(_(c),'" \n                        height="').concat(d,'" \n                        width="').concat(d,'" \n                        vertical-align="middle"\n                    >&nbsp;&nbsp;'):u in r&&4===v.rowArgs[y]?h.innerHTML='<img \n                        src="images/8_bellset_key_'.concat(r[u],'.svg" \n                        width="').concat(h.style.width,'" \n                        vertical-align="middle"\n                    >'):"C"===u&&5===v.rowArgs[y]&&(h.innerHTML='<img \n                        src="images/8_bellset_key_8.svg" \n                        width="'.concat(h.style.width,'" \n                        vertical-align="middle"\n                    >')),h=v._labelcols[y],null!=c?(h.innerHTML=_(c),h.style.fontSize=Math.floor(14*v._cellScale)+"px"):noteIsSolfege(v.rowLabels[n])&&!isCustomTemperament(v.activity.logo.synth.inTemperament)?(h.innerHTML="".concat(i18nSolfege(v.rowLabels[y])).concat(v.rowArgs[y].toString().sub()),o=getNote(v.rowLabels[y],v.rowArgs[y],0,v.activity.turtles.ithTurtle(0).singer.keySignature,!1,null,v.activity.errorMsg,v.activity.logo.synth.inTemperament)):isCustomTemperament(v.activity.logo.synth.inTemperament)?(o=getNote(v.rowLabels[n],v.rowArgs[n],0,v.activity.turtles.ithTurtle(0).singer.keySignature,!1,null,v.activity.errorMsg,v.activity.logo.synth.inTemperament),h.innerHTML="".concat(v.rowLabels[n]).concat(v.rowArgs[n].toString().sub())):(h.innerHTML="".concat(v.rowLabels[n]).concat(v.rowArgs[n].toString().sub()),o=[v.rowLabels[n],v.rowArgs[n]]);var b=null;"pitchblocks"===m?b=o[0]+o[1]:"drumblocks"===m&&(b=c),v._noteStored[y]=b}()},I=0;I<g.length;I++)this._pitchWheel.navItems[I].navigateFunction=L;if("pitchblocks"===m){for(var x=0;x<i.length;x++)this._accidentalsWheel.navItems[x].navigateFunction=L;for(var S=0;S<8;S++)this._octavesWheel.navItems[S].navigateFunction=L}}},{key:"_blockReplace",value:function(t,e){var l=this.activity.blocks.blockList[t].connections[0],i=last(this.activity.blocks.blockList[t].connections);if(this.activity.blocks.blockList[e].connections[0]=l,this.activity.blocks.blockList[e].connections[this.activity.blocks.blockList[e].connections.length-1]=i,null!=l){for(var s=0;s<this.activity.blocks.blockList[l].connections.length;s++)if(this.activity.blocks.blockList[l].connections[s]===t){this.activity.blocks.blockList[l].connections[s]=e;break}for(var o=l;o!==this.blockNo;)this.activity.blocks.blockList[o].isClampBlock()&&this.activity.blocks.clampBlocksToCheck.push([o,0]),o=this.activity.blocks.blockList[o].connections[0];this.activity.blocks.clampBlocksToCheck.push([this.blockNo,0])}if(null!=i)for(var a=0;a<this.activity.blocks.blockList[i].connections.length;a++)if(this.activity.blocks.blockList[i].connections[a]===t){this.activity.blocks.blockList[i].connections[a]=e;break}this.activity.blocks.adjustDocks(l,!0),this.activity.blocks.blockList[t].connections[0]=null,this.activity.blocks.blockList[t].connections[this.activity.blocks.blockList[t].connections.length-1]=null,this.activity.blocks.sendStackToTrash(this.activity.blocks.blockList[t]),this.activity.refreshCanvas()}},{key:"_addNotesBlockBetween",value:function(t,e,l){var i;l?(i=this.activity.blocks.blockList[t].connections[1],this.activity.blocks.blockList[t].connections[1]=e):(i=last(this.activity.blocks.blockList[t].connections),this.activity.blocks.blockList[t].connections[this.activity.blocks.blockList[t].connections.length-1]=e),this.activity.blocks.blockList[i].connections[0]=e,this.activity.blocks.blockList[e].connections[0]=t,this.activity.blocks.blockList[e].connections[this.activity.blocks.blockList[e].connections.length-1]=i,this.activity.blocks.adjustDocks(this.blockNo,!0),this.activity.blocks.clampBlocksToCheck.push([this.blockNo,0]),this.activity.refreshCanvas()}},{key:"_removePitchBlock",value:function(t){var e=this.activity.blocks.blockList[t].connections[0],l=last(this.activity.blocks.blockList[t].connections);this.activity.blocks.blockList[e].connections[this.activity.blocks.blockList[e].connections.length-1]=l,this.activity.blocks.blockList[l].connections[0]=e,this.activity.blocks.blockList[t].connections[this.activity.blocks.blockList[t].connections.length-1]=null,this.activity.blocks.sendStackToTrash(this.activity.blocks.blockList[t]),this.activity.blocks.adjustDocks(this.blockNo,!0),this.activity.blocks.clampBlocksToCheck.push([this.blockNo,0]),this.activity.refreshCanvas()}},{key:"_generateDataURI",value:function(t){return"data: text/html;charset=utf-8, "+encodeURIComponent(t)}},{key:"_sort",value:function(){if(!this.sorted){var t,e,l;this._markedColsInRow=[];for(var i=0;i<this.rowLabels.length;i++){t=[],l=(e=this._rows[i]).cells.length;for(var s=0;s<l;s++)"black"===e.cells[s].style.backgroundColor&&t.push(s);this._markedColsInRow.push(t)}for(var o,a=new Set,n=[],h=0;h<this.rowLabels.length;h++){"rest"!==this.rowLabels[h].toLowerCase()&&null==getDrumName(this.rowLabels[h])&&(MATRIXGRAPHICS.includes(this.rowLabels[h])||MATRIXGRAPHICS2.includes(this.rowLabels[h])||(o=noteToFrequency(this.rowLabels[h]+this.rowArgs[h],this.activity.turtles.ithTurtle(0).singer.keySignature),a.has(o)||(n.push([o,this.rowLabels[h],this.rowArgs[h],h,this._noteStored[h]]),a.add(o))))}for(var c,r=0;r<this.rowLabels.length;r++)null!=getDrumName(this.rowLabels[r])&&n.push([-1*r,this.rowLabels[r],this.rowArgs[r],r,this._noteStored[r]]);for(var u=0;u<this.rowLabels.length;u++)MATRIXGRAPHICS.includes(this.rowLabels[u])?(c=MATRIXGRAPHICS.indexOf(this.rowLabels[u])+100,n.push([-c,this.rowLabels[u],this.rowArgs[u],u,this._noteStored[u]])):MATRIXGRAPHICS2.includes(this.rowLabels[u])&&(c=MATRIXGRAPHICS.indexOf(this.rowLabels[u])+200,n.push([-c,this.rowLabels[u],this.rowArgs[u],u,this._noteStored[u]]));var p=(p=n.sort(function(t,e){return t[0]-e[0]})).reverse();this.rowLabels=[],this.rowArgs=[],this._sortedRowMap=[],this._rowMapper=[];for(var d=0;d<p.length;d++)this._rowMapper.push(p[d][3]);for(var b=[],y=this.columnBlocksMap,m=0;m<this._rowMapper.length;m++)b.push(this.columnBlocksMap[this._rowMapper[m]]);this.columnBlocksMap=b;for(var v,_,g=0,k=0;k<p.length;k++){if(v=p[k],this._rowMap[v[3]]=k,this._noteStored[k]=v[4],0===k)this._sortedRowMap.push(0);else{if(0<k&&"hertz"!==v[1]&&v[1]===last(this.rowLabels)){console.debug("skipping "+v[1]+" "+last(this.rowLabels)),this._sortedRowMap.push(last(this._sortedRowMap)),null!=y[p[g][3]]&&(setTimeout(this._removePitchBlock(y[p[g][3]][0]),500),this.columnBlocksMap=this.columnBlocksMap.filter(function(t){return t[0]!==y[p[g][3]][0]}),g=k);for(var f=this._rowMap[k];f<this._rowMap.length;f++)--this._rowOffset[f];this._rowMap[k]=this._rowMap[k-1];continue}console.debug("pushing "+v[1]+" "+last(this.rowLabels)),this._sortedRowMap.push(last(this._sortedRowMap)+1),g=k,this.stylePhraseMaker()}this.rowLabels.push(v[1]),this.rowArgs.push(Number(v[2]))}this._matrixHasTuplets=!1,this.sorted=!0,this.init(this.activity),this.sorted=!0;for(var w=0;w<this.activity.logo.tupletRhythms.length;w++)switch(this.activity.logo.tupletRhythms[w][0]){case"simple":case"notes":(_=[this.activity.logo.tupletParams[this.activity.logo.tupletRhythms[w][1]]]).push([]);for(var C=2;C<this.activity.logo.tupletRhythms[w].length;C++)_[1].push(this.activity.logo.tupletRhythms[w][C]);this.addTuplet(_);break;default:this.addNotes(this.activity.logo.tupletRhythms[w][1],this.activity.logo.tupletRhythms[w][2])}this.makeClickable()}}},{key:"_export",value:function(){var t=window.open("").document;if(void 0!==t){var e=t.createElement("title");e.innerHTML="Music Matrix",t.head.appendChild(e);var l=t.createElement("H3");l.innerHTML="Music Matrix",t.body.appendChild(l);var i=t.createElement("TABLE");i.setAttribute("id","exportTable"),i.style.textAlign="center",t.body.appendChild(i);for(var s,o,a,n,h,c,r,u=t.getElementById("exportTable").createTHead(),p=0;p<this.rowLabels.length;p++){s=(o=u.insertRow()).insertCell(),null!=(a=getDrumName(this.rowLabels[p]))?(s.innerHTML=_(a),s.style.fontSize=Math.floor(14*this._cellScale)+"px"):"http"===this.rowLabels[p].slice(0,4)?(s.innerHTML=this.rowLabels[p],s.style.fontSize=Math.floor(14*this._cellScale)+"px"):MATRIXSYNTHS.includes(this.rowLabels[p])?(s.innerHTML=this.rowArgs[p],s.style.fontSize=Math.floor(14*this._cellScale)+"px"):MATRIXGRAPHICS.includes(this.rowLabels[p])?(n=this.activity.blocks.protoBlockDict[this.rowLabels[p]].staticLabels[0],s.innerHTML=n+"<br>"+this.rowArgs[p],s.style.fontSize=Math.floor(12*this._cellScale)+"px"):MATRIXGRAPHICS2.includes(this.rowLabels[p])?(n=this.activity.blocks.protoBlockDict[this.rowLabels[p]].staticLabels[0],s.innerHTML="".concat(n,"<br>").concat(this.rowArgs[p][0]," ").concat(this.rowArgs[p][1]),s.style.fontSize=Math.floor(12*this._cellScale)+"px"):noteIsSolfege(this.rowLabels[p])?s.innerHTML="".concat(i18nSolfege(this.rowLabels[p])).concat(this.rowArgs[p].toString().sub()):s.innerHTML="".concat(this.rowLabels[p]).concat(this.rowArgs[p].toString().sub());for(var d,b=0;d=this._rows[p].cells[b];b++)(h=o.insertCell()).style.backgroundColor=d.style.backgroundColor,h.innerHTML=d.innerHTML,h.width=d.width,""==h.width&&(h.width=d.style.width),h.colSpan=d.colSpan,h.style.minWidth=d.style.width,h.style.maxWidth=d.style.width,h.height="30px",h.style.fontSize="14px",h.style.padding="1px"}if(this._matrixHasTuplets){(s=(o=u.insertRow()).insertCell()).innerHTML=_("note value"),c=this._tupletNoteValueRow;for(var y=0;y<c.cells.length;y++)h=o.insertCell(),r=c.cells[y],h.style.backgroundColor=r.style.backgroundColor,h.innerHTML=r.innerHTML,h.width=r.width,""==h.width&&(h.width=r.style.width),h.colSpan=r.colSpan,h.style.minWidth=r.style.width,h.style.maxWidth=r.style.width,h.style.fontSize="14px",h.style.padding="1px";(s=(o=u.insertRow()).insertCell()).innerHTML=_("tuplet value"),c=this._tupletValueRow;for(var m=0;m<c.cells.length;m++)h=o.insertCell(),r=c.cells[m],h.style.backgroundColor=r.style.backgroundColor,h.innerHTML=r.innerHTML,h.width=r.width,""==h.width&&(h.width=r.style.width),h.colSpan=r.colSpan,h.style.minWidth=r.style.width,h.style.maxWidth=r.style.width,h.style.fontSize="14px",h.style.padding="1px"}(s=(o=u.insertRow()).insertCell()).innerHTML=_("note value"),c=this._noteValueRow;for(var v=0;v<c.cells.length;v++)h=o.insertCell(),r=c.cells[v],h.style.backgroundColor=r.style.backgroundColor,h.innerHTML=r.innerHTML,h.width=r.width,""==h.width&&(h.width=r.style.width),h.colSpan=r.colSpan,h.style.minWidth=r.style.width,h.style.maxWidth=r.style.width,h.style.fontSize="14px",h.style.padding="1px";var g=t.documentElement.outerHTML;t.body.innerHTML+='<br><a id="downloadb1" style="background: #C374E9; border-radius: 5%; padding: 0.3em; text-decoration: none; margin: 0.5em; color: white;" download>Download Matrix</a>',t.getElementById("downloadb1").download="MusicMatrix",t.getElementById("downloadb1").href=this._generateDataURI(g),t.close()}else console.debug("Could not create export window")}},{key:"note2Solfege",value:function(t,e){var l,i=["â™­","â™¯"].includes(t[1])?(l=t[2],SOLFEGECONVERSIONTABLE[t.substr(0,2)]):(l=t[1],SOLFEGECONVERSIONTABLE[t[0]]);this.rowLabels[e]=i,this.rowArgs[e]=l}},{key:"addTuplet",value:function(t){for(var e,l=t[0][0]/t[0][1],i=t[1].length,s=0,o=0;o<i;o++)e=0===o?t[1][0]:LCD(e,t[1][o]),s+=32/t[1][o];for(var a=0,n=0;n<i;n++)0<t[1][n]&&(a+=e/t[1][n]);var h=t[0][1]/t[0][0],c=calcNoteValueToDisplay(t[0][1],t[0][0]);12<h&&(c='<a href="#" title="'+t[0][0]+"/"+t[0][1]+'">.</a>');for(var r,u,p,d,b=0;b<i;b++)this._notesToPlay.push([["R"],s*t[0][1]/(32/t[1][b])]),this._outputAsTuplet.push([i,h]);if(!this._matrixHasTuplets){r=this._rows[0],(u=this._tupletNoteLabel).innerHTML=_("note value"),u.style.fontSize=75*this._cellScale+"%",u.style.height=Math.floor(1.5*MATRIXSOLFEHEIGHT*this._cellScale)+"px",u.style.width=Math.floor(2*MATRIXSOLFEWIDTH*this._cellScale)+"px",u.style.minWidth=u.style.width,u.style.maxWidth=u.style.width,u.style.backgroundColor=platformColor.labelColor,(u=this._tupletValueLabel).innerHTML=_("tuplet value"),u.style.fontSize=75*this._cellScale+"%",u.style.height=Math.floor(1.5*MATRIXSOLFEHEIGHT*this._cellScale)+"px",u.style.width=Math.floor(2*MATRIXSOLFEWIDTH*this._cellScale)+"px",u.style.minWidth=u.style.width,u.style.maxWidth=u.style.width,u.style.backgroundColor=platformColor.labelColor,p=this._tupletNoteValueRow,d=this._tupletValueRow;for(var y=0;y<r.cells.length;y++)(w=p.insertCell()).style.backgroundColor=platformColor.tupletBackground,w.style.width=r.cells[y].style.width,w.style.minWidth=r.cells[y].style.minWidth,w.style.maxWidth=r.cells[y].style.maxWidth,w.style.height=Math.floor(MATRIXSOLFEHEIGHT*this._cellScale)+"px",(w=d.insertCell()).style.backgroundColor=platformColor.tupletBackground,w.style.width=r.cells[y].style.width,w.style.minWidth=r.cells[y].style.minWidth,w.style.maxWidth=r.cells[y].style.maxWidth,w.style.height=Math.floor(MATRIXSOLFEHEIGHT*this._cellScale)+"px"}for(var m,v,g,k,f,w,C=h*a,W=0;W<i;W++){w=(p=this._tupletNoteValueRow).insertCell(-1),v=1/((m=32/t[1][W])/(s/l)),w.style.backgroundColor=platformColor.tupletBackground,w.style.width=this._noteWidth(v)+"px",w.style.minWidth=w.style.width,w.style.maxWidth=w.style.width,w.style.height=Math.floor(1.5*MATRIXSOLFEHEIGHT*this._cellScale)+"px",w.setAttribute("id",1/C),w.style.lineHeight="60%",w.style.fontSize=75*this._cellScale+"%",w.style.textAlign="center",(g=toFraction(m/(s/l)))[1]<13?null!=NOTESYMBOLS&&g[1]in NOTESYMBOLS?w.innerHTML="".concat(g[0],"<br>&mdash;<br>").concat(g[1],'<br>\n                        <img \n                            src="').concat(NOTESYMBOLS[g[1]],'" \n                            height="').concat(MATRIXSOLFEHEIGHT/2*this._cellScale,'"\n                        >'):w.innerHTML="".concat(g[0],"<br>&mdash;<br>").concat(g[1],"<br><br>"):w.innerHTML="",k=w.style.width;for(var L=0;L<this.rowLabels.length;L++)f=-1!=MATRIXGRAPHICS.indexOf(this.rowLabels[L])?platformColor.graphicsBackground:null===getDrumName(this.rowLabels[L])?platformColor.pitchBackground:platformColor.drumBackground,(w=this._rows[L].insertCell()).setAttribute("cellColor",f),w.style.height=Math.floor(MATRIXSOLFEHEIGHT*this._cellScale)+"px",w.setAttribute("alt",1/C),w.style.width=k,w.style.minWidth=w.style.width,w.style.maxWidth=w.style.width,w.style.backgroundColor=f,w.onmouseover=function(t){"black"!==t.target.style.backgroundColor&&(t.target.style.backgroundColor=platformColor.selectorSelected)},w.onmouseout=function(t){"black"!==t.target.style.backgroundColor&&(t.target.style.backgroundColor=t.target.getAttribute("cellColor"))}}(w=(d=this._tupletValueRow).insertCell()).colSpan=i,w.style.fontSize=Math.floor(75*this._cellScale)+"%",w.style.lineHeight="60%",w.style.width=this._noteWidth(h)+"px",w.style.minWidth=w.style.width,w.style.maxWidth=w.style.width,w.style.height=Math.floor(1.5*MATRIXSOLFEHEIGHT*this._cellScale)+"px",w.style.textAlign="center",w.innerHTML=a,w.style.backgroundColor=platformColor.tupletBackground,(w=this._noteValueRow.insertCell()).colSpan=i,w.style.fontSize=Math.floor(75*this._cellScale)+"%",w.style.lineHeight="60%",w.style.width=this._noteWidth(h)+"px",w.style.minWidth=w.style.width,w.style.maxWidth=w.style.width,w.style.height=Math.floor(1.5*MATRIXSOLFEHEIGHT*this._cellScale)+"px",w.style.textAlign="center",w.innerHTML=c,w.style.backgroundColor=platformColor.rhythmcellcolor,this._matrixHasTuplets=!0}},{key:"_noteWidth",value:function(t){return Math.max(Math.floor(EIGHTHNOTEWIDTH*(8/t)*this._cellScale),15)}},{key:"addNotes",value:function(t,e){var l=calcNoteValueToDisplay(e,1);12<e&&(l='<a href="#" title="1/'+e+'">.</a>');for(var i=0;i<t;i++)this._notesToPlay.push([["R"],e]),this._outputAsTuplet.push([t,e]);for(var s,o,a=this.rowLabels.length-this._rests,n=0;n<t;n++){for(var h=0;h<a;h++)o=-1!=MATRIXGRAPHICS.indexOf(this.rowLabels[h])||-1!=MATRIXGRAPHICS2.indexOf(this.rowLabels[h])?platformColor.graphicsBackground:null===getDrumName(this.rowLabels[h])?platformColor.pitchBackground:platformColor.drumBackground,(s=this._rows[h].insertCell()).setAttribute("cellColor",o),s.style.borderRadius="6px",s.style.height=Math.floor(MATRIXSOLFEHEIGHT*this._cellScale)+"px",s.style.width=this._noteWidth(e)+"px",s.style.minWidth=s.style.width,s.style.maxWidth=s.style.width,s.style.backgroundColor=o,s.setAttribute("alt",1/e),s.addEventListener("mouseover",function(t){"black"!==t.target.style.backgroundColor&&(t.target.style.backgroundColor=platformColor.selectorSelected)}),s.addEventListener("mouseout",function(t){"black"!==t.target.style.backgroundColor&&(t.target.style.backgroundColor=t.target.getAttribute("cellColor"))});(s=this._noteValueRow.insertCell()).style.width=this._noteWidth(e)+"px",s.style.minWidth=s.style.width,s.style.maxWidth=s.style.width,s.style.height=Math.floor(1.5*MATRIXSOLFEHEIGHT*this._cellScale)+"px",s.style.fontSize=Math.floor(75*this._cellScale)+"%",s.style.lineHeight="60%",s.style.textAlign="center",s.innerHTML=l,s.style.backgroundColor=platformColor.rhythmcellcolor,s.style.color=platformColor.textColor,s.setAttribute("alt",e),this._matrixHasTuplets&&((s=this._tupletNoteValueRow.insertCell()).style.width=this._noteWidth(e)+"px",s.style.minWidth=s.style.width,s.style.maxWidth=s.style.width,s.height=Math.floor(1.5*MATRIXSOLFEHEIGHT*this._cellScale)+"px",s.style.height=Math.floor(1.5*MATRIXSOLFEHEIGHT*this._cellScale)+"px",s.style.backgroundColor=platformColor.tupletBackground,(s=this._tupletValueRow.insertCell()).style.width=this._noteWidth(e)+"px",s.style.minWidth=s.style.width,s.style.maxWidth=s.style.width,s.height=Math.floor(1.5*MATRIXSOLFEHEIGHT*this._cellScale)+"px",s.style.height=Math.floor(1.5*MATRIXSOLFEHEIGHT*this._cellScale)+"px",s.style.backgroundColor=platformColor.tupletBackground)}}},{key:"_lookForNoteBlocksOrRepeat",value:function(){this._noteBlocks=!1;for(var t,e=this.blockNo,l=0;l<this._blockMap[e].length;l++)if(-1!==(t=this._blockMap[e][l][1][0])&&null!==this.activity.blocks.blockList[t])if(void 0!==this.activity.blocks.blockList[t]){if("newnote"===this.activity.blocks.blockList[t].name||"repeat"===this.activity.blocks.blockList[t].name){this._noteBlocks=!0;break}}else console.debug("block "+t+" is undefined")}},{key:"_syncMarkedBlocks",value:function(){for(var l=[],t=this.blockNo,e=0;e<this._blockMap[t].length;e++)if(-1!==this._blockMap[t][e][0])for(var i=0;i<this._blockMapHelper.length;i++)if(JSON.stringify(this._blockMap[t][e][1])===JSON.stringify(this._blockMapHelper[i][0]))for(var s=0;s<this._blockMapHelper[i][1].length;s++)l.push([this._blockMap[t][e][0],this._colBlocks[this._blockMapHelper[i][1][s]],this._blockMap[t][e][2]]);this._blockMap[t]=l.filter(function(e,t){return t===l.findIndex(function(t){return JSON.stringify(t)===JSON.stringify(e)})})}},{key:"blockConnection",value:function(t,e){var l,i=this.activity.blocks.blockList.length-t;null==e?(this.activity.blocks.blockList[this.blockNo].connections[2]=i,this.activity.blocks.blockList[i].connections[0]=this.blockNo):(l=this.activity.blocks.blockList[e].connections.length-1,this.activity.blocks.blockList[e].connections[l]=i,this.activity.blocks.blockList[i].connections[0]=e),this.activity.blocks.clampBlocksToCheck.push([this.blockNo,0]),this.activity.blocks.adjustDocks(this.blockNo,!0)}},{key:"_deleteRhythmBlock",value:function(t){null!==last(this.activity.blocks.blockList[t].connections)&&this.activity.blocks.sendStackToTrash(this.activity.blocks.blockList[last(this.activity.blocks.blockList[t].connections)]),this.activity.blocks.sendStackToTrash(this.activity.blocks.blockList[t]),this.activity.blocks.adjustDocks(this.blockNo,!0),this.activity.refreshCanvas()}},{key:"_addRhythmBlock",value:function(t,e){var l=[];t=toFraction(t);var i=this.activity.blocks.blockList[this.blockNo].connections[1],s=this.activity.blocks.findBottomBlock(i),l="vspace"===this.activity.blocks.blockList[s].name?[[0,["rhythm2",{}],0,0,[null,1,2,5]],[1,["number",{value:e}],0,0,[0]],[2,["divide",{}],0,0,[0,3,4]],[3,["number",{value:t[1]}],0,0,[2]],[4,["number",{value:t[0]}],0,0,[2]],[5,["vspace",{}],0,0,[0,null]]]:[[0,"vspace",0,0,[null,1]],[1,["rhythm2",{}],0,0,[0,2,3,6]],[2,["number",{value:e}],0,0,[1]],[3,["divide",{}],0,0,[1,4,5]],[4,["number",{value:t[1]}],0,0,[3]],[5,["number",{value:t[0]}],0,0,[3]],[6,["vspace",{}],0,0,[1,null]]];this.activity.blocks.loadNewBlocks(l),"vspace"===this.activity.blocks.blockList[s].name?setTimeout(this.blockConnection(6,s),500):setTimeout(this.blockConnection(7,s),500),this.activity.refreshCanvas()}},{key:"_update",value:function(t,e,l,i){var s=[];e=toFraction(e),"tupletnote"===i?(s.push(this.activity.blocks.blockList[this.activity.blocks.blockList[t].connections[1]].connections[1]),s.push(this.activity.blocks.blockList[this.activity.blocks.blockList[t].connections[1]].connections[2])):(s.push(this.activity.blocks.blockList[this.activity.blocks.blockList[t].connections[2]].connections[1]),s.push(this.activity.blocks.blockList[this.activity.blocks.blockList[t].connections[2]].connections[2])),"rhythm"!==i&&"stupletvalue"!==i||(s.push(this.activity.blocks.blockList[t].connections[1]),this.activity.blocks.blockList[s[2]].value=parseFloat(l),this.activity.blocks.blockList[s[2]].text.text=l.toString(),this.activity.blocks.blockList[s[2]].updateCache()),("rhythm"===i||"stuplet"===i||"tupletnote"===i&&null!==e)&&(this.activity.blocks.blockList[s[0]].value=parseFloat(e[1]),this.activity.blocks.blockList[s[0]].text.text=e[1].toString(),this.activity.blocks.blockList[s[0]].updateCache(),this.activity.blocks.blockList[s[1]].value=parseFloat(e[0]),this.activity.blocks.blockList[s[1]].text.text=e[0].toString(),this.activity.blocks.blockList[s[1]].updateCache(),this.activity.refreshCanvas()),this.activity.saveLocally()}},{key:"_mapNotesBlocks",value:function(t,e){var l=[],i=this.activity.blocks.blockList[this.blockNo].connections[1],s=this.activity.blocks.blockList[i],o=0;for((s.name===t||"all"===t&&"hidden"!==s.name&&"vspace"!==s.name&&"hiddennoflow"!==s.name)&&(e?l.push([i,s.name]):l.push(i));null!=last(s.connections)&&!((o+=1)>2*this.activity.blocks.blockList);)i=last(s.connections),((s=this.activity.blocks.blockList[i]).name===t||"all"===t&&"hidden"!==s.name&&"vspace"!==s.name&&"hiddennoflow"!==s.name)&&(e?l.push([i,s.name]):l.push(i));return l}},{key:"recalculateBlocks",value:function(){var t=[];t.push([this.activity.logo.tupletRhythms[0][2],1]);for(var e=1,l=1;l<this.activity.logo.tupletRhythms.length;l++)this.activity.logo.tupletRhythms[l][2]===last(t)[0]?e+=1:(t[t.length-1][1]=e,t.push([this.activity.logo.tupletRhythms[l][2],1]),e=1);return 1<e&&(t[t.length-1][1]=e),t}},{key:"_readjustNotesBlocks",value:function(){var t=this._mapNotesBlocks("rhythm2"),e=this.recalculateBlocks(),l=[],i=e.length-t.length;if(0<=i)for(var s=0;s<t.length;s++)this._update(t[s],e[s][0],e[s][1],"rhythm");else for(var o=0;o<e.length;o++)this._update(t[o],e[o][0],e[o][1],"rhythm");for(var a=0;a<i;a++)this._addRhythmBlock(e[t.length+a][0],e[t.length+a][1]);for(var n=i;n<0;n++)this._deleteRhythmBlock(t[t.length+n]);t=this._mapNotesBlocks("rhythm2");for(var h=0;h<t.length;h++)for(var c=0;c<e[h][1];c++)l.push([t[h],c]);this._colBlocks=l}},{key:"_restartGrid",value:function(){var t;this._matrixHasTuplets=!1,this.sorted=!0,this.init(this.activity),this.sorted=!1;for(var e=0;e<this.activity.logo.tupletRhythms.length;e++)switch(this.activity.logo.tupletRhythms[e][0]){case"simple":case"notes":(t=[this.activity.logo.tupletParams[this.activity.logo.tupletRhythms[e][1]]]).push([]);for(var l=2;l<this.activity.logo.tupletRhythms[e].length;l++)t[1].push(this.activity.logo.tupletRhythms[e][l]);this.addTuplet(t);break;default:this.addNotes(this.activity.logo.tupletRhythms[e][1],this.activity.logo.tupletRhythms[e][2])}this.makeClickable(),docById("wheelDivptm").style.display="none",this._menuWheel.removeWheel(),this._exitWheel.removeWheel()}},{key:"_addNotes",value:function(t,e){t=parseInt(t),this._blockMapHelper=[];for(var l=0;l<=t;l++)this._blockMapHelper.push([this._colBlocks[l],[l]]);for(var i=t+1;i<this.activity.logo.tupletRhythms.length;i++)this._blockMapHelper.push([this._colBlocks[i],[i+parseInt(e)]]);for(var s=0;s<parseInt(e);s++)this.activity.logo.tupletRhythms=this.activity.logo.tupletRhythms.slice(0,t+s+1).concat(this.activity.logo.tupletRhythms.slice(t+s));this._readjustNotesBlocks(),this._syncMarkedBlocks(),this._restartGrid.call(this)}},{key:"_deleteNotes",value:function(t){if(1!==this.activity.logo.tupletRhythms.length){t=parseInt(t),this._blockMapHelper=[];for(var e=0;e<t;e++)this._blockMapHelper.push([this._colBlocks[e],[e]]);for(var l=t+1;l<this.activity.logo.tupletRhythms.length;l++)this._blockMapHelper.push([this._colBlocks[l],[l-1]]);this.activity.logo.tupletRhythms=this.activity.logo.tupletRhythms.slice(0,t).concat(this.activity.logo.tupletRhythms.slice(t+1)),this._readjustNotesBlocks(),this._syncMarkedBlocks(),this._restartGrid.call(this)}}},{key:"_divideNotes",value:function(t,e){t=parseInt(t),this._blockMapHelper=[];for(var l=0;l<t;l++)this._blockMapHelper.push([this._colBlocks[l],[l]]);this.activity.logo.tupletRhythms=this.activity.logo.tupletRhythms.slice(0,t).concat([[this.activity.logo.tupletRhythms[t][0],this.activity.logo.tupletRhythms[t][1],this.activity.logo.tupletRhythms[t][2]*e]]).concat(this.activity.logo.tupletRhythms.slice(t+1)),this._blockMapHelper.push([this._colBlocks[t],[]]);for(var i=0,s=0;s<e-1;s++)this.activity.logo.tupletRhythms=this.activity.logo.tupletRhythms.slice(0,t+s+1).concat(this.activity.logo.tupletRhythms.slice(t+s)),i=t+s,this._blockMapHelper[t][1].push(i);i++,this._blockMapHelper[t][1].push(i);for(var o=t+1;o<this._colBlocks.length;o++)i++,this._blockMapHelper.push([this._colBlocks[o],[i]]);this._readjustNotesBlocks(),this._syncMarkedBlocks(),this._restartGrid.call(this)}},{key:"_tieNotes",value:function(t,e){var l,i=null,s=null,s=t.id<e.id?(i=t.id,e.id):(i=e.id,t.id);for(this._blockMapHelper=[],l=0;l<i;l++)this._blockMapHelper.push([this._colBlocks[l],[l]]);for(var o=l,a=i;a<=s;a++)this._blockMapHelper.push([this._colBlocks[a],[o]]);o++;for(var n=parseInt(s)+1;n<this.activity.logo.tupletRhythms.length;n++)this._blockMapHelper.push([this._colBlocks[n],[o]]),o++;for(var h=0,c=i;c<=s;c++)h+=1/parseFloat(this.activity.logo.tupletRhythms[c][2]);this.activity.logo.tupletRhythms=this.activity.logo.tupletRhythms.slice(0,i).concat([[this.activity.logo.tupletRhythms[i][0],this.activity.logo.tupletRhythms[i][1],1/h]]).concat(this.activity.logo.tupletRhythms.slice(parseInt(s)+1)),this._readjustNotesBlocks(),this._syncMarkedBlocks(),this._restartGrid.call(this)}},{key:"_updateTuplet",value:function(t,e,l){var i;this.activity.logo.tupletParams[t][1]=e,this._restartGrid.call(this),"simpletupletnote"===l?(i=this._mapNotesBlocks("stuplet"),this._update(i[t],e,0,"stuplet")):(i=this._mapNotesBlocks("tuplet4"),this._update(i[t],e,0,"tupletnote"))}},{key:"_updateTupletValue",value:function(t,e,l){t=parseInt(t),e=parseInt(e),l=parseInt(l),this._blockMapHelper=[];var i,s=0;if(e<l){for(var o=0;o<=this.activity.logo.tupletRhythms.length&&o!=t;o++)for(var a=0;a<this.activity.logo.tupletRhythms[o].length-2;a++)this._blockMapHelper.push([this._colBlocks[s],[s]]),s++;for(var n=0;n<this.activity.logo.tupletRhythms[t].length-2;n++)this._blockMapHelper.push([this._colBlocks[s],[s]]),s++;s=(i=s)+l-e;for(var h=t+1;h<this.activity.logo.tupletRhythms.length;h++)for(var c=0;c<this.activity.logo.tupletRhythms[h].length-2;c++)this._blockMapHelper.push([this._colBlocks[i],[s]]),i++,s++;for(var r=e;r<l;r++)this.activity.logo.tupletRhythms[t]=this.activity.logo.tupletRhythms[t].slice(0,this.activity.logo.tupletRhythms[t].length).concat(this.activity.logo.tupletRhythms[t].slice(this.activity.logo.tupletRhythms[t].length-1))}else{for(var u=s=0;u<=this.activity.logo.tupletRhythms.length&&u!==t;u++)for(var p=0;p<this.activity.logo.tupletRhythms[u].length-2;p++)this._blockMapHelper.push([this._colBlocks[s],[s]]),s++;for(var d=e;l<d;d--)this.activity.logo.tupletRhythms[t]=this.activity.logo.tupletRhythms[t].slice(0,this.activity.logo.tupletRhythms[t].length-1);for(var b=0;b<this.activity.logo.tupletRhythms[t].length-2;b++)this._blockMapHelper.push([this._colBlocks[s],[s]]),s++;i=s+e-l;for(var y=t+1;y<this.activity.logo.tupletRhythms.length;y++)for(var m=0;m<this.activity.logo.tupletRhythms[y].length-2;m++)this._blockMapHelper.push([this._colBlocks[i],[s]]),i++,s++}for(var v=this._mapNotesBlocks("stuplet"),_=[],g=0;g<this.activity.logo.tupletRhythms.length;g++)for(var k=0;k<this.activity.logo.tupletRhythms[g].length-2;k++)_.push([v[g],k]);this._colBlocks=_,this._restartGrid.call(this),this._syncMarkedBlocks(),this._update(v[t],null,l,"stupletvalue")}},{key:"_createpiesubmenu",value:function(l,i,e){var s=this;docById("wheelDivptm").style.display="",this._menuWheel=new wheelnav("wheelDivptm",null,800,800),this._exitWheel=new wheelnav("_exitWheel",this._menuWheel.raphael);var o=[];"tupletvalue"===e?(o=["1","2","3","-","4","5","6","7","8","+","9","10"],this.newNoteValue=String(i)):"simpletupletnote"===e||"tupletnote"===e?(o=["<-","Enter","1","2","3","4","5","6","7","8","9","10"],this.newNoteValue="/"):"rhythmnote"===e&&(this._tabsWheel=new wheelnav("_tabsWheel",this._menuWheel.raphael),this.newNoteValue=2,o=["divide","delete","duplicate",String(this.newNoteValue)]),wheelnav.cssMode=!0,this._menuWheel.keynavigateEnabled=!1,this._menuWheel.clickModeRotate=!1,this._menuWheel.colors=platformColor.pitchWheelcolors,this._menuWheel.slicePathFunction=slicePath().DonutSlice,this._menuWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._menuWheel.sliceSelectedPathCustom=this._menuWheel.slicePathCustom,this._menuWheel.sliceInitPathCustom=this._menuWheel.slicePathCustom,this._menuWheel.animatetime=0,this._exitWheel.colors=platformColor.exitWheelcolors,this._exitWheel.keynavigateEnabled=!1,this._exitWheel.clickModeRotate=!1,this._exitWheel.slicePathFunction=slicePath().DonutSlice,this._exitWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._exitWheel.sliceSelectedPathCustom=this._exitWheel.slicePathCustom,this._exitWheel.sliceInitPathCustom=this._exitWheel.slicePathCustom;var t=[],a=[];if("tupletvalue"===e)t=["x",this.newNoteValue],this._menuWheel.slicePathCustom.minRadiusPercent=.4,this._menuWheel.slicePathCustom.maxRadiusPercent=1,this._exitWheel.slicePathCustom.minRadiusPercent=0,this._exitWheel.slicePathCustom.maxRadiusPercent=.4;else if("simpletupletnote"===e||"tupletnote"===e)t=["x",this.newNoteValue],this._menuWheel.slicePathCustom.minRadiusPercent=.5,this._menuWheel.slicePathCustom.maxRadiusPercent=1,this._exitWheel.slicePathCustom.minRadiusPercent=0,this._exitWheel.slicePathCustom.maxRadiusPercent=.5;else if("rhythmnote"===e){t=["x"," "],a=["","","","","","","","","","","","","1","2","3","4","5","6","7",""],this._menuWheel.slicePathCustom.minRadiusPercent=.2,this._menuWheel.slicePathCustom.maxRadiusPercent=.7,this._exitWheel.slicePathCustom.minRadiusPercent=0,this._exitWheel.slicePathCustom.maxRadiusPercent=.2,this._tabsWheel.colors=platformColor.pitchWheelcolors,this._tabsWheel.slicePathFunction=slicePath().DonutSlice,this._tabsWheel.slicePathCustom=slicePath().DonutSliceCustomization(),this._tabsWheel.slicePathCustom.minRadiusPercent=.7,this._tabsWheel.slicePathCustom.maxRadiusPercent=1,this._tabsWheel.sliceSelectedPathCustom=this._tabsWheel.slicePathCustom,this._tabsWheel.sliceInitPathCustom=this._tabsWheel.slicePathCustom,this._tabsWheel.clickModeRotate=!1,this._tabsWheel.createWheel(a);for(var n=0;n<a.length;n++)this._tabsWheel.navItems[n].navItem.hide()}this._menuWheel.createWheel(o),this._exitWheel.createWheel(t),docById("wheelDivptm").style.position="absolute",docById("wheelDivptm").style.height="250px",docById("wheelDivptm").style.width="250px";var h,c=0,r=0;if(null!==l&&(c=(h=this._noteValueRow.cells[l]).getBoundingClientRect().x,r=h.getBoundingClientRect().y),docById("wheelDivptm").style.left=Math.min(this.activity.canvas.width-200,Math.max(0,c*this.activity.getStageScale()))+"px",docById("wheelDivptm").style.top=Math.min(this.activity.canvas.height-250,Math.max(0,r*this.activity.getStageScale()))+"px",this._exitWheel.navItems[0].navigateFunction=function(){docById("wheelDivptm").style.display="none",s._menuWheel.removeWheel(),s._exitWheel.removeWheel()},"tupletvalue"===e){var u=function(){var t=s._menuWheel.selectedNavItemIndex,e=o[t];s.newNoteValue=String(e),docById("wheelnav-_exitWheel-title-1").children[0].textContent=s.newNoteValue,s._updateTupletValue(s,l,i,s.newNoteValue)};this._menuWheel.navItems[3].navigateFunction=function(){1<s.newNoteValue&&(s.newNoteValue=String(parseInt(s.newNoteValue)-1),docById("wheelnav-_exitWheel-title-1").children[0].textContent=s.newNoteValue,s._updateTupletValue(s,l,i,s.newNoteValue))},this._menuWheel.navItems[9].navigateFunction=function(){s.newNoteValue=String(parseInt(s.newNoteValue)+1),docById("wheelnav-_exitWheel-title-1").children[0].textContent=s.newNoteValue,s._updateTupletValue(l,i,s.newNoteValue)};for(var p=0;p<o.length;p++)9!==p&&3!=p&&(this._menuWheel.navItems[p].navigateFunction=u)}else if("simpletupletnote"===e||"tupletnote"===e){var d=!1,b=!1,y=function(){var t=s._menuWheel.selectedNavItemIndex,e=o[t];d?b||(s.newNoteValue=s.newNoteValue+String(e),docById("wheelnav-_exitWheel-title-1").children[0].textContent=s.newNoteValue,b=!0):(s.newNoteValue=String(e)+"/",docById("wheelnav-_exitWheel-title-1").children[0].textContent=s.newNoteValue,d=!0)};this._menuWheel.navItems[0].navigateFunction=function(){var t;b&&d?(t=s.newNoteValue.split("/"),s.newNoteValue=t[0]+"/",docById("wheelnav-_exitWheel-title-1").children[0].textContent=s.newNoteValue,b=!1):d&&(s.newNoteValue="/",docById("wheelnav-_exitWheel-title-1").children[0].textContent=s.newNoteValue,d=!1)},this._menuWheel.navItems[1].navigateFunction=function(){var t;b&&d&&(t=s.newNoteValue.split("/"),s._updateTuplet(l,parseInt(t[1])/parseInt(t[0]),e))};for(var m=2;m<o.length;m++)this._menuWheel.navItems[m].navigateFunction=y}else if("rhythmnote"===e){var v=0;this._menuWheel.navItems[0].navigateFunction=function(){s._divideNotes(l,s.newNoteValue)},this._menuWheel.navItems[1].navigateFunction=function(){s._deleteNotes(l)},this._menuWheel.navItems[2].navigateFunction=function(){s._addNotes(l,s.newNoteValue)},this._menuWheel.navItems[3].navigateFunction=function(){if(v){for(var t=12;t<19;t++)docById("wheelnav-wheelDivptm-title-3").children[0].textContent=s.newNoteValue,s._tabsWheel.navItems[t].navItem.hide();v=0}else{for(var e=12;e<19;e++)docById("wheelnav-wheelDivptm-title-3").children[0].textContent=s.newNoteValue,s._tabsWheel.navItems[e].navItem.show();v=1}};for(var _=12;_<19;_++)this._tabsWheel.navItems[_].navigateFunction=function(){var t=s._tabsWheel.selectedNavItemIndex;s.newNoteValue=a[t],docById("wheelnav-wheelDivptm-title-3").children[0].textContent=a[t]}}}},{key:"makeClickable",value:function(){for(var t,e,i=this,l=this._noteValueRow,s=this._tupletValueRow,o=0;o<l.cells.length;o++){(t=l.cells[o]).setAttribute("id",o),void 0!==(e=s.cells[o])&&e.setAttribute("id",o);var a=function(t){i._mouseDownCell=t.target},n=function(t){var e;i._mouseUpCell=t.target,i._mouseDownCell!==i._mouseUpCell?i._tieNotes(i._mouseDownCell,i._mouseUpCell):(e=Array.prototype.slice.call(t.target.parentElement.children),i._createpiesubmenu(e.indexOf(t.target),t.target.getAttribute("alt"),"rhythmnote"))};void 0!==e?"notes"===this.activity.logo.tupletRhythms[0][0]?t.onclick=function(t){i._createpiesubmenu(t.target.getAttribute("id"),null,"tupletnote")}:(t.onclick=function(t){i._createpiesubmenu(t.target.getAttribute("id"),null,"simpletupletnote")},e.onclick=function(t){i._createpiesubmenu(t.target.getAttribute("id"),t.target.getAttribute("colspan"),"tupletvalue")}):(t.removeEventListener("mousedown",a),t.addEventListener("mousedown",a),t.removeEventListener("mouseup",n),t.addEventListener("mouseup",n))}for(var h,c,r=this.rowLabels.length,u=0;u<r;u++){h=this._rows[u];for(var p=0;p<h.cells.length;p++)"black"===(t=h.cells[p]).style.backgroundColor&&(t.style.backgroundColor=t.getAttribute("cellColor"),this._setNotes(p,u,!1))}for(var d,b,y,m,v,_,g,k=0;k<r;k++){h=this._rows[k];for(var f=0;f<h.cells.length;f++)(t=h.cells[f]).setAttribute("data-i",k),t.setAttribute("data-j",f),c=!1,t.onmousedown=function(t){c=!0;var e=Number(t.target.getAttribute("data-i")),l=Number(t.target.getAttribute("data-j"));"black"===t.target.style.backgroundColor?(t.target.style.backgroundColor=t.target.getAttribute("cellColor"),i._notesToPlay[l][0]=["R"],i._noteBlocks||i._setNotes(l,e,!1)):(t.target.style.backgroundColor="black",i._noteBlocks||i._setNotes(l,e,!0))},t.onmouseover=function(t){var e=Number(t.target.getAttribute("data-i")),l=Number(t.target.getAttribute("data-j"));c&&("black"===t.target.style.backgroundColor?(t.target.style.backgroundColor=t.target.getAttribute("cellColor"),i._notesToPlay[l][0]=["R"],i._noteBlocks||i._setNotes(l,e,!1)):(t.target.style.backgroundColor="black",i._noteBlocks||i._setNotes(l,e,!0)))},t.onmouseup=function(){c=!1}}if(this.sorted)for(var w=0;w<this._rowMapper.length;w++){d=this._rowMapper[w],b=this._sortedRowMap[w],h=this._rows[b];for(var C=0;C<this._markedColsInRow[d].length;C++)y=this._markedColsInRow[d][C],(t=h.cells[y]).style.backgroundColor="black",this._setNoteCell(b,y,t,!1,null)}else{m=this.blockNo;for(var W=0;W<this._blockMap[m].length;W++)if(-1!==(v=this._blockMap[m][W])[0]){_=v[2],g=null;for(var L,I,x,S=y=0;S<this._rowBlocks.length;S++){if(this._rowBlocks[S].toString().slice(-(null===(L=v[0])||void 0===L||null===(I=L.toString())||void 0===I?void 0:I.length))===(null===(x=v[0])||void 0===x?void 0:x.toString())&&y++===_){g=S;break}}if(null===g)continue;b=this._rowMap[g]+this._rowOffset[this._rowMap[g]],y=-1;for(var M=0;M<this._colBlocks.length;M++)if(this._noteBlocks){if(this._colBlocks[M][0]===v[1][0]&&this._colBlocks[M][1]===_){y=M;break}}else if(this._colBlocks[M][0]===v[1][0]&&this._colBlocks[M][1]===v[1][1]){y=M;break}if(-1===y)continue;null!=(h=this._rows[b])&&null!=(t=h.cells[y])&&(t.style.backgroundColor="black",this._setNoteCell(b,y,t,!1,null))}}}},{key:"playAll",value:function(){if(this.playingNow=!this.playingNow,this.playingNow){this.widgetWindow.modifyButton(0,"stop-button.svg",P.ICONSIZE,_("Stop")),this.activity.logo.synth.stop(),this.collectNotesToPlay(),this._notesCounter=0;for(var t,e,l=this._notesToPlay[this._notesCounter][0],i=[],s=[],o=[],a=0;a<l.length;a++)t="number"==typeof l[a]?null:getDrumName(l[a]),"number"==typeof l[a]?s.push(l[a]):null!=t?o.push(t):"http"===l[a].slice(0,4)?o.push(l[a]):1<(e=l[a].split(": ")).length?MATRIXSYNTHS.includes(e[0])?s.push(l[a]):this._processGraphics(e):i.push(l[a].replace(/â™­/g,"b").replace(/â™¯/g,"#")),this._stopOrCloseClicked=!1;var n=this._notesToPlay[this._notesCounter][1];this._notesCounter+=1,this._colIndex=0;var h=this._noteValueRow,c=h.cells[this._colIndex];c.style.backgroundColor=platformColor.selectorBackground,1<c.colSpan?(this._spanCounter=1,this._tupletNoteValueRow.cells[this._colIndex].style.backgroundColor=platformColor.selectorBackground):(this._spanCounter=0,this._colIndex+=1),"R"!==l[0]&&0<i.length&&this._playChord(i,Singer.defaultBPMFactor/n);for(var r=0;r<s.length;r++)this.activity.logo.synth.trigger(0,[Number(s[r])],Singer.defaultBPMFactor/n,this._instrumentName,null,null);for(var u=0;u<o.length;u++)this.activity.logo.synth.trigger(0,"C2",Singer.defaultBPMFactor/n,o[u],null,null);this.__playNote(0,0)}else this._stopOrCloseClicked=!0,this.widgetWindow.modifyButton(0,"play-button.svg",P.ICONSIZE,_("Play"))}},{key:"collectNotesToPlay",value:function(){for(var t,e,l=["doâ™­","Câ™­","do","C","doâ™¯","Câ™¯","reâ™­","Dâ™­","re","D","reâ™¯","Dâ™¯","miâ™­","Eâ™­","mi","E","miâ™¯","Eâ™¯","faâ™­","Fâ™­","fa","F","faâ™¯","Fâ™¯","solâ™­","Gâ™­","sol","G","solâ™¯","Gâ™¯","laâ™­","Aâ™­","la","A","laâ™¯","Aâ™¯","tiâ™­","Bâ™­","ti","B","tiâ™¯","Bâ™¯"],i=["Câ™­","Câ™­","C","C","Câ™¯","Câ™¯","Dâ™­","Dâ™­","D","D","Dâ™¯","Dâ™¯","Eâ™­","Eâ™­","E","E","Eâ™¯","Eâ™¯","Fâ™­","Fâ™­","F","F","Fâ™¯","Fâ™¯","Gâ™­","Gâ™­","G","G","Gâ™¯","Gâ™¯","Aâ™­","Aâ™­","A","A","Aâ™¯","Aâ™¯","Bâ™­","Bâ™­","B","B","Bâ™¯","Bâ™¯"],s=[],o=0;o<this._colBlocks.length;o++){e=[];for(var a=0;a<this.rowLabels.length;a++)if("black"===(t=this._rows[a].cells[o]).style.backgroundColor)if("hertz"===this.rowLabels[a])e.push(this.rowArgs[a]);else if(-1!=MATRIXGRAPHICS.indexOf(this.rowLabels[a])||-1!=MATRIXGRAPHICS2.indexOf(this.rowLabels[a]))e.push(this.rowLabels[a]+": "+this.rowArgs[a]);else if(-1!=l.indexOf(this.rowLabels[a]))e.push(i[l.indexOf(this.rowLabels[a])]+this.rowArgs[a]);else if(isCustomTemperament(this.activity.logo.synth.inTemperament)){var n=getTemperament(this.activity.logo.synth.inTemperament),h=this.rowLabels[a],c=[];for(var r in n)if(n[r][1]===h){c=n[r];break}0<c.length&&e.push(this.rowLabels[a]+this.rowArgs[a])}else e.push(this.rowLabels[a]);s.push([e,1/t.getAttribute("alt")])}this._notesToPlay=s}},{key:"_resetMatrix",value:function(){for(var t=this._noteValueRow,e=0;e<t.cells.length;e++)t.cells[e].style.backgroundColor=platformColor.rhythmcellcolor;if(this._matrixHasTuplets){t=this._tupletNoteValueRow;for(var l=0;l<t.cells.length;l++)t.cells[l].style.backgroundColor=platformColor.tupletBackground}}},{key:"__playNote",value:function(r,u){var p,d=this;this.lyricsON&&activity.textMsg(this._lyrics[u],3e3),this.widgetWindow.isVisible()&&(p=this._notesToPlay[u][1],r=1/p,setTimeout(function(){var t;if(u===d._notesToPlay.length-1)d._resetMatrix(),d.widgetWindow.modifyButton(0,"play-button.svg",P.ICONSIZE,_("Play")),d.playingNow=!1,d._playButton.innerHTML='&nbsp;&nbsp;<img \n                        src="header-icons/play-button.svg" \n                        title="'.concat(_("Play"),'" \n                        alt="').concat(_("Play"),'" \n                        height="').concat(P.ICONSIZE,'" \n                        width="').concat(P.ICONSIZE,'" \n                        vertical-align="middle"\n                    >&nbsp;&nbsp;');else{null!=(t=d._noteValueRow.cells[d._colIndex])&&(t.style.backgroundColor=platformColor.selectorBackground,1<t.colSpan&&(d._tupletNoteValueRow.cells[d._notesCounter].style.backgroundColor=platformColor.selectorBackground)),d._notesCounter>=d._notesToPlay.length&&(d._notesCounter=1,d.activity.logo.synth.stop());var e=d._notesToPlay[d._notesCounter][0];p=d._notesToPlay[d._notesCounter][1],d._notesCounter+=1;var l,i,s=[],o=[],a=[];if(!d._stopOrCloseClicked)for(var n=0;n<e.length;n++)if(l="number"==typeof e[n]?null:getDrumName(e[n]),"number"==typeof e[n])o.push(e[n]);else if(null!=l)a.push(l);else if("http"===e[n].slice(0,4))a.push(e[n]);else{if(i=e[n].split(": "),MATRIXSYNTHS.includes(i[0])){o.push(e[n]);continue}MATRIXGRAPHICS.includes(i[0])||MATRIXGRAPHICS2.includes(i[0])?d._processGraphics(i):s.push(e[n].replace(/â™­/g,"b").replace(/â™¯/g,"#"))}"R"!==e[0]&&0<s.length&&d._playChord(s,Singer.defaultBPMFactor/p);for(var h=0;h<o.length;h++)d.activity.logo.synth.trigger(0,[Number(o[h])],Singer.defaultBPMFactor/p,d._instrumentName,null,null);for(var c=0;c<a.length;c++)d.activity.logo.synth.trigger(0,["C2"],Singer.defaultBPMFactor/p,a[c],null,null)}null!=(t=d._noteValueRow.cells[d._colIndex])&&(1<t.colSpan?(d._spanCounter+=1,d._spanCounter===t.colSpan&&(d._spanCounter=0,d._colIndex+=1)):(d._spanCounter=0,d._colIndex+=1),(u+=1)<d._notesToPlay.length&&d.playingNow?d.__playNote(r,u):(d._resetMatrix(),d.widgetWindow.modifyButton(0,"play-button.svg",P.ICONSIZE,_("Play"))))},1e3*Singer.defaultBPMFactor*r+this.activity.logo.turtleDelay))}},{key:"_playChord",value:function(t,e){var l=this;setTimeout(function(){l.activity.logo.synth.trigger(0,t[0],e,l._instrumentName,null,null)},1),1<t.length&&setTimeout(function(){l.activity.logo.synth.trigger(0,t[1],e,l._instrumentName,null,null)},1),2<t.length&&setTimeout(function(){l.activity.logo.synth.trigger(0,t[2],e,l._instrumentName,null,null)},1),3<t.length&&setTimeout(function(){l.activity.logo.synth.trigger(0,t[3],e,l._instrumentName,null,null)},1)}},{key:"_processGraphics",value:function(t){var e=this.activity.turtles.getTurtle(0);switch(t[0]){case"forward":e.painter.doForward(t[1]);break;case"back":e.painter.doForward(-t[1]);break;case"right":e.painter.doRight(t[1]);break;case"left":e.painter.doRight(-t[1]);break;case"setcolor":e.painter.doSetColor(t[1]);break;case"sethue":e.painter.doSetHue(t[1]);break;case"setshade":e.painter.doSetValue(t[1]);break;case"setgrey":e.painter.doSetChroma(t[1]);break;case"settranslucency":e.painter.doSetPenAlpha(1-t[1]/100);break;case"setpensize":e.painter.doSetPensize(t[1]);break;case"setheading":e.painter.doSetHeading(t[1]);break;case"arc":e.painter.doArc(t[1],t[2]);break;case"setxy":e.painter.doSetXY(t[1],t[2]);break;default:console.debug("unknown graphics command "+t[0])}}},{key:"_setNotes",value:function(t,e,l){var i,s=this._rowBlocks[this._rowMap.indexOf(e-this._rowOffset[e])],o=this._colBlocks[t];l?this.addNode(s,o[0],o[1],this.blockNo):this.removeNode(s,o[0],o[1]);for(var a=0;a<this.rowLabels.length;a++)"black"===(i=this._rows[a].cells[t]).style.backgroundColor&&this._setNoteCell(a,t,i,l)}},{key:"_setNoteCell",value:function(t,e,l,i){var s,o,a,n=this._noteStored[t],h="hertz"===this.rowLabels[t]?(s=null,o=!1,[n]):(s=getDrumName(n),o=!1,a=n.split(": "),-1!=MATRIXGRAPHICS.indexOf(a[0])&&-1!=MATRIXGRAPHICS2.indexOf(a[0])&&(o=!0),n.split(": ")),c=this._rows[t].cells[e].getAttribute("alt")*Singer.defaultBPMFactor;1===h.length?i&&(null!=s?this.activity.logo.synth.trigger(0,"C2",c,s,null,null):"hertz"===this.rowLabels[t]?this.activity.logo.synth.trigger(0,Number(n),c,this._instrumentName,null,null):!0!==o?"string"==typeof n?this.activity.logo.synth.trigger(0,n.replace(/â™­/g,"b").replace(/â™¯/g,"#"),c,this._instrumentName,null,null):this.activity.logo.synth.trigger(0,n,c,this._instrumentName,null,null):console.debug("Cannot parse note object: "+h)):MATRIXSYNTHS.includes(h[0])&&this.activity.logo.synth.trigger(0,[Number(h[1])],c,h[0],null,null)}},{key:"_clear",value:function(){var l=this;this._lyrics=Array(this._lyrics.length).fill("");var t,e,i=document.getElementById("lyricRow");i&&i.querySelectorAll("input[type='text']").forEach(function(t,e){t.value=l._lyrics[e]||""});for(var s=0;s<this.rowLabels.length;s++){t=this._rows[s];for(var o=0;o<t.cells.length;o++)"black"===(e=t.cells[o]).style.backgroundColor&&(e.style.backgroundColor=e.getAttribute("cellColor"),this._notesToPlay[o][0]=["R"],this._setNotes(o,s,!1))}}},{key:"_save",value:function(){for(var t in this.activity.blocks.palettes.dict)this.activity.blocks.palettes.dict[t].hideMenu(!0);this.activity.refreshCanvas();var e,l,i,s,o,a,n=[[0,["action",{collapsed:!0}],100,100,[null,1,null,null]],[1,["text",{value:_("action")}],0,0,[0]]],h=0;this.collectNotesToPlay();for(var c=0;c<this._notesToPlay.length;c++){""===(e=this._notesToPlay[c].slice(0))[0]&&(e[0]="R"),l=n.length,n.push([l,"newnote",0,0,[h,l+1,l+2,null]]),i=n[l][4].length,0===c?n[h][4][i-2]=l:n[h][4][i-1]=l,h=l,1!==this._outputAsTuplet[c][0]&&parseInt(this._outputAsTuplet[c][1])===this._outputAsTuplet[c][1]?(s=7,n.push([l+1,"vspace",0,0,[l,l+s]]),n.push([l+2,"divide",0,0,[l,l+3,l+4]]),n.push([l+3,["number",{value:1}],0,0,[l+2]]),n.push([l+4,"multiply",0,0,[l+2,l+5,l+6]]),n.push([l+5,["number",{value:this._outputAsTuplet[c][0]}],0,0,[l+4]]),n.push([l+6,["number",{value:this._outputAsTuplet[c][1]}],0,0,[l+4]])):(s=5,n.push([l+1,"vspace",0,0,[l,l+s]]),n.push([l+2,"divide",0,0,[l,l+3,l+4]]),parseInt(e[1])<e[1]?(o=toFraction(e[1]),n.push([l+3,["number",{value:o[1]}],0,0,[l+2]]),n.push([l+4,["number",{value:o[0]}],0,0,[l+2]])):(n.push([l+3,["number",{value:1}],0,0,[l+2]]),n.push([l+4,["number",{value:e[1]}],0,0,[l+2]]))),n[l][4][1]=l+2,n[l][4][2]=l+1;var r=void 0,u=void 0,p=void 0;if("R"===e[0][0]||null==e[0][0])r=null,u=5===s||7===s?l+1:l,p=l+(s-=2),n.push([p+1,"rest2",0,0,[u,r]]),u+=s;else{p=l+s;for(var d=0;d<e[0].length;d++)0===d&&(u=5===s||7===s?l+1:l),a=isNaN(parseInt(e[0][d]))?(o=e[0][d].split(": "),getDrumName(e[0][d])):o=null,null===o?(r=this.lyricsON||1!==e[0].length&&d!==e[0].length-1?p+2:null,n.push([p,"hertz",0,0,[u,p+1,r]]),n.push([p+1,["number",{value:parseInt(e[0][d])}],0,0,[p]]),u=(p+=2)-2):null!=a?(r=this.lyricsON||1!==e[0].length&&d!==e[0].length-1?p+2:null,n.push([p,"playdrum",0,0,[u,p+1,r]]),n.push([p+1,["drumname",{value:a}],0,0,[p]]),u=(p+=2)-2):"http"===e[0][d].slice(0,4)?(r=this.lyricsON||1!==e[0].length&&d!==e[0].length-1?p+2:null,n.push([p,"playdrum",0,0,[u,p+1,r]]),n.push([p+1,["text",{value:e[0][d]}],0,0,[p]]),u=(p+=2)-2):2<o.length?(r=this.lyricsON||1!==e[0].length&&d!==e[0].length-1?p+3:null,n.push([p,o[0],0,0,[u,p+1,p+2,r]]),n.push([p+1,["number",{value:Number(o[1])}],0,0,[p]]),n.push([p+2,["number",{value:Number(o[2])}],0,0,[p]]),u=(p+=3)-3):1<o.length?(r=this.lyricsON||1!==e[0].length&&d!==e[0].length-1?p+2:null,n.push([p,o[0],0,0,[u,p+1,r]]),n.push([p+1,["number",{value:Number(o[1])}],0,0,[p]]),u=(p+=2)-2):(r=this.lyricsON||1!==e[0].length&&d!==e[0].length-1?p+3:null,u=("â™¯"===e[0][d][1]?isCustomTemperament(this.activity.logo.synth.inTemperament)?(n.push([p,"pitch",0,0,[u,p+1,p+2,r]]),n.push([p+1,["customNote",{value:e[0][d].substring(0,e[0][d].length-1)}],0,0,[p]]),n.push([p+2,["number",{value:e[0][d].slice(-1)}],0,0,[p]])):(n.push([p,"pitch",0,0,[u,p+1,p+2,r]]),n.push([p+1,["solfege",{value:SOLFEGECONVERSIONTABLE[e[0][d][0]+"â™¯"]}],0,0,[p]]),n.push([p+2,["number",{value:e[0][d][2]}],0,0,[p]])):"â™­"===e[0][d][1]?isCustomTemperament(this.activity.logo.synth.inTemperament)?(n.push([p,"pitch",0,0,[u,p+1,p+2,r]]),n.push([p+1,["customNote",{value:e[0][d].substring(0,e[0][d].length-1)}],0,0,[p]]),n.push([p+2,["number",{value:e[0][d].slice(-1)}],0,0,[p]])):(n.push([p,"pitch",0,0,[u,p+1,p+2,r]]),n.push([p+1,["solfege",{value:SOLFEGECONVERSIONTABLE[e[0][d][0]+"â™­"]}],0,0,[p]]),n.push([p+2,["number",{value:e[0][d][2]}],0,0,[p]])):(n.push([p,"pitch",0,0,[u,p+1,p+2,r]]),"custom"==this.activity.logo.synth.inTemperament?(n.push([p+1,["customNote",{value:e[0][d].substring(0,e[0][d].length-1)}],0,0,[p]]),n.push([p+2,["number",{value:e[0][d].slice(-1)}],0,0,[p]])):(n.push([p+1,["solfege",{value:SOLFEGECONVERSIONTABLE[e[0][d][0]]}],0,0,[p]]),n.push([p+2,["number",{value:e[0][d][1]}],0,0,[p]]))),p),p+=3);this.lyricsON&&(n.push([p,"print",0,0,[u,p+1,null]]),u=p,p+=1,this._lyrics[c]&&""!==this._lyrics?n.push([p,["text",{value:this._lyrics[c]}],0,0,[u]]):n.push([p,["text",{value:"..."}],0,0,[u]]))}}this.activity.blocks.loadNewBlocks(n),activity.textMsg(_("New action block generated."),3e3)}}]),P}();_defineProperty(PhraseMaker,"BUTTONDIVWIDTH",535),_defineProperty(PhraseMaker,"OUTERWINDOWWIDTH",758),_defineProperty(PhraseMaker,"INNERWINDOWWIDTH",630),_defineProperty(PhraseMaker,"BUTTONSIZE",53),_defineProperty(PhraseMaker,"ICONSIZE",24);