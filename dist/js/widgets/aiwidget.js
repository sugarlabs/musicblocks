"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _createForOfIteratorHelper(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var o=0,a=function(){};return{s:a,n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,s=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){l=!0,r=e},f:function(){try{s||null==n.return||n.return()}finally{if(l)throw r}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=Array(t);n<t;n++)o[n]=e[n];return o}function asyncGeneratorStep(e,t,n,o,a,r,s){try{var l=e[r](s),i=l.value}catch(e){return void n(e)}l.done?t(i):Promise.resolve(i).then(o,a)}function _asyncToGenerator(l){return function(){var e=this,s=arguments;return new Promise(function(t,n){var o=l.apply(e,s);function a(e){asyncGeneratorStep(o,t,n,a,r,"next",e)}function r(e){asyncGeneratorStep(o,t,n,a,r,"throw",e)}a(void 0)})}}function AIWidget(){var a,l=32,n=(DOUBLEFLAT,FLAT,SHARP,DOUBLESHARP,[DOUBLEFLAT,FLAT,NATURAL,SHARP,DOUBLESHARP]),o=["do","re","mi","fa","sol","la","ti","do"],i="electronic synth",c="";function W(e,t,n,o,a,r,s){var l=e;n=toFraction(n);var i,c,u,d=(i=l.name,((c=o.accidentals.find(function(e){var t=e.note.toUpperCase().replace(",","");return i=i.replace(",",""),t.toLowerCase()===i.toLowerCase()}))?i+("sharp"===c.acc?"♯":"flat"===c.acc?"♭":""):i).toUpperCase());return null!=r&&(console.log("For the Pitch"),console.log(l),console.log("below is the meter Den"),console.log(s),console.log("below is the triplet"),console.log(r),n[1]=s*r),a.push([t,["newnote",{collapsed:!0}],0,0,[t-1,t+1,t+4,t+8]],[t+1,"divide",0,0,[t,t+2,t+3]],[t+2,["number",{value:n[0]}],0,0,[t+1]],[t+3,["number",{value:n[1]}],0,0,[t+1]],[t+4,"vspace",0,0,[t,t+5]],[t+5,"pitch",0,0,[t+4,t+6,t+7,null]],[t+6,["notename",{value:d}],0,0,[t+5]],[t+7,["number",{value:(u=l.pitch,Math.floor(u/7)+4)}],0,0,[t+5]],[t+8,"hidden",0,0,[t,t+9]]),1}function R(e,t){for(var n=0;n<e.length;n++)if(e[n][0]===t)return n;return-1}this.timbreBlock,this.sampleArray,this.sampleData="",this.sampleName=i,this.samplePitch="sol",this.sampleOctave="4",this.pitchCenter=9,this.accidentalCenter=2,this.octaveCenter=4,this.sampleLength=1e3,this.pitchAnalysers={},this.pause=function(){a.stop()},this.resume=function(){this.playBtn.innerHTML='<img\n                src="header-icons/pause-button.svg" \n                title="'.concat(_("Pause"),'" \n                alt="').concat(_("Pause"),'" \n                height="').concat(l,'" \n                width="').concat(l,'" \n                vertical-align="middle"\n            >'),this.isMoving=!0},this._usePitch=function(e){var t=o.indexOf(e);this.pitchCenter=-1==t?0:t},this._useAccidental=function(e){var t=n.indexOf(e);this.accidentalCenter=-1===t?2:t},this._useOctave=function(e){this.octaveCenter=parseInt(e)},this.getSampleLength=function(){1333333<this.sampleData.length&&this.activity.errorMsg(_("Warning: Sample is bigger than 1MB."),this.timbreBlock)},this._parseABC=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,o,a,r,s,d,h,l,p,m,y,g,i,c,u,v,f,b,k,B,A,w,S,x,C,T,L,E,P,I,M,N,O,D;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:for(c in d=[],h={},l={},p=0,y=((m=null)!==(n=null===(o=t.metaText)||void 0===o?void 0:o.title)&&void 0!==n?n:"title").toString().toLowerCase(),g=(null!==(a=null===(r=t.metaText)||void 0===r?void 0:r.instruction)&&void 0!==a?a:"guitar").toString().toLowerCase(),null!==(s=t.lines)&&void 0!==s&&s.forEach(function(e){var t;console.log(e),null!==(t=e.staff)&&void 0!==t&&t.forEach(function(e,t){l.hasOwnProperty(t)||(l[t]={arrangedBlocks:[]}),l[t].arrangedBlocks.push(e)})}),console.log("below is the arranged blocks"),console.log(l),i=function(u){var e;null!==(e=l[u].arrangedBlocks)&&void 0!==e&&e.forEach(function(r){var e,t,n,o,a,s,l,i;h.hasOwnProperty(u)||(h[u]={meterNum:(null==r||null===(e=r.meter)||void 0===e||null===(t=e.value[0])||void 0===t?void 0:t.num)||4,meterDen:(null==r||null===(n=r.meter)||void 0===n||null===(o=n.value[0])||void 0===o?void 0:o.den)||4,keySignature:r.key,baseBlocks:[],startBlock:[[p,["start",{collapsed:!1}],100,100,[null,p+1,null]],[p+1,"print",0,0,[p,p+2,p+3]],[p+2,["text",{value:y}],0,0,[p+1]],[p+3,"setturtlename2",0,0,[p+1,p+4,p+5]],[p+4,["text",{value:"Voice ".concat(parseInt(u)+1," ")}],0,0,[p+3]],[p+5,"meter",0,0,[p+3,p+6,p+7,p+10]],[p+6,["number",{value:(null==r||null===(a=r.meter)||void 0===a||null===(s=a.value[0])||void 0===s?void 0:s.num)||4}],0,0,[p+5]],[p+7,"divide",0,0,[p+5,p+8,p+9]],[p+8,["number",{value:1}],0,0,[p+7]],[p+9,["number",{value:(null==r||null===(l=r.meter)||void 0===l||null===(i=l.value[0])||void 0===i?void 0:i.den)||4}],0,0,[p+7]],[p+10,"vspace",0,0,[p+5,p+11]],[p+11,"setkey2",0,0,[p+10,p+12,p+13,p+14]],[p+12,["notename",{value:r.key.root}],0,0,[p+11]],[p+13,["modename",{value:"m"==r.key.mode?"minor":"major"}],0,0,[p+11]],[p+14,"settimbre",0,0,[p+11,p+15,null,p+16]],[p+15,["voicename",{value:g}],0,0,[p+14]],[p+16,"hidden",0,0,[p+14,null]]],repeatBlock:[],repeatArray:[],nameddoArray:{}},p+=17);var c=[];r.voices.forEach(function(e){var t,n,o,a;console.log(e),e.forEach(function(e){if(console.log("hello"),"note"===e.el_type)null!==(null==e?void 0:e.startTriplet)&&void 0!==(null==e?void 0:e.startTriplet)&&(m=e.startTriplet),console.log("pitches are below"),console.log(e),W(e.pitches[0],p,e.duration,r.key,c,m,h[u].meterDen),null!==(null==e?void 0:e.endTriplet)&&void 0!==(null==e?void 0:e.endTriplet)&&(m=null),p+=9;else if("bar"===e.el_type)if("bar_left_repeat"===e.type)h[u].repeatArray.push({start:h[u].baseBlocks.length,end:-1});else if("bar_right_repeat"===e.type){var t=h[u].repeatArray;for(var n in t)console.log("endBlockSearch[repeatbar].end"+t[n].end),-1==t[n].end&&(h[u].repeatArray[n].end=h[u].baseBlocks.length)}}),c[0][4][0]=p+3,c[c.length-1][4][1]=null,0!=h[u].baseBlocks.length&&(h[u].baseBlocks[h[u].baseBlocks.length-1][0][h[u].baseBlocks[h[u].baseBlocks.length-1][0].length-4][4][1]=p),c.push([p,["nameddo",{value:"V: ".concat(parseInt(u)+1," Line ").concat((null===(t=h[u])||void 0===t||null===(n=t.baseBlocks)||void 0===n?void 0:n.length)+1)}],0,0,[0===h[u].baseBlocks.length?null:h[u].baseBlocks[h[u].baseBlocks.length-1][0][h[u].baseBlocks[h[u].baseBlocks.length-1][0].length-4][0],null]],[p+1,["action",{collapsed:!1}],100,100,[null,p+2,p+3,null]],[p+2,["text",{value:"V: ".concat(parseInt(u)+1," Line ").concat((null===(o=h[u])||void 0===o||null===(a=o.baseBlocks)||void 0===a?void 0:a.length)+1)}],0,0,[p+1]],[p+3,"hidden",0,0,[p+1,c[0][0]]]),h[u].nameddoArray||(h[u].nameddoArray={}),h[u].nameddoArray[u]||(h[u].nameddoArray[u]=[]),h[u].nameddoArray[u].push(p),p+=4,d.push(c),console.log("below is the repeat checker"+u),h[u].baseBlocks.push([c])})})},l)i(c);for(v in u=[],console.log("below is the staff Block map"),console.log(h),h){h[v].startBlock[h[v].startBlock.length-3][4][2]=h[v].baseBlocks[0][0][h[v].baseBlocks[0][0].length-4][0],h[v].baseBlocks[0][0][h[v].baseBlocks[0][0].length-4][4][0]=h[v].startBlock[h[v].startBlock.length-3][0],console.log("For iter ".concat(v)),console.log(h[v].baseBlocks[0][0][h[v].baseBlocks[0][0].length-4]),f=h[v].repeatArray,b=_createForOfIteratorHelper(f);try{for(b.s();!(k=b.n()).done;)0==(B=k.value).start?(h[v].repeatBlock.push([p,"repeat",0,0,[h[v].startBlock[h[v].startBlock.length-3][0],p+1,h[v].nameddoArray[v][0],null===h[v].nameddoArray[v][B.end+1]?null:h[v].nameddoArray[v][B.end+1]]]),h[v].repeatBlock.push([p+1,["number",{value:2}],100,100,[p]]),h[v].startBlock[h[v].startBlock.length-3][4][2]=p,console.log("Following are the nameddo Array"),console.log(h[v].nameddoArray),A=R(h[v].baseBlocks[0][0],h[v].nameddoArray[v][0]),w=R(h[v].baseBlocks[B.end][0],h[v].nameddoArray[v][B.end]),console.log("below is the firstnammedo"),console.log(A),console.log("below and below is the error for you "),console.log(h[v].baseBlocks[0][0]),h[v].baseBlocks[B.end+1]&&h[v].baseBlocks[B.end+1][0]&&-1!=(S=R(h[v].baseBlocks[B.end+1][0],h[v].nameddoArray[v][B.end+1]))&&(h[v].baseBlocks[B.end+1][0][S][4][0]=p),h[v].baseBlocks[0][0][A][4][0]=p,h[v].baseBlocks[B.end][0][w][4][1]=null):(x=R(h[v].baseBlocks[B.start][0],h[v].nameddoArray[v][B.start]),C=R(h[v].baseBlocks[B.start-1][0],h[v].baseBlocks[B.start][0][x][4][0]),T=R(h[v].baseBlocks[B.end][0],h[v].baseBlocks[B.start][0][x][4][1]),(L=-1)==C&&(L=R(h[v].repeatBlock,h[v].baseBlocks[B.start][0][x][4][0])),E=h[v].baseBlocks[B.start][0][x][4][0],console.log("prevBlockID"),console.log(E),P=h[v].baseBlocks[B.start][0][x][0],I=h[v].nameddoArray[v][B.end+1],h[v].repeatBlock.push([p,"repeat",0,0,[h[v].baseBlocks[B.start][0][x][4][0],p+1,P,null===I?null:I]]),h[v].repeatBlock.push([p+1,["number",{value:2}],100,100,[p]]),-1!=C?h[v].baseBlocks[B.start-1][0][C][4][1]=p:h[v].repeatBlock[L][4][3]=p,-1!=T&&(h[v].baseBlocks[B.end][0][T][4][1]=null),h[v].baseBlocks[B.start][0][x][4][0]=p,null!=I&&(console.log("below is the repeat next block id "+B),console.log(h[v].baseBlocks),M=R(h[v].baseBlocks[B.end+1][0],I),h[v].baseBlocks[B.end+1][0][M][4][0]=p)),p+=2}catch(e){b.e(e)}finally{b.f()}N=h[v].baseBlocks.reduce(function(e,t){return e.concat(t)},[]),O=N.flat(),D=[].concat(_toConsumableArray(h[v].startBlock),_toConsumableArray(O)),u.push.apply(u,_toConsumableArray(h[v].startBlock)),u.push.apply(u,_toConsumableArray(O)),u.push.apply(u,_toConsumableArray(h[v].repeatBlock)),console.log("Below is the combined block:"),console.log(D)}return console.log("below is the staff Block map"),console.log(h),console.log("test block is "),console.log(u),this.activity.blocks.loadNewBlocks(u),this.activity.textMsg(_("New start block generated")),e.abrupt("return",null);case 23:case"end":return e.stop()}},e,this)}));return function(e){return t.apply(this,arguments)}}(),this.showSampleTypeError=function(){this.activity.errorMsg(_("Upload failed: Sample is not a .wav file."),this.timbreBlock)},this.__save=function(){var t=this,e=new ABCJS.parseOnly(c);console.log(e),e.forEach(function(e){t._parseABC(e),console.log(e)})},this._saveSample=function(){this.__save()},this._get_save_lock=function(){return this._save_lock},this.init=function(e){var o=this;if(this.activity=e,this._directions=[],this._widgetFirstTimes=[],this._widgetNextTimes=[],this._firstClickTimes=null,this.isMoving=!1,this.pitchAnalysers={},this.activity.logo.synth.loadSynth(0,getVoiceSynthName(i)),this.reconnectSynthsToAnalyser(),this.pitchAnalysers={},this.running=!0,this.drawVisualIDs)for(var t=0,n=Object.keys(this.drawVisualIDs);t<n.length;t++){var a=n[t];cancelAnimationFrame(this.drawVisualIDs[a])}this.drawVisualIDs={};var r=window.widgetWindows.windowFor(this,"AI");this.widgetWindow=r,this.divisions=[],r.clear(),r.show();var s=this;r.onclose=function(){if(o.drawVisualIDs)for(var e=0,t=Object.keys(o.drawVisualIDs);e<t.length;e++){var n=t[e];cancelAnimationFrame(o.drawVisualIDs[n])}o.running=!1,docById("wheelDivptm").style.display="none",o.pitchWheel,o.pitchAnalysers={},r.destroy()},r.onmaximize=this._scale.bind(this),this.playBtn=r.addButton("play-button.svg",l,_("Play")),this.playBtn.onclick=function(){console.log(c),o.isMoving?(o.pause(),o.playBtn.innerHTML='<img \n                        src="header-icons/play-button.svg" \n                        title="'.concat(_("Play"),'" \n                        alt="').concat(_("Play"),'" \n                        height="').concat(l,'" \n                        width="').concat(l,'"\n                        vertical-align="middle"\n                    >'),o.isMoving=!1):""!=c&&(console.log(c),o.resume(),o._playABCSong())},this._save_lock=!1,r.addButton("export-chunk.svg",l,_("Save sample"),"").onclick=function(){s._get_save_lock()||(s._save_lock=!0,s._saveSample(),setTimeout(function(){s._save_lock=!1},1e3))},r.sendToCenter(),this.widgetWindow=r,this._scale(),this.activity.textMsg(_("AI Music")),this.pause(),r.sendToCenter()},this._addSample=function(){for(var e=0;e<CUSTOMSAMPLES.length;e++)if(CUSTOMSAMPLES[e][0]==this.sampleName)return;CUSTOMSAMPLES.push([this.sampleName,this.sampleData])},this._playABCSong=function(){var e=c,t=document.querySelector(".stop-audio");console.log("abcd",c);var n,o=ABCJS.renderAbc("*",e,{responsive:"resize"})[0];ABCJS.synth.supportsAudio()?(window.AudioContext=window.AudioContext||window.webkitAudioContext||navigator.mozAudioContext||navigator.msAudioContext,(n=new window.AudioContext).resume().then(function(){return(a=new ABCJS.synth.CreateSynth).init({visualObj:o,audioContext:n,millisecondsPerMeasure:o.millisecondsPerMeasure()}).then(function(e){return console.log("Notes loaded: ",e),a.prime()}).then(function(e){return a.start(),Promise.resolve()}).catch(function(e){"NotSupported"===e.status?(t.setAttribute("style","display:none;"),document.querySelector(".audio-error").setAttribute("style","")):console.warn("synth error",e)})})):document.querySelector(".audio-error").setAttribute("style","")},this._playSample=function(){null!=this.sampleName&&""!=this.sampleName&&(this.reconnectSynthsToAnalyser(),this.activity.logo.synth.trigger(0,[220],this.sampleLength/1e3,"customsample_"+this.originalSampleName,null,null,!1))},this._waitAndPlaySample=function(){var t=this;return new Promise(function(e){setTimeout(function(){t._playSample(),e("played"),t._endPlaying()},500)})},this._playDelayedSample=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._waitAndPlaySample();case 2:case"end":return e.stop()}},e,this)})),this._waitAndEndPlaying=function(){var t=this;return new Promise(function(e){setTimeout(function(){t.pause(),e("ended")},t.sampleLength)})},this._endPlaying=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._waitAndEndPlaying();case 2:case"end":return e.stop()}},e,this)})),this.reconnectSynthsToAnalyser=function(){for(var e in[0,1])void 0===this.pitchAnalysers[e]&&(this.pitchAnalysers[e]=new Tone.Analyser({type:"waveform",size:8192}));for(var t in instruments[0]){var n=1;"electronic synth"===t&&(n=0,instruments[0][t].connect(this.pitchAnalysers[n])),t==="customsample_"+this.originalSampleName&&(n=1,instruments[0][t].connect(this.pitchAnalysers[n]))}},this._scale=function(){var e,t,n=this,o=document.getElementsByClassName("samplerCanvas");Array.prototype.forEach.call(o,function(e){n.widgetWindow.getWidgetBody().removeChild(e)}),t=this.widgetWindow.isMaximized()?(e=this.widgetWindow.getWidgetBody().getBoundingClientRect().width,this.widgetWindow.getWidgetFrame().getBoundingClientRect().height-70):(e=800,400),document.getElementsByTagName("canvas")[0].innerHTML="",this.makeCanvas(e,t,0,!0),this.reconnectSynthsToAnalyser()},this.makeCanvas=function(e,t){var n=document.createElement("div");this.widgetWindow.getWidgetBody().appendChild(n);var o=document.createElement("div");o.style.overflowY="auto",o.style.height=t+"px",o.style.border="1px solid #ccc",o.style.marginBottom="8px",o.style.marginLeft="8px",o.style.display="flex",o.style.flexDirection="column",o.style.alignItems="center",n.appendChild(o);var l=document.createElement("textarea");l.style.height=t+"px",l.style.width=e+"px",l.className="samplerTextarea",l.style.marginLeft="20px",l.style.fontSize="20px",l.style.padding="10px",o.appendChild(l);var a=document.createElement("div");a.style.marginBottom="10px",a.style.display="flex",a.style.justifyContent="center",a.style.marginTop="8px";["Dance tune","Fiddle jig","Nice melody","Fun song","Simple canon"].forEach(function(e){var t=document.createElement("span");t.textContent=e,t.style.marginRight="20px",t.style.cursor="pointer",t.style.marginRight="4px",t.style.fontSize="20px",t.style.color="blue",t.style.backgroundColor="rgb(227 162 162 / 80%)",t.style.padding="10px",t.style.borderRadius="5px",t.onclick=function(){r.value=e,a.style.display="none"},a.appendChild(t)}),o.appendChild(a);var r=document.createElement("input");r.type="text",r.className="inputField",r.placeholder="Enter text here",r.style.fontSize="20px",r.style.marginRight="2px",r.style.marginLeft="64px",r.style.padding="10px",r.style.marginBottom="10px",r.style.width="60%",n.appendChild(r),r.addEventListener("click",function(){r.focus()});var s=document.createElement("button");s.className="submitButton",s.textContent="Submit",s.style.fontSize="20px",s.style.padding="10px 20px",s.style.marginBottom="20px",n.appendChild(s),s.onclick=function(){var e,t,n=r.value.trim();""!==n&&(e="\n            Generate an ABC notation song based on the following description:\n            \n            ".concat(n,'\n            \n            {\n                "abc": "\n            X: {index}\n            T: {title}\n            M: {meter}\n            L: {length}\n            Q: {tempo}\n            K: {key}\n            {notes}\n                "\n            }\n            \n            IMPORTANT:\n            - Ensure that the response is only in ABC notation format.\n            - Use only notes, not chords.\n            - Do not provide any other content or formats, such as guitar tablature or chord diagrams.\n            - If your response includes other formats, please only output the ABC notation content within the curly braces.\n            - Do not add other text at the bottom such as "Let me know if you need any changes! "\n            '),t=JSON.stringify({messages:[{role:"system",content:"You are a helpful assistant that generates ABC notation songs."},{role:"user",content:e}],model:"llama3-8b-8192"}),s.disabled=!0,l.value="Loading...",fetch("https://api.groq.com/openai/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(env.GROQ_API_KEY)},body:t}).then(function(e){return e.json()}).then(function(e){var t;console.log("API Response:",e);var n=(null===(t=e.choices[0].message)||void 0===t?void 0:t.content)||"",o=n.indexOf("X:"),a=n.substring(o),r=a.indexOf("}");-1!==r?a=a.substring(0,r+1):console.warn("No closing brace found in the response."),a=(a=a.replace(/"|\}/g,"").trim()).replace(/(X:|T:|M:|L:|Q:|K:)/g,"\n$1").replace(/\n\s+/g,"\n").trim(),console.log(a);var s=a.split("\n").map(function(e){return e.trim()}).map(function(e){return e.startsWith("X:")||e.startsWith("T:")||e.startsWith("M:")||e.startsWith("L:")||e.startsWith("Q:")||e.startsWith("K:")?e+"\n":e}).join("");console.log(s),c=s,console.log("Updated abcNotationSong:",c),l.value=c}).catch(function(e){console.error("Error:",e),l.value="An error occurred: "+e.message}).finally(function(){s.disabled=!1}))},l.addEventListener("input",function(){c=l.value,console.log("abcNotationSong updated to:",c)})}}