"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function asyncGeneratorStep(e,t,s,l,i,r,n){try{var a=e[r](n),o=a.value}catch(e){return void s(e)}a.done?t(o):Promise.resolve(o).then(l,i)}function _asyncToGenerator(a){return function(){var e=this,n=arguments;return new Promise(function(t,s){var l=a.apply(e,n);function i(e){asyncGeneratorStep(l,t,s,i,r,"next",e)}function r(e){asyncGeneratorStep(l,t,s,i,r,"throw",e)}i(void 0)})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var s=0;s<t.length;s++){var l=t[s];l.enumerable=l.enumerable||!1,l.configurable=!0,"value"in l&&(l.writable=!0),Object.defineProperty(e,_toPropertyKey(l.key),l)}}function _createClass(e,t,s){return t&&_defineProperties(e.prototype,t),s&&_defineProperties(e,s),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,t,s){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var s=e[Symbol.toPrimitive];if(void 0===s)return("string"===t?String:Number)(e);var l=s.call(e,t||"default");if("object"!=_typeof(l))return l;throw new TypeError("@@toPrimitive must return a primitive value.")}var RhythmRuler=function(){function R(){_classCallCheck(this,R),this.Drums=[],this.Rulers=[],this._dissectHistory=[],this._undoList=[],this._playing=!1,this._playingOne=!1,this._playingAll=!1,this._cellCounter=0,this._elapsedTimes=[],this._startingTime=null,this._offsets=[],this._rulerSelected=0,this._rulerPlaying=-1,this._tapMode=!1,this._tapTimes=[],this._tapCell=null,this._tapEndTime=null,this._longPressStartTime=null,this._inLongPress=!1,this._mouseDownCell=null,this._mouseUpCell=null,this._wheel=null,this._dissectNumber=null,this._progressBar=null,this._rulers=[],this._fullscreenScaleFactor=3}return _createClass(R,[{key:"init",value:function(e){var o=this;this.activity=e,this._bpmFactor=1e3*TONEBPM/Singer.masterBPM,this._playing=!1,this._playingOne=!1,this._playingAll=!1,this._rulerPlaying=-1,this._startingTime=null,this._expanded=!1,0===this.Drums.length&&(this.Drums.push(null),this.Rulers.push([[1],[]])),this._elapsedTimes=[],this._offsets=[];for(var t=0;t<this.Rulers.length;t++)this._elapsedTimes.push(0),this._offsets.push(0);this._cellScale=1;var s=R.ICONSIZE,l=window.widgetWindows.windowFor(this,"rhythm maker");(this.widgetWindow=l).clear(),l.show(),l.onclose=function(){o._playing&&o.__pause();for(var e=[],t=[],s=0;s<o.Rulers.length;s++)if(null!==o.Drums[s]){for(var l=[],i=0;i<o.Rulers[s][1].length;i++)l.push(o.Rulers[s][1][i]);o._dissectNumber.classList.add("hasKeyboard"),e.push([l,o.Drums[s]]),t.push(o.Drums[s])}for(var r=0;r<o._dissectHistory.length;r++){var n,a=o._dissectHistory[r][1];t.includes(a)||(n=JSON.parse(JSON.stringify(o._dissectHistory[r][0])),e.push([n,a]))}o._dissectHistory=JSON.parse(JSON.stringify(e)),o._playing=!1,o._playingOne=!1,o._playingAll=!1,o.activity.hideMsgs(),o.widgetWindow.destroy()},this.widgetWindow.onmaximize=this._scale.bind(this),this._playAllCell=l.addButton("play-button.svg",s,_("Play all")),this._playAllCell.onclick=function(){o._playing?o.__pause():o._playingAll||o.__resume()},this._save_lock=!1,l.addButton("export-chunk.svg",s,_("Save rhythms")).onclick=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(o._get_save_lock()){e.next=6;break}return o._save_lock=!0,o._saveTupletsMerged(o._mergeRulers()),e.next=5,delayExecution(1e3);case 5:o._save_lock=!1;case 6:case"end":return e.stop()}},e)})),l.addButton("export-drums.svg",s,_("Save drum machine")).onclick=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(o._get_save_lock()){e.next=6;break}return o._save_lock=!0,o._saveMachine(0),e.next=5,delayExecution(1e3);case 5:o._save_lock=!1;case 6:case"end":return e.stop()}},e)})),this._dissectNumber=l.addInputButton("2"),this._dissectNumber.onfocus=function(){},this._dissectNumber.onkeydown=function(e){var t,s,l,i;e.keyCode===R.DEL&&(o._dissectNumber.value=o._dissectNumber.value.substring(0,o._dissectNumber.value.length-1)),e.keyCode===R.BACK&&(t=o._dissectNumber.selectionStart,o._dissectNumber.selectionStart!==o._dissectNumber.selectionEnd?(s=o._dissectNumber.selectionStart,l=o._dissectNumber.selectionEnd,o._dissectNumber.value=o._dissectNumber.value.substring(0,s)+o._dissectNumber.value.substring(s,l+1)):1==o._dissectNumber.value.length&&1==t?o._dissectNumber.value="":0<t&&(i=o._dissectNumber.value.substring(0,t)+o._dissectNumber.value.substring(t,o._dissectNumber.value),o._dissectNumber.value=i))},this._dissectNumber.oninput=function(){o._dissectNumber.onmouseout=function(){o._dissectNumber.value=Math.max(o._dissectNumber.value,2)},o._dissectNumber.value=Math.max(Math.min(o._dissectNumber.value,128),2)},l.addButton("restore-button.svg",s,_("Undo")).onclick=function(){o._undo()},this._tapButton=l.addButton("tap-button.svg",s,_("Tap a rhythm")),this._tapButton.onclick=function(){o._tap()},l.addButton("erase-button.svg",s,_("Clear")).onclick=function(){o._clear()};var i=document.createElement("table");l.getWidgetBody().append(i);for(var r,n=0,a=0;a<this.Rulers.length;a++){var u=i.insertRow();if(beginnerMode){for(var h=0,c=0;c<this.Rulers[a][0].length;c++)h+=580/this.Rulers[a][0][c];n<h&&(i.style.width=h+"px",n=h)}else!function(){var e,t=u.insertCell();t.innerHTML='<img \n                        src="header-icons/play-button.svg" \n                        title="'.concat(_("Play"),'" \n                        alt="').concat(_("Play"),'" \n                        height="').concat(s,'" \n                        width="').concat(s,'" \n                    />'),t.className="headcol",t.style.cursor="pointer",t.onclick=(e=a,function(){o._playing?o._rulerPlaying===e&&(t.innerHTML='<img \n                                        src="header-icons/play-button.svg" \n                                        title="'.concat(_("Play"),'" \n                                        alt="').concat(_("Play"),'" \n                                        height="').concat(s,'" \n                                        width="').concat(s,'" \n                                        vertical-align="middle"\n                                    >'),o._playing=!1,o._playingOne=!1,o._playingAll=!1,o._rulerPlaying=-1,o._startingTime=null,o._elapsedTimes[e]=0,o._offsets[e]=0,setTimeout(o._calculateZebraStripes(e),1e3)):!1===o._playingOne&&(o._rulerSelected=e,o.activity.logo.turtleDelay=0,o._playing=!0,o._playingOne=!0,o._playingAll=!1,o._cellCounter=0,o._startingTime=null,o._rulerPlaying=e,t.innerHTML='<img \n                                    src="header-icons/pause-button.svg" \n                                    title="'.concat(_("Pause"),'" \n                                    alt="').concat(_("Pause"),'" \n                                    height="').concat(s,'" \n                                    width="').concat(s,'" \n                                    vertical-align="middle"\n                                >'),o._elapsedTimes[e]=0,o._offsets[e]=0,o._playOne())})}();u.insertCell().innerHTML='<table id="rulerCellTable'.concat(a,'"></table>');var d=docById("rulerCellTable"+a);d.style.textAlign="center",d.style.border="0px",d.style.borderCollapse="collapse",d.cellSpacing="0px",d.cellPadding="0px";var p=d.insertRow();(this._rulers[a]=p).setAttribute("data-row",a);for(var v=0;v<this.Rulers[a][0].length;v++){var y=this.Rulers[a][0][v],m=p.insertCell(-1);m.innerHTML=calcNoteValueToDisplay(y,1),m.style.height=R.RULERHEIGHT+"px",m.style.minHeight=m.style.height,m.style.maxHeight=m.style.height,m.style.width=this._noteWidth(y)+"px",m.style.minWidth=m.style.width,m.style.border="0px",m.border="0px",m.padding="0px",m.style.padding="0px",m.style.lineHeight="60 % ",m.style.backgroundColor=a%2==0?v%2==0?platformColor.selectorBackground:platformColor.selectorSelected:v%2==0?platformColor.selectorSelected:platformColor.selectorBackground,this.__addCellEventHandlers(m,this._noteWidth(y),y)}u.cells[0].style.width=R.BUTTONSIZE+"px",u.cells[0].style.minWidth=R.BUTTONSIZE+"px",u.cells[0].style.maxWidth=R.BUTTONSIZE+"px",u.cells[0].style.height=p.offsetHeight+"px",u.cells[0].style.minHeight=p.offsetHeight+"px",u.cells[0].style.maxHeight=p.offsetHeight+"px",u.cells[0].style.verticalAlign="middle"}for(var g=0;g<this.Drums.length;g++)if(null!==g)for(var f=0;f<this._dissectHistory.length;f++)if(this._dissectHistory[f][1]===this.Drums[g])for(var b,T=this._rulers[g],S=0;S<this._dissectHistory[f][0].length;S++){null!=this._dissectHistory[f][0][S]&&(this._rulerSelected=g,"number"==typeof this._dissectHistory[f][0][S]?(r=T.cells[this._dissectHistory[f][0][S]],this.__toggleRestState(r,!1)):"number"==typeof this._dissectHistory[f][0][S][0]?"number"==typeof this._dissectHistory[f][0][S][1]?null!=(r=T.cells[this._dissectHistory[f][0][S][0]])&&this.__dissectByNumber(r,this._dissectHistory[f][0][S][1],!1):null!=(r=T.cells[this._dissectHistory[f][0][S][0]])&&this.__divideFromList(r,this._dissectHistory[f][0][S][1],!1):(b=this._dissectHistory[f][0][S],this._mouseDownCell=T.cells[b[0][0]],this._mouseUpCell=T.cells[last(b)[0]],null!=this._mouseUpCell&&this.__tie(!1),this._mouseDownCell=null,this._mouseUpCell=null))}e.textMsg(_("Click on the ruler to divide it."),3e3)}},{key:"_noteWidth",value:function(e){return Math.floor(EIGHTHNOTEWIDTH*(8/Math.abs(e))*(this.widgetWindow.isMaximized()?this._fullscreenScaleFactor:3))}},{key:"_scale",value:function(){var e,t=this;this.widgetWindow.isMaximized()&&(e=this.widgetWindow.getWidgetBody().getBoundingClientRect().width,this._fullscreenScaleFactor=Math.floor(e/(8*EIGHTHNOTEWIDTH))),this._rulers.forEach(function(e){t.widgetWindow.isMaximized()?Array.prototype.forEach.call(e.children,function(e){e.style.width=Number(e.style.width.slice(0,e.style.width.indexOf("px")))*(t._fullscreenScaleFactor/3)+"px",e.style.minWidth=e.style.width}):Array.prototype.forEach.call(e.children,function(e){e.style.width=Math.floor(Number(e.style.width.slice(0,e.style.width.indexOf("px")))/Math.floor(t._fullscreenScaleFactor/3))+"px",e.style.minWidth=e.style.width})})}},{key:"_calculateZebraStripes",value:function(e){for(var t=this._rulers[e],s=this._rulerSelected%2==0?platformColor.selectorBackground:platformColor.selectorSelected,l=0;l<t.cells.length;l++){var i=t.cells[l];i.style.border="2px solid lightgrey",i.style.borderRadius="10px",s===platformColor.selectorBackground&&(i.style.backgroundColor=l%2==0?platformColor.selectorBackground:platformColor.selectorSelected),s===platformColor.selectorSelected&&(i.style.backgroundColor=l%2==0?platformColor.selectorSelected:platformColor.selectorBackground)}}},{key:"_dissectRuler",value:function(r,e){var n=this,t=r.target;if(null!==t)if(this._tapMode&&0<this._tapTimes.length){var s=new Date;this._tapTimes.push(s.getTime())}else{if(null!==t.parentNode&&(this._rulerSelected=e,null!=this._rulerSelected&&!this._playing)){if(this._tapMode){if(null===this._tapCell){var l=function(){var e=n.Rulers[n._rulerSelected][0];if(n._tapCell=r.target,e[n._tapCell.cellIndex]<0)return n._tapCell=null,n._tapMode=!1,n._tapTimes=[],n._tapEndTime=null,n._tapButton.innerHTML='<img \n                            src="header-icons/tap-button.svg" \n                            title="'.concat(_("tap a rhythm"),'" \n                            alt="').concat(_("tap a rhythm"),'" \n                            height="').concat(R.ICONSIZE,'" \n                            width="').concat(R.ICONSIZE,'" \n                            vertical-align="middle"\n                        >'),{v:void 0};n._tapTimes=[];var t,s,l=n._bpmFactor/Math.abs(e[n._tapCell.cellIndex]);s=null===n.Drums[n._rulerSelected]?"snare drum":(t=n.activity.blocks.blockList[n.Drums[n._rulerSelected]].connections[1],n.activity.blocks.blockList[t].value);for(var i=0;i<4;i++)setTimeout(function(){n.activity.logo.synth.trigger(0,"C4",Singer.defaultBPMFactor/16,s,null,null)},l*i/4);setTimeout(function(){n.__startTapping(l,r)},l)}();if("object"===_typeof(l))return l.v}}else{var i=""===(i=this._dissectNumber.value)||isNaN(i)?2:Math.abs(Math.floor(i));this._dissectNumber.value=i,this._rulerSelected=t.parentNode.getAttribute("data-row"),this.__dissectByNumber(t,i,!0)}this.saveDissectHistory()}}}},{key:"__startTapping",value:function(e,t){var s=this,l=new Date;this._tapTimes=[l.getTime()],this._tapEndTime=this._tapTimes[0]+e,setTimeout(function(){s.__endTapping(t)},e);var i,r,n;this._tapCell.innerHTML="<div class='progressBar'></div>",this._progressBar=this._tapCell.querySelector(".progressBar"),i=12.5,r=1,n=setInterval(function(){100<=r?clearInterval(n):(r+=i,s._progressBar.style.width=r+"%")},e/8)}},{key:"__endTapping",value:function(e){var t=e.target;if(null!==t.parentNode){this._rulerSelected=t.parentNode.getAttribute("data-row"),this._progressBar&&this._progressBar.remove(),this._tapCell.innerHTML="";var s=new Date;if(this._tapTimes.push(s.getTime()),this._tapMode=!1,"string"==typeof this._rulerSelected||"number"==typeof this._rulerSelected){var l=this.Rulers[this._rulerSelected][0];last(this._tapTimes)>this._tapEndTime&&(this._tapTimes[this._tapTimes.length-1]=this._tapEndTime);var i,r=this._dissectNumber.value;switch(r=""===r||isNaN(r)?2:Math.abs(Math.floor(r))){case 2:i=16;break;case 3:i=27;break;case 4:i=32;break;case 5:i=25;break;case 6:i=36;break;case 7:i=14;break;case 8:i=64;break;default:i=16}for(var n,a=[],o=0,u=1;u<this._tapTimes.length;u++){var h=this._tapTimes[u]-this._tapTimes[u-1];u<this._tapTimes.length-1?(0===(n=nearestBeat(100*h/this._bpmFactor,i))[0]&&(n[0]=1,n[1]=n[1]/2),o+n[0]/n[1]<1&&(o+=n[0]/n[1],a.push(n[1]/n[0]))):(n=rationalToFraction(1/l[this._tapCell.cellIndex]-o),a.push(n[1]/n[0]))}this.__divideFromList(this._tapCell,a,!0)}this._tapTimes=[],this._tapCell=null,this._tapEndTime=null,this._tapButton.innerHTML='<img \n                src="header-icons/tap-button.svg" \n                title="'.concat(_("tap a rhythm"),'" \n                alt="').concat(_("tap a rhythm"),'" \n                height="').concat(R.ICONSIZE,'" \n                width="').concat(R.ICONSIZE,'" \n                vertical-align="middle"\n            >')}}},{key:"__addCellEventHandlers",value:function(e,t,s){function l(e){var t,s,l=e.target;null!==l&&null!==l.parentNode&&(u._rulerSelected=l.parentNode.getAttribute("data-row"),(t=u.Rulers[u._rulerSelected][0][l.cellIndex])<0?(s=rationalToFraction(Math.abs(Math.abs(-1/t))),l.innerHTML="".concat(calcNoteValueToDisplay(s[1],s[0])," ").concat(_("silence"),"}")):(s=rationalToFraction(Math.abs(Math.abs(1/t))),l.innerHTML=calcNoteValueToDisplay(s[1],s[0])))}function i(e){e.target.innerHTML=""}function r(e){var t=e.target;u._mouseDownCell=t;var s=new Date;u._longPressStartTime=s.getTime(),u._inLongPress=!1,u._longPressBeep=setTimeout(function(){var e=u._mouseDownCell;null!==e&&null!==e.parentNode&&(u._rulerSelected=e.parentNode.getAttribute("data-row"),e.style.backgroundColor=platformColor.selectorBackground)},1500)}function n(e){clearTimeout(u._longPressBeep);var t=e.target;u._mouseUpCell=t,u._mouseDownCell!==u._mouseUpCell?u._tieRuler(e,t.parentNode.getAttribute("data-row")):null===u._longPressStartTime||u._tapMode||1500<(new Date).getTime()-u._longPressStartTime&&(u._inLongPress=!0,u.__toggleRestState(t,!0)),u._mouseDownCell=null,u._mouseUpCell=null,u._longPressStartTime=null}function a(e){var t;null!=e&&(u.__getLongPressStatus()||null!==(t=e.target)&&null!==t.parentNode&&u._dissectRuler(e,t.parentNode.getAttribute("data-row")),u._inLongPress=!1)}var o,u=this;18<=t&&0<s?(o=rationalToFraction(Math.abs(1/s)),e.innerHTML=calcNoteValueToDisplay(o[1],o[0])):(e.innerHTML="",e.removeEventListener("mouseover",l),e.addEventListener("mouseover",l),e.removeEventListener("mouseout",i),e.addEventListener("mouseout",i)),e.removeEventListener("mousedown",r),e.addEventListener("mousedown",r),e.removeEventListener("mouseup",n),e.addEventListener("mouseup",n),e.removeEventListener("click",a),e.addEventListener("click",a)}},{key:"__getLongPressStatus",value:function(){return this._inLongPress}},{key:"__toggleRestState",value:function(e,t){var s,l,i,r,n,a,o=this;null!==e&&null!==e.parentNode&&void 0!==e.parentNode&&(this._rulerSelected=e.parentNode.getAttribute("data-row"),i=function(e){var t,s,l=e.target;null!==l&&(o._rulerSelected=l.parentNode.getAttribute("data-row"),(s=o.Rulers[o._rulerSelected][0][l.cellIndex])<0?(t=rationalToFraction(Math.abs(Math.abs(-1/s))),l.innerHTML=calcNoteValueToDisplay(t[1],t[0])+" "+_("silence")):(t=rationalToFraction(Math.abs(Math.abs(1/s))),l.innerHTML=calcNoteValueToDisplay(t[1],t[0])))},r=function(e){e.target.innerHTML=""},(l=(s=this.Rulers[this._rulerSelected][0])[e.cellIndex])<0?(n=rationalToFraction(Math.abs(1/l)),e.innerHTML=calcNoteValueToDisplay(n[1],n[0]),e.removeEventListener("mouseover",i),e.removeEventListener("mouseout",r)):(e.innerHTML="",e.removeEventListener("mouseover",i),e.addEventListener("mouseover",i),e.removeEventListener("mouseout",r),e.addEventListener("mouseout",r)),s[e.cellIndex]=-l,this._calculateZebraStripes(this._rulerSelected),a=this.Rulers[this._rulerSelected][1],t&&this._undoList.push(["rest",this._rulerSelected]),a.push(e.cellIndex))}},{key:"__divideFromList",value:function(e,t,s){if("object"===_typeof(e)&&"object"===_typeof(t)){var l=this._rulers[this._rulerSelected],i=e.cellIndex;if("string"==typeof this._rulerSelected||"number"==typeof this._rulerSelected){var r=this.Rulers[this._rulerSelected][0],n=this.Rulers[this._rulerSelected][1];s&&this._undoList.push(["tap",this._rulerSelected]),n.push([i,t]),l.deleteCell(i),r.splice(i,1);for(var a=0;a<t.length;a++){var o=l.insertCell(i+a),u=t[a],h=parseFloat(this._noteWidth(u));r.splice(i+a,0,u),o.style.width=h+"px",o.style.minWidth=o.style.width,o.style.height=R.RULERHEIGHT+"px",o.style.minHeight=o.style.height,o.style.maxHeight=o.style.height,this.__addCellEventHandlers(o,h,u)}this._calculateZebraStripes(this._rulerSelected)}}}},{key:"__dissectByNumber",value:function(e,t,s){if("object"===_typeof(e)&&"number"==typeof t){var l=this._rulers[this._rulerSelected],i=e.cellIndex;if("string"==typeof this._rulerSelected||"number"==typeof this._rulerSelected){var r=this.Rulers[this._rulerSelected][0],n=r[i];if(256<t*n)return void this.activity.logo.errorMsg(_("Maximum value of 256 has been exceeded."));this.activity.hideMsgs();var a=this.Rulers[this._rulerSelected][1];s&&this._undoList.push(["dissect",this._rulerSelected]),a.push([i,t]),l.deleteCell(i);var o=t*n,u=this._noteWidth(o),h=parseFloat(this._noteWidth(n))-parseFloat(t)*parseFloat(u),c=parseFloat(this._noteWidth(o))+parseFloat(h)/t;r.splice(i,1);for(var d=0;d<t;d++){var p=l.insertCell(i+d);r.splice(i+d,0,o),p.style.width=c+"px",p.style.minWidth=p.style.width,p.style.height=R.RULERHEIGHT+"px",p.style.minHeight=p.style.height,p.style.maxHeight=p.style.height,this.__addCellEventHandlers(p,c,o)}this._calculateZebraStripes(this._rulerSelected)}}}},{key:"_tieRuler",value:function(e,t){var s;this._playing||(this._tapMode?this._dissectRuler(e,t):null!==(s=e.target)&&null!==s.parentNode&&(this._rulerSelected=s.parentNode.getAttribute("data-row"),this.__tie(!0)))}},{key:"__tie",value:function(e){var t=this._rulers[this._rulerSelected];if(null!==this._mouseDownCell&&null!==this._mouseUpCell&&this._mouseDownCell!==this._mouseUpCell&&("string"==typeof this._rulerSelected||"number"==typeof this._rulerSelected)){var s,l=this.Rulers[this._rulerSelected][0],i=this._mouseDownCell.cellIndex,r=this._mouseUpCell.cellIndex;if(-1===i||-1===r)return;r<i&&(s=i,i=r,r=s,s=this._mouseDdownCell,this._mouseDownCell=this._mouseUpCell,this._mouseUpCell=s),l=this.Rulers[this._rulerSelected][0];var n=this.Rulers[this._rulerSelected][1];e&&this._undoList.push(["tie",this._rulerSelected]);for(var a=[],o=i;o<r+1;o++)a.push([o,l[o]]);n.push(a);for(var u=l[i],h=Math.abs(1/u),c=r;i<c;c--)h+=Math.abs(1/l[c]),t.deleteCell(c),this.Rulers[this._rulerSelected][0].splice(c,1);var d=this._noteWidth(1/h);l[i]=u<0?-1/h:1/h,this._mouseDownCell.style.width=d+"px",this._mouseDownCell.style.minWidth=this._mouseDownCell.style.width,this._mouseDownCell.style.height=R.RULERHEIGHT+"px",this._mouseDownCell.style.minHeight=this._mouseDownCell.style.height,this._mouseDownCell.style.maxHeight=this._mouseDownCell.style.height,this.__addCellEventHandlers(this._mouseDownCell,d,l[i]),this._calculateZebraStripes(this._rulerSelected)}}},{key:"_undo",value:function(){if(this.activity.logo.synth.stop(),this._startingTime=null,this._playing=!1,this._playingAll=!1,this._playingOne=!1,this._rulerPlaying=-1,this._startingTime=null,0!==this._undoList.length){var e=this._undoList.pop(),t=e[1],s=this.Rulers[t][1];if(0!==s.length){var l,i,r=this._rulers[t],n=this.Rulers[t][0];if("dissect"===e[0]){var a=s[s.length-1][1],o=s[s.length-1][0],u=r.cells[o].style.width,h=parseFloat(u)*a,c=n[o],d=c/a,_=r.insertCell(o);_.style.width=this._noteWidth(d)+"px",_.style.minWidth=_.style.width,_.style.height=R.RULERHEIGHT+"px",_.style.minHeight=_.style.height,_.style.maxHeight=_.style.height,_.style.backgroundColor=platformColor.selectorBackground,_.innerHTML=calcNoteValueToDisplay(c/a,1),n[o]=c/a,n.splice(o+1,a-1),this.__addCellEventHandlers(_,h,d);for(var p=0;p<a;p++)r.deleteCell(o+1)}else if("tap"===e[0]){for(var v=last(s)[0],y=last(s)[1],m=0,g=0;g<y.length;g++)m+=1/y[g];var f=1/m,b=this._noteWidth(f),T=r.insertCell(v);T.style.width=b+"px",T.style.minWidth=T.style.width,T.style.height=R.RULERHEIGHT+"px",T.style.minHeight=T.style.height,T.style.maxHeight=T.style.height,T.style.backgroundColor=platformColor.selectorBackground;var S=rationalToFraction(f);T.innerHTML=calcNoteValueToDisplay(S[1],S[0]),n[v]=f,n.splice(v+1,y.length-1),this.__addCellEventHandlers(T,b,f);for(var C=0;C<y.length;C++)r.deleteCell(v+1)}else if("tie"===e[0]){var w=last(s);if(0<w.length){var k=r.cells[w[0][0]],M=this._noteWidth(w[0][1]);k.style.width=M+"px",k.style.minWidth=k.style.width,k.style.height=R.RULERHEIGHT+"px",k.style.minHeight=k.style.height,k.style.maxHeight=k.style.height,n[w[0][0]]=w[0][1],this.__addCellEventHandlers(k,M,w[0][1]);for(var N=1;N<w.length;N++){var H=r.insertCell(w[0][0]+N),E=this._noteWidth(w[N][1]);H.style.width=E+"px",H.style.minWidth=H.style.width,H.style.height=R.RULERHEIGHT+"px",H.style.minHeight=H.style.height,H.style.maxHeight=H.style.height,n.splice(w[0][0]+N,0,w[N][1]),H.innerHTML=calcNoteValueToDisplay(w[N][1],1),this.__addCellEventHandlers(H,E,w[N][1])}this.Rulers[t][0]=n}}else{"rest"===e[0]&&(l=last(s),i=r.cells[l],this.__toggleRestState(i,!1),s.pop())}s.pop(),this._calculateZebraStripes(t)}}}},{key:"_tap",value:function(){this._tapMode=!0;var e=R.ICONSIZE;this._tapButton.innerHTML='<img \n                src="header-icons/tap-active-button.svg" \n                title="'.concat(_("tap a rhythm"),'" \n                alt="').concat(_("tap a rhythm"),'" \n                height="').concat(e,'" \n                width="').concat(e,'" \n                vertical-align="middle"\n            >')}},{key:"_clear",value:function(){this.activity.logo.synth.stop(),this.activity.logo.resetSynth(0),this._playing=!1,this._playingAll=!1,this._playingOne=!1,this._rulerPlaying=-1,this._startingTime=null,this._playAllCell.innerHTML='<img \n                src="header-icons/play-button.svg" \n                title="'.concat(_("Play all"),'" \n                alt="').concat(_("Play all"),'" \n                height="').concat(R.ICONSIZE,'" \n                width="').concat(R.ICONSIZE,'" \n                vertical-align="middle"\n            >');for(var e=0;e<this.Rulers.length;e++)for(this._rulerSelected=e;0<this.Rulers[e][1].length;)this._undo()}},{key:"__pause",value:function(){this._playAllCell.innerHTML='<img \n                src="header-icons/play-button.svg" \n                title="'.concat(_("Play all"),'" \n                alt="').concat(_("Play all"),'" \n                height="').concat(R.ICONSIZE,'" \n                width="').concat(R.ICONSIZE,'" \n                vertical-align="middle"\n            >'),this._playing=!1,this._playingAll=!1,this._playingOne=!1,this._rulerPlaying=-1,this._startingTime=null;for(var e=0;e<this.Rulers.length;e++)this._calculateZebraStripes(e)}},{key:"playAll",value:function(){var e=this;this._playing?this._playingAll&&(this.__pause(),this._playingAll=!0,setTimeout(function(){e.__resume()},1e3)):this._playingAll||this.__resume()}},{key:"__resume",value:function(){this._playAllCell.innerHTML='<img \n                src="header-icons/pause-button.svg" \n                title="'.concat(_("Pause"),'" \n                alt="').concat(_("Pause"),'" \n                height="').concat(R.ICONSIZE,'" \n                width="').concat(R.ICONSIZE,'" \n                vertical-align="middle"\n            >'),this.activity.logo.turtleDelay=0,this._playingAll=!0,this._playing=!0,this._playingOne=!1,this._cellCounter=0,this._rulerPlaying=-1;for(var e=0;e<this.Rulers.length;e++)this._elapsedTimes[e]=0,this._offsets[e]=0;this._playAll()}},{key:"_playAll",value:function(){if(this.activity.logo.synth.stop(),this.activity.logo.resetSynth(0),null===this._startingTime){var e=new Date;this._startingTime=e.getTime();for(var t=0;t<this.Rulers.length;t++)this._offsets[t]=0,this._elapsedTimes[t]=0}for(var s=0;s<this.Rulers.length;s++)this.__loop(0,s,0)}},{key:"_playOne",value:function(){var e;this.activity.logo.synth.stop(),this.activity.logo.resetSynth(0),null===this._startingTime&&(e=new Date,this._startingTime=e.getTime(),this._elapsedTimes[this._rulerSelected]=0,this._offsets[this._rulerSelected]=0),this.__loop(0,this._rulerSelected,0)}},{key:"__loop",value:function(e,t,s){var l=this,i=this._rulers[t];if(null!==i){0===s&&this._calculateZebraStripes(t);var r,n,a=i.cells[s],o=this.Rulers[t][0],u=o[s];e=Math.abs(1/u),n=null===this.Drums[t]?"snare drum":(r=this.activity.blocks.blockList[this.Drums[t]].connections[1],this.activity.blocks.blockList[r].value);for(var h=!1,c=0;c<DRUMNAMES.length;c++){if(DRUMNAMES[c][0].replace("-"," ")===n){n=DRUMNAMES[c][1],h=!0;break}if(DRUMNAMES[c][1]===n){h=!0;break}}var d,_=!1;if(!h)for(var p=0;p<VOICENAMES.length;p++){if(VOICENAMES[p][0]===n){n=VOICENAMES[p][1],_=!0;break}if(VOICENAMES[p][1]===n){_=!0;break}}this._playing&&(0<u&&(_?this.activity.logo.synth.trigger(0,"C4",Singer.defaultBPMFactor/u,n,null,null,!1):h&&this.activity.logo.synth.trigger(0,["C4"],Singer.defaultBPMFactor/u,n,null,null)),a.style.backgroundColor=platformColor.rulerHighlight,d=new Date,this._offsets[t]=d.getTime()-this._startingTime-this._elapsedTimes[t]),setTimeout(function(){(s+=1)===o.length&&(s=0),l._playing&&l.__loop(e,t,s)},1e3*Singer.defaultBPMFactor*e-this._offsets[t]),this._elapsedTimes[t]+=1e3*Singer.defaultBPMFactor*e}}},{key:"_save",value:function(c){var d=this;for(var e in this.activity.palettes.dict)this.activity.palettes.dict[e].hideMenu(!0);this.activity.refreshCanvas(),setTimeout(function(){for(var e,t,s,l=d._rulers[c],i=d.Rulers[c][0],r=null===d.Drums[c]?_("snare drum")+" "+_("rhythm"):d.activity.blocks.blockList[d.activity.blocks.blockList[d.Drums[c]].connections[1]].value.split(" ")[0]+" "+_("rhythm"),n=42*c,a=[[0,["action",{collapsed:!0}],100+n,100+n,[null,1,2,null]],[1,["text",{value:r}],0,0,[0]]],o=0,u=1,h=0;h<l.cells.length;h++){i[h]===i[h+1]&&h<l.cells.length-1?u+=1:(e=a.length,t=i[h],s=rationalToFraction(1/Math.abs(t)),a.push([e,"rhythm2",0,0,[o,e+1,e+2,e+5]]),a.push([e+1,["number",{value:u}],0,0,[e]]),a.push([e+2,"divide",0,0,[e,e+3,e+4]]),a.push([e+3,["number",{value:s[0]}],0,0,[e+2]]),a.push([e+4,["number",{value:s[1]}],0,0,[e+2]]),a.push([e+5,"vspace",0,0,[e,e+6]]),h==l.cells.length-1?a.push([e+6,"hidden",0,0,[e+5,null]]):a.push([e+6,"hidden",0,0,[e+5,e+7]]),o=e+6,u=1)}d.activity.blocks.loadNewBlocks(a),c>d.Rulers.length-2||d._save(c+1)},500)}},{key:"_saveTuplets",value:function(d){var p=this;for(var e in this.activity.palettes.dict)this.activity.palettes.dict[e].hideMenu(!0);this.activity.refreshCanvas(),setTimeout(function(){for(var e,t,s,l,i=p._rulers[d],r=p.Rulers[d][0],n=null===p.Drums[d]?_("rhythm"):p.activity.blocks.blockList[p.activity.blocks.blockList[p.Drums[d]].connections[1]].value.split(" ")[0]+" "+_("rhythm"),a=42*d,o=[[0,["action",{collapsed:!0}],100+a,100+a,[null,1,2,null]],[1,["text",{value:n}],0,0,[0]]],u=0,h=1,c=0;c<i.cells.length;c++){r[c]===r[c+1]&&c<i.cells.length-1?h+=1:(e=o.length,t=r[c],l=(s=rationalToFraction(1/Math.abs(t)))[1]/h,Number.isInteger(l)?(o.push([e,"stuplet",0,0,[u,e+1,e+2,e+5]]),o.push([e+1,["number",{value:h}],0,0,[e]]),o.push([e+2,"divide",0,0,[e,e+3,e+4]]),o.push([e+3,["number",{value:s[0]}],0,0,[e+2]]),o.push([e+4,["number",{value:l}],0,0,[e+2]])):(o.push([e,"rhythm2",0,0,[u,e+1,e+2,e+5]]),o.push([e+1,["number",{value:h}],0,0,[e]]),o.push([e+2,"divide",0,0,[e,e+3,e+4]]),o.push([e+3,["number",{value:s[0]}],0,0,[e+2]]),o.push([e+4,["number",{value:s[1]}],0,0,[e+2]])),o.push([e+5,"vspace",0,0,[e,e+6]]),c==i.cells.length-1?o.push([e+6,"hidden",0,0,[e+5,null]]):o.push([e+6,"hidden",0,0,[e+5,e+7]]),u=e+6,h=1)}p.activity.blocks.loadNewBlocks(o),d>p.Rulers.length-2||p._saveTuplets(d+1)},500)}},{key:"_saveTupletsMerged",value:function(e){for(var t in this.activity.palettes.dict)this.activity.palettes.dict[t].hideMenu(!0);this.activity.refreshCanvas();for(var s,l,i,r=[[0,["action",{collapsed:!0}],142,142,[null,1,2,null]],[1,["text",{value:_("rhythm")}],0,0,[0]]],n=0,a=1,o=0;o<e.length;o++){e[o]===e[o+1]&&o<e.length-1?a+=1:(s=r.length,l=e[o],i=rationalToFraction(1/Math.abs(l)),r.push([s,"rhythm2",0,0,[n,s+1,s+2,s+5]]),r.push([s+1,["number",{value:a}],0,0,[s]]),r.push([s+2,"divide",0,0,[s,s+3,s+4]]),r.push([s+3,["number",{value:i[0]}],0,0,[s+2]]),r.push([s+4,["number",{value:i[1]}],0,0,[s+2]]),r.push([s+5,"vspace",0,0,[s,s+6]]),o==e.length-1?r.push([s+6,"hidden",0,0,[s+5,null]]):r.push([s+6,"hidden",0,0,[s+5,s+7]]),n=s+6,a=1)}this.activity.blocks.loadNewBlocks(r),activity.textMsg(_("New action block generated."),3e3)}},{key:"_saveMachine",value:function(e){var t,s;s=null===this.Drums[e]?"snare drum":(t=this.activity.blocks.blockList[this.Drums[e]].connections[1],this.activity.blocks.blockList[t].value);for(var l=0;l<DRUMNAMES.length;l++)if(DRUMNAMES[l][1]===s)return void(EFFECTSNAMES.includes(s)?this._saveDrumMachine(e,s,!0):this._saveDrumMachine(e,s,!1));for(var i=0;i<VOICENAMES.length;i++)if(VOICENAMES[i][1]===s)return void this._saveVoiceMachine(e,s)}},{key:"_saveDrumMachine",value:function(c,d,p){var v=this;for(var e in this.activity.palettes.dict)this.activity.palettes.dict[e].hideMenu(!0);this.activity.refreshCanvas(),setTimeout(function(){for(var e,t,s,l=v._rulers[c],i=v.Rulers[c][0],r=42*c,n=null===v.Drums[c]?_("snare drum")+" "+_("action"):v.activity.blocks.blockList[v.activity.blocks.blockList[v.Drums[c]].connections[1]].value.split(" ")[0]+" "+_("action"),a=[[0,["action",{collapsed:!0}],100+r,100+r,[null,1,2,null]],[1,["text",{value:n}],0,0,[0]]],o=0,u=1,h=0;h<l.cells.length;h++){i[h]===i[h+1]&&h<l.cells.length-1?u+=1:(e=a.length,t=i[h],s=rationalToFraction(1/Math.abs(t)),1===u?(a.push([e,"newnote",0,0,[o,e+1,e+4,e+7]]),a.push([e+1,"divide",0,0,[e,e+2,e+3]]),a.push([e+2,["number",{value:s[0]}],0,0,[e+1]]),t<0?(a.push([e+3,["number",{value:s[1]}],0,0,[e+1]]),a.push([e+4,"vspace",0,0,[e,e+5]]),a.push([e+5,"rest2",0,0,[e+4,e+6]]),a.push([e+6,"hidden",0,0,[e+5,null]])):(a.push([e+3,["number",{value:s[1]}],0,0,[e+1]]),a.push([e+4,"vspace",0,0,[e,e+5]]),a.push([e+5,"playdrum",0,0,[e+4,e+6,null]]),p?a.push([e+6,["effectsname",{value:d}],0,0,[e+5]]):a.push([e+6,["drumname",{value:d}],0,0,[e+5]])),h==l.cells.length-1?a.push([e+7,"hidden",0,0,[e,null]]):(a.push([e+7,"hidden",0,0,[e,e+8]]),o=e+7)):(h==l.cells.length-1?a.push([e,"repeat",0,0,[o,e+1,e+2,null]]):(a.push([e,"repeat",0,0,[o,e+1,e+2,e+10]]),o=e),a.push([e+1,["number",{value:u}],0,0,[e]]),a.push([e+2,"newnote",0,0,[e,e+3,e+6,e+9]]),a.push([e+3,"divide",0,0,[e+2,e+4,e+5]]),a.push([e+4,["number",{value:1}],0,0,[e+3]]),t<0?(a.push([e+5,["number",{value:-t}],0,0,[e+3]]),a.push([e+6,"vspace",0,0,[e+2,e+7]]),a.push([e+7,"rest2",0,0,[e+6,e+8]]),a.push([e+8,"hidden",0,0,[e+7,null]])):(a.push([e+5,["number",{value:t}],0,0,[e+3]]),a.push([e+6,"vspace",0,0,[e+2,e+7]]),a.push([e+7,"playdrum",0,0,[e+6,e+8,null]]),p?a.push([e+8,["effectsname",{value:d}],0,0,[e+7]]):a.push([e+8,["drumname",{value:d}],0,0,[e+7]])),a.push([e+9,"hidden",0,0,[e+2,null]])),u=1)}v.activity.blocks.loadNewBlocks(a),activity.textMsg(_("New action block generated."),3e3),c>v.Rulers.length-2||v._saveMachine(c+1)},500)}},{key:"_saveVoiceMachine",value:function(c,d){var p=this;for(var e in this.activity.palettes.dict)this.activity.palettes.dict[e].hideMenu(!0);this.activity.refreshCanvas(),setTimeout(function(){var e=p._rulers[c],t=p.Rulers[c][0],s=42*c,l=null===p.Drums[c]?_("guitar")+" "+_("action"):p.activity.blocks.blockList[p.activity.blocks.blockList[p.Drums[c]].connections[1]].value.split(" ")[0]+"_"+_("action"),i=[[0,["action",{collapsed:!0}],100+s,100+s,[null,1,2,null]],[1,["text",{value:l}],0,0,[0]]];i.push([2,"settimbre",0,0,[0,3,5,4]]),i.push([3,["voicename",{value:d}],0,0,[2]]),i.push([4,"hidden",0,0,[2,null]]);for(var r,n,a,o=2,u=1,h=0;h<e.cells.length;h++){t[h]===t[h+1]&&h<e.cells.length-1?u+=1:(r=i.length,n=t[h],a=rationalToFraction(1/Math.abs(n)),1===u?n<0?(i.push([r,"newnote",0,0,[o,r+1,r+4,r+7]]),i.push([r+1,"divide",0,0,[r,r+2,r+3]]),i.push([r+2,["number",{value:a[0]}],0,0,[r+1]]),i.push([r+3,["number",{value:a[1]}],0,0,[r+1]]),i.push([r+4,"vspace",0,0,[r,r+5]]),i.push([r+5,"rest2",0,0,[r+4,r+6]]),i.push([r+6,"hidden",0,0,[r+5,null]]),h==e.cells.length-1?i.push([r+7,"hidden",0,0,[r,null]]):(i.push([r+7,"hidden",0,0,[r,r+8]]),o=r+7)):(i.push([r,"newnote",0,0,[o,r+1,r+4,r+8]]),i.push([r+1,"divide",0,0,[r,r+2,r+3]]),i.push([r+2,["number",{value:a[0]}],0,0,[r+1]]),i.push([r+3,["number",{value:a[1]}],0,0,[r+1]]),i.push([r+4,"vspace",0,0,[r,r+5]]),i.push([r+5,"pitch",0,0,[r+4,r+6,r+7,null]]),i.push([r+6,["notename",{value:"C"}],0,0,[r+5]]),i.push([r+7,["number",{value:4}],0,0,[r+5]]),h==e.cells.length-1?i.push([r+8,"hidden",0,0,[r,null]]):(i.push([r+8,"hidden",0,0,[r,r+9]]),o=r+8)):(h==e.cells.length-1?i.push([r,"repeat",0,0,[o,r+1,r+2,null]]):(i.push([r,"repeat",0,0,[o,r+1,r+2,r+11]]),o=r),i.push([r+1,["number",{value:u}],0,0,[r]]),n<0?(i.push([r+2,"newnote",0,0,[r,r+3,r+6,r+9]]),i.push([r+3,"divide",0,0,[r+2,r+4,r+5]]),i.push([r+4,["number",{value:1}],0,0,[r+3]]),i.push([r+5,["number",{value:-n}],0,0,[r+3]]),i.push([r+6,"vspace",0,0,[r+2,r+7]]),i.push([r+7,"rest2",0,0,[r+6,r+8]]),i.push([r+8,"hidden",0,0,[r+7,null]]),i.push([r+9,"hidden",0,0,[r+2,null]])):(i.push([r+2,"newnote",0,0,[r,r+3,r+6,r+10]]),i.push([r+3,"divide",0,0,[r+2,r+4,r+5]]),i.push([r+4,["number",{value:1}],0,0,[r+3]]),i.push([r+5,["number",{value:n}],0,0,[r+3]]),i.push([r+6,"vspace",0,0,[r+2,r+7]]),i.push([r+7,"pitch",0,0,[r+6,r+8,r+9,null]]),i.push([r+8,["notename",{value:"C"}],0,0,[r+7]]),i.push([r+9,["number",{value:4}],0,0,[r+7]]),i.push([r+10,"hidden",0,0,[r+2,null]]))),u=1)}p.activity.blocks.loadNewBlocks(i),c>p.Rulers.length-2||p._saveMachine(c+1)},500)}},{key:"_mergeRulers",value:function(){for(var e=[],t=0;t<this.Rulers.length;t++)for(var s=0,l=this.Rulers[t][0],i=0;i<l.length;i++)s+=1/l[i],e.includes(s)||e.push(s);e.sort(function(e,t){return e-t}),l=[];for(var r=0;r<e.length;r++)0===r?l.push(1/e[r]):l.push(1/(e[r]-e[r-1]));return l}},{key:"_get_save_lock",value:function(){return this._save_lock}},{key:"saveDissectHistory",value:function(){for(var e,t,s=[],l=[],i=0;i<this.Rulers.length;i++)if(null!==this.Drums[i]){t=[];for(var r=0;r<this.Rulers[i][1].length;r++)t.push(this.Rulers[i][1][r]);this._dissectNumber.classList.add("hasKeyboard"),s.push([t,this.Drums[i]]),l.push(this.Drums[i])}for(var n=0;n<this._dissectHistory.length;n++)e=this._dissectHistory[n][1],l.includes(e)||(t=JSON.parse(JSON.stringify(this._dissectHistory[n][0])),s.push([t,e]));this._dissectHistory=JSON.parse(JSON.stringify(s))}},{key:"_piemenuRuler",value:function(){}},{key:"_positionWheel",value:function(){var e,t;"none"!=docById("wheelDiv").style.display&&(docById("wheelDiv").style.position="absolute",docById("wheelDiv").style.height="300px",docById("wheelDiv").style.width="300px",e=this._left+100,t=this._top,docById("wheelDiv").style.left=Math.min(Math.max(e-75,0),this.activity.canvas.width-300)+"px",docById("wheelDiv").style.top=t-300<0?t+60+"px":t-300+"px")}}]),R}();_defineProperty(RhythmRuler,"RULERHEIGHT",70),_defineProperty(RhythmRuler,"BUTTONSIZE",51),_defineProperty(RhythmRuler,"ICONSIZE",32),_defineProperty(RhythmRuler,"DEL",46),_defineProperty(RhythmRuler,"BACK",8);