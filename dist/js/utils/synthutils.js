"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function _iterableToArrayLimit(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,a,o,s,i=[],l=!0,c=!1;try{if(o=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=o.call(n)).done)&&(i.push(r.value),i.length!==t);l=!0);}catch(e){c=!0,a=e}finally{try{if(!l&&null!=n.return&&(s=n.return(),Object(s)!==s))return}finally{if(c)throw a}}return i}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function asyncGeneratorStep(e,t,n,r,a,o,s){try{var i=e[o](s),l=i.value}catch(e){return void n(e)}i.done?t(l):Promise.resolve(l).then(r,a)}function _asyncToGenerator(i){return function(){var e=this,s=arguments;return new Promise(function(t,n){var r=i.apply(e,s);function a(e){asyncGeneratorStep(r,t,n,a,o,"next",e)}function o(e){asyncGeneratorStep(r,t,n,a,o,"throw",e)}a(void 0)})}}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _defineProperty(e,t,n){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0===n)return("string"===t?String:Number)(e);var r=n.call(e,t||"default");if("object"!=_typeof(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}var POLYCOUNT=3,NOISENAMES=[[_("white noise"),"noise1","images/synth.svg","electronic"],[_("brown noise"),"noise2","images/synth.svg","electronic"],[_("pink noise"),"noise3","images/synth.svg","electronic"]],VOICENAMES=[[_("piano"),"piano","images/voices.svg","string"],[_("violin"),"violin","images/voices.svg","string"],[_("viola"),"viola","images/voices.svg","string"],[_("cello"),"cello","images/voices.svg","string"],[_("bass"),"bass","images/voices.svg","string"],[_("double bass"),"double bass","images/voices.svg","string"],[_("sitar"),"sitar","images/synth.svg","string"],[_("harmonium"),"harmonium","images/voices.svg","string"],[_("mandolin"),"mandolin","images/voices.svg","string"],[_("guitar"),"guitar","images/voices.svg","string"],[_("acoustic guitar"),"acoustic guitar","images/voices.svg","string"],[_("flute"),"flute","images/voices.svg","wind"],[_("clarinet"),"clarinet","images/voices.svg","wind"],[_("saxophone"),"saxophone","images/voices.svg","wind"],[_("tuba"),"tuba","images/voices.svg","wind"],[_("trumpet"),"trumpet","images/voices.svg","wind"],[_("oboe"),"oboe","images/voices.svg","wind"],[_("trombone"),"trombone","images/voices.svg","wind"],[_("banjo"),"banjo","images/voices.svg","string"],[_("koto"),"koto","images/voices.svg","string"],[_("dulcimer"),"dulcimer","images/voices.svg","string"],[_("electric guitar"),"electric guitar","images/voices.svg","string"],[_("bassoon"),"bassoon","images/voices.svg","string"],[_("celeste"),"celeste","images/voices.svg","string"],[_("xylophone"),"xylophone","images/8_bellset_key_6.svg","precussion"],[_("electronic synth"),"electronic synth","images/synth.svg","electronic"],[_("sine"),"sine","images/synth.svg","electronic"],[_("square"),"square","images/synth.svg","electronic"],[_("sawtooth"),"sawtooth","images/synth.svg","electronic"],[_("triangle"),"triangle","images/synth.svg","electronic"],[_("custom"),"custom","images/synth.svg","electronic"],[_("vibraphone"),"vibraphone","images/synth.svg","electronic"]],DRUMNAMES=[[_("snare drum"),"snare drum","images/snaredrum.svg","sn","drum"],[_("kick drum"),"kick drum","images/kick.svg","hh","drum"],[_("tom tom"),"tom tom","images/tom.svg","tomml","drum"],[_("floor tom"),"floor tom","images/floortom.svg","tomfl","drum"],[_("bass drum"),"bass drum","images/kick.svg","tomfl","drum"],[_("cup drum"),"cup drum","images/cup.svg","hh","drum"],[_("darbuka drum"),"darbuka drum","images/darbuka.svg","hh","drum"],[_("taiko"),"japanese drum","images/tom.svg","hh","drum"],[_("hi hat"),"hi hat","images/hihat.svg","hh","bell"],[_("ride bell"),"ride bell","images/ridebell.svg","rb","bell"],[_("cow bell"),"cow bell","images/cowbell.svg","cb","bell"],[_("triangle bell"),"triangle bell","images/trianglebell.svg","tri","bell"],[_("finger cymbals"),"finger cymbals","images/fingercymbals.svg","cymca","bell"],[_("chime"),"chime","images/chime.svg","cymca","bell"],[_("gong"),"gong","images/gong.svg","cymca","bell"],[_("clang"),"clang","images/clang.svg","cymca","effect"],[_("crash"),"crash","images/crash.svg","cymca","effect"],[_("bottle"),"bottle","images/bottle.svg","hh","effect"],[_("clap"),"clap","images/clap.svg","hc","effect"],[_("slap"),"slap","images/slap.svg","vibs","effect"],[_("splash"),"splash","images/splash.svg","hh","effect"],[_("bubbles"),"bubbles","images/bubbles.svg","hh","effect"],[_("raindrop"),"raindrop","images/bubbles.svg","hh","effect"],[_("cat"),"cat","images/cat.svg","hh","animal"],[_("cricket"),"cricket","images/cricket.svg","hh","animal"],[_("dog"),"dog","images/dog.svg","hh","animal"],[_("duck"),"duck","images/duck.svg","hh","animal"]],EFFECTSNAMES=["duck","dog","cricket","cat","bubbles","splash","bottle"],SOUNDSAMPLESDEFINES=["samples/violin","samples/cello","samples/flute","samples/guitar","samples/clarinet","samples/saxophone","samples/tuba","samples/trumpet","samples/bass","samples/bottle","samples/clap","samples/darbuka","samples/hihat","samples/splash","samples/bubbles","samples/cowbell","samples/dog","samples/kick","samples/tom","samples/cat","samples/crash","samples/duck","samples/ridebell","samples/triangle","samples/chime","samples/cricket","samples/fingercymbal","samples/slap","samples/clang","samples/cup","samples/floortom","samples/bassdrum","samples/snare","samples/piano","samples/acguit","samples/banjo","samples/bassoon","samples/celeste","samples/raindrop","samples/koto","samples/gong","samples/dulcimer","samples/electricguitar","samples/xylophone","samples/vibraphone","samples/japanese_drum","samples/viola","samples/oboe","samples/trombone","samples/doublebass","samples/sitar","samples/harmonium","samples/mandolin"],DEFAULTSYNTHVOLUME={flute:90,"electronic synth":90,piano:100,viola:20,violin:20,banjo:90,koto:70,"kick drum":100,"tom tom":100,"floor tom":100,"bass drum":100,"cup drum":100,"darbuka drum":100,"hi hat":100,"ride bell":100,"cow bell":100,"triangle bell":60,"finger cymbals":70,chime:90,gong:70,clang:70,crash:90,clap:90,slap:60,vibraphone:100,xylophone:100,"japanese drum":90,sitar:100,harmonium:100,mandolin:100},SAMPLECENTERNO={piano:["C4",39],violin:["C5",51],cello:["C3",27],bass:["C3",27],guitar:["C4",39],"acoustic guitar":["C4",39],flute:["F#5",57],saxophone:["C5",51],clarinet:["C4",39],tuba:["C4",39],trumpet:["C3",27],oboe:["C4",39],trombone:["C3",27],banjo:["C6",63],koto:["C5",51],dulcimer:["C4",39],"electric guitar":["C3",27],bassoon:["D4",41],celeste:["C3",27],vibraphone:["C5",51],xylophone:["C4",39],viola:["D4",53],"double bass":["C4",39],sitar:["C4",39],harmonium:["C4",39]},MULTIPITCH={mandolin:["A4","A5","A6"]},CUSTOMSAMPLES=[],percussionInstruments=["koto","banjo","dulcimer","xylophone","celeste"],stringInstruments=["piano","harmonium","sitar","guitar","acoustic guitar","electric guitar"],validateAndSetParams=function(e,t){if(e&&null!==e&&t&&void 0!==t)for(var n in e)n in t&&void 0!==t[n]&&(e[n]=t[n]);return e},instruments={0:{}},instrumentsSource={},instrumentsEffects={0:{}},instrumentsFilters={0:{}};function Synth(){var V=this,s={sine:1,triangle:1,sawtooth:1,square:1,pluck:1,noise1:1,noise2:1,noise3:1,poly:1,"simple 1":1,"simple 2":1,"simple 3":1,"simple 4":1,custom:1},a={amsynth:1,fmsynth:1,duosynth:1};this.tone=null,Tone.Buffer.onload=function(){console.debug("sample loaded")},this.samples=null,this.samplesuffix="_SAMPLE",this.samplesManifest=null,this.changeInTemperament=!1,this.inTemperament="equal",this.startingPitch="C4",this.noteFrequencies={},this.newTone=function(){V.tone=Tone},this.whichTemperament=function(){return V.inTemperament},this.temperamentChanged=function(e,t){var n,r=t,a=getTemperament(e),o=r.length,s=pitchToNumber(r.substring(0,o-1),r.slice(-1),"C major"),i=numberToPitch(s);(r=(i[0]+i[1]).toString()).substring(1,o-1)===FLAT||"b"===r.substring(1,o-1)?r=r.replace(FLAT,"b"):r.substring(1,o-1)!==SHARP&&"#"!==r.substring(1,o-1)||(r=r.replace(SHARP,"#"));var l=Tone.Frequency(r).toFrequency();for(var c in V.noteFrequencies=(_defineProperty(n={},t.substring(0,o-1),[Number(t.slice(-1)),l]),_defineProperty(n,getNoteFromInterval(t,"minor 2")[0],[getNoteFromInterval(t,"minor 2")[1],a["minor 2"]*l]),_defineProperty(n,getNoteFromInterval(t,"augmented 1")[0],[getNoteFromInterval(t,"augmented 1")[1],a["augmented 1"]*l]),_defineProperty(n,getNoteFromInterval(t,"major 2")[0],[getNoteFromInterval(t,"major 2")[1],a["major 2"]*l]),_defineProperty(n,getNoteFromInterval(t,"minor 3")[0],[getNoteFromInterval(t,"minor 3")[1],a["minor 3"]*l]),_defineProperty(n,getNoteFromInterval(t,"augmented 2")[0],[getNoteFromInterval(t,"augmented 2")[1],a["augmented 2"]*l]),_defineProperty(n,getNoteFromInterval(t,"major 3")[0],[getNoteFromInterval(t,"major 3")[1],a["major 3"]*l]),_defineProperty(n,getNoteFromInterval(t,"augmented 3")[0],[getNoteFromInterval(t,"augmented 3")[1],a["augmented 3"]*l]),_defineProperty(n,getNoteFromInterval(t,"diminished 4")[0],[getNoteFromInterval(t,"diminished 4")[1],a["diminished 4"]*l]),_defineProperty(n,getNoteFromInterval(t,"perfect 4")[0],[getNoteFromInterval(t,"perfect 4")[1],a["perfect 4"]*l]),_defineProperty(n,getNoteFromInterval(t,"augmented 4")[0],[getNoteFromInterval(t,"augmented 4")[1],a["augmented 4"]*l]),_defineProperty(n,getNoteFromInterval(t,"diminished 5")[0],[getNoteFromInterval(t,"diminished 5")[1],a["diminished 5"]*l]),_defineProperty(n,getNoteFromInterval(t,"perfect 5")[0],[getNoteFromInterval(t,"perfect 5")[1],a["perfect 5"]*l]),_defineProperty(n,getNoteFromInterval(t,"augmented 5")[0],[getNoteFromInterval(t,"augmented 5")[1],a["augmented 5"]*l]),_defineProperty(n,getNoteFromInterval(t,"minor 6")[0],[getNoteFromInterval(t,"minor 6")[1],a["minor 6"]*l]),_defineProperty(n,getNoteFromInterval(t,"major 6")[0],[getNoteFromInterval(t,"major 6")[1],a["major 6"]*l]),_defineProperty(n,getNoteFromInterval(t,"augmented 6")[0],[getNoteFromInterval(t,"augmented 6")[1],a["augmented 6"]*l]),_defineProperty(n,getNoteFromInterval(t,"minor 7")[0],[getNoteFromInterval(t,"minor 7")[1],a["minor 7"]*l]),_defineProperty(n,getNoteFromInterval(t,"major 7")[0],[getNoteFromInterval(t,"major 7")[1],a["major 7"]*l]),_defineProperty(n,getNoteFromInterval(t,"augmented 7")[0],[getNoteFromInterval(t,"augmented 7")[1],a["augmented 7"]*l]),_defineProperty(n,getNoteFromInterval(t,"diminished 8")[0],[getNoteFromInterval(t,"diminished 8")[1],a["diminished 8"]*l]),_defineProperty(n,getNoteFromInterval(t,"perfect 8")[0],[getNoteFromInterval(t,"perfect 8")[1],a["perfect 8"]*l]),n),V.noteFrequencies){var u=void 0;c.substring(1,c.length)===FLAT||"b"===c.substring(1,c.length)?(u=c.substring(0,1)+"b",V.noteFrequencies[u]=V.noteFrequencies[c],delete V.noteFrequencies[c]):c.substring(1,c.length)!==SHARP&&"#"!==c.substring(1,c.length)||(u=c.substring(0,1)+"#",V.noteFrequencies[u]=V.noteFrequencies[c],delete V.noteFrequencies[c])}V.changeInTemperament=!1},this.getFrequency=function(e,t){return V._getFrequency(e,t)},this._getFrequency=function(e,t,n){if(t&&(void 0===n?V.temperamentChanged(V.inTemperament,V.startingPitch):V.temperamentChanged(n,V.startingPitch)),"equal"===V.inTemperament){var r,a,o;if("string"==typeof e)return r=e.length,a=e.substring(0,r-1),o=Number(e.slice(-1)),pitchToFrequency(a,o,0,"c major");if("number"==typeof e)return e;for(var s=[],i=0;i<e.length;i++)"string"==typeof e[i]?(r=e[i].length,a=e[i].substring(0,r-1),o=Number(e[i].slice(-1)),s.push(pitchToFrequency(a,o,0,"c major"))):s.push(e[i]);return s}function l(e){var t=e.length;for(var n in V.noteFrequencies)if(n===e.substring(0,t-1)){if(V.noteFrequencies[n][0]===Number(e.slice(-1)))return V.noteFrequencies[n][1];var r=Number(e.slice(-1))-V.noteFrequencies[n][0];return V.noteFrequencies[n][1]*Math.pow(2,r)}}if("string"==typeof e)return l(e);if("object"!==_typeof(e))return e;for(var c=[],u=0;u<e.length;u++)"string"==typeof e[u]?c.push(l(e[u])):c.push(e[u]);return c},this.getCustomFrequency=function(e,l){function t(e,t){var n=e.slice(-1);e=getCustomNote(e.substring(0,e.length-1));var r=t,a=pitchToFrequency(r.substring(0,r.length-1),r.slice(-1),0,"C Major");if("number"!=typeof e){var o=getTemperament(l);for(var s in o)if("pitchNumber"!==s&&(isCustomTemperament(l)&&e===o[s][3]||e===o[s][1])){var i=n-o[s][2];return Number(o[s][0]*a*Math.pow(getOctaveRatio(),i))}}return e}if("string"==typeof e)return t(e,V.startingPitch);if("object"!==_typeof(e))return e;for(var n=[],r=0;r<e.length;r++)"string"==typeof e[r]?n.push(t(e[r],V.startingPitch)):n.push(e[r]);return n},this.resume=function(){null===V.tone&&V.newTone(),V.tone.context.resume()},this.loadSamples=function(){V.samplesManifest={voice:[{name:"piano",data:PIANO_SAMPLE},{name:"violin",data:VIOLIN_SAMPLE},{name:"viola",data:VIOLA_SAMPLE},{name:"double bass",data:DOUBLEBASS_SAMPLE},{name:"cello",data:CELLO_SAMPLE},{name:"flute",data:FLUTE_SAMPLE},{name:"clarinet",data:CLARINET_SAMPLE},{name:"saxophone",data:SAXOPHONE_SAMPLE},{name:"trumpet",data:TRUMPET_SAMPLE},{name:"oboe",data:OBOE_SAMPLE},{name:"trombone",data:TROMBONE_SAMPLE},{name:"tuba",data:TUBA_SAMPLE},{name:"guitar",data:GUITAR_SAMPLE},{name:"acoustic guitar",data:ACOUSTIC_GUITAR_SAMPLE},{name:"bass",data:BASS_SAMPLE},{name:"banjo",data:BANJO_SAMPLE},{name:"koto",data:KOTO_SAMPLE},{name:"dulcimer",data:DULCIMER_SAMPLE},{name:"electric guitar",data:ELECTRICGUITAR_SAMPLE},{name:"bassoon",data:BASSOON_SAMPLE},{name:"celeste",data:CELESTE_SAMPLE},{name:"vibraphone",data:VIBRAPHONE_SAMPLE},{name:"xylophone",data:XYLOPHONE_SAMPLE},{name:"sitar",data:SITAR_SAMPLE},{name:"harmonium",data:HARMONIUM_SAMPLE},{name:"mandolin",data:MANDOLIN_SAMPLE}],drum:[{name:"bottle",data:BOTTLE_SAMPLE},{name:"clap",data:CLAP_SAMPLE},{name:"darbuka drum",data:DARBUKA_SAMPLE},{name:"hi hat",data:HIHAT_SAMPLE},{name:"splash",data:SPLASH_SAMPLE},{name:"bubbles",data:BUBBLES_SAMPLE},{name:"raindrop",data:RAINDROP_SAMPLE},{name:"cow bell",data:COWBELL_SAMPLE},{name:"dog",data:DOG_SAMPLE},{name:"kick drum",data:KICK_SAMPLE},{name:"tom tom",data:TOM_SAMPLE},{name:"cat",data:CAT_SAMPLE},{name:"crash",data:CRASH_SAMPLE},{name:"duck",data:DUCK_SAMPLE},{name:"ride bell",data:RIDEBELL_SAMPLE},{name:"triangle bell",data:TRIANGLE_SAMPLE},{name:"chime",data:CHIME_SAMPLE},{name:"gong",data:GONG_SAMPLE},{name:"cricket",data:CRICKET_SAMPLE},{name:"finger cymbals",data:FINGERCYMBAL_SAMPLE},{name:"slap",data:SLAP_SAMPLE},{name:"japanese drum",data:JAPANESE_DRUM_SAMPLE},{name:"clang",data:CLANG_SAMPLE},{name:"cup drum",data:CUP_SAMPLE},{name:"floor tom",data:FLOORTOM_SAMPLE},{name:"bass drum",data:BASSDRUM_SAMPLE},{name:"snare drum",data:SNARE_SAMPLE}]};if(V.samplesManifest.voice.push({name:"empty",data:function(){return null}}),null===V.samples)for(var e in V.samples={},V.samplesManifest)V.samplesManifest.hasOwnProperty(e)&&(V.samples[e]={})},this._loadSample=function(e){for(var t in V.samplesManifest)if(V.samplesManifest.hasOwnProperty(t))for(var n in V.samplesManifest[t]){var r;!V.samplesManifest[t].hasOwnProperty(n)||e===(r=V.samplesManifest[t][n].name)&&(V.samples[t][r]=V.samplesManifest[t][n].data())}},this.samplesQueue=[],require(SOUNDSAMPLESDEFINES,function(){V.loadSamples();for(var e=0;e<V.samplesQueue.length;e++)V.__createSynth(0,V.samplesQueue[e][0],V.samplesQueue[e][1],V.samplesQueue[e][2])}),this.setupRecorder=function(){var e=Tone.getContext().createMediaStreamDestination(),s=[],t=e.stream;for(var n in platform.FF?V.recorder=new MediaRecorder(t,{type:"audio/wav"}):V.recorder=new MediaRecorder(t,{mimeType:"audio/webm"}),instruments)for(var r in instruments[n])instruments[n][r].connect(e);V.recorder.ondataavailable=function(e){void 0!==e.data&&0!==e.data.size&&s.push(e.data)};V.recorder.onstop=function(){var e,t,n,r,a,o;s.length&&(e=platform.FF?new Blob(s,{type:"audio/wav"}):new Blob(s,{type:"audio/ogg"}),s=[],t=URL.createObjectURL(e),(n=window.prompt("Enter file name","recording"))?(r=t,a=n+(platform.FF?".wav":".ogg"),(o=document.createElement("a")).download=a,o.href=r,document.body.appendChild(o),o.click(),document.body.removeChild(o)):alert("Download cancelled."))}},this.getDefaultParamValues=function(e){var t,n=e.toLowerCase();switch(null!==getOscillatorTypes(n)&&(n=getOscillatorTypes(n)),n){case"amsynth":t={harmonicity:1,detune:0,envelope:{attack:.01,decay:.01,sustain:1,release:.5},modulation:{type:"square"},modulationEnvelope:{attack:.5,decay:.001,sustain:1,release:.5}};break;case"fmsynth":t={harmonicity:1,modulationIndex:10,detune:0,envelope:{attack:.01,decay:.01,sustain:1,release:.5},modulation:{type:"square"},modulationEnvelope:{attack:.5,decay:.001,sustain:1,release:.5}};break;case"noise1":t={noise:{type:"white"},envelope:{attack:.005,decay:.1,sustain:1}};break;case"noise2":t={noise:{type:"brown"},envelope:{attack:.005,decay:.1,sustain:1}};break;case"noise3":t={noise:{type:"pink"},envelope:{attack:.005,decay:.1,sustain:1}};break;case"simple 1":case"simple 2":case"simple 3":case"simple 4":t={oscillator:{type:"sine"},envelope:{attack:.03,decay:.001,sustain:1,release:.03}};break;case"duosynth":t={vibratoAmount:.5,vibratoRate:5,harmonicity:1.5,voice0:{volume:-10,portamento:0,oscillator:{type:"sine"},filterEnvelope:{attack:.01,decay:.001,sustain:1,release:.5},envelope:{attack:.01,decay:.001,sustain:1,release:.5}},voice1:{volume:-10,portamento:0,oscillator:{type:"sine"},filterEnvelope:{attack:.01,decay:.001,sustain:1,release:.5},envelope:{attack:.01,decay:.001,sustain:1,release:.5}}};break;case"sine":case"triangle":case"square":case"sawtooth":t={oscillator:{type:n},envelope:{attack:.03,decay:.001,sustain:1,release:.03}};break;case"pluck":t={attackNoise:1,dampening:4e3,resonance:.9};break;case"poly":t={polyphony:POLYCOUNT};break;default:t={}}return t},this.createDefaultSynth=function(e){console.debug("create default poly/default/custom synth for turtle "+e);var t=new Tone.PolySynth(Tone.AMSynth,POLYCOUNT).toDestination();instruments[e]["electronic synth"]=t,instrumentsSource["electronic synth"]=[0,"electronic synth"],instruments[e].custom=t,instrumentsSource.custom=[0,"custom"]},this._createSampleSynth=function(e,t,n){var r,a,o,s,i;if(n in V.samples.voice){instrumentsSource[t]=[2,n];var l={};if(n in SAMPLECENTERNO)l[SAMPLECENTERNO[n][0]]=V.samples.voice[n];else if(n in MULTIPITCH){for(var c=0;c<MULTIPITCH[n].length;c++)l[MULTIPITCH[n][c]]=V.samples.voice[n][c];r=new Tone.Sampler(l)}else l.C4=V.samples.voice[n];r=new Tone.Sampler(l)}else{r=n in V.samples.drum?(instrumentsSource[t]=[1,n],new Tone.Player(V.samples.drum[n])):n in CUSTOMSAMPLES?(instrumentsSource[t]=[2,n],a={},o=CUSTOMSAMPLES[n],s=V._parseSampleCenterNo(o[1],o[2]),0!==(i=o[4]||0)&&(V.sampleCentAdjustments||(V.sampleCentAdjustments={}),V.sampleCentAdjustments[n]=i),a[s]=o[0],new Tone.Sampler(a)):(instrumentsSource[t]=[1,"drum"],new Tone.Player(V.samples.drum[DEFAULTDRUM]))}return r},this._parseSampleCenterNo=function(e,t){var n={do:0,re:2,mi:4,fa:5,sol:7,la:9,ti:11},r={C:0,D:2,E:4,F:5,G:7,A:9,B:11},a=(a=getArticulation(e))===SHARP?1:a===FLAT?-1:a===DOUBLESHARP?2:a===DOUBLEFLAT?-2:0,o=e.replace(a,""),s=0;o in n?s=n[o]:o in r?s=r[o]:console.debug("Cannot parse "+o);var i=12*t+s+a;return console.log(e+t+" = "+i),i.toString()},this._createBuiltinSynth=function(e,t,n,r){var a,o;switch(n in s&&(a=V.getDefaultParamValues(n),a=validateAndSetParams(a,r)),n){case"simple 1":case"simple 2":case"simple 3":case"simple 4":instrumentsSource[t]=[3,n],o=new Tone.Synth(a);break;case"sine":case"triangle":case"square":case"sawtooth":instrumentsSource[t]=[3,n],o=new Tone.Synth(a);break;case"pluck":instrumentsSource[t]=[3,n],o=new Tone.PluckSynth(a);break;case"poly":instrumentsSource[t]=[0,"poly"],o=new Tone.PolySynth(Tone.AMSynth,a.polyphony);break;case"noise1":case"noise2":case"noise3":instrumentsSource[t]=[4,n],o=new Tone.NoiseSynth(a);break;default:instrumentsSource[t]=[0,"poly"],o=new Tone.PolySynth(Tone.AMSynth,POLYCOUNT)}return o},this._createCustomSynth=function(e,t){var n=V.getDefaultParamValues(e),n=validateAndSetParams(n,t),r="amsynth"===e.toLowerCase()?new Tone.AMSynth(n):"fmsynth"===e.toLowerCase()?new Tone.FMSynth(n):"duosynth"===e.toLowerCase()?new Tone.DuoSynth(n):new Tone.PolySynth(Tone.AMSynth,POLYCOUNT);return r},this.__createSynth=function(e,t,n,r){V._loadSample(n),n in V.samples.voice||n in V.samples.drum?instruments[e][t]||(instruments[e][t]=V._createSampleSynth(e,t,n,r)):n in s?(instruments[e]&&instruments[e][t]&&delete instruments[e][t],instruments[e][t]||(instruments[e][t]=V._createBuiltinSynth(e,t,n,r))):n in a?(instruments[e]&&instruments[e][t]&&delete instruments[e][t],instruments[e][t]||(instruments[e][t]=V._createCustomSynth(n,r)),instrumentsSource[t]=[0,"poly"]):n in CUSTOMSAMPLES?(instruments[e]&&instruments[e][t]&&delete instruments[e][t],instruments[e][t]||(instruments[e][t]=V._createSampleSynth(e,t,n,r))):4<=n.length&&("http"===n.slice(0,4)||"file"===n.slice(0,4)?(instruments[e][n]=new Tone.Sampler(n).toDestination(),instrumentsSource[t]=[1,"drum"]):"drum"===n&&(instruments[e][n]=V._createSampleSynth(e,n,n,null).toDestination(),instrumentsSource[t]=[1,"drum"]))},this.createSynth=function(e,t,n,r){null===V.samples?(V.samplesQueue.push([t,n,r]),require(SOUNDSAMPLESDEFINES,function(){V.loadSamples()})):V.__createSynth(e,t,n,r)},this.loadSynth=function(e,t){return"customsample_"===t.substring(0,13)?console.debug("loading custom "+t):console.debug("loading "+t),V.createSynth(e,t,t,null),V.setVolume(e,t,last(Singer.masterVolume)),t in instruments[e]?instruments[e][t].toDestination():null},this._performNotes=function(){var i=_asyncToGenerator(regeneratorRuntime.mark(function e(n,t,r,a,o,s,i){var l,c,u,m,d,p,g,h,f,y,v,b,_,S,T,A,E,C,w,P,F,M;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("equal"===V.inTemperament||isCustomTemperament(V.inTemperament)||"number"==typeof t||(l=t,void 0===(t=V._getFrequency(t,V.changeInTemperament))&&(t=l.substring(1,l.length-1)==DOUBLEFLAT?l.substring(0,1)+"bb"+l.substring(l.length-1,l.length):l.substring(1,l.length-1)===DOUBLESHARP?l.substring(0,1)+"x"+l.substring(l.length-1,l.length):l)),isCustomTemperament(V.inTemperament)&&(-1===(c=t).search("[+]")&&-1===t.search("[-]")||(t=V.getCustomFrequency(t,V.inTemperament)),void 0!==t&&"undefined"!==t||(t=c)),m=[],d=[],e.prev=4,null===a&&null===o)return e.prev=6,e.next=9,Tone.ToneAudioBuffer.loaded();e.next=17;break;case 9:n.triggerAttackRelease(t,r,Tone.now()+i),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(6),console.debug("Error triggering note:",e.t0);case 15:e.next=36;break;case 17:if(null!=o)for(u=o.length,p=0;p<u;p++)g=new Tone.Filter(o[p].filterFrequency,o[p].filterType,o[p].filterRolloff),m.push(g),n.chain(m[p],Tone.Destination);if(null!=a){if(a.doVibrato&&(h=new Tone.Vibrato(1/a.vibratoFrequency,a.vibratoIntensity),n.chain(h,Tone.Destination),d.push(h)),a.doDistortion&&(v=new Tone.Distortion(a.distortionAmount).toDestination(),n.connect(v,Tone.Destination),d.push(v)),a.doTremolo&&(f=new Tone.Tremolo({frequency:a.tremoloFrequency,depth:a.tremoloDepth}).toDestination().start(),n.chain(f),d.push(f)),a.doPhaser&&(y=new Tone.Phaser({frequency:a.rate,octaves:a.octaves,baseFrequency:a.baseFrequency}).toDestination(),n.chain(y,Tone.Destination),d.push(y)),a.doChorus&&(b=new Tone.Chorus({frequency:a.chorusRate,delayTime:a.delayTime,depth:a.chorusDepth}).toDestination(),n.chain(b,Tone.Destination),d.push(b)),a.doPartials)if(void 0!==n.oscillator)n.oscillator.partials=a.partials;else if(void 0!==n.voices)for(S=0;S<n.voices.length;S++)n.voices[S].oscillator.partials=a.partials;if(a.doPortamento)if(void 0!==n.oscillator)n.portamento=a.portamento;else if(void 0!==n.voices)for(T=0;T<n.voices.length;T++)n.voices[T].portamento=a.portamento;if(a.doNeighbor){for(A=a.neighborArgBeat,E=a.neighborArgCurrentBeat,C=[],w=0;w<a.neighborArgNote1.length;w++)P=a.neighborArgNote1[w].replace("â™¯","#").replace("â™­","b"),F=a.neighborArgNote2[w].replace("â™¯","#").replace("â™­","b"),C.push({time:0,note:P,duration:A},{time:A,note:F,duration:A},{time:2*A,note:P,duration:E});_=new Tone.Part(function(e,t){n.triggerAttackRelease(t.note,t.duration,e)},C).start(),d.push(_)}}if(a.doNeighbor){e.next=35;break}if(void 0===s||!s){e.next=26;break}if(void 0!==n.oscillator)n.setNote(t);else if(void 0!==n.voices)for(M=0;M<n.voices.length;M++)n.voices[M].setNote(t);e.next=35;break;case 26:return e.prev=26,e.next=29,Tone.ToneAudioBuffer.loaded();case 29:n.triggerAttackRelease(t,r,Tone.now()+i),e.next=35;break;case 32:e.prev=32,e.t1=e.catch(26),console.debug("Error triggering note:",e.t1);case 35:setTimeout(function(){try{d.forEach(function(e){e&&"function"==typeof e.dispose&&e.dispose()}),0<m.length&&m.forEach(function(e){e&&"function"==typeof e.dispose&&e.dispose()})}catch(e){console.debug("Error disposing effects:",e)}},1e3*r);case 36:e.next=43;break;case 38:e.prev=38,e.t2=e.catch(4),console.error("Error in _performNotes:",e.t2),d.forEach(function(e){e&&"function"==typeof e.dispose&&e.dispose()}),m.forEach(function(e){e&&"function"==typeof e.dispose&&e.dispose()});case 43:case"end":return e.stop()}},e,null,[[4,38],[6,12],[26,32]])}));return function(e,t,n,r,a,o,s){return i.apply(this,arguments)}}(),this.trigger=function(){var l=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n,r,a,o,s,i,l){var c,u,m,d,p,g;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,"running"!==Tone.context.state)return e.next=4,Tone.start();e.next=4;break;case 4:if(["sine","sawtooth","triangle","square"].includes(a)?o=null:null!=o&&(0!==o.vibratoIntensity&&(o.doVibrato=!0),0!==o.distortionAmount&&(o.doDistortion=!0),0!==o.tremoloFrequency&&(o.doTremolo=!0),0!==o.rate&&(o.doPhaser=!0),0!==o.chorusRate&&(o.doChorus=!0),o.neighborSynth&&(o.doNeighbor=!0)),c=n,u=instruments[t]["electronic synth"],m=0,a in instruments[t]&&(u=instruments[t][a],1!==(m=instrumentsSource[a][0])&&2!==m||(d=instrumentsSource[a][1],2===m&&V.sampleCentAdjustments&&V.sampleCentAdjustments[d]&&(p=V.sampleCentAdjustments[d],g=Math.pow(2,p/1200),u&&u.playbackRate&&(u.playbackRate.value=g)))),void 0===l&&(l=0),u){e.next=16;break}return console.warn("Synth not initialized, creating default synth"),V.createDefaultSynth(t),e.next=15,V.loadSynth(t,a);case 15:u=instruments[t][a];case 16:e.t0=m,e.next=1===e.t0?19:2===e.t0?21:3===e.t0?24:4===e.t0?28:(e.t0,30);break;case 19:if("http"===a.slice(0,4)||"data:audio/wav;base64"===a.slice(0,21))u.start(Tone.now()+l);else if("file"===a.slice(0,4))u.start(Tone.now()+l);else try{u.start(Tone.now()+l)}catch(e){console.debug("Error starting drum synth:",e)}return e.abrupt("break",33);case 21:return e.next=23,V._performNotes(u.toDestination(),n,r,o,s,i,l);case 23:return e.abrupt("break",33);case 24:return"object"===_typeof(n)&&(c=n[0]),e.next=27,V._performNotes(u.toDestination(),c,r,o,s,i,l);case 27:return e.abrupt("break",33);case 28:return u.triggerAttackRelease("c2",r,Tone.now()+l),e.abrupt("break",33);case 30:return e.next=32,V._performNotes(u.toDestination(),c,r,o,s,i,l);case 32:return e.abrupt("break",33);case 33:e.next=38;break;case 35:e.prev=35,e.t1=e.catch(0),console.error("Error in trigger:",e.t1);case 38:case"end":return e.stop()}},e,null,[[0,35]])}));return function(e,t,n,r,a,o,s,i){return l.apply(this,arguments)}}(),this.startSound=function(e,t,n){switch(instrumentsSource[t][0]){case 1:instruments[e][t].start();break;default:instruments[e][t].triggerAttack(n)}},this.stopSound=function(e,t,n){switch(instrumentsSource[t][0]){case 1:instruments[e][t].stop();break;default:null==n?instruments[e][t].triggerRelease():instruments[e][t].triggerRelease(n)}},this.loop=function(t,n,r,a,e,o,s){var i=instruments[t][n],l=instrumentsSource[n][0],c=Tone.now();return new Tone.Loop(function(e){1==l?(V.setVolume(t,n,100*s),instruments[t][n].start()):i.triggerAttackRelease(r,a,c+e,s)},60/o).start(e)},this.start=function(){Tone.Transport.start()},this.stop=function(){Tone.Transport.stop()},this.rampTo=function(e,t,n,r,a){var o,s,i,l;percussionInstruments.includes(t)||stringInstruments.includes(t)||(s=t in DEFAULTSYNTHVOLUME?(o=DEFAULTSYNTHVOLUME[t],50<r?(r-50)/50*(100-o)+o:r/50*o):r,i=Tone.gainToDb(s/100),l=instruments[e]["electronic synth"],t in instruments[e]&&(l=instruments[e][t]),console.debug("Crescendo(decibels)",t,":",l.volume.value,"to",i,"t:",a),console.debug("Crescendo",t,":",n,"to",r,"t:",a),l.volume.linearRampToValueAtTime(i,Tone.now()+a))},this.getVolume=function(e,t){return instruments[e]&&instruments[e][t]?instruments[e][t].volume.value:(console.debug("instrument not found"),50)},this.setVolume=function(e,t,n){var r,a;a=t in DEFAULTSYNTHVOLUME?(r=DEFAULTSYNTHVOLUME[t],50<n?(n-50)/50*(100-r)+r:n/50*r):n;var o=Tone.gainToDb(a/100);t in instruments[e]&&(instruments[e][t].volume.value=o)},this.setMasterVolume=function(e,t,n){var r;instruments[0]["electronic synth"]||V.createDefaultSynth(0),null===t&&null===n?(Tone.Destination.volume.rampTo(0,.01),V.setVolume(0,"electronic synth",e),setTimeout(function(){V.trigger(0,"G4",.25,"electronic synth",null,null,!1)},200)):(r=Tone.gainToDb(e/100),Tone.Destination.volume.rampTo(r,.01))},this.startRecording=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Tone.start();case 2:return V.mic=new Tone.UserMedia,V.recorder=new Tone.Recorder,e.next=6,V.mic.open().then(function(){console.log("Mic opened"),V.mic.connect(V.recorder),V.recorder.start()}).catch(function(e){console.log(e)});case 6:case"end":return e.stop()}},e)})),this.stopRecording=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,V.recorder.stop();case 2:return V.recording=e.sent,V.mic.close(),V.audioURL=URL.createObjectURL(V.recording),e.abrupt("return",V.audioURL);case 6:case"end":return e.stop()}},e)})),this.playRecording=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return V.player=(new Tone.Player).toDestination(),e.next=3,V.player.load(V.audioURL);case 3:V.player.start();case 4:case"end":return e.stop()}},e)})),this.stopPlayBackRecording=function(){V.player.stop()},this.LiveWaveForm=function(){V.analyser=new Tone.Analyser("waveform",8192),V.mic.connect(V.analyser)},this.getWaveFormValues=function(){return V.analyser.getValue()},this.startTuner=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,j,U,B,W;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(window.activity||(window.activity={blocks:{blockList:[],setPitchOctave:function(){},findPitchOctave:function(){return 4},stageClick:!1},logo:{synth:V},canvas:document.createElement("canvas"),blocksContainer:{x:0,y:0},getStageScale:function(){return 1},KeySignatureEnv:["A","major",!1]}),"function"!=typeof wheelnav)return console.warn("Wheelnav library not found, attempting to load it"),(t=document.createElement("script")).src="lib/wheelnav/wheelnav.min.js",document.head.appendChild(t),e.next=8,new Promise(function(e){t.onload=e});e.next=8;break;case 8:if("function"!=typeof Raphael)return console.warn("Raphael library not found, attempting to load it"),(n=document.createElement("script")).src="lib/raphael.min.js",document.head.appendChild(n),e.next=15,new Promise(function(e){n.onload=e});e.next=15;break;case 15:return e.next=17,Tone.start();case 17:if(instruments[0]||(instruments[0]={}),instruments[0]["electronic synth"]){e.next=23;break}return V.createDefaultSynth(0),e.next=22,V.loadSynth(0,"electronic synth");case 22:V.setVolume(0,"electronic synth",50);case 23:return V.tunerMic&&V.tunerMic.close(),e.next=26,Tone.start();case 26:return V.tunerMic=new Tone.UserMedia,e.next=29,V.tunerMic.open();case 29:j=new Tone.Analyser("waveform",2048),V.tunerMic.connect(j),U=function(s,e,t){function i(e){var a,n=(a=e).map(function(e,r){return a.slice(0,a.length-r).reduce(function(e,t,n){return e+t*a[n+r]},0)});return n.map(function(e,t){return n[0]+n[t]-2*n[t]})}var l=2<arguments.length&&void 0!==t?t:.1;return function(e){e=function(e,t){var n=1<arguments.length&&void 0!==t?t:500,r=2*Math.PI*n/s;return e.map(function(e,t,n){return 0<t?r*e+(1-r)*n[t-1]:e})}(e,300);var n,t=i(e),r=(n=0,t.map(function(e,t){return n+=e,0===t?1:e/(n/t)})),a=function(e){for(var t=2;t<e.length;t++)if(e[t]<l){for(;t+1<e.length&&e[t+1]<e[t];)t++;return t}return-1}(r);if(-1===a)return-1;var o=function(e,t){var n=t<1?t:t-1,r=t+1<e.length?t+1:t;if(n===t)return e[t]<=e[r]?t:r;if(r===t)return e[t]<=e[n]?t:n;var a=e[n],o=e[t],s=e[r];return t+(r-n)*(a-s)/(2*(a-2*o+s))}(r,a);return s/o}}(Tone.context.sampleRate),B="chromatic",W={note:"A4",frequency:440},function e(){var t,n,r,a,o,s,i,l,c,u,m,h,d,p,g,f,y,v,b,_,S,T,A,E,C,w,P,F,M,x,k,L,I,N,O,D,R=j.getValue(),q=U(R);0<q&&(t=H(q),"chromatic"===B?(c=t.note,i=t.cents):(c=t.note,console.log("Debug values:",{detectedPitch:q,targetNote:W.note,targetFrequency:W.frequency,currentNote:c}),0<q&&0<W.frequency?(n=1200*Math.log2(q/W.frequency),r=Math.round(n/100),a=Math.floor(Math.abs(r)/12),o=Math.abs(r)%12,100<=Math.abs(n)?(s=0<n?"+":"-",i=Math.round(n),l=s,0<a&&(l+=a+" octave"+(1<a?"s":""),0<o&&(l+=" ")),0<o&&(l+=o+" semitone"+(1<o?"s":"")),V.displayText=l):(i=Math.round(n),V.displayText="".concat(0<i?"+":"").concat(i," cents"))):(i=0,V.displayText="0 cents")),console.log({frequency:q.toFixed(1),detectedNote:c,centsDeviation:i,mode:B}),u=document.getElementById("noteDisplayContainer"),m=document.getElementById("tunerContainer"),!u&&m&&((u=document.createElement("div")).id="noteDisplayContainer",u.style.position="absolute",u.style.top="62%",u.style.left="50%",u.style.transform="translate(-50%, -50%)",u.style.textAlign="center",u.style.fontFamily="Arial, sans-serif",u.style.zIndex="1000",(h=document.createElement("div")).id="targetNoteSelector",h.style.position="absolute",h.style.top="-40px",h.style.left="50%",h.style.transform="translateX(-50%)",h.style.color="#666666",h.style.fontSize="24px",h.style.cursor="pointer",h.style.transition="opacity 0.2s ease",h.style.opacity="0.7",h.textContent=W.note,h.addEventListener("mouseenter",function(){h.style.opacity="1"}),h.addEventListener("mouseleave",function(){h.style.opacity="0.7"}),(d=docById("wheelDiv"))||((d=document.createElement("div")).id="wheelDiv",d.style.position="absolute",d.style.display="none",d.style.zIndex="1500",document.body.appendChild(d)),h.addEventListener("click",function(){"target"===B&&function(){var c=["ti","la","sol","fa","mi","re","do"],u=["B","A","G","F","E","D","C"],m=["ð„ª","â™¯","â™®","â™­","ð„«"],d=W.note[0],p=1<W.note.length?W.note.substring(1):"â™®",g=c[u.indexOf(d)];""===p&&(p="â™®");try{!function(e){var r=(_defineProperty(e={container:{x:h.offsetLeft,y:h.offsetTop},activity:window.activity,blocks:{blockList:[{name:"pitch",connections:[null,null],value:W.note,container:{x:h.offsetLeft,y:h.offsetTop}}],stageClick:!1,setPitchOctave:function(){},findPitchOctave:function(){return 4},turtles:{_canvas:{width:window.innerWidth,height:window.innerHeight},ithTurtle:function(){return{singer:{instrumentNames:["default"]}}}}},connections:[0],value:W.note,text:{text:W.note},updateCache:function(){},_exitWheel:null,_pitchWheel:null,_accidentalsWheel:null,_octavesWheel:null,piemenuOKtoLaunch:function(){return!0},_piemenuExitTime:0},"container",{x:h.offsetLeft,y:h.offsetTop,setChildIndex:function(){}}),_defineProperty(e,"prevAccidental","â™®"),_defineProperty(e,"name","pitch"),_defineProperty(e,"_triggerLock",!1),e);window.activity.logo||(window.activity.logo={synth:{createDefaultSynth:function(){},loadSynth:function(){},setMasterVolume:function(){},trigger:function(e,t,n){var r=new(window.AudioContext||window.webkitAudioContext),a=r.createOscillator(),o=r.createGain();a.connect(o),o.connect(r.destination);var s=pitchToFrequency(t[0],"equal");a.frequency.value=s,o.gain.value=.1,a.start(),o.gain.setValueAtTime(.1,r.currentTime),o.gain.linearRampToValueAtTime(0,r.currentTime+n),a.stop(r.currentTime+n)},inTemperament:"equal"},errorMsg:function(e){console.warn(e)}}),window.activity.KeySignatureEnv=["C","major",!1];var t,n=docById("wheelDiv");n&&(t=h.getBoundingClientRect(),n.style.position="absolute",n.style.left=t.left-250+"px",n.style.top=t.top-250+"px",n.style.width="600px",n.style.height="600px",n.style.zIndex="1500",n.style.backgroundColor="transparent",n.style.display="block"),piemenuPitches(r,c,u,m,g,p);var l={note:d,accidental:p,octave:4};if(r._pitchWheel&&r._pitchWheel.navItems)for(var a=0;a<r._pitchWheel.navItems.length;a++)!function(n){r._pitchWheel.navItems[n].navigateFunction=function(){var e,t=r._pitchWheel.navItems[n].title;t&&c.includes(t)&&(e=c.indexOf(t),l.note=u[e],i())}}(a);if(r._accidentalsWheel&&r._accidentalsWheel.navItems)for(var o=0;o<r._accidentalsWheel.navItems.length;o++)!function(e){r._accidentalsWheel.navItems[e].navigateFunction=function(){l.accidental=r._accidentalsWheel.navItems[e].title,i()}}(o);if(r._octavesWheel&&r._octavesWheel.navItems)for(var s=0;s<r._octavesWheel.navItems.length;s++)!function(t){r._octavesWheel.navItems[t].navigateFunction=function(){var e=r._octavesWheel.navItems[t].title;e&&!isNaN(e)&&(l.octave=parseInt(e),i())}}(s);var i=function(){if(l.note){var e=l.note;"â™¯"===l.accidental?e+="#":"â™­"===l.accidental?e+="b":"ð„ª"===l.accidental?e+="##":"ð„«"===l.accidental&&(e+="bb");var t=e+l.octave;W.note=t;try{var n=t.match(/([A-G][#b]?)(\d+)/);if(!n)throw new Error("Invalid note format");var r=_slicedToArray(n,3),a=r[1],o=r[2],s={C:261.63,"C#":277.18,D:293.66,"D#":311.13,E:329.63,F:349.23,"F#":369.99,G:392,"G#":415.3,A:440,"A#":466.16,B:493.88}[a.replace("b","#").replace("bb","##")];if(!s)throw new Error("Invalid note");var i=parseInt(o)-4;s*=Math.pow(2,i),W.frequency=s,console.log("Target pitch updated:",{note:t,frequency:W.frequency}),(isNaN(W.frequency)||W.frequency<=0)&&(console.error("Invalid frequency calculated:",W.frequency),W.frequency=440)}catch(e){console.error("Error calculating frequency:",e),W.frequency=440}h.textContent=t}};r._exitWheel&&r._exitWheel.navItems&&(r._exitWheel.navItems[0].navigateFunction=function(){r._pitchWheel&&r._pitchWheel.removeWheel(),r._accidentalsWheel&&r._accidentalsWheel.removeWheel(),r._octavesWheel&&r._octavesWheel.removeWheel(),r._exitWheel&&r._exitWheel.removeWheel(),n.style.display="none"})}()}catch(e){console.error("Error opening pie menu:",e)}}()}),u.appendChild(h),(p=document.createElement("div")).id="modeToggle",p.style.position="absolute",p.style.top="30px",p.style.left="50%",p.style.transform="translateX(-50%)",p.style.display="flex",p.style.backgroundColor="#FFFFFF",p.style.borderRadius="25px",p.style.padding="3px",p.style.boxShadow="0 2px 8px rgba(0,0,0,0.1)",p.style.width="120px",p.style.height="44px",p.style.cursor="pointer",(g=document.createElement("div")).style.flex="1",g.style.display="flex",g.style.alignItems="center",g.style.justifyContent="center",g.style.borderRadius="22px",g.style.cursor="pointer",g.style.transition="all 0.2s ease",g.style.userSelect="none",g.title="Chromatic",(f=document.createElement("div")).style.flex="1",f.style.display="flex",f.style.alignItems="center",f.style.justifyContent="center",f.style.borderRadius="22px",f.style.cursor="pointer",f.style.transition="all 0.2s ease",f.style.userSelect="none",f.title="Target pitch",(y=document.createElement("img")).src="header-icons/chromatic-mode.svg",y.style.width="32px",y.style.height="32px",y.style.filter="brightness(0)",y.style.pointerEvents="none",(v=document.createElement("img")).src="header-icons/target-pitch-mode.svg",v.style.width="32px",v.style.height="32px",v.style.filter="brightness(0)",v.style.pointerEvents="none",b=function(){"chromatic"===B?(g.style.backgroundColor="#A6CEFF",f.style.backgroundColor="#FFFFFF"):(g.style.backgroundColor="#FFFFFF",f.style.backgroundColor="#A6CEFF")},_=!0,S=function(e){_&&(_=!1,B=e,b(),setTimeout(function(){_=!0},200))},g.onclick=function(){return S("chromatic")},f.onclick=function(){return S("target")},g.appendChild(y),f.appendChild(v),p.appendChild(g),p.appendChild(f),b(),m.appendChild(p),(T=document.createElement("div")).id="noteText",T.style.fontSize="64px",T.style.fontWeight="bold",T.style.marginBottom="5px",(A=document.createElement("div")).id="centsText",A.style.fontSize="14px",A.style.color="#666666",A.style.marginBottom="5px",(E=document.createElement("div")).id="tuneDirection",E.style.fontSize="18px",E.style.color="#FF4500",u.appendChild(T),u.appendChild(A),u.appendChild(E),m.appendChild(u)),u&&(C=document.getElementById("noteText"),w=document.getElementById("centsText"),P=document.getElementById("tuneDirection"),F=document.getElementById("targetNoteSelector"),C&&(C.textContent=c),w&&(w.textContent=V.displayText||("target"===B?"0 cents":"".concat(0<i?"+":"").concat(Math.round(i)," cents"))),F&&(F.style.display="target"===B?"block":"none",F.textContent=W.note),P&&(P.textContent="",P.style.color=Math.abs(i)<=5?"#00FF00":"#FF4500")),M=document.querySelectorAll("#tunerContainer svg path"),x="#FF0000",k="#FF4500",L="#FFA500",I="#FFB833",N="#9ACD32",O="#00FF00",D="#D3D3D3",M.forEach(function(e,t){var n=10*(t-5),r=D;if("chromatic"===B){Math.abs(i);if((i<0?n<=0&&Math.abs(n)<=Math.abs(i):0<=n&&n<=i)||Math.abs(i-n)<=5)if(5===t)r=Math.abs(i)<=5?O:D;else if(t<5)switch(t){case 0:r=x;break;case 1:r=k;break;case 2:r=L;break;case 3:r=I;break;case 4:r=N}else switch(t){case 6:r=N;break;case 7:r=I;break;case 8:r=L;break;case 9:r=k;break;case 10:r=x}}else{var a=i;if(50<Math.abs(a))a<0?0===t&&(r=x):10===t&&(r=x);else if((a<0?n<=0&&Math.abs(n)<=Math.abs(a):0<=n&&n<=a)||Math.abs(a-n)<=5)if(5===t)r=Math.abs(a)<=5?O:D;else if(t<5)switch(t){case 0:r=x;break;case 1:r=k;break;case 2:r=L;break;case 3:r=I;break;case 4:r=N}else switch(t){case 6:r=N;break;case 7:r=I;break;case 8:r=L;break;case 9:r=k;break;case 10:r=x}}e.style.transition="fill 0.1s ease-in-out",e.setAttribute("fill",r)})),requestAnimationFrame(e)}();case 37:case"end":return e.stop()}},e)})),this.stopTuner=function(){V.tunerMic&&V.tunerMic.close()};var H=function(e){if(e<=0)return{note:"---",cents:0};var t=69+12*Math.log2(e/440),n=Math.round(t),r=Math.round(100*(t-n));50<r?n++:r<-50&&n--;var a=(n%12+12)%12,o=Math.floor((n-12)/12);return{note:["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][a]+o,cents:r}};return this.getTunerFrequency=function(){if(!V.tunerAnalyser)return 440;V.tunerAnalyser.getValue();return 440},this.testTuner=function(){var n,r,e,a,o;window.AudioContext?(n=new AudioContext,r=n.createOscillator(),e=n.createGain(),r.connect(e),e.connect(n.destination),e.gain.value=.1,a=[{freq:440,expected:"A4"},{freq:442,expected:"A4"},{freq:438,expected:"A4"},{freq:261.63,expected:"C4"},{freq:329.63,expected:"E4"}],o=0,r.start(),function e(){if(a.length<=o)return r.stop(),void console.log("Tuner tests completed");var t=a[o];console.log("Testing frequency: ".concat(t.freq,"Hz (Expected: ").concat(t.expected,")")),r.frequency.setValueAtTime(t.freq,n.currentTime),o++,setTimeout(e,2e3)}()):console.error("Web Audio API not supported")},this.testSpecificFrequency=function(e){var t,n,r;window.AudioContext?(t=new AudioContext,n=t.createOscillator(),r=t.createGain(),n.connect(r),r.connect(t.destination),r.gain.value=.1,n.frequency.setValueAtTime(e,t.currentTime),n.start(),console.log("Testing frequency: ".concat(e,"Hz")),setTimeout(function(){n.stop(),console.log("Test completed")},3e3)):console.error("Web Audio API not supported")},this.createCentsSlider=function(){var n=this,e=this.widgetWindow.getWidgetBody();this.previousContent=e.innerHTML,e.innerHTML="";var t=document.createElement("div");Object.assign(t.style,{width:"100%",height:"100%",backgroundColor:"#A6CEFF",display:"flex",flexDirection:"column"});var r=document.createElement("div");Object.assign(r.style,{width:"100%",padding:"15px",display:"flex",justifyContent:"space-between",alignItems:"center",boxSizing:"border-box"});var a=document.createElement("div");a.textContent=_("Cents Adjustment"),Object.assign(a.style,{fontWeight:"bold",fontSize:"16px"});var o=document.createElement("div");o.textContent=(0<=this.centsValue?"+":"")+(this.centsValue||0)+"Â¢",Object.assign(o.style,{fontSize:"16px"}),r.appendChild(a),r.appendChild(o),t.appendChild(r);var s=document.createElement("div");Object.assign(s.style,{flex:1,backgroundColor:"#E8E8E8",padding:"20px",display:"flex",flexDirection:"column",gap:"10px"});var i=document.createElement("div");i.textContent=_("reference tone"),Object.assign(i.style,{fontSize:"14px",color:"#666666"}),s.appendChild(i);var l=document.createElement("div");Object.assign(l.style,{width:"100%",padding:"10px 0"});var c=document.createElement("input");Object.assign(c,{type:"range",min:-50,max:50,value:this.centsValue||0,step:1}),Object.assign(c.style,{width:"100%",height:"20px",margin:"10px 0",backgroundColor:"#4CAF50",borderRadius:"10px",appearance:"none",outline:"none"}),l.appendChild(c),s.appendChild(l);var u=document.createElement("div");u.textContent=_("sample"),Object.assign(u.style,{fontSize:"14px",color:"#666666",marginTop:"auto"}),s.appendChild(u),t.appendChild(s),e.appendChild(t),c.oninput=function(){var e,t=parseInt(c.value);o.textContent=(0<=t?"+":"")+t+"Â¢",n.centsValue=t,n.tunerDisplay&&(e=TunerUtils.frequencyToPitch(n._calculateFrequency()),n.tunerDisplay.update(e[0],n.centsValue,e[2])),n.applyCentsAdjustment()},this.sliderDiv=t,this.sliderVisible=!0,this.centsSliderBtn.getElementsByTagName("img")[0].style.filter="brightness(0) invert(1)",this.centsSliderBtn.style.backgroundColor=platformColor.selectorSelected},this.removeCentsSlider=function(){this.sliderDiv&&this.sliderDiv.parentNode&&(this.widgetWindow.getWidgetBody().innerHTML=this.previousContent,this.previousContent=null),this.sliderVisible=!1,this.centsSliderBtn.getElementsByTagName("img")[0].style.filter="",this.centsSliderBtn.style.backgroundColor=""},this.tone=null,this.noteFrequencies={},this.startingPitch="C4",this.startingPitchOctave=4,this.octaveTranspose=0,this.inTemperament="equal",this.changeInTemperament="equal",this.inTransposition=0,this.transposition=2,this.playbackRate=1,this.defaultBPMFactor=1,this.recorder=null,this.samples=null,this.samplesManifest=null,this.sampleCentAdjustments={},this.mic=null,this}