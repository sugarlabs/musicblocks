"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ownKeys(t,e){var n,o=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),o.push.apply(o,n)),o}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(n),!0).forEach(function(e){_defineProperty(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function _defineProperty(e,t,n){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0===n)return("string"===t?String:Number)(e);var o=n.call(e,t||"default");if("object"!=_typeof(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}var fs=require("fs"),path=require("path"),_require=require("util"),TextEncoder=_require.TextEncoder,TextDecoder=_require.TextDecoder;jest.mock("tone"),describe("Utility Functions (logic-only)",function(){var t,n,i,s,a,u,c,l,d,p,f,h,m,y,v,T,x,g,b,S,B,C,E,j,O,q,A,M,H,_,w,P,D,o="turtle1";beforeAll(function(){global.TextEncoder=TextEncoder,global.TextDecoder=TextDecoder,global.MediaRecorder=jest.fn(),global.AudioBuffer=jest.fn(),global.module=module,global.Tone=require("./tonemock.js");var o="";["../../../lib/require.js","../platformstyle.js","../musicutils.js","../synthutils.js","../utils.js","../../logo.js","../../turtle-singer.js"].forEach(function(e){var t=fs.readFileSync(path.join(__dirname,e),"utf8");o+="\n".concat(t)});var r=path.join(__dirname,"../../../sounds/samples");fs.readdirSync(r,"utf8").forEach(function(e){var t,n;e.endsWith(".js")&&(t=path.join(r,e),n=fs.readFileSync(t,"utf8"),o+="\n".concat(n))});var e=new Function("\n            let metaTag = document.querySelector(\"meta[name=theme-color]\");\n            metaTag = document.createElement('meta');\n            metaTag.name = 'theme-color';\n            metaTag.content = \"#4DA6FF\";\n            document.head?.appendChild(metaTag);\n            ".concat(o,'\n            \n            return {\n                Synth: typeof Synth !== "undefined" ? Synth : undefined,\n                instrumentsSource: typeof instrumentsSource !== "undefined" ? instrumentsSource : undefined,\n                instruments: typeof instruments !== "undefined" ? instruments : undefined,\n                SAMPLECENTERNO: typeof SAMPLECENTERNO !== "undefined" ? SAMPLECENTERNO : undefined,\n                CUSTOMSAMPLES: typeof CUSTOMSAMPLES !== "undefined" ? CUSTOMSAMPLES : undefined,\n                DEFAULTSYNTHVOLUME: typeof DEFAULTSYNTHVOLUME !== "undefined" ? DEFAULTSYNTHVOLUME : undefined,\n                  };\n        '))();D=e.Synth(),S=e.instruments,H=e.DEFAULTSYNTHVOLUME,B=e.CUSTOMSAMPLES,SAMPLECENTERNO=e.SAMPLECENTERNO,C=e.instrumentsSource,f=D.createDefaultSynth,t=D.whichTemperament,n=D.temperamentChanged,i=D.getFrequency,s=D._getFrequency,a=D.getCustomFrequency,u=D.resume,c=D.loadSamples,l=D._loadSample,d=D.setupRecorder,p=D.getDefaultParamValues,h=D._createSampleSynth,m=D._parseSampleCenterNo,y=D._createBuiltinSynth,v=D._createCustomSynth,T=D.__createSynth,x=D.createSynth,g=D.loadSynth,D._performNotes,b=D.startSound,E=D.trigger,j=D.stopSound,O=D.loop,q=D.start,A=D.stop,M=D.rampTo,_=D.setVolume,w=D.getVolume,P=D.setMasterVolume}),describe("setupRecorder",function(){it("it should sets up the recorder for the Synth instance.",function(){for(var e in S[o]||(S[o]={}),expect(d()).toBe(void 0),S)for(var t in S[e])expect((n=S[e][t])instanceof Tone.PolySynth||n instanceof Tone.Sampler||n instanceof Tone.Player).toBe(!0);var n})}),describe("createDefaultSynth",function(){it("it should create the default poly/default/custom synth for the specified turtle",function(){f(o),expect(S[o]["electronic synth"]).toBeTruthy(),expect(S[o].custom).toBeTruthy(),expect(C["electronic synth"]).toEqual([0,"electronic synth"]),expect(C.custom).toEqual([0,"custom"])})}),describe("_createBuiltinSynth",function(){it("it should create a synth using builtin synths from Tone.js.",function(){var e=y(o,"guitar","sine",{});expect(e).toBeInstanceOf(Tone.Synth)}),it("it should create a synth using builtin synths from Tone.js.",function(){var e=y(o,"guitar","pluck",{});expect(e).toBeInstanceOf(Tone.PluckSynth)}),it("it should create a synth using builtin synths from Tone.js.",function(){var e=y(o,"guitar","noise3",{});expect(e).toBeInstanceOf(Tone.NoiseSynth)})}),describe("_createCustomSynth",function(){it("it should create an amsynth using Tone.js methods like AMSynth, FMSynth, etc.",function(){var e=v("amsynth",{});expect(e).toBeInstanceOf(Tone.AMSynth)}),it("it should create a fmsynth using Tone.js methods like AMSynth, FMSynth, etc.",function(){var e=v("fmsynth",{});expect(e).toBeInstanceOf(Tone.FMSynth)}),it("it should create a duosynth using Tone.js methods like AMSynth, FMSynth, etc.",function(){var e=v("duosynth",{});expect(e).toBeInstanceOf(Tone.DuoSynth)}),it("it should create a testsynth using Tone.js methods like AMSynth, FMSynth, etc.",function(){var e=v("testsynth",{});expect(e).toBeInstanceOf(Tone.PolySynth)})}),describe("__createSynth",function(){beforeAll(function(){c()}),it("it should create a PolySynth based on the specified parameters, either using samples, built-in synths, or custom synths",function(){T(o,"guitar","guitar",{}),expect(S[o]["electronic synth"]).toBeInstanceOf(Tone.PolySynth)}),it("it should create a PolySynth based on the specified parameters, either using samples, built-in synths, or custom synths",function(){T(o,"guitar","sine",{}),expect(S[o]["electronic synth"]).toBeInstanceOf(Tone.PolySynth)}),it("it should create a amsynth based on the specified parameters, either using samples, built-in synths, or custom synths",function(){T(o,"poly","amsynth",{}),expect(S[o].poly).toBeInstanceOf(Tone.AMSynth)}),it("it should create a CUSTOMSAMPLES based on the specified parameters, either using samples, built-in synths, or custom synths",function(){B.pianoC4="pianoC4",B.drumKick="drumKick";T(o,"piano","pianoC4",{}),expect(S[o].piano).toBeInstanceOf(Tone.Sampler)}),it("it should create a CUSTOMSAMPLES based on the specified parameters, either using samples, built-in synths, or custom synths",function(){var e="drumKick",t="http://example.com/drumKick.wav";T(o,e,t,{}),expect(S[o][t].noteDict).toBe(t),expect(C[e]).toStrictEqual([1,"drum"])}),it("it should create a CUSTOMSAMPLES based on the specified parameters, either using samples, built-in synths, or custom synths",function(){var e="file://testing.wav";T(o,"guitar",e,{}),expect(S[o][e].noteDict).toBe(e),expect(C.guitar).toStrictEqual([1,"drum"])}),it("it should create a CUSTOMSAMPLES based on the specified parameters, either using samples, built-in synths, or custom synths",function(){var e="snare drum";T(o,e,"drum",{}),expect(C[e]).toStrictEqual([1,"drum"])})}),describe("loadSynth",function(){it("it should loads a synth based on the user's input, creating and setting volume for the specified turtle.",function(){var e=g("turtle1","flute");expect(e).toBeTruthy(),expect(e).toBeInstanceOf(Tone.Sampler),expect(S.turtle1).toHaveProperty("flute")})}),describe("trigger",function(){var r="turtle1";test("should process effect parameters correctly",function(){S[r].guitar||(S[r].guitar={triggerAttackRelease:jest.fn()}),E(r,"C4",1,"guitar",{vibratoIntensity:1,distortionAmount:.5,tremoloFrequency:2,rate:1,chorusRate:1.5,neighborSynth:!0},null,!0,0)}),test("should ignore effects for basic waveform instruments",function(){var t=jest.fn(),n=function(e,t,n,o,r,i,s,a){this._performNotes&&this._performNotes(e,t,n,r,i,s,a)}.bind({_performNotes:t}),o={vibratoIntensity:1};["sine","sawtooth","triangle","square"].forEach(function(e){n(r,"C4",1,e,o,null,!0,0),expect(t).toHaveBeenCalledWith(r,"C4",1,{vibratoIntensity:1},null,!0,0)})}),test("should handle array of notes for builtin synth",function(){var e=["C4","E4","G4"],t=jest.fn();(function(e,t,n,o,r,i,s,a){this._performNotes&&this._performNotes(e,t,n,r,i,s,a)}).bind({_performNotes:t})(r,e,1,"builtin",null,null,!0,0),expect(t).toHaveBeenCalledWith("turtle1",e,1,null,null,!0,0)})}),describe("temperamentChanged",function(){it("should change the temperament",function(){expect(n("equal","Bb3")).toBe(void 0),expect(t()).toBe("equal")})}),describe("resume",function(){it("it should resume the Tone.js context",function(){expect(u()).toBe(void 0),expect(Tone).toStrictEqual(Tone)})}),describe("rampTo",function(){it("it should resume the Tone.js context",function(){expect(u()).toBe(void 0),expect(Tone).toStrictEqual(Tone)})}),describe("rampTo function",function(){test("should ramp the volume for non-percussion and non-string instruments",function(){M("turtle1","flute",20,60,5),expect(Tone.gainToDb).toHaveBeenCalledWith(.92),expect(Tone.now).toHaveBeenCalled(),expect(S.turtle1.flute.volume.linearRampToValueAtTime).toHaveBeenCalledWith(4,expect.any(Number))}),test("should not ramp the volume for percussion instruments",function(){M("turtle1","xylophone",20,60,5),expect(Tone.gainToDb).not.toHaveBeenCalled(),expect(S.turtle1.flute.volume.linearRampToValueAtTime).not.toHaveBeenCalled()})}),describe("setVolume function",function(){test("should set the volume for an instrument using DEFAULTSYNTHVOLUME",function(){_("turtle1","flute",80);var e=H.piano,t=.6*(100-e)+e,n=Tone.gainToDb(t/100);expect(Tone.gainToDb).toHaveBeenCalledWith(.96),expect(S.turtle1.flute.volume.value).toBe(n)}),test("should set the volume directly if instrument is not in DEFAULTSYNTHVOLUME",function(){_("turtle1","unknown",70);var e=Tone.gainToDb(.7);expect(Tone.gainToDb).toHaveBeenCalledWith(.7),expect(S.turtle1.flute.volume.value).toBe(e)}),test("should not throw error if instrument is not found in turtle",function(){expect(function(){return _("turtle1","nonexistent",50)}).not.toThrow()})}),describe("getVolume function",function(){beforeEach(function(){jest.clearAllMocks()}),test("should return the volume for a defined instrument",function(){S.turtle1.flute.volume.value=-10;var e=w("turtle1","flute");expect(e).toBe(-10)}),test("should return default volume if instrument is not found",function(){var e=jest.spyOn(console,"debug").mockImplementation(function(){}),t=w("turtle1","nonexistent");expect(t).toBe(50),expect(e).toHaveBeenCalledWith("instrument not found"),e.mockRestore()})}),describe("setMasterVolume function",function(){test("should set the master volume correctly",function(){P(75);var e=Tone.gainToDb(.75);expect(Tone.gainToDb).toHaveBeenCalledWith(.75),expect(Tone.Destination.volume.rampTo).toHaveBeenCalledWith(e,.01)}),test("should handle edge case with volume set to 0 with connections",function(){P(0,87,64);var e=Tone.gainToDb(0);expect(Tone.gainToDb).toHaveBeenCalledWith(0),expect(Tone.Destination.volume.rampTo).toHaveBeenCalledWith(e,.01)}),test("should handle edge case with volume set to 100 with connections",function(){P(100,87,64);var e=Tone.gainToDb(1);expect(Tone.gainToDb).toHaveBeenCalledWith(1),expect(Tone.Destination.volume.rampTo).toHaveBeenCalledWith(e,.01)})}),describe("startSound",function(){var t="turtle1";test("should call start() for drum instruments",function(){var e="guitar";b(t,e,"C4"),expect(S[t][e].start).toHaveBeenCalledTimes(1),expect(S[t][e].triggerAttack).not.toHaveBeenCalled()}),test("should call triggerAttack() for non-drum instruments",function(){var e="flute";b(t,e,"C4"),expect(S[t][e].triggerAttack).toHaveBeenCalledWith("C4"),expect(S[t][e].start).not.toHaveBeenCalled()}),test("should handle undefined instrument gracefully",function(){expect(function(){return b(t,"nonexistent","C4")}).toThrow()}),test("should handle undefined turtle gracefully",function(){expect(function(){return b("nonexistentTurtle","piano","C4")}).toThrow()})}),describe("stopSound",function(){var t="turtle1";test("should call stop() for drum instruments",function(){var e="guitar";j(t,e,"C4"),expect(S[t][e].stop).toHaveBeenCalledTimes(1),expect(S[t][e].triggerRelease).not.toHaveBeenCalled()}),test("should call triggerRelease() with note for non-drum instruments when note is provided",function(){var e="flute";j(t,e,"C4"),expect(S[t][e].triggerRelease).toHaveBeenCalledWith("C4"),expect(S[t][e].stop).not.toHaveBeenCalled()}),test("should call triggerRelease() without note for non-drum instruments when note is undefined",function(){var e="flute";j(t,e,void 0),expect(S[t][e].triggerRelease).toHaveBeenCalledTimes(1),expect(S[t][e].triggerRelease).toHaveBeenCalledWith(),expect(S[t][e].stop).not.toHaveBeenCalled()}),test("should handle invalid instrument gracefully",function(){expect(function(){return j(t,"nonexistent","C4")}).toThrow()}),test("should handle invalid turtle gracefully",function(){expect(function(){return j("nonexistentTurtle","flute","C4")}).toThrow()})}),describe("loop",function(){test("should create and start a loop for drum instruments",function(){var e="turtle1",t="guitar",n=O(e,t,"C4",.25,0,120,.8);expect(S[e][t].start).toHaveBeenCalledTimes(1),expect(S[e][t].triggerAttackRelease).not.toHaveBeenCalled(),expect(n).toStrictEqual({})}),test("should create and start a loop for melodic instruments",function(){var e="turtle1",t="flute",n=O(e,t,"C4",.25,0,120,.8);expect(Tone.Loop).toHaveBeenCalled(),(0,Tone.Loop.mock.calls[0][0])(0),expect(S[e][t].triggerAttackRelease).toHaveBeenCalledWith("C4",.25,expect.any(Number),.8),expect(S[e][t].start).not.toHaveBeenCalled(),expect(n).toStrictEqual({})}),test("should calculate correct loop interval based on BPM",function(){O("turtle1","flute","C4",.25,0,120,.8),expect(Tone.Loop).toHaveBeenCalledWith(expect.any(Function),.5)}),test("should handle different start times",function(){var e={start:jest.fn()};Tone.Loop=jest.fn(function(){return e});O("turtle1","flute","C4",.25,2.5,120,.8),expect(e.start).toHaveBeenCalledWith(2.5)}),test("should use velocity correctly for both instrument types",function(){var e={start:jest.fn()};Tone.Loop=jest.fn(function(){return e}),Tone.now=jest.fn(function(){return 100});O("turtle1","flute","C4",.25,0,120,.6),(0,Tone.Loop.mock.calls[0][0])(0),expect(S.turtle1.flute.triggerAttackRelease).toHaveBeenCalledWith("C4",.25,100,.6)})}),describe("Tone Transport Controls",function(){test("start should call Tone.Transport.start",function(){var e=jest.spyOn(Tone.Transport,"start");q(),expect(e).toHaveBeenCalledTimes(1),e.mockRestore()}),test("stop should call Tone.Transport.stop",function(){var e=jest.spyOn(Tone.Transport,"stop");A(),expect(e).toHaveBeenCalledTimes(1),e.mockRestore()}),test("start and stop should work in sequence",function(){var e=jest.spyOn(Tone.Transport,"start"),t=jest.spyOn(Tone.Transport,"stop");q(),A(),q(),A(),expect(e).toHaveBeenCalledTimes(2),expect(t).toHaveBeenCalledTimes(2),e.mockRestore(),t.mockRestore()})}),describe("_createSampleSynth",function(){it("creates voice synth correctly",function(){c(),l("guitar");var e=h("turtle1","electronic synth","guitar");expect(e).toBeInstanceOf(Tone.Sampler)})}),describe("startSound",function(){it("it should start the sound",function(){expect(b("turtle1","guitar","A")).toBe(void 0)}),it("it should start the sound",function(){expect(b("turtle1","custom","A")).toBe(void 0)})}),describe("whichTemperament",function(){it("should get the temperament",function(){expect(t()).toBe("equal")})}),describe("getFrequency",function(){it("it should return the frequency or frequencies.",function(){expect(i("Bb2",!1)).toBe(116.54094037952261),expect(i("Bb3",!1)).toBe(233.0818807590453),expect(i("A4",!1)).toBe(440.00000000000085)})}),describe("_getFrequency",function(){it("it should return the frequency or frequencies.",function(){expect(s("Bb2",!1,"equal")).toBe(116.54094037952261),expect(s("Bb3",!1,"equal")).toBe(233.0818807590453),expect(s("A4",!1,"equal")).toBe(440.00000000000085)})}),describe("getCustomFrequency",function(){it("it should return the custom frequency or frequencies.",function(){expect(a("Bb2","equal")).toBe("B♭"),expect(a("A4","equal")).toBe("A"),expect(a("Bb3","equal")).toBe("B♭")})}),describe("loadSamples",function(){beforeEach(function(){jest.clearAllMocks(),D.samples=null}),test("should initialize samples object when samples is null",function(){c(),expect(D.samples).toEqual({voice:{},drum:{}})}),test("should not overwrite existing samples object",function(){D.samples={voice:{existingInstrument:{}},drum:{existingDrum:{}}};var e=_objectSpread({},D.samples);c(),expect(D.samples).toEqual(e)}),test("should correctly populate samplesManifest",function(){c(),expect(D.samplesManifest).toEqual({voice:expect.anything(),drum:expect.anything()})}),test("empty data function should return null",function(){c();var e=D.samplesManifest.voice.find(function(e){return"empty"===e.name}).data;expect(e()).toBeNull()}),test("should create separate objects for each manifest type",function(){c(),expect(D.samples.voice).toBeDefined(),expect(D.samples.drum).toBeDefined(),expect(D.samples.voice).not.toBe(D.samples.drum)})}),describe("_loadSample",function(){it("it should loads samples into the Synth instance.",function(){expect(l()).toBe(void 0)})}),describe("getDefaultParamValues",function(){it("it should retrieves default parameter values for various synthesizers.",function(){expect(p("sine")).toStrictEqual({oscillator:{type:"sine"},envelope:{attack:.03,decay:.001,sustain:1,release:.03}}),expect(p("square")).toStrictEqual({oscillator:{type:"square"},envelope:{attack:.03,decay:.001,sustain:1,release:.03}}),expect(p("triangle")).toStrictEqual({oscillator:{type:"triangle"},envelope:{attack:.03,decay:.001,sustain:1,release:.03}}),expect(p("sawtooth")).toStrictEqual({oscillator:{type:"sawtooth"},envelope:{attack:.03,decay:.001,sustain:1,release:.03}})})}),describe("_parseSampleCenterNo",function(){it("it should parses solfege notation and octave to determine the pitch number.",function(){expect(m("do",2)).toBe("24"),expect(m("do",3)).toBe("36"),expect(m("do",4)).toBe("48"),expect(m("do",5)).toBe("60"),expect(m("A",5)).toBe("69"),expect(m("A",2)).toBe("33")})}),describe("createSynth",function(){it("it should create a synth based on the user's input in the 'Timbre' clamp, handling race conditions with the samples loader.",function(){expect(x("turtle1","piano","voice recording",{})).toBe(void 0)})})});