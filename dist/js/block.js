"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function asyncGeneratorStep(e,t,i,s,l,o,a){try{var n=e[o](a),c=n.value}catch(e){return void i(e)}n.done?t(c):Promise.resolve(c).then(s,l)}function _asyncToGenerator(n){return function(){var e=this,a=arguments;return new Promise(function(t,i){var s=n.apply(e,a);function l(e){asyncGeneratorStep(s,t,i,l,o,"next",e)}function o(e){asyncGeneratorStep(s,t,i,l,o,"throw",e)}l(void 0)})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,_toPropertyKey(s.key),s)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var i=e[Symbol.toPrimitive];if(void 0===i)return("string"===t?String:Number)(e);var s=i.call(e,t||"default");if("object"!=_typeof(s))return s;throw new TypeError("@@toPrimitive must return a primitive value.")}var TEXTWIDTH=240,STRINGLEN=9,LONGPRESSTIME=1500,INLINECOLLAPSIBLES=["newnote","interval","osctime","definemode"],COLLAPSIBLES=["drum","start","action","temperament1","matrix","pitchdrummatrix","rhythmruler2","timbre","status","pitchstaircase","tempo","pitchslider","modewidget","newnote","musickeyboard","temperament","interval","osctime","definemode"],NOHIT=["hidden","hiddennoflow"],SPECIALINPUTS=["text","number","solfege","eastindiansolfege","scaledegree2","notename","voicename","modename","chordname","drumname","effectsname","filtertype","oscillatortype","boolean","intervalname","invertmode","accidentalname","temperamentname","noisename","customNote","grid","outputtools","wrapmode"],WIDENAMES=["intervalname","accidentalname","drumname","effectsname","voicename","modename","chordname","temperamentname","noisename","outputtools"],EXTRAWIDENAMES=[],PIEMENUS=["solfege","eastindiansolfege","scaledegree2","notename","voicename","drumname","effectsname","accidentalname","invertmode","boolean","filtertype","oscillatortype","intervalname","modename","chordname","temperamentname","noisename","customNote","grid","outputtools","wrapmode"],_blockMakeBitmap=function(e,t,i){var s=new Image;s.onload=function(){var e=new createjs.Bitmap(s);t(e,i)},s.src="data:image/svg+xml;base64,"+window.btoa(base64Encode(e))},Block=function(){function s(e,t,i){_classCallCheck(this,s),null!==e&&(this.protoblock=e,this.blocks=t,this.overrideName=i,this.name=e.name,this.activity=this.blocks.activity,this.collapsed=!1,this.inCollapsed=!1,this.trash=!1,this.loadComplete=!1,this.label=null,this.labelattr=null,this.text=null,this.value=null,this.privateData=null,this.customID=null,this.image=e.image,this.imageBitmap=null,this.controller=null,this.container=null,this.bounds=null,this.width=0,this.height=0,this.hitHeight=0,this.bitmap=null,this.highlightBitmap=null,this.disconnectedBitmap=null,this.disconnectedHighlightBitmap=null,this.artwork=null,this.collapseArtwork=null,this.collapseButtonBitmap=null,this.expandButtonBitmap=null,this.collapseBlockBitmap=null,this.highlightCollapseBlockBitmap=null,this.collapseText=null,this.size=1,this.docks=[],this.connections=[],this.clampCount=[1,1],this.argClampSlots=[1],this.postProcess=null,(this.postProcessArg=this)._labelLock=!1,this._piemenuExitTime=null,this._triggerLongPress=!1,this._triggerLock=!1,this._check_meter_block=null,this.original={x:0,y:0},this.offset={x:0,y:0})}return _createClass(s,[{key:"_createCache",value:function(a,n){var c=this;return new Promise(function(i,s){var l=0,o=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(void(e.prev=0)!==t&&(l=t),10<l)throw new Error("COULD NOT CREATE CACHE");e.next=4;break;case 4:if(c.bounds=c.container.getBounds(),null===c.bounds)return e.next=8,delayExecution(100);e.next=12;break;case 8:c.regenerateArtwork(!0,[]),o(l+1),e.next=15;break;case 12:c.container.cache(c.bounds.x,c.bounds.y,c.bounds.width,c.bounds.height),a(c,n),i();case 15:e.next=20;break;case 17:e.prev=17,e.t0=e.catch(0),s(e.t0);case 20:case"end":return e.stop()}},e,null,[[0,17]])}));return function(e){return t.apply(this,arguments)}}();o()})}},{key:"updateCache",value:function(){var a=this;return new Promise(function(i,s){var l=0,o=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(void(e.prev=0)!==t&&(l=t),5<l)throw new Error("COULD NOT UPDATE CACHE");e.next=4;break;case 4:if(null===a.bounds)return o(l+1),e.next=8,a.pause(200);e.next=10;break;case 8:e.next=13;break;case 10:a.container.updateCache(),a.activity.refreshCanvas(),i();case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(0),s(e.t0);case 18:case"end":return e.stop()}},e,null,[[0,15]])}));return function(e){return t.apply(this,arguments)}}();o()})}},{key:"ignore",value:function(){if(null===this.bitmap)return!0;if("hidden"===this.name)return!0;if("hiddennoflow"===this.name)return!0;if(this.trash)return!0;if(this.inCollapsed)return!0;if(null!==this.disconnectedBitmap&&null!==this.disconnectedHighlightBitmap){if(!(this.bitmap.visible||this.highlightBitmap.visible||this.disconnectedBitmap.visible||this.disconnectedHighlightBitmap.visible)){if(null===this.collapseBlockBitmap)return!0;if(!this.collapseBlockBitmap.visible&&!this.highlightCollapseBlockBitmap.visible)return!0}}else if(!this.bitmap.visible&&!this.highlightBitmap.visible){if(null===this.collapseBlockBitmap)return!0;if(!this.collapseBlockBitmap.visible&&!this.highlightCollapseBlockBitmap.visible)return!0}return!1}},{key:"offScreen",value:function(e){return!this.trash&&e.offScreen(this.container.x,this.container.y)}},{key:"copySize",value:function(){this.size=this.protoblock.size}},{key:"getInfo",value:function(){return this.name+" block"}},{key:"isCollapsible",value:function(){return COLLAPSIBLES.includes(this.name)}},{key:"isInlineCollapsible",value:function(){return INLINECOLLAPSIBLES.includes(this.name)}},{key:"highlight",value:function(){if(!this.trash&&!this.inCollapsed&&this.container.visible){if(null!==this.disconnectedBitmap){if(!this.bitmap.visible&&!this.disconnectedBitmap.visible)return}else if(!this.bitmap.visible)return;this.container.visible=!0,this.bitmap.visible=!1,null!==this.disconnectedBitmap&&(this.disconnectedBitmap.visible=!1),this.collapsed?(null!==this.highlightCollapseBlockBitmap&&(this.highlightCollapseBlockBitmap.visible=!0),null!==this.collapseText&&(this.collapseText.visible=!0),null!==this.collapseBlockBitmap&&(this.collapseBlockBitmap.visible=!1),this.highlightBitmap.visible=!1,null!==this.disconnectedHighlightBitmap&&(this.disconnectedHighlightBitmap.visible=!1),this.highlightBitmap.visible=!1):(this.isDisconnected()?(this.disconnectedHighlightBitmap.visible=!0,this.highlightBitmap.visible=!1):(null!==this.disconnectedHighlightBitmap&&(this.disconnectedHighlightBitmap.visible=!1),this.highlightBitmap.visible=!0),this.isCollapsible()&&(null!==this.collapseText&&(this.collapseText.visible=!1),null!==this.collapseBlockBitmap&&(this.collapseBlockBitmap.visible=!1),null!==this.highlightCollapseBlockBitmap&&(this.highlightCollapseBlockBitmap.visible=!1))),this.container.updateCache()}}},{key:"unhighlight",value:function(){this.trash||this.inCollapsed||null!==this.bitmap&&(this.highlightBitmap.visible=!1,null!==this.disconnectedHighlightBitmap&&(this.disconnectedHighlightBitmap.visible=!1),this.container.visible=!0,this.collapsed?(null!==this.collapseBlockBitmap&&(this.collapseBlockBitmap.visible=!0),null!==this.collapseText&&(this.collapseText.visible=!0),null!==this.highlightCollapseBlockBitmap&&(this.highlightCollapseBlockBitmap.visible=!1),this.bitmap.visible=!1):(this.isDisconnected()?(this.disconnectedBitmap.visible=!0,this.bitmap.visible=!1):(null!==this.disconnectedBitmap&&(this.disconnectedBitmap.visible=!1),this.bitmap.visible=!0),this.container.visible=!0,this.isCollapsible()&&(null!==this.collapseText&&(this.collapseText.visible=!1),null!==this.collapseBlockBitmap&&(this.collapseBlockBitmap.visible=!1),null!==this.highlightCollapseBlockBitmap&&(this.highlightCollapseBlockBitmap.visible=!1))),this.container.updateCache())}},{key:"unhighlightSelectedBlocks",value:function(e,t){t&&(this.blocks.unhighlight(e,!0),this.collapsed||(this.disconnectedBitmap.visible=!0),this.container.updateCache())}},{key:"updateArgSlots",value:function(e){this.argClampSlots=e,this._newArtwork(0),this.regenerateArtwork(!1)}},{key:"updateSlots",value:function(e,t){this.clampCount[e]+=t,this._newArtwork(t),this.regenerateArtwork(!1)}},{key:"resize",value:function(i){var e,s=this;this.postProcess=function(){var e;if(null!==s.imageBitmap&&(s._positionMedia(s.imageBitmap,s.imageBitmap.image.width,s.imageBitmap.image.height,i),e=s.container.children.length-1,s.container.setChildIndex(s.imageBitmap,e)),"start"===s.name||"drum"===s.name){for(var t=0;t<s.activity.turtles.getTurtleCount();t++)if(s.activity.turtles.getTurtle(t).startBlock===s){s.activity.turtles.getTurtle(t).resizeDecoration(i,s.bitmap.image.width),s._ensureDecorationOnTop();break}}else s.isCollapsible()&&s._ensureDecorationOnTop();s.updateCache(),s._calculateBlockHitArea(),s.trash&&s.hide()},(this.postProcessArg=this).protoblock.scale=i,this._newArtwork(0),this.regenerateArtwork(!0,[]),null!==this.text&&this._positionText(i),null===this.container||this.isCollapsible()&&(this._generateCollapseArtwork(function(e){e.collapseButtonBitmap.scaleX=e.collapseButtonBitmap.scaleY=e.collapseButtonBitmap.scale=i/3,e.expandButtonBitmap.scaleX=e.expandButtonBitmap.scaleY=e.expandButtonBitmap.scale=i/3,e.updateCache(),e._calculateBlockHitArea()}),e=10*i,this.collapseText.font=e+"px Sans",this._positionCollapseLabel(i))}},{key:"_newArtwork",value:function(e){var t,i;if(this.isInlineCollapsible())(t=new ProtoBlock("collapse-note")).scale=this.protoblock.scale,"interval"===this.name?t.extraWidth=80:t.extraWidth=40,t.zeroArgBlock(),i=t.generator(),this.collapseArtwork=i[0],i=this.protoblock.generator(this.clampCount[0]);else if(this.isCollapsible())(t=new ProtoBlock("collapse")).scale=this.protoblock.scale,t.extraWidth=40,t.basicBlockCollapsed(),i=t.generator(),this.collapseArtwork=i[0],i=this.protoblock.generator(this.clampCount[0]);else if("ifthenelse"===this.name)i=this.protoblock.generator(this.clampCount[0],this.clampCount[1]);else if("clamp"===this.protoblock.style)i=this.protoblock.generator(this.clampCount[0]);else if("argflowclamp"===this.protoblock.style)i=this.protoblock.generator(this.clampCount[0]);else switch(this.name){case"equal":case"greater":case"less":i=this.protoblock.generator(this.clampCount[0]);break;case"makeblock":case"calcArg":case"doArg":case"namedcalcArg":case"nameddoArg":i=this.protoblock.generator(this.argClampSlots),this.size=2;for(var s=0;s<this.argClampSlots.length;s++)this.size+=this.argClampSlots[s];this.docks=[],this.docks.push([i[1][0][0],i[1][0][1],this.protoblock.dockTypes[0]]);break;default:i=this.isArgBlock()||this.isTwoArgBlock()?this.protoblock.generator(this.clampCount[0]):this.protoblock.generator(),this.size+=e}switch(this.name){case"nameddoArg":for(var l=1;l<i[1].length-1;l++)this.docks.push([i[1][l][0],i[1][l][1],"anyin"]);this.docks.push([i[1][2][0],i[1][2][1],"in"]);break;case"namedcalcArg":for(var o=1;o<i[1].length;o++)this.docks.push([i[1][o][0],i[1][o][1],"anyin"]);break;case"doArg":this.docks.push([i[1][1][0],i[1][1][1],this.protoblock.dockTypes[1]]);for(var a=2;a<i[1].length-1;a++)this.docks.push([i[1][a][0],i[1][a][1],"anyin"]);this.docks.push([i[1][3][0],i[1][3][1],"in"]);break;case"makeblock":case"calcArg":this.docks.push([i[1][1][0],i[1][1][1],this.protoblock.dockTypes[1]]);for(var n=2;n<i[1].length;n++)this.docks.push([i[1][n][0],i[1][n][1],"anyin"])}this.artwork=i[0];for(var c=0;c<this.docks.length;c++)this.docks[c][0]=i[1][c][0],this.docks[c][1]=i[1][c][1];this.width=i[2],this.height=i[3],this.hitHeight=i[4]}},{key:"imageLoad",value:function(){var e=10*this.protoblock.scale;this.text=new createjs.Text("",e+"px Sans",platformColor.blockText),this.generateArtwork(!0,[])}},{key:"_addImage",value:function(){var i=new Image,s=this;i.onload=function(){var e=new createjs.Bitmap(i);if("media"===s.name)for(var t=0;t<s.container.children.length;t++)if("media"===s.container.children[t].name)return;e.name="media",s.container.addChild(e),s._positionMedia(e,i.width,i.height,s.protoblock.scale),s.imageBitmap=e,s.updateCache()},-1!==this.image.search("xmlns")?i.src="data:image/svg+xml;base64,"+window.btoa(window.base64Encode(this.image)):i.src=this.image}},{key:"regenerateArtwork",value:function(e){null!=this.bitmap&&this.container.removeChild(this.bitmap),null!=this.highlightBitmap&&this.container.removeChild(this.highlightBitmap),null!=this.disconnectedBitmap&&this.container.removeChild(this.disconnectedBitmap),null!=this.disconnectedHighlightBitmap&&this.container.removeChild(this.disconnectedHighlightBitmap),e&&null!==this.collapseBlockBitmap&&(this.container.removeChild(this.collapseButtonBitmap),this.container.removeChild(this.expandButtonBitmap),this.container.removeChild(this.collapseBlockBitmap),this.container.removeChild(this.highlightCollapseBlockBitmap)),this.generateArtwork(!1)}},{key:"generateArtwork",value:function(i){function l(e,t){null!=t.highlightBitmap&&t.container.removeChild(t.highlightBitmap),t.highlightBitmap=e,t.container.addChild(t.highlightBitmap),t.highlightBitmap.x=0,t.highlightBitmap.y=0,t.highlightBitmap.name="bmp_highlight_"+n,t.activity.logo.runningLilypond||(t.highlightBitmap.cursor="pointer"),t.highlightBitmap.visible=!1,i||t.container.uncache(),t._createCache(function(e,t){e.activity.refreshCanvas();var i=e.blocks.blockList.indexOf(e);t?(e._loadEventHandlers(),null!==e.image&&e._addImage(),e._finishImageLoad()):(e.isCollapsible()&&e._ensureDecorationOnTop(),e.blocks.adjustDocks(i,!0),e._positionText(e.protoblock.scale),e.isCollapsible()&&(e.bitmap.visible=!e.collapsed,e.highlightBitmap.visible=!1,e.updateCache()),null!=e.postProcess&&(e.postProcess(e.postProcessArg),e.postProcess=null))},i)}function o(e,t){var i;null!=t.disconnectedHighlightBitmap&&t.container.removeChild(t.disconnectedHighlightBitmap),t.disconnectedHighlightBitmap=e,t.container.addChild(t.disconnectedHighlightBitmap),t.disconnectedHighlightBitmap.x=0,t.disconnectedHighlightBitmap.y=0,t.disconnectedHighlightBitmap.name="bmp_disconnect_hightlight_"+n,t.activity.logo.runningLilypond||(t.disconnectedHighlightBitmap.cursor="pointer"),t.disconnectedHighlightBitmap.visible=!1,i=t.protoblock.disabled?t.artwork.replace(/fill_color/g,DISABLEDFILLCOLOR).replace(/stroke_color/g,DISABLEDSTROKECOLOR).replace("block_label",safeSVG(c)):t.artwork.replace(/fill_color/g,PALETTEHIGHLIGHTCOLORS[t.protoblock.palette.name]).replace(/stroke_color/g,HIGHLIGHTSTROKECOLORS[t.protoblock.palette.name]).replace("block_label",safeSVG(c));for(var s=1;s<t.protoblock.staticLabels.length;s++)i=i.replace("arg_label_"+s,t.protoblock.staticLabels[s]);_blockMakeBitmap(i,l,t)}function a(e,t){var i;null!=t.disconnectedBitmap&&t.container.removeChild(t.disconnectedBitmap),t.disconnectedBitmap=e,t.container.addChild(t.disconnectedBitmap),t.disconnectedBitmap.x=0,t.disconnectedBitmap.y=0,t.disconnectedBitmap.name="bmp_disconnect_"+n,t.activity.logo.runningLilypond||(t.disconnectedBitmap.cursor="pointer"),t.disconnectedBitmap.visible=!1,i=t.protoblock.disabled?t.artwork.replace(/fill_color/g,DISABLEDFILLCOLOR).replace(/stroke_color/g,DISABLEDSTROKECOLOR).replace("block_label",safeSVG(c)):t.artwork.replace(/fill_color/g,platformColor.paletteColors[t.protoblock.palette.name][3]).replace(/stroke_color/g,HIGHLIGHTSTROKECOLORS[t.protoblock.palette.name]).replace("block_label",safeSVG(c));for(var s=1;s<t.protoblock.staticLabels.length;s++)i=i.replace("arg_label_"+s,t.protoblock.staticLabels[s]);_blockMakeBitmap(i,o,t)}var e,n=this.blocks.blockList.indexOf(this),c="";for(this.overrideName&&"outputtools"!==this.name?["namedbox","storein2","nameddo","nameddoArg","namedcalc","namedcalcArg"].includes(this.name)?(c=this.overrideName,getTextWidth(c,"bold 20pt Sans")>TEXTWIDTH&&(c=c.substr(0,STRINGLEN)+"...")):c=this.overrideName:0<this.protoblock.staticLabels.length&&!this.protoblock.image&&(c=SPECIALINPUTS.includes(this.name)?"":this.protoblock.staticLabels[0]);this.protoblock.staticLabels.length<this.protoblock.args+1;)this.protoblock.staticLabels.push("");if(i){this.protoblock.scale=this.blocks.blockScale;var t=this.protoblock.generator();this.artwork=t[0];for(var s=0;s<t[1].length;s++)this.docks.push([t[1][s][0],t[1][s][1],this.protoblock.dockTypes[s]]);this.width=t[2],this.height=t[3],this.hitHeight=t[4]}e=this.protoblock.disabled?this.artwork.replace(/fill_color/g,DISABLEDFILLCOLOR).replace(/stroke_color/g,DISABLEDSTROKECOLOR).replace("block_label",safeSVG(c)):this.artwork.replace(/fill_color/g,PALETTEFILLCOLORS[this.protoblock.palette.name]).replace(/stroke_color/g,PALETTESTROKECOLORS[this.protoblock.palette.name]).replace("block_label",safeSVG(c));for(var h=1;h<this.protoblock.staticLabels.length;h++)e=e.replace("arg_label_"+h,this.protoblock.staticLabels[h]);this.blocks.blockArt[this.blocks.blockList.indexOf(this)]=e,_blockMakeBitmap(e,function(e,t){var i;null!=t.bitmap&&t.container.removeChild(t.bitmap),t.bitmap=e,t.container.addChild(t.bitmap),t.bitmap.x=0,t.bitmap.y=0,t.bitmap.name="bmp_"+n,t.bitmap.cursor="pointer",t.activity.refreshCanvas(),i=t.protoblock.disabled?t.artwork.replace(/fill_color/g,DISABLEDFILLCOLOR).replace(/stroke_color/g,DISABLEDSTROKECOLOR).replace("block_label",safeSVG(c)):t.artwork.replace(/fill_color/g,platformColor.disconnected).replace(/stroke_color/g,HIGHLIGHTSTROKECOLORS[t.protoblock.palette.name]).replace("block_label",safeSVG(c));for(var s=1;s<t.protoblock.staticLabels.length;s++)i=i.replace("arg_label_"+s,t.protoblock.staticLabels[s]);_blockMakeBitmap(i,a,t)},this)}},{key:"_finishImageLoad",value:function(){var e,t,i,s;if(SPECIALINPUTS.includes(this.name)){if(null==this.value)switch(this.name){case"text":this.value="---";break;case"solfege":case"eastindiansolfege":this.value="sol";break;case"scaledegree2":this.value="5";break;case"customNote":this.value=this.activity.logo.synth.startingPitch.substring(0,this.activity.logo.synth.startingPitch.length-1)+"(+0)";break;case"notename":this.value="G";break;case"rest":this.value="rest";break;case"boolean":this.value=!0;break;case"number":this.value=NUMBERBLOCKDEFAULT;break;case"modename":this.value=DEFAULTMODE;break;case"chordname":this.value=DEFAULTCHORD;break;case"accidentalname":this.value=DEFAULTACCIDENTAL;break;case"intervalname":this.value=DEFAULTINTERVAL;break;case"invertmode":this.value=DEFAULTINVERT;break;case"voicename":this.value=DEFAULTVOICE;break;case"noisename":this.value=DEFAULTNOISE;break;case"drumname":this.value=DEFAULTDRUM;break;case"effectsname":this.value=DEFAULTEFFECT;break;case"filtertype":this.value=DEFAULTFILTERTYPE;break;case"oscillatortype":this.value=DEFAULTOSCILLATORTYPE;break;case"temperamentname":this.value="equal";break;case"grid":this.value="Cartesian";break;case"wrapmode":this.value="on"}"solfege"===this.name?(t=splitSolfege(this.value),i=i18nSolfege(t[0]),"♮"!==(s=t[1])&&(i+=s)):"eastindiansolfege"===this.name?(t=splitSolfege(this.value),i=WESTERN2EISOLFEGENAMES[t[0]],"♮"!==(s=t[1])&&(i+=s)):"scaledegree2"===this.name?(i=(t=splitScaleDegree(this.value))[0],"♮"!==(s=t[1])&&(i+=s)):i="drumname"===this.name?getDrumName(this.value):"noisename"===this.name?getNoiseName(this.value):"outputtools"===this.name?this.overrideName:"grid"===this.name?_(this.value):null!==this.value?this.value.toString():"???",!WIDENAMES.includes(this.name)&&getTextWidth(i,"bold 20pt Sans")>TEXTWIDTH&&(i=i.substr(0,STRINGLEN)+"..."),this.text.text=i,this.container.addChild(this.text),this._positionText(this.protoblock.scale)}else this.protoblock.parameter&&(this.container.addChild(this.text),this._positionText(this.protoblock.scale));this.isCollapsible()?(this.isInlineCollapsible()?((e=new ProtoBlock("collapse-note")).scale=this.protoblock.scale,"interval"===this.name?e.extraWidth=80:e.extraWidth=40,e.zeroArgBlock()):((e=new ProtoBlock("collapse")).scale=this.protoblock.scale,e.extraWidth=40,e.basicBlockCollapsed()),t=e.generator(),this.collapseArtwork=t[0],this.isCollapsible()&&this._generateCollapseArtwork(function(e){e.loadComplete=!0,null!==e.postProcess&&(e.postProcess(e.postProcessArg),e.postProcess=null)})):(this.loadComplete=!0,null!==this.postProcess&&(this.postProcess(this.postProcessArg),this.postProcess=null),this.blocks.cleanupAfterLoad(this.name)),this.activity.refreshCanvas()}},{key:"_generateCollapseArtwork",value:function(s){function o(t){var i=new Image;i.onload=function(){var e;t.collapseButtonBitmap=new createjs.Bitmap(i),t.collapseButtonBitmap.scaleX=t.collapseButtonBitmap.scaleY=t.collapseButtonBitmap.scale=t.protoblock.scale/3,t.container.addChild(t.collapseButtonBitmap),t.collapseButtonBitmap.x=2*t.protoblock.scale,t.isInlineCollapsible()?t.collapseButtonBitmap.y=4*t.protoblock.scale:t.collapseButtonBitmap.y=10*t.protoblock.scale,t.collapseButtonBitmap.visible=!t.collapsed,e=t,null!==s&&s(e),e.activity.refreshCanvas(),e.blocks.cleanupAfterLoad(e.name),e.trash&&(e.collapseText.visible=!1,e.collapseButtonBitmap.visible=!1,e.expandButtonBitmap.visible=!1)},i.src="data:image/svg+xml;base64,"+window.btoa(base64Encode(COLLAPSEBUTTON))}function l(e,t){if(t.highlightCollapseBlockBitmap=e,t.highlightCollapseBlockBitmap.name="highlight_collapse_"+a,t.container.addChild(t.highlightCollapseBlockBitmap),t.highlightCollapseBlockBitmap.visible=!1,null===t.collapseText){var i=10*t.protoblock.scale;switch(t.name){case"action":t.collapseText=new createjs.Text(_("action"),i+"px Sans",platformColor.blockText);break;case"temperament1":t.collapseText=new createjs.Text(_("temperament"),i+"px Sans",platformColor.blockText);break;case"start":t.collapseText=new createjs.Text(_("start"),i+"px Sans",platformColor.blockText);break;case"matrix":t.collapseText=new createjs.Text(_("matrix"),i+"px Sans",platformColor.blockText);break;case"status":t.collapseText=new createjs.Text(_("status"),i+"px Sans",platformColor.blockText);break;case"pitchdrummatrix":t.collapseText=new createjs.Text(_("drum mapper"),i+"px Sans",platformColor.blockText);break;case"rhythmruler":t.collapseText=new createjs.Text(_("ruler"),i+"px Sans",platformColor.blockText);break;case"timbre":t.collapseText=new createjs.Text(_("timbre"),i+"px Sans",platformColor.blockText);break;case"pitchstaircase":t.collapseText=new createjs.Text(_("stair"),i+"px Sans",platformColor.blockText);break;case"tempo":t.collapseText=new createjs.Text(_("tempo"),i+"px Sans",platformColor.blockText);break;case"modewidget":t.collapseText=new createjs.Text(_("mode"),i+"px Sans",platformColor.blockText);break;case"pitchslider":t.collapseText=new createjs.Text(_("slider"),i+"px Sans",platformColor.blockText);break;case"musickeyboard":t.collapseText=new createjs.Text(_("keyboard"),i+"px Sans",platformColor.blockText);break;case"drum":t.collapseText=new createjs.Text(_("drum"),i+"px Sans",platformColor.blockText);break;case"rhythmruler2":t.collapseText=new createjs.Text(_("rhythm maker"),i+"px Sans",platformColor.blockText);break;case"newnote":t.collapseText=new createjs.Text(_("note value"),i+"px Sans",platformColor.blockText);break;case"interval":t.collapseText=new createjs.Text(_("scalar interval"),i+"px Sans",platformColor.blockText);break;case"osctime":t.collapseText=new createjs.Text(_("milliseconds"),i+"px Sans",platformColor.blockText);break;case"temperament":t.collapseText=new createjs.Text(_("temperament"),i+"px Sans",platformColor.blockText);break;case"definemode":t.collapseText=new createjs.Text(_("mode"),i+"px Sans",platformColor.blockText);break;default:t.collapseText=new createjs.Text("foobar",i+"px Sans",platformColor.blockText)}t.collapseText.textAlign="left",t.collapseText.textBaseline="alphabetic",t.container.addChild(t.collapseText)}var s,l;t._positionCollapseLabel(t.protoblock.scale),t.collapseText.visible=t.collapsed,t._ensureDecorationOnTop(),t.blocks.blockCollapseArt[t.blocks.blockList.indexOf(t)]=t.collapseArtwork.replace(/fill_color/g,PALETTEFILLCOLORS[t.protoblock.palette.name]).replace(/stroke_color/g,PALETTESTROKECOLORS[t.protoblock.palette.name]).replace("block_label",safeSVG(t.collapseText.text)),s=t,(l=new Image).onload=function(){s.expandButtonBitmap=new createjs.Bitmap(l),s.expandButtonBitmap.scaleX=s.expandButtonBitmap.scaleY=s.expandButtonBitmap.scale=s.protoblock.scale/3,s.container.addChild(s.expandButtonBitmap),s.expandButtonBitmap.visible=s.collapsed,s.expandButtonBitmap.x=2*s.protoblock.scale,s.isInlineCollapsible()?s.expandButtonBitmap.y=4*s.protoblock.scale:s.expandButtonBitmap.y=10*s.protoblock.scale,o(s)},l.src="data:image/svg+xml;base64,"+window.btoa(base64Encode(EXPANDBUTTON))}var a=this.blocks.blockList.indexOf(this),e=this.collapseArtwork.replace(/fill_color/g,PALETTEFILLCOLORS[this.protoblock.palette.name]).replace(/stroke_color/g,PALETTESTROKECOLORS[this.protoblock.palette.name]).replace("block_label","");_blockMakeBitmap(e,function(e,t){t.collapseBlockBitmap=e,t.collapseBlockBitmap.name="collapse_"+a,t.container.addChild(t.collapseBlockBitmap),t.collapseBlockBitmap.visible=t.collapsed,t.activity.refreshCanvas();var i=t.collapseArtwork;_blockMakeBitmap(i.replace(/fill_color/g,PALETTEHIGHLIGHTCOLORS[t.protoblock.palette.name]).replace(/stroke_color/g,HIGHLIGHTSTROKECOLORS[t.protoblock.palette.name]).replace("block_label",""),l,t)},this)}},{key:"hide",value:function(){this.container.visible=!1,this.isCollapsible()&&(null!==this.collapseText&&(this.collapseText.visible=!1),null!==this.expandButtonBitmap&&(this.expandButtonBitmap.visible=!1),null!==this.collapseButtonBitmap&&(this.collapseButtonBitmap.visible=!1)),this.updateCache(),this.activity.refreshCanvas()}},{key:"isDisconnected",value:function(){return null!==this.disconnectedBitmap&&(null===this.connections[0]&&(!(COLLAPSIBLES.includes(this.name)&&!INLINECOLLAPSIBLES.includes(this.name))&&(!!this.isArgBlock()||(null===last(this.connections)||"hidden"===this.blocks.blockList[last(this.connections)].name&&null===last(this.blocks.blockList[last(this.connections)].connections)))))}},{key:"show",value:function(){this.trash||this.inCollapsed||(this.container.visible=!0,this.isCollapsible()?this.collapsed?(this.bitmap.visible=!1,this.highlightBitmap.visible=!1,this.collapseBlockBitmap.visible=!0,this.highlightCollapseBlockBitmap.visible=!1,this.collapseText.visible=!0,this.expandButtonBitmap.visible=!0,this.collapseButtonBitmap.visible=!1,null!==this.disconnectedBitmap&&(this.disconnectedBitmap.visible=!1),null!==this.disconnectedHighlightBitmap&&(this.disconnectedHighlightBitmap.visible=!1)):(this.isDisconnected()?(this.disconnectedBitmap.visible=!0,this.bitmap.visible=!1):(null!==this.disconnectedBitmap&&(this.disconnectedBitmap.visible=!1),this.bitmap.visible=!0),this.highlightBitmap.visible=!1,null!==this.disconnectedHighlightBitmap&&(this.disconnectedHighlightBitmap.visible=!1),this.collapseBlockBitmap.visible=!1,this.highlightCollapseBlockBitmap.visible=!1,this.collapseText.visible=!1,this.expandButtonBitmap.visible=!1,this.collapseButtonBitmap.visible=!0):(this.isDisconnected()?(this.disconnectedBitmap.visible=!0,this.bitmap.visible=!1):(null!==this.disconnectedBitmap&&(this.disconnectedBitmap.visible=!1),this.bitmap.visible=!0),this.highlightBitmap.visible=!1,null!==this.disconnectedHighlightBitmap&&(this.disconnectedHighlightBitmap.visible=!1)),this.updateCache(),this.activity.refreshCanvas())}},{key:"isValueBlock",value:function(){return"value"===this.protoblock.style}},{key:"isNoHitBlock",value:function(){return NOHIT.includes(this.name)}},{key:"isArgBlock",value:function(){return"value"===this.protoblock.style||"arg"===this.protoblock.style}},{key:"isTwoArgBlock",value:function(){return"twoarg"===this.protoblock.style}},{key:"isTwoArgBooleanBlock",value:function(){return["equal","greater","less"].includes(this.name)}},{key:"isClampBlock",value:function(){return"clamp"===this.protoblock.style||this.isDoubleClampBlock()||this.isArgFlowClampBlock()}},{key:"isArgFlowClampBlock",value:function(){return"argflowclamp"===this.protoblock.style}},{key:"isLeftClampBlock",value:function(){return this.protoblock.isLeftClamp}},{key:"isDoubleClampBlock",value:function(){return"doubleclamp"===this.protoblock.style}},{key:"isNoRunBlock",value:function(){return"action"===this.name}},{key:"isArgClamp",value:function(){return"argclamp"===this.protoblock.style||"argclamparg"===this.protoblock.style}},{key:"isExpandableBlock",value:function(){return this.protoblock.expandable}},{key:"getBlockId",value:function(){return"_"+blockBlocks.blockList.indexOf(this).toString()}},{key:"removeChildBitmap",value:function(e){for(var t=0;t<this.container.children.length;t++)if(this.container.children[t].name===e){this.container.removeChild(this.container.children[t]);break}}},{key:"loadThumbnail",value:function(e){var s,t=this.blocks.blockList.indexOf(this),l=this;null===this.blocks.blockList[t].value&&null===e||((s=new Image).onload=function(){l.removeChildBitmap("media");var e=new createjs.Bitmap(s);e.name="media";var t=new createjs.Container;t.addChild(e);s.width>s.height?600<s.width&&(e.scaleX=e.scaleY=e.scale=600/s.width):450<s.height&&(e.scaleX=e.scaleY=e.scale=450/s.height);var i=t.getBounds();t.cache(i.x,i.y,i.width,i.height),l.value=t.bitmapCache.getCacheDataURL(),l.imageBitmap=e,l._positionMedia(e,e.image.width,e.image.height,l.protoblock.scale),l.container.addChild(e),l.updateCache()},s.src=null===e?this.value:e)}},{key:"_doOpenMedia",value:function(i){var s=this,l="media"==s.name?docById("myMedia"):docById("audio");l.addEventListener("change",function e(){window.scroll(0,0);var t=new FileReader;t.onloadend=function(){if(t.result){if("media"===s.name)return s.value=t.result,s.loadThumbnail(null),void(l.value="");s.value=[l.files[0].name,t.result],s.blocks.updateBlockText(i),l.value=""}},"media"===s.name||"audiofile"===s.name?t.readAsDataURL(l.files[0]):t.readAsText(l.files[0]),l.removeEventListener("change",e)},!1),l.focus(),l.click(),window.scroll(0,0)}},{key:"setCollapsedState",value:function(){this.inCollapsed=!0,this.hide()}},{key:"setUncollapsedState",value:function(e){null!==e&&this.blocks.blockList[e].collapsed||(this.inCollapsed=!1,this.show())}},{key:"collapseToggle",value:function(){var e=this.blocks.blockList.indexOf(this);if(this.blocks.findDragGroup(e),null!==this.collapseBlockBitmap){var t,i=this.collapsed;if(this.collapsed=!i,this.collapseButtonBitmap.visible=i,this.expandButtonBitmap.visible=!i,this.collapseBlockBitmap.visible=!i,this.highlightCollapseBlockBitmap.visible=!1,this.collapseText.visible=!i,this.isInlineCollapsible()&&this.collapseText.visible)switch(this.name){case"newnote":this._newNoteLabel();break;case"interval":this._intervalLabel();break;case"osctime":this._oscTimeLabel()}if(this.bitmap.visible=this.collapsed,this.highlightBitmap.visible=!1,null!==this.disconnectedBitmap&&(this.disconnectedBitmap.visible=!1),null!==this.disconnectedHighlightBitmap&&(this.disconnectedHighlightBitmap.visible=!1),this.updateCache(),"action"===this.name&&(null!==this.connections[1]?(t=this.blocks.blockList[this.connections[1]].value,getTextWidth(t,"bold 20pt Sans")>TEXTWIDTH&&(t=t.substr(0,STRINGLEN)+"..."),this.collapseText.text=t):this.collapseText.text=""),this.container.setChildIndex(this.collapseText,this.container.children.length-1),this.isInlineCollapsible())this._toggle_inline(e,i);else if(0<this.blocks.dragGroup.length)for(var s=1;s<this.blocks.dragGroup.length;s++){var l=this.blocks.dragGroup[s];this.collapsed?this.blocks.blockList[l].setCollapsedState():this.blocks.blockList[l].setUncollapsedState(this.blocks.insideInlineCollapsibleBlock(l))}this.updateCache(),this.unhighlight(),this.activity.refreshCanvas()}}},{key:"_intervalLabel",value:function(){for(var e=DEGREES.split(" "),t={},i=0;i<e.length;i++)t[i]=e[i];for(var s,l=[],o=0,a=this.blocks.blockList.indexOf(this);null!==a;){s=a;var n=this.blocks.blockList[a].connections[1],c=this.blocks.blockList[n];if("number"===c.name?Math.abs(c.value)in t?c.value<0?l.push("-"+t[-c.value]):l.push("+"+t[c.value]):c.value<0?l.push("-"+c.value):l.push("+"+c.value):l.push(""),5<(o+=1))break;a=this.blocks.findNestedIntervalBlock(this.blocks.blockList[a].connections[2])}for(var h="",r=l.length;0<r;r--)h+=" "+l[r-1];var u,b,p,m="",k=this.blocks.findNoteBlock(s);null===k?this.collapseText.text=_("scalar interval")+h:(null!==(a=this.blocks.blockList[k].connections[1])&&"divide"===this.blocks.blockList[a].name&&(u=this.blocks.blockList[a].connections[1],b=this.blocks.blockList[a].connections[2],"number"===this.blocks.blockList[u].name&&"number"===this.blocks.blockList[b].name&&(m=this.blocks.blockList[u].value+"/"+this.blocks.blockList[b].value,this.blocks.blockList[b].value in NSYMBOLS&&(m+=NSYMBOLS[this.blocks.blockList[b].value]))),a=this.blocks.findFirstPitchBlock(this.blocks.blockList[k].connections[2]),p=this._getPitch(a),null===a||""===p?this.collapseText.text=_("scalar interval")+h:(a=this.blocks.findFirstPitchBlock(last(this.blocks.blockList[a].connections)),this.collapseText.text=null===a?p+" | "+m+h:p+"... | "+m+h))}},{key:"_newNoteLabel",value:function(){var e,t,i="",s=this.connections[1],l=null;null!==s&&"divide"===this.blocks.blockList[s].name&&(e=this.blocks.blockList[s].connections[1],t=this.blocks.blockList[s].connections[2],"number"===this.blocks.blockList[e].name&&"number"===this.blocks.blockList[t].name&&(i=this.blocks.blockList[e].value+"/"+this.blocks.blockList[t].value,(l=this.blocks.blockList[t].value)in NSYMBOLS&&(i+=NSYMBOLS[l]))),s=this.connections[2],s=this.blocks.findFirstPitchBlock(s);var o=this._getPitch(s);null===s?(null!==l&&l in NSYMBOLS&&(i=i.replace(NSYMBOLS[l],RSYMBOLS[l])),this.collapseText.text=_("silence")+" | "+i):""===o&&""===i?this.collapseText.text=_("note value"):(o===_("silence")&&null!==l&&l in NSYMBOLS&&(i=i.replace(NSYMBOLS[l],RSYMBOLS[l])),s=this.blocks.findFirstPitchBlock(last(this.blocks.blockList[s].connections)),this.collapseText.text=null===s?o+" | "+i:o+"... | "+i)}},{key:"_oscTimeLabel",value:function(){var e,t,i,s,l="",o=this.connections[1];null!==o&&"divide"===this.blocks.blockList[o].name&&(e=this.blocks.blockList[o].connections[1],t=this.blocks.blockList[o].connections[2],null!==e&&null!==t&&"divide"===this.blocks.blockList[t].name&&(i=this.blocks.blockList[t].connections[1],s=this.blocks.blockList[t].connections[2],null!==i&&null!==s&&"number"===this.blocks.blockList[i].name&&"number"===this.blocks.blockList[s].name&&(l=this.blocks.blockList[e].value/this.blocks.blockList[i].value*this.blocks.blockList[s].value))),o=this.connections[2],o=this.blocks.findFirstPitchBlock(o);var a=this._getPitch(o);null===o?this.collapseText.text=_("silence")+" | "+l:""===a&&""===l?this.collapseText.text=_("note value"):(o=this.blocks.findFirstPitchBlock(last(this.blocks.blockList[o].connections)),this.collapseText.text=""!==l?null===o?a+" | "+l.toFixed(0):a+"... | "+l.toFixed(0):a+"...")}},{key:"_getPitch",value:function(e){if(null===e)return"";var t,i;switch(this.blocks.blockList[e].name){case"pitch":if(t=this.blocks.blockList[e].connections[1],i=this.blocks.blockList[e].connections[2],"number"===this.blocks.blockList[i].name){if("solfege"===this.blocks.blockList[t].name){var s=_("ti la sol fa mi re do").split(" "),l=this.blocks.blockList[t].value.replace(SHARP,"").replace(FLAT,"").replace(DOUBLESHARP,"").replace(DOUBLEFLAT,""),o=["ti","la","sol","fa","mi","re","do"].indexOf(l);return-1===o?l+" "+this.blocks.blockList[i].value:this.blocks.blockList[t].value.includes(SHARP)?s[o]+SHARP+" "+this.blocks.blockList[i].value:this.blocks.blockList[t].value.includes(FLAT)?s[o]+FLAT+" "+this.blocks.blockList[i].value:this.blocks.blockList[t].value.includes(DOUBLESHARP)?s[o]+DOUBLESHARP+" "+this.blocks.blockList[i].value:this.blocks.blockList[t].value.includes(DOUBLEFLAT)?s[o]+DOUBLEFLAT+" "+this.blocks.blockList[i].value:s[o]+" "+this.blocks.blockList[i].value}if("notename"===this.blocks.blockList[t].name)return this.blocks.blockList[t].value+" "+this.blocks.blockList[i].value;if("scaledegree2"===this.blocks.blockList[t].name){var a=splitScaleDegree(this.blocks.blockList[t].value),n=a[0];return a[1]!==NATURAL&&(n+=a[1]),n+" "+this.blocks.blockList[i].value}}break;case"nthmodalpitch":if(t=this.blocks.blockList[e].connections[1],i=this.blocks.blockList[e].connections[2],"number"!==this.blocks.blockList[i].name||"number"!==this.blocks.blockList[t].name)break;var c=DEGREES.split(" "),h=this.blocks.blockList[t].value-1;return 0<h&&h<c.length?c[h]+" "+this.blocks.blockList[i].value:this.blocks.blockList[t].value+" "+this.blocks.blockList[i].value;case"hertz":if(t=this.blocks.blockList[e].connections[0],"number"===this.blocks.blockList[t].name)return this.blocks.blockList[t].value+"HZ";break;case"steppitch":return t=this.blocks.blockList[e].connections[1],"number"===this.blocks.blockList[t].name&&this.blocks.blockList[t].value<0?_("down")+" "+Math.abs(this.blocks.blockList[t].value):_("up")+" "+this.blocks.blockList[t].value;case"pitchnumber":if(t=this.blocks.blockList[e].connections[1],"number"===this.blocks.blockList[t].name)return _("pitch")+" "+this.blocks.blockList[t].value;break;case"playdrum":return _("drum");case"rest2":return _("silence");default:return""}}},{key:"_toggle_inline",value:function(e,t){if(null!==this.connections[1]){this.blocks.findDragGroup(this.connections[1]);for(var i=0;i<this.blocks.dragGroup.length;i++){var s=this.blocks.dragGroup[i];this.blocks.blockList[s].container.visible=t,this.blocks.blockList[s].inCollapsed=!t}}if(null!==this.connections[2]){this.blocks.findDragGroup(this.connections[2]);for(var l=0;l<this.blocks.dragGroup.length;l++){var o=this.blocks.dragGroup[l],a=this.blocks.insideInlineCollapsibleBlock(o);null!==a&&this.blocks.blockList[a].collapsed?(this.blocks.blockList[o].container.visible=!1,this.blocks.blockList[o].inCollapsed=!0):(this.blocks.blockList[o].container.visible=t,this.blocks.blockList[o].inCollapsed=!t)}}if(null!=this.connections[3]){var n=this.docks.length,c=t?this.blocks.blockList[e].docks[n-1][1]-this.blocks.blockList[e].docks[n-2][1]:this.blocks.blockList[e].docks[n-2][1]-this.blocks.blockList[e].docks[n-1][1];this.blocks.findDragGroup(this.connections[3]);for(var h=0;h<this.blocks.dragGroup.length;h++)this.blocks.moveBlockRelative(this.blocks.dragGroup[h],0,c);this.blocks.adjustDocks(e,!0)}var r=[];this.blocks.findNestedClampBlocks(e,r),0<r.length&&(this.blocks.clampBlocksToCheck=r,this.blocks.adjustExpandableClampBlock()),this.activity.refreshCanvas()}},{key:"_positionText",value:function(e){this.text.textBaseline="alphabetic",this.text.textAlign="right";var t=10*e;this.text.font=t+"px Sans",this.text.x=Math.floor(TEXTX*e/2+.5),this.text.y=Math.floor(TEXTY*e/2+.5),SPECIALINPUTS.includes(this.name)?(this.text.textAlign="center",this.text.x=Math.floor(VALUETEXTX*e/2+10),EXTRAWIDENAMES.includes(this.name)?this.text.x*=3:WIDENAMES.includes(this.name)?this.text.x=Math.floor(1.75*this.text.x+.5):"text"===this.name&&(this.text.x=Math.floor(this.width/2+.5))):"nameddo"===this.name?(this.text.textAlign="center",this.text.x=Math.floor(this.width/2+.5)):0===this.protoblock.args?this.text.x=Math.floor(this.width-25+.5):this.isCollapsible()?this.text.x+=Math.floor(15*e):(this.text.textAlign="left","booleanout"===this.docks[0][2]&&(this.text.y=Math.floor(this.docks[0][1]+.5)));var i=this.container.children.length-1;this.container.setChildIndex(this.text,i),this.updateCache()}},{key:"_positionMedia",value:function(e,t,i,s){e.scaleX=e.scaleY=e.scale=i<t?MEDIASAFEAREA[2]/t*s/2:MEDIASAFEAREA[3]/i*s/2,e.x=(MEDIASAFEAREA[0]-10)*s/2,e.y=MEDIASAFEAREA[1]*s/2}},{key:"_positionCollapseLabel",value:function(e){this.isInlineCollapsible()?(this.collapseText.x=Math.floor((COLLAPSETEXTX+STANDARDBLOCKHEIGHT)*e/2+.5),this.collapseText.y=Math.floor((COLLAPSETEXTY-8)*e/2+.5)):(this.collapseText.x=Math.floor((COLLAPSETEXTX+30)*e/2+.5),this.collapseText.y=Math.floor(COLLAPSETEXTY*e/2+.5));var t=this.container.children.length-1;this.container.setChildIndex(this.collapseText,t)}},{key:"_calculateBlockHitArea",value:function(){var e=new createjs.Shape;e.graphics.beginFill("platformColor.hitAreaGraphicsBeginFill").drawRect(0,0,this.width,this.hitHeight),this.container.hitArea=e}},{key:"_loadEventHandlers",value:function(){var r=this,u=this,b=this.blocks.blockList.indexOf(this);this._calculateBlockHitArea(),this.container.on("mouseover",function(){docById("contextWheelDiv").style.display="none",u.activity.logo.runningLilypond||(document.body.style.cursor="pointer"),u.blocks.selectionModeOn||u.blocks.highlight(b,!0),u.blocks.activeBlock=b});var s=!1,p=!1,l=!1,m=window.hasMouse;this.container.on("click",function(e){if(docById("helpfulWheelDiv")&&"none"!==docById("helpfulWheelDiv").style.display&&(docById("helpfulWheelDiv").style.display="none"),"nativeEvent"in e){if("button"in e.nativeEvent&&2==e.nativeEvent.button)return u.blocks.stageClick=!0,docById("wheelDiv").style.display="none",u.blocks.activeBlock=b,void piemenuBlockContext(u);if("ctrlKey"in e.nativeEvent&&e.nativeEvent.ctrlKey)return u.blocks.activeBlock=b,void piemenuBlockContext(u);if("shiftKey"in e.nativeEvent&&e.nativeEvent.shiftKey)return void(u.activity.turtles.running()?(u.activity.logo.doStopTurtles(),setTimeout(function(){u.activity.logo.runLogoCommands(topBlock)},250)):u.activity.logo.runLogoCommands(topBlock))}var t,i;u.blocks.getLongPressStatus()||(u.blocks.activeBlock=b,s=!0,l||(l=!0,setTimeout(function(){l=!1},500),hideDOMLabel(),u._checkWidgets(!1),i=e.stageX/u.activity.getStageScale()-u.container.x,!p&&u.isCollapsible()&&i<30/u.activity.getStageScale()?u.collapseToggle():!window.hasMouse&&m||window.hasMouse&&!p?["media","audiofile","loadFile"].includes(u.name)?u._doOpenMedia(b):SPECIALINPUTS.includes(u.name)?u.trash||(u._triggerLongPress?u._triggerLongPress=!1:u._changeLabel()):u.blocks.getLongPressStatus()||u.blocks.stageClick||(t=u.blocks.findTopBlock(b),u.activity.runMode="normal",u.activity.logo.synth.resume(),u.activity.turtles.running()?(u.activity.logo.doStopTurtles(),setTimeout(function(){u.activity.logo.runLogoCommands(t)},250)):u.activity.logo.runLogoCommands(t)):p||u.blocks.getLongPressStatus()||u.blocks.stageClick||(t=u.blocks.findTopBlock(b),u.activity.runMode="normal",u.activity.logo.synth.resume(),u.activity.turtles.running()?(u.activity.logo.doStopTurtles(),setTimeout(function(){u.activity.logo.runLogoCommands(t)},250)):u.activity.logo.runLogoCommands(t))))}),this.container.on("mousedown",function(e){if(docById("contextWheelDiv").style.display="none",u.blocks.mouseDownTime=(new Date).getTime(),u.blocks.longPressTimeout=setTimeout(function(){u.blocks.activeBlock=u.blocks.blockList.indexOf(u),u._triggerLongPress=!0,u.blocks.triggerLongPress()},LONGPRESSTIME),r.collapseButtonBitmap&&r.expandButtonBitmap){var t=r.container.globalToLocal(e.stageX,e.stageY);if(r.collapseButtonBitmap.getBounds().contains(t.x,t.y)||r.expandButtonBitmap.getBounds().contains(t.x,t.y))return void u.activity.trashcan.hide()}u.activity.trashcan.show(),u.blocks.raiseStackToTop(b),null!=u.collapseContainer&&u.activity.blocksContainer.setChildIndex(u.collapseContainer,u.activity.blocksContainer.children.length-1),p=!1,u.original={x:e.stageX/u.activity.getStageScale(),y:e.stageY/u.activity.getStageScale()},u.offset={x:Math.round(u.container.x-u.original.x),y:Math.round(u.container.y-u.original.y)}}),this.container.on("pressmove",function(e){var t;if(e.nativeEvent.preventDefault(),"rest2"!==u.name&&("vspace"!==(null==u?void 0:u.name)||"rest2"!==(null===(t=u.blocks.blockList[u.connections[1]])||void 0===t?void 0:t.name))){for(var i=u.blocks.blockList[u.connections[1]];null!=i;){if("rest2"===(null===i||void 0===i?void 0:i.name))return void r.activity.errorMsg(_("Silence block cannot be removed."),i);i=null===i||void 0===i?void 0:i.blocks.blockList[i.connections[1]]}window.hasMouse?p=!0:setTimeout(function(){p=20<Math.abs(e.stageX/u.activity.getStageScale()-u.original.x)+Math.abs(e.stageY/u.activity.getStageScale()-u.original.y)&&!window.hasMouse,m=!p},200);var s=u.container.x,l=u.container.y,o=Math.round(e.stageX/u.activity.getStageScale()+u.offset.x-s),a=Math.round(e.stageY/u.activity.getStageScale()+u.offset.y-l),n=l+a;if(0===u.activity.blocksContainer.y&&n<45&&(a+=45-n),e.stageX<10&&u.activity.scrollBlockContainer?u.blocks.moveAllBlocksExcept(u,10,0):e.stageX>window.innerWidth-10&&u.activity.scrollBlockContainer?u.blocks.moveAllBlocksExcept(u,-10,0):e.stageY>window.innerHeight-10?u.blocks.moveAllBlocksExcept(u,0,-10):e.stageY<60&&u.blocks.moveAllBlocksExcept(u,0,10),null!=u.blocks.longPressTimeout&&(clearTimeout(u.blocks.longPressTimeout),u.blocks.longPressTimeout=null,u.blocks.clearLongPress()),p||null==u.label||(u.label.style.display="none"),u.blocks.moveBlockRelative(b,o,a),u.activity.trashcan.overTrashcan(e.stageX/u.activity.getStageScale(),e.stageY/u.activity.getStageScale())?u.activity.trashcan.startHighlightAnimation():u.activity.trashcan.stopHighlightAnimation(),u.isValueBlock()&&"media"!==u.name&&u.container.setChildIndex(u.text,u.container.children.length-1),u.blocks.findDragGroup(b),0<u.blocks.dragGroup.length)for(var c=0;c<u.blocks.dragGroup.length;c++){var h=u.blocks.dragGroup[c];0!==c&&u.blocks.moveBlockRelative(h,o,a)}u.activity.refreshCanvas()}}),this.container.on("mouseout",function(e){u.blocks.getLongPressStatus()?(clearTimeout(u.blocks.longPressTimeout),u.blocks.longPressTimeout=null,u.blocks.clearLongPress()):u._mouseoutCallback(e,p,s,!1),u.blocks.selectionModeOn||u.blocks.unhighlight(b,!0),u.blocks.activeBlock=null,p=!1}),this.container.on("pressup",function(e){u.blocks.getLongPressStatus()?(clearTimeout(u.blocks.longPressTimeout),u.blocks.longPressTimeout=null,u.blocks.clearLongPress()):u._mouseoutCallback(e,p,s,!1),u.blocks.unhighlight(b,!0),u.blocks.activeBlock=null,p=!1})}},{key:"_mouseoutCallback",value:function(e,t,i,s){var l=this.blocks.blockList.indexOf(this);this.activity.logo.runningLilypond||(document.body.style.cursor="default"),t||this.activity.trashcan.hide(),null!=this.blocks.longPressTimeout&&(clearTimeout(this.blocks.longPressTimeout),this.blocks.longPressTimeout=null,this.blocks.clearLongPress()),t?this.activity.trashcan.overTrashcan(e.stageX/this.activity.getStageScale(),e.stageY/this.activity.getStageScale())?this.activity.trashcan.isVisible&&(this.blocks.sendStackToTrash(this),this.activity.textMsg(_("You can restore deleted blocks from the trash with the Restore From Trash button."),3e3)):(this.blocks.mouseDownTime=(new Date).getTime(),this.blocks.blockMoved(l),this.blocks.adjustDocks(this.blocks.blockList.indexOf(this),!0)):(SPECIALINPUTS.includes(this.name)||["media","loadFile"].includes(this.name))&&(i||(new Date).getTime()-this.blocks.mouseDownTime<500&&(this.trash||(this.blocks.mouseDownTime=(new Date).getTime(),"media"===this.name||"loadFile"===this.name?this._doOpenMedia(l):this._changeLabel()))),s&&((e.stageX/this.activity.getStageScale()<this.container.x||e.stageX/this.activity.getStageScale()>this.container.x+this.width||e.stageY<this.container.y||e.stageY>this.container.y+this.hitHeight)&&(this._usePiemenu()||(this._labelChanged(!0,!0),hideDOMLabel(),this._checkWidgets(!1)),this.blocks.unhighlight(null),this.activity.refreshCanvas()),this.blocks.activeBlock=null)}},{key:"_usePiemenu",value:function(){if(this._check_meter_block=null,PIEMENUS.includes(this.name))return!0;var e=this.blocks.blockList.indexOf(this);return!!this.blocks.octaveNumber(e)||(!!this.blocks.noteValueNumber(e,2)||(!!this.blocks.noteValueNumber(e,1)||(!!this.blocks.octaveModifierNumber(e)||(!!this.blocks.intervalModifierNumber(e)||(!!this._usePieNumberC3()||(!!this._usePieNumberC2()||!!this._usePieNumberC1()))))))}},{key:"_usePieNumberC1",value:function(){var e=this.connections[0];return null!==e&&(0!==this.blocks.blockList[this.connections[0]].protoblock.piemenuValuesC1.length&&this.blocks.blockList[e].connections[1]===this.blocks.blockList.indexOf(this))}},{key:"_usePieNumberC2",value:function(){var e=this.connections[0];return null!==e&&(0!==this.blocks.blockList[this.connections[0]].protoblock.piemenuValuesC2.length&&this.blocks.blockList[e].connections[2]===this.blocks.blockList.indexOf(this))}},{key:"_usePieNumberC3",value:function(){var e=this.connections[0];return null!==e&&(0!==this.blocks.blockList[this.connections[0]].protoblock.piemenuValuesC3.length&&this.blocks.blockList[e].connections[3]===this.blocks.blockList.indexOf(this))}},{key:"_ensureDecorationOnTop",value:function(){for(var e=0;e<this.container.children.length;e++)if("decoration"===this.container.children[e].name){var t=0;"drum"===this.name&&this.collapsed&&(t=25*this.protoblock.scale/2);for(var i=0;i<this.activity.turtles.getTurtleCount();i++)if(this.activity.turtles.getTurtle(i).startBlock===this){this.activity.turtles.getTurtle(i).decorationBitmap.x=this.width-t-30*this.protoblock.scale/2;break}this.container.setChildIndex(this.container.children[e],this.container.children.length-1);break}this.container.setChildIndex(this.bitmap,0),this.container.setChildIndex(this.highlightBitmap,0),null!==this.disconnectedBitmap&&this.container.setChildIndex(this.disconnectedBitmap,0),this.updateCache()}},{key:"_changeLabel",value:function(){var t,e,i,s,l,o,a,n,c,h,r,u,b,p,m,k,d=this,v=this.container.x,g=this.container.y,f=this.activity.canvas.offsetLeft+28*this.blocks.blockScale,L=this.activity.canvas.offsetTop+6*this.blocks.blockScale,B=!1;!window.hasMouse&&75<this.activity.blocksContainer.y+g&&(B=!0,t=this.activity.blocksContainer.y,this.activity.blocksContainer.y=75-g),e=null!=this.label?this.label.value:this.value;var T,y,x,C,S=docById("labelDiv");if("text"===this.name){S.innerHTML='<input id="textLabel" style="position: absolute; -webkit-user-select: text;-moz-user-select: text;-ms-user-select: text;" class="text" type="text" value="'+(T={"<":"lt",">":"gt",'"':"quot","'":"apos","&":"amp","\r":"#10","\n":"#13"},e.toString().replace(/[<>"'\r\n&]/g,function(e){return"&"+T[e]+";"}))+'" />',S.classList.add("hasKeyboard"),this.label=docById("textLabel");var E=this.label.value.length;this.label.setSelectionRange(E,E)}else if("solfege"===this.name){i=splitSolfege(this.value);var A=_("ti la sol fa mi re do").split(" ");this.piemenuOKtoLaunch()&&piemenuPitches(this,A,SOLFNOTES,SOLFATTRS,i[0],i[1])}else if("scaledegree2"===this.name){i=splitScaleDegree(this.value);var w="7 6 5 4 3 2 1".split(" ");this.piemenuOKtoLaunch()&&piemenuPitches(this,w,SCALENOTES,SOLFATTRS,i[0],i[1])}else if("customNote"===this.name)if(this.activity.logo.customTemperamentDefined){for(var O,N=getTemperamentKeys(),I={},D=[],M=0;M<N.length;M++)I[N[M]]=getTemperament(N[M]),isCustomTemperament(N[M])&&D.push(N[M]);O=null!==this.customID?this.customID:D[0],s=null!==this.value?this.value:getTemperament(O)[0][1],piemenuCustomNotes(this,I,D,O,s)}else{i=splitSolfege(this.value);var P=_("ti la sol fa mi re do").split(" ");this.piemenuOKtoLaunch()&&piemenuPitches(this,P,SOLFNOTES,SOLFATTRS,i[0],i[1])}else if("eastindiansolfege"===this.name)s=(i=splitSolfege(this.value))[0],R=i[1],this.piemenuOKtoLaunch()&&piemenuPitches(this,EASTINDIANSOLFNOTES,SOLFNOTES,SOLFATTRS,i[0],i[1]);else if("notename"===this.name){var R,H=["B","A","G","F","E","D","C"];""===(R=null!=this.value?(s=this.value[0],1===this.value.length?"♮":2===this.value.length?this.value[1]:this.value[1]+this.value[2]):(s="G","♮"))&&(R="♮"),this.piemenuOKtoLaunch()&&piemenuPitches(this,H,H,SOLFATTRS,s,R)}else if("modename"===this.name)o=null!=this.value?this.value:DEFAULTMODE,piemenuModes(this,o);else if("chordname"===this.name)a=null!=this.value?this.value:DEFAULTCHORD,piemenuChords(this,a);else if("accidentalname"===this.name)l=null!=this.value?this.value:DEFAULTACCIDENTAL,this.piemenuOKtoLaunch()&&piemenuAccidentals(this,ACCIDENTALLABELS,ACCIDENTALNAMES,l);else if("intervalname"===this.name)c=null!=this.value?this.value:DEFAULTINTERVAL,this.piemenuOKtoLaunch()&&piemenuIntervals(this,c);else if("invertmode"===this.name){n=null!=this.value?this.value:DEFAULTINVERT;for(var F=[],U=[],G=0;G<INVERTMODES.length;G++)F.push(_(INVERTMODES[G][1])),U.push(INVERTMODES[G][1]);this.piemenuOKtoLaunch()&&piemenuBasic(this,F,U,n)}else if("drumname"===this.name){h=null!=this.value?this.value:DEFAULTDRUM;for(var V,W=[],Y=[],X=[],j=[],K=0;K<DRUMNAMES.length;K++){EFFECTSNAMES.includes(DRUMNAMES[K][1])||(V=_(DRUMNAMES[K][1]),400<getTextWidth(V,"bold 30pt Sans")?W.push(V.substr(0,8)+"..."):W.push(V),Y.push(DRUMNAMES[K][1]),j.includes(DRUMNAMES[K][4])||j.push(DRUMNAMES[K][4]),X.push(j.indexOf(DRUMNAMES[K][4])))}piemenuVoices(this,W,Y,X,h)}else if("effectsname"===this.name){null!=this.value?h=this.value:r=DEFAULTEFFECT;for(var z,q=[],Z=[],$=[],J=[],Q=0;Q<DRUMNAMES.length;Q++){EFFECTSNAMES.includes(DRUMNAMES[Q][1])&&(z=_(DRUMNAMES[Q][1]),400<getTextWidth(z,"Bold 30pt Sans")?q.push(z.substr(0,8)+"..."):q.push(z),Z.push(DRUMNAMES[Q][1]),J.includes(DRUMNAMES[Q][4])||J.push(DRUMNAMES[Q][4]),$.push(J.indexOf(DRUMNAMES[Q][4])))}piemenuVoices(this,q,Z,$,r)}else if("filtertype"===this.name){m=null!=this.value?this.value:DEFAULTFILTERTYPE;for(var ee=[],te=[],ie=0;ie<FILTERTYPES.length;ie++)ee.push(_(FILTERTYPES[ie][0])),te.push(FILTERTYPES[ie][1]);piemenuBasic(this,ee,te,m,platformColor.piemenuBasic)}else if("oscillatortype"===this.name){m=null!=this.value?this.value:DEFAULTOSCILLATORTYPE;for(var se=[],le=[],oe=0;oe<OSCTYPES.length;oe++)se.push(_(OSCTYPES[oe][1])),le.push(OSCTYPES[oe][1]);piemenuBasic(this,se,le,m,platformColor.piemenuBasic)}else if("voicename"===this.name){u=null!=this.value?this.value:DEFAULTVOICE;for(var ae,ne=[],ce=[],he=[],re=[],ue=0;ue<VOICENAMES.length;ue++){this.activity.beginnerMode&&"custom"===VOICENAMES[ue][1]||(ae=_(VOICENAMES[ue][1]),400<getTextWidth(ae,"bold 30pt Sans")?ne.push(ae.substr(0,8)+"..."):ne.push(ae),ce.push(VOICENAMES[ue][1]),re.includes(VOICENAMES[ue][3])||re.push(VOICENAMES[ue][3]),he.push(re.indexOf(VOICENAMES[ue][3])))}piemenuVoices(this,ne,ce,he,u)}else if("noisename"===this.name){b=null!=this.value?this.value:DEFAULTNOISE;for(var be=[],pe=[],me=[],ke=[],de=0;de<NOISENAMES.length;de++){var ve=NOISENAMES[de][0];600<getTextWidth(ve,"bold 30pt Sans")?be.push(ve.substr(0,16)+"..."):be.push(ve),pe.push(NOISENAMES[de][1]),ke.includes(NOISENAMES[de][3])||ke.push(NOISENAMES[de][3]),me.push(ke.indexOf(NOISENAMES[de][3]))}piemenuVoices(this,be,pe,me,b,90)}else if("temperamentname"===this.name){p=null!=this.value?this.value:DEFAULTTEMPERAMENT;for(var ge=[],fe=[],Le=getTemperamentsList(),Be=0;Be<Le.length;Be++)this.activity.beginnerMode&&"custom"===Le[Be][1]||(0===Le[Be][0].length?ge.push(Le[Be][2]):ge.push(Le[Be][0]),fe.push(Le[Be][1]));piemenuBasic(this,ge,fe,p,platformColor.piemenuBasic)}else if("boolean"===this.name){Se=null==this.value||this.value;var Te=[_("true"),_("false")];piemenuBoolean(this,Te,[!0,!1],Se)}else if("grid"===this.name){Se=this.value;var ye=[],xe=[],xe=_THIS_IS_TURTLE_BLOCKS_?(ye=[_("Cartesian"),_("polar"),_("Cartesian/Polar"),_("none")],["Cartesian","polar","Cartesian/Polar","none"]):(ye=[_("Cartesian"),_("polar"),_("Cartesian/Polar"),_("treble"),_("grand staff"),_("mezzo-soprano"),_("alto"),_("tenor"),_("bass"),_("none")],["Cartesian","polar","Cartesian/Polar","treble","grand staff","mezzo-soprano","alto","tenor","bass","none"]);piemenuBasic(this,ye,xe,Se,platformColor.piemenuBasic)}else if("outputtools"===this.name){var Ce,Se=this.privateData,Ee=this.activity.beginnerMode?(Ce=this.protoblock.extraSearchTerms.slice(0,6),this.protoblock.iemenuLabels.slice(0,6)):(Ce=this.protoblock.extraSearchTerms,this.protoblock.piemenuLabels);Ce.includes(Se)||(Se=Ce[3]),piemenuBasic(this,Ee,Ce,Se,platformColor.piemenuBasic)}else if("wrapmode"===this.name){k=null!=this.value?this.value:"on";for(var _e=[],Ae=[],we=[[_("on2"),"on"],[_("off"),"off"]],Oe=0;Oe<we.length;Oe++)_e.push(_(we[Oe][1])),Ae.push(we[Oe][1]);piemenuBasic(this,_e,Ae,k)}else{var Ne=this.blocks.blockList.indexOf(this);if(this.blocks.octaveNumber(Ne))piemenuNumber(this,[8,7,6,5,4,3,2,1],this.value);else if(this.blocks.noteValueNumber(Ne,2)){var Ie=this.connections[0];null!==Ie&&null!==(Ie=this.blocks.blockList[Ie].connections[0])&&["rhythm2","stuplet"].includes(this.blocks.blockList[Ie].name)?piemenuNumber(this,[2,4,8,16],this.value):piemenuNoteValue(this,this.value)}else if(this.blocks.noteValueNumber(Ne,1)){var De,Me=this.blocks.noteValueValue(Ne);if(1===Me)De=[8,7,6,5,4,3,2,1];else{De=[];for(var Pe=0;Pe<Math.min(Me,16);Pe++)De.push(Pe+1)}var Re=this.connections[0];null!==Re&&null!==(Re=this.blocks.blockList[Re].connections[0])&&["neighbor","neighbor2","rhythm2","stuplet"].includes(this.blocks.blockList[Re].name)&&(De=[3,2,1]),piemenuNumber(this,De,this.value)}else if(this.blocks.octaveModifierNumber(Ne))piemenuNumber(this,[-2,-1,0,1,2],this.value);else if(this.blocks.intervalModifierNumber(Ne))piemenuNumber(this,this.blocks.blockList[this.blocks.blockList[this.connections[0]].connections[0]].protoblock.piemenuValuesC1,this.value);else if(this._usePieNumberC3())piemenuNumber(this,this.blocks.blockList[this.connections[0]].protoblock.piemenuValuesC3,this.value);else if(this._usePieNumberC2())piemenuNumber(this,this.blocks.blockList[this.connections[0]].protoblock.piemenuValuesC2,this.value);else if(this._usePieNumberC1())switch(this.blocks.blockList[this.connections[0]].name){case"setturtlecolor":case"setcolor":case"sethue":case"setshade":case"settranslucency":case"setgrey":piemenuColor(this,this.blocks.blockList[this.connections[0]].protoblock.piemenuValuesC1,this.value,this.blocks.blockList[this.connections[0]].name);break;case"pitchnumber":for(var He,Fe,Ue=0;Ue<this.blocks.blockList.length;Ue++){"settemperament"===this.blocks.blockList[Ue].name&&null!==this.blocks.blockList[Ue].connections[0]&&(He=this.blocks.blockList[Ue].connections[1],Fe=this.blocks.blockList[He].value)}if(void 0===Fe&&(Fe="equal"),"equal"===Fe)piemenuNumber(this,[-3,-2,-1,0,1,2,3,4,5,6,7,8,9,10,11,12],this.value);else{for(var Ge=[],Ve=0;Ve<getTemperament(Fe).pitchNumber;Ve++)Ge.push(Ve);piemenuNumber(this,Ge,this.value)}break;default:piemenuNumber(this,this.blocks.blockList[this.connections[0]].protoblock.piemenuValuesC1,this.value)}else{S.innerHTML='<input id="numberLabel" style="position: absolute; -webkit-user-select: text;-moz-user-select: text;-ms-user-select: text;" class="number" type="number" value="'+e+'" />',S.classList.add("hasKeyboard"),this.label=docById("numberLabel");var We=this.label.value.length,Ye=this.label.type;this.label.type="text",this.label.setSelectionRange(We,We),this.label.type=Ye}}this._usePiemenu()||(y=!1,x=function(e){y&&(d._labelChanged(!0,!0),e.preventDefault(),S.classList.remove("hasKeyboard"),window.scroll(0,0),d.label.removeEventListener("keypress",C),B&&(d.activity.blocksContainer.y=t,d.activity.blocksContainer.update()))},"text"!==this.name&&"number"!==this.name||(this.label.addEventListener("blur",x),this.label.addEventListener("input",function(){d._labelChanged(!1,!0)})),C=function(e){[13,10,9].includes(e.keyCode)&&x(e)},this.label.addEventListener("keypress",C),this.label.addEventListener("change",function(){d._labelChanged(!1,!0)}),this.label.style.left=Math.round((v+this.activity.blocksContainer.x)*this.activity.getStageScale()+f)+"px",this.label.style.top=Math.round((g+this.activity.blocksContainer.y)*this.activity.getStageScale()+L)+"px",this.label.style.width=Math.round(150*this.blocks.blockScale*this.protoblock.scale/2)+"px",this.label.style.fontSize=Math.round(20*this.blocks.blockScale*this.protoblock.scale/2)+"px",this.label.style.display="",this.label.focus(),null!=this.labelattr&&(this.labelattr.style.display=""),setTimeout(function(){d.label.style.display="",d.label.focus(),y=!0},100))}},{key:"_exitKeyPressed",value:function(e){[13,10,9].includes(e.keyCode)&&(this._labelChanged(!0,!1),e.preventDefault(),this.label.removeEventListener("keypress",this._exitKeyPressed))}},{key:"piemenuOKtoLaunch",value:function(){return null===this._piemenuExitTime||200<(new Date).getTime()-this._piemenuExitTime}},{key:"_noteValueNumber",value:function(e){var t=this.connections[0];if("number"===this.name&&null!==t&&"divide"===this.blocks.blockList[t].name&&this.blocks.blockList[t].connections[e]===this.blocks.blockList.indexOf(this)){var i=this.blocks.blockList[t].connections[0];if(null!==i)switch(this.blocks.blockList[i].name){case"newnote":case"pickup":case"tuplet4":case"newstaccato":case"newslur":case"elapsednotes2":return this.blocks.blockList[i].connections[1]===t;case"meter":this._check_meter_block=i;case"setbpm2":case"setmasterbpm2":case"stuplet":case"rhythm2":case"newswing2":case"vibrato":case"neighbor":case"neighbor2":return this.blocks.blockList[i].connections[2]===t;default:return!1}}return!1}},{key:"_noteValueValue",value:function(){var e=this.connections[0],t=this.blocks.blockList[e].connections[0];if(null!==t)switch(this.blocks.blockList[t].name){case"newnote":case"pickup":case"tuplet4":case"newstaccato":case"newslur":case"elapsednotes2":return this.blocks.blockList[t].connections[1]===e?(t=this.blocks.blockList[e].connections[2],this.blocks.blockList[t].value):1;case"meter":this._check_meter_block=t;case"setbpm2":case"setmasterbpm2":case"stuplet":case"rhythm2":case"newswing2":case"vibrato":case"neighbor":case"neighbor2":return this.blocks.blockList[t].connections[2]===e&&this.blocks.blockList[t].connections[1]===e?(t=this.blocks.blockList[e].connections[2],this.blocks.blockList[t].value):1;default:return 1}return 1}},{key:"_checkWidgets",value:function(e){var t=this.blocks.blockList.indexOf(this),i=this.blocks.findTopBlock(t),s=document.getElementsByClassName("wftTitle"),l=!1;if(!1===e)for(var o=0;o<s.length;o++)if(!1===l)switch(s[o].innerHTML){case"oscilloscope":case"tempo":case"rhythm maker":case"pitch slider":case"pitch staircase":case"status":case"phrase maker":case"lego bricks":case"custom mode":case"music keyboard":case"pitch drum":case"meter":case"temperament":case"mode":case"timbre":l=!0,this.blocks.blockList[i].protoblock.staticLabels[0]==s[o].innerHTML&&this.blocks.reInitWidget(i,1500)}}},{key:"_labelChanged",value:function(e,t){if(null!==this&&null!==this.label){this._labelLock=!0,e&&(this.label.style.display="none",null!=this.labelattr&&(this.labelattr.style.display="none"),docById("wheelDiv").style.display="none"),void 0===t&&(docById("wheelDiv").style.display="none");var i=this.value,s=this.label.value;if(null!=this.labelattr){var l=this.labelattr.value;switch(l){case"𝄪":case"♯":case"𝄫":case"♭":s+=l}}var o=this.connections[0];if(i!==s||(this._labelLock=!1,"text"===this.name&&null!==o&&"storein"===this.blocks.blockList[o].name)){var a,n,c,h,r,u,b,p,m,k,o=this.connections[0];if("text"===this.name&&null!=o)switch(this.blocks.blockList[o].name){case"action":this.blocks.palettes.removeActionPrototype(i),(a=this.blocks.findUniqueActionName(s))!==s&&(s=a,this.value=s,n=this.value.toString(),getTextWidth(n,"bold 20pt Sans")>TEXTWIDTH&&(n=n.substr(0,STRINGLEN)+"..."),this.text.text=n,this.label.value=s,this.updateCache());break;case"pitch":s=a=this.blocks.findUniqueCustomName(s);var d=getTemperament("custom"),v=!1;for(var g in d)"pitchNumber"!==g&&i===d[g][1]&&(d[g][1]=s,v=!0);v&&addTemperamentToDictionary("custom",d),this.value=s;var f=this.value.toString();getTextWidth(f,"bold 20pt Sans")>TEXTWIDTH&&(f=f.substr(0,STRINGLEN)+"..."),this.text.text=f,this.label.value=s,this.updateCache()}if("number"===this.name?(b=null!==(c=this.connections[0])?this.blocks.blockList[c].connections[0]:null,"-"===this.value?this.value=-1:null!==b&&s<0&&("newnote"===this.blocks.blockList[c].name||"newnote"==this.blocks.blockList[b].name)?(this.label.value=0,this.value=0):this.value=Number(s),isNaN(this.value)&&(h=this.blocks.blockList.indexOf(this),this.activity.errorMsg(s+": "+_("Not a number"),h),this.activity.refreshCanvas(),this.value=i),null!=c&&"pitch"===this.blocks.blockList[c].name&&(8<this.value||this.value<1)&&(r=this.blocks.blockList.indexOf(this),this.activity.errorMsg(_("Octave value must be between 1 and 8."),r),this.activity.refreshCanvas(),this.label.value=i,this.value=i),10<String(this.value).length&&(u=this.blocks.blockList.indexOf(this),this.activity.errorMsg(_("Numbers can have at most 10 digits."),u),this.activity.refreshCanvas(),this.label.value=i,this.value=i)):this.value=s,"solfege"===this.name?(p=splitSolfege(this.value),m=i18nSolfege(p[0]),"♮"!==(k=p[1])&&(m+=k)):"eastindiansolfege"===this.name?(p=splitSolfege(this.value),m=WESTERN2EISOLFEGENAMES[p[0]],"♮"!==(k=p[1])&&(m+=k)):m="modename"===this.name?this.value+" "+getModeNumbers(this.value):this.value.toString(),!WIDENAMES.includes(this.name)&&getTextWidth(m,"bold 20pt Sans")>TEXTWIDTH){for(var L=m.length-5,B=m.substr(0,L)+"...";getTextWidth(B,"bold 20pt Sans")>TEXTWIDTH&&(--L,B=m.substr(0,L)+"...",!(L<=STRINGLEN)););m=B}if(this.text.text=m,e&&(this.label.style.display="none",docById("wheelDiv").style.display="none"),this.container.setChildIndex(this.text,this.container.children.length-1),this.updateCache(),"text"===this.name&&null!=o){var T=this.blocks.blockList[o];switch(T.name){case"action":this.blocks.renameDos(i,s),i===_("action")&&(this.blocks.newNameddoBlock(s,this.blocks.actionHasReturn(o),this.blocks.actionHasArgs(o)),this.blocks.setActionProtoVisiblity(!1)),this.blocks.newNameddoBlock(s,this.blocks.actionHasReturn(o),this.blocks.actionHasArgs(o));for(var y=this.blocks.palettes.dict.action,x=0;x<y.protoList.length;x++){var C=y.protoList[x];i===_("action")?"nameddo"===C.name&&0===C.defaults.length&&(C.hidden=!0):"nameddo"===C.name&&C.defaults[0]===i&&y.remove(C,i)}i===_("action")&&(this.blocks.newNameddoBlock(s,this.blocks.actionHasReturn(o),this.blocks.actionHasArgs(o)),this.blocks.setActionProtoVisiblity(!1)),this.blocks.renameNameddos(i,s),this.blocks.palettes.hide(),this.blocks.palettes.updatePalettes("action"),this.blocks.palettes.show();break;case"storein":T.connections[1]===this.blocks.blockList.indexOf(this)&&e&&("box"!==this.value&&(this.blocks.newStorein2Block(this.value),this.blocks.newNamedboxBlock(this.value)),this.blocks.renameBoxes(i,s),this.blocks.renameNamedboxes(i,s),this.blocks.renameStoreinBoxes(i,s),this.blocks.renameStorein2Boxes(i,s),this.blocks.palettes.hide(),this.blocks.palettes.updatePalettes("boxes"),this.blocks.palettes.show());break;case"setdrum":case"playdrum":"http"===s.slice(0,4)&&this.activity.logo.synth.loadSynth(0,s);break;case"temperament1":var S=getTemperament(i);deleteTemperamentFromList(i),addTemperamentToDictionary(s,S),updateTemperaments()}}this._labelLock=!1,["drumname","effectsname","voicename","noisename"].includes(this.name)&&this.activity.logo.synth.loadSynth(0,getDrumSynthName(this.value))}}else this._labelLock=!1}}]),s}(),$=function(){for(var e=new Array,t=0;t<e.length;t++){var i=e[t];if("string"==typeof i&&(i=docById(i)),1===e.length)return i;e.push(i)}return e};window.hasMouse=!1,document.addEventListener("mousemove",function(){window.hasMouse=!0});