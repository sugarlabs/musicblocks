"use strict";function asyncGeneratorStep(e,t,n,o,a,r,i){try{var c=e[r](i),s=c.value}catch(e){return void n(e)}c.done?t(s):Promise.resolve(s).then(o,a)}function _asyncToGenerator(c){return function(){var e=this,i=arguments;return new Promise(function(t,n){var o=c.apply(e,i);function a(e){asyncGeneratorStep(o,t,n,a,r,"next",e)}function r(e){asyncGeneratorStep(o,t,n,a,r,"throw",e)}a(void 0)})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var PlanetInterface=function e(t){var r=this;_classCallCheck(this,e),this.planet=null,this.iframe=null,this.mainCanvas=null,this.activity=t,this.hideMusicBlocks=function(){r.activity.hideSearchWidget(),window.widgetWindows.hideAllWindows(),r.activity.logo.doStopTurtles(),docById("helpElem").style.visibility="hidden",document.querySelector(".canvasHolder").classList.add("hide"),document.querySelector("#canvas").style.display="none",document.querySelector("#theme-color").content="#8bc34a";var e=r;setTimeout(function(){e.activity.stage.enableDOMEvents(!1)},250),window.scroll(0,0)},this.showMusicBlocks=function(){document.title=r.activity.planet.getCurrentProjectName(),document.getElementById("toolbars").style.display="block",document.getElementById("palette").style.display="block",r.activity.prepSearchWidget(),window.widgetWindows.showWindows(),document.querySelector(".canvasHolder").classList.remove("hide"),document.querySelector("#canvas").style.display="",document.querySelector("#theme-color").content=platformColor.header,r.activity.stage.enableDOMEvents(!0),window.scroll(0,0),docById("buttoncontainerBOTTOM").style.display="block",docById("buttoncontainerTOP").style.display="block"},this.showPlanet=function(){var e=docById("overlayCanvas").toDataURL("image/png");r.planet.open(e),r.iframe.style.display="block",r.iframe.style.zIndex="9999";try{r.iframe.contentWindow.document.getElementById("local-tab").click()}catch(e){console.error(e)}},this.hidePlanet=function(){r.iframe.style.display="none"},this.openPlanet=function(){r.saveLocally(),r.hideMusicBlocks(),r.showPlanet()},this.closePlanet=function(){r.hidePlanet(),r.showMusicBlocks()},this.loadProjectFromData=function(e,t){if(void 0===t&&(t=!1),r.closePlanet(),t||r.activity.sendAllToTrash(!1,!0),void 0!==e){r.activity.textMsg(r.getCurrentProjectName()),r.activity.loading=!0,document.body.style.cursor="wait",r.activity.doLoadAnimation(),r.activity._allClear(!1),r.activity.blocks.palettes._hideMenus(!0);var n=function e(){document.removeEventListener("finishedLoading",e)};document.addEventListener?document.addEventListener("finishedLoading",n):document.attachEvent("finishedLoading",n);try{var o=JSON.parse(e);r.activity.blocks.loadNewBlocks(o)}catch(e){r.errorMsg(e)}r.activity.loading=!1,document.body.style.cursor="default"}else r.errorMsg(_("project undefined"))},this.loadProjectFromFile=function(){document.querySelector("#myOpenFile").focus(),document.querySelector("#myOpenFile").click(),window.scroll(0,0)},this.newProject=function(){r.closePlanet(),r.initialiseNewProject(),r.activity._loadStart(),r.saveLocally()},this.initialiseNewProject=function(e){r.planet.ProjectStorage.initialiseNewProject(e),r.activity.sendAllToTrash(),r.activity.refreshCanvas(),r.activity.blocks.trashStacks=[]},this.saveLocally=function(){r.activity.stage.update(event);var n,o,a=r.activity.prepareExport(),e=doSVG(r.activity.canvas,r.activity.logo,r.activity.turtles,320,240,320/r.activity.canvas.width);try{null==e||""===e?r.planet.ProjectStorage.saveLocally(a,null):(n=new Image,o=r,n.onload=function(){var e=new createjs.Bitmap(n),t=e.getBounds();e.cache(t.x,t.y,t.width,t.height),o.planet.ProjectStorage.saveLocally(a,e.bitmapCache.getCacheDataURL())},n.src="data:image/svg+xml;base64,"+window.btoa(base64Encode(e)))}catch(e){if(e.code!==DOMException.QUOTA_EXCEEDED_ERR&&"Not enough space to save locally"!==e.message)throw console.error(e),e;r.activity.textMsg(_("Error: Unable to save because you ran out of local storage. Try deleting some saved projects."))}},this.openCurrentProject=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.planet.ProjectStorage.getCurrentProjectData();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e)})),this.openProjectFromPlanet=function(e,t){r.planet.openProjectFromPlanet(e,t)},this.onConverterLoad=function(){window.Converter=r.planet.Converter},this.getCurrentProjectName=function(){return r.planet.ProjectStorage.getCurrentProjectName()},this.getCurrentProjectDescription=function(){return r.planet.ProjectStorage.getCurrentProjectDescription()},this.getCurrentProjectImage=function(){return r.planet.ProjectStorage.getCurrentProjectImage()},this.getTimeLastSaved=function(){return r.planet.ProjectStorage.TimeLastSaved},this.init=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r.iframe=document.getElementById("planet-iframe"),e.prev=1,e.next=4,r.iframe.contentWindow.makePlanet(_THIS_IS_MUSIC_BLOCKS_,r.activity.storage,window._);case 4:r.planet=r.iframe.contentWindow.p,r.planet.setLoadProjectFromData(r.loadProjectFromData.bind(r)),r.planet.setPlanetClose(r.closePlanet.bind(r)),r.planet.setLoadNewProject(r.newProject.bind(r)),r.planet.setLoadProjectFromFile(r.loadProjectFromFile.bind(r)),r.planet.setOnConverterLoad(r.onConverterLoad.bind(r)),e.next=16;break;case 12:e.prev=12,e.t0=e.catch(1),console.error(e.t0),r.planet=null;case 16:window.Converter=r.planet.Converter,r.mainCanvas=r.activity.canvas;case 18:case"end":return e.stop()}},e,null,[[1,12]])}))};"undefined"!=typeof module&&module.exports&&(module.exports=PlanetInterface);