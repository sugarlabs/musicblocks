"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o=0;o<t.length;o++){var r=t[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,_toPropertyKey(r.key),r)}}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var o=e[Symbol.toPrimitive];if(void 0===o)return("string"===t?String:Number)(e);var r=o.call(e,t||"default");if("object"!=_typeof(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(o){var r=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(o);return _possibleConstructorReturn(this,r?(e=_getPrototypeOf(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function _possibleConstructorReturn(e,t){if(t&&("object"==_typeof(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(_isNativeReflectConstruct=function(){return!!e})()}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function setupProgramBlocks(O){var e=function(){_inherits(o,FlowBlock);var t=_createSuper(o);function o(){var e;return _classCallCheck(this,o),(e=t.call(this,"loadHeapFromApp")).setPalette("program",O),e.setHelpString([_("The Load-heap-from-app block loads the heap from a web page."),"documentation",""]),e.formBlock({name:_("load heap from App"),args:2,argTypes:["textin","textin"],defaults:["appName","localhost"]}),e}return _createClass(o,[{key:"flow",value:function(e,t,o,r){if(null!==e[0]&&null!==e[1]){var l=[],n=e[1],s=e[0],a=new XMLHttpRequest,c=[];if(a.open("GET",n,!1),a.send(),4!==a.readyState||200!==a.status)return 4===a.readyState&&200!==a.status?(console.debug("fetched the wrong page or network error..."),void O.errorMsg(_("404: Page not found"))):void O.errorMsg("xmlHttp.readyState: "+a.readyState);console.debug(a.responseText);try{l=JSON.parse(a.responseText)}catch(e){console.debug(e),O.errorMsg(_("Error parsing JSON data:")+e)}s in t.turtleHeaps&&(c=t.turtleHeaps[o]);try{t.turtleHeaps[s]=l}catch(e){t.turtleHeaps[s]=c,console.debug(e)}}else O.errorMsg(NOINPUTERRORMSG,r)}}]),o}(),t=function(){_inherits(o,FlowBlock);var t=_createSuper(o);function o(){var e;return _classCallCheck(this,o),(e=t.call(this,"saveHeapToApp")).setPalette("program",O),e.setHelpString([_("The Save-heap-to-app block saves the heap to a web page."),"documentation",""]),e.formBlock({name:_("save heap to App"),args:2,argTypes:["textin","textin"],defaults:["appName","localhost"]}),e}return _createClass(o,[{key:"flow",value:function(e,t,o,r){var l,n,s,a;null!==e[0]&&null!==e[1]?(l=e[0],n=e[1],l in t.turtleHeaps?(s=JSON.stringify(t.turtleHeaps[l]),(a=new XMLHttpRequest).open("POST",n,!0),a.setRequestHeader("Content-Type","application/json;charset=UTF-8"),a.send(s)):O.errorMsg(_("Cannot find a valid heap for")+" "+l)):O.errorMsg(NOINPUTERRORMSG,r)}}]),o}(),o=function(){_inherits(o,FlowBlock);var t=_createSuper(o);function o(){var e;return _classCallCheck(this,o),(e=t.call(this,"loadHeap")).setPalette("program",O),e.setHelpString([_("The Load-heap block loads the heap from a file."),"documentation",""]),e.formBlock({name:_("load heap"),args:1,argTypes:["filein"],defaults:[[null,null]]}),e}return _createClass(o,[{key:"flow",value:function(e,t,o,r){var l=O.blocks.blockList[r],n=o in t.turtleHeaps?t.turtleHeaps[o]:[],s=l.connections[1];if(null!=s&&"loadFile"===O.blocks.blockList[s].name)if(1!==e.length)O.errorMsg(_("You must select a file."));else try{if(t.turtleHeaps[o]=JSON.parse(O.blocks.blockList[s].value[1]),!Array.isArray(t.turtleHeaps[o]))throw"is not array"}catch(e){t.turtleHeaps[o]=n,O.errorMsg(_("The file you selected does not contain a valid heap."))}else O.errorMsg(_("The loadHeap block needs a loadFile block."))}}]),o}(),r=function(){_inherits(o,FlowBlock);var t=_createSuper(o);function o(){var e;return _classCallCheck(this,o),(e=t.call(this,"setHeap")).setPalette("program",O),e.setHelpString([_("The Set-heap block loads the heap."),"documentation",""]),e.formBlock({name:_("set heap"),args:1,argTypes:["anyin"]}),e}return _createClass(o,[{key:"flow",value:function(e,t,o,r){var l=O.blocks.blockList[r],n=o in t.turtleHeaps?t.turtleHeaps[o]:[],s=l.connections[1];if(null!==s)try{if(t.turtleHeaps[o]=JSON.parse(O.blocks.blockList[s].value),!Array.isArray(t.turtleHeaps[o]))throw"is not array"}catch(e){t.turtleHeaps[o]=n,O.errorMsg(_("The block you selected does not contain a valid heap."))}else O.errorMsg(_("The Set heap block needs a heap."))}}]),o}(),l=function(){_inherits(o,FlowBlock);var t=_createSuper(o);function o(){var e;return _classCallCheck(this,o),(e=t.call(this,"loadDict")).setPalette("program",O),e.setHelpString([_("The Load-dictionary block loads a dictionary from a file."),"documentation",""]),e.formBlock({name:_("load dictionary"),args:2,argTypes:["textin","filein"],argLabels:[_("name"),_("file")],defaults:[_("My Dictionary"),[null,null]]}),e}return _createClass(o,[{key:"flow",value:function(e,t,o,r){var l=O.blocks.blockList[r];if(null!==e[0])if(null!==e[1]){var n=e[0];o in t.turtleDicts||(t.turtleDicts[o]={});var s=l.connections[2];if(null!=s&&"loadFile"===O.blocks.blockList[s].name)if(2!==e.length)O.errorMsg(_("You must select a file."));else try{var a=JSON.parse(O.blocks.blockList[s].value[1]),c=getTargetTurtle(O.turtles,n);if(null!==c)for(var i=Object.keys(a),u=0;u<i.length;u++)Turtle.DictActions.setDictValue(c,o,i[u],a[i[u]]);else n in t.turtleDicts[o]||(t.turtleDicts[o][n]={})}catch(e){O.errorMsg(_("The file you selected does not contain a valid dictionary."))}else O.errorMsg(_("The load dictionary block needs a load file block."))}else O.errorMsg(NOINPUTERRORMSG,r);else O.errorMsg(NOINPUTERRORMSG,r)}}]),o}(),n=function(){_inherits(o,FlowBlock);var t=_createSuper(o);function o(){var e;return _classCallCheck(this,o),(e=t.call(this,"setDictionary")).setPalette("program",O),e.setHelpString([_("The Set-dictionary block loads a dictionary."),"documentation",""]),e.formBlock({name:_("set dictionary"),args:2,argTypes:["textin","anyin"],argLabels:[_("name"),_("dictionary")],defaults:[_("My Dictionary")]}),e}return _createClass(o,[{key:"flow",value:function(e,t,o,r){var l=O.blocks.blockList[r];if(null!==e[0])if(null!==e[1]){var n=e[0];o in t.turtleDicts||(t.turtleDicts[o]={});var s=l.connections[2];if(null!=s)try{var a=JSON.parse(O.blocks.blockList[s].value),c=getTargetTurtle(O.turtles,n);if(null!==c)for(var i=Object.keys(a),u=0;u<i.length;u++)Turtle.DictActions.setDictValue(c,o,i[u],a[i[u]]);else n in t.turtleDicts[o]||(t.turtleDicts[o][n]={})}catch(e){O.errorMsg(_("The block you selected does not contain a valid dictionary."))}else O.errorMsg(_("The set dictionary block needs a dictionary."))}else O.errorMsg(NOINPUTERRORMSG,r);else O.errorMsg(NOINPUTERRORMSG,r)}}]),o}(),s=function(){_inherits(o,FlowBlock);var t=_createSuper(o);function o(){var e;return _classCallCheck(this,o),(e=t.call(this,"saveHeap")).setPalette("program",O),e.setHelpString([_("The Save-heap block saves the heap to a file."),"documentation",""]),e.formBlock({name:_("save heap"),args:1,argTypes:["textin"],defaults:["heap.json"]}),e}return _createClass(o,[{key:"flow",value:function(e,t,o){null!==e[0]&&o in t.turtleHeaps&&O.save.download("json","data:text/json;charset-utf-8,"+JSON.stringify(t.turtleHeaps[o]),e[0])}}]),o}(),a=function(){_inherits(o,FlowBlock);var t=_createSuper(o);function o(){var e;return _classCallCheck(this,o),(e=t.call(this,"saveDict")).setPalette("program",O),e.setHelpString([_("The Save-dictionary block saves a dictionary to a file."),"documentation",""]),e.formBlock({name:_("save dictionary"),args:2,argTypes:["textin","textin"],argLabels:[_("name"),_("file")],defaults:[_("My Dictionary"),"dictionary.json"]}),e}return _createClass(o,[{key:"flow",value:function(e,t,o,r){var l,n;null!==e[0]&&null!==e[1]?(l=e[0],o in t.turtleDicts||(t.turtleDicts[o]={}),null===(n=getTargetTurtle(O.turtles,l))?O.save.download("json","data:text/json;charset-utf-8,"+JSON.stringify(t.turtleDicts[o][l]),e[1]):O.save.download("json","data:text/json;charset-utf-8,"+Turtle.DictActions.SerializeDict(n,o),e[1])):O.errorMsg(NOINPUTERRORMSG,r)}}]),o}(),c=function(){_inherits(o,FlowBlock);var t=_createSuper(o);function o(){var e;return _classCallCheck(this,o),(e=t.call(this,"openpalette")).setPalette("program",O),e.setHelpString([_("The Open palette block opens a palette."),"documentation",""]),e.formBlock({name:_("open palette"),args:1,argTypes:["textin"],defaults:[_("rhythm")]}),e}return _createClass(o,[{key:"flow",value:function(e,t,o,r){if(e.length<1)O.errorMsg(NOINPUTERRORMSG,r);else for(var l in O.blocks.palettes.dict)if(_(O.blocks.palettes.dict[l].name)===e[0].toLowerCase())return O.blocks.palettes.hide(),O.blocks.palettes.dict[l].show(),void O.blocks.palettes.show()}}]),o}(),i=function(){_inherits(o,FlowBlock);var t=_createSuper(o);function o(){var e;return _classCallCheck(this,o),(e=t.call(this,"deleteblock")).setPalette("program",O),e.setHelpString([_("The Delete block block removes a block."),"documentation","","deletehelp"]),e.formBlock({name:_("delete block"),args:1}),e}return _createClass(o,[{key:"flow",value:function(e,t,o,r){if(e.length<1)return O.errorMsg(NOINPUTERRORMSG,r),void(t.stopTurtle=!0);if(e[0]<0||e[0]>O.blocks.blockList.length-1)O.errorMsg(NOINPUTERRORMSG,r);else if(!O.blocks.blockList[e[0]].trash){var l=O.blocks.blockList[e[0]].connections[0];if((O.blocks.blockList[e[0]].connections[0]=null)!==l)for(var n=0;n<O.blocks.blockList[l].connections.length;n++)O.blocks.blockList[l].connections[n]===e[0]&&(O.blocks.blockList[l].connections[n]=null);O.blocks.sendStackToTrash(O.blocks.blockList[e[0]]),O.blocks.adjustDocks(l,!0)}}}]),o}(),u=function(){_inherits(o,FlowBlock);var t=_createSuper(o);function o(){var e;return _classCallCheck(this,o),(e=t.call(this,"moveblock")).setPalette("program",O),e.setHelpString([_("The Move block block moves a block."),"documentation",""]),e.formBlock({name:_("move block"),args:3,argLabels:[_("block number"),_("x"),_("y")]}),e}return _createClass(o,[{key:"flow",value:function(e,t,o,r){var l,n;e.length<3||e[0]<0||e[0]>O.blocks.blockList.length-1?O.errorMsg(NOINPUTERRORMSG,r):(l=O.turtles.turtleX2screenX(e[1]),n=O.turtles.turtleY2screenY(e[2]),O.blocks.moveBlock(e[0],l,n))}}]),o}(),p=function(){_inherits(o,FlowBlock);var t=_createSuper(o);function o(){var e;return _classCallCheck(this,o),(e=t.call(this,"runblock")).setPalette("program",O),e.setHelpString([_("The Run block block runs a block. It accepts two types of arguments: block number or block name."),"documentation",""]),e.formBlock({name:_("run block"),args:1,argTypes:["anyin"],defaults:[0]}),e}return _createClass(o,[{key:"flow",value:function(e,t,o,r,l){if(e.length<1)O.errorMsg(NOINPUTERRORMSG,r);else{if("string"==typeof e[0])for(var n=0;n<O.blocks.blockList.length;n++)if(0<O.blocks.blockList[n].protoblock.staticLabels.length&&O.blocks.blockList[n].protoblock.staticLabels[0]===e[0])return void(e[0]=n);if("string"==typeof e[0]&&(e[0]=-1),e[0]<0||e[0]>O.blocks.blockList.length-1)O.errorMsg(NOINPUTERRORMSG,r);else{if("start"!==O.blocks.blockList[e[0]].name)return[e[0],1];var s=O.blocks.blockList[e[0]].value,a=O.turtles.ithTurtle(s);console.debug("run start "+s),t.initTurtle(s),a.queue=[],a.parentFlowQueue=[],a.unhighlightQueue=[],a.parameterQueue=[],a.running=!0,t.runFromBlock(t,s,e[0],0,l)}}}}]),o}(),f=function(){_inherits(o,FlowBlock);var t=_createSuper(o);function o(){var e;return _classCallCheck(this,o),(e=t.call(this,"dockblock")).setPalette("program",O),e.setHelpString([_("The Dock block block connections two blocks."),"documentation",""]),e.formBlock({name:_("connect blocks"),args:3,argLabels:[_("target block"),_("connection number"),_("block number")]}),e}return _createClass(o,[{key:"flow",value:function(e,t,o,r){if(e.length<3)return console.debug(e.length+" < 3"),void O.errorMsg(NOINPUTERRORMSG,r);if(e[0]<0||e[0]>O.blocks.blockList.length-1)return console.debug(e[0]+" > "+O.blocks.blockList.length-1),void O.errorMsg(NOINPUTERRORMSG,r);if(e[0]===e[2])return console.debug(e[0]+" == "+e[2]),void O.errorMsg(NOINPUTERRORMSG,r);if(e[2]<0||e[2]>O.blocks.blockList.length-1)return console.debug(e[2]+" > "+O.blocks.blockList.length-1),void O.errorMsg(NOINPUTERRORMSG,r);if(-1===e[1])e[1]=O.blocks.blockList[e[0]].connections.length-1;else if(e[1]<1||e[1]>O.blocks.blockList[e[0]].connections.length-1)return console.debug(e[1]+" out of bounds"),void O.errorMsg(NOINPUTERRORMSG,r);var l=O.blocks.blockList[e[0]].connections[e[1]];if(null!==l)if("hidden"===O.blocks.blockList[l].name)e[0]=l,e[1]=1;else{for(var n=0;n<O.blocks.blockList[l].connections.length;n++)if(O.blocks.blockList[l].connections[n]===e[0])return void(O.blocks.blockList[l].connections[n]=null);O.blocks.blockList[e[0]].connections[e][1]=null}O.blocks.blockList[e[0]].connections[e[1]]=e[2],O.blocks.blockList[e[2]].connections[0]=e[0],O.blocks.adjustDocks(e[0],!0)}}]),o}(),k=function(){_inherits(o,LeftBlock);var t=_createSuper(o);function o(){var e;return _classCallCheck(this,o),(e=t.call(this,"makeblock")).setPalette("program",O),e.setHelpString([_("The Make block block creates a new block."),"documentation","","makehelp"]),e.formBlock({name:_("make block"),args:1,argTypes:["anyin"],outType:"numberout",flows:{type:"arg",types:["anyin"],labels:[""]},defaults:[_("note")]}),e}return _createClass(o,[{key:"arg",value:function(e,t,o,r){O.blocks.showBlocks();var l=[null];if(0<O.blocks.blockList[o].argClampSlots.length)for(var n=0;n<O.blocks.blockList[o].argClampSlots.length;n++){var s=e.parseArg(e,t,O.blocks.blockList[o].connections[n+2],o,r);l.push(s)}var a,c,i,u=O.blocks.blockList[o].connections[1],p=e.parseArg(e,t,u,o,r),f=O.blocks.blockList.length,k=O.turtles.ithTurtle(t),b=O.turtles.turtleX2screenX(k.x),h=O.turtles.turtleY2screenY(k.y);if(k.doWait(1),p===_("note")){switch(l.length){case 1:a="sol",i=c=4;break;case 2:a=l[1],i=c=4;break;case 3:a=l[1],c=l[2],i=4;break;default:a=l[1],c=l[2],i=l[3]}var g=[[0,"newnote",b,h,[null,1,4,8]],[1,"divide",0,0,[0,2,3]],[2,["number",{value:1}],0,0,[1]],[3,["number",{value:i}],0,0,[1]],[4,"vspace",0,0,[0,5]],[5,"pitch",0,0,[4,6,7,null]],[6,["solfege",{value:a}],0,0,[5]],[7,["number",{value:c}],0,0,[5]],[8,"hidden",0,0,[0,null]]];return O.blocks.loadNewBlocks(g),console.debug("BLOCKNUMBER "+f),f}if(p===_("start")){var d=[[0,"start",b,h,[null,null,null]]];return O.blocks.loadNewBlocks(d),console.debug("BLOCKNUMBER "+f),f}if(p===_("silence")){var y=[[0,"rest2",b,h,[null,null]]];return O.blocks.loadNewBlocks(y),console.debug("BLOCKNUMBER "+f),f}var v=O.blocks.palettes.getProtoNameAndPalette(p),m=v[0],w=v[2];if(null===m)return O.errorMsg(_("Cannot find block")+" "+p),console.debug("Cannot find block "+p),0;for(var T=[[0,w,b,h,[null]]],S=1;S<O.blocks.protoBlockDict[m].dockTypes.length;S++)S<l.length?("number"==typeof l[S]?(["anyin","numberin"].includes(O.blocks.protoBlockDict[m].dockTypes[S])||O.errorMsg(_("Warning: block argument type mismatch")),T.push([S,["number",{value:l[S]}],0,0,[0]])):"string"==typeof l[S]?(["anyin","textin"].includes(O.blocks.protoBlockDict[m].dockTypes[S])||O.errorMsg(_("Warning: block argument type mismatch")),T.push([S,["string",{value:l[S]}],0,0,[0]])):T[0][4].push(null),T[0][4].push(S)):T[0][4].push(null);return O.blocks.loadNewBlocks(T),console.debug("BLOCKNUMBER "+f),f}}]),o}(),b=function(){_inherits(o,FlowBlock);var t=_createSuper(o);function o(){var e;return _classCallCheck(this,o),(e=t.call(this,"openProject")).setPalette("program",O),e.setHelpString([_("The Open project block is used to open a project from a web page."),"documentation",""]),e.formBlock({name:_("open project"),args:1,argTypes:["textin"],defaults:["url"]}),e}return _createClass(o,[{key:"flow",value:function(e,t,o,r){var l,n,s;null!==e[0]?(l=e[0],s=l,new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.) {3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i").test(s)?(n=window.open(l,"_blank"))?n.focus():alert("Please allow popups for this site"):O.errorMsg(_("Please enter a valid URL."))):O.errorMsg(NOINPUTERRORMSG,r)}}]),o}();(new i).setup(O),(new u).setup(O),(new p).setup(O),(new f).setup(O),(new k).setup(O),(new b).setup(O),(new c).setup(O),(new e).setup(O),(new t).setup(O),(new a).setup(O),(new l).setup(O),(new n).setup(O),(new s).setup(O),(new o).setup(O),(new r).setup(O)}