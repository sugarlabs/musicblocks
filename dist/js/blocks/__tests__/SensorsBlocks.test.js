"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ownKeys(t,e){var r,o=Object.keys(t);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(t),e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),o.push.apply(o,r)),o}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(r),!0).forEach(function(e){_defineProperty(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function _defineProperty(e,t,r){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(r){var o=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(r);return _possibleConstructorReturn(this,o?(e=_getPrototypeOf(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function _possibleConstructorReturn(e,t){if(t&&("object"==_typeof(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(_isNativeReflectConstruct=function(){return!!e})()}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,_toPropertyKey(o.key),o)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);var o=r.call(e,t||"default");if("object"!=_typeof(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}var _require=require("../SensorsBlocks"),setupSensorsBlocks=_require.setupSensorsBlocks,DummyFlowBlock=function(){function r(e,t){_classCallCheck(this,r),this.name=e,this.displayName=t,r.createdBlocks[e]=this}return _createClass(r,[{key:"setPalette",value:function(e){return this.palette=e,this}},{key:"beginnerBlock",value:function(e){return this.isBeginner=e,this}},{key:"setHelpString",value:function(e){return this.help=e,this}},{key:"formBlock",value:function(e){return this.blockParams=e,this}},{key:"makeMacro",value:function(e){return this.macro=e,this}},{key:"setup",value:function(){return this}}]),r}();DummyFlowBlock.createdBlocks={};var DummyValueBlock=function(){_inherits(t,DummyFlowBlock);var e=_createSuper(t);function t(){return _classCallCheck(this,t),e.apply(this,arguments)}return t}(),DummyLeftBlock=function(){_inherits(t,DummyFlowBlock);var e=_createSuper(t);function t(){return _classCallCheck(this,t),e.apply(this,arguments)}return t}(),DummyBooleanSensorBlock=function(){_inherits(t,DummyValueBlock);var e=_createSuper(t);function t(){return _classCallCheck(this,t),e.apply(this,arguments)}return t}();global.FlowBlock=DummyFlowBlock,global.ValueBlock=DummyValueBlock,global.LeftBlock=DummyLeftBlock,global.BooleanSensorBlock=DummyBooleanSensorBlock;var documentElements={labelDiv:{innerHTML:"",classList:{add:jest.fn(),remove:jest.fn()},style:{},addEventListener:jest.fn()},textLabel:{value:"",placeholder:"",style:{},focus:jest.fn(),blur:jest.fn(),addEventListener:jest.fn()},overlayCanvas:{getContext:jest.fn(function(){return{getImageData:jest.fn(function(e,t,r,o){return{data:[100,150,200,255]}})}})}};function dummyStageX(){return 123}function dummyStageY(){return 456}function dummyStageMouseDown(){return!0}function dummyCurrentKeyCode(){return 65}function dummyClearCurrentKeyCode(){}global.docById=function(e){return documentElements[e]||null},global.toFixed2=function(e){return Number(e).toFixed(2)},global.hex2rgb=function(e){return"rgb(100,150,200)"},global.searchColors=function(e,t,r){return"rgb(".concat(e,",").concat(t,",").concat(r,")")},global.Tone={Analyser:function(){function t(e){_classCallCheck(this,t),this.type=e.type,this.size=e.size,this.smoothing=e.smoothing,this.sampleTime=.01}return _createClass(t,[{key:"getValue",value:function(){return Array(this.size).fill(-100).map(function(e,t){return e+t})}}]),t}()},global.platformColor={background:"rgb(200,200,200)"};var dummyTurtle={id:"t1",container:{x:50,y:100,visible:global._THIS_IS_MUSIC_BLOCKS_=!0},painter:{canvasColor:"rgb(255,0,0)"},doWait:jest.fn()},createDummyTurtle=function(){return _objectSpread({},dummyTurtle)};describe("setupSensorsBlocks",function(){var u,r,o;beforeEach(function(){DummyFlowBlock.createdBlocks={},global.NOINPUTERRORMSG="No input provided",global.NANERRORMSG="Not a number",global._=jest.fn(function(e){return e}),(u={errorMsg:jest.fn(),blocks:{blockList:{}},getStageX:dummyStageX,getStageY:dummyStageY,getStageMouseDown:dummyStageMouseDown,getCurrentKeyCode:dummyCurrentKeyCode,clearCurrentKeyCode:dummyClearCurrentKeyCode,refreshCanvas:jest.fn()}).turtles={turtleObjs:{},getTurtle:function(e){return this.turtleObjs[e]||(this.turtleObjs[e]=createDummyTurtle()),this.turtleObjs[e]},ithTurtle:function(e){return this.getTurtle(e)}},r={inStatusMatrix:!1,statusFields:[],inputValues:{},lastKeyCode:null,clearTurtleRun:jest.fn(),setDispatchBlock:jest.fn(),setTurtleListener:jest.fn()},o=0,setupSensorsBlocks(u)}),describe("GetColorPixelBlock",function(){var r,o,n,e;beforeEach(function(){r=DummyFlowBlock.createdBlocks.getcolorpixel,o={inStatusMatrix:!1,statusFields:[],inputValues:{},lastKeyCode:null,clearTurtleRun:jest.fn(),setDispatchBlock:jest.fn(),setTurtleListener:jest.fn()},n=0,e=global.docById,global.docById=jest.fn(function(e){return documentElements[e]||null}),u.turtles.getTurtle=jest.fn(function(e){var t=createDummyTurtle();if(999===e)throw new Error("Turtle ".concat(e," not found"));return t})}),afterEach(function(){global.docById=e}),describe("arg",function(){it("should return a color value for a pixel",function(){var e=r.arg(o,n);expect(e).toBe("rgb(100,150,200)")}),it("should return fallback color if turtle is not found",function(){var e=r.arg(o,999);expect(e).toBe("rgb(128,128,128)")}),it("should return fallback color if turtle container is missing",function(){u.turtles.getTurtle=jest.fn(function(){return{}});var e=r.arg(o,n);expect(e).toBe("rgb(128,128,128)")}),it("should handle canvas errors and return fallback color",function(){global.docById=jest.fn(function(){return null});var e=r.arg(o,n);expect(e).toBe("rgb(128,128,128)")}),it("should restore turtle visibility after successful execution",function(){var e=createDummyTurtle();u.turtles.getTurtle=jest.fn(function(){return e}),r.arg(o,n),expect(e.container.visible).toBe(!0)}),it("should not attempt to restore visibility if turtle is not found",function(){var e=r.arg(o,999);expect(e).toBe("rgb(128,128,128)")}),it("should not attempt to restore visibility if container is missing",function(){var e={container:null};u.turtles.getTurtle=jest.fn(function(){return e});var t=r.arg(o,n);expect(t).toBe("rgb(128,128,128)")})}),describe("getPixelData",function(){it("should return pixel data from the canvas",function(){var e=r.getPixelData(50,100);expect(e).toEqual([100,150,200,255])}),it("should throw an error if canvas context is unavailable",function(){global.docById=jest.fn(function(){return null}),expect(function(){return r.getPixelData(50,100)}).toThrow("Canvas context unavailable")})}),describe("detectColor",function(){it("should return color index for opaque pixel",function(){var e=r.detectColor([100,150,200,255]);expect(e).toBe("rgb(100,150,200)")}),it("should return background color for transparent pixel",function(){var e=r.detectColor([100,150,200,0]);expect(e).toBe("rgb(200,200,200)")}),it("should throw an error for invalid pixel data",function(){var e=[100,150];expect(function(){return r.detectColor(e)}).toThrow("Invalid pixel data")})}),describe("getBackgroundColor",function(){it("should parse and return background color",function(){var e=r.getBackgroundColor();expect(e).toBe("rgb(200,200,200)")})}),describe("getFallbackColor",function(){it("should return a default gray color",function(){var e=r.getFallbackColor();expect(e).toBe("rgb(128,128,128)")})})}),describe("InputBlock",function(){it("should set up the input form and wait for input",function(){var e=DummyFlowBlock.createdBlocks.input;u.turtles.ithTurtle(o).doWait=jest.fn(),u.blocks.blockList.blkInput={connections:[null,"cblk1"]},u.blocks.blockList.cblk1={value:"Enter text"},e.flow([],r,o,"blkInput");var t=docById("labelDiv");expect(t.innerHTML).toContain('input id="textLabel"'),expect(u.turtles.ithTurtle(o).doWait).toHaveBeenCalledWith(120)})}),describe("InputValueBlock",function(){it("should return input value if present",function(){r.inputValues[o]=42;var e=DummyFlowBlock.createdBlocks.inputvalue;expect(e.updateParameter(r,o)).toEqual(42),expect(e.arg(r,o,"blkIV")).toEqual(42)}),it("should call errorMsg and return 0 if no input value",function(){var e=DummyFlowBlock.createdBlocks.inputvalue.arg(r,o,"blkIV");expect(u.errorMsg).toHaveBeenCalledWith("No input provided","blkIV"),expect(e).toEqual(0)})}),describe("PitchnessBlock",function(){it("should return a frequency based on pitch analyser",function(){r.mic={connect:jest.fn()},r.pitchAnalyser=null,r.limit=16;var e=DummyFlowBlock.createdBlocks.pitchness.arg(r);expect(_typeof(e)).toEqual("number")})}),describe("LoudnessBlock",function(){it("should return computed loudness",function(){r.mic={connect:jest.fn()},r.volumeAnalyser=null,r.limit=16;var e=DummyFlowBlock.createdBlocks.loudness.arg(r);expect(_typeof(e)).toEqual("number")})}),describe("MyClickBlock",function(){it("should return a click event string with turtle id",function(){u.turtles.getTurtle=jest.fn(function(){return{id:"T123"}});var e=DummyFlowBlock.createdBlocks.myclick.arg(r,o);expect(e).toEqual("clickT123")})}),describe("MouseYBlock",function(){it("should return stage Y position",function(){var e=DummyFlowBlock.createdBlocks.mousey.arg(r,o,"blkMY");expect(e).toEqual(dummyStageY())})}),describe("ToASCIIBlock",function(){it("should convert a number to a character",function(){u.blocks.blockList.blkASCII={connections:[null,"cblkASCII"]},u.blocks.blockList.cblkASCII={},r.parseArg=jest.fn(function(){return 65});var e=DummyFlowBlock.createdBlocks.toascii.arg(r,o,"blkASCII",65);expect(e).toEqual("A")}),it("should call errorMsg and return 0 for non-number input",function(){u.blocks.blockList.blkASCII2={connections:[null,"cblkASCII2"]},u.blocks.blockList.cblkASCII2={},r.parseArg=jest.fn(function(){return"NaN"});var e=DummyFlowBlock.createdBlocks.toascii.arg(r,o,"blkASCII2","NaN");expect(u.errorMsg).toHaveBeenCalledWith("Not a number","blkASCII2"),expect(e).toEqual(0)})}),describe("KeyboardBlock",function(){it("should return the last key code and clear it",function(){r.lastKeyCode=66,u.getCurrentKeyCode=jest.fn(function(){return 66}),u.clearCurrentKeyCode=jest.fn();var e=DummyFlowBlock.createdBlocks.keyboard.arg(r);expect(e).toEqual(66),expect(u.clearCurrentKeyCode).toHaveBeenCalled()})}),describe("TimeBlock",function(){it("should return elapsed time in seconds",function(){r.time=(new Date).getTime()-5e3;var e=DummyFlowBlock.createdBlocks.time.arg(r);expect(e).toBeGreaterThanOrEqual(4.9),expect(e).toBeLessThanOrEqual(5.1)})}),describe("MouseXBlock",function(){it("should return stage X position",function(){var e=DummyFlowBlock.createdBlocks.mousex.arg(r,o,"blkMX");expect(e).toEqual(dummyStageX())})}),describe("MouseButtonBlock",function(){it("should return stage mouse down state",function(){var e=DummyFlowBlock.createdBlocks.mousebutton.arg(r);expect(e).toEqual(dummyStageMouseDown())})})});