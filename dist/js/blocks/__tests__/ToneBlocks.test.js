"use strict";function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(o){var n=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(o);return _possibleConstructorReturn(this,n?(e=_getPrototypeOf(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function _possibleConstructorReturn(e,t){if(t&&("object"==_typeof(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(_isNativeReflectConstruct=function(){return!!e})()}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var o=e[Symbol.toPrimitive];if(void 0===o)return("string"===t?String:Number)(e);var n=o.call(e,t||"default");if("object"!=_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}global._=function(e){return e},global.NOINPUTERRORMSG="No input error",global.DEFAULTOSCILLATORTYPE="defaultOsc",global.OSCTYPES={triangle:["triangle","triangle"],sine:["sine","sine"]},global.DEFAULTVOICE="defaultVoice";var DummyFlowBlock=function(){function o(e,t){_classCallCheck(this,o),this.type=e,this.label=t}return _createClass(o,[{key:"setPalette",value:function(e,t){this.palette=e,this.activity=t}},{key:"setHelpString",value:function(e){this.help=e}},{key:"formBlock",value:function(e){this.form=e}},{key:"setup",value:function(e){e.blockInstances||(e.blockInstances={}),e.blockInstances[this.type]=this,e.blockTypes||(e.blockTypes=[]),e.blockTypes.push(this.type)}},{key:"beginnerBlock",value:function(e){this.beginner=e}},{key:"makeMacro",value:function(e){this.macro=e}}]),o}(),DummyValueBlock=function(){_inherits(n,DummyFlowBlock);var o=_createSuper(n);function n(e,t){return _classCallCheck(this,n),o.call(this,e,t)}return n}(),DummyFlowClampBlock=function(){_inherits(o,DummyFlowBlock);var t=_createSuper(o);function o(e){return _classCallCheck(this,o),t.call(this,e,e)}return o}(),DummyLeftBlock=function(){_inherits(n,DummyFlowBlock);var o=_createSuper(n);function n(e,t){return _classCallCheck(this,n),o.call(this,e,t)}return n}();global.FlowBlock=DummyFlowBlock,global.ValueBlock=DummyValueBlock,global.FlowClampBlock=DummyFlowClampBlock,global.LeftBlock=DummyLeftBlock,global.last=function(e){return e&&e.length?e[e.length-1]:void 0},global.Singer={ToneActions:{defDuoSynth:jest.fn(),defAMSynth:jest.fn(),defFMSynth:jest.fn(),doHarmonic:jest.fn(),doDistortion:jest.fn(),doTremolo:jest.fn(),doPhaser:jest.fn(),doChorus:jest.fn(),doVibrato:jest.fn(),setTimbre:jest.fn()}},global.instrumentsEffects={},global.VOICENAMES={violin:["violin","violin"],piano:["piano","piano"]},global.DRUMNAMES={drum:["drum","drum"]};var createMockActivity=function(){var t={};return{blockTypes:[],blockInstances:{},turtles:{ithTurtle:jest.fn(function(e){return t[e]||(t[e]={singer:{inHarmonic:[],partials:[],distortionAmount:[],tremoloFrequency:[],tremoloDepth:[],rate:[],octaves:[],baseFrequency:[],chorusRate:[],delayTime:[],chorusDepth:[],instrumentNames:[],voices:[]}}),t[e]})},blocks:{blockList:{},updateBlockText:jest.fn()},errorMsg:jest.fn()}},createMockLogo=function(e){var t=0<arguments.length&&void 0!==e?e:{};return{inTimbre:void 0===t.inTimbre||t.inTimbre,inRhythmRuler:t.inRhythmRuler||!1,inSample:t.inSample||!1,timbre:{osc:[],oscParams:[],distortionEffect:[],distortionParams:[],tremoloEffect:[],tremoloParams:[],phaserEffect:[],phaserParams:[],chorusEffect:[],chorusParams:[],instrumentName:"testInstrument",synthVals:void 0},synth:{createSynth:jest.fn()},setDispatchBlock:jest.fn(),setTurtleListener:jest.fn(),statusFields:[],sample:{},stopTurtle:!1}},_require=require("../ToneBlocks"),setupToneBlocks=_require.setupToneBlocks;describe("setupToneBlocks",function(){var n,i;beforeEach(function(){n=createMockActivity(),i=createMockLogo(),global.instrumentsEffects[0]={},global.instrumentsEffects[0][i.timbre.instrumentName]={},setupToneBlocks(n)});function r(e){return n.blockInstances[e]}describe("OscillatorBlock",function(){it("should create synth if no oscillator exists",function(){var e=r("oscillator");i.timbre.osc=[];e.flow(["triangle",6],i,0,"oscBlk"),expect(i.synth.createSynth).toHaveBeenCalledWith(0,i.timbre.instrumentName,"triangle",i.timbre.synthVals),expect(i.timbre.osc).toContain("oscBlk"),expect(i.timbre.oscParams).toEqual(["triangle",6])}),it("should not create synth if oscillator exists and show error",function(){i.timbre.osc=["existingOsc"];r("oscillator").flow(["sine",8],i,0,"oscBlk2"),expect(n.errorMsg).toHaveBeenCalledWith("You are adding multiple oscillator blocks."),expect(i.timbre.osc).toContain("existingOsc")})}),describe("FillerTypeBlock and OscillatorTypeBlock",function(){it("should setup filler type block (value block)",function(){var e=r("filtertype");expect(n.blockTypes).toContain("filtertype"),expect(e.form).toEqual({outType:"textout"})}),it("should setup oscillator type block (value block)",function(){var e=r("oscillatortype");expect(n.blockTypes).toContain("oscillatortype"),expect(e.form).toEqual({outType:"textout"})})}),describe("DuoSynthBlock",function(){it("should call defDuoSynth with proper arguments",function(){r("duosynth").flow([10,5],i,0,"duoBlk"),expect(Singer.ToneActions.defDuoSynth).toHaveBeenCalledWith(10,5,0,"duoBlk")})}),describe("AMSynth",function(){it("should call defAMSynth with proper argument",function(){r("amsynth").flow([1],i,0,"amBlk"),expect(Singer.ToneActions.defAMSynth).toHaveBeenCalledWith(1,0,"amBlk")})}),describe("FMSynth",function(){it("should call defFMSynth with proper argument",function(){r("fmsynth").flow([10],i,0,"fmBlk"),expect(Singer.ToneActions.defFMSynth).toHaveBeenCalledWith(10,0,"fmBlk")})}),describe("PartialBlock",function(){it("should error and stop turtle if weight is out of range",function(){r("partial").flow([1.5],i,0,"partialBlk"),expect(n.errorMsg).toHaveBeenCalledWith("Partial weight must be between 0 and 1."),expect(i.stopTurtle).toBe(!0)}),it("should update partial in harmonic when inHarmonic is non-empty",function(){var e=r("partial"),t=n.turtles.ithTurtle(0);t.singer.inHarmonic.push("dummyHarmonic"),t.singer.partials.push([]),e.flow([.5],i,0,"partialBlk2"),expect(t.singer.partials[t.singer.partials.length-1]).toContain(.5)}),it("should error if no harmonic context exists",function(){var e=r("partial"),t=n.turtles.ithTurtle(0);expect(t.singer.inHarmonic.length).toBe(0),e.flow([.3],i,0,"partialBlk3"),expect(n.errorMsg).toHaveBeenCalledWith("Partial block should be used inside of a Weighted-partials block.")})}),describe("HarmonicBlock",function(){it("should push block onto harmonic stack and set listener",function(){var e=r("harmonic").flow([42],i,0,"harmonicBlk"),t=n.turtles.ithTurtle(0);expect(t.singer.inHarmonic).toContain("harmonicBlk"),expect(t.singer.partials).toContainEqual([]),expect(i.setDispatchBlock).toHaveBeenCalledWith("harmonicBlk",0,expect.stringContaining("_harmonic_")),expect(e).toEqual([42,1])})}),describe("Harmonic2Block",function(){it("should call doHarmonic and return proper flow",function(){var e=r("harmonic2").flow([7,1],i,0,"harmonic2Blk");expect(Singer.ToneActions.doHarmonic).toHaveBeenCalledWith(7,0,"harmonic2Blk"),expect(e).toEqual([1,1])})}),describe("DisBlock",function(){it("should call doDistortion and update distortion effect if in timbre",function(){var e=r("dis");n.turtles.ithTurtle(0).singer.distortionAmount=[.5],i.inTimbre=!0;var t=e.flow([40,1],i,0,"disBlk");expect(Singer.ToneActions.doDistortion).toHaveBeenCalledWith(40,0,"disBlk"),expect(global.instrumentsEffects[0][i.timbre.instrumentName].distortionActive).toBe(!0),expect(i.timbre.distortionEffect).toContain("disBlk"),expect(i.timbre.distortionParams).toContain(50),expect(global.instrumentsEffects[0][i.timbre.instrumentName].distortionAmount).toEqual(40),expect(t).toEqual([1,1])})}),describe("TremoloBlock",function(){it("should call doTremolo and update tremolo effect if in timbre",function(){var e=r("tremolo"),t=n.turtles.ithTurtle(0);t.singer.tremoloFrequency=[5],t.singer.tremoloDepth=[.7],i.inTimbre=!0;var o=e.flow([10,50,99],i,0,"tremoloBlk");expect(Singer.ToneActions.doTremolo).toHaveBeenCalledWith(10,50,0,"tremoloBlk"),expect(global.instrumentsEffects[0][i.timbre.instrumentName].tremoloActive).toBe(!0),expect(i.timbre.tremoloEffect).toContain("tremoloBlk"),expect(i.timbre.tremoloParams).toContain(5),expect(i.timbre.tremoloParams).toContain(70),expect(global.instrumentsEffects[0][i.timbre.instrumentName].tremoloFrequency).toEqual(10),expect(global.instrumentsEffects[0][i.timbre.instrumentName].tremoloDepth).toEqual(50),expect(o).toEqual([99,1])})}),describe("PhaserBlock",function(){it("should call doPhaser and update phaser effect if in timbre",function(){var e=r("phaser"),t=n.turtles.ithTurtle(0);t.singer.rate=[.5],t.singer.octaves=[3],t.singer.baseFrequency=[392],i.inTimbre=!0;var o=e.flow([.5,3,392,88],i,0,"phaserBlk");expect(Singer.ToneActions.doPhaser).toHaveBeenCalledWith(.5,3,392,0,"phaserBlk"),expect(global.instrumentsEffects[0][i.timbre.instrumentName].phaserActive).toBe(!0),expect(i.timbre.phaserEffect).toContain("phaserBlk"),expect(i.timbre.phaserParams).toContain(.5),expect(i.timbre.phaserParams).toContain(3),expect(i.timbre.phaserParams).toContain(392),expect(o).toEqual([88,1])})}),describe("ChorusBlock",function(){it("should call doChorus and update chorus effect if in timbre",function(){var e=r("chorus"),t=n.turtles.ithTurtle(0);t.singer.chorusRate=[1.5],t.singer.delayTime=[3.5],t.singer.chorusDepth=[.7],i.inTimbre=!0;var o=e.flow([1.5,3.5,70,77],i,0,"chorusBlk");expect(Singer.ToneActions.doChorus).toHaveBeenCalledWith(1.5,3.5,70,0,"chorusBlk"),expect(global.instrumentsEffects[0][i.timbre.instrumentName].chorusActive).toBe(!0),expect(i.timbre.chorusEffect).toContain("chorusBlk"),expect(i.timbre.chorusParams).toContain(1.5),expect(i.timbre.chorusParams).toContain(3.5),expect(i.timbre.chorusParams).toContain(70),expect(o).toEqual([77,1])})}),describe("VibratoBlock",function(){it("should call doVibrato and return correct flow",function(){var e=r("vibrato").flow([5,1/16,33],i,0,"vibratoBlk");expect(Singer.ToneActions.doVibrato).toHaveBeenCalledWith(5,1/16,0,"vibratoBlk"),expect(e).toEqual([33,1])})}),describe("SetVoiceBlock",function(){it("should push valid voice into turtle's voices and set listener",function(){var e=r("setvoice"),t=n.turtles.ithTurtle(0);e.flow(["violin",44],i,0,"setVoiceBlk"),expect(t.singer.voices).toContain("violin"),expect(i.setDispatchBlock).toHaveBeenCalledWith("setVoiceBlk",0,expect.stringMatching("_setvoice_"))}),it("should error if provided voice is not found",function(){r("setvoice").flow(["nonexistent",55],i,0,"setVoiceBlk2"),expect(n.errorMsg).toHaveBeenCalledWith("No input error","setVoiceBlk2")})}),describe("SynthNameBlock",function(){it("should push status field if inStatusMatrix and connection is print",function(){n.blocks.blockList.blkPrint={name:"print"},n.blocks.blockList.synthNameBlk={connections:["blkPrint"]};var e=r("synthname");i.inStatusMatrix=!0,e.arg(i,0,"synthNameBlk"),expect(i.statusFields).toContainEqual(["synthNameBlk","synthname"])}),it("should return last instrument name otherwise",function(){var e=r("synthname");n.turtles.ithTurtle(0).singer.instrumentNames=["first","second"];var t=e.arg(i,0,"synthNameBlk2");expect(t).toEqual("second")})}),describe("SetDefaultVoiceBlock",function(){it("should error if argument is null",function(){r("setdefaultinstrument").flow([null],i,0,"setDefVoiceBlk"),expect(n.errorMsg).toHaveBeenCalledWith("No input error","setDefVoiceBlk")}),it("should update default instrument name",function(){var e=r("setdefaultinstrument"),t=n.turtles.ithTurtle(0);t.singer.instrumentNames=[],e.flow(["piano"],i,0,"setDefVoiceBlk2"),expect(t.singer.instrumentNames[0]).toEqual("piano")})}),describe("VoiceNameBlock",function(){it("should be a value block with extra width",function(){var e=r("voicename");e.setup(n),expect(e.extraWidth).toEqual(50)})}),describe("SetTimbreBlock",function(){it("should error if argument is null",function(){r("settimbre").flow([null,66],i,0,"setTimbreBlk"),expect(n.errorMsg).toHaveBeenCalledWith("No input error","setTimbreBlk")}),it("should set timbre when inRhythmRuler is false and inSample is false",function(){r("settimbre").flow(["customTimbre",77],i,0,"setTimbreBlk2"),expect(Singer.ToneActions.setTimbre).toHaveBeenCalledWith("customTimbre",0,"setTimbreBlk2")}),it("should update sample properties if inSample is true",function(){i.inSample=!0,r("settimbre").flow([["sampleName","sampleData","la",5],88],i,0,"setTimbreBlk3"),expect(i.sample.sampleName).toEqual("sampleName"),expect(i.sample.sampleData).toEqual("sampleData"),expect(i.sample.samplePitch).toEqual("la"),expect(i.sample.sampleOctave).toEqual(5)})}),describe("CustomSampleBlock",function(){it("should update parameter correctly",function(){var e=r("customsample");n.blocks.blockList.csBlk={value:"initial"};var t=e.updateParameter(i,0,"csBlk");expect(t).toEqual("initial")}),it("should update its value based on connected blocks",function(){n.blocks.blockList.csBlk2={value:["","","do",4],connections:{1:"nameBlk",2:"solfegeBlk",3:"numBlk"}},n.blocks.blockList.nameBlk={value:["newName","newData"]},n.blocks.blockList.solfegeBlk={value:"re"},n.blocks.blockList.numBlk={value:7};var e=r("customsample").arg(i,0,"csBlk2");expect(e).toEqual(["newName","newData","re",7])})}),describe("AudioFileBlock",function(){it("should update parameter by calling updateBlockText",function(){n.blocks.blockList.afBlk={value:"audioValue"};var e=r("audiofile").updateParameter(i,0,"afBlk");expect(n.blocks.updateBlockText).toHaveBeenCalledWith("afBlk"),expect(e).toEqual("audioValue")})})});