"use strict";function _readOnlyError(t){throw new TypeError('"'+t+'" is read-only')}function asyncGeneratorStep(t,e,i,r,n,o,s){try{var l=t[o](s),a=l.value}catch(t){return void i(t)}l.done?e(a):Promise.resolve(a).then(r,n)}function _asyncToGenerator(l){return function(){var t=this,s=arguments;return new Promise(function(e,i){var r=l.apply(t,s);function n(t){asyncGeneratorStep(r,e,i,n,o,"next",t)}function o(t){asyncGeneratorStep(r,e,i,n,o,"throw",t)}n(void 0)})}}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var r,n,o,s,l=[],a=!0,u=!1;try{if(o=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;a=!1}else for(;!(a=(r=o.call(i)).done)&&(l.push(r.value),l.length!==e);a=!0);}catch(t){u=!0,n=t}finally{try{if(!a&&null!=i.return&&(s=i.return(),Object(s)!==s))return}finally{if(u)throw n}}return l}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _createForOfIteratorHelper(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var r=0,n=function(){};return{s:n,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,l=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return s=t.done,t},e:function(t){l=!0,o=t},f:function(){try{s||null==i.return||i.return()}finally{if(l)throw o}}}}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,r=Array(e);i<e;i++)r[i]=t[i];return r}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,_toPropertyKey(r.key),r)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(t,e){if("object"!=_typeof(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0===i)return("string"===e?String:Number)(t);var r=i.call(t,e||"default");if("object"!=_typeof(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var DEFAULTVOLUME=50,PREVIEWVOLUME=80,DEFAULTDELAY=500,OSCVOLUMEADJUSTMENT=1.5,TONEBPM=240,TARGETBPM=90,TURTLESTEP=-1,NOTEDIV=8,NOMICERRORMSG="The microphone is not available.",NANERRORMSG="Not a number.",NOSTRINGERRORMSG="Not a string.",NOBOXERRORMSG="Cannot find box",NOACTIONERRORMSG="Cannot find action.",NOINPUTERRORMSG="Missing argument.",NOSQRTERRORMSG="Cannot take square root of negative number.",ZERODIVIDEERRORMSG="Cannot divide by zero.",EMPTYHEAPERRORMSG="empty heap.",POSNUMBER="Argument must be a positive number",INVALIDPITCH=_("Not a valid pitch name"),NOTATIONNOTE=0,NOTATIONDURATION=1,NOTATIONDOTCOUNT=2,NOTATIONTUPLETVALUE=3,NOTATIONROUNDDOWN=4,NOTATIONINSIDECHORD=5,NOTATIONSTACCATO=6,Queue=function t(e,i,r,n){_classCallCheck(this,t),this.blk=e,this.count=i,this.parentBlk=r,this.args=n},Logo=function(){function Logo(t){_classCallCheck(this,Logo),this.activity=t,this.blockList=this.activity.blocks.blockList,this._onStopTurtle=this.activity.onStopTurtle,this._onRunTurtle=this.activity.onRunTurtle,this._meSpeak=this.activity.meSpeak,this.reflection=null,this.phraseMaker=null,this.legoWidget=null,this.pitchDrumMatrix=null,this.arpeggio=null,this.rhythmRuler=null,this.timbre=null,this.pitchStaircase=null,this.temperament=null,this.tempo=null,this.pitchSlider=null,this.musicKeyboard=null,this.modeWidget=null,this.Oscilloscope=null,this.oscilloscopeTurtles=[],this.meterWidget=null,this.statusMatrix=null,this.legobricks=null,this.evalFlowDict={},this.evalArgDict={},this.evalParameterDict={},this.evalSetterDict={},this.evalOnStartList={},this.evalOnStopList={},this.pluginVars={},this.pluginReturnValue=null,this.eventList={},this.receivedArg=null,this.inputValues={},this.boxes={},this.actions={},this.returns={},this.turtleHeaps={},this.turtleDicts={},this.switchCases={},this.switchBlocks={},this._lastNoteTimeout=null,this._alreadyRunning=!1,this._prematureRestart=!1,this._runningBlock=null,this._ignoringBlock=null,this._currentlyHighlightedBlock=null,this.time=0,this.firstNoteTime=null,this._turtleDelay=0,this.sounds=[],this.cameraID=null,this.stopTurtle=!1,this.lastKeyCode=null,this.showPitchDrumMatrix=!1,this.inPitchDrumMatrix=!1,this.inRhythmRuler=!1,this.rhythmRulerMeasure=null,this.inPitchStaircase=!1,this.inTempo=!1,this.inPitchSlider=!1,this.inMusicKeyboard=!1,this._currentDrumlock=null,this.inTimbre=!1,this.inArpeggio=!1,this.insideModeWidget=!1,this.insideMeterWidget=!1,this.insideTemperament=!1,this.inMatrix=!1,this.inLegoWidget=!1,this.tupletRhythms=[],this.addingNotesToTuplet=!1,this.drumBlocks=[],this.pitchBlocks=[],this.connectionStore={},this.connectionStoreLock=!1,this.tuplet=!1,this.tupletParams=[],this._notation=new Notation(this.activity),this.notationOutput="",this.notationNotes={},this.MIDIOutput="",this.guitarOutputHead="",this.guitarOutputEnd="",this.runningLilypond=!1,this.collectingStats=!1,this.runningAbc=!1,this.runningMxml=!1,this.runningMIDI=!1,this._checkingCompletionState=!1,this.recording=!1,this.temperamentSelected=[],this.customTemperamentDefined=!1,this.specialArgs=[],this.synth=new Synth,this.synth.changeInTemperament=!1,this.modeBlock=null,this._meterBlock=null,this.inStatusMatrix=!1,this.inOscilloscope=!1,this.updatingStatusMatrix=!1,this.statusFields=[],this._midiData={},this.stepQueue={},this._unhighlightStepQueue={},this.svgOutput="",this.svgBackground=!0,this.mic=null,this.volumeAnalyser=null,this.pitchAnalyser=null}var Qc;return _createClass(Logo,[{key:"_restoreConnections",value:function(){for(var t in this.connectionStore)for(var e in this.connectionStore[t])for(var i=this.connectionStore[t][e].length,r=0;r<i;r++){var n=this.connectionStore[t][e].pop();this.blockList[n[0]].connections[n[1]]=n[2],null!=n[2]&&(this.blockList[n[2]].connections[0]=n[0])}}},{key:"prepSynths",value:function(){for(var t in this.synth.newTone(),this.activity.turtles.turtleList){var e=this.activity.turtles.ithTurtle(t);for(var i in t in instruments||(instruments[t]={},instrumentsFilters[t]={},instrumentsEffects[t]={}),DEFAULTVOICE in instruments[t]||this.synth.createDefaultSynth(t),instruments[0])i in instruments[t]||(this.synth.loadSynth(t,i),i in instrumentsFilters[0]&&(instrumentsFilters[t][i]=instrumentsFilters[0][i]),i in instrumentsEffects[0]&&(instrumentsEffects[t][i]=instrumentsEffects[0][i]));e.singer.synthVolume={"electronic synth":[DEFAULTVOLUME],noise1:[DEFAULTVOLUME],noise2:[DEFAULTVOLUME],noise3:[DEFAULTVOLUME]},e.singer.synthVolume[DEFAULTVOICE]=[DEFAULTVOLUME]}for(var r in this.activity.turtles.turtleList)for(var n in this.activity.turtles.ithTurtle(r).singer.synthVolume)Singer.setSynthVolume(this,r,n,DEFAULTVOLUME)}},{key:"resetSynth",value:function(t){for(var e in DEFAULTVOICE in instruments[t]||this.synth.createDefaultSynth(t),Singer.setMasterVolume(this.activity.logo,DEFAULTVOLUME),this.activity.turtles.turtleList)for(var i in this.activity.turtles.ithTurtle(e).singer.synthVolume)Singer.setSynthVolume(this,e,i,DEFAULTVOLUME);this.synth.start()}},{key:"initMediaDevices",value:function(){var e=new Tone.UserMedia;try{e.open()}catch(t){this.activity.errorMsg(NOMICERRORMSG),e=null}this.mic=e,this.limit=16384}},{key:"clearNoteParams",value:function(t,e,i){t.singer.oscList[e]=[],t.singer.noteBeat[e]=[],t.singer.noteBeatValues[e]=[],t.singer.noteValue[e]=null,t.singer.notePitches[e]=[],t.singer.noteOctaves[e]=[],t.singer.noteCents[e]=[],t.singer.noteHertz[e]=[],t.singer.embeddedGraphics[e]=[],t.singer.noteDrums[e]=null!==i?i:[]}},{key:"processSpeak",value:function(t){var e="";for(var i in t)new RegExp("^[A-Za-z,. ]$").test(t[i])&&(e+=t[i]);null!==this.meSpeak&&this.meSpeak.speak(e)}},{key:"processShow",value:function(t,e,i,r){var n,o=this.activity.turtles.getTurtle(t);"string"==typeof r?14===(n=r.length)&&r.substr(0,14)===CAMERAVALUE?doUseCamera([i],this.activity.turtles,t,!1,this.cameraID,this.setCameraID,this.activity.errorMsg):13===n&&r.substr(0,13)===VIDEOVALUE?doUseCamera([i],this.activity.turtles,t,!0,this.cameraID,this.setCameraID,this.activity.errorMsg):10<n&&"data:image"===r.substr(0,10)?o.doShowImage(i,r):8<n&&"https://"===r.substr(0,8)||7<n&&"http://"===r.substr(0,7)||7<n&&"file://"===r.substr(0,7)?o.doShowURL(i,r):o.doShowText(i,r):"object"===_typeof(r)&&null!==e&&"loadFile"===this.blockList[this.blockList[e].connections[2]].name?r?o.doShowText(i,r[1]):this.activity.errorMsg(_("You must select a file.")):o.doShowText(i,r)}},{key:"setCameraID",value:function(t){this.cameraID=t}},{key:"setTurtleListener",value:function(t,e,i){var r=this.activity.turtles.ithTurtle(t);e in r.listeners&&this.activity.stage.removeEventListener(e,r.listeners[e],!1),r.listeners[e]=i,this.activity.stage.addEventListener(e,i,!1)}},{key:"setDispatchBlock",value:function(t,e,i){var r,n=this.activity.turtles.ithTurtle(e),o=null;null!==(o=!n.singer.inDuplicate&&0<n.singer.backward.length?(r="backward"===this.blockList[last(n.singer.backward)].name?1:2,this.activity.blocks.sameGeneration(this.blockList[last(n.singer.backward)].connections[r],t)?this.blockList[t].connections[0]:last(this.blockList[t].connections)):last(this.blockList[t].connections))&&(o in n.endOfClampSignals?n.endOfClampSignals[o].push(i):n.endOfClampSignals[o]=[i])}},{key:"parseArg",value:function parseArg(logo,turtle,blk,parentBlk,receivedArg){var tur=logo.activity.turtles.ithTurtle(turtle),cblk,a;if(null==blk)return logo.activity.errorMsg(NOINPUTERRORMSG,parentBlk),null;if(logo.blockList[blk].protoblock.parameter&&(tur.parameterQueue.includes(blk)||tur.parameterQueue.push(blk)),"function"==typeof logo.blockList[blk].protoblock.arg)return logo.blockList[blk].value=logo.blockList[blk].protoblock.arg(logo,turtle,blk,receivedArg);if("intervalname"===logo.blockList[blk].name)return"string"==typeof logo.blockList[blk].value?(tur.singer.noteDirection=getIntervalDirection(logo.blockList[blk].value),getIntervalNumber(logo.blockList[blk].value)):0;if(logo.blockList[blk].isValueBlock())return logo.blockList[blk].value;if(["anyout","numberout","textout","booleanout"].includes(logo.blockList[blk].protoblock.dockTypes[0])){switch(logo.blockList[blk].name){case"dectofrac":logo.inStatusMatrix&&"print"===logo.blockList[logo.blockList[blk].connections[0]].name?logo.statusFields.push([blk,"dectofrac"]):(cblk=logo.blockList[blk].connections[1],null===cblk?(logo.activity.errorMsg(NOINPUTERRORMSG,blk),logo.blockList[blk].value=0):(a=logo.parseArg(logo,turtle,cblk,blk,receivedArg),"number"==typeof a?logo.blockList[blk].value=a<0?"-"+mixedNumber(-a):mixedNumber(a):(logo.activity.errorMsg(NANERRORMSG,blk),logo.blockList[blk].value=0)));break;case"hue":logo.inStatusMatrix&&"print"===logo.blockList[logo.blockList[blk].connections[0]].name?logo.statusFields.push([blk,"color"]):logo.blockList[blk].value=logo.activity.turtles.getTurtle(turtle).painter.color;break;case"returnValue":0<logo.returns[turtle].length?logo.blockList[blk].value=logo.returns[turtle].pop():logo.blockList[blk].value=0;break;default:logo.blockList[blk].name in logo.evalArgDict?(console.log("running eval on "+logo.blockList[blk].name),eval(logo.evalArgDict[logo.blockList[blk].name])):console.error("I do not know how to "+logo.blockList[blk].name)}return logo.blockList[blk].value}return blk}},{key:"updateNotation",value:function(t,e,i,r,n,o){null==o&&(o=!0);var s,l=this.activity.turtles.ithTurtle(i),a=1/e,u=(l.singer.notesPlayed[0]/l.singer.notesPlayed[1]-l.singer.pickup-a)*l.singer.noteValuePerBeat%l.singer.beatsPerMeasure/l.singer.noteValuePerBeat,c=l.singer.beatsPerMeasure/l.singer.noteValuePerBeat-u;if(o&&c<a){var h=a-c,g=c,p=l.singer.beatsPerMeasure/l.singer.noteValuePerBeat,k=rationalToFraction(h);if(0<g){for(var b=0;p<g;)++b,g-=p;var d=rationalToFraction(g);for(0!==d[0]&&this.updateNotation(t,d[1]/d[0],i,r,n,!1),(0<b||0<k[0])&&("R"!==t[0]&&(this.notation.notationInsertTie(i),this.notation.notationDrumStaging[i].push("tie")),d=rationalToFraction(1/p));0<b;)--b,0!==d[0]&&this.updateNotation(t,d[1]/d[0],i,r,n,!1),0<k[0]&&"R"!==t[0]&&(this.notation.notationInsertTie(i),this.notation.notationDrumStaging[i].push("tie"))}0<k[0]&&0!==k[0]&&this.updateNotation(t,k[1]/k[0],i,r,n,!1)}else{(s=this.notation).doUpdateNotation.apply(s,arguments)}}},{key:"notationMIDI",value:function(t,e,i,r,n,o){this._midiData[r]||(this._midiData[r]=[]),e=e&&e[0],this._midiData[r].push({note:t,duration:i,bpm:n,instrument:o,drum:e})}},{key:"clearTurtleRun",value:function(t){var e=this.activity.turtles.ithTurtle(t);null!==e.delayTimeout&&(clearTimeout(e.delayTimeout),e.delayTimeout=null,this.runFromBlockNow(this,t,e.delayParameters.blk,e.delayParameters.flow,e.delayParameters.arg))}},{key:"doBreak",value:function(t){for(var e,i,r=null,n=-1,o=t.queue.length-1;-1<o;o--){if(["forever","repeat","while","until"].includes(this.blockList[t.queue[o].blk].name)){n=t.queue[o].blk,r=this.blockList[n],t.queue.pop();break}if(["forever","repeat","while","until"].includes(this.blockList[t.queue[o].parentBlk].name)){n=t.queue[o].parentBlk,r=this.blockList[n],t.queue.pop();break}}null!=r?"while"!==r.name&&"until"!==r.name||null!=(e=last(r.connections))&&(i=new Queue(e,1,n),t.parentFlowQueue.push(n),t.queue.push(i)):t.queue.pop()}},{key:"initTurtle",value:function(t){this.connectionStore[t]={},this.connectionStoreLock=!1,this.switchCases[t]={},this.switchBlocks[t]=[],this.returns[t]=[],this.notation.notationStaging[t]=[],this.notation.notationDrumStaging[t]=[],this.notation.pickupPoint[t]=null,this.notation.pickupPOW2[t]=!1,this.activity.turtles.ithTurtle(t).initTurtle(this.runningLilypond||this.runningAbc||this.runningMxml||this.runningMIDI)}},{key:"doStopTurtles",value:function(){for(var t in this.stopTurtle=!0,this.activity.turtles.markAllAsStopped(),this.sounds)this.sounds[t].stop();for(var e in this.sounds=[],this.activity.turtles.turtleList){for(var i in instruments[e])this.synth.stopSound(e,i);var r,n=this.activity.turtles.getTurtle(e).companionTurtle;n&&(this.activity.turtles.getTurtle(n).running=!1,(r=this.activity.turtles.getTurtle(n).interval)&&clearInterval(r))}this.synth.stop(),this.synth.recorder&&"recording"==this.synth.recorder.state&&this.synth.recorder.stop(),null!=this.cameraID&&doStopVideoCam(this.cameraID,this.setCameraID),this.onStopTurtle(),this.activity.blocks.bringToTop(),this.stepQueue={};var o,s=_createForOfIteratorHelper(this.activity.turtles.turtleList);try{for(s.s();!(o=s.n()).done;){o.value.unhighlightQueue=[]}}catch(t){s.e(t)}finally{s.f()}this._restoreConnections(),document.body.style.cursor="default",this.activity.showBlocksAfterRun&&(this.activity.blocks.showBlocks(),document.getElementById("stop").style.color="white"),this.activity.showBlocksAfterRun=!1}},{key:"step",value:function(){for(var t in this.stepQueue){var e;0<this.stepQueue[t].length&&(t in this._unhighlightStepQueue&&null!=this._unhighlightStepQueue[t]&&(this.activity.blocks.visible&&this.activity.blocks.unhighlight(this._unhighlightStepQueue[t]),this._unhighlightStepQueue[t]=null),null!=(e=this.stepQueue[t].pop())&&this.runFromBlockNow(this,t,e,0,null))}}},{key:"runLogoCommands",value:function runLogoCommands(startHere,env){var _this=this;for(var arg in this._prematureRestart=this._alreadyRunning,this._alreadyRunning&&null!==this._runningBlock?this._ignoringBlock=this._runningBlock:this._ignoringBlock=null,null!=this._lastNoteTimeout&&(clearTimeout(this._lastNoteTimeout),this._lastNoteTimeout=null),this._restoreConnections(),this.activity.saveLocally(),this.evalOnStartList)eval(this.evalOnStartList[arg]);this.stopTurtle=!1,this.activity.blocks.unhighlightAll(),this.activity.blocks.bringToTop(),this.activity.hideMsgs(),this.time=(new Date).getTime(),this.firstNoteTime=null,0===this.activity.turtles.getTurtleCount()&&this.activity.turtles.add(null),Singer.masterBPM=TARGETBPM,Singer.defaultBPMFactor=TONEBPM/TARGETBPM,this.synth.changeInTemperament=!1,this._checkingCompletionState=!1;var _iterator2=_createForOfIteratorHelper(this.activity.turtles.turtleList),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _turtle9=_step2.value;_turtle9.embeddedGraphicsFinished=!0}}catch(t){_iterator2.e(t)}finally{_iterator2.f()}for(var turtle in this.prepSynths(),this.notation.notationStaging={},this.notation.notationDrumStaging={},this.activity.turtles.turtleList)this.initTurtle(turtle);this.inPitchDrumMatrix=!1,this.inMatrix=!1,this.inLegoWidget=!1,this.inMusicKeyboard=!1,this.inTimbre=!1,this.inArpeggio=!1,this.inRhythmRuler=!1,this.insideModeWidget=!1,this.insideMeterWidget=!1,this.insideTemperament=!1,this.rhythmRulerMeasure=null,this._currentDrumBlock=null,this.inStatusMatrix=!1,this.pitchBlocks=[],this.drumBlocks=[],this.tuplet=!1,this.modeBlock=null,this._meterBlock=null;var _iterator3=_createForOfIteratorHelper(this.activity.turtles.turtleList),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var _turtle10=_step3.value;for(var listener in _turtle10.listeners)this.activity.stage.removeEventListener(listener,_turtle10.listeners[listener],!1);_turtle10.listeners={}}}catch(t){_iterator3.e(t)}finally{_iterator3.f()}for(var _turtle4 in this.activity.turtles.turtleList){var requiredTurtle=this.activity.turtles.getTurtle(_turtle4);requiredTurtle.container.x=this.activity.turtles.turtleX2screenX(requiredTurtle.x),requiredTurtle.container.y=this.activity.turtles.turtleY2screenY(requiredTurtle.y)}window.widgetWindows.isOpen("status")&&(null===this.statusMatrix&&(this.statusMatrix=new StatusMatrix),this.statusMatrix.init(this.activity));var startBlocks=[];this.activity.blocks.findStacks(),this.actions={};for(var blk=0,c,b,name;blk<this.activity.blocks.stackList.length;blk++){["start","drum","status","oscilloscope"].includes(this.blockList[this.activity.blocks.stackList[blk]].name)?this.blockList[this.activity.blocks.stackList[blk]].trash||startBlocks.push(this.activity.blocks.stackList[blk]):"action"===this.blockList[this.activity.blocks.stackList[blk]].name&&(c=this.blockList[this.activity.blocks.stackList[blk]].connections[1],b=this.blockList[this.activity.blocks.stackList[blk]].connections[2],null!=c&&null!=b&&(this.blockList[this.activity.blocks.stackList[blk]].trash||(name=this.parseArg(this,0,c,null),this.actions[name]=b)))}this.svgOutput="",this.svgBackground=!0;var _iterator4=_createForOfIteratorHelper(this.activity.turtles.turtleList),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var _turtle11=_step4.value;_turtle11.parentFlowQueue=[],_turtle11.unhighlightQueue=[],_turtle11.parameterQueue=[]}}catch(t){_iterator4.e(t)}finally{_iterator4.f()}for(var _turtle5 in 0===this.turtleDelay&&this.activity.blocks.clearParameterBlocks(),this.onRunTurtle(),0===this.activity.turtles.getTurtleCount()&&this.activity.turtles.addTurtle(null),this.activity.turtles.turtleList)this.activity.turtles.getTurtle(_turtle5).running=!1;if(0===this.activity.turtles.turtleCount())this.activity.errorMsg(NOACTIONERRORMSG,null,_("start"));else if(null!=startHere){for(var _turtle6=0;this.activity.turtles.getTurtle(_turtle6).inTrash&&_turtle6<this.activity.turtles.getTurtleCount();)++_turtle6;["start","drum"].includes(this.blockList[startHere].name)&&(_turtle6=this.blockList[startHere].value);var tur=this.activity.turtles.ithTurtle(_turtle6);tur.queue=[],tur.parentFlowQueue=[],tur.unhighlightQueue=[],tur.parameterQueue=[],tur.running=!0,this.runFromBlock(this,_turtle6,startHere,0,env)}else if(0<startBlocks.length){for(var delayStart=0,_b=0,_turtle7,_tur;_b<startBlocks.length;_b++){["status","oscilloscope"].includes(this.blockList[startBlocks[_b]].name)&&!this.blockList[startBlocks[_b]].trash&&(_turtle7=0,_tur=this.activity.turtles.ithTurtle(_turtle7),_tur.queue=[],_tur.parentFlowQueue=[],_tur.unhighlightQueue=[],_tur.parameterQueue=[],_tur.running=!0,delayStart=250,this.runFromBlock(this,_turtle7,startBlocks[_b],0,env))}setTimeout(function(){0!==delayStart&&_this.onRunTurtle();for(var t,e,i=0;i<startBlocks.length;i++){["status","oscilloscope"].includes(_this.blockList[startBlocks[i]].name)||(t=_this.blockList[startBlocks[i]].value,(e=_this.activity.turtles.ithTurtle(t)).queue=[],e.parentFlowQueue=[],e.unhighlightQueue=[],e.parameterQueue=[],e.inTrash||(e.running=!0,_this.runFromBlock(_this,t,startBlocks[i],0,env)))}},delayStart)}else document.body.style.cursor="default";this.activity.refreshCanvas()}},{key:"runFromBlock",value:function(t,e,i,r,n){var o,s;null!=(this._runningBlock=i)&&(this.receivedArg=n,o=t.activity.turtles.ithTurtle(e),s=t.turtleDelay+o.waitTime,o.doWait(0),t.stopTurtle||(t.turtleDelay===TURTLESTEP?(e in t.stepQueue||(t.stepQueue[e]=[]),t.stepQueue[e].push(i)):(o.delayParameters={blk:i,flow:r,arg:n},o.delayTimeout=setTimeout(function(){return t.runFromBlockNow(t,e,i,r,n)},s))))}},{key:"runFromBlockNow",value:function runFromBlockNow(logo,turtle,blk,isflow,receivedArg,queueStart){this._alreadyRunning=!0,this.receivedArg=receivedArg,void 0===queueStart&&(queueStart=0);var args=[];if(0<logo.blockList[blk].protoblock.args)for(var i=1;i<=logo.blockList[blk].protoblock.args;i++)"in"===logo.blockList[blk].protoblock.dockTypes[i]?null===logo.blockList[blk].connections[i]||args.push(logo.blockList[blk].connections[i]):args.push(logo.parseArg(logo,turtle,logo.blockList[blk].connections[i],blk,receivedArg)),0<logo.activity.turtles.ithTurtle(turtle).singer.inNoteBlock.length&&void 0!==logo.blockList[blk].connections[i]&&void 0!==logo.blockList[logo.blockList[blk].connections[i]]&&"currentpitch"===logo.blockList[logo.blockList[blk].connections[i]].name&&logo.specialArgs.push([args,logo,turtle,blk,receivedArg,null,isflow]);var tur=logo.activity.turtles.ithTurtle(turtle),nextFlow=null,c,nextFlow,queueBlock;logo.blockList[blk].isValueBlock()||(nextFlow=0<tur.singer.backward.length?(c="backward"===logo.blockList[last(tur.singer.backward)].name?1:2,logo.activity.blocks.sameGeneration(logo.blockList[last(tur.singer.backward)].connections[c],blk)?(nextFlow=logo.blockList[blk].connections[0],"action"===logo.blockList[nextFlow].name||"backward"===logo.blockList[nextFlow].name?null:logo.activity.blocks.sameGeneration(logo.blockList[last(tur.singer.backward)].connections[c],nextFlow)?logo.blockList[blk].connections[0]:last(logo.blockList[blk].connections)):last(logo.blockList[blk].connections)):last(logo.blockList[blk].connections),-1===nextFlow&&(nextFlow=null),queueBlock=new Queue(nextFlow,1,blk,receivedArg),null!=nextFlow&&tur.queue.push(queueBlock));var childFlow=null,childFlowCount=0,actionArgs=[],_queueBlock,_queueBlock;if(logo.activity.blocks.visible&&(tur.singer.suppressOutput||0!==tur.singer.justCounting.length||(null!==logo._currentlyHighlightedBlock&&logo._currentlyHighlightedBlock!==blk&&logo.activity.blocks.unhighlight(logo._currentlyHighlightedBlock),logo.activity.blocks.highlight(blk,!1),logo._currentlyHighlightedBlock=blk)),logo.blockList[blk].isArgBlock())logo.blockList[blk].isArgBlock()||["anyout","numberout","textout","booleanout"].includes(logo.blockList[blk].protoblock.dockTypes[0])?(args.push(logo.parseArg(logo,turtle,blk,logo.receievedArg)),null==logo.blockList[blk].value?logo.activity.textMsg("null block value"):logo.activity.textMsg(logo.blockList[blk].value.toString())):logo.activity.errorMsg("I do not know how to "+logo.blockList[blk].name+".",blk),logo.stopTurtle=!0;else{var res=null,res=logo.blockList[blk].name in logo.evalFlowDict?(console.log("running eval on "+logo.blockList[blk].name),logo.pluginReturnValue=null,eval(logo.evalFlowDict[logo.blockList[blk].name]),logo.pluginReturnValue):logo.blockList[blk].protoblock.flow(args,logo,turtle,blk,receivedArg,actionArgs,isflow);if(res){var _res=res,_res2=_slicedToArray(_res,3),cf=_res2[0],cfc=_res2[1],ret=_res2[2];if(void 0!==cf&&(childFlow=cf),void 0!==cfc&&(childFlowCount=cfc),ret)return ret}}if(blk!==logo._ignoringBlock&&blk in tur.endOfClampSignals)for(;0<tur.endOfClampSignals[blk].length;){var signal=tur.endOfClampSignals[blk].pop();null!=signal&&logo.activity.stage.dispatchEvent(signal)}logo.statusMatrix&&logo.statusMatrix.isOpen&&!logo.inStatusMatrix&&logo.statusMatrix.updateAll(),null!=childFlow&&(_queueBlock="doArg"===logo.blockList[blk].name||"nameddoArg"===logo.blockList[blk].name?new Queue(childFlow,childFlowCount,blk,actionArgs):new Queue(childFlow,childFlowCount,blk,receivedArg),null!=tur.parentFlowQueue&&(tur.parentFlowQueue.push(blk),tur.queue.push(_queueBlock)));var nextBlock=null,parentBlk=null,passArg=null;if(tur.queue.length>queueStart&&(nextBlock=last(tur.queue).blk,parentBlk=last(tur.queue).parentBlk,passArg=last(tur.queue).args,1===last(tur.queue).count?tur.queue.pop():--last(tur.queue).count),null!=nextBlock){if(parentBlk!==blk&&(logo.turtleDelay===TURTLESTEP?logo._unhighlightStepQueue[turtle]=blk:tur.singer.suppressOutput||0!==tur.singer.justCounting.length||setTimeout(function(){logo.activity.blocks.visible&&(logo.activity.blocks.unhighlight(blk),logo._currentlyHighlightedBlock===blk&&(logo._currentlyHighlightedBlock=null))},logo.turtleDelay+tur.waitTime)),(0<tur.singer.backward.length&&null==logo.blockList[blk].connections[0]||0===tur.singer.backward.length&&null==last(logo.blockList[blk].connections))&&(tur.singer.suppressOutput||0!==tur.singer.justCounting.length||void 0===tur.unhighlightQueue||(0<tur.parentFlowQueue.length&&0<tur.queue.length&&last(tur.queue).parentBlk!==last(tur.parentFlowQueue)?tur.unhighlightQueue.push(last(tur.parentFlowQueue)):0<tur.unhighlightQueue.length&&setTimeout(function(){var t;logo.activity.blocks.visible?(t=tur.unhighlightQueue.pop(),logo.activity.blocks.unhighlight(t),logo._currentlyHighlightedBlock===t&&(logo._currentlyHighlightedBlock=null)):tur.unhighlightQueue.pop()},logo.turtleDelay))),0!==logo.turtleDelay)for(var pblk in tur.parameterQueue)logo.activity.blocks.updateParameterBlock(logo,turtle,tur.parameterQueue[pblk]);isflow?logo.runFromBlockNow(logo,turtle,nextBlock,isflow,passArg,queueStart):logo.runFromBlock(logo,turtle,nextBlock,isflow,passArg)}else{if(logo._alreadyRunning=!1,logo._prematureRestart)logo.activity.turtles.getTurtle(turtle).running=!1;else{for(var b in tur.endOfClampSignals)for(var _i=0;_i<tur.endOfClampSignals[b].length;_i++)null!=tur.endOfClampSignals[b][_i]&&(null!=tur.butNotThese[b]&&-1!==tur.butNotThese[b].indexOf(_i)||tur.singer.runningFromEvent||logo.activity.stage.dispatchEvent(tur.endOfClampSignals[b][_i]));logo.activity.turtles.getTurtle(turtle).painter.closeSVG(),logo.activity.turtles.getTurtle(turtle).running=!1,logo.activity.turtles.running()||0!==queueStart||logo.onStopTurtle()}var comp=logo.activity.turtles.getTurtle(turtle).companionTurtle,interval;comp&&(logo.activity.turtles.getTurtle(comp).running=!1,interval=logo.activity.turtles.getTurtle(comp).interval,interval&&clearInterval(interval));var __checkCompletionState=function(){logo.activity.turtles.running()||0!==queueStart||0!==tur.singer.justCounting.length||(logo.runningLilypond?(logo.collectingStats?(logo.projectStats=getStatsFromNotation(logo.activity),logo.activity.statsWindow.displayInfo(logo.projectStats)):logo.activity.save.afterSaveLilypond(),logo.collectingStats=!1,logo.runningLilypond=!1):logo.runningAbc?(logo.activity.save.afterSaveAbc(),logo.runningAbc=!1):logo.runningMxml?(logo.activity.save.afterSaveMxml(),logo.runningMxml=!1):logo.runningMIDI?(logo.activity.save.afterSaveMIDI(),logo.runningMIDI=!1):tur.singer.suppressOutput&&(logo.recording||logo.activity.errorMsg(_("Playback is ready."))),logo._lastNoteTimeout=setTimeout(function(){logo._lastNoteTimeout=null,tur.singer.runningFromEvent=!1,tur.singer.suppressOutput&&logo.recording&&(tur.singer.suppressOutput=!1)},1e3))};setTimeout(__checkCompletionState,100)}}},{key:"dispatchTurtleSignals",value:(Qc=_asyncToGenerator(regeneratorRuntime.mark(function t(e,i,r,n){var a,o,s,u,l,c,h,g,p,k,b,d,v,y,m,f,T,L,S,_,A,w,O,E,D,B,M,F,I,N,R=this;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(a=this.activity.turtles.ithTurtle(e),!Object.keys){t.next=6;break}if(0===Object.keys(a.singer.embeddedGraphics).length)return t.abrupt("return");t.next=4;break;case 4:t.next=17;break;case 6:o=!0,t.t0=regeneratorRuntime.keys(a.singer.embeddedGraphics);case 8:if((t.t1=t.t0()).done){t.next=15;break}if(s=t.t1.value,a.singer.embeddedGraphics.hasOwnProperty(s))return _readOnlyError("isEmpty"),o=!1,t.abrupt("break",15);t.next=13;break;case 13:t.next=8;break;case 15:if(o)return t.abrupt("return");t.next=17;break;case 17:if(r in a.singer.embeddedGraphics){t.next=19;break}return t.abrupt("return");case 19:if(0===a.singer.embeddedGraphics[r].length)return t.abrupt("return");t.next=21;break;case 21:a.embeddedGraphicsFinished||(n+=.1),a.embeddedGraphicsFinished=!1,u=a.singer.suppressOutput,l=function(t,e,i,r){var n;switch(e){case"penup":case"pendown":break;default:n=R.parseArg(R,t,R.blockList[i].connections[1],i,R.receivedArg)}function o(t){switch(t){case"penup":a.painter.doPenUp();break;case"pendown":a.painter.doPenDown();break;case"setcolor":a.painter.doSetColor(n);break;case"sethue":a.painter.doSetHue(n);break;case"setshade":a.painter.doSetValue(n);break;case"settranslucency":a.painter.doSetPenAlpha(n);break;case"setgrey":a.painter.doSetChroma(n);break;case"setpensize":a.painter.doSetPensize(n)}}u?o(e):setTimeout(function(){return o(e)},r)},c=function(){var t;a.singer.suppressOutput?(t=a.painter.penState,a.painter.penState=!1,a.painter.doSetXY(0,0),a.painter.doSetHeading(0),a.painter.penState=t,R.svgBackground=!0):(a.painter.penState=!1,a.painter.doSetHeading(0),a.painter.doSetXY(0,0),a.painter.penState=!0)},h=function(t,e,r,n,i){var o=R.parseArg(R,t,R.blockList[e].connections[1],e,R.receivedArg)*i;if(u){var s=a.painter.penState;a.painter.penState=!1,a.painter.doRight(o),a.painter.penState=s}else for(var l=0;l<NOTEDIV/a.singer.dispatchFactor;l++)!function(t){var e=r+t*n*a.singer.dispatchFactor,i=o/(NOTEDIV/a.singer.dispatchFactor);setTimeout(function(){return a.painter.doRight(i)},e)}(l)},g=function(e,i,t){var r;u?(r=R.parseArg(R,e,R.blockList[i].connections[1],i,R.receivedArg),a.painter.doSetHeading(r)):setTimeout(function(){var t=R.parseArg(R,e,R.blockList[i].connections[1],i,R.receivedArg);a.painter.doSetHeading(t)},t)},p=function(t,e,r,n,i){var o=R.parseArg(R,t,R.blockList[e].connections[1],e,R.receivedArg)*i;if(u){var s=a.painter.penState;a.painter.penState=!1,a.painter.doForward(o),a.painter.penState=s}else for(var l=0;l<NOTEDIV/a.singer.dispatchFactor;l++)!function(t){var e=r+t*n*a.singer.dispatchFactor,i=o/(NOTEDIV/a.singer.dispatchFactor);0===t?setTimeout(function(){return a.painter.doForward(i,"first")},e):t===Math.ceil(NOTEDIV/a.singer.dispatchFactor)-1?setTimeout(function(){return a.painter.doForward(i,"last")},e):setTimeout(function(){return a.painter.doForward(i,"middle")},e)}(l)},k=function(i,r,t){var e,n;u?(e=R.parseArg(R,i,R.blockList[r].connections[1],r,R.receivedArg),n=R.parseArg(R,i,R.blockList[r].connections[2],r,R.receivedArg),a.painter.doScrollXY(e,n)):setTimeout(function(){var t=R.parseArg(R,i,R.blockList[r].connections[1],r,R.receivedArg),e=R.parseArg(R,i,R.blockList[r].connections[2],r,R.receivedArg);a.painter.doScrollXY(t,e)},t)},b=function(i,r,t){var e,n,o;u?(e=a.painter.penState,n=R.parseArg(R,i,R.blockList[r].connections[1],r,R.receivedArg),o=R.parseArg(R,i,R.blockList[r].connections[2],r,R.receivedArg),a.painter.penState=!1,a.painter.doSetXY(n,o),a.painter.penState=e):setTimeout(function(){var t=R.parseArg(R,i,R.blockList[r].connections[1],r,R.receivedArg),e=R.parseArg(R,i,R.blockList[r].connections[2],r,R.receivedArg);a.painter.doSetXY(t,e)},t)},d=function(t,e,i){var r,n;u||(r=R.parseArg(R,t,R.blockList[e].connections[1],e,R.receivedArg),n=R.parseArg(R,t,R.blockList[e].connections[2],e,R.receivedArg),setTimeout(function(){return R.processShow(t,null,r,n)},i))},v=function(t,e,i){var r;u||(r=R.parseArg(R,t,R.blockList[e].connections[1],e,R.receivedArg),setTimeout(function(){return R.processSpeak(r)},i))},y=function(t,e,i){var r;u||void 0!==(r=R.parseArg(R,t,R.blockList[e].connections[1],e,R.receivedArg))&&setTimeout(function(){return R.activity.textMsg(r.toString())},i)},m=function(t,e,r,n){var o=R.parseArg(R,t,R.blockList[e].connections[1],e,R.receivedArg),s=R.parseArg(R,t,R.blockList[e].connections[2],e,R.receivedArg);if(u){var i=a.painter.penState;a.painter.penState=!1,a.painter.doArc(o,s),a.painter.penState=i}else for(var l=0;l<NOTEDIV/a.singer.dispatchFactor;l++)!function(t){var e=r+t*n*a.singer.dispatchFactor,i=o/(NOTEDIV/a.singer.dispatchFactor);setTimeout(function(){return a.painter.doArc(i,s)},e)}(l)},f=function(i,r,t){var e,n;u?(e=R.parseArg(R,i,R.blockList[r].connections[1],r,R.receivedArg),n=R.parseArg(R,i,R.blockList[r].connections[2],r,R.receivedArg),a.painter.cp1x=e,a.painter.cp1y=n):setTimeout(function(){var t=R.parseArg(R,i,R.blockList[r].connections[1],r,R.receivedArg),e=R.parseArg(R,i,R.blockList[r].connections[2],r,R.receivedArg);a.painter.cp1x=t,a.painter.cp1y=e},t)},T=function(i,r,t){var e,n;u?(e=R.parseArg(R,i,R.blockList[r].connections[1],r,R.receivedArg),n=R.parseArg(R,i,R.blockList[r].connections[2],r,R.receivedArg),a.painter.cp2x=e,a.painter.cp2y=n):setTimeout(function(){var t=R.parseArg(R,i,R.blockList[r].connections[1],r,R.receivedArg),e=R.parseArg(R,i,R.blockList[r].connections[2],r,R.receivedArg);a.painter.cp2x=t,a.painter.cp2y=e},t)},S=!(L=function(i,r,t){var e,n,o;u?(e=a.painter.penState,n=R.parseArg(R,i,R.blockList[r].connections[1],r,R.receivedArg),o=R.parseArg(R,i,R.blockList[r].connections[2],r,R.receivedArg),a.painter.penState=!1,a.painter.doBezier(n,o),a.painter.penState=e):setTimeout(function(){var t=R.parseArg(R,i,R.blockList[r].connections[1],r,R.receivedArg),e=R.parseArg(R,i,R.blockList[r].connections[2],r,R.receivedArg);a.painter.doBezier(t,e)},t)}),A=!(_=function(t,e){var i;u?(i=a.painter.penState,a.painter.penState=!1,S=S?(a.painter.doEndFill(),!1):(a.painter.doStartFill(),!0),a.painter.penState=i):setTimeout(function(){S=S?(a.painter.doEndFill(),!1):(a.painter.doStartFill(),!0)},e)}),w=function(t,e){u?A=A?(a.painter.doEndHollowLine(),!1):(a.painter.doStartHollowLine(),!0):setTimeout(function(){A=A?(a.painter.doEndHollowLine(),!1):(a.painter.doStartHollowLine(),!0)},e)},E=O=0;case 44:if(!(E<a.singer.embeddedGraphics[r].length)){t.next=55;break}D=a.singer.embeddedGraphics[r][E],t.t2=this.blockList[D].name,t.next="forward"===t.t2||"back"===t.t2||"right"===t.t2||"left"===t.t2||"arc"===t.t2?49:51;break;case 49:return++O,t.abrupt("break",52);case 51:return t.abrupt("break",52);case 52:E++,t.next=44;break;case 55:(B=995*(i-n)/NOTEDIV)<0&&(B=0),0<O&&(B/=O),M=1e3*n,a.singer.dispatchFactor=200<B?NOTEDIV/32:100<B?NOTEDIV/16:50<B?NOTEDIV/8:25<B?NOTEDIV/4:12.5<B?NOTEDIV/2:NOTEDIV,F=0;case 61:if(!(F<a.singer.embeddedGraphics[r].length)){t.next=114;break}I=a.singer.embeddedGraphics[r][F],N=this.blockList[I].name,t.t3=N,t.next="setcolor"===t.t3||"sethue"===t.t3||"setshade"===t.t3||"settranslucency"===t.t3||"setgrey"===t.t3||"setpensize"===t.t3?67:"penup"===t.t3||"pendown"===t.t3?69:"clear"===t.t3?71:"fill"===t.t3?73:"hollowline"===t.t3?75:"controlpoint1"===t.t3?77:"controlpoint2"===t.t3?79:"bezier"===t.t3?81:"setheading"===t.t3?83:"right"===t.t3?85:"left"===t.t3?88:"forward"===t.t3?91:"back"===t.t3?94:"setxy"===t.t3?97:"scrollxy"===t.t3?99:"show"===t.t3?101:"speak"===t.t3?103:"print"===t.t3?105:"arc"===t.t3?107:110;break;case 67:return l(e,N,I,M),t.abrupt("break",111);case 69:return u||l(e,N,null,M),t.abrupt("break",111);case 71:return c(e,M),t.abrupt("break",111);case 73:return _(e,M),t.abrupt("break",111);case 75:return w(e,M),t.abrupt("break",111);case 77:return f(e,I,M),t.abrupt("break",111);case 79:return T(e,I,M),t.abrupt("break",111);case 81:return L(e,I,M),t.abrupt("break",111);case 83:return g(e,I,M),t.abrupt("break",111);case 85:return h(e,I,M,B,1),M+=NOTEDIV*B,t.abrupt("break",111);case 88:return h(e,I,M,B,-1),M+=NOTEDIV*B,t.abrupt("break",111);case 91:return p(e,I,M,B,1),M+=NOTEDIV*B,t.abrupt("break",111);case 94:return p(e,I,M,B,-1),M+=NOTEDIV*B,t.abrupt("break",111);case 97:return b(e,I,M),t.abrupt("break",111);case 99:return k(e,I,M),t.abrupt("break",111);case 101:return d(e,I,M),t.abrupt("break",111);case 103:return v(e,I,M),t.abrupt("break",111);case 105:return y(e,I,M),t.abrupt("break",111);case 107:return m(e,I,M,B),M+=NOTEDIV*B,t.abrupt("break",111);case 110:return t.abrupt("break",111);case 111:F++,t.next=61;break;case 114:return t.next=116,delayExecution(1e3*i);case 116:a.embeddedGraphicsFinished=!0;case 117:case"end":return t.stop()}},t,this)})),function(t,e,i,r){return Qc.apply(this,arguments)})},{key:"onStopTurtle",set:function(t){this._onStopTurtle=t},get:function(){return this._onStopTurtle}},{key:"onRunTurtle",set:function(t){this._onRunTurtle=t},get:function(){return this._onRunTurtle}},{key:"turtleDelay",set:function(t){this._turtleDelay=t},get:function(){return this._turtleDelay}},{key:"notation",get:function(){return this._notation}}]),Logo}();